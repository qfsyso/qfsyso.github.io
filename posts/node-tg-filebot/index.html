<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Node TG FileBot | MLOG</title>
<meta name=keywords content="TG,Node,Server,Docker"><meta name=description content="Node.js TG 文件管理机器人，支持分类存储、分页浏览、搜索、下载、删除文件，同时支持图片缩略图预览和服务器本地下载。
功能 文件分类管理：支持用户自定义分类。
文件上传自动保存：支持文档、图片、视频，并记录上传用户和分类。
分页查看文件列表：可分页显示最近上传的文件。
图片缩略图：在分页列表中显示图片缩略图。
文件搜索：按文件名关键字搜索文件。
获取文件：支持发送文件回 Telegram。
删除文件：支持单个文件删除，带确认机制。
下载到本地：将文件下载到服务器本地，支持重试和错误提示。
命令： /start # 欢迎信息和操作提示 /setcategory # 设置文件分类 /myfiles # 查看最近 10 条文件 /myfilelist [页码] # 分页显示文件列表 /search 关键字 # 搜索文件 /getfile id # 获取文件到 Telegram /delete id # 删除文件
按钮操作： 分类选择：在 /setcategory 后点击按钮设置分类。
删除文件：点击“删除”按钮，带确认操作。
下载文件：点击“下载本地”按钮，将文件下载到服务器本地。
分页：点击上一页/下一页翻页。
文件存储 默认本地存储目录：./files/分类名/文件名
支持自动创建分类目录。
图片会在分页列表显示缩略图。
错误处理和日志
文件下载支持 3 次重试，失败会输出控制台日志。
用户端收到友好提示，不会导致 bot 崩掉。
依赖 node-telegram-bot-api sqlite3 axios Node.js >= 16 项目目录结构 bot.js # 主程序 db."><meta name=author content="dwd"><link rel=canonical href=https://qfsyso.github.io/posts/node-tg-filebot/><link crossorigin=anonymous href=/assets/css/stylesheet.f49d66caae9ea0fd43f21f29e71a8d3e284517ed770f2aa86fa012953ad3c9ef.css integrity="sha256-9J1myq6eoP1D8h8p5xqNPihFF+13Dyqob6ASlTrTye8=" rel="preload stylesheet" as=style><link rel=icon href=https://qfsyso.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://qfsyso.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://qfsyso.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://qfsyso.github.io/apple-touch-icon.png><link rel=mask-icon href=https://qfsyso.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://qfsyso.github.io/posts/node-tg-filebot/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://qfsyso.github.io/posts/node-tg-filebot/"><meta property="og:site_name" content="MLOG"><meta property="og:title" content="Node TG FileBot"><meta property="og:description" content="Node.js TG 文件管理机器人，支持分类存储、分页浏览、搜索、下载、删除文件，同时支持图片缩略图预览和服务器本地下载。
功能 文件分类管理：支持用户自定义分类。
文件上传自动保存：支持文档、图片、视频，并记录上传用户和分类。
分页查看文件列表：可分页显示最近上传的文件。
图片缩略图：在分页列表中显示图片缩略图。
文件搜索：按文件名关键字搜索文件。
获取文件：支持发送文件回 Telegram。
删除文件：支持单个文件删除，带确认机制。
下载到本地：将文件下载到服务器本地，支持重试和错误提示。
命令： /start # 欢迎信息和操作提示 /setcategory # 设置文件分类 /myfiles # 查看最近 10 条文件 /myfilelist [页码] # 分页显示文件列表 /search 关键字 # 搜索文件 /getfile id # 获取文件到 Telegram /delete id # 删除文件
按钮操作： 分类选择：在 /setcategory 后点击按钮设置分类。
删除文件：点击“删除”按钮，带确认操作。
下载文件：点击“下载本地”按钮，将文件下载到服务器本地。
分页：点击上一页/下一页翻页。
文件存储 默认本地存储目录：./files/分类名/文件名
支持自动创建分类目录。
图片会在分页列表显示缩略图。
错误处理和日志
文件下载支持 3 次重试，失败会输出控制台日志。
用户端收到友好提示，不会导致 bot 崩掉。
依赖 node-telegram-bot-api sqlite3 axios Node.js >= 16 项目目录结构 bot.js # 主程序 db."><meta property="og:locale" content="zh-CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-08-26T22:51:47+08:00"><meta property="article:modified_time" content="2025-08-26T22:51:47+08:00"><meta property="article:tag" content="TG"><meta property="article:tag" content="Node"><meta property="article:tag" content="Server"><meta property="article:tag" content="Docker"><meta name=twitter:card content="summary"><meta name=twitter:title content="Node TG FileBot"><meta name=twitter:description content="Node.js TG 文件管理机器人，支持分类存储、分页浏览、搜索、下载、删除文件，同时支持图片缩略图预览和服务器本地下载。
功能 文件分类管理：支持用户自定义分类。
文件上传自动保存：支持文档、图片、视频，并记录上传用户和分类。
分页查看文件列表：可分页显示最近上传的文件。
图片缩略图：在分页列表中显示图片缩略图。
文件搜索：按文件名关键字搜索文件。
获取文件：支持发送文件回 Telegram。
删除文件：支持单个文件删除，带确认机制。
下载到本地：将文件下载到服务器本地，支持重试和错误提示。
命令： /start # 欢迎信息和操作提示 /setcategory # 设置文件分类 /myfiles # 查看最近 10 条文件 /myfilelist [页码] # 分页显示文件列表 /search 关键字 # 搜索文件 /getfile id # 获取文件到 Telegram /delete id # 删除文件
按钮操作： 分类选择：在 /setcategory 后点击按钮设置分类。
删除文件：点击“删除”按钮，带确认操作。
下载文件：点击“下载本地”按钮，将文件下载到服务器本地。
分页：点击上一页/下一页翻页。
文件存储 默认本地存储目录：./files/分类名/文件名
支持自动创建分类目录。
图片会在分页列表显示缩略图。
错误处理和日志
文件下载支持 3 次重试，失败会输出控制台日志。
用户端收到友好提示，不会导致 bot 崩掉。
依赖 node-telegram-bot-api sqlite3 axios Node.js >= 16 项目目录结构 bot.js # 主程序 db."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://qfsyso.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Node TG FileBot","item":"https://qfsyso.github.io/posts/node-tg-filebot/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Node TG FileBot","name":"Node TG FileBot","description":"Node.js TG 文件管理机器人，支持分类存储、分页浏览、搜索、下载、删除文件，同时支持图片缩略图预览和服务器本地下载。\n功能 文件分类管理：支持用户自定义分类。\n文件上传自动保存：支持文档、图片、视频，并记录上传用户和分类。\n分页查看文件列表：可分页显示最近上传的文件。\n图片缩略图：在分页列表中显示图片缩略图。\n文件搜索：按文件名关键字搜索文件。\n获取文件：支持发送文件回 Telegram。\n删除文件：支持单个文件删除，带确认机制。\n下载到本地：将文件下载到服务器本地，支持重试和错误提示。\n命令： /start # 欢迎信息和操作提示 /setcategory # 设置文件分类 /myfiles # 查看最近 10 条文件 /myfilelist [页码] # 分页显示文件列表 /search 关键字 # 搜索文件 /getfile id # 获取文件到 Telegram /delete id # 删除文件\n按钮操作： 分类选择：在 /setcategory 后点击按钮设置分类。\n删除文件：点击“删除”按钮，带确认操作。\n下载文件：点击“下载本地”按钮，将文件下载到服务器本地。\n分页：点击上一页/下一页翻页。\n文件存储 默认本地存储目录：./files/分类名/文件名\n支持自动创建分类目录。\n图片会在分页列表显示缩略图。\n错误处理和日志\n文件下载支持 3 次重试，失败会输出控制台日志。\n用户端收到友好提示，不会导致 bot 崩掉。\n依赖 node-telegram-bot-api sqlite3 axios Node.js \u0026gt;= 16 项目目录结构 bot.js # 主程序 db.","keywords":["TG","Node","Server","Docker"],"articleBody":"Node.js TG 文件管理机器人，支持分类存储、分页浏览、搜索、下载、删除文件，同时支持图片缩略图预览和服务器本地下载。\n功能 文件分类管理：支持用户自定义分类。\n文件上传自动保存：支持文档、图片、视频，并记录上传用户和分类。\n分页查看文件列表：可分页显示最近上传的文件。\n图片缩略图：在分页列表中显示图片缩略图。\n文件搜索：按文件名关键字搜索文件。\n获取文件：支持发送文件回 Telegram。\n删除文件：支持单个文件删除，带确认机制。\n下载到本地：将文件下载到服务器本地，支持重试和错误提示。\n命令： /start # 欢迎信息和操作提示 /setcategory # 设置文件分类 /myfiles # 查看最近 10 条文件 /myfilelist [页码] # 分页显示文件列表 /search 关键字 # 搜索文件 /getfile id # 获取文件到 Telegram /delete id # 删除文件\n按钮操作： 分类选择：在 /setcategory 后点击按钮设置分类。\n删除文件：点击“删除”按钮，带确认操作。\n下载文件：点击“下载本地”按钮，将文件下载到服务器本地。\n分页：点击上一页/下一页翻页。\n文件存储 默认本地存储目录：./files/分类名/文件名\n支持自动创建分类目录。\n图片会在分页列表显示缩略图。\n错误处理和日志\n文件下载支持 3 次重试，失败会输出控制台日志。\n用户端收到友好提示，不会导致 bot 崩掉。\n依赖 node-telegram-bot-api sqlite3 axios Node.js \u003e= 16 项目目录结构 bot.js # 主程序 db.js # SQLite 数据库封装 files/ # 本地文件存储目录 node_modules/ # 依赖库 package.json\n注意事项 确保服务器可以访问 Telegram API（国内可能需要代理）。\ntoken 必须正确，且 bot 有文件读取权限。\n图片缩略图通过 Telegram sendMediaGroup 实现，其他文件显示为文字列表。\n下载文件到本地时，如果失败会重试 3 次并记录日志。\nBot 在 BotFather 创建机器人 打开 TG，搜索 BotFather。\n输入 /start。\n输入 /newbot → 按提示给机器人取名字（例如：FileStorageBot）。\nBotFather 会返回一个 HTTP API Token，类似：\n1234567890:ABCdefGhIjKlmNoPQRstuVWxyZ 这个就是 Node.js 代码里要用的 BOT_TOKEN。\nNode.js 项目初始化 在服务器或本地环境里执行：\nmkdir tg-file-storage-bot cd tg-file-storage-bot npm init -y npm install node-telegram-bot-api sqlite3 node-telegram-bot-api → Telegram 机器人 SDK\nsqlite3 → 存储文件信息（文件分类、路径等）\n建 SQLite 数据库表 新建一个 db.js：\nconst sqlite3 = require('sqlite3').verbose(); const db = new sqlite3.Database('./files.db'); db.serialize(() =\u003e { db.run(` CREATE TABLE IF NOT EXISTS files ( id INTEGER PRIMARY KEY AUTOINCREMENT, file_id TEXT, file_name TEXT, category TEXT, user_id TEXT, date DATETIME DEFAULT CURRENT_TIMESTAMP ) `); }); module.exports = db; bot 新建 bot.js：\nconst TelegramBot = require('node-telegram-bot-api'); const db = require('./db'); const token = \"TOKEN\"; const bot = new TelegramBot(token, { polling: true }); // 保存分类信息（用户 -\u003e 当前选择的分类） const userCategory = {}; // /start 命令 bot.onText(/\\/start/, (msg) =\u003e { bot.sendMessage(msg.chat.id, \"欢迎使用文件存储机器人！\\n\\n命令：\\n/setcategory 分类名\\n/myfiles 查看我的文件\"); }); // 设置分类 bot.onText(/\\/setcategory (.+)/, (msg, match) =\u003e { const category = match[1]; userCategory[msg.from.id] = category; bot.sendMessage(msg.chat.id, `✅ 已设置分类为：${category}\\n请直接发送文件，我会帮存储。`); }); // 接收文件（文档） bot.on(\"document\", async (msg) =\u003e { const fileId = msg.document.file_id; const fileName = msg.document.file_name; const userId = msg.from.id; const category = userCategory[userId] || \"未分类\"; db.run( `INSERT INTO files (file_id, file_name, category, user_id) VALUES (?, ?, ?, ?)`, [fileId, fileName, category, userId], (err) =\u003e { if (err) { console.error(err); bot.sendMessage(msg.chat.id, \"❌ 存储失败。\"); } else { bot.sendMessage(msg.chat.id, `📂 文件已保存：${fileName}\\n分类：${category}`); } } ); }); // 查看文件列表 bot.onText(/\\/myfiles/, (msg) =\u003e { const userId = msg.from.id; db.all( `SELECT id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT 10`, [userId], (err, rows) =\u003e { if (err) return bot.sendMessage(msg.chat.id, \"❌ 查询失败。\"); if (rows.length === 0) return bot.sendMessage(msg.chat.id, \"📭 没有找到文件。\"); let text = \"📂 最近的文件：\\n\\n\"; rows.forEach((r) =\u003e { text += `#${r.id} ${r.file_name} [${r.category}]\\n`; }); bot.sendMessage(msg.chat.id, text); } ); }); // 回复 /getfile id 来取回文件 bot.onText(/\\/getfile (\\d+)/, (msg, match) =\u003e { const id = match[1]; db.get(`SELECT file_id, file_name FROM files WHERE id = ?`, [id], (err, row) =\u003e { if (!row) return bot.sendMessage(msg.chat.id, \"❌ 文件不存在。\"); bot.sendDocument(msg.chat.id, row.file_id, {}, { filename: row.file_name }); }); }); run node bot.js 然后在 TG 里打开机器人：\n/setcategory 工作资料 → 设置分类\n上传文件（文档、PDF、Zip 等）\n/myfiles → 查看自己存的文件\n/getfile 1 → 获取 ID=1 的文件\nXXX, [2025/8/26 9:37] /start mybot1, [2025/8/26 9:37] 欢迎使用文件存储机器人！ 命令： /setcategory 分类名 /myfiles 查看我的文件 inline keyboard search 新增分类 搜索\n//bot.js const TelegramBot = require(\"node-telegram-bot-api\"); const db = require(\"./db\"); const token = \"XXXTOKEN\"; const bot = new TelegramBot(token, { polling: true }); // 保存分类信息（用户 -\u003e 当前选择的分类） const userCategory = {}; // 预设分类 const categories = [\"工作\", \"学习\", \"生活\", \"其他\"]; // /start 命令 bot.onText(/\\/start/, (msg) =\u003e { bot.sendMessage( msg.chat.id, \"欢迎使用文件存储机器人！\\n\\n命令：\\n/setcategory 设置分类\\n/myfiles 查看我的文件\\n/search 关键字 搜索文件\\n/getfile id 获取文件\" ); }); // /setcategory 显示按钮 bot.onText(/\\/setcategory/, (msg) =\u003e { const opts = { reply_markup: { inline_keyboard: categories.map((c) =\u003e [{ text: c, callback_data: `cat_${c}` }]), }, }; bot.sendMessage(msg.chat.id, \"请选择分类：\", opts); }); // 处理按钮点击 bot.on(\"callback_query\", (query) =\u003e { const userId = query.from.id; const chatId = query.message.chat.id; if (query.data.startsWith(\"cat_\")) { const category = query.data.replace(\"cat_\", \"\"); userCategory[userId] = category; bot.sendMessage(chatId, `✅ 已设置分类为：${category}`); } bot.answerCallbackQuery(query.id); // 收起按钮 loading }); // 接收文件 bot.on(\"document\", async (msg) =\u003e { const fileId = msg.document.file_id; const fileName = msg.document.file_name; const userId = msg.from.id; const category = userCategory[userId] || \"未分类\"; db.run( `INSERT INTO files (file_id, file_name, category, user_id) VALUES (?, ?, ?, ?)`, [fileId, fileName, category, userId], (err) =\u003e { if (err) { console.error(err); bot.sendMessage(msg.chat.id, \"❌ 存储失败。\"); } else { bot.sendMessage( msg.chat.id, `📂 文件已保存：${fileName}\\n分类：${category}` ); } } ); }); // 查看文件列表 bot.onText(/\\/myfiles/, (msg) =\u003e { const userId = msg.from.id; db.all( `SELECT id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT 10`, [userId], (err, rows) =\u003e { if (err) return bot.sendMessage(msg.chat.id, \"❌ 查询失败。\"); if (rows.length === 0) return bot.sendMessage(msg.chat.id, \"📭 没有找到文件。\"); let text = \"📂 最近的文件：\\n\\n\"; rows.forEach((r) =\u003e { text += `#${r.id} ${r.file_name} [${r.category}]\\n`; }); bot.sendMessage(msg.chat.id, text); } ); }); // 搜索文件 bot.onText(/\\/search (.+)/, (msg, match) =\u003e { const keyword = `%${match[1]}%`; const userId = msg.from.id; db.all( `SELECT id, file_name, category FROM files WHERE user_id = ? AND file_name LIKE ? ORDER BY date DESC LIMIT 10`, [userId, keyword], (err, rows) =\u003e { if (err) return bot.sendMessage(msg.chat.id, \"❌ 查询失败。\"); if (rows.length === 0) return bot.sendMessage(msg.chat.id, \"🔍 没有匹配的文件。\"); let text = `🔍 搜索结果：\\n\\n`; rows.forEach((r) =\u003e { text += `#${r.id} ${r.file_name} [${r.category}]\\n`; }); bot.sendMessage(msg.chat.id, text); } ); }); // 回复 /getfile id 来取回文件 bot.onText(/\\/getfile (\\d+)/, (msg, match) =\u003e { const id = match[1]; db.get( `SELECT file_id, file_name FROM files WHERE id = ?`, [id], (err, row) =\u003e { if (!row) return bot.sendMessage(msg.chat.id, \"❌ 文件不存在。\"); bot.sendDocument(msg.chat.id, row.file_id, {}, { filename: row.file_name }); } ); }); XXX, [2025/8/26 9:37] /start mybot1, [2025/8/26 9:37] 欢迎使用文件存储机器人！ 命令： /setcategory 分类名 /myfiles 查看我的文件 XXX, [2025/8/26 9:43] /start mybot1, [2025/8/26 9:43] 欢迎使用文件存储机器人！ 命令： /setcategory 设置分类 /myfiles 查看我的文件 /search 关键字 搜索文件 /getfile id 获取文件 XXX, [2025/8/26 9:43] /setcategory mybot1, [2025/8/26 9:43] 请选择分类： mybot1, [2025/8/26 9:43] ✅ 已设置分类为：其他 mybot1, [2025/8/26 9:45] 📂 文件已保存：ttsbot.zip 分类：其他 XXX, [2025/8/26 9:46] /search tts pic video //bot.js const TelegramBot = require(\"node-telegram-bot-api\"); const db = require(\"./db\"); const token = \"XXXTOKEN\"; const bot = new TelegramBot(token, { polling: true }); // 保存分类信息（用户 -\u003e 当前选择的分类） const userCategory = {}; // 预设分类 const categories = [\"工作\", \"学习\", \"生活\", \"其他\"]; // /start 命令 bot.onText(/\\/start/, (msg) =\u003e { bot.sendMessage( msg.chat.id, \"欢迎使用文件存储机器人！\\n\\n命令：\\n/setcategory 设置分类\\n/myfiles 查看文件\\n/search 关键字 搜索文件\\n/getfile id 获取文件\" ); }); // /setcategory 显示按钮 bot.onText(/\\/setcategory/, (msg) =\u003e { const opts = { reply_markup: { inline_keyboard: categories.map((c) =\u003e [{ text: c, callback_data: `cat_${c}` }]), }, }; bot.sendMessage(msg.chat.id, \"请选择分类：\", opts); }); // 处理按钮点击 bot.on(\"callback_query\", (query) =\u003e { const userId = query.from.id; const chatId = query.message.chat.id; if (query.data.startsWith(\"cat_\")) { const category = query.data.replace(\"cat_\", \"\"); userCategory[userId] = category; bot.sendMessage(chatId, `✅ 已设置分类为：${category}`); } bot.answerCallbackQuery(query.id); // 收起按钮 loading }); // 通用保存函数 function saveFile(msg, fileId, fileName, type) { const userId = msg.from.id; const chatId = msg.chat.id; const category = userCategory[userId] || \"未分类\"; db.run( `INSERT INTO files (file_id, file_name, category, user_id) VALUES (?, ?, ?, ?)`, [fileId, fileName, category, userId], function (err) { if (err) { console.error(err); bot.sendMessage(chatId, \"❌ 存储失败。\"); } else { bot.sendMessage( chatId, `📦 已保存 ${type}\\nID: ${this.lastID}\\n文件名: ${fileName}\\n分类: ${category}` ); } } ); } // 监听文档（PDF, ZIP 等） bot.on(\"document\", (msg) =\u003e { const fileId = msg.document.file_id; const fileName = msg.document.file_name; saveFile(msg, fileId, fileName, \"文档\"); }); // 监听图片（包括转发的） bot.on(\"photo\", (msg) =\u003e { // photo 是数组，选最高分辨率的 const photo = msg.photo[msg.photo.length - 1]; const fileId = photo.file_id; const fileName = `photo_${Date.now()}.jpg`; saveFile(msg, fileId, fileName, \"图片\"); }); // 监听视频（包括转发的） bot.on(\"video\", (msg) =\u003e { const fileId = msg.video.file_id; const fileName = msg.video.file_name || `video_${Date.now()}.mp4`; saveFile(msg, fileId, fileName, \"视频\"); }); // 查看文件列表 bot.onText(/\\/myfiles/, (msg) =\u003e { const userId = msg.from.id; db.all( `SELECT id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT 10`, [userId], (err, rows) =\u003e { if (err) return bot.sendMessage(msg.chat.id, \"❌ 查询失败。\"); if (rows.length === 0) return bot.sendMessage(msg.chat.id, \"📭 没有找到文件。\"); let text = \"📂 最近的文件：\\n\\n\"; rows.forEach((r) =\u003e { text += `#${r.id} ${r.file_name} [${r.category}]\\n`; }); bot.sendMessage(msg.chat.id, text); } ); }); // 搜索文件 bot.onText(/\\/search (.+)/, (msg, match) =\u003e { const keyword = `%${match[1]}%`; const userId = msg.from.id; db.all( `SELECT id, file_name, category FROM files WHERE user_id = ? AND file_name LIKE ? ORDER BY date DESC LIMIT 10`, [userId, keyword], (err, rows) =\u003e { if (err) return bot.sendMessage(msg.chat.id, \"❌ 查询失败。\"); if (rows.length === 0) return bot.sendMessage(msg.chat.id, \"🔍 没有匹配的文件。\"); let text = `🔍 搜索结果：\\n\\n`; rows.forEach((r) =\u003e { text += `#${r.id} ${r.file_name} [${r.category}]\\n`; }); bot.sendMessage(msg.chat.id, text); } ); }); // 回复 /getfile id 来取回文件 bot.onText(/\\/getfile (\\d+)/, (msg, match) =\u003e { const id = match[1]; db.get( `SELECT file_id, file_name FROM files WHERE id = ?`, [id], (err, row) =\u003e { if (!row) return bot.sendMessage(msg.chat.id, \"❌ 文件不存在。\"); // 根据扩展名类型发送不同消息 if (row.file_name.endsWith(\".jpg\")) { bot.sendPhoto(msg.chat.id, row.file_id, { caption: row.file_name }); } else if (row.file_name.endsWith(\".mp4\")) { bot.sendVideo(msg.chat.id, row.file_id, { caption: row.file_name }); } else { bot.sendDocument(msg.chat.id, row.file_id, {}, { filename: row.file_name }); } } ); }); list const TelegramBot = require(\"node-telegram-bot-api\"); const db = require(\"./db\"); const token = \"XXXTOKEN\"; const bot = new TelegramBot(token, { polling: true }); // 保存分类信息（用户 -\u003e 当前选择的分类） const userCategory = {}; // 预设分类 const categories = [\"工作\", \"学习\", \"生活\", \"其他\"]; // 每页显示条数 const PAGE_SIZE = 5; // /start 命令 bot.onText(/\\/start/, (msg) =\u003e { bot.sendMessage( msg.chat.id, \"欢迎使用文件存储机器人！\\n\\n命令：\\n\" + \"/setcategory 设置分类\\n\" + \"/myfiles 查看最近文件(文字列表)\\n\" + \"/myfilelist [页码] 文件预览分页\\n\" + \"/search 关键字 搜索文件\\n\" + \"/getfile id 获取文件\" ); }); // /setcategory 显示按钮 bot.onText(/\\/setcategory/, (msg) =\u003e { const opts = { reply_markup: { inline_keyboard: categories.map((c) =\u003e [{ text: c, callback_data: `cat_${c}` }]), }, }; bot.sendMessage(msg.chat.id, \"请选择分类：\", opts); }); // 处理按钮点击 bot.on(\"callback_query\", (query) =\u003e { const userId = query.from.id; const chatId = query.message.chat.id; if (query.data.startsWith(\"cat_\")) { const category = query.data.replace(\"cat_\", \"\"); userCategory[userId] = category; bot.sendMessage(chatId, `✅ 已设置分类为：${category}`); } bot.answerCallbackQuery(query.id); // 收起按钮 loading }); // 通用保存函数 function saveFile(msg, fileId, fileName, type) { const userId = msg.from.id; const chatId = msg.chat.id; const category = userCategory[userId] || \"未分类\"; db.run( `INSERT INTO files (file_id, file_name, category, user_id) VALUES (?, ?, ?, ?)`, [fileId, fileName, category, userId], function (err) { if (err) { console.error(err); bot.sendMessage(chatId, \"❌ 存储失败。\"); } else { bot.sendMessage( chatId, `📦 已保存 ${type}\\nID: ${this.lastID}\\n文件名: ${fileName}\\n分类: ${category}` ); } } ); } // 监听文档 bot.on(\"document\", (msg) =\u003e { const fileId = msg.document.file_id; const fileName = msg.document.file_name; saveFile(msg, fileId, fileName, \"文档\"); }); // 监听图片 bot.on(\"photo\", (msg) =\u003e { const photo = msg.photo[msg.photo.length - 1]; const fileId = photo.file_id; const fileName = `photo_${Date.now()}.jpg`; saveFile(msg, fileId, fileName, \"图片\"); }); // 监听视频 bot.on(\"video\", (msg) =\u003e { const fileId = msg.video.file_id; const fileName = msg.video.file_name || `video_${Date.now()}.mp4`; saveFile(msg, fileId, fileName, \"视频\"); }); // /myfiles 文本列表 bot.onText(/\\/myfiles/, (msg) =\u003e { const userId = msg.from.id; db.all( `SELECT id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT 10`, [userId], (err, rows) =\u003e { if (err) return bot.sendMessage(msg.chat.id, \"❌ 查询失败。\"); if (rows.length === 0) return bot.sendMessage(msg.chat.id, \"📭 没有找到文件。\"); let text = \"📂 最近的文件：\\n\\n\"; rows.forEach((r) =\u003e { text += `#${r.id} ${r.file_name} [${r.category}]\\n`; }); bot.sendMessage(msg.chat.id, text); } ); }); // /myfilelist [页码] 文件预览分页 bot.onText(/\\/myfilelist ?(\\d+)?/, (msg, match) =\u003e { const userId = msg.from.id; const page = parseInt(match[1]) || 1; const offset = (page - 1) * PAGE_SIZE; db.all( `SELECT id, file_id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT ? OFFSET ?`, [userId, PAGE_SIZE, offset], async (err, rows) =\u003e { if (err) return bot.sendMessage(msg.chat.id, \"❌ 查询失败。\"); if (rows.length === 0) return bot.sendMessage(msg.chat.id, \"📭 没有找到文件。\"); bot.sendMessage(msg.chat.id, `📑 第 ${page} 页（每页 ${PAGE_SIZE} 条）`); for (const r of rows) { const caption = `#${r.id} ${r.file_name}\\n分类：${r.category}`; if (r.file_name.endsWith(\".jpg\")) { await bot.sendPhoto(msg.chat.id, r.file_id, { caption }); } else if (r.file_name.endsWith(\".mp4\")) { await bot.sendVideo(msg.chat.id, r.file_id, { caption }); } else { await bot.sendDocument(msg.chat.id, r.file_id, {}, { filename: r.file_name }); await bot.sendMessage(msg.chat.id, caption); } } } ); }); // /search 关键字 bot.onText(/\\/search (.+)/, (msg, match) =\u003e { const keyword = `%${match[1]}%`; const userId = msg.from.id; db.all( `SELECT id, file_name, category FROM files WHERE user_id = ? AND file_name LIKE ? ORDER BY date DESC LIMIT 10`, [userId, keyword], (err, rows) =\u003e { if (err) return bot.sendMessage(msg.chat.id, \"❌ 查询失败。\"); if (rows.length === 0) return bot.sendMessage(msg.chat.id, \"🔍 没有匹配的文件。\"); let text = `🔍 搜索结果：\\n\\n`; rows.forEach((r) =\u003e { text += `#${r.id} ${r.file_name} [${r.category}]\\n`; }); bot.sendMessage(msg.chat.id, text); } ); }); // /getfile id bot.onText(/\\/getfile (\\d+)/, (msg, match) =\u003e { const id = match[1]; db.get( `SELECT file_id, file_name FROM files WHERE id = ?`, [id], (err, row) =\u003e { if (!row) return bot.sendMessage(msg.chat.id, \"❌ 文件不存在。\"); if (row.file_name.endsWith(\".jpg\")) { bot.sendPhoto(msg.chat.id, row.file_id, { caption: row.file_name }); } else if (row.file_name.endsWith(\".mp4\")) { bot.sendVideo(msg.chat.id, row.file_id, { caption: row.file_name }); } else { bot.sendDocument(msg.chat.id, row.file_id, {}, { filename: row.file_name }); } } ); }); del //bot const TelegramBot = require(\"node-telegram-bot-api\"); const db = require(\"./db\"); const token = \"XXXTOKEN\"; const bot = new TelegramBot(token, { polling: true }); // 保存分类信息（用户 -\u003e 当前选择的分类） const userCategory = {}; // 预设分类 const categories = [\"工作\", \"学习\", \"生活\", \"其他\"]; // 每页显示条数 const PAGE_SIZE = 5; // /start 命令 bot.onText(/\\/start/, (msg) =\u003e { bot.sendMessage( msg.chat.id, \"欢迎使用文件存储机器人！\\n\\n命令：\\n\" + \"/setcategory 设置分类\\n\" + \"/myfiles 查看最近文件(文字列表)\\n\" + \"/myfilelist [页码] 文件预览分页\\n\" + \"/search 关键字 搜索文件\\n\" + \"/getfile id 获取文件\\n\" + \"/delete id 删除文件\" ); }); // /setcategory 显示按钮 bot.onText(/\\/setcategory/, (msg) =\u003e { const opts = { reply_markup: { inline_keyboard: categories.map((c) =\u003e [{ text: c, callback_data: `cat_${c}` }]), }, }; bot.sendMessage(msg.chat.id, \"请选择分类：\", opts); }); // 通用保存函数 function saveFile(msg, fileId, fileName, type) { const userId = msg.from.id; const chatId = msg.chat.id; const category = userCategory[userId] || \"未分类\"; db.run( `INSERT INTO files (file_id, file_name, category, user_id) VALUES (?, ?, ?, ?)`, [fileId, fileName, category, userId], function (err) { if (err) { console.error(err); bot.sendMessage(chatId, \"❌ 存储失败。\"); } else { bot.sendMessage( chatId, `📦 已保存 ${type}\\nID: ${this.lastID}\\n文件名: ${fileName}\\n分类: ${category}` ); } } ); } // 监听文档 bot.on(\"document\", (msg) =\u003e { const fileId = msg.document.file_id; const fileName = msg.document.file_name; saveFile(msg, fileId, fileName, \"文档\"); }); // 监听图片 bot.on(\"photo\", (msg) =\u003e { const photo = msg.photo[msg.photo.length - 1]; const fileId = photo.file_id; const fileName = `photo_${Date.now()}.jpg`; saveFile(msg, fileId, fileName, \"图片\"); }); // 监听视频 bot.on(\"video\", (msg) =\u003e { const fileId = msg.video.file_id; const fileName = msg.video.file_name || `video_${Date.now()}.mp4`; saveFile(msg, fileId, fileName, \"视频\"); }); // /myfiles 文本列表 bot.onText(/\\/myfiles/, (msg) =\u003e { const userId = msg.from.id; db.all( `SELECT id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT 10`, [userId], (err, rows) =\u003e { if (err) return bot.sendMessage(msg.chat.id, \"❌ 查询失败。\"); if (rows.length === 0) return bot.sendMessage(msg.chat.id, \"📭 没有找到文件。\"); let text = \"📂 最近的文件：\\n\\n\"; rows.forEach((r) =\u003e { text += `#${r.id} ${r.file_name} [${r.category}]\\n`; }); bot.sendMessage(msg.chat.id, text); } ); }); // /myfilelist [页码] 文件预览分页 bot.onText(/\\/myfilelist ?(\\d+)?/, (msg, match) =\u003e { const userId = msg.from.id; const page = parseInt(match[1]) || 1; const offset = (page - 1) * PAGE_SIZE; db.all( `SELECT id, file_id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT ? OFFSET ?`, [userId, PAGE_SIZE, offset], async (err, rows) =\u003e { if (err) return bot.sendMessage(msg.chat.id, \"❌ 查询失败。\"); if (rows.length === 0) return bot.sendMessage(msg.chat.id, \"📭 没有找到文件。\"); bot.sendMessage(msg.chat.id, `📑 第 ${page} 页（每页 ${PAGE_SIZE} 条）`); for (const r of rows) { const caption = `#${r.id} ${r.file_name}\\n分类：${r.category}`; const opts = { reply_markup: { inline_keyboard: [[{ text: \"❌ 删除\", callback_data: `del_${r.id}` }]], }, }; if (r.file_name.endsWith(\".jpg\")) { await bot.sendPhoto(msg.chat.id, r.file_id, { caption, ...opts }); } else if (r.file_name.endsWith(\".mp4\")) { await bot.sendVideo(msg.chat.id, r.file_id, { caption, ...opts }); } else { await bot.sendDocument(msg.chat.id, r.file_id, {}, { filename: r.file_name }); await bot.sendMessage(msg.chat.id, caption, opts); } } } ); }); // /search 关键字 bot.onText(/\\/search (.+)/, (msg, match) =\u003e { const keyword = `%${match[1]}%`; const userId = msg.from.id; db.all( `SELECT id, file_name, category FROM files WHERE user_id = ? AND file_name LIKE ? ORDER BY date DESC LIMIT 10`, [userId, keyword], (err, rows) =\u003e { if (err) return bot.sendMessage(msg.chat.id, \"❌ 查询失败。\"); if (rows.length === 0) return bot.sendMessage(msg.chat.id, \"🔍 没有匹配的文件。\"); let text = `🔍 搜索结果：\\n\\n`; rows.forEach((r) =\u003e { text += `#${r.id} ${r.file_name} [${r.category}]\\n`; }); bot.sendMessage(msg.chat.id, text); } ); }); // /getfile id bot.onText(/\\/getfile (\\d+)/, (msg, match) =\u003e { const id = match[1]; db.get( `SELECT file_id, file_name FROM files WHERE id = ?`, [id], (err, row) =\u003e { if (!row) return bot.sendMessage(msg.chat.id, \"❌ 文件不存在。\"); if (row.file_name.endsWith(\".jpg\")) { bot.sendPhoto(msg.chat.id, row.file_id, { caption: row.file_name }); } else if (row.file_name.endsWith(\".mp4\")) { bot.sendVideo(msg.chat.id, row.file_id, { caption: row.file_name }); } else { bot.sendDocument(msg.chat.id, row.file_id, {}, { filename: row.file_name }); } } ); }); // /delete id 命令删除 bot.onText(/\\/delete (\\d+)/, (msg, match) =\u003e { const id = match[1]; const userId = msg.from.id; db.run(`DELETE FROM files WHERE id = ? AND user_id = ?`, [id, userId], function (err) { if (err) { console.error(err); return bot.sendMessage(msg.chat.id, \"❌ 删除失败。\"); } if (this.changes === 0) { bot.sendMessage(msg.chat.id, \"⚠️ 没找到该文件或无权限删除。\"); } else { bot.sendMessage(msg.chat.id, `✅ 文件(ID=${id}) 已删除。`); } }); }); // callback_query 统一处理 bot.on(\"callback_query\", (query) =\u003e { const userId = query.from.id; const chatId = query.message.chat.id; // 分类按钮 if (query.data.startsWith(\"cat_\")) { const category = query.data.replace(\"cat_\", \"\"); userCategory[userId] = category; bot.sendMessage(chatId, `✅ 已设置分类为：${category}`); } // 删除按钮（第一步：弹出确认） if (query.data.startsWith(\"del_\")) { const fileId = query.data.replace(\"del_\", \"\"); const confirmOpts = { reply_markup: { inline_keyboard: [ [ { text: \"✅ 确认删除\", callback_data: `confirmdel_${fileId}` }, { text: \"❌ 取消\", callback_data: `cancel_${fileId}` }, ], ], }, }; bot.sendMessage(chatId, `⚠️ 确认要删除文件(ID=${fileId})吗？`, confirmOpts); } // 确认删除（第二步） if (query.data.startsWith(\"confirmdel_\")) { const fileId = query.data.replace(\"confirmdel_\", \"\"); db.run( `DELETE FROM files WHERE id = ? AND user_id = ?`, [fileId, userId], function (err) { if (err) { console.error(err); return bot.sendMessage(chatId, \"❌ 删除失败。\"); } if (this.changes === 0) { bot.sendMessage(chatId, \"⚠️ 没找到该文件或无权限删除。\"); } else { bot.sendMessage(chatId, `✅ 文件(ID=${fileId}) 已删除。`); } } ); } // 取消删除 if (query.data.startsWith(\"cancel_\")) { const fileId = query.data.replace(\"cancel_\", \"\"); bot.sendMessage(chatId, `❎ 已取消删除文件(ID=${fileId})。`); } bot.answerCallbackQuery(query.id); }); Loacl DownloadFile const TelegramBot = require(\"node-telegram-bot-api\"); const db = require(\"./db\"); const fs = require(\"fs\"); const path = require(\"path\"); const axios = require(\"axios\"); const token = \"TKTKg\"; const bot = new TelegramBot(token, { polling: true }); // 保存分类信息（用户 -\u003e 当前选择的分类） const userCategory = {}; // 预设分类 const categories = [\"work\", \"study\", \"life\", \"other\",\"yo\",\"yo2\"]; // 每页显示条数 const PAGE_SIZE = 5; // 本地存储根目录 const STORAGE_DIR = path.join(__dirname, \"files\"); if (!fs.existsSync(STORAGE_DIR)) fs.mkdirSync(STORAGE_DIR); // /start 命令 bot.onText(/\\/start/, (msg) =\u003e { bot.sendMessage( msg.chat.id, \"欢迎使用文件存储机器人！\\n\\n命令：\\n\" + \"/setcategory 设置分类\\n\" + \"/myfiles 查看最近文件(文字列表)\\n\" + \"/myfilelist [页码] 文件预览分页\\n\" + \"/search 关键字 搜索文件\\n\" + \"/getfile id 获取文件\\n\" + \"/delete id 删除文件\\n\" + \"📥 点击文件后的“下载本地”按钮可保存到服务器本地\" ); }); // /setcategory 显示按钮 bot.onText(/\\/setcategory/, (msg) =\u003e { const opts = { reply_markup: { inline_keyboard: categories.map((c) =\u003e [{ text: c, callback_data: `cat_${c}` }]), }, }; bot.sendMessage(msg.chat.id, \"请选择分类：\", opts); }); // 通用保存函数 function saveFile(msg, fileId, fileName, type) { const userId = msg.from.id; const chatId = msg.chat.id; const category = userCategory[userId] || \"未分类\"; db.run( `INSERT INTO files (file_id, file_name, category, user_id) VALUES (?, ?, ?, ?)`, [fileId, fileName, category, userId], function (err) { if (err) { console.error(err); bot.sendMessage(chatId, \"❌ 存储失败。\"); } else { bot.sendMessage( chatId, `📦 已保存 ${type}\\nID: ${this.lastID}\\n文件名: ${fileName}\\n分类: ${category}` ); } } ); } // 下载文件到本地 async function downloadFile(fileId, fileName, category) { try { const url = await bot.getFileLink(fileId); const dir = path.join(STORAGE_DIR, category); if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true }); const filePath = path.join(dir, fileName); const writer = fs.createWriteStream(filePath); const response = await axios({ url, method: 'GET', responseType: 'stream' }); response.data.pipe(writer); return new Promise((resolve, reject) =\u003e { writer.on('finish', () =\u003e resolve(filePath)); writer.on('error', reject); }); } catch (err) { console.error(\"下载文件失败:\", err); throw err; } } // 统一处理消息（普通消息和转发消息） bot.on(\"message\", (msg) =\u003e { const hasFile = msg.document || msg.photo || msg.video; const isForward = msg.forward_from || msg.forward_from_chat; if (!hasFile) return; const typePrefix = isForward ? \"转发\" : \"\"; // 文档 if (msg.document) { saveFile(msg, msg.document.file_id, msg.document.file_name, `${typePrefix}文档`); } // 图片 if (msg.photo) { const photo = msg.photo[msg.photo.length - 1]; const fileName = `photo_${Date.now()}.jpg`; saveFile(msg, photo.file_id, fileName, `${typePrefix}图片`); } // 视频 if (msg.video) { const fileName = msg.video.file_name || `video_${Date.now()}.mp4`; saveFile(msg, msg.video.file_id, fileName, `${typePrefix}视频`); } }); // /myfiles 文本列表 bot.onText(/\\/myfiles/, (msg) =\u003e { const userId = msg.from.id; db.all( `SELECT id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT 10`, [userId], (err, rows) =\u003e { if (err) return bot.sendMessage(msg.chat.id, \"❌ 查询失败。\"); if (rows.length === 0) return bot.sendMessage(msg.chat.id, \"📭 没有找到文件。\"); let text = \"📂 最近的文件：\\n\\n\"; rows.forEach((r) =\u003e { text += `#${r.id} ${r.file_name} [${r.category}]\\n`; }); bot.sendMessage(msg.chat.id, text); } ); }); // /myfilelist 分页显示 async function sendFilePage(chatId, userId, page = 1, messageId = null) { const offset = (page - 1) * PAGE_SIZE; db.all( `SELECT id, file_id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT ? OFFSET ?`, [userId, PAGE_SIZE, offset], async (err, rows) =\u003e { if (err) return bot.sendMessage(chatId, \"❌ 查询失败。\"); if (rows.length === 0) return bot.sendMessage(chatId, \"📭 没有找到文件。\"); if (messageId) { await bot.editMessageText(`📑 第 ${page} 页（每页 ${PAGE_SIZE} 条）`, { chat_id: chatId, message_id: messageId, }); } else { await bot.sendMessage(chatId, `📑 第 ${page} 页（每页 ${PAGE_SIZE} 条）`); } for (const r of rows) { const caption = `#${r.id} ${r.file_name}\\n分类：${r.category}`; const opts = { reply_markup: { inline_keyboard: [ [{ text: \"❌ 删除\", callback_data: `del_${r.id}` }], [{ text: \"⬇️ 下载本地\", callback_data: `download_${r.id}` }], ], }, }; if (r.file_name.endsWith(\".jpg\")) { await bot.sendPhoto(chatId, r.file_id, { caption, ...opts }); } else if (r.file_name.endsWith(\".mp4\")) { await bot.sendVideo(chatId, r.file_id, { caption, ...opts }); } else { await bot.sendDocument(chatId, r.file_id, {}, { filename: r.file_name }); await bot.sendMessage(chatId, caption, opts); } } // 翻页按钮 const totalCountRow = await new Promise((resolve) =\u003e db.get(`SELECT COUNT(*) as cnt FROM files WHERE user_id = ?`, [userId], (err, row) =\u003e resolve(row)) ); const totalPages = Math.ceil(totalCountRow.cnt / PAGE_SIZE); const navOpts = { reply_markup: { inline_keyboard: [ [ { text: \"⬅️ 上一页\", callback_data: `page_${page - 1}` }, { text: \"➡️ 下一页\", callback_data: `page_${page + 1}` }, ], ], }, }; await bot.sendMessage(chatId, `分页导航：第 ${page}/${totalPages} 页`, navOpts); } ); } bot.onText(/\\/myfilelist ?(\\d+)?/, (msg, match) =\u003e { const page = parseInt(match[1]) || 1; sendFilePage(msg.chat.id, msg.from.id, page); }); // /search 关键字 bot.onText(/\\/search (.+)/, (msg, match) =\u003e { const keyword = `%${match[1]}%`; const userId = msg.from.id; db.all( `SELECT id, file_name, category FROM files WHERE user_id = ? AND file_name LIKE ? ORDER BY date DESC LIMIT 10`, [userId, keyword], (err, rows) =\u003e { if (err) return bot.sendMessage(msg.chat.id, \"❌ 查询失败。\"); if (rows.length === 0) return bot.sendMessage(msg.chat.id, \"🔍 没有匹配的文件。\"); let text = `🔍 搜索结果：\\n\\n`; rows.forEach((r) =\u003e { text += `#${r.id} ${r.file_name} [${r.category}]\\n`; }); bot.sendMessage(msg.chat.id, text); } ); }); // /getfile id bot.onText(/\\/getfile (\\d+)/, (msg, match) =\u003e { const id = match[1]; db.get(`SELECT file_id, file_name FROM files WHERE id = ?`, [id], (err, row) =\u003e { if (!row) return bot.sendMessage(msg.chat.id, \"❌ 文件不存在。\"); if (row.file_name.endsWith(\".jpg\")) { bot.sendPhoto(msg.chat.id, row.file_id, { caption: row.file_name }); } else if (row.file_name.endsWith(\".mp4\")) { bot.sendVideo(msg.chat.id, row.file_id, { caption: row.file_name }); } else { bot.sendDocument(msg.chat.id, row.file_id, {}, { filename: row.file_name }); } }); }); // /delete id bot.onText(/\\/delete (\\d+)/, (msg, match) =\u003e { const id = match[1]; const userId = msg.from.id; db.run(`DELETE FROM files WHERE id = ? AND user_id = ?`, [id, userId], function (err) { if (err) return bot.sendMessage(msg.chat.id, \"❌ 删除失败。\"); if (this.changes === 0) return bot.sendMessage(msg.chat.id, \"⚠️ 没找到该文件或无权限删除。\"); bot.sendMessage(msg.chat.id, `✅ 文件(ID=${id}) 已删除。`); }); }); // callback_query 统一处理 bot.on(\"callback_query\", async (query) =\u003e { const userId = query.from.id; const chatId = query.message.chat.id; // 分类按钮 if (query.data.startsWith(\"cat_\")) { const category = query.data.replace(\"cat_\", \"\"); userCategory[userId] = category; bot.sendMessage(chatId, `✅ 已设置分类为：${category}`); } // 删除按钮 if (query.data.startsWith(\"del_\")) { const fileId = query.data.replace(\"del_\", \"\"); const confirmOpts = { reply_markup: { inline_keyboard: [ [ { text: \"✅ 确认删除\", callback_data: `confirmdel_${fileId}` }, { text: \"❌ 取消\", callback_data: `cancel_${fileId}` }, ], ], }, }; bot.sendMessage(chatId, `⚠️ 确认要删除文件(ID=${fileId})吗？`, confirmOpts); } // 确认删除 if (query.data.startsWith(\"confirmdel_\")) { const fileId = query.data.replace(\"confirmdel_\", \"\"); db.run(`DELETE FROM files WHERE id = ? AND user_id = ?`, [fileId, userId], function (err) { if (err) return bot.sendMessage(chatId, \"❌ 删除失败。\"); if (this.changes === 0) return bot.sendMessage(chatId, \"⚠️ 没找到该文件或无权限删除。\"); bot.sendMessage(chatId, `✅ 文件(ID=${fileId}) 已删除。`); }); } // 取消删除 if (query.data.startsWith(\"cancel_\")) { const fileId = query.data.replace(\"cancel_\", \"\"); bot.sendMessage(chatId, `❎ 已取消删除文件(ID=${fileId})。`); } // 分页按钮 if (query.data.startsWith(\"page_\")) { const page = parseInt(query.data.replace(\"page_\", \"\")); if (page \u003c 1) return bot.answerCallbackQuery(query.id, { text: \"已经是第一页\" }); sendFilePage(chatId, userId, page, query.message.message_id); } // 下载到本地按钮 if (query.data.startsWith(\"download_\")) { const id = query.data.replace(\"download_\", \"\"); db.get(`SELECT file_id, file_name, category FROM files WHERE id = ? AND user_id = ?`, [id, userId], async (err, row) =\u003e { if (!row) return bot.sendMessage(chatId, \"❌ 文件不存在或无权限下载。\"); try { const filePath = await downloadFile(row.file_id, row.file_name, row.category); bot.sendMessage(chatId, `✅ 文件已下载到服务器本地：${filePath}`); } catch { bot.sendMessage(chatId, \"❌ 下载失败，请稍后重试。\"); } }); } bot.answerCallbackQuery(query.id); }); Mv const TelegramBot = require(\"node-telegram-bot-api\"); const db = require(\"./db\"); const fs = require(\"fs\"); const path = require(\"path\"); const axios = require(\"axios\"); const token = \"TKTK\"; const bot = new TelegramBot(token, { polling: true }); // 保存分类信息（用户 -\u003e 当前选择的分类） const userCategory = {}; // 预设分类 const categories = [\"work\", \"study\", \"life\", \"other\",\"yo\",\"yo2\"]; // 每页显示条数 const PAGE_SIZE = 5; // 本地存储根目录 const STORAGE_DIR = path.join(__dirname, \"files\"); if (!fs.existsSync(STORAGE_DIR)) fs.mkdirSync(STORAGE_DIR); // /start 命令 bot.onText(/\\/start/, (msg) =\u003e { bot.sendMessage( msg.chat.id, \"欢迎使用文件存储机器人！\\n\\n命令：\\n\" + \"/setcategory 设置分类\\n\" + \"/myfiles 查看最近文件(文字列表)\\n\" + \"/myfilelist [页码] 文件分页显示\\n\" + \"/search 关键字 搜索文件\\n\" + \"/getfile id 获取文件\\n\" + \"/delete id 删除文件\\n\" + \"📥 点击文件后的“下载本地”按钮可保存到服务器本地\" ); }); // /setcategory 显示按钮 bot.onText(/\\/setcategory/, (msg) =\u003e { const opts = { reply_markup: { inline_keyboard: categories.map((c) =\u003e [{ text: c, callback_data: `cat_${c}` }]), }, }; bot.sendMessage(msg.chat.id, \"请选择分类：\", opts); }); // 通用保存函数 function saveFile(msg, fileId, fileName, type) { const userId = msg.from.id; const chatId = msg.chat.id; const category = userCategory[userId] || \"未分类\"; db.run( `INSERT INTO files (file_id, file_name, category, user_id) VALUES (?, ?, ?, ?)`, [fileId, fileName, category, userId], function (err) { if (err) { console.error(err); bot.sendMessage(chatId, \"❌ 存储失败。\"); } else { bot.sendMessage( chatId, `📦 已保存 ${type}\\nID: ${this.lastID}\\n文件名: ${fileName}\\n分类: ${category}` ); } } ); } // 下载文件到本地（带重试和日志） async function downloadFile(fileId, fileName, category, retries = 3) { const dir = path.join(STORAGE_DIR, category); if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true }); const filePath = path.join(dir, fileName); for (let attempt = 1; attempt \u003c= retries; attempt++) { try { console.log(`下载文件尝试 ${attempt}/${retries}：${fileName}`); const url = await bot.getFileLink(fileId); // 获取文件链接 const writer = fs.createWriteStream(filePath); const response = await axios({ url, method: 'GET', responseType: 'stream', timeout: 30000 // 30秒超时 }); response.data.pipe(writer); await new Promise((resolve, reject) =\u003e { writer.on('finish', resolve); writer.on('error', reject); }); console.log(`✅ 文件下载成功：${filePath}`); return filePath; } catch (err) { console.error(`❌ 下载文件失败（尝试 ${attempt}）：${fileName}`, err); if (attempt === retries) { throw new Error(`下载文件失败，请稍后重试：${fileName}`); } // 等待 1 秒后重试 await new Promise(res =\u003e setTimeout(res, 1000)); } } } // 统一处理消息（普通消息和转发消息） bot.on(\"message\", (msg) =\u003e { const hasFile = msg.document || msg.photo || msg.video; const isForward = msg.forward_from || msg.forward_from_chat; if (!hasFile) return; const typePrefix = isForward ? \"转发\" : \"\"; // 文档 if (msg.document) { saveFile(msg, msg.document.file_id, msg.document.file_name, `${typePrefix}文档`); } // 图片 if (msg.photo) { const photo = msg.photo[msg.photo.length - 1]; const fileName = `photo_${Date.now()}.jpg`; saveFile(msg, photo.file_id, fileName, `${typePrefix}图片`); } // 视频 if (msg.video) { const fileName = msg.video.file_name || `video_${Date.now()}.mp4`; saveFile(msg, msg.video.file_id, fileName, `${typePrefix}视频`); } }); // /myfiles 文本列表 bot.onText(/\\/myfiles/, (msg) =\u003e { const userId = msg.from.id; db.all( `SELECT id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT 10`, [userId], (err, rows) =\u003e { if (err) return bot.sendMessage(msg.chat.id, \"❌ 查询失败。\"); if (rows.length === 0) return bot.sendMessage(msg.chat.id, \"📭 没有找到文件。\"); let text = \"📂 最近的文件：\\n\\n\"; rows.forEach((r) =\u003e { text += `#${r.id} ${r.file_name} [${r.category}]\\n`; }); bot.sendMessage(msg.chat.id, text); } ); }); // /myfilelist 分页显示（优化：支持图片缩略图） async function sendFilePage(chatId, userId, page = 1, messageId = null) { const offset = (page - 1) * PAGE_SIZE; db.all( `SELECT id, file_id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT ? OFFSET ?`, [userId, PAGE_SIZE, offset], async (err, rows) =\u003e { if (err) return bot.sendMessage(chatId, \"❌ 查询失败。\"); if (rows.length === 0) return bot.sendMessage(chatId, \"📭 没有找到文件。\"); // 拼接文件列表文字 let text = `📑 第 ${page} 页（每页 ${PAGE_SIZE} 条）\\n\\n`; const inline_keyboard = []; const mediaGroup = []; for (const r of rows) { text += `#${r.id} ${r.file_name} [${r.category}]\\n`; // 每个文件单独两按钮行：删除+下载 inline_keyboard.push([ { text: \"❌ 删除\", callback_data: `del_${r.id}` }, { text: \"⬇️ 下载本地\", callback_data: `download_${r.id}` }, ]); // 如果是图片，加入缩略图到 mediaGroup if (r.file_name.endsWith(\".jpg\") || r.file_name.endsWith(\".png\")) { mediaGroup.push({ type: \"photo\", media: r.file_id, caption: `#${r.id} ${r.file_name}` }); } } // 翻页按钮 const totalCountRow = await new Promise((resolve) =\u003e db.get(`SELECT COUNT(*) as cnt FROM files WHERE user_id = ?`, [userId], (err, row) =\u003e resolve(row)) ); const totalPages = Math.ceil(totalCountRow.cnt / PAGE_SIZE); inline_keyboard.push([ { text: \"⬅️ 上一页\", callback_data: `page_${page - 1}` }, { text: \"➡️ 下一页\", callback_data: `page_${page + 1}` }, ]); const opts = { reply_markup: { inline_keyboard } }; if (mediaGroup.length \u003e 0) { // 先发送图片缩略图组 try { await bot.sendMediaGroup(chatId, mediaGroup); } catch (err) { console.error(\"发送缩略图失败:\", err); } } if (messageId) { // 编辑已有消息 await bot.editMessageText(text, { chat_id: chatId, message_id: messageId, reply_markup: opts.reply_markup, }); } else { await bot.sendMessage(chatId, text, opts); } } ); } bot.onText(/\\/myfilelist ?(\\d+)?/, (msg, match) =\u003e { const page = parseInt(match[1]) || 1; sendFilePage(msg.chat.id, msg.from.id, page); }); // /search 关键字 bot.onText(/\\/search (.+)/, (msg, match) =\u003e { const keyword = `%${match[1]}%`; const userId = msg.from.id; db.all( `SELECT id, file_name, category FROM files WHERE user_id = ? AND file_name LIKE ? ORDER BY date DESC LIMIT 10`, [userId, keyword], (err, rows) =\u003e { if (err) return bot.sendMessage(msg.chat.id, \"❌ 查询失败。\"); if (rows.length === 0) return bot.sendMessage(msg.chat.id, \"🔍 没有匹配的文件。\"); let text = `🔍 搜索结果：\\n\\n`; rows.forEach((r) =\u003e { text += `#${r.id} ${r.file_name} [${r.category}]\\n`; }); bot.sendMessage(msg.chat.id, text); } ); }); // /getfile id bot.onText(/\\/getfile (\\d+)/, (msg, match) =\u003e { const id = match[1]; db.get(`SELECT file_id, file_name FROM files WHERE id = ?`, [id], (err, row) =\u003e { if (!row) return bot.sendMessage(msg.chat.id, \"❌ 文件不存在。\"); if (row.file_name.endsWith(\".jpg\")) { bot.sendPhoto(msg.chat.id, row.file_id, { caption: row.file_name }); } else if (row.file_name.endsWith(\".mp4\")) { bot.sendVideo(msg.chat.id, row.file_id, { caption: row.file_name }); } else { bot.sendDocument(msg.chat.id, row.file_id, {}, { filename: row.file_name }); } }); }); // /delete id bot.onText(/\\/delete (\\d+)/, (msg, match) =\u003e { const id = match[1]; const userId = msg.from.id; db.run(`DELETE FROM files WHERE id = ? AND user_id = ?`, [id, userId], function (err) { if (err) return bot.sendMessage(msg.chat.id, \"❌ 删除失败。\"); if (this.changes === 0) return bot.sendMessage(msg.chat.id, \"⚠️ 没找到该文件或无权限删除。\"); bot.sendMessage(msg.chat.id, `✅ 文件(ID=${id}) 已删除。`); }); }); // callback_query 统一处理 bot.on(\"callback_query\", async (query) =\u003e { const userId = query.from.id; const chatId = query.message.chat.id; // 分类按钮 if (query.data.startsWith(\"cat_\")) { const category = query.data.replace(\"cat_\", \"\"); userCategory[userId] = category; bot.sendMessage(chatId, `✅ 已设置分类为：${category}`); } // 删除按钮 if (query.data.startsWith(\"del_\")) { const fileId = query.data.replace(\"del_\", \"\"); const confirmOpts = { reply_markup: { inline_keyboard: [ [ { text: \"✅ 确认删除\", callback_data: `confirmdel_${fileId}` }, { text: \"❌ 取消\", callback_data: `cancel_${fileId}` }, ], ], }, }; bot.sendMessage(chatId, `⚠️ 确认要删除文件(ID=${fileId})吗？`, confirmOpts); } // 确认删除 if (query.data.startsWith(\"confirmdel_\")) { const fileId = query.data.replace(\"confirmdel_\", \"\"); db.run(`DELETE FROM files WHERE id = ? AND user_id = ?`, [fileId, userId], function (err) { if (err) return bot.sendMessage(chatId, \"❌ 删除失败。\"); if (this.changes === 0) return bot.sendMessage(chatId, \"⚠️ 没找到该文件或无权限删除。\"); bot.sendMessage(chatId, `✅ 文件(ID=${fileId}) 已删除。`); }); } // 取消删除 if (query.data.startsWith(\"cancel_\")) { const fileId = query.data.replace(\"cancel_\", \"\"); bot.sendMessage(chatId, `❎ 已取消删除文件(ID=${fileId})。`); } // 分页按钮 if (query.data.startsWith(\"page_\")) { const page = parseInt(query.data.replace(\"page_\", \"\")); if (page \u003c 1) return bot.answerCallbackQuery(query.id, { text: \"已经是第一页\" }); sendFilePage(chatId, userId, page, query.message.message_id); } // 下载到本地按钮 if (query.data.startsWith(\"download_\")) { const id = query.data.replace(\"download_\", \"\"); db.get(`SELECT file_id, file_name, category FROM files WHERE id = ? AND user_id = ?`, [id, userId], async (err, row) =\u003e { if (!row) return bot.sendMessage(chatId, \"❌ 文件不存在或无权限下载。\"); try { const filePath = await downloadFile(row.file_id, row.file_name, row.category); bot.sendMessage(chatId, `✅ 文件已下载到服务器本地：${filePath}`); } catch (err) { console.error(err); bot.sendMessage(chatId, `❌ ${err.message}`); } }); } bot.answerCallbackQuery(query.id); }); config.js configbot.js\n// configbot.js module.exports = { token: \"t\", // Telegram Bot Token categories: [\"work\", \"study\", \"life\", \"other\", \"yo\", \"yo2\"], // 分类 pageSize: 5 // 每页显示条数 }; //bot.js const TelegramBot = require(\"node-telegram-bot-api\"); const db = require(\"./db\"); const fs = require(\"fs\"); const path = require(\"path\"); const axios = require(\"axios\"); const config = require(\"./configbot\"); // 引入配置文件 const token = config.token; const categories = config.categories; const PAGE_SIZE = config.pageSize; const bot = new TelegramBot(token, { polling: true }); login //config module.exports = { token: \"BOT_TOKEN\", categories: [\"c1\", \"c2\", \"c2\"], pageSize: 5, adminPassword: \"admin123\" // 机器人访问密码 }; const TelegramBot = require(\"node-telegram-bot-api\"); const db = require(\"./db\"); const fs = require(\"fs\"); const path = require(\"path\"); const axios = require(\"axios\"); const config = require(\"./configbot\"); // 引入配置文件 const token = config.token; const categories = config.categories; const PAGE_SIZE = config.pageSize; // 从配置读取 const ADMIN_PASSWORD = config.adminPassword; // 管理密码 const bot = new TelegramBot(token, { polling: true }); // 保存分类信息（用户 -\u003e 当前选择的分类） const userCategory = {}; // 保存已登录用户 const authenticatedUsers = new Set(); // 本地存储根目录 const STORAGE_DIR = path.join(__dirname, \"files\"); if (!fs.existsSync(STORAGE_DIR)) fs.mkdirSync(STORAGE_DIR); // 检查是否已鉴权 function checkAuth(msg) { const userId = msg.from.id; if (!authenticatedUsers.has(userId)) { bot.sendMessage(msg.chat.id, \"⚠️ 请先使用 /login \u003c密码\u003e 登录。\"); return false; } return true; } // /login 命令 bot.onText(/\\/login (.+)/, (msg, match) =\u003e { const password = match[1]; const userId = msg.from.id; if (password === ADMIN_PASSWORD) { authenticatedUsers.add(userId); bot.sendMessage(msg.chat.id, \"✅ 登录成功，您已获得访问权限。\"); } else { bot.sendMessage(msg.chat.id, \"❌ 密码错误。\"); } }); // /start 命令 bot.onText(/\\/start/, (msg) =\u003e { if (!checkAuth(msg)) return; bot.sendMessage( msg.chat.id, \"欢迎使用文件存储机器人！\\n\\n命令：\\n\" + \"/setcategory 设置分类\\n\" + \"/myfiles 查看最近文件(文字列表)\\n\" + \"/myfilelist [页码] 文件分页显示\\n\" + \"/search 关键字 搜索文件\\n\" + \"/getfile id 获取文件\\n\" + \"/delete id 删除文件\\n\" + \"📥 点击文件后的“下载本地”按钮可保存到服务器本地\" ); }); // /setcategory 显示按钮 bot.onText(/\\/setcategory/, (msg) =\u003e { if (!checkAuth(msg)) return; const opts = { reply_markup: { inline_keyboard: categories.map((c) =\u003e [{ text: c, callback_data: `cat_${c}` }]), }, }; bot.sendMessage(msg.chat.id, \"请选择分类：\", opts); }); // 通用保存函数 function saveFile(msg, fileId, fileName, type) { const userId = msg.from.id; const chatId = msg.chat.id; const category = userCategory[userId] || \"未分类\"; db.run( `INSERT INTO files (file_id, file_name, category, user_id) VALUES (?, ?, ?, ?)`, [fileId, fileName, category, userId], function (err) { if (err) { console.error(err); bot.sendMessage(chatId, \"❌ 存储失败。\"); } else { bot.sendMessage( chatId, `📦 已保存 ${type}\\nID: ${this.lastID}\\n文件名: ${fileName}\\n分类: ${category}` ); } } ); } // 下载文件到本地（带重试和日志） async function downloadFile(fileId, fileName, category, retries = 3) { const dir = path.join(STORAGE_DIR, category); if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true }); const filePath = path.join(dir, fileName); for (let attempt = 1; attempt \u003c= retries; attempt++) { try { console.log(`下载文件尝试 ${attempt}/${retries}：${fileName}`); const url = await bot.getFileLink(fileId); // 获取文件链接 const writer = fs.createWriteStream(filePath); const response = await axios({ url, method: \"GET\", responseType: \"stream\", timeout: 30000, // 30秒超时 }); response.data.pipe(writer); await new Promise((resolve, reject) =\u003e { writer.on(\"finish\", resolve); writer.on(\"error\", reject); }); console.log(`✅ 文件下载成功：${filePath}`); return filePath; } catch (err) { console.error(`❌ 下载文件失败（尝试 ${attempt}）：${fileName}`, err); if (attempt === retries) { throw new Error(`下载文件失败，请稍后重试：${fileName}`); } // 等待 1 秒后重试 await new Promise((res) =\u003e setTimeout(res, 1000)); } } } // 统一处理消息（普通消息和转发消息） bot.on(\"message\", (msg) =\u003e { if (!checkAuth(msg)) return; const hasFile = msg.document || msg.photo || msg.video; const isForward = msg.forward_from || msg.forward_from_chat; if (!hasFile) return; const typePrefix = isForward ? \"转发\" : \"\"; // 文档 if (msg.document) { saveFile(msg, msg.document.file_id, msg.document.file_name, `${typePrefix}文档`); } // 图片 if (msg.photo) { const photo = msg.photo[msg.photo.length - 1]; const fileName = `photo_${Date.now()}.jpg`; saveFile(msg, photo.file_id, fileName, `${typePrefix}图片`); } // 视频 if (msg.video) { const fileName = msg.video.file_name || `video_${Date.now()}.mp4`; saveFile(msg, msg.video.file_id, fileName, `${typePrefix}视频`); } }); // /myfiles 文本列表 bot.onText(/\\/myfiles/, (msg) =\u003e { if (!checkAuth(msg)) return; const userId = msg.from.id; db.all( `SELECT id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT 10`, [userId], (err, rows) =\u003e { if (err) return bot.sendMessage(msg.chat.id, \"❌ 查询失败。\"); if (rows.length === 0) return bot.sendMessage(msg.chat.id, \"📭 没有找到文件。\"); let text = \"📂 最近的文件：\\n\\n\"; rows.forEach((r) =\u003e { text += `#${r.id} ${r.file_name} [${r.category}]\\n`; }); bot.sendMessage(msg.chat.id, text); } ); }); // /myfilelist 分页显示 async function sendFilePage(chatId, userId, page = 1, messageId = null) { const offset = (page - 1) * PAGE_SIZE; db.all( `SELECT id, file_id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT ? OFFSET ?`, [userId, PAGE_SIZE, offset], async (err, rows) =\u003e { if (err) return bot.sendMessage(chatId, \"❌ 查询失败。\"); if (rows.length === 0) return bot.sendMessage(chatId, \"📭 没有找到文件。\"); let text = `📑 第 ${page} 页（每页 ${PAGE_SIZE} 条）\\n\\n`; const inline_keyboard = []; const mediaGroup = []; for (const r of rows) { text += `#${r.id} ${r.file_name} [${r.category}]\\n`; inline_keyboard.push([ { text: \"❌ 删除\", callback_data: `del_${r.id}` }, { text: \"⬇️ 下载本地\", callback_data: `download_${r.id}` }, ]); if (r.file_name.endsWith(\".jpg\") || r.file_name.endsWith(\".png\")) { mediaGroup.push({ type: \"photo\", media: r.file_id, caption: `#${r.id} ${r.file_name}` }); } } const totalCountRow = await new Promise((resolve) =\u003e db.get(`SELECT COUNT(*) as cnt FROM files WHERE user_id = ?`, [userId], (err, row) =\u003e resolve(row) ) ); const totalPages = Math.ceil(totalCountRow.cnt / PAGE_SIZE); inline_keyboard.push([ { text: \"⬅️ 上一页\", callback_data: `page_${page - 1}` }, { text: \"➡️ 下一页\", callback_data: `page_${page + 1}` }, ]); const opts = { reply_markup: { inline_keyboard } }; if (mediaGroup.length \u003e 0) { try { await bot.sendMediaGroup(chatId, mediaGroup); } catch (err) { console.error(\"发送缩略图失败:\", err); } } if (messageId) { await bot.editMessageText(text, { chat_id: chatId, message_id: messageId, reply_markup: opts.reply_markup, }); } else { await bot.sendMessage(chatId, text, opts); } } ); } bot.onText(/\\/myfilelist ?(\\d+)?/, (msg, match) =\u003e { if (!checkAuth(msg)) return; const page = parseInt(match[1]) || 1; sendFilePage(msg.chat.id, msg.from.id, page); }); // /search 关键字 bot.onText(/\\/search (.+)/, (msg, match) =\u003e { if (!checkAuth(msg)) return; const keyword = `%${match[1]}%`; const userId = msg.from.id; db.all( `SELECT id, file_name, category FROM files WHERE user_id = ? AND file_name LIKE ? ORDER BY date DESC LIMIT 10`, [userId, keyword], (err, rows) =\u003e { if (err) return bot.sendMessage(msg.chat.id, \"❌ 查询失败。\"); if (rows.length === 0) return bot.sendMessage(msg.chat.id, \"🔍 没有匹配的文件。\"); let text = `🔍 搜索结果：\\n\\n`; rows.forEach((r) =\u003e { text += `#${r.id} ${r.file_name} [${r.category}]\\n`; }); bot.sendMessage(msg.chat.id, text); } ); }); // /getfile id bot.onText(/\\/getfile (\\d+)/, (msg, match) =\u003e { if (!checkAuth(msg)) return; const id = match[1]; db.get(`SELECT file_id, file_name FROM files WHERE id = ?`, [id], (err, row) =\u003e { if (!row) return bot.sendMessage(msg.chat.id, \"❌ 文件不存在。\"); if (row.file_name.endsWith(\".jpg\")) { bot.sendPhoto(msg.chat.id, row.file_id, { caption: row.file_name }); } else if (row.file_name.endsWith(\".mp4\")) { bot.sendVideo(msg.chat.id, row.file_id, { caption: row.file_name }); } else { bot.sendDocument(msg.chat.id, row.file_id, {}, { filename: row.file_name }); } }); }); // /delete id bot.onText(/\\/delete (\\d+)/, (msg, match) =\u003e { if (!checkAuth(msg)) return; const id = match[1]; const userId = msg.from.id; db.run(`DELETE FROM files WHERE id = ? AND user_id = ?`, [id, userId], function (err) { if (err) return bot.sendMessage(msg.chat.id, \"❌ 删除失败。\"); if (this.changes === 0) return bot.sendMessage(msg.chat.id, \"⚠️ 没找到该文件或无权限删除。\"); bot.sendMessage(msg.chat.id, `✅ 文件(ID=${id}) 已删除。`); }); }); // callback_query 统一处理 bot.on(\"callback_query\", async (query) =\u003e { const userId = query.from.id; const chatId = query.message.chat.id; if (!authenticatedUsers.has(userId)) { return bot.answerCallbackQuery(query.id, { text: \"⚠️ 请先登录 /login \u003c密码\u003e\" }); } if (query.data.startsWith(\"cat_\")) { const category = query.data.replace(\"cat_\", \"\"); userCategory[userId] = category; bot.sendMessage(chatId, `✅ 已设置分类为：${category}`); } if (query.data.startsWith(\"del_\")) { const fileId = query.data.replace(\"del_\", \"\"); const confirmOpts = { reply_markup: { inline_keyboard: [ [ { text: \"✅ 确认删除\", callback_data: `confirmdel_${fileId}` }, { text: \"❌ 取消\", callback_data: `cancel_${fileId}` }, ], ], }, }; bot.sendMessage(chatId, `⚠️ 确认要删除文件(ID=${fileId})吗？`, confirmOpts); } if (query.data.startsWith(\"confirmdel_\")) { const fileId = query.data.replace(\"confirmdel_\", \"\"); db.run(`DELETE FROM files WHERE id = ? AND user_id = ?`, [fileId, userId], function (err) { if (err) return bot.sendMessage(chatId, \"❌ 删除失败。\"); if (this.changes === 0) return bot.sendMessage(chatId, \"⚠️ 没找到该文件或无权限删除。\"); bot.sendMessage(chatId, `✅ 文件(ID=${fileId}) 已删除。`); }); } if (query.data.startsWith(\"cancel_\")) { const fileId = query.data.replace(\"cancel_\", \"\"); bot.sendMessage(chatId, `❎ 已取消删除文件(ID=${fileId})。`); } if (query.data.startsWith(\"page_\")) { const page = parseInt(query.data.replace(\"page_\", \"\")); if (page \u003c 1) return bot.answerCallbackQuery(query.id, { text: \"已经是第一页\" }); sendFilePage(chatId, userId, page, query.message.message_id); } if (query.data.startsWith(\"download_\")) { const id = query.data.replace(\"download_\", \"\"); db.get( `SELECT file_id, file_name, category FROM files WHERE id = ? AND user_id = ?`, [id, userId], async (err, row) =\u003e { if (!row) return bot.sendMessage(chatId, \"❌ 文件不存在或无权限下载。\"); try { const filePath = await downloadFile(row.file_id, row.file_name, row.category); bot.sendMessage(chatId, `✅ 文件已下载到服务器本地：${filePath}`); } catch (err) { console.error(err); bot.sendMessage(chatId, `❌ ${err.message}`); } } ); } bot.answerCallbackQuery(query.id); }); 用户必须先输入 /login admin123，否则所有命令都会提示 ⚠️ 请先使用 /login \u003c密码\u003e 登录。\n登录成功后，才可以正常使用 /start、上传文件、搜索、分页、删除、下载等功能。\nlist detail const TelegramBot = require(\"node-telegram-bot-api\"); const db = require(\"./db\"); const fs = require(\"fs\"); const path = require(\"path\"); const axios = require(\"axios\"); const config = require(\"./configbot\"); // 引入配置文件 const token = config.token; const categories = config.categories; const PAGE_SIZE = config.pageSize; // 从配置读取 const ADMIN_PASSWORD = config.adminPassword; // 管理密码 const bot = new TelegramBot(token, { polling: true }); // 保存分类信息（用户 -\u003e 当前选择的分类） const userCategory = {}; // 保存已登录用户 const authenticatedUsers = new Set(); // 本地存储根目录 const STORAGE_DIR = path.join(__dirname, \"files\"); if (!fs.existsSync(STORAGE_DIR)) fs.mkdirSync(STORAGE_DIR); // 检查是否已鉴权 function checkAuth(msg) { const userId = msg.from.id; if (!authenticatedUsers.has(userId)) { bot.sendMessage(msg.chat.id, \"⚠️ 请先使用 /login \u003c密码\u003e 登录。\"); return false; } return true; } // /login 命令 bot.onText(/\\/login (.+)/, (msg, match) =\u003e { const password = match[1]; const userId = msg.from.id; if (password === ADMIN_PASSWORD) { authenticatedUsers.add(userId); bot.sendMessage(msg.chat.id, \"✅ 登录成功，您已获得访问权限。\"); } else { bot.sendMessage(msg.chat.id, \"❌ 密码错误。\"); } }); // /start 命令 bot.onText(/\\/start/, (msg) =\u003e { if (!checkAuth(msg)) return; bot.sendMessage( msg.chat.id, \"欢迎使用文件存储机器人！\\n\\n命令：\\n\" + \"/setcategory 设置分类\\n\" + \"/myfiles 查看最近文件(文字列表)\\n\" + \"/myfilelist [页码] 文件分页显示\\n\" + \"/search 关键字 搜索文件\\n\" + \"/getfile id 获取文件\\n\" + \"/delete id 删除文件\\n\" + \"📥 点击文件后的“下载本地”或“查看详情”按钮操作\" ); }); // /setcategory 显示按钮 bot.onText(/\\/setcategory/, (msg) =\u003e { if (!checkAuth(msg)) return; const opts = { reply_markup: { inline_keyboard: categories.map((c) =\u003e [{ text: c, callback_data: `cat_${c}` }]), }, }; bot.sendMessage(msg.chat.id, \"请选择分类：\", opts); }); // 通用保存函数 function saveFile(msg, fileId, fileName, type) { const userId = msg.from.id; const chatId = msg.chat.id; const category = userCategory[userId] || \"未分类\"; db.run( `INSERT INTO files (file_id, file_name, category, user_id, date) VALUES (?, ?, ?, ?, datetime('now'))`, [fileId, fileName, category, userId], function (err) { if (err) { console.error(err); bot.sendMessage(chatId, \"❌ 存储失败。\"); } else { bot.sendMessage( chatId, `📦 已保存 ${type}\\nID: ${this.lastID}\\n文件名: ${fileName}\\n分类: ${category}` ); } } ); } // 下载文件到本地（带重试和日志） async function downloadFile(fileId, fileName, category, retries = 3) { const dir = path.join(STORAGE_DIR, category); if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true }); const filePath = path.join(dir, fileName); for (let attempt = 1; attempt \u003c= retries; attempt++) { try { console.log(`下载文件尝试 ${attempt}/${retries}：${fileName}`); const url = await bot.getFileLink(fileId); // 获取文件链接 const writer = fs.createWriteStream(filePath); const response = await axios({ url, method: \"GET\", responseType: \"stream\", timeout: 30000, // 30秒超时 }); response.data.pipe(writer); await new Promise((resolve, reject) =\u003e { writer.on(\"finish\", resolve); writer.on(\"error\", reject); }); console.log(`✅ 文件下载成功：${filePath}`); return filePath; } catch (err) { console.error(`❌ 下载文件失败（尝试 ${attempt}）：${fileName}`, err); if (attempt === retries) { throw new Error(`下载文件失败，请稍后重试：${fileName}`); } // 等待 1 秒后重试 await new Promise((res) =\u003e setTimeout(res, 1000)); } } } // 统一处理消息（普通消息和转发消息） bot.on(\"message\", (msg) =\u003e { if (!checkAuth(msg)) return; const hasFile = msg.document || msg.photo || msg.video; const isForward = msg.forward_from || msg.forward_from_chat; if (!hasFile) return; const typePrefix = isForward ? \"转发\" : \"\"; // 文档 if (msg.document) { saveFile(msg, msg.document.file_id, msg.document.file_name, `${typePrefix}文档`); } // 图片 if (msg.photo) { const photo = msg.photo[msg.photo.length - 1]; const fileName = `photo_${Date.now()}.jpg`; saveFile(msg, photo.file_id, fileName, `${typePrefix}图片`); } // 视频 if (msg.video) { const fileName = msg.video.file_name || `video_${Date.now()}.mp4`; saveFile(msg, msg.video.file_id, fileName, `${typePrefix}视频`); } }); // /myfiles 文本列表 bot.onText(/\\/myfiles/, (msg) =\u003e { if (!checkAuth(msg)) return; const userId = msg.from.id; db.all( `SELECT id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT 10`, [userId], (err, rows) =\u003e { if (err) return bot.sendMessage(msg.chat.id, \"❌ 查询失败。\"); if (rows.length === 0) return bot.sendMessage(msg.chat.id, \"📭 没有找到文件。\"); let text = \"📂 最近的文件：\\n\\n\"; const inline_keyboard = []; rows.forEach((r) =\u003e { text += `#${r.id} ${r.file_name} [${r.category}]\\n`; inline_keyboard.push([{ text: \"ℹ️ 查看详情\", callback_data: `detail_${r.id}` }]); }); bot.sendMessage(msg.chat.id, text, { reply_markup: { inline_keyboard } }); } ); }); // /myfilelist 分页显示 async function sendFilePage(chatId, userId, page = 1, messageId = null) { const offset = (page - 1) * PAGE_SIZE; db.all( `SELECT id, file_id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT ? OFFSET ?`, [userId, PAGE_SIZE, offset], async (err, rows) =\u003e { if (err) return bot.sendMessage(chatId, \"❌ 查询失败。\"); if (rows.length === 0) return bot.sendMessage(chatId, \"📭 没有找到文件。\"); let text = `📑 第 ${page} 页（每页 ${PAGE_SIZE} 条）\\n\\n`; const inline_keyboard = []; const mediaGroup = []; for (const r of rows) { text += `#${r.id} ${r.file_name} [${r.category}]\\n`; inline_keyboard.push([ { text: \"ℹ️ 查看详情\", callback_data: `detail_${r.id}` }, { text: \"❌ 删除\", callback_data: `del_${r.id}` }, { text: \"⬇️ 下载本地\", callback_data: `download_${r.id}` }, ]); if (r.file_name.endsWith(\".jpg\") || r.file_name.endsWith(\".png\")) { mediaGroup.push({ type: \"photo\", media: r.file_id, caption: `#${r.id} ${r.file_name}` }); } } const totalCountRow = await new Promise((resolve) =\u003e db.get(`SELECT COUNT(*) as cnt FROM files WHERE user_id = ?`, [userId], (err, row) =\u003e resolve(row) ) ); const totalPages = Math.ceil(totalCountRow.cnt / PAGE_SIZE); inline_keyboard.push([ { text: \"⬅️ 上一页\", callback_data: `page_${page - 1}` }, { text: \"➡️ 下一页\", callback_data: `page_${page + 1}` }, ]); const opts = { reply_markup: { inline_keyboard } }; if (mediaGroup.length \u003e 0) { try { await bot.sendMediaGroup(chatId, mediaGroup); } catch (err) { console.error(\"发送缩略图失败:\", err); } } if (messageId) { await bot.editMessageText(text, { chat_id: chatId, message_id: messageId, reply_markup: opts.reply_markup, }); } else { await bot.sendMessage(chatId, text, opts); } } ); } bot.onText(/\\/myfilelist ?(\\d+)?/, (msg, match) =\u003e { if (!checkAuth(msg)) return; const page = parseInt(match[1]) || 1; sendFilePage(msg.chat.id, msg.from.id, page); }); // /search 关键字 bot.onText(/\\/search (.+)/, (msg, match) =\u003e { if (!checkAuth(msg)) return; const keyword = `%${match[1]}%`; const userId = msg.from.id; db.all( `SELECT id, file_name, category FROM files WHERE user_id = ? AND file_name LIKE ? ORDER BY date DESC LIMIT 10`, [userId, keyword], (err, rows) =\u003e { if (err) return bot.sendMessage(msg.chat.id, \"❌ 查询失败。\"); if (rows.length === 0) return bot.sendMessage(msg.chat.id, \"🔍 没有匹配的文件。\"); let text = `🔍 搜索结果：\\n\\n`; const inline_keyboard = []; rows.forEach((r) =\u003e { text += `#${r.id} ${r.file_name} [${r.category}]\\n`; inline_keyboard.push([{ text: \"ℹ️ 查看详情\", callback_data: `detail_${r.id}` }]); }); bot.sendMessage(msg.chat.id, text, { reply_markup: { inline_keyboard } }); } ); }); // /getfile id bot.onText(/\\/getfile (\\d+)/, (msg, match) =\u003e { if (!checkAuth(msg)) return; const id = match[1]; db.get(`SELECT file_id, file_name FROM files WHERE id = ?`, [id], (err, row) =\u003e { if (!row) return bot.sendMessage(msg.chat.id, \"❌ 文件不存在。\"); if (row.file_name.endsWith(\".jpg\")) { bot.sendPhoto(msg.chat.id, row.file_id, { caption: row.file_name }); } else if (row.file_name.endsWith(\".mp4\")) { bot.sendVideo(msg.chat.id, row.file_id, { caption: row.file_name }); } else { bot.sendDocument(msg.chat.id, row.file_id, {}, { filename: row.file_name }); } }); }); // /delete id bot.onText(/\\/delete (\\d+)/, (msg, match) =\u003e { if (!checkAuth(msg)) return; const id = match[1]; const userId = msg.from.id; db.run(`DELETE FROM files WHERE id = ? AND user_id = ?`, [id, userId], function (err) { if (err) return bot.sendMessage(msg.chat.id, \"❌ 删除失败。\"); if (this.changes === 0) return bot.sendMessage(msg.chat.id, \"⚠️ 没找到该文件或无权限删除。\"); bot.sendMessage(msg.chat.id, `✅ 文件(ID=${id}) 已删除。`); }); }); // callback_query 统一处理 bot.on(\"callback_query\", async (query) =\u003e { const userId = query.from.id; const chatId = query.message.chat.id; if (!authenticatedUsers.has(userId)) { return bot.answerCallbackQuery(query.id, { text: \"⚠️ 请先登录 /login \u003c密码\u003e\" }); } if (query.data.startsWith(\"cat_\")) { const category = query.data.replace(\"cat_\", \"\"); userCategory[userId] = category; bot.sendMessage(chatId, `✅ 已设置分类为：${category}`); } if (query.data.startsWith(\"del_\")) { const fileId = query.data.replace(\"del_\", \"\"); const confirmOpts = { reply_markup: { inline_keyboard: [ [ { text: \"✅ 确认删除\", callback_data: `confirmdel_${fileId}` }, { text: \"❌ 取消\", callback_data: `cancel_${fileId}` }, ], ], }, }; bot.sendMessage(chatId, `⚠️ 确认要删除文件(ID=${fileId})吗？`, confirmOpts); } if (query.data.startsWith(\"confirmdel_\")) { const fileId = query.data.replace(\"confirmdel_\", \"\"); db.run(`DELETE FROM files WHERE id = ? AND user_id = ?`, [fileId, userId], function (err) { if (err) return bot.sendMessage(chatId, \"❌ 删除失败。\"); if (this.changes === 0) return bot.sendMessage(chatId, \"⚠️ 没找到该文件或无权限删除。\"); bot.sendMessage(chatId, `✅ 文件(ID=${fileId}) 已删除。`); }); } if (query.data.startsWith(\"cancel_\")) { const fileId = query.data.replace(\"cancel_\", \"\"); bot.sendMessage(chatId, `❎ 已取消删除文件(ID=${fileId})。`); } if (query.data.startsWith(\"page_\")) { const page = parseInt(query.data.replace(\"page_\", \"\")); if (page \u003c 1) return bot.answerCallbackQuery(query.id, { text: \"已经是第一页\" }); sendFilePage(chatId, userId, page, query.message.message_id); } if (query.data.startsWith(\"download_\")) { const id = query.data.replace(\"download_\", \"\"); db.get( `SELECT file_id, file_name, category FROM files WHERE id = ? AND user_id = ?`, [id, userId], async (err, row) =\u003e { if (!row) return bot.sendMessage(chatId, \"❌ 文件不存在或无权限下载。\"); try { const filePath = await downloadFile(row.file_id, row.file_name, row.category); bot.sendMessage(chatId, `✅ 文件已下载到服务器本地：${filePath}`); } catch (err) { console.error(err); bot.sendMessage(chatId, `❌ ${err.message}`); } } ); } if (query.data.startsWith(\"detail_\")) { const id = query.data.replace(\"detail_\", \"\"); db.get( `SELECT id, file_id, file_name, category, date, user_id FROM files WHERE id = ? AND user_id = ?`, [id, userId], (err, row) =\u003e { if (!row) return bot.sendMessage(chatId, \"❌ 文件不存在或无权限查看。\"); const text = `📋 文件详情\\n\\n` + `ID: ${row.id}\\n` + `文件名: ${row.file_name}\\n` + `分类: ${row.category}\\n` + `上传时间: ${row.date}\\n` + `用户ID: ${row.user_id}`; bot.sendMessage(chatId, text).then(() =\u003e { // 自动发送文件 if (row.file_name.endsWith(\".jpg\") || row.file_name.endsWith(\".png\")) { bot.sendPhoto(chatId, row.file_id, { caption: row.file_name }); } else if (row.file_name.endsWith(\".mp4\")) { bot.sendVideo(chatId, row.file_id, { caption: row.file_name }); } else { bot.sendDocument(chatId, row.file_id, {}, { filename: row.file_name }); } }); } ); } bot.answerCallbackQuery(query.id); }); Docker # 使用官方 Node.js 镜像 FROM node:20 # 设置工作目录 WORKDIR /app # 复制 package.json 和 package-lock.json COPY package*.json ./ # 安装依赖 RUN npm install --production # 复制项目代码 COPY . . # 暴露端口（根据 app.js 监听的端口） EXPOSE 3000 # 容器启动命令 CMD [\"node\", \"bot.js\"] docker build -t my-node-app . docker run -d \\ --name node-app \\ -p 3000:3000 \\ -v $(pwd):/app \\ --restart unless-stopped \\ my-node-app 原始消息 数据库结构更新 (db.js) 添加了转发消息相关字段： is_forward: 是否为转发消息 forward_from_chat_id: 来源群组ID forward_from_chat_title: 来源群组名称 forward_from_chat_type: 群组类型 forward_from_chat_username: 群组用户名 forward_message_id: 转发消息ID jump_link: 跳转链接\n转发消息处理 (bot.js) 保存群组信息：检测转发消息并保存完整的群组信息 生成跳转链接： 公开群组/频道：https://t.me/{username}/{message_id} 私有群组：https://t.me/c/{chat_id}/{message_id} 显示来源：在文件列表中显示来源群组名称\n按钮布局更新 将原来的按钮布局改为：\nℹ️ 详情 - 查看文件详细信息 ❌ 删除 - 删除文件 ⬇️ 下载 - 下载文件到服务器本地 🔗 跳转 - 跳转到原始消息（仅转发消息显示）\n详情页面增强 显示是否为转发消息 显示来源群组信息 显示群组类型 显示跳转链接\n自动识别并保存转发的群组消息 为每个转发消息生成可点击的跳转链接 在文件列表中显示统一的四个按钮：详情、删除、下载、跳转 区分公开群和私有群，生成正确的链接格式\n// 通用保存函数 function saveFile(msg, fileId, fileName, type) { const userId = msg.from.id; const chatId = msg.chat.id; const category = userCategory[userId] || \"未分类\"; // 检查是否为转发消息 const isForward = msg.forward_from || msg.forward_from_chat; let forwardInfo = { is_forward: isForward ? 1 : 0, forward_from_chat_id: null, forward_from_chat_title: null, forward_from_chat_type: null, forward_from_chat_username: null, forward_message_id: null, jump_link: null }; if (isForward \u0026\u0026 msg.forward_from_chat) { const forwardChat = msg.forward_from_chat; forwardInfo.forward_from_chat_id = forwardChat.id; forwardInfo.forward_from_chat_title = forwardChat.title; forwardInfo.forward_from_chat_type = forwardChat.type; forwardInfo.forward_from_chat_username = forwardChat.username; forwardInfo.forward_message_id = msg.forward_from_message_id; // 生成跳转链接 if (forwardChat.username) { // 公开群组/频道 forwardInfo.jump_link = `https://t.me/${forwardChat.username}/${msg.forward_from_message_id}`; } else { // 私有群组 forwardInfo.jump_link = `https://t.me/c/${Math.abs(forwardChat.id).toString().substring(4)}/${msg.forward_from_message_id}`; } } db.run( `INSERT INTO files (file_id, file_name, category, user_id, date, is_forward, forward_from_chat_id, forward_from_chat_title, forward_from_chat_type, forward_from_chat_username, forward_message_id, jump_link) VALUES (?, ?, ?, ?, datetime('now'), ?, ?, ?, ?, ?, ?, ?)`, [fileId, fileName, category, userId, forwardInfo.is_forward, forwardInfo.forward_from_chat_id, forwardInfo.forward_from_chat_title, forwardInfo.forward_from_chat_type, forwardInfo.forward_from_chat_username, forwardInfo.forward_message_id, forwardInfo.jump_link], function (err) { if (err) { console.error(err); bot.sendMessage(chatId, \"❌ 存储失败。\"); } else { let message = `📦 已保存 ${type}\\nID: ${this.lastID}\\n文件名: ${fileName}\\n分类: ${category}`; if (forwardInfo.is_forward \u0026\u0026 forwardInfo.forward_from_chat_title) { message += `\\n来源群组: ${forwardInfo.forward_from_chat_title}`; } bot.sendMessage(chatId, message); } } ); } bots https://github.com/AZeC4/TelegramBot\nhttps://github.com/itgoyo/TelegramBot\nhttps://github.com/itgoyo/TelegramGroup\nNext TGBOT LocalWeb Manage\ngo txt config 新建 回复 Q:A 适用于群回复\n分类 列表 对应分类 sql备份 前端后台等\n","wordCount":"7956","inLanguage":"en","datePublished":"2025-08-26T22:51:47+08:00","dateModified":"2025-08-26T22:51:47+08:00","author":{"@type":"Person","name":"dwd"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://qfsyso.github.io/posts/node-tg-filebot/"},"publisher":{"@type":"Organization","name":"MLOG","logo":{"@type":"ImageObject","url":"https://qfsyso.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://qfsyso.github.io/ accesskey=h title="MLOG (Alt + H)">MLOG</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://qfsyso.github.io/posts/ title=Archive><span>Archive</span></a></li><li><a href=https://qfsyso.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://qfsyso.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Node TG FileBot</h1><div class=post-meta><span title='2025-08-26 22:51:47 +0800 +0800'>August 26, 2025</span>&nbsp;·&nbsp;38 min&nbsp;·&nbsp;dwd</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e5%8a%9f%e8%83%bd aria-label=功能>功能</a><ul><li><a href=#%e5%91%bd%e4%bb%a4 aria-label=命令：>命令：</a></li><li><a href=#%e6%8c%89%e9%92%ae%e6%93%8d%e4%bd%9c aria-label=按钮操作：>按钮操作：</a></li><li><a href=#%e6%96%87%e4%bb%b6%e5%ad%98%e5%82%a8 aria-label=文件存储>文件存储</a></li><li><a href=#%e4%be%9d%e8%b5%96 aria-label=依赖>依赖</a></li><li><a href=#%e9%a1%b9%e7%9b%ae%e7%9b%ae%e5%bd%95%e7%bb%93%e6%9e%84 aria-label=项目目录结构>项目目录结构</a></li><li><a href=#%e6%b3%a8%e6%84%8f%e4%ba%8b%e9%a1%b9 aria-label=注意事项>注意事项</a></li></ul></li><li><a href=#bot aria-label=Bot>Bot</a><ul><li><a href=#%e5%9c%a8-botfather-%e5%88%9b%e5%bb%ba%e6%9c%ba%e5%99%a8%e4%ba%ba aria-label="在 BotFather 创建机器人">在 BotFather 创建机器人</a></li><li><a href=#nodejs-%e9%a1%b9%e7%9b%ae%e5%88%9d%e5%a7%8b%e5%8c%96 aria-label="Node.js 项目初始化">Node.js 项目初始化</a></li><li><a href=#%e5%bb%ba-sqlite-%e6%95%b0%e6%8d%ae%e5%ba%93%e8%a1%a8 aria-label="建 SQLite 数据库表">建 SQLite 数据库表</a></li><li><a href=#bot-1 aria-label=bot>bot</a></li><li><a href=#run aria-label=run>run</a></li></ul></li><li><a href=#inline-keyboard----search aria-label="inline keyboard    search">inline keyboard search</a></li><li><a href=#pic-video aria-label="pic video">pic video</a></li><li><a href=#list aria-label=list>list</a></li><li><a href=#del aria-label=del>del</a></li><li><a href=#loacl-downloadfile aria-label="Loacl DownloadFile">Loacl DownloadFile</a></li><li><a href=#mv aria-label=Mv>Mv</a></li><li><a href=#configjs aria-label=config.js>config.js</a></li><li><a href=#login aria-label=login>login</a></li><li><a href=#list-detail aria-label="list detail">list detail</a></li><li><a href=#docker aria-label=Docker>Docker</a></li><li><a href=#%e5%8e%9f%e5%a7%8b%e6%b6%88%e6%81%af aria-label=原始消息>原始消息</a><ul><li><a href=#%e6%95%b0%e6%8d%ae%e5%ba%93%e7%bb%93%e6%9e%84%e6%9b%b4%e6%96%b0-dbjs aria-label="数据库结构更新 (db.js)">数据库结构更新 (db.js)</a></li><li><a href=#%e8%bd%ac%e5%8f%91%e6%b6%88%e6%81%af%e5%a4%84%e7%90%86-botjs aria-label="转发消息处理 (bot.js)">转发消息处理 (bot.js)</a></li><li><a href=#%e6%8c%89%e9%92%ae%e5%b8%83%e5%b1%80%e6%9b%b4%e6%96%b0 aria-label=按钮布局更新>按钮布局更新</a></li><li><a href=#%e8%af%a6%e6%83%85%e9%a1%b5%e9%9d%a2%e5%a2%9e%e5%bc%ba aria-label=详情页面增强>详情页面增强</a></li></ul></li><li><a href=#bots aria-label=bots>bots</a></li><li><a href=#next-tgbot aria-label="Next TGBOT">Next TGBOT</a></li></ul></div></details></div><div class=post-content><p>Node.js TG 文件管理机器人，支持分类存储、分页浏览、搜索、下载、删除文件，同时支持图片缩略图预览和服务器本地下载。</p><h1 id=功能>功能<a hidden class=anchor aria-hidden=true href=#功能>#</a></h1><p>文件分类管理：支持用户自定义分类。</p><p>文件上传自动保存：支持文档、图片、视频，并记录上传用户和分类。</p><p>分页查看文件列表：可分页显示最近上传的文件。</p><p>图片缩略图：在分页列表中显示图片缩略图。</p><p>文件搜索：按文件名关键字搜索文件。</p><p>获取文件：支持发送文件回 Telegram。</p><p>删除文件：支持单个文件删除，带确认机制。</p><p>下载到本地：将文件下载到服务器本地，支持重试和错误提示。</p><h2 id=命令>命令：<a hidden class=anchor aria-hidden=true href=#命令>#</a></h2><p>/start # 欢迎信息和操作提示
/setcategory # 设置文件分类
/myfiles # 查看最近 10 条文件
/myfilelist [页码] # 分页显示文件列表
/search 关键字 # 搜索文件
/getfile id # 获取文件到 Telegram
/delete id # 删除文件</p><h2 id=按钮操作>按钮操作：<a hidden class=anchor aria-hidden=true href=#按钮操作>#</a></h2><p>分类选择：在 /setcategory 后点击按钮设置分类。</p><p>删除文件：点击“删除”按钮，带确认操作。</p><p>下载文件：点击“下载本地”按钮，将文件下载到服务器本地。</p><p>分页：点击上一页/下一页翻页。</p><h2 id=文件存储>文件存储<a hidden class=anchor aria-hidden=true href=#文件存储>#</a></h2><p>默认本地存储目录：./files/分类名/文件名</p><p>支持自动创建分类目录。</p><p>图片会在分页列表显示缩略图。</p><p>错误处理和日志</p><p>文件下载支持 3 次重试，失败会输出控制台日志。</p><p>用户端收到友好提示，不会导致 bot 崩掉。</p><h2 id=依赖>依赖<a hidden class=anchor aria-hidden=true href=#依赖>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>node-telegram-bot-api
</span></span><span style=display:flex><span>sqlite3
</span></span><span style=display:flex><span>axios
</span></span><span style=display:flex><span>Node.js &gt;<span style=color:#f92672>=</span> <span style=color:#ae81ff>16</span>
</span></span></code></pre></div><h2 id=项目目录结构>项目目录结构<a hidden class=anchor aria-hidden=true href=#项目目录结构>#</a></h2><p>bot.js # 主程序
db.js # SQLite 数据库封装
files/ # 本地文件存储目录
node_modules/ # 依赖库
package.json</p><h2 id=注意事项>注意事项<a hidden class=anchor aria-hidden=true href=#注意事项>#</a></h2><p>确保服务器可以访问 Telegram API（国内可能需要代理）。</p><p>token 必须正确，且 bot 有文件读取权限。</p><p>图片缩略图通过 Telegram sendMediaGroup 实现，其他文件显示为文字列表。</p><p>下载文件到本地时，如果失败会重试 3 次并记录日志。</p><h1 id=bot>Bot<a hidden class=anchor aria-hidden=true href=#bot>#</a></h1><h2 id=在-botfather-创建机器人>在 BotFather 创建机器人<a hidden class=anchor aria-hidden=true href=#在-botfather-创建机器人>#</a></h2><p>打开 TG，搜索 BotFather。</p><p>输入 /start。</p><p>输入 /newbot → 按提示给机器人取名字（例如：FileStorageBot）。</p><p>BotFather 会返回一个 HTTP API Token，类似：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>1234567890:ABCdefGhIjKlmNoPQRstuVWxyZ
</span></span></code></pre></div><p>这个就是 Node.js 代码里要用的 BOT_TOKEN。</p><h2 id=nodejs-项目初始化>Node.js 项目初始化<a hidden class=anchor aria-hidden=true href=#nodejs-项目初始化>#</a></h2><p>在服务器或本地环境里执行：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir tg-file-storage-bot
</span></span><span style=display:flex><span>cd tg-file-storage-bot
</span></span><span style=display:flex><span>npm init -y
</span></span><span style=display:flex><span>npm install node-telegram-bot-api sqlite3
</span></span></code></pre></div><p>node-telegram-bot-api → Telegram 机器人 SDK</p><p>sqlite3 → 存储文件信息（文件分类、路径等）</p><h2 id=建-sqlite-数据库表>建 SQLite 数据库表<a hidden class=anchor aria-hidden=true href=#建-sqlite-数据库表>#</a></h2><p>新建一个 db.js：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>sqlite3</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;sqlite3&#39;</span>).<span style=color:#a6e22e>verbose</span>();
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>db</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>sqlite3</span>.<span style=color:#a6e22e>Database</span>(<span style=color:#e6db74>&#39;./files.db&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>serialize</span>(() =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>run</span>(<span style=color:#e6db74>`
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    CREATE TABLE IF NOT EXISTS files (
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      id INTEGER PRIMARY KEY AUTOINCREMENT,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      file_id TEXT,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      file_name TEXT,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      category TEXT,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      user_id TEXT,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      date DATETIME DEFAULT CURRENT_TIMESTAMP
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    )
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  `</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>db</span>;
</span></span></code></pre></div><h2 id=bot-1>bot<a hidden class=anchor aria-hidden=true href=#bot-1>#</a></h2><p>新建 bot.js：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>TelegramBot</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;node-telegram-bot-api&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>db</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;./db&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;TOKEN&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>bot</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>TelegramBot</span>(<span style=color:#a6e22e>token</span>, { <span style=color:#a6e22e>polling</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 保存分类信息（用户 -&gt; 当前选择的分类）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userCategory</span> <span style=color:#f92672>=</span> {};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /start 命令
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/start/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;欢迎使用文件存储机器人！\n\n命令：\n/setcategory 分类名\n/myfiles 查看我的文件&#34;</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 设置分类
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/setcategory (.+)/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>category</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>userCategory</span>[<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>category</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>`✅ 已设置分类为：</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\n请直接发送文件，我会帮存储。`</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 接收文件（文档）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;document&#34;</span>, <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.document.<span style=color:#a6e22e>file_id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileName</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.document.<span style=color:#a6e22e>file_name</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>category</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>userCategory</span>[<span style=color:#a6e22e>userId</span>] <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;未分类&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>run</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`INSERT INTO files (file_id, file_name, category, user_id) VALUES (?, ?, ?, ?)`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#a6e22e>category</span>, <span style=color:#a6e22e>userId</span>],
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>err</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;❌ 存储失败。&#34;</span>);
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>`📂 文件已保存：</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\n分类：</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 查看文件列表
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/myfiles/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>all</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT 10`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>userId</span>],
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>rows</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;❌ 查询失败。&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;📭 没有找到文件。&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>text</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;📂 最近的文件：\n\n&#34;</span>;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>r</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>text</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74> [</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>]\n`</span>;
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>text</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 回复 /getfile id 来取回文件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/getfile (\d+)/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>`SELECT file_id, file_name FROM files WHERE id = ?`</span>, [<span style=color:#a6e22e>id</span>], (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>row</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>row</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;❌ 文件不存在。&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendDocument</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, {}, { <span style=color:#a6e22e>filename</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><h2 id=run>run<a hidden class=anchor aria-hidden=true href=#run>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>node bot.js
</span></span></code></pre></div><p>然后在 TG 里打开机器人：</p><p>/setcategory 工作资料 → 设置分类</p><p>上传文件（文档、PDF、Zip 等）</p><p>/myfiles → 查看自己存的文件</p><p>/getfile 1 → 获取 ID=1 的文件</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>
</span></span><span style=display:flex><span>XXX, <span style=color:#f92672>[</span>2025/8/26 9:37<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>/start
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mybot1, <span style=color:#f92672>[</span>2025/8/26 9:37<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>欢迎使用文件存储机器人！
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>命令：
</span></span><span style=display:flex><span>/setcategory 分类名
</span></span><span style=display:flex><span>/myfiles 查看我的文件
</span></span></code></pre></div><h1 id=inline-keyboard----search>inline keyboard search<a hidden class=anchor aria-hidden=true href=#inline-keyboard----search>#</a></h1><p>新增分类 搜索</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>//bot.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>TelegramBot</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;node-telegram-bot-api&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>db</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;./db&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;XXXTOKEN&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>bot</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>TelegramBot</span>(<span style=color:#a6e22e>token</span>, { <span style=color:#a6e22e>polling</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 保存分类信息（用户 -&gt; 当前选择的分类）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userCategory</span> <span style=color:#f92672>=</span> {};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 预设分类
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>categories</span> <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;工作&#34;</span>, <span style=color:#e6db74>&#34;学习&#34;</span>, <span style=color:#e6db74>&#34;生活&#34;</span>, <span style=color:#e6db74>&#34;其他&#34;</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /start 命令
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/start/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;欢迎使用文件存储机器人！\n\n命令：\n/setcategory 设置分类\n/myfiles 查看我的文件\n/search 关键字 搜索文件\n/getfile id 获取文件&#34;</span>
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /setcategory 显示按钮
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/setcategory/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>opts</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reply_markup</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>inline_keyboard</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>categories</span>.<span style=color:#a6e22e>map</span>((<span style=color:#a6e22e>c</span>) =&gt; [{ <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`cat_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>c</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> }]),
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;请选择分类：&#34;</span>, <span style=color:#a6e22e>opts</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 处理按钮点击
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;callback_query&#34;</span>, (<span style=color:#a6e22e>query</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>chatId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;cat_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>category</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;cat_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>userCategory</span>[<span style=color:#a6e22e>userId</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>category</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`✅ 已设置分类为：</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>answerCallbackQuery</span>(<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>id</span>); <span style=color:#75715e>// 收起按钮 loading
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 接收文件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;document&#34;</span>, <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.document.<span style=color:#a6e22e>file_id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileName</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.document.<span style=color:#a6e22e>file_name</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>category</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>userCategory</span>[<span style=color:#a6e22e>userId</span>] <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;未分类&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>run</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`INSERT INTO files (file_id, file_name, category, user_id) VALUES (?, ?, ?, ?)`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#a6e22e>category</span>, <span style=color:#a6e22e>userId</span>],
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>err</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;❌ 存储失败。&#34;</span>);
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>`📂 文件已保存：</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\n分类：</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 查看文件列表
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/myfiles/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>all</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT 10`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>userId</span>],
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>rows</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;❌ 查询失败。&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;📭 没有找到文件。&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>text</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;📂 最近的文件：\n\n&#34;</span>;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>r</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>text</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74> [</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>]\n`</span>;
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>text</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 搜索文件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/search (.+)/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>keyword</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`%</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>%`</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>all</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT id, file_name, category FROM files WHERE user_id = ? AND file_name LIKE ? ORDER BY date DESC LIMIT 10`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>userId</span>, <span style=color:#a6e22e>keyword</span>],
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>rows</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;❌ 查询失败。&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;🔍 没有匹配的文件。&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>text</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`🔍 搜索结果：\n\n`</span>;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>r</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>text</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74> [</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>]\n`</span>;
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>text</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 回复 /getfile id 来取回文件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/getfile (\d+)/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>get</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT file_id, file_name FROM files WHERE id = ?`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>id</span>],
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>row</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>row</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;❌ 文件不存在。&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendDocument</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, {}, { <span style=color:#a6e22e>filename</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>
</span></span><span style=display:flex><span>XXX, <span style=color:#f92672>[</span>2025/8/26 9:37<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>/start
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mybot1, <span style=color:#f92672>[</span>2025/8/26 9:37<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>欢迎使用文件存储机器人！
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>命令：
</span></span><span style=display:flex><span>/setcategory 分类名
</span></span><span style=display:flex><span>/myfiles 查看我的文件
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>XXX, <span style=color:#f92672>[</span>2025/8/26 9:43<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>/start
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mybot1, <span style=color:#f92672>[</span>2025/8/26 9:43<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>欢迎使用文件存储机器人！
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>命令：
</span></span><span style=display:flex><span>/setcategory 设置分类
</span></span><span style=display:flex><span>/myfiles 查看我的文件
</span></span><span style=display:flex><span>/search 关键字 搜索文件
</span></span><span style=display:flex><span>/getfile id 获取文件
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>XXX, <span style=color:#f92672>[</span>2025/8/26 9:43<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>/setcategory
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mybot1, <span style=color:#f92672>[</span>2025/8/26 9:43<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>请选择分类：
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mybot1, <span style=color:#f92672>[</span>2025/8/26 9:43<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>✅ 已设置分类为：其他
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mybot1, <span style=color:#f92672>[</span>2025/8/26 9:45<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>📂 文件已保存：ttsbot.zip
</span></span><span style=display:flex><span>分类：其他
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>XXX, <span style=color:#f92672>[</span>2025/8/26 9:46<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>/search tts
</span></span></code></pre></div><h1 id=pic-video>pic video<a hidden class=anchor aria-hidden=true href=#pic-video>#</a></h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>//bot.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>TelegramBot</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;node-telegram-bot-api&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>db</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;./db&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;XXXTOKEN&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>bot</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>TelegramBot</span>(<span style=color:#a6e22e>token</span>, { <span style=color:#a6e22e>polling</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 保存分类信息（用户 -&gt; 当前选择的分类）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userCategory</span> <span style=color:#f92672>=</span> {};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 预设分类
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>categories</span> <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;工作&#34;</span>, <span style=color:#e6db74>&#34;学习&#34;</span>, <span style=color:#e6db74>&#34;生活&#34;</span>, <span style=color:#e6db74>&#34;其他&#34;</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /start 命令
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/start/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;欢迎使用文件存储机器人！\n\n命令：\n/setcategory 设置分类\n/myfiles 查看文件\n/search 关键字 搜索文件\n/getfile id 获取文件&#34;</span>
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /setcategory 显示按钮
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/setcategory/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>opts</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reply_markup</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>inline_keyboard</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>categories</span>.<span style=color:#a6e22e>map</span>((<span style=color:#a6e22e>c</span>) =&gt; [{ <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`cat_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>c</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> }]),
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;请选择分类：&#34;</span>, <span style=color:#a6e22e>opts</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 处理按钮点击
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;callback_query&#34;</span>, (<span style=color:#a6e22e>query</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>chatId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;cat_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>category</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;cat_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>userCategory</span>[<span style=color:#a6e22e>userId</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>category</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`✅ 已设置分类为：</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>answerCallbackQuery</span>(<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>id</span>); <span style=color:#75715e>// 收起按钮 loading
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 通用保存函数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#a6e22e>type</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>chatId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>category</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>userCategory</span>[<span style=color:#a6e22e>userId</span>] <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;未分类&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>run</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`INSERT INTO files (file_id, file_name, category, user_id) VALUES (?, ?, ?, ?)`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#a6e22e>category</span>, <span style=color:#a6e22e>userId</span>],
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;❌ 存储失败。&#34;</span>);
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>chatId</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>`📦 已保存 </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>type</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\nID: </span><span style=color:#e6db74>${</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>lastID</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\n文件名: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\n分类: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 监听文档（PDF, ZIP 等）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;document&#34;</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.document.<span style=color:#a6e22e>file_id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileName</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.document.<span style=color:#a6e22e>file_name</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#e6db74>&#34;文档&#34;</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 监听图片（包括转发的）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;photo&#34;</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// photo 是数组，选最高分辨率的
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>photo</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>photo</span>[<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>photo</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>photo</span>.<span style=color:#a6e22e>file_id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileName</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`photo_</span><span style=color:#e6db74>${</span>Date.<span style=color:#a6e22e>now</span>()<span style=color:#e6db74>}</span><span style=color:#e6db74>.jpg`</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#e6db74>&#34;图片&#34;</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 监听视频（包括转发的）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;video&#34;</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>video</span>.<span style=color:#a6e22e>file_id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileName</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>video</span>.<span style=color:#a6e22e>file_name</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>`video_</span><span style=color:#e6db74>${</span>Date.<span style=color:#a6e22e>now</span>()<span style=color:#e6db74>}</span><span style=color:#e6db74>.mp4`</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#e6db74>&#34;视频&#34;</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 查看文件列表
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/myfiles/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>all</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT 10`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>userId</span>],
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>rows</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;❌ 查询失败。&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;📭 没有找到文件。&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>text</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;📂 最近的文件：\n\n&#34;</span>;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>r</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>text</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74> [</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>]\n`</span>;
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>text</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 搜索文件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/search (.+)/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>keyword</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`%</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>%`</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>all</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT id, file_name, category FROM files WHERE user_id = ? AND file_name LIKE ? ORDER BY date DESC LIMIT 10`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>userId</span>, <span style=color:#a6e22e>keyword</span>],
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>rows</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;❌ 查询失败。&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;🔍 没有匹配的文件。&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>text</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`🔍 搜索结果：\n\n`</span>;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>r</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>text</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74> [</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>]\n`</span>;
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>text</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 回复 /getfile id 来取回文件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/getfile (\d+)/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>get</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT file_id, file_name FROM files WHERE id = ?`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>id</span>],
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>row</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>row</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;❌ 文件不存在。&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 根据扩展名类型发送不同消息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.jpg&#34;</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendPhoto</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, { <span style=color:#a6e22e>caption</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.mp4&#34;</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendVideo</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, { <span style=color:#a6e22e>caption</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendDocument</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, {}, { <span style=color:#a6e22e>filename</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><h1 id=list>list<a hidden class=anchor aria-hidden=true href=#list>#</a></h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-JS data-lang=JS><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>TelegramBot</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;node-telegram-bot-api&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>db</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;./db&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;XXXTOKEN&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>bot</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>TelegramBot</span>(<span style=color:#a6e22e>token</span>, { <span style=color:#a6e22e>polling</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 保存分类信息（用户 -&gt; 当前选择的分类）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userCategory</span> <span style=color:#f92672>=</span> {};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 预设分类
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>categories</span> <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;工作&#34;</span>, <span style=color:#e6db74>&#34;学习&#34;</span>, <span style=color:#e6db74>&#34;生活&#34;</span>, <span style=color:#e6db74>&#34;其他&#34;</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 每页显示条数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>PAGE_SIZE</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /start 命令
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/start/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;欢迎使用文件存储机器人！\n\n命令：\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/setcategory 设置分类\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/myfiles 查看最近文件(文字列表)\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/myfilelist [页码] 文件预览分页\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/search 关键字 搜索文件\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/getfile id 获取文件&#34;</span>
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /setcategory 显示按钮
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/setcategory/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>opts</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reply_markup</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>inline_keyboard</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>categories</span>.<span style=color:#a6e22e>map</span>((<span style=color:#a6e22e>c</span>) =&gt; [{ <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`cat_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>c</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> }]),
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;请选择分类：&#34;</span>, <span style=color:#a6e22e>opts</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 处理按钮点击
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;callback_query&#34;</span>, (<span style=color:#a6e22e>query</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>chatId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;cat_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>category</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;cat_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>userCategory</span>[<span style=color:#a6e22e>userId</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>category</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`✅ 已设置分类为：</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>answerCallbackQuery</span>(<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>id</span>); <span style=color:#75715e>// 收起按钮 loading
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 通用保存函数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#a6e22e>type</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>chatId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>category</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>userCategory</span>[<span style=color:#a6e22e>userId</span>] <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;未分类&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>run</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`INSERT INTO files (file_id, file_name, category, user_id) VALUES (?, ?, ?, ?)`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#a6e22e>category</span>, <span style=color:#a6e22e>userId</span>],
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;❌ 存储失败。&#34;</span>);
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>chatId</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>`📦 已保存 </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>type</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\nID: </span><span style=color:#e6db74>${</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>lastID</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\n文件名: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\n分类: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 监听文档
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;document&#34;</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.document.<span style=color:#a6e22e>file_id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileName</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.document.<span style=color:#a6e22e>file_name</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#e6db74>&#34;文档&#34;</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 监听图片
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;photo&#34;</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>photo</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>photo</span>[<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>photo</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>photo</span>.<span style=color:#a6e22e>file_id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileName</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`photo_</span><span style=color:#e6db74>${</span>Date.<span style=color:#a6e22e>now</span>()<span style=color:#e6db74>}</span><span style=color:#e6db74>.jpg`</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#e6db74>&#34;图片&#34;</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 监听视频
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;video&#34;</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>video</span>.<span style=color:#a6e22e>file_id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileName</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>video</span>.<span style=color:#a6e22e>file_name</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>`video_</span><span style=color:#e6db74>${</span>Date.<span style=color:#a6e22e>now</span>()<span style=color:#e6db74>}</span><span style=color:#e6db74>.mp4`</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#e6db74>&#34;视频&#34;</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /myfiles 文本列表
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/myfiles/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>all</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT 10`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>userId</span>],
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>rows</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;❌ 查询失败。&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;📭 没有找到文件。&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>text</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;📂 最近的文件：\n\n&#34;</span>;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>r</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>text</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74> [</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>]\n`</span>;
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>text</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /myfilelist [页码] 文件预览分页
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/myfilelist ?(\d+)?/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>page</span> <span style=color:#f92672>=</span> parseInt(<span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>]) <span style=color:#f92672>||</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>offset</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>page</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>*</span> <span style=color:#a6e22e>PAGE_SIZE</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>all</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT id, file_id, file_name, category 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     FROM files WHERE user_id = ? ORDER BY date DESC LIMIT ? OFFSET ?`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>userId</span>, <span style=color:#a6e22e>PAGE_SIZE</span>, <span style=color:#a6e22e>offset</span>],
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>rows</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;❌ 查询失败。&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;📭 没有找到文件。&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>`📑 第 </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>page</span><span style=color:#e6db74>}</span><span style=color:#e6db74> 页（每页 </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>PAGE_SIZE</span><span style=color:#e6db74>}</span><span style=color:#e6db74> 条）`</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>r</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>rows</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>caption</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\n分类：</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.jpg&#34;</span>)) {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendPhoto</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_id</span>, { <span style=color:#a6e22e>caption</span> });
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.mp4&#34;</span>)) {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendVideo</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_id</span>, { <span style=color:#a6e22e>caption</span> });
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendDocument</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_id</span>, {}, { <span style=color:#a6e22e>filename</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>caption</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /search 关键字
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/search (.+)/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>keyword</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`%</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>%`</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>all</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT id, file_name, category FROM files WHERE user_id = ? AND file_name LIKE ? ORDER BY date DESC LIMIT 10`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>userId</span>, <span style=color:#a6e22e>keyword</span>],
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>rows</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;❌ 查询失败。&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;🔍 没有匹配的文件。&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>text</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`🔍 搜索结果：\n\n`</span>;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>r</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>text</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74> [</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>]\n`</span>;
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>text</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /getfile id
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/getfile (\d+)/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>get</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT file_id, file_name FROM files WHERE id = ?`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>id</span>],
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>row</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>row</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;❌ 文件不存在。&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.jpg&#34;</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendPhoto</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, { <span style=color:#a6e22e>caption</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.mp4&#34;</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendVideo</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, { <span style=color:#a6e22e>caption</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendDocument</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, {}, { <span style=color:#a6e22e>filename</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><h1 id=del>del<a hidden class=anchor aria-hidden=true href=#del>#</a></h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>//bot
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>TelegramBot</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;node-telegram-bot-api&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>db</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;./db&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;XXXTOKEN&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>bot</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>TelegramBot</span>(<span style=color:#a6e22e>token</span>, { <span style=color:#a6e22e>polling</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 保存分类信息（用户 -&gt; 当前选择的分类）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userCategory</span> <span style=color:#f92672>=</span> {};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 预设分类
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>categories</span> <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;工作&#34;</span>, <span style=color:#e6db74>&#34;学习&#34;</span>, <span style=color:#e6db74>&#34;生活&#34;</span>, <span style=color:#e6db74>&#34;其他&#34;</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 每页显示条数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>PAGE_SIZE</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /start 命令
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/start/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;欢迎使用文件存储机器人！\n\n命令：\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/setcategory 设置分类\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/myfiles 查看最近文件(文字列表)\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/myfilelist [页码] 文件预览分页\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/search 关键字 搜索文件\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/getfile id 获取文件\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/delete id 删除文件&#34;</span>
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /setcategory 显示按钮
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/setcategory/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>opts</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reply_markup</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>inline_keyboard</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>categories</span>.<span style=color:#a6e22e>map</span>((<span style=color:#a6e22e>c</span>) =&gt; [{ <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`cat_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>c</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> }]),
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;请选择分类：&#34;</span>, <span style=color:#a6e22e>opts</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 通用保存函数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#a6e22e>type</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>chatId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>category</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>userCategory</span>[<span style=color:#a6e22e>userId</span>] <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;未分类&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>run</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`INSERT INTO files (file_id, file_name, category, user_id) VALUES (?, ?, ?, ?)`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#a6e22e>category</span>, <span style=color:#a6e22e>userId</span>],
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;❌ 存储失败。&#34;</span>);
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>chatId</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>`📦 已保存 </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>type</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\nID: </span><span style=color:#e6db74>${</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>lastID</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\n文件名: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\n分类: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 监听文档
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;document&#34;</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.document.<span style=color:#a6e22e>file_id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileName</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.document.<span style=color:#a6e22e>file_name</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#e6db74>&#34;文档&#34;</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 监听图片
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;photo&#34;</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>photo</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>photo</span>[<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>photo</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>photo</span>.<span style=color:#a6e22e>file_id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileName</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`photo_</span><span style=color:#e6db74>${</span>Date.<span style=color:#a6e22e>now</span>()<span style=color:#e6db74>}</span><span style=color:#e6db74>.jpg`</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#e6db74>&#34;图片&#34;</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 监听视频
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;video&#34;</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>video</span>.<span style=color:#a6e22e>file_id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileName</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>video</span>.<span style=color:#a6e22e>file_name</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>`video_</span><span style=color:#e6db74>${</span>Date.<span style=color:#a6e22e>now</span>()<span style=color:#e6db74>}</span><span style=color:#e6db74>.mp4`</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#e6db74>&#34;视频&#34;</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /myfiles 文本列表
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/myfiles/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>all</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT 10`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>userId</span>],
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>rows</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;❌ 查询失败。&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;📭 没有找到文件。&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>text</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;📂 最近的文件：\n\n&#34;</span>;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>r</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>text</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74> [</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>]\n`</span>;
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>text</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /myfilelist [页码] 文件预览分页
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/myfilelist ?(\d+)?/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>page</span> <span style=color:#f92672>=</span> parseInt(<span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>]) <span style=color:#f92672>||</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>offset</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>page</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>*</span> <span style=color:#a6e22e>PAGE_SIZE</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>all</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT id, file_id, file_name, category 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     FROM files WHERE user_id = ? ORDER BY date DESC LIMIT ? OFFSET ?`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>userId</span>, <span style=color:#a6e22e>PAGE_SIZE</span>, <span style=color:#a6e22e>offset</span>],
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>rows</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;❌ 查询失败。&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;📭 没有找到文件。&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>`📑 第 </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>page</span><span style=color:#e6db74>}</span><span style=color:#e6db74> 页（每页 </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>PAGE_SIZE</span><span style=color:#e6db74>}</span><span style=color:#e6db74> 条）`</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>r</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>rows</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>caption</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\n分类：</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>opts</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>reply_markup</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>inline_keyboard</span><span style=color:#f92672>:</span> [[{ <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;❌ 删除&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`del_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> }]],
</span></span><span style=display:flex><span>          },
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.jpg&#34;</span>)) {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendPhoto</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_id</span>, { <span style=color:#a6e22e>caption</span>, ...<span style=color:#a6e22e>opts</span> });
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.mp4&#34;</span>)) {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendVideo</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_id</span>, { <span style=color:#a6e22e>caption</span>, ...<span style=color:#a6e22e>opts</span> });
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendDocument</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_id</span>, {}, { <span style=color:#a6e22e>filename</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>caption</span>, <span style=color:#a6e22e>opts</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /search 关键字
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/search (.+)/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>keyword</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`%</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>%`</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>all</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT id, file_name, category FROM files WHERE user_id = ? AND file_name LIKE ? ORDER BY date DESC LIMIT 10`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>userId</span>, <span style=color:#a6e22e>keyword</span>],
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>rows</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;❌ 查询失败。&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;🔍 没有匹配的文件。&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>text</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`🔍 搜索结果：\n\n`</span>;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>r</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>text</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74> [</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>]\n`</span>;
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>text</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /getfile id
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/getfile (\d+)/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>get</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT file_id, file_name FROM files WHERE id = ?`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>id</span>],
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>row</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>row</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;❌ 文件不存在。&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.jpg&#34;</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendPhoto</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, { <span style=color:#a6e22e>caption</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.mp4&#34;</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendVideo</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, { <span style=color:#a6e22e>caption</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendDocument</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, {}, { <span style=color:#a6e22e>filename</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /delete id 命令删除
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/delete (\d+)/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>run</span>(<span style=color:#e6db74>`DELETE FROM files WHERE id = ? AND user_id = ?`</span>, [<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>userId</span>], <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;❌ 删除失败。&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>changes</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;⚠️ 没找到该文件或无权限删除。&#34;</span>);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>`✅ 文件(ID=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>) 已删除。`</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// callback_query 统一处理
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;callback_query&#34;</span>, (<span style=color:#a6e22e>query</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>chatId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 分类按钮
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;cat_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>category</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;cat_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>userCategory</span>[<span style=color:#a6e22e>userId</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>category</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`✅ 已设置分类为：</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 删除按钮（第一步：弹出确认）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;del_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;del_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>confirmOpts</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>reply_markup</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>inline_keyboard</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>          [
</span></span><span style=display:flex><span>            { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;✅ 确认删除&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`confirmdel_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>            { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;❌ 取消&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`cancel_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>          ],
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`⚠️ 确认要删除文件(ID=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>)吗？`</span>, <span style=color:#a6e22e>confirmOpts</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 确认删除（第二步）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;confirmdel_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;confirmdel_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>run</span>(
</span></span><span style=display:flex><span>      <span style=color:#e6db74>`DELETE FROM files WHERE id = ? AND user_id = ?`</span>,
</span></span><span style=display:flex><span>      [<span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>userId</span>],
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;❌ 删除失败。&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>changes</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;⚠️ 没找到该文件或无权限删除。&#34;</span>);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`✅ 文件(ID=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>) 已删除。`</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 取消删除
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;cancel_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;cancel_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`❎ 已取消删除文件(ID=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>)。`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>answerCallbackQuery</span>(<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>id</span>);
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><h1 id=loacl-downloadfile>Loacl DownloadFile<a hidden class=anchor aria-hidden=true href=#loacl-downloadfile>#</a></h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>TelegramBot</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;node-telegram-bot-api&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>db</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;./db&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fs</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;fs&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>path</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;path&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>axios</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;axios&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;TKTKg&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>bot</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>TelegramBot</span>(<span style=color:#a6e22e>token</span>, { <span style=color:#a6e22e>polling</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 保存分类信息（用户 -&gt; 当前选择的分类）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userCategory</span> <span style=color:#f92672>=</span> {};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 预设分类
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>categories</span> <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;work&#34;</span>, <span style=color:#e6db74>&#34;study&#34;</span>, <span style=color:#e6db74>&#34;life&#34;</span>, <span style=color:#e6db74>&#34;other&#34;</span>,<span style=color:#e6db74>&#34;yo&#34;</span>,<span style=color:#e6db74>&#34;yo2&#34;</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 每页显示条数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>PAGE_SIZE</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 本地存储根目录
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>STORAGE_DIR</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>join</span>(<span style=color:#a6e22e>__dirname</span>, <span style=color:#e6db74>&#34;files&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>existsSync</span>(<span style=color:#a6e22e>STORAGE_DIR</span>)) <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>mkdirSync</span>(<span style=color:#a6e22e>STORAGE_DIR</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /start 命令
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/start/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;欢迎使用文件存储机器人！\n\n命令：\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/setcategory 设置分类\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/myfiles 查看最近文件(文字列表)\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/myfilelist [页码] 文件预览分页\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/search 关键字 搜索文件\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/getfile id 获取文件\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/delete id 删除文件\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;📥 点击文件后的“下载本地”按钮可保存到服务器本地&#34;</span>
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /setcategory 显示按钮
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/setcategory/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>opts</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reply_markup</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>inline_keyboard</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>categories</span>.<span style=color:#a6e22e>map</span>((<span style=color:#a6e22e>c</span>) =&gt; [{ <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`cat_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>c</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> }]),
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;请选择分类：&#34;</span>, <span style=color:#a6e22e>opts</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 通用保存函数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#a6e22e>type</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>chatId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>category</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>userCategory</span>[<span style=color:#a6e22e>userId</span>] <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;未分类&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>run</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`INSERT INTO files (file_id, file_name, category, user_id) VALUES (?, ?, ?, ?)`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#a6e22e>category</span>, <span style=color:#a6e22e>userId</span>],
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;❌ 存储失败。&#34;</span>);
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>chatId</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>`📦 已保存 </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>type</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\nID: </span><span style=color:#e6db74>${</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>lastID</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\n文件名: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\n分类: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 下载文件到本地
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>downloadFile</span>(<span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#a6e22e>category</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>url</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>getFileLink</span>(<span style=color:#a6e22e>fileId</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>dir</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>join</span>(<span style=color:#a6e22e>STORAGE_DIR</span>, <span style=color:#a6e22e>category</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>existsSync</span>(<span style=color:#a6e22e>dir</span>)) <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>mkdirSync</span>(<span style=color:#a6e22e>dir</span>, { <span style=color:#a6e22e>recursive</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> });
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>filePath</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>join</span>(<span style=color:#a6e22e>dir</span>, <span style=color:#a6e22e>fileName</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>writer</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>createWriteStream</span>(<span style=color:#a6e22e>filePath</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>axios</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>url</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>method</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;GET&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>responseType</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;stream&#39;</span>
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>pipe</span>(<span style=color:#a6e22e>writer</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Promise((<span style=color:#a6e22e>resolve</span>, <span style=color:#a6e22e>reject</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>writer</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;finish&#39;</span>, () =&gt; <span style=color:#a6e22e>resolve</span>(<span style=color:#a6e22e>filePath</span>));
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>writer</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;error&#39;</span>, <span style=color:#a6e22e>reject</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#34;下载文件失败:&#34;</span>, <span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> <span style=color:#a6e22e>err</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 统一处理消息（普通消息和转发消息）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;message&#34;</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>hasFile</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.document <span style=color:#f92672>||</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>photo</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>video</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>isForward</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>forward_from</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>forward_from_chat</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>hasFile</span>) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>typePrefix</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>isForward</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;转发&#34;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 文档
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>msg</span>.document) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>msg</span>.document.<span style=color:#a6e22e>file_id</span>, <span style=color:#a6e22e>msg</span>.document.<span style=color:#a6e22e>file_name</span>, <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>typePrefix</span><span style=color:#e6db74>}</span><span style=color:#e6db74>文档`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 图片
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>photo</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>photo</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>photo</span>[<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>photo</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileName</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`photo_</span><span style=color:#e6db74>${</span>Date.<span style=color:#a6e22e>now</span>()<span style=color:#e6db74>}</span><span style=color:#e6db74>.jpg`</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>photo</span>.<span style=color:#a6e22e>file_id</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>typePrefix</span><span style=color:#e6db74>}</span><span style=color:#e6db74>图片`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 视频
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>video</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileName</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>video</span>.<span style=color:#a6e22e>file_name</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>`video_</span><span style=color:#e6db74>${</span>Date.<span style=color:#a6e22e>now</span>()<span style=color:#e6db74>}</span><span style=color:#e6db74>.mp4`</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>video</span>.<span style=color:#a6e22e>file_id</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>typePrefix</span><span style=color:#e6db74>}</span><span style=color:#e6db74>视频`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /myfiles 文本列表
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/myfiles/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>all</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT 10`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>userId</span>],
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>rows</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;❌ 查询失败。&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;📭 没有找到文件。&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>text</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;📂 最近的文件：\n\n&#34;</span>;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>r</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>text</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74> [</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>]\n`</span>;
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>text</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /myfilelist 分页显示
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>sendFilePage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#a6e22e>userId</span>, <span style=color:#a6e22e>page</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>messageId</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>offset</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>page</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>*</span> <span style=color:#a6e22e>PAGE_SIZE</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>all</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT id, file_id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT ? OFFSET ?`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>userId</span>, <span style=color:#a6e22e>PAGE_SIZE</span>, <span style=color:#a6e22e>offset</span>],
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>rows</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;❌ 查询失败。&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;📭 没有找到文件。&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>messageId</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>editMessageText</span>(<span style=color:#e6db74>`📑 第 </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>page</span><span style=color:#e6db74>}</span><span style=color:#e6db74> 页（每页 </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>PAGE_SIZE</span><span style=color:#e6db74>}</span><span style=color:#e6db74> 条）`</span>, {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>chat_id</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>chatId</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>message_id</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>messageId</span>,
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`📑 第 </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>page</span><span style=color:#e6db74>}</span><span style=color:#e6db74> 页（每页 </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>PAGE_SIZE</span><span style=color:#e6db74>}</span><span style=color:#e6db74> 条）`</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>r</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>rows</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>caption</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\n分类：</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>opts</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>reply_markup</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>inline_keyboard</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>              [{ <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;❌ 删除&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`del_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> }],
</span></span><span style=display:flex><span>              [{ <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;⬇️ 下载本地&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`download_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> }],
</span></span><span style=display:flex><span>            ],
</span></span><span style=display:flex><span>          },
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.jpg&#34;</span>)) {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendPhoto</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_id</span>, { <span style=color:#a6e22e>caption</span>, ...<span style=color:#a6e22e>opts</span> });
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.mp4&#34;</span>)) {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendVideo</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_id</span>, { <span style=color:#a6e22e>caption</span>, ...<span style=color:#a6e22e>opts</span> });
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendDocument</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_id</span>, {}, { <span style=color:#a6e22e>filename</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#a6e22e>caption</span>, <span style=color:#a6e22e>opts</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 翻页按钮
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>totalCountRow</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>new</span> Promise((<span style=color:#a6e22e>resolve</span>) =&gt;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>`SELECT COUNT(*) as cnt FROM files WHERE user_id = ?`</span>, [<span style=color:#a6e22e>userId</span>], (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>row</span>) =&gt; <span style=color:#a6e22e>resolve</span>(<span style=color:#a6e22e>row</span>))
</span></span><span style=display:flex><span>      );
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>totalPages</span> <span style=color:#f92672>=</span> Math.<span style=color:#a6e22e>ceil</span>(<span style=color:#a6e22e>totalCountRow</span>.<span style=color:#a6e22e>cnt</span> <span style=color:#f92672>/</span> <span style=color:#a6e22e>PAGE_SIZE</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>navOpts</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>reply_markup</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>inline_keyboard</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>            [
</span></span><span style=display:flex><span>              { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;⬅️ 上一页&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`page_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>page</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>              { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;➡️ 下一页&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`page_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>page</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>            ],
</span></span><span style=display:flex><span>          ],
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`分页导航：第 </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>page</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>totalPages</span><span style=color:#e6db74>}</span><span style=color:#e6db74> 页`</span>, <span style=color:#a6e22e>navOpts</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/myfilelist ?(\d+)?/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>page</span> <span style=color:#f92672>=</span> parseInt(<span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>]) <span style=color:#f92672>||</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>sendFilePage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>page</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /search 关键字
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/search (.+)/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>keyword</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`%</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>%`</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>all</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT id, file_name, category FROM files WHERE user_id = ? AND file_name LIKE ? ORDER BY date DESC LIMIT 10`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>userId</span>, <span style=color:#a6e22e>keyword</span>],
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>rows</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;❌ 查询失败。&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;🔍 没有匹配的文件。&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>text</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`🔍 搜索结果：\n\n`</span>;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>r</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>text</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74> [</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>]\n`</span>;
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>text</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /getfile id
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/getfile (\d+)/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>`SELECT file_id, file_name FROM files WHERE id = ?`</span>, [<span style=color:#a6e22e>id</span>], (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>row</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>row</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;❌ 文件不存在。&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.jpg&#34;</span>)) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendPhoto</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, { <span style=color:#a6e22e>caption</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.mp4&#34;</span>)) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendVideo</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, { <span style=color:#a6e22e>caption</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendDocument</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, {}, { <span style=color:#a6e22e>filename</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /delete id
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/delete (\d+)/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>run</span>(<span style=color:#e6db74>`DELETE FROM files WHERE id = ? AND user_id = ?`</span>, [<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>userId</span>], <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;❌ 删除失败。&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>changes</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;⚠️ 没找到该文件或无权限删除。&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>`✅ 文件(ID=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>) 已删除。`</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// callback_query 统一处理
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;callback_query&#34;</span>, <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>query</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>chatId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 分类按钮
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;cat_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>category</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;cat_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>userCategory</span>[<span style=color:#a6e22e>userId</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>category</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`✅ 已设置分类为：</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 删除按钮
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;del_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;del_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>confirmOpts</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>reply_markup</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>inline_keyboard</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>          [
</span></span><span style=display:flex><span>            { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;✅ 确认删除&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`confirmdel_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>            { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;❌ 取消&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`cancel_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>          ],
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`⚠️ 确认要删除文件(ID=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>)吗？`</span>, <span style=color:#a6e22e>confirmOpts</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 确认删除
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;confirmdel_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;confirmdel_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>run</span>(<span style=color:#e6db74>`DELETE FROM files WHERE id = ? AND user_id = ?`</span>, [<span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>userId</span>], <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;❌ 删除失败。&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>changes</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;⚠️ 没找到该文件或无权限删除。&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`✅ 文件(ID=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>) 已删除。`</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 取消删除
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;cancel_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;cancel_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`❎ 已取消删除文件(ID=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>)。`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 分页按钮
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;page_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>page</span> <span style=color:#f92672>=</span> parseInt(<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;page_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>page</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>answerCallbackQuery</span>(<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>id</span>, { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;已经是第一页&#34;</span> });
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sendFilePage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#a6e22e>userId</span>, <span style=color:#a6e22e>page</span>, <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>message_id</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 下载到本地按钮
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;download_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;download_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>`SELECT file_id, file_name, category FROM files WHERE id = ? AND user_id = ?`</span>, [<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>userId</span>], <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>row</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>row</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;❌ 文件不存在或无权限下载。&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>filePath</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>downloadFile</span>(<span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>category</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`✅ 文件已下载到服务器本地：</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>filePath</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>catch</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;❌ 下载失败，请稍后重试。&#34;</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>answerCallbackQuery</span>(<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>id</span>);
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><h1 id=mv>Mv<a hidden class=anchor aria-hidden=true href=#mv>#</a></h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>TelegramBot</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;node-telegram-bot-api&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>db</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;./db&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fs</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;fs&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>path</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;path&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>axios</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;axios&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;TKTK&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>bot</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>TelegramBot</span>(<span style=color:#a6e22e>token</span>, { <span style=color:#a6e22e>polling</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 保存分类信息（用户 -&gt; 当前选择的分类）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userCategory</span> <span style=color:#f92672>=</span> {};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 预设分类
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>categories</span> <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;work&#34;</span>, <span style=color:#e6db74>&#34;study&#34;</span>, <span style=color:#e6db74>&#34;life&#34;</span>, <span style=color:#e6db74>&#34;other&#34;</span>,<span style=color:#e6db74>&#34;yo&#34;</span>,<span style=color:#e6db74>&#34;yo2&#34;</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 每页显示条数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>PAGE_SIZE</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 本地存储根目录
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>STORAGE_DIR</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>join</span>(<span style=color:#a6e22e>__dirname</span>, <span style=color:#e6db74>&#34;files&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>existsSync</span>(<span style=color:#a6e22e>STORAGE_DIR</span>)) <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>mkdirSync</span>(<span style=color:#a6e22e>STORAGE_DIR</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /start 命令
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/start/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;欢迎使用文件存储机器人！\n\n命令：\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/setcategory 设置分类\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/myfiles 查看最近文件(文字列表)\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/myfilelist [页码] 文件分页显示\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/search 关键字 搜索文件\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/getfile id 获取文件\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/delete id 删除文件\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;📥 点击文件后的“下载本地”按钮可保存到服务器本地&#34;</span>
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /setcategory 显示按钮
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/setcategory/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>opts</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reply_markup</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>inline_keyboard</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>categories</span>.<span style=color:#a6e22e>map</span>((<span style=color:#a6e22e>c</span>) =&gt; [{ <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`cat_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>c</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> }]),
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;请选择分类：&#34;</span>, <span style=color:#a6e22e>opts</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 通用保存函数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#a6e22e>type</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>chatId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>category</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>userCategory</span>[<span style=color:#a6e22e>userId</span>] <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;未分类&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>run</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`INSERT INTO files (file_id, file_name, category, user_id) VALUES (?, ?, ?, ?)`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#a6e22e>category</span>, <span style=color:#a6e22e>userId</span>],
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;❌ 存储失败。&#34;</span>);
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>chatId</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>`📦 已保存 </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>type</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\nID: </span><span style=color:#e6db74>${</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>lastID</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\n文件名: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\n分类: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 下载文件到本地（带重试和日志）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>downloadFile</span>(<span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#a6e22e>category</span>, <span style=color:#a6e22e>retries</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>dir</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>join</span>(<span style=color:#a6e22e>STORAGE_DIR</span>, <span style=color:#a6e22e>category</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>existsSync</span>(<span style=color:#a6e22e>dir</span>)) <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>mkdirSync</span>(<span style=color:#a6e22e>dir</span>, { <span style=color:#a6e22e>recursive</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> });
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>filePath</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>join</span>(<span style=color:#a6e22e>dir</span>, <span style=color:#a6e22e>fileName</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>attempt</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>; <span style=color:#a6e22e>attempt</span> <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>retries</span>; <span style=color:#a6e22e>attempt</span><span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`下载文件尝试 </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>attempt</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>retries</span><span style=color:#e6db74>}</span><span style=color:#e6db74>：</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>url</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>getFileLink</span>(<span style=color:#a6e22e>fileId</span>); <span style=color:#75715e>// 获取文件链接
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>writer</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>createWriteStream</span>(<span style=color:#a6e22e>filePath</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>axios</span>({
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>url</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>method</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;GET&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>responseType</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;stream&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>timeout</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>30000</span> <span style=color:#75715e>// 30秒超时
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>pipe</span>(<span style=color:#a6e22e>writer</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>new</span> Promise((<span style=color:#a6e22e>resolve</span>, <span style=color:#a6e22e>reject</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>writer</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;finish&#39;</span>, <span style=color:#a6e22e>resolve</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>writer</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;error&#39;</span>, <span style=color:#a6e22e>reject</span>);
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`✅ 文件下载成功：</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>filePath</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>filePath</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>`❌ 下载文件失败（尝试 </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>attempt</span><span style=color:#e6db74>}</span><span style=color:#e6db74>）：</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>, <span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>attempt</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>retries</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>`下载文件失败，请稍后重试：</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 等待 1 秒后重试
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>new</span> Promise(<span style=color:#a6e22e>res</span> =&gt; <span style=color:#a6e22e>setTimeout</span>(<span style=color:#a6e22e>res</span>, <span style=color:#ae81ff>1000</span>));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 统一处理消息（普通消息和转发消息）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;message&#34;</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>hasFile</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.document <span style=color:#f92672>||</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>photo</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>video</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>isForward</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>forward_from</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>forward_from_chat</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>hasFile</span>) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>typePrefix</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>isForward</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;转发&#34;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 文档
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>msg</span>.document) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>msg</span>.document.<span style=color:#a6e22e>file_id</span>, <span style=color:#a6e22e>msg</span>.document.<span style=color:#a6e22e>file_name</span>, <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>typePrefix</span><span style=color:#e6db74>}</span><span style=color:#e6db74>文档`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 图片
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>photo</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>photo</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>photo</span>[<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>photo</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileName</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`photo_</span><span style=color:#e6db74>${</span>Date.<span style=color:#a6e22e>now</span>()<span style=color:#e6db74>}</span><span style=color:#e6db74>.jpg`</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>photo</span>.<span style=color:#a6e22e>file_id</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>typePrefix</span><span style=color:#e6db74>}</span><span style=color:#e6db74>图片`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 视频
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>video</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileName</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>video</span>.<span style=color:#a6e22e>file_name</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>`video_</span><span style=color:#e6db74>${</span>Date.<span style=color:#a6e22e>now</span>()<span style=color:#e6db74>}</span><span style=color:#e6db74>.mp4`</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>video</span>.<span style=color:#a6e22e>file_id</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>typePrefix</span><span style=color:#e6db74>}</span><span style=color:#e6db74>视频`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /myfiles 文本列表
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/myfiles/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>all</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT 10`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>userId</span>],
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>rows</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;❌ 查询失败。&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;📭 没有找到文件。&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>text</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;📂 最近的文件：\n\n&#34;</span>;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>r</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>text</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74> [</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>]\n`</span>;
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>text</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /myfilelist 分页显示（优化：支持图片缩略图）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>sendFilePage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#a6e22e>userId</span>, <span style=color:#a6e22e>page</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>messageId</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>offset</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>page</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>*</span> <span style=color:#a6e22e>PAGE_SIZE</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>all</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT id, file_id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT ? OFFSET ?`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>userId</span>, <span style=color:#a6e22e>PAGE_SIZE</span>, <span style=color:#a6e22e>offset</span>],
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>rows</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;❌ 查询失败。&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;📭 没有找到文件。&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 拼接文件列表文字
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>text</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`📑 第 </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>page</span><span style=color:#e6db74>}</span><span style=color:#e6db74> 页（每页 </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>PAGE_SIZE</span><span style=color:#e6db74>}</span><span style=color:#e6db74> 条）\n\n`</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>inline_keyboard</span> <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>mediaGroup</span> <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>r</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>rows</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>text</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74> [</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>]\n`</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 每个文件单独两按钮行：删除+下载
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>inline_keyboard</span>.<span style=color:#a6e22e>push</span>([
</span></span><span style=display:flex><span>          { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;❌ 删除&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`del_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>          { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;⬇️ 下载本地&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`download_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>        ]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 如果是图片，加入缩略图到 mediaGroup
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.jpg&#34;</span>) <span style=color:#f92672>||</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.png&#34;</span>)) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>mediaGroup</span>.<span style=color:#a6e22e>push</span>({ <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;photo&#34;</span>, <span style=color:#a6e22e>media</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_id</span>, <span style=color:#a6e22e>caption</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> });
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 翻页按钮
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>totalCountRow</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>new</span> Promise((<span style=color:#a6e22e>resolve</span>) =&gt;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>`SELECT COUNT(*) as cnt FROM files WHERE user_id = ?`</span>, [<span style=color:#a6e22e>userId</span>], (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>row</span>) =&gt; <span style=color:#a6e22e>resolve</span>(<span style=color:#a6e22e>row</span>))
</span></span><span style=display:flex><span>      );
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>totalPages</span> <span style=color:#f92672>=</span> Math.<span style=color:#a6e22e>ceil</span>(<span style=color:#a6e22e>totalCountRow</span>.<span style=color:#a6e22e>cnt</span> <span style=color:#f92672>/</span> <span style=color:#a6e22e>PAGE_SIZE</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>inline_keyboard</span>.<span style=color:#a6e22e>push</span>([
</span></span><span style=display:flex><span>        { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;⬅️ 上一页&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`page_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>page</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>        { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;➡️ 下一页&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`page_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>page</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>      ]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>opts</span> <span style=color:#f92672>=</span> { <span style=color:#a6e22e>reply_markup</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>inline_keyboard</span> } };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>mediaGroup</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 先发送图片缩略图组
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMediaGroup</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#a6e22e>mediaGroup</span>);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#34;发送缩略图失败:&#34;</span>, <span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>messageId</span>) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 编辑已有消息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>editMessageText</span>(<span style=color:#a6e22e>text</span>, {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>chat_id</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>chatId</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>message_id</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>messageId</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>reply_markup</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>opts</span>.<span style=color:#a6e22e>reply_markup</span>,
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#a6e22e>text</span>, <span style=color:#a6e22e>opts</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/myfilelist ?(\d+)?/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>page</span> <span style=color:#f92672>=</span> parseInt(<span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>]) <span style=color:#f92672>||</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>sendFilePage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>page</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /search 关键字
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/search (.+)/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>keyword</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`%</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>%`</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>all</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT id, file_name, category FROM files WHERE user_id = ? AND file_name LIKE ? ORDER BY date DESC LIMIT 10`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>userId</span>, <span style=color:#a6e22e>keyword</span>],
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>rows</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;❌ 查询失败。&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;🔍 没有匹配的文件。&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>text</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`🔍 搜索结果：\n\n`</span>;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>r</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>text</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74> [</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>]\n`</span>;
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>text</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /getfile id
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/getfile (\d+)/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>`SELECT file_id, file_name FROM files WHERE id = ?`</span>, [<span style=color:#a6e22e>id</span>], (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>row</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>row</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;❌ 文件不存在。&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.jpg&#34;</span>)) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendPhoto</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, { <span style=color:#a6e22e>caption</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.mp4&#34;</span>)) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendVideo</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, { <span style=color:#a6e22e>caption</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendDocument</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, {}, { <span style=color:#a6e22e>filename</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /delete id
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/delete (\d+)/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>run</span>(<span style=color:#e6db74>`DELETE FROM files WHERE id = ? AND user_id = ?`</span>, [<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>userId</span>], <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;❌ 删除失败。&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>changes</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;⚠️ 没找到该文件或无权限删除。&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>`✅ 文件(ID=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>) 已删除。`</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// callback_query 统一处理
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;callback_query&#34;</span>, <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>query</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>chatId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 分类按钮
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;cat_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>category</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;cat_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>userCategory</span>[<span style=color:#a6e22e>userId</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>category</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`✅ 已设置分类为：</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 删除按钮
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;del_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;del_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>confirmOpts</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>reply_markup</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>inline_keyboard</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>          [
</span></span><span style=display:flex><span>            { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;✅ 确认删除&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`confirmdel_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>            { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;❌ 取消&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`cancel_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>          ],
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`⚠️ 确认要删除文件(ID=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>)吗？`</span>, <span style=color:#a6e22e>confirmOpts</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 确认删除
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;confirmdel_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;confirmdel_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>run</span>(<span style=color:#e6db74>`DELETE FROM files WHERE id = ? AND user_id = ?`</span>, [<span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>userId</span>], <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;❌ 删除失败。&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>changes</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;⚠️ 没找到该文件或无权限删除。&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`✅ 文件(ID=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>) 已删除。`</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 取消删除
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;cancel_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;cancel_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`❎ 已取消删除文件(ID=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>)。`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 分页按钮
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;page_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>page</span> <span style=color:#f92672>=</span> parseInt(<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;page_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>page</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>answerCallbackQuery</span>(<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>id</span>, { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;已经是第一页&#34;</span> });
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sendFilePage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#a6e22e>userId</span>, <span style=color:#a6e22e>page</span>, <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>message_id</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 下载到本地按钮
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;download_&#34;</span>)) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;download_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>`SELECT file_id, file_name, category FROM files WHERE id = ? AND user_id = ?`</span>, [<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>userId</span>], <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>row</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>row</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;❌ 文件不存在或无权限下载。&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>filePath</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>downloadFile</span>(<span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>category</span>);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`✅ 文件已下载到服务器本地：</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>filePath</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`❌ </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>message</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>answerCallbackQuery</span>(<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>id</span>);
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><h1 id=configjs>config.js<a hidden class=anchor aria-hidden=true href=#configjs>#</a></h1><p>configbot.js</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// configbot.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>token</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;t&#34;</span>, <span style=color:#75715e>//  Telegram Bot Token
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>categories</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#34;work&#34;</span>, <span style=color:#e6db74>&#34;study&#34;</span>, <span style=color:#e6db74>&#34;life&#34;</span>, <span style=color:#e6db74>&#34;other&#34;</span>, <span style=color:#e6db74>&#34;yo&#34;</span>, <span style=color:#e6db74>&#34;yo2&#34;</span>], <span style=color:#75715e>// 分类
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>pageSize</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>5</span> <span style=color:#75715e>// 每页显示条数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>};
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>//bot.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>TelegramBot</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;node-telegram-bot-api&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>db</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;./db&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fs</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;fs&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>path</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;path&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>axios</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;axios&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>config</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;./configbot&#34;</span>); <span style=color:#75715e>// 引入配置文件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>token</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>categories</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>categories</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>PAGE_SIZE</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>pageSize</span>; 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>bot</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>TelegramBot</span>(<span style=color:#a6e22e>token</span>, { <span style=color:#a6e22e>polling</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> });
</span></span></code></pre></div><h1 id=login>login<a hidden class=anchor aria-hidden=true href=#login>#</a></h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>//config
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>token</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;BOT_TOKEN&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>categories</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#34;c1&#34;</span>, <span style=color:#e6db74>&#34;c2&#34;</span>, <span style=color:#e6db74>&#34;c2&#34;</span>],
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>pageSize</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>5</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>adminPassword</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;admin123&#34;</span> <span style=color:#75715e>// 机器人访问密码
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>};
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>TelegramBot</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;node-telegram-bot-api&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>db</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;./db&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fs</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;fs&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>path</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;path&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>axios</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;axios&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>config</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;./configbot&#34;</span>); <span style=color:#75715e>// 引入配置文件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>token</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>categories</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>categories</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>PAGE_SIZE</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>pageSize</span>; <span style=color:#75715e>// 从配置读取
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>ADMIN_PASSWORD</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>adminPassword</span>; <span style=color:#75715e>// 管理密码
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>bot</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>TelegramBot</span>(<span style=color:#a6e22e>token</span>, { <span style=color:#a6e22e>polling</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 保存分类信息（用户 -&gt; 当前选择的分类）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userCategory</span> <span style=color:#f92672>=</span> {};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 保存已登录用户
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>authenticatedUsers</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Set</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 本地存储根目录
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>STORAGE_DIR</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>join</span>(<span style=color:#a6e22e>__dirname</span>, <span style=color:#e6db74>&#34;files&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>existsSync</span>(<span style=color:#a6e22e>STORAGE_DIR</span>)) <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>mkdirSync</span>(<span style=color:#a6e22e>STORAGE_DIR</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 检查是否已鉴权
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>checkAuth</span>(<span style=color:#a6e22e>msg</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>authenticatedUsers</span>.<span style=color:#a6e22e>has</span>(<span style=color:#a6e22e>userId</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;⚠️ 请先使用 /login &lt;密码&gt; 登录。&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /login 命令
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/login (.+)/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>password</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>password</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>ADMIN_PASSWORD</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>authenticatedUsers</span>.<span style=color:#a6e22e>add</span>(<span style=color:#a6e22e>userId</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;✅ 登录成功，您已获得访问权限。&#34;</span>);
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;❌ 密码错误。&#34;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /start 命令
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/start/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>checkAuth</span>(<span style=color:#a6e22e>msg</span>)) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;欢迎使用文件存储机器人！\n\n命令：\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/setcategory 设置分类\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/myfiles 查看最近文件(文字列表)\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/myfilelist [页码] 文件分页显示\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/search 关键字 搜索文件\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/getfile id 获取文件\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/delete id 删除文件\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;📥 点击文件后的“下载本地”按钮可保存到服务器本地&#34;</span>
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /setcategory 显示按钮
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/setcategory/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>checkAuth</span>(<span style=color:#a6e22e>msg</span>)) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>opts</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reply_markup</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>inline_keyboard</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>categories</span>.<span style=color:#a6e22e>map</span>((<span style=color:#a6e22e>c</span>) =&gt; [{ <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`cat_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>c</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> }]),
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;请选择分类：&#34;</span>, <span style=color:#a6e22e>opts</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 通用保存函数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#a6e22e>type</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>chatId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>category</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>userCategory</span>[<span style=color:#a6e22e>userId</span>] <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;未分类&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>run</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`INSERT INTO files (file_id, file_name, category, user_id) VALUES (?, ?, ?, ?)`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#a6e22e>category</span>, <span style=color:#a6e22e>userId</span>],
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;❌ 存储失败。&#34;</span>);
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>chatId</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>`📦 已保存 </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>type</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\nID: </span><span style=color:#e6db74>${</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>lastID</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\n文件名: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\n分类: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 下载文件到本地（带重试和日志）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>downloadFile</span>(<span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#a6e22e>category</span>, <span style=color:#a6e22e>retries</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>dir</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>join</span>(<span style=color:#a6e22e>STORAGE_DIR</span>, <span style=color:#a6e22e>category</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>existsSync</span>(<span style=color:#a6e22e>dir</span>)) <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>mkdirSync</span>(<span style=color:#a6e22e>dir</span>, { <span style=color:#a6e22e>recursive</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> });
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>filePath</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>join</span>(<span style=color:#a6e22e>dir</span>, <span style=color:#a6e22e>fileName</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>attempt</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>; <span style=color:#a6e22e>attempt</span> <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>retries</span>; <span style=color:#a6e22e>attempt</span><span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`下载文件尝试 </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>attempt</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>retries</span><span style=color:#e6db74>}</span><span style=color:#e6db74>：</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>url</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>getFileLink</span>(<span style=color:#a6e22e>fileId</span>); <span style=color:#75715e>// 获取文件链接
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>writer</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>createWriteStream</span>(<span style=color:#a6e22e>filePath</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>axios</span>({
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>url</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>method</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;GET&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>responseType</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;stream&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>timeout</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>30000</span>, <span style=color:#75715e>// 30秒超时
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>pipe</span>(<span style=color:#a6e22e>writer</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>new</span> Promise((<span style=color:#a6e22e>resolve</span>, <span style=color:#a6e22e>reject</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>writer</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;finish&#34;</span>, <span style=color:#a6e22e>resolve</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>writer</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;error&#34;</span>, <span style=color:#a6e22e>reject</span>);
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`✅ 文件下载成功：</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>filePath</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>filePath</span>;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>`❌ 下载文件失败（尝试 </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>attempt</span><span style=color:#e6db74>}</span><span style=color:#e6db74>）：</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>, <span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>attempt</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>retries</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>`下载文件失败，请稍后重试：</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 等待 1 秒后重试
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>new</span> Promise((<span style=color:#a6e22e>res</span>) =&gt; <span style=color:#a6e22e>setTimeout</span>(<span style=color:#a6e22e>res</span>, <span style=color:#ae81ff>1000</span>));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 统一处理消息（普通消息和转发消息）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;message&#34;</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>checkAuth</span>(<span style=color:#a6e22e>msg</span>)) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>hasFile</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.document <span style=color:#f92672>||</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>photo</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>video</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>isForward</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>forward_from</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>forward_from_chat</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>hasFile</span>) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>typePrefix</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>isForward</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;转发&#34;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 文档
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>msg</span>.document) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>msg</span>.document.<span style=color:#a6e22e>file_id</span>, <span style=color:#a6e22e>msg</span>.document.<span style=color:#a6e22e>file_name</span>, <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>typePrefix</span><span style=color:#e6db74>}</span><span style=color:#e6db74>文档`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 图片
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>photo</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>photo</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>photo</span>[<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>photo</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileName</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`photo_</span><span style=color:#e6db74>${</span>Date.<span style=color:#a6e22e>now</span>()<span style=color:#e6db74>}</span><span style=color:#e6db74>.jpg`</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>photo</span>.<span style=color:#a6e22e>file_id</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>typePrefix</span><span style=color:#e6db74>}</span><span style=color:#e6db74>图片`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 视频
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>video</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileName</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>video</span>.<span style=color:#a6e22e>file_name</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>`video_</span><span style=color:#e6db74>${</span>Date.<span style=color:#a6e22e>now</span>()<span style=color:#e6db74>}</span><span style=color:#e6db74>.mp4`</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>video</span>.<span style=color:#a6e22e>file_id</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>typePrefix</span><span style=color:#e6db74>}</span><span style=color:#e6db74>视频`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /myfiles 文本列表
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/myfiles/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>checkAuth</span>(<span style=color:#a6e22e>msg</span>)) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>all</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT 10`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>userId</span>],
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>rows</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;❌ 查询失败。&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;📭 没有找到文件。&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>text</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;📂 最近的文件：\n\n&#34;</span>;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>r</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>text</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74> [</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>]\n`</span>;
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>text</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /myfilelist 分页显示
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>sendFilePage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#a6e22e>userId</span>, <span style=color:#a6e22e>page</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>messageId</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>offset</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>page</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>*</span> <span style=color:#a6e22e>PAGE_SIZE</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>all</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT id, file_id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT ? OFFSET ?`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>userId</span>, <span style=color:#a6e22e>PAGE_SIZE</span>, <span style=color:#a6e22e>offset</span>],
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>rows</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;❌ 查询失败。&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;📭 没有找到文件。&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>text</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`📑 第 </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>page</span><span style=color:#e6db74>}</span><span style=color:#e6db74> 页（每页 </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>PAGE_SIZE</span><span style=color:#e6db74>}</span><span style=color:#e6db74> 条）\n\n`</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>inline_keyboard</span> <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>mediaGroup</span> <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>r</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>rows</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>text</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74> [</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>]\n`</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>inline_keyboard</span>.<span style=color:#a6e22e>push</span>([
</span></span><span style=display:flex><span>          { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;❌ 删除&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`del_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>          { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;⬇️ 下载本地&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`download_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>        ]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.jpg&#34;</span>) <span style=color:#f92672>||</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.png&#34;</span>)) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>mediaGroup</span>.<span style=color:#a6e22e>push</span>({ <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;photo&#34;</span>, <span style=color:#a6e22e>media</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_id</span>, <span style=color:#a6e22e>caption</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> });
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>totalCountRow</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>new</span> Promise((<span style=color:#a6e22e>resolve</span>) =&gt;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>`SELECT COUNT(*) as cnt FROM files WHERE user_id = ?`</span>, [<span style=color:#a6e22e>userId</span>], (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>row</span>) =&gt;
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>resolve</span>(<span style=color:#a6e22e>row</span>)
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>      );
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>totalPages</span> <span style=color:#f92672>=</span> Math.<span style=color:#a6e22e>ceil</span>(<span style=color:#a6e22e>totalCountRow</span>.<span style=color:#a6e22e>cnt</span> <span style=color:#f92672>/</span> <span style=color:#a6e22e>PAGE_SIZE</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>inline_keyboard</span>.<span style=color:#a6e22e>push</span>([
</span></span><span style=display:flex><span>        { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;⬅️ 上一页&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`page_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>page</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>        { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;➡️ 下一页&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`page_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>page</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>      ]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>opts</span> <span style=color:#f92672>=</span> { <span style=color:#a6e22e>reply_markup</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>inline_keyboard</span> } };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>mediaGroup</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMediaGroup</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#a6e22e>mediaGroup</span>);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#34;发送缩略图失败:&#34;</span>, <span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>messageId</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>editMessageText</span>(<span style=color:#a6e22e>text</span>, {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>chat_id</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>chatId</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>message_id</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>messageId</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>reply_markup</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>opts</span>.<span style=color:#a6e22e>reply_markup</span>,
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#a6e22e>text</span>, <span style=color:#a6e22e>opts</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/myfilelist ?(\d+)?/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>checkAuth</span>(<span style=color:#a6e22e>msg</span>)) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>page</span> <span style=color:#f92672>=</span> parseInt(<span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>]) <span style=color:#f92672>||</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>sendFilePage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>page</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /search 关键字
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/search (.+)/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>checkAuth</span>(<span style=color:#a6e22e>msg</span>)) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>keyword</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`%</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>%`</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>all</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT id, file_name, category FROM files WHERE user_id = ? AND file_name LIKE ? ORDER BY date DESC LIMIT 10`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>userId</span>, <span style=color:#a6e22e>keyword</span>],
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>rows</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;❌ 查询失败。&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;🔍 没有匹配的文件。&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>text</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`🔍 搜索结果：\n\n`</span>;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>r</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>text</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74> [</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>]\n`</span>;
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>text</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /getfile id
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/getfile (\d+)/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>checkAuth</span>(<span style=color:#a6e22e>msg</span>)) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>`SELECT file_id, file_name FROM files WHERE id = ?`</span>, [<span style=color:#a6e22e>id</span>], (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>row</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>row</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;❌ 文件不存在。&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.jpg&#34;</span>)) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendPhoto</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, { <span style=color:#a6e22e>caption</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.mp4&#34;</span>)) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendVideo</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, { <span style=color:#a6e22e>caption</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendDocument</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, {}, { <span style=color:#a6e22e>filename</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /delete id
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/delete (\d+)/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>checkAuth</span>(<span style=color:#a6e22e>msg</span>)) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>run</span>(<span style=color:#e6db74>`DELETE FROM files WHERE id = ? AND user_id = ?`</span>, [<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>userId</span>], <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;❌ 删除失败。&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>changes</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;⚠️ 没找到该文件或无权限删除。&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>`✅ 文件(ID=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>) 已删除。`</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// callback_query 统一处理
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;callback_query&#34;</span>, <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>query</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>chatId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>authenticatedUsers</span>.<span style=color:#a6e22e>has</span>(<span style=color:#a6e22e>userId</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>answerCallbackQuery</span>(<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>id</span>, { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;⚠️ 请先登录 /login &lt;密码&gt;&#34;</span> });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;cat_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>category</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;cat_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>userCategory</span>[<span style=color:#a6e22e>userId</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>category</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`✅ 已设置分类为：</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;del_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;del_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>confirmOpts</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>reply_markup</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>inline_keyboard</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>          [
</span></span><span style=display:flex><span>            { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;✅ 确认删除&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`confirmdel_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>            { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;❌ 取消&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`cancel_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>          ],
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`⚠️ 确认要删除文件(ID=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>)吗？`</span>, <span style=color:#a6e22e>confirmOpts</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;confirmdel_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;confirmdel_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>run</span>(<span style=color:#e6db74>`DELETE FROM files WHERE id = ? AND user_id = ?`</span>, [<span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>userId</span>], <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;❌ 删除失败。&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>changes</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;⚠️ 没找到该文件或无权限删除。&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`✅ 文件(ID=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>) 已删除。`</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;cancel_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;cancel_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`❎ 已取消删除文件(ID=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>)。`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;page_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>page</span> <span style=color:#f92672>=</span> parseInt(<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;page_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>page</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>answerCallbackQuery</span>(<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>id</span>, { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;已经是第一页&#34;</span> });
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sendFilePage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#a6e22e>userId</span>, <span style=color:#a6e22e>page</span>, <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>message_id</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;download_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;download_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>get</span>(
</span></span><span style=display:flex><span>      <span style=color:#e6db74>`SELECT file_id, file_name, category FROM files WHERE id = ? AND user_id = ?`</span>,
</span></span><span style=display:flex><span>      [<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>userId</span>],
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>row</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>row</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;❌ 文件不存在或无权限下载。&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>filePath</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>downloadFile</span>(<span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>category</span>);
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`✅ 文件已下载到服务器本地：</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>filePath</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`❌ </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>message</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>answerCallbackQuery</span>(<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>id</span>);
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>用户必须先输入 /login admin123，否则所有命令都会提示 ⚠️ 请先使用 /login &lt;密码> 登录。</p><p>登录成功后，才可以正常使用 /start、上传文件、搜索、分页、删除、下载等功能。</p><h1 id=list-detail>list detail<a hidden class=anchor aria-hidden=true href=#list-detail>#</a></h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>TelegramBot</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;node-telegram-bot-api&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>db</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;./db&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fs</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;fs&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>path</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;path&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>axios</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;axios&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>config</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;./configbot&#34;</span>); <span style=color:#75715e>// 引入配置文件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>token</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>categories</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>categories</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>PAGE_SIZE</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>pageSize</span>; <span style=color:#75715e>// 从配置读取
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>ADMIN_PASSWORD</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>adminPassword</span>; <span style=color:#75715e>// 管理密码
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>bot</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>TelegramBot</span>(<span style=color:#a6e22e>token</span>, { <span style=color:#a6e22e>polling</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 保存分类信息（用户 -&gt; 当前选择的分类）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userCategory</span> <span style=color:#f92672>=</span> {};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 保存已登录用户
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>authenticatedUsers</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Set</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 本地存储根目录
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>STORAGE_DIR</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>join</span>(<span style=color:#a6e22e>__dirname</span>, <span style=color:#e6db74>&#34;files&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>existsSync</span>(<span style=color:#a6e22e>STORAGE_DIR</span>)) <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>mkdirSync</span>(<span style=color:#a6e22e>STORAGE_DIR</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 检查是否已鉴权
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>checkAuth</span>(<span style=color:#a6e22e>msg</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>authenticatedUsers</span>.<span style=color:#a6e22e>has</span>(<span style=color:#a6e22e>userId</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;⚠️ 请先使用 /login &lt;密码&gt; 登录。&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /login 命令
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/login (.+)/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>password</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>password</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>ADMIN_PASSWORD</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>authenticatedUsers</span>.<span style=color:#a6e22e>add</span>(<span style=color:#a6e22e>userId</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;✅ 登录成功，您已获得访问权限。&#34;</span>);
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;❌ 密码错误。&#34;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /start 命令
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/start/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>checkAuth</span>(<span style=color:#a6e22e>msg</span>)) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;欢迎使用文件存储机器人！\n\n命令：\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/setcategory 设置分类\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/myfiles 查看最近文件(文字列表)\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/myfilelist [页码] 文件分页显示\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/search 关键字 搜索文件\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/getfile id 获取文件\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/delete id 删除文件\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;📥 点击文件后的“下载本地”或“查看详情”按钮操作&#34;</span>
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /setcategory 显示按钮
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/setcategory/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>checkAuth</span>(<span style=color:#a6e22e>msg</span>)) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>opts</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reply_markup</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>inline_keyboard</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>categories</span>.<span style=color:#a6e22e>map</span>((<span style=color:#a6e22e>c</span>) =&gt; [{ <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`cat_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>c</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> }]),
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;请选择分类：&#34;</span>, <span style=color:#a6e22e>opts</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 通用保存函数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#a6e22e>type</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>chatId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>category</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>userCategory</span>[<span style=color:#a6e22e>userId</span>] <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;未分类&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>run</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`INSERT INTO files (file_id, file_name, category, user_id, date) VALUES (?, ?, ?, ?, datetime(&#39;now&#39;))`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#a6e22e>category</span>, <span style=color:#a6e22e>userId</span>],
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;❌ 存储失败。&#34;</span>);
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>chatId</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>`📦 已保存 </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>type</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\nID: </span><span style=color:#e6db74>${</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>lastID</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\n文件名: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\n分类: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 下载文件到本地（带重试和日志）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>downloadFile</span>(<span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#a6e22e>category</span>, <span style=color:#a6e22e>retries</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>dir</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>join</span>(<span style=color:#a6e22e>STORAGE_DIR</span>, <span style=color:#a6e22e>category</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>existsSync</span>(<span style=color:#a6e22e>dir</span>)) <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>mkdirSync</span>(<span style=color:#a6e22e>dir</span>, { <span style=color:#a6e22e>recursive</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> });
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>filePath</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>join</span>(<span style=color:#a6e22e>dir</span>, <span style=color:#a6e22e>fileName</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>attempt</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>; <span style=color:#a6e22e>attempt</span> <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>retries</span>; <span style=color:#a6e22e>attempt</span><span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`下载文件尝试 </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>attempt</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>retries</span><span style=color:#e6db74>}</span><span style=color:#e6db74>：</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>url</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>getFileLink</span>(<span style=color:#a6e22e>fileId</span>); <span style=color:#75715e>// 获取文件链接
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>writer</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>createWriteStream</span>(<span style=color:#a6e22e>filePath</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>axios</span>({
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>url</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>method</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;GET&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>responseType</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;stream&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>timeout</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>30000</span>, <span style=color:#75715e>// 30秒超时
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>pipe</span>(<span style=color:#a6e22e>writer</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>new</span> Promise((<span style=color:#a6e22e>resolve</span>, <span style=color:#a6e22e>reject</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>writer</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;finish&#34;</span>, <span style=color:#a6e22e>resolve</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>writer</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;error&#34;</span>, <span style=color:#a6e22e>reject</span>);
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`✅ 文件下载成功：</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>filePath</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>filePath</span>;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>`❌ 下载文件失败（尝试 </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>attempt</span><span style=color:#e6db74>}</span><span style=color:#e6db74>）：</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>, <span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>attempt</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>retries</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>`下载文件失败，请稍后重试：</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 等待 1 秒后重试
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>new</span> Promise((<span style=color:#a6e22e>res</span>) =&gt; <span style=color:#a6e22e>setTimeout</span>(<span style=color:#a6e22e>res</span>, <span style=color:#ae81ff>1000</span>));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 统一处理消息（普通消息和转发消息）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;message&#34;</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>checkAuth</span>(<span style=color:#a6e22e>msg</span>)) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>hasFile</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.document <span style=color:#f92672>||</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>photo</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>video</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>isForward</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>forward_from</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>forward_from_chat</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>hasFile</span>) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>typePrefix</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>isForward</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;转发&#34;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 文档
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>msg</span>.document) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>msg</span>.document.<span style=color:#a6e22e>file_id</span>, <span style=color:#a6e22e>msg</span>.document.<span style=color:#a6e22e>file_name</span>, <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>typePrefix</span><span style=color:#e6db74>}</span><span style=color:#e6db74>文档`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 图片
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>photo</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>photo</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>photo</span>[<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>photo</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileName</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`photo_</span><span style=color:#e6db74>${</span>Date.<span style=color:#a6e22e>now</span>()<span style=color:#e6db74>}</span><span style=color:#e6db74>.jpg`</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>photo</span>.<span style=color:#a6e22e>file_id</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>typePrefix</span><span style=color:#e6db74>}</span><span style=color:#e6db74>图片`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 视频
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>video</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileName</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>video</span>.<span style=color:#a6e22e>file_name</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>`video_</span><span style=color:#e6db74>${</span>Date.<span style=color:#a6e22e>now</span>()<span style=color:#e6db74>}</span><span style=color:#e6db74>.mp4`</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>video</span>.<span style=color:#a6e22e>file_id</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>typePrefix</span><span style=color:#e6db74>}</span><span style=color:#e6db74>视频`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /myfiles 文本列表
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/myfiles/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>checkAuth</span>(<span style=color:#a6e22e>msg</span>)) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>all</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT 10`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>userId</span>],
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>rows</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;❌ 查询失败。&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;📭 没有找到文件。&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>text</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;📂 最近的文件：\n\n&#34;</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>inline_keyboard</span> <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>r</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>text</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74> [</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>]\n`</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>inline_keyboard</span>.<span style=color:#a6e22e>push</span>([{ <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;ℹ️ 查看详情&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`detail_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> }]);
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>text</span>, { <span style=color:#a6e22e>reply_markup</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>inline_keyboard</span> } });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /myfilelist 分页显示
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>sendFilePage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#a6e22e>userId</span>, <span style=color:#a6e22e>page</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>messageId</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>offset</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>page</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>*</span> <span style=color:#a6e22e>PAGE_SIZE</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>all</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT id, file_id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT ? OFFSET ?`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>userId</span>, <span style=color:#a6e22e>PAGE_SIZE</span>, <span style=color:#a6e22e>offset</span>],
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>rows</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;❌ 查询失败。&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;📭 没有找到文件。&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>text</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`📑 第 </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>page</span><span style=color:#e6db74>}</span><span style=color:#e6db74> 页（每页 </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>PAGE_SIZE</span><span style=color:#e6db74>}</span><span style=color:#e6db74> 条）\n\n`</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>inline_keyboard</span> <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>mediaGroup</span> <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>r</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>rows</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>text</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74> [</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>]\n`</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>inline_keyboard</span>.<span style=color:#a6e22e>push</span>([
</span></span><span style=display:flex><span>          { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;ℹ️ 查看详情&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`detail_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>          { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;❌ 删除&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`del_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>          { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;⬇️ 下载本地&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`download_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>        ]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.jpg&#34;</span>) <span style=color:#f92672>||</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.png&#34;</span>)) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>mediaGroup</span>.<span style=color:#a6e22e>push</span>({ <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;photo&#34;</span>, <span style=color:#a6e22e>media</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_id</span>, <span style=color:#a6e22e>caption</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> });
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>totalCountRow</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>new</span> Promise((<span style=color:#a6e22e>resolve</span>) =&gt;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>`SELECT COUNT(*) as cnt FROM files WHERE user_id = ?`</span>, [<span style=color:#a6e22e>userId</span>], (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>row</span>) =&gt;
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>resolve</span>(<span style=color:#a6e22e>row</span>)
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>      );
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>totalPages</span> <span style=color:#f92672>=</span> Math.<span style=color:#a6e22e>ceil</span>(<span style=color:#a6e22e>totalCountRow</span>.<span style=color:#a6e22e>cnt</span> <span style=color:#f92672>/</span> <span style=color:#a6e22e>PAGE_SIZE</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>inline_keyboard</span>.<span style=color:#a6e22e>push</span>([
</span></span><span style=display:flex><span>        { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;⬅️ 上一页&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`page_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>page</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>        { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;➡️ 下一页&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`page_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>page</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>      ]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>opts</span> <span style=color:#f92672>=</span> { <span style=color:#a6e22e>reply_markup</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>inline_keyboard</span> } };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>mediaGroup</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMediaGroup</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#a6e22e>mediaGroup</span>);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#34;发送缩略图失败:&#34;</span>, <span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>messageId</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>editMessageText</span>(<span style=color:#a6e22e>text</span>, {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>chat_id</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>chatId</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>message_id</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>messageId</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>reply_markup</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>opts</span>.<span style=color:#a6e22e>reply_markup</span>,
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#a6e22e>text</span>, <span style=color:#a6e22e>opts</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/myfilelist ?(\d+)?/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>checkAuth</span>(<span style=color:#a6e22e>msg</span>)) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>page</span> <span style=color:#f92672>=</span> parseInt(<span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>]) <span style=color:#f92672>||</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>sendFilePage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>page</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /search 关键字
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/search (.+)/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>checkAuth</span>(<span style=color:#a6e22e>msg</span>)) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>keyword</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`%</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>%`</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>all</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT id, file_name, category FROM files WHERE user_id = ? AND file_name LIKE ? ORDER BY date DESC LIMIT 10`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>userId</span>, <span style=color:#a6e22e>keyword</span>],
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>rows</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;❌ 查询失败。&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;🔍 没有匹配的文件。&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>text</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`🔍 搜索结果：\n\n`</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>inline_keyboard</span> <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>r</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>text</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74> [</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>]\n`</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>inline_keyboard</span>.<span style=color:#a6e22e>push</span>([{ <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;ℹ️ 查看详情&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`detail_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> }]);
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>text</span>, { <span style=color:#a6e22e>reply_markup</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>inline_keyboard</span> } });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /getfile id
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/getfile (\d+)/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>checkAuth</span>(<span style=color:#a6e22e>msg</span>)) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>`SELECT file_id, file_name FROM files WHERE id = ?`</span>, [<span style=color:#a6e22e>id</span>], (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>row</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>row</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;❌ 文件不存在。&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.jpg&#34;</span>)) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendPhoto</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, { <span style=color:#a6e22e>caption</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.mp4&#34;</span>)) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendVideo</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, { <span style=color:#a6e22e>caption</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendDocument</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, {}, { <span style=color:#a6e22e>filename</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /delete id
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/delete (\d+)/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>checkAuth</span>(<span style=color:#a6e22e>msg</span>)) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>run</span>(<span style=color:#e6db74>`DELETE FROM files WHERE id = ? AND user_id = ?`</span>, [<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>userId</span>], <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;❌ 删除失败。&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>changes</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;⚠️ 没找到该文件或无权限删除。&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>`✅ 文件(ID=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>) 已删除。`</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// callback_query 统一处理
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;callback_query&#34;</span>, <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>query</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>chatId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>authenticatedUsers</span>.<span style=color:#a6e22e>has</span>(<span style=color:#a6e22e>userId</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>answerCallbackQuery</span>(<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>id</span>, { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;⚠️ 请先登录 /login &lt;密码&gt;&#34;</span> });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;cat_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>category</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;cat_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>userCategory</span>[<span style=color:#a6e22e>userId</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>category</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`✅ 已设置分类为：</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;del_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;del_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>confirmOpts</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>reply_markup</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>inline_keyboard</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>          [
</span></span><span style=display:flex><span>            { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;✅ 确认删除&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`confirmdel_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>            { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;❌ 取消&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`cancel_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>          ],
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`⚠️ 确认要删除文件(ID=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>)吗？`</span>, <span style=color:#a6e22e>confirmOpts</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;confirmdel_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;confirmdel_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>run</span>(<span style=color:#e6db74>`DELETE FROM files WHERE id = ? AND user_id = ?`</span>, [<span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>userId</span>], <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;❌ 删除失败。&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>changes</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;⚠️ 没找到该文件或无权限删除。&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`✅ 文件(ID=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>) 已删除。`</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;cancel_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;cancel_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`❎ 已取消删除文件(ID=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>)。`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;page_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>page</span> <span style=color:#f92672>=</span> parseInt(<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;page_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>page</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>answerCallbackQuery</span>(<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>id</span>, { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;已经是第一页&#34;</span> });
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sendFilePage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#a6e22e>userId</span>, <span style=color:#a6e22e>page</span>, <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>message_id</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;download_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;download_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>get</span>(
</span></span><span style=display:flex><span>      <span style=color:#e6db74>`SELECT file_id, file_name, category FROM files WHERE id = ? AND user_id = ?`</span>,
</span></span><span style=display:flex><span>      [<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>userId</span>],
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>row</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>row</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;❌ 文件不存在或无权限下载。&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>filePath</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>downloadFile</span>(<span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>category</span>);
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`✅ 文件已下载到服务器本地：</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>filePath</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`❌ </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>message</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;detail_&#34;</span>)) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;detail_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>get</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT id, file_id, file_name, category, date, user_id FROM files WHERE id = ? AND user_id = ?`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>userId</span>],
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>row</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>row</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;❌ 文件不存在或无权限查看。&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>text</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>`📋 文件详情\n\n`</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>`ID: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\n`</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>`文件名: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\n`</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>`分类: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\n`</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>`上传时间: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>date</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\n`</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>`用户ID: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>user_id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#a6e22e>text</span>).<span style=color:#a6e22e>then</span>(() =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 自动发送文件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.jpg&#34;</span>) <span style=color:#f92672>||</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.png&#34;</span>)) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendPhoto</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, { <span style=color:#a6e22e>caption</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.mp4&#34;</span>)) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendVideo</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, { <span style=color:#a6e22e>caption</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendDocument</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, {}, { <span style=color:#a6e22e>filename</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>answerCallbackQuery</span>(<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>id</span>);
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><h1 id=docker>Docker<a hidden class=anchor aria-hidden=true href=#docker>#</a></h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 使用官方 Node.js 镜像</span>
</span></span><span style=display:flex><span>FROM node:20
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 设置工作目录</span>
</span></span><span style=display:flex><span>WORKDIR /app
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 复制 package.json 和 package-lock.json</span>
</span></span><span style=display:flex><span>COPY package*.json ./
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 安装依赖</span>
</span></span><span style=display:flex><span>RUN npm install --production
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 复制项目代码</span>
</span></span><span style=display:flex><span>COPY . .
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 暴露端口（根据 app.js 监听的端口）</span>
</span></span><span style=display:flex><span>EXPOSE <span style=color:#ae81ff>3000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 容器启动命令</span>
</span></span><span style=display:flex><span>CMD <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;node&#34;</span>, <span style=color:#e6db74>&#34;bot.js&#34;</span><span style=color:#f92672>]</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker build -t my-node-app .
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker run -d <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --name node-app <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -p 3000:3000 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -v <span style=color:#66d9ef>$(</span>pwd<span style=color:#66d9ef>)</span>:/app <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --restart unless-stopped <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  my-node-app
</span></span></code></pre></div><h1 id=原始消息>原始消息<a hidden class=anchor aria-hidden=true href=#原始消息>#</a></h1><h2 id=数据库结构更新-dbjs>数据库结构更新 (db.js)<a hidden class=anchor aria-hidden=true href=#数据库结构更新-dbjs>#</a></h2><p>添加了转发消息相关字段：
is_forward: 是否为转发消息
forward_from_chat_id: 来源群组ID
forward_from_chat_title: 来源群组名称
forward_from_chat_type: 群组类型
forward_from_chat_username: 群组用户名
forward_message_id: 转发消息ID
jump_link: 跳转链接</p><h2 id=转发消息处理-botjs>转发消息处理 (bot.js)<a hidden class=anchor aria-hidden=true href=#转发消息处理-botjs>#</a></h2><p>保存群组信息：检测转发消息并保存完整的群组信息
生成跳转链接：
公开群组/频道：https://t.me/{username}/{message_id}
私有群组：https://t.me/c/{chat_id}/{message_id}
显示来源：在文件列表中显示来源群组名称</p><h2 id=按钮布局更新>按钮布局更新<a hidden class=anchor aria-hidden=true href=#按钮布局更新>#</a></h2><p>将原来的按钮布局改为：</p><p>ℹ️ 详情 - 查看文件详细信息
❌ 删除 - 删除文件
⬇️ 下载 - 下载文件到服务器本地
🔗 跳转 - 跳转到原始消息（仅转发消息显示）</p><h2 id=详情页面增强>详情页面增强<a hidden class=anchor aria-hidden=true href=#详情页面增强>#</a></h2><p>显示是否为转发消息
显示来源群组信息
显示群组类型
显示跳转链接</p><p>自动识别并保存转发的群组消息
为每个转发消息生成可点击的跳转链接
在文件列表中显示统一的四个按钮：详情、删除、下载、跳转
区分公开群和私有群，生成正确的链接格式</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 通用保存函数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#a6e22e>type</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>chatId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>category</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>userCategory</span>[<span style=color:#a6e22e>userId</span>] <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;未分类&#34;</span>;
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 检查是否为转发消息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>isForward</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>forward_from</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>forward_from_chat</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>forwardInfo</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>is_forward</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>isForward</span> <span style=color:#f92672>?</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>:</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>forward_from_chat_id</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>forward_from_chat_title</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>forward_from_chat_type</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>forward_from_chat_username</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>forward_message_id</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>jump_link</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>isForward</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>forward_from_chat</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>forwardChat</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>forward_from_chat</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>forwardInfo</span>.<span style=color:#a6e22e>forward_from_chat_id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>forwardChat</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>forwardInfo</span>.<span style=color:#a6e22e>forward_from_chat_title</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>forwardChat</span>.<span style=color:#a6e22e>title</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>forwardInfo</span>.<span style=color:#a6e22e>forward_from_chat_type</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>forwardChat</span>.<span style=color:#a6e22e>type</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>forwardInfo</span>.<span style=color:#a6e22e>forward_from_chat_username</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>forwardChat</span>.<span style=color:#a6e22e>username</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>forwardInfo</span>.<span style=color:#a6e22e>forward_message_id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>forward_from_message_id</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 生成跳转链接
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>forwardChat</span>.<span style=color:#a6e22e>username</span>) {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 公开群组/频道
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>forwardInfo</span>.<span style=color:#a6e22e>jump_link</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`https://t.me/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>forwardChat</span>.<span style=color:#a6e22e>username</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>forward_from_message_id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 私有群组
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>forwardInfo</span>.<span style=color:#a6e22e>jump_link</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`https://t.me/c/</span><span style=color:#e6db74>${</span>Math.<span style=color:#a6e22e>abs</span>(<span style=color:#a6e22e>forwardChat</span>.<span style=color:#a6e22e>id</span>).<span style=color:#a6e22e>toString</span>().<span style=color:#a6e22e>substring</span>(<span style=color:#ae81ff>4</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>forward_from_message_id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>run</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`INSERT INTO files (file_id, file_name, category, user_id, date, is_forward, forward_from_chat_id, forward_from_chat_title, forward_from_chat_type, forward_from_chat_username, forward_message_id, jump_link) VALUES (?, ?, ?, ?, datetime(&#39;now&#39;), ?, ?, ?, ?, ?, ?, ?)`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#a6e22e>category</span>, <span style=color:#a6e22e>userId</span>, <span style=color:#a6e22e>forwardInfo</span>.<span style=color:#a6e22e>is_forward</span>, <span style=color:#a6e22e>forwardInfo</span>.<span style=color:#a6e22e>forward_from_chat_id</span>, <span style=color:#a6e22e>forwardInfo</span>.<span style=color:#a6e22e>forward_from_chat_title</span>, <span style=color:#a6e22e>forwardInfo</span>.<span style=color:#a6e22e>forward_from_chat_type</span>, <span style=color:#a6e22e>forwardInfo</span>.<span style=color:#a6e22e>forward_from_chat_username</span>, <span style=color:#a6e22e>forwardInfo</span>.<span style=color:#a6e22e>forward_message_id</span>, <span style=color:#a6e22e>forwardInfo</span>.<span style=color:#a6e22e>jump_link</span>],
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;❌ 存储失败。&#34;</span>);
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>message</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`📦 已保存 </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>type</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\nID: </span><span style=color:#e6db74>${</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>lastID</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\n文件名: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\n分类: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>forwardInfo</span>.<span style=color:#a6e22e>is_forward</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>forwardInfo</span>.<span style=color:#a6e22e>forward_from_chat_title</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>message</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>`\n来源群组: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>forwardInfo</span>.<span style=color:#a6e22e>forward_from_chat_title</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#a6e22e>message</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h1 id=bots>bots<a hidden class=anchor aria-hidden=true href=#bots>#</a></h1><p><a href=https://github.com/AZeC4/TelegramBot>https://github.com/AZeC4/TelegramBot</a></p><p><a href=https://github.com/itgoyo/TelegramBot>https://github.com/itgoyo/TelegramBot</a></p><p><a href=https://github.com/itgoyo/TelegramGroup>https://github.com/itgoyo/TelegramGroup</a></p><h1 id=next-tgbot>Next TGBOT<a hidden class=anchor aria-hidden=true href=#next-tgbot>#</a></h1><p>LocalWeb Manage</p><p>go txt config 新建 回复 Q:A 适用于群回复</p><p>分类 列表 对应分类
sql备份 前端后台等</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://qfsyso.github.io/tags/tg/>TG</a></li><li><a href=https://qfsyso.github.io/tags/node/>Node</a></li><li><a href=https://qfsyso.github.io/tags/server/>Server</a></li><li><a href=https://qfsyso.github.io/tags/docker/>Docker</a></li></ul><nav class=paginav><a class=prev href=https://qfsyso.github.io/posts/push-tg-bot/><span class=title>« Prev</span><br><span>Push TG Bot</span>
</a><a class=next href=https://qfsyso.github.io/posts/go-file-manager/><span class=title>Next »</span><br><span>Go File Manager</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Node TG FileBot on x" href="https://x.com/intent/tweet/?text=Node%20TG%20FileBot&amp;url=https%3a%2f%2fqfsyso.github.io%2fposts%2fnode-tg-filebot%2f&amp;hashtags=TG%2cNode%2cServer%2cDocker"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Node TG FileBot on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fqfsyso.github.io%2fposts%2fnode-tg-filebot%2f&amp;title=Node%20TG%20FileBot&amp;summary=Node%20TG%20FileBot&amp;source=https%3a%2f%2fqfsyso.github.io%2fposts%2fnode-tg-filebot%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Node TG FileBot on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fqfsyso.github.io%2fposts%2fnode-tg-filebot%2f&title=Node%20TG%20FileBot"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Node TG FileBot on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fqfsyso.github.io%2fposts%2fnode-tg-filebot%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Node TG FileBot on whatsapp" href="https://api.whatsapp.com/send?text=Node%20TG%20FileBot%20-%20https%3a%2f%2fqfsyso.github.io%2fposts%2fnode-tg-filebot%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Node TG FileBot on telegram" href="https://telegram.me/share/url?text=Node%20TG%20FileBot&amp;url=https%3a%2f%2fqfsyso.github.io%2fposts%2fnode-tg-filebot%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Node TG FileBot on ycombinator" href="https://news.ycombinator.com/submitlink?t=Node%20TG%20FileBot&u=https%3a%2f%2fqfsyso.github.io%2fposts%2fnode-tg-filebot%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><div class=wtime><div class=wtime2>CST<span id=beijingTime></span> GMT <span id=londonTime></span> EST <span id=newYorkTime></span> PST<span id=losAngelesTime></span></div><div class=wtime2 style=display:none>东京<span id=tokyoTime></span></div><div class=wtime2 style=display:none>欧洲-巴黎<span id=parisTime></span></div><div class=wtime2 style=display:none>UTC<span id=utcTime></span></div></div><span>&copy; 2025 <a href=https://qfsyso.github.io/>MLOG</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a>
</span><script type=text/javascript>const timeZoneOffsets={beijing:8,tokyo:9,paris:[1,2],london:[0,1],newYork:[-5,-4],losAngeles:[-8,-7]};function padZero(e){return e<10?"0"+e:e}function formatTime(e){const t=e.getFullYear(),n=padZero(e.getMonth()+1),s=padZero(e.getDate()),o=padZero(e.getHours()),i=padZero(e.getMinutes()),a=padZero(e.getSeconds());return`${t}-${n}-${s} ${o}:${i}:${a}`}function isDaylightSavingTime(e,t){const o=e.getMonth(),n=new Date(e.getFullYear(),3,8,2,0,0),s=new Date(e.getFullYear(),10,1,2,0,0);return(t==="paris"||t==="london"||t==="newYork"||t==="losAngeles")&&e>=n&&e<s}function updateTime(){const e=new Date,t=new Date(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds()),n=formatTime(t);document.getElementById("utcTime").innerHTML=n;for(const n in timeZoneOffsets){const e=timeZoneOffsets[n];let s;Array.isArray(e)?s=isDaylightSavingTime(t,n)?e[1]:e[0]:s=e;const o=new Date(t.getTime()+s*60*60*1e3);document.getElementById(n+"Time").innerHTML=formatTime(o)}setTimeout(updateTime,1e3)}window.onload=function(){updateTime()};function notfound(e){var n=e.src,t=n.split("/"),s=t[t.length-1];e.src="https://47.115.223.75:8080/group1/v2/"+s+"?timestamp="+Date.now(),e.onerror=null}</script></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>