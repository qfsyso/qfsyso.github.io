<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Node TG FileBot | MLOG</title>
<meta name=keywords content="TG,Node,Server,Docker"><meta name=description content="Node.js TG æ–‡ä»¶ç®¡ç†æœºå™¨äººï¼Œæ”¯æŒåˆ†ç±»å­˜å‚¨ã€åˆ†é¡µæµè§ˆã€æœç´¢ã€ä¸‹è½½ã€åˆ é™¤æ–‡ä»¶ï¼ŒåŒæ—¶æ”¯æŒå›¾ç‰‡ç¼©ç•¥å›¾é¢„è§ˆå’ŒæœåŠ¡å™¨æœ¬åœ°ä¸‹è½½ã€‚
åŠŸèƒ½ æ–‡ä»¶åˆ†ç±»ç®¡ç†ï¼šæ”¯æŒç”¨æˆ·è‡ªå®šä¹‰åˆ†ç±»ã€‚
æ–‡ä»¶ä¸Šä¼ è‡ªåŠ¨ä¿å­˜ï¼šæ”¯æŒæ–‡æ¡£ã€å›¾ç‰‡ã€è§†é¢‘ï¼Œå¹¶è®°å½•ä¸Šä¼ ç”¨æˆ·å’Œåˆ†ç±»ã€‚
åˆ†é¡µæŸ¥çœ‹æ–‡ä»¶åˆ—è¡¨ï¼šå¯åˆ†é¡µæ˜¾ç¤ºæœ€è¿‘ä¸Šä¼ çš„æ–‡ä»¶ã€‚
å›¾ç‰‡ç¼©ç•¥å›¾ï¼šåœ¨åˆ†é¡µåˆ—è¡¨ä¸­æ˜¾ç¤ºå›¾ç‰‡ç¼©ç•¥å›¾ã€‚
æ–‡ä»¶æœç´¢ï¼šæŒ‰æ–‡ä»¶åå…³é”®å­—æœç´¢æ–‡ä»¶ã€‚
è·å–æ–‡ä»¶ï¼šæ”¯æŒå‘é€æ–‡ä»¶å› Telegramã€‚
åˆ é™¤æ–‡ä»¶ï¼šæ”¯æŒå•ä¸ªæ–‡ä»¶åˆ é™¤ï¼Œå¸¦ç¡®è®¤æœºåˆ¶ã€‚
ä¸‹è½½åˆ°æœ¬åœ°ï¼šå°†æ–‡ä»¶ä¸‹è½½åˆ°æœåŠ¡å™¨æœ¬åœ°ï¼Œæ”¯æŒé‡è¯•å’Œé”™è¯¯æç¤ºã€‚
å‘½ä»¤ï¼š /start # æ¬¢è¿ä¿¡æ¯å’Œæ“ä½œæç¤º /setcategory # è®¾ç½®æ–‡ä»¶åˆ†ç±» /myfiles # æŸ¥çœ‹æœ€è¿‘ 10 æ¡æ–‡ä»¶ /myfilelist [é¡µç ] # åˆ†é¡µæ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨ /search å…³é”®å­— # æœç´¢æ–‡ä»¶ /getfile id # è·å–æ–‡ä»¶åˆ° Telegram /delete id # åˆ é™¤æ–‡ä»¶
æŒ‰é’®æ“ä½œï¼š åˆ†ç±»é€‰æ‹©ï¼šåœ¨ /setcategory åç‚¹å‡»æŒ‰é’®è®¾ç½®åˆ†ç±»ã€‚
åˆ é™¤æ–‡ä»¶ï¼šç‚¹å‡»â€œåˆ é™¤â€æŒ‰é’®ï¼Œå¸¦ç¡®è®¤æ“ä½œã€‚
ä¸‹è½½æ–‡ä»¶ï¼šç‚¹å‡»â€œä¸‹è½½æœ¬åœ°â€æŒ‰é’®ï¼Œå°†æ–‡ä»¶ä¸‹è½½åˆ°æœåŠ¡å™¨æœ¬åœ°ã€‚
åˆ†é¡µï¼šç‚¹å‡»ä¸Šä¸€é¡µ/ä¸‹ä¸€é¡µç¿»é¡µã€‚
æ–‡ä»¶å­˜å‚¨ é»˜è®¤æœ¬åœ°å­˜å‚¨ç›®å½•ï¼š./files/åˆ†ç±»å/æ–‡ä»¶å
æ”¯æŒè‡ªåŠ¨åˆ›å»ºåˆ†ç±»ç›®å½•ã€‚
å›¾ç‰‡ä¼šåœ¨åˆ†é¡µåˆ—è¡¨æ˜¾ç¤ºç¼©ç•¥å›¾ã€‚
é”™è¯¯å¤„ç†å’Œæ—¥å¿—
æ–‡ä»¶ä¸‹è½½æ”¯æŒ 3 æ¬¡é‡è¯•ï¼Œå¤±è´¥ä¼šè¾“å‡ºæ§åˆ¶å°æ—¥å¿—ã€‚
ç”¨æˆ·ç«¯æ”¶åˆ°å‹å¥½æç¤ºï¼Œä¸ä¼šå¯¼è‡´ bot å´©æ‰ã€‚
ä¾èµ– node-telegram-bot-api sqlite3 axios Node.js >= 16 é¡¹ç›®ç›®å½•ç»“æ„ bot.js # ä¸»ç¨‹åº db."><meta name=author content="dwd"><link rel=canonical href=https://qfsyso.github.io/posts/node-tg-filebot/><link crossorigin=anonymous href=/assets/css/stylesheet.f49d66caae9ea0fd43f21f29e71a8d3e284517ed770f2aa86fa012953ad3c9ef.css integrity="sha256-9J1myq6eoP1D8h8p5xqNPihFF+13Dyqob6ASlTrTye8=" rel="preload stylesheet" as=style><link rel=icon href=https://qfsyso.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://qfsyso.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://qfsyso.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://qfsyso.github.io/apple-touch-icon.png><link rel=mask-icon href=https://qfsyso.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://qfsyso.github.io/posts/node-tg-filebot/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://qfsyso.github.io/posts/node-tg-filebot/"><meta property="og:site_name" content="MLOG"><meta property="og:title" content="Node TG FileBot"><meta property="og:description" content="Node.js TG æ–‡ä»¶ç®¡ç†æœºå™¨äººï¼Œæ”¯æŒåˆ†ç±»å­˜å‚¨ã€åˆ†é¡µæµè§ˆã€æœç´¢ã€ä¸‹è½½ã€åˆ é™¤æ–‡ä»¶ï¼ŒåŒæ—¶æ”¯æŒå›¾ç‰‡ç¼©ç•¥å›¾é¢„è§ˆå’ŒæœåŠ¡å™¨æœ¬åœ°ä¸‹è½½ã€‚
åŠŸèƒ½ æ–‡ä»¶åˆ†ç±»ç®¡ç†ï¼šæ”¯æŒç”¨æˆ·è‡ªå®šä¹‰åˆ†ç±»ã€‚
æ–‡ä»¶ä¸Šä¼ è‡ªåŠ¨ä¿å­˜ï¼šæ”¯æŒæ–‡æ¡£ã€å›¾ç‰‡ã€è§†é¢‘ï¼Œå¹¶è®°å½•ä¸Šä¼ ç”¨æˆ·å’Œåˆ†ç±»ã€‚
åˆ†é¡µæŸ¥çœ‹æ–‡ä»¶åˆ—è¡¨ï¼šå¯åˆ†é¡µæ˜¾ç¤ºæœ€è¿‘ä¸Šä¼ çš„æ–‡ä»¶ã€‚
å›¾ç‰‡ç¼©ç•¥å›¾ï¼šåœ¨åˆ†é¡µåˆ—è¡¨ä¸­æ˜¾ç¤ºå›¾ç‰‡ç¼©ç•¥å›¾ã€‚
æ–‡ä»¶æœç´¢ï¼šæŒ‰æ–‡ä»¶åå…³é”®å­—æœç´¢æ–‡ä»¶ã€‚
è·å–æ–‡ä»¶ï¼šæ”¯æŒå‘é€æ–‡ä»¶å› Telegramã€‚
åˆ é™¤æ–‡ä»¶ï¼šæ”¯æŒå•ä¸ªæ–‡ä»¶åˆ é™¤ï¼Œå¸¦ç¡®è®¤æœºåˆ¶ã€‚
ä¸‹è½½åˆ°æœ¬åœ°ï¼šå°†æ–‡ä»¶ä¸‹è½½åˆ°æœåŠ¡å™¨æœ¬åœ°ï¼Œæ”¯æŒé‡è¯•å’Œé”™è¯¯æç¤ºã€‚
å‘½ä»¤ï¼š /start # æ¬¢è¿ä¿¡æ¯å’Œæ“ä½œæç¤º /setcategory # è®¾ç½®æ–‡ä»¶åˆ†ç±» /myfiles # æŸ¥çœ‹æœ€è¿‘ 10 æ¡æ–‡ä»¶ /myfilelist [é¡µç ] # åˆ†é¡µæ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨ /search å…³é”®å­— # æœç´¢æ–‡ä»¶ /getfile id # è·å–æ–‡ä»¶åˆ° Telegram /delete id # åˆ é™¤æ–‡ä»¶
æŒ‰é’®æ“ä½œï¼š åˆ†ç±»é€‰æ‹©ï¼šåœ¨ /setcategory åç‚¹å‡»æŒ‰é’®è®¾ç½®åˆ†ç±»ã€‚
åˆ é™¤æ–‡ä»¶ï¼šç‚¹å‡»â€œåˆ é™¤â€æŒ‰é’®ï¼Œå¸¦ç¡®è®¤æ“ä½œã€‚
ä¸‹è½½æ–‡ä»¶ï¼šç‚¹å‡»â€œä¸‹è½½æœ¬åœ°â€æŒ‰é’®ï¼Œå°†æ–‡ä»¶ä¸‹è½½åˆ°æœåŠ¡å™¨æœ¬åœ°ã€‚
åˆ†é¡µï¼šç‚¹å‡»ä¸Šä¸€é¡µ/ä¸‹ä¸€é¡µç¿»é¡µã€‚
æ–‡ä»¶å­˜å‚¨ é»˜è®¤æœ¬åœ°å­˜å‚¨ç›®å½•ï¼š./files/åˆ†ç±»å/æ–‡ä»¶å
æ”¯æŒè‡ªåŠ¨åˆ›å»ºåˆ†ç±»ç›®å½•ã€‚
å›¾ç‰‡ä¼šåœ¨åˆ†é¡µåˆ—è¡¨æ˜¾ç¤ºç¼©ç•¥å›¾ã€‚
é”™è¯¯å¤„ç†å’Œæ—¥å¿—
æ–‡ä»¶ä¸‹è½½æ”¯æŒ 3 æ¬¡é‡è¯•ï¼Œå¤±è´¥ä¼šè¾“å‡ºæ§åˆ¶å°æ—¥å¿—ã€‚
ç”¨æˆ·ç«¯æ”¶åˆ°å‹å¥½æç¤ºï¼Œä¸ä¼šå¯¼è‡´ bot å´©æ‰ã€‚
ä¾èµ– node-telegram-bot-api sqlite3 axios Node.js >= 16 é¡¹ç›®ç›®å½•ç»“æ„ bot.js # ä¸»ç¨‹åº db."><meta property="og:locale" content="zh-CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-08-26T22:51:47+08:00"><meta property="article:modified_time" content="2025-08-26T22:51:47+08:00"><meta property="article:tag" content="TG"><meta property="article:tag" content="Node"><meta property="article:tag" content="Server"><meta property="article:tag" content="Docker"><meta name=twitter:card content="summary"><meta name=twitter:title content="Node TG FileBot"><meta name=twitter:description content="Node.js TG æ–‡ä»¶ç®¡ç†æœºå™¨äººï¼Œæ”¯æŒåˆ†ç±»å­˜å‚¨ã€åˆ†é¡µæµè§ˆã€æœç´¢ã€ä¸‹è½½ã€åˆ é™¤æ–‡ä»¶ï¼ŒåŒæ—¶æ”¯æŒå›¾ç‰‡ç¼©ç•¥å›¾é¢„è§ˆå’ŒæœåŠ¡å™¨æœ¬åœ°ä¸‹è½½ã€‚
åŠŸèƒ½ æ–‡ä»¶åˆ†ç±»ç®¡ç†ï¼šæ”¯æŒç”¨æˆ·è‡ªå®šä¹‰åˆ†ç±»ã€‚
æ–‡ä»¶ä¸Šä¼ è‡ªåŠ¨ä¿å­˜ï¼šæ”¯æŒæ–‡æ¡£ã€å›¾ç‰‡ã€è§†é¢‘ï¼Œå¹¶è®°å½•ä¸Šä¼ ç”¨æˆ·å’Œåˆ†ç±»ã€‚
åˆ†é¡µæŸ¥çœ‹æ–‡ä»¶åˆ—è¡¨ï¼šå¯åˆ†é¡µæ˜¾ç¤ºæœ€è¿‘ä¸Šä¼ çš„æ–‡ä»¶ã€‚
å›¾ç‰‡ç¼©ç•¥å›¾ï¼šåœ¨åˆ†é¡µåˆ—è¡¨ä¸­æ˜¾ç¤ºå›¾ç‰‡ç¼©ç•¥å›¾ã€‚
æ–‡ä»¶æœç´¢ï¼šæŒ‰æ–‡ä»¶åå…³é”®å­—æœç´¢æ–‡ä»¶ã€‚
è·å–æ–‡ä»¶ï¼šæ”¯æŒå‘é€æ–‡ä»¶å› Telegramã€‚
åˆ é™¤æ–‡ä»¶ï¼šæ”¯æŒå•ä¸ªæ–‡ä»¶åˆ é™¤ï¼Œå¸¦ç¡®è®¤æœºåˆ¶ã€‚
ä¸‹è½½åˆ°æœ¬åœ°ï¼šå°†æ–‡ä»¶ä¸‹è½½åˆ°æœåŠ¡å™¨æœ¬åœ°ï¼Œæ”¯æŒé‡è¯•å’Œé”™è¯¯æç¤ºã€‚
å‘½ä»¤ï¼š /start # æ¬¢è¿ä¿¡æ¯å’Œæ“ä½œæç¤º /setcategory # è®¾ç½®æ–‡ä»¶åˆ†ç±» /myfiles # æŸ¥çœ‹æœ€è¿‘ 10 æ¡æ–‡ä»¶ /myfilelist [é¡µç ] # åˆ†é¡µæ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨ /search å…³é”®å­— # æœç´¢æ–‡ä»¶ /getfile id # è·å–æ–‡ä»¶åˆ° Telegram /delete id # åˆ é™¤æ–‡ä»¶
æŒ‰é’®æ“ä½œï¼š åˆ†ç±»é€‰æ‹©ï¼šåœ¨ /setcategory åç‚¹å‡»æŒ‰é’®è®¾ç½®åˆ†ç±»ã€‚
åˆ é™¤æ–‡ä»¶ï¼šç‚¹å‡»â€œåˆ é™¤â€æŒ‰é’®ï¼Œå¸¦ç¡®è®¤æ“ä½œã€‚
ä¸‹è½½æ–‡ä»¶ï¼šç‚¹å‡»â€œä¸‹è½½æœ¬åœ°â€æŒ‰é’®ï¼Œå°†æ–‡ä»¶ä¸‹è½½åˆ°æœåŠ¡å™¨æœ¬åœ°ã€‚
åˆ†é¡µï¼šç‚¹å‡»ä¸Šä¸€é¡µ/ä¸‹ä¸€é¡µç¿»é¡µã€‚
æ–‡ä»¶å­˜å‚¨ é»˜è®¤æœ¬åœ°å­˜å‚¨ç›®å½•ï¼š./files/åˆ†ç±»å/æ–‡ä»¶å
æ”¯æŒè‡ªåŠ¨åˆ›å»ºåˆ†ç±»ç›®å½•ã€‚
å›¾ç‰‡ä¼šåœ¨åˆ†é¡µåˆ—è¡¨æ˜¾ç¤ºç¼©ç•¥å›¾ã€‚
é”™è¯¯å¤„ç†å’Œæ—¥å¿—
æ–‡ä»¶ä¸‹è½½æ”¯æŒ 3 æ¬¡é‡è¯•ï¼Œå¤±è´¥ä¼šè¾“å‡ºæ§åˆ¶å°æ—¥å¿—ã€‚
ç”¨æˆ·ç«¯æ”¶åˆ°å‹å¥½æç¤ºï¼Œä¸ä¼šå¯¼è‡´ bot å´©æ‰ã€‚
ä¾èµ– node-telegram-bot-api sqlite3 axios Node.js >= 16 é¡¹ç›®ç›®å½•ç»“æ„ bot.js # ä¸»ç¨‹åº db."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://qfsyso.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Node TG FileBot","item":"https://qfsyso.github.io/posts/node-tg-filebot/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Node TG FileBot","name":"Node TG FileBot","description":"Node.js TG æ–‡ä»¶ç®¡ç†æœºå™¨äººï¼Œæ”¯æŒåˆ†ç±»å­˜å‚¨ã€åˆ†é¡µæµè§ˆã€æœç´¢ã€ä¸‹è½½ã€åˆ é™¤æ–‡ä»¶ï¼ŒåŒæ—¶æ”¯æŒå›¾ç‰‡ç¼©ç•¥å›¾é¢„è§ˆå’ŒæœåŠ¡å™¨æœ¬åœ°ä¸‹è½½ã€‚\nåŠŸèƒ½ æ–‡ä»¶åˆ†ç±»ç®¡ç†ï¼šæ”¯æŒç”¨æˆ·è‡ªå®šä¹‰åˆ†ç±»ã€‚\næ–‡ä»¶ä¸Šä¼ è‡ªåŠ¨ä¿å­˜ï¼šæ”¯æŒæ–‡æ¡£ã€å›¾ç‰‡ã€è§†é¢‘ï¼Œå¹¶è®°å½•ä¸Šä¼ ç”¨æˆ·å’Œåˆ†ç±»ã€‚\nåˆ†é¡µæŸ¥çœ‹æ–‡ä»¶åˆ—è¡¨ï¼šå¯åˆ†é¡µæ˜¾ç¤ºæœ€è¿‘ä¸Šä¼ çš„æ–‡ä»¶ã€‚\nå›¾ç‰‡ç¼©ç•¥å›¾ï¼šåœ¨åˆ†é¡µåˆ—è¡¨ä¸­æ˜¾ç¤ºå›¾ç‰‡ç¼©ç•¥å›¾ã€‚\næ–‡ä»¶æœç´¢ï¼šæŒ‰æ–‡ä»¶åå…³é”®å­—æœç´¢æ–‡ä»¶ã€‚\nè·å–æ–‡ä»¶ï¼šæ”¯æŒå‘é€æ–‡ä»¶å› Telegramã€‚\nåˆ é™¤æ–‡ä»¶ï¼šæ”¯æŒå•ä¸ªæ–‡ä»¶åˆ é™¤ï¼Œå¸¦ç¡®è®¤æœºåˆ¶ã€‚\nä¸‹è½½åˆ°æœ¬åœ°ï¼šå°†æ–‡ä»¶ä¸‹è½½åˆ°æœåŠ¡å™¨æœ¬åœ°ï¼Œæ”¯æŒé‡è¯•å’Œé”™è¯¯æç¤ºã€‚\nå‘½ä»¤ï¼š /start # æ¬¢è¿ä¿¡æ¯å’Œæ“ä½œæç¤º /setcategory # è®¾ç½®æ–‡ä»¶åˆ†ç±» /myfiles # æŸ¥çœ‹æœ€è¿‘ 10 æ¡æ–‡ä»¶ /myfilelist [é¡µç ] # åˆ†é¡µæ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨ /search å…³é”®å­— # æœç´¢æ–‡ä»¶ /getfile id # è·å–æ–‡ä»¶åˆ° Telegram /delete id # åˆ é™¤æ–‡ä»¶\næŒ‰é’®æ“ä½œï¼š åˆ†ç±»é€‰æ‹©ï¼šåœ¨ /setcategory åç‚¹å‡»æŒ‰é’®è®¾ç½®åˆ†ç±»ã€‚\nåˆ é™¤æ–‡ä»¶ï¼šç‚¹å‡»â€œåˆ é™¤â€æŒ‰é’®ï¼Œå¸¦ç¡®è®¤æ“ä½œã€‚\nä¸‹è½½æ–‡ä»¶ï¼šç‚¹å‡»â€œä¸‹è½½æœ¬åœ°â€æŒ‰é’®ï¼Œå°†æ–‡ä»¶ä¸‹è½½åˆ°æœåŠ¡å™¨æœ¬åœ°ã€‚\nåˆ†é¡µï¼šç‚¹å‡»ä¸Šä¸€é¡µ/ä¸‹ä¸€é¡µç¿»é¡µã€‚\næ–‡ä»¶å­˜å‚¨ é»˜è®¤æœ¬åœ°å­˜å‚¨ç›®å½•ï¼š./files/åˆ†ç±»å/æ–‡ä»¶å\næ”¯æŒè‡ªåŠ¨åˆ›å»ºåˆ†ç±»ç›®å½•ã€‚\nå›¾ç‰‡ä¼šåœ¨åˆ†é¡µåˆ—è¡¨æ˜¾ç¤ºç¼©ç•¥å›¾ã€‚\né”™è¯¯å¤„ç†å’Œæ—¥å¿—\næ–‡ä»¶ä¸‹è½½æ”¯æŒ 3 æ¬¡é‡è¯•ï¼Œå¤±è´¥ä¼šè¾“å‡ºæ§åˆ¶å°æ—¥å¿—ã€‚\nç”¨æˆ·ç«¯æ”¶åˆ°å‹å¥½æç¤ºï¼Œä¸ä¼šå¯¼è‡´ bot å´©æ‰ã€‚\nä¾èµ– node-telegram-bot-api sqlite3 axios Node.js \u0026gt;= 16 é¡¹ç›®ç›®å½•ç»“æ„ bot.js # ä¸»ç¨‹åº db.","keywords":["TG","Node","Server","Docker"],"articleBody":"Node.js TG æ–‡ä»¶ç®¡ç†æœºå™¨äººï¼Œæ”¯æŒåˆ†ç±»å­˜å‚¨ã€åˆ†é¡µæµè§ˆã€æœç´¢ã€ä¸‹è½½ã€åˆ é™¤æ–‡ä»¶ï¼ŒåŒæ—¶æ”¯æŒå›¾ç‰‡ç¼©ç•¥å›¾é¢„è§ˆå’ŒæœåŠ¡å™¨æœ¬åœ°ä¸‹è½½ã€‚\nåŠŸèƒ½ æ–‡ä»¶åˆ†ç±»ç®¡ç†ï¼šæ”¯æŒç”¨æˆ·è‡ªå®šä¹‰åˆ†ç±»ã€‚\næ–‡ä»¶ä¸Šä¼ è‡ªåŠ¨ä¿å­˜ï¼šæ”¯æŒæ–‡æ¡£ã€å›¾ç‰‡ã€è§†é¢‘ï¼Œå¹¶è®°å½•ä¸Šä¼ ç”¨æˆ·å’Œåˆ†ç±»ã€‚\nåˆ†é¡µæŸ¥çœ‹æ–‡ä»¶åˆ—è¡¨ï¼šå¯åˆ†é¡µæ˜¾ç¤ºæœ€è¿‘ä¸Šä¼ çš„æ–‡ä»¶ã€‚\nå›¾ç‰‡ç¼©ç•¥å›¾ï¼šåœ¨åˆ†é¡µåˆ—è¡¨ä¸­æ˜¾ç¤ºå›¾ç‰‡ç¼©ç•¥å›¾ã€‚\næ–‡ä»¶æœç´¢ï¼šæŒ‰æ–‡ä»¶åå…³é”®å­—æœç´¢æ–‡ä»¶ã€‚\nè·å–æ–‡ä»¶ï¼šæ”¯æŒå‘é€æ–‡ä»¶å› Telegramã€‚\nåˆ é™¤æ–‡ä»¶ï¼šæ”¯æŒå•ä¸ªæ–‡ä»¶åˆ é™¤ï¼Œå¸¦ç¡®è®¤æœºåˆ¶ã€‚\nä¸‹è½½åˆ°æœ¬åœ°ï¼šå°†æ–‡ä»¶ä¸‹è½½åˆ°æœåŠ¡å™¨æœ¬åœ°ï¼Œæ”¯æŒé‡è¯•å’Œé”™è¯¯æç¤ºã€‚\nå‘½ä»¤ï¼š /start # æ¬¢è¿ä¿¡æ¯å’Œæ“ä½œæç¤º /setcategory # è®¾ç½®æ–‡ä»¶åˆ†ç±» /myfiles # æŸ¥çœ‹æœ€è¿‘ 10 æ¡æ–‡ä»¶ /myfilelist [é¡µç ] # åˆ†é¡µæ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨ /search å…³é”®å­— # æœç´¢æ–‡ä»¶ /getfile id # è·å–æ–‡ä»¶åˆ° Telegram /delete id # åˆ é™¤æ–‡ä»¶\næŒ‰é’®æ“ä½œï¼š åˆ†ç±»é€‰æ‹©ï¼šåœ¨ /setcategory åç‚¹å‡»æŒ‰é’®è®¾ç½®åˆ†ç±»ã€‚\nåˆ é™¤æ–‡ä»¶ï¼šç‚¹å‡»â€œåˆ é™¤â€æŒ‰é’®ï¼Œå¸¦ç¡®è®¤æ“ä½œã€‚\nä¸‹è½½æ–‡ä»¶ï¼šç‚¹å‡»â€œä¸‹è½½æœ¬åœ°â€æŒ‰é’®ï¼Œå°†æ–‡ä»¶ä¸‹è½½åˆ°æœåŠ¡å™¨æœ¬åœ°ã€‚\nåˆ†é¡µï¼šç‚¹å‡»ä¸Šä¸€é¡µ/ä¸‹ä¸€é¡µç¿»é¡µã€‚\næ–‡ä»¶å­˜å‚¨ é»˜è®¤æœ¬åœ°å­˜å‚¨ç›®å½•ï¼š./files/åˆ†ç±»å/æ–‡ä»¶å\næ”¯æŒè‡ªåŠ¨åˆ›å»ºåˆ†ç±»ç›®å½•ã€‚\nå›¾ç‰‡ä¼šåœ¨åˆ†é¡µåˆ—è¡¨æ˜¾ç¤ºç¼©ç•¥å›¾ã€‚\né”™è¯¯å¤„ç†å’Œæ—¥å¿—\næ–‡ä»¶ä¸‹è½½æ”¯æŒ 3 æ¬¡é‡è¯•ï¼Œå¤±è´¥ä¼šè¾“å‡ºæ§åˆ¶å°æ—¥å¿—ã€‚\nç”¨æˆ·ç«¯æ”¶åˆ°å‹å¥½æç¤ºï¼Œä¸ä¼šå¯¼è‡´ bot å´©æ‰ã€‚\nä¾èµ– node-telegram-bot-api sqlite3 axios Node.js \u003e= 16 é¡¹ç›®ç›®å½•ç»“æ„ bot.js # ä¸»ç¨‹åº db.js # SQLite æ•°æ®åº“å°è£… files/ # æœ¬åœ°æ–‡ä»¶å­˜å‚¨ç›®å½• node_modules/ # ä¾èµ–åº“ package.json\næ³¨æ„äº‹é¡¹ ç¡®ä¿æœåŠ¡å™¨å¯ä»¥è®¿é—® Telegram APIï¼ˆå›½å†…å¯èƒ½éœ€è¦ä»£ç†ï¼‰ã€‚\ntoken å¿…é¡»æ­£ç¡®ï¼Œä¸” bot æœ‰æ–‡ä»¶è¯»å–æƒé™ã€‚\nå›¾ç‰‡ç¼©ç•¥å›¾é€šè¿‡ Telegram sendMediaGroup å®ç°ï¼Œå…¶ä»–æ–‡ä»¶æ˜¾ç¤ºä¸ºæ–‡å­—åˆ—è¡¨ã€‚\nä¸‹è½½æ–‡ä»¶åˆ°æœ¬åœ°æ—¶ï¼Œå¦‚æœå¤±è´¥ä¼šé‡è¯• 3 æ¬¡å¹¶è®°å½•æ—¥å¿—ã€‚\nBot åœ¨ BotFather åˆ›å»ºæœºå™¨äºº æ‰“å¼€ TGï¼Œæœç´¢ BotFatherã€‚\nè¾“å…¥ /startã€‚\nè¾“å…¥ /newbot â†’ æŒ‰æç¤ºç»™æœºå™¨äººå–åå­—ï¼ˆä¾‹å¦‚ï¼šFileStorageBotï¼‰ã€‚\nBotFather ä¼šè¿”å›ä¸€ä¸ª HTTP API Tokenï¼Œç±»ä¼¼ï¼š\n1234567890:ABCdefGhIjKlmNoPQRstuVWxyZ è¿™ä¸ªå°±æ˜¯ Node.js ä»£ç é‡Œè¦ç”¨çš„ BOT_TOKENã€‚\nNode.js é¡¹ç›®åˆå§‹åŒ– åœ¨æœåŠ¡å™¨æˆ–æœ¬åœ°ç¯å¢ƒé‡Œæ‰§è¡Œï¼š\nmkdir tg-file-storage-bot cd tg-file-storage-bot npm init -y npm install node-telegram-bot-api sqlite3 node-telegram-bot-api â†’ Telegram æœºå™¨äºº SDK\nsqlite3 â†’ å­˜å‚¨æ–‡ä»¶ä¿¡æ¯ï¼ˆæ–‡ä»¶åˆ†ç±»ã€è·¯å¾„ç­‰ï¼‰\nå»º SQLite æ•°æ®åº“è¡¨ æ–°å»ºä¸€ä¸ª db.jsï¼š\nconst sqlite3 = require('sqlite3').verbose(); const db = new sqlite3.Database('./files.db'); db.serialize(() =\u003e { db.run(` CREATE TABLE IF NOT EXISTS files ( id INTEGER PRIMARY KEY AUTOINCREMENT, file_id TEXT, file_name TEXT, category TEXT, user_id TEXT, date DATETIME DEFAULT CURRENT_TIMESTAMP ) `); }); module.exports = db; bot æ–°å»º bot.jsï¼š\nconst TelegramBot = require('node-telegram-bot-api'); const db = require('./db'); const token = \"TOKEN\"; const bot = new TelegramBot(token, { polling: true }); // ä¿å­˜åˆ†ç±»ä¿¡æ¯ï¼ˆç”¨æˆ· -\u003e å½“å‰é€‰æ‹©çš„åˆ†ç±»ï¼‰ const userCategory = {}; // /start å‘½ä»¤ bot.onText(/\\/start/, (msg) =\u003e { bot.sendMessage(msg.chat.id, \"æ¬¢è¿ä½¿ç”¨æ–‡ä»¶å­˜å‚¨æœºå™¨äººï¼\\n\\nå‘½ä»¤ï¼š\\n/setcategory åˆ†ç±»å\\n/myfiles æŸ¥çœ‹æˆ‘çš„æ–‡ä»¶\"); }); // è®¾ç½®åˆ†ç±» bot.onText(/\\/setcategory (.+)/, (msg, match) =\u003e { const category = match[1]; userCategory[msg.from.id] = category; bot.sendMessage(msg.chat.id, `âœ… å·²è®¾ç½®åˆ†ç±»ä¸ºï¼š${category}\\nè¯·ç›´æ¥å‘é€æ–‡ä»¶ï¼Œæˆ‘ä¼šå¸®å­˜å‚¨ã€‚`); }); // æ¥æ”¶æ–‡ä»¶ï¼ˆæ–‡æ¡£ï¼‰ bot.on(\"document\", async (msg) =\u003e { const fileId = msg.document.file_id; const fileName = msg.document.file_name; const userId = msg.from.id; const category = userCategory[userId] || \"æœªåˆ†ç±»\"; db.run( `INSERT INTO files (file_id, file_name, category, user_id) VALUES (?, ?, ?, ?)`, [fileId, fileName, category, userId], (err) =\u003e { if (err) { console.error(err); bot.sendMessage(msg.chat.id, \"âŒ å­˜å‚¨å¤±è´¥ã€‚\"); } else { bot.sendMessage(msg.chat.id, `ğŸ“‚ æ–‡ä»¶å·²ä¿å­˜ï¼š${fileName}\\nåˆ†ç±»ï¼š${category}`); } } ); }); // æŸ¥çœ‹æ–‡ä»¶åˆ—è¡¨ bot.onText(/\\/myfiles/, (msg) =\u003e { const userId = msg.from.id; db.all( `SELECT id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT 10`, [userId], (err, rows) =\u003e { if (err) return bot.sendMessage(msg.chat.id, \"âŒ æŸ¥è¯¢å¤±è´¥ã€‚\"); if (rows.length === 0) return bot.sendMessage(msg.chat.id, \"ğŸ“­ æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶ã€‚\"); let text = \"ğŸ“‚ æœ€è¿‘çš„æ–‡ä»¶ï¼š\\n\\n\"; rows.forEach((r) =\u003e { text += `#${r.id} ${r.file_name} [${r.category}]\\n`; }); bot.sendMessage(msg.chat.id, text); } ); }); // å›å¤ /getfile id æ¥å–å›æ–‡ä»¶ bot.onText(/\\/getfile (\\d+)/, (msg, match) =\u003e { const id = match[1]; db.get(`SELECT file_id, file_name FROM files WHERE id = ?`, [id], (err, row) =\u003e { if (!row) return bot.sendMessage(msg.chat.id, \"âŒ æ–‡ä»¶ä¸å­˜åœ¨ã€‚\"); bot.sendDocument(msg.chat.id, row.file_id, {}, { filename: row.file_name }); }); }); run node bot.js ç„¶ååœ¨ TG é‡Œæ‰“å¼€æœºå™¨äººï¼š\n/setcategory å·¥ä½œèµ„æ–™ â†’ è®¾ç½®åˆ†ç±»\nä¸Šä¼ æ–‡ä»¶ï¼ˆæ–‡æ¡£ã€PDFã€Zip ç­‰ï¼‰\n/myfiles â†’ æŸ¥çœ‹è‡ªå·±å­˜çš„æ–‡ä»¶\n/getfile 1 â†’ è·å– ID=1 çš„æ–‡ä»¶\nXXX, [2025/8/26 9:37] /start mybot1, [2025/8/26 9:37] æ¬¢è¿ä½¿ç”¨æ–‡ä»¶å­˜å‚¨æœºå™¨äººï¼ å‘½ä»¤ï¼š /setcategory åˆ†ç±»å /myfiles æŸ¥çœ‹æˆ‘çš„æ–‡ä»¶ inline keyboard search æ–°å¢åˆ†ç±» æœç´¢\n//bot.js const TelegramBot = require(\"node-telegram-bot-api\"); const db = require(\"./db\"); const token = \"XXXTOKEN\"; const bot = new TelegramBot(token, { polling: true }); // ä¿å­˜åˆ†ç±»ä¿¡æ¯ï¼ˆç”¨æˆ· -\u003e å½“å‰é€‰æ‹©çš„åˆ†ç±»ï¼‰ const userCategory = {}; // é¢„è®¾åˆ†ç±» const categories = [\"å·¥ä½œ\", \"å­¦ä¹ \", \"ç”Ÿæ´»\", \"å…¶ä»–\"]; // /start å‘½ä»¤ bot.onText(/\\/start/, (msg) =\u003e { bot.sendMessage( msg.chat.id, \"æ¬¢è¿ä½¿ç”¨æ–‡ä»¶å­˜å‚¨æœºå™¨äººï¼\\n\\nå‘½ä»¤ï¼š\\n/setcategory è®¾ç½®åˆ†ç±»\\n/myfiles æŸ¥çœ‹æˆ‘çš„æ–‡ä»¶\\n/search å…³é”®å­— æœç´¢æ–‡ä»¶\\n/getfile id è·å–æ–‡ä»¶\" ); }); // /setcategory æ˜¾ç¤ºæŒ‰é’® bot.onText(/\\/setcategory/, (msg) =\u003e { const opts = { reply_markup: { inline_keyboard: categories.map((c) =\u003e [{ text: c, callback_data: `cat_${c}` }]), }, }; bot.sendMessage(msg.chat.id, \"è¯·é€‰æ‹©åˆ†ç±»ï¼š\", opts); }); // å¤„ç†æŒ‰é’®ç‚¹å‡» bot.on(\"callback_query\", (query) =\u003e { const userId = query.from.id; const chatId = query.message.chat.id; if (query.data.startsWith(\"cat_\")) { const category = query.data.replace(\"cat_\", \"\"); userCategory[userId] = category; bot.sendMessage(chatId, `âœ… å·²è®¾ç½®åˆ†ç±»ä¸ºï¼š${category}`); } bot.answerCallbackQuery(query.id); // æ”¶èµ·æŒ‰é’® loading }); // æ¥æ”¶æ–‡ä»¶ bot.on(\"document\", async (msg) =\u003e { const fileId = msg.document.file_id; const fileName = msg.document.file_name; const userId = msg.from.id; const category = userCategory[userId] || \"æœªåˆ†ç±»\"; db.run( `INSERT INTO files (file_id, file_name, category, user_id) VALUES (?, ?, ?, ?)`, [fileId, fileName, category, userId], (err) =\u003e { if (err) { console.error(err); bot.sendMessage(msg.chat.id, \"âŒ å­˜å‚¨å¤±è´¥ã€‚\"); } else { bot.sendMessage( msg.chat.id, `ğŸ“‚ æ–‡ä»¶å·²ä¿å­˜ï¼š${fileName}\\nåˆ†ç±»ï¼š${category}` ); } } ); }); // æŸ¥çœ‹æ–‡ä»¶åˆ—è¡¨ bot.onText(/\\/myfiles/, (msg) =\u003e { const userId = msg.from.id; db.all( `SELECT id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT 10`, [userId], (err, rows) =\u003e { if (err) return bot.sendMessage(msg.chat.id, \"âŒ æŸ¥è¯¢å¤±è´¥ã€‚\"); if (rows.length === 0) return bot.sendMessage(msg.chat.id, \"ğŸ“­ æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶ã€‚\"); let text = \"ğŸ“‚ æœ€è¿‘çš„æ–‡ä»¶ï¼š\\n\\n\"; rows.forEach((r) =\u003e { text += `#${r.id} ${r.file_name} [${r.category}]\\n`; }); bot.sendMessage(msg.chat.id, text); } ); }); // æœç´¢æ–‡ä»¶ bot.onText(/\\/search (.+)/, (msg, match) =\u003e { const keyword = `%${match[1]}%`; const userId = msg.from.id; db.all( `SELECT id, file_name, category FROM files WHERE user_id = ? AND file_name LIKE ? ORDER BY date DESC LIMIT 10`, [userId, keyword], (err, rows) =\u003e { if (err) return bot.sendMessage(msg.chat.id, \"âŒ æŸ¥è¯¢å¤±è´¥ã€‚\"); if (rows.length === 0) return bot.sendMessage(msg.chat.id, \"ğŸ” æ²¡æœ‰åŒ¹é…çš„æ–‡ä»¶ã€‚\"); let text = `ğŸ” æœç´¢ç»“æœï¼š\\n\\n`; rows.forEach((r) =\u003e { text += `#${r.id} ${r.file_name} [${r.category}]\\n`; }); bot.sendMessage(msg.chat.id, text); } ); }); // å›å¤ /getfile id æ¥å–å›æ–‡ä»¶ bot.onText(/\\/getfile (\\d+)/, (msg, match) =\u003e { const id = match[1]; db.get( `SELECT file_id, file_name FROM files WHERE id = ?`, [id], (err, row) =\u003e { if (!row) return bot.sendMessage(msg.chat.id, \"âŒ æ–‡ä»¶ä¸å­˜åœ¨ã€‚\"); bot.sendDocument(msg.chat.id, row.file_id, {}, { filename: row.file_name }); } ); }); XXX, [2025/8/26 9:37] /start mybot1, [2025/8/26 9:37] æ¬¢è¿ä½¿ç”¨æ–‡ä»¶å­˜å‚¨æœºå™¨äººï¼ å‘½ä»¤ï¼š /setcategory åˆ†ç±»å /myfiles æŸ¥çœ‹æˆ‘çš„æ–‡ä»¶ XXX, [2025/8/26 9:43] /start mybot1, [2025/8/26 9:43] æ¬¢è¿ä½¿ç”¨æ–‡ä»¶å­˜å‚¨æœºå™¨äººï¼ å‘½ä»¤ï¼š /setcategory è®¾ç½®åˆ†ç±» /myfiles æŸ¥çœ‹æˆ‘çš„æ–‡ä»¶ /search å…³é”®å­— æœç´¢æ–‡ä»¶ /getfile id è·å–æ–‡ä»¶ XXX, [2025/8/26 9:43] /setcategory mybot1, [2025/8/26 9:43] è¯·é€‰æ‹©åˆ†ç±»ï¼š mybot1, [2025/8/26 9:43] âœ… å·²è®¾ç½®åˆ†ç±»ä¸ºï¼šå…¶ä»– mybot1, [2025/8/26 9:45] ğŸ“‚ æ–‡ä»¶å·²ä¿å­˜ï¼šttsbot.zip åˆ†ç±»ï¼šå…¶ä»– XXX, [2025/8/26 9:46] /search tts pic video //bot.js const TelegramBot = require(\"node-telegram-bot-api\"); const db = require(\"./db\"); const token = \"XXXTOKEN\"; const bot = new TelegramBot(token, { polling: true }); // ä¿å­˜åˆ†ç±»ä¿¡æ¯ï¼ˆç”¨æˆ· -\u003e å½“å‰é€‰æ‹©çš„åˆ†ç±»ï¼‰ const userCategory = {}; // é¢„è®¾åˆ†ç±» const categories = [\"å·¥ä½œ\", \"å­¦ä¹ \", \"ç”Ÿæ´»\", \"å…¶ä»–\"]; // /start å‘½ä»¤ bot.onText(/\\/start/, (msg) =\u003e { bot.sendMessage( msg.chat.id, \"æ¬¢è¿ä½¿ç”¨æ–‡ä»¶å­˜å‚¨æœºå™¨äººï¼\\n\\nå‘½ä»¤ï¼š\\n/setcategory è®¾ç½®åˆ†ç±»\\n/myfiles æŸ¥çœ‹æ–‡ä»¶\\n/search å…³é”®å­— æœç´¢æ–‡ä»¶\\n/getfile id è·å–æ–‡ä»¶\" ); }); // /setcategory æ˜¾ç¤ºæŒ‰é’® bot.onText(/\\/setcategory/, (msg) =\u003e { const opts = { reply_markup: { inline_keyboard: categories.map((c) =\u003e [{ text: c, callback_data: `cat_${c}` }]), }, }; bot.sendMessage(msg.chat.id, \"è¯·é€‰æ‹©åˆ†ç±»ï¼š\", opts); }); // å¤„ç†æŒ‰é’®ç‚¹å‡» bot.on(\"callback_query\", (query) =\u003e { const userId = query.from.id; const chatId = query.message.chat.id; if (query.data.startsWith(\"cat_\")) { const category = query.data.replace(\"cat_\", \"\"); userCategory[userId] = category; bot.sendMessage(chatId, `âœ… å·²è®¾ç½®åˆ†ç±»ä¸ºï¼š${category}`); } bot.answerCallbackQuery(query.id); // æ”¶èµ·æŒ‰é’® loading }); // é€šç”¨ä¿å­˜å‡½æ•° function saveFile(msg, fileId, fileName, type) { const userId = msg.from.id; const chatId = msg.chat.id; const category = userCategory[userId] || \"æœªåˆ†ç±»\"; db.run( `INSERT INTO files (file_id, file_name, category, user_id) VALUES (?, ?, ?, ?)`, [fileId, fileName, category, userId], function (err) { if (err) { console.error(err); bot.sendMessage(chatId, \"âŒ å­˜å‚¨å¤±è´¥ã€‚\"); } else { bot.sendMessage( chatId, `ğŸ“¦ å·²ä¿å­˜ ${type}\\nID: ${this.lastID}\\næ–‡ä»¶å: ${fileName}\\nåˆ†ç±»: ${category}` ); } } ); } // ç›‘å¬æ–‡æ¡£ï¼ˆPDF, ZIP ç­‰ï¼‰ bot.on(\"document\", (msg) =\u003e { const fileId = msg.document.file_id; const fileName = msg.document.file_name; saveFile(msg, fileId, fileName, \"æ–‡æ¡£\"); }); // ç›‘å¬å›¾ç‰‡ï¼ˆåŒ…æ‹¬è½¬å‘çš„ï¼‰ bot.on(\"photo\", (msg) =\u003e { // photo æ˜¯æ•°ç»„ï¼Œé€‰æœ€é«˜åˆ†è¾¨ç‡çš„ const photo = msg.photo[msg.photo.length - 1]; const fileId = photo.file_id; const fileName = `photo_${Date.now()}.jpg`; saveFile(msg, fileId, fileName, \"å›¾ç‰‡\"); }); // ç›‘å¬è§†é¢‘ï¼ˆåŒ…æ‹¬è½¬å‘çš„ï¼‰ bot.on(\"video\", (msg) =\u003e { const fileId = msg.video.file_id; const fileName = msg.video.file_name || `video_${Date.now()}.mp4`; saveFile(msg, fileId, fileName, \"è§†é¢‘\"); }); // æŸ¥çœ‹æ–‡ä»¶åˆ—è¡¨ bot.onText(/\\/myfiles/, (msg) =\u003e { const userId = msg.from.id; db.all( `SELECT id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT 10`, [userId], (err, rows) =\u003e { if (err) return bot.sendMessage(msg.chat.id, \"âŒ æŸ¥è¯¢å¤±è´¥ã€‚\"); if (rows.length === 0) return bot.sendMessage(msg.chat.id, \"ğŸ“­ æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶ã€‚\"); let text = \"ğŸ“‚ æœ€è¿‘çš„æ–‡ä»¶ï¼š\\n\\n\"; rows.forEach((r) =\u003e { text += `#${r.id} ${r.file_name} [${r.category}]\\n`; }); bot.sendMessage(msg.chat.id, text); } ); }); // æœç´¢æ–‡ä»¶ bot.onText(/\\/search (.+)/, (msg, match) =\u003e { const keyword = `%${match[1]}%`; const userId = msg.from.id; db.all( `SELECT id, file_name, category FROM files WHERE user_id = ? AND file_name LIKE ? ORDER BY date DESC LIMIT 10`, [userId, keyword], (err, rows) =\u003e { if (err) return bot.sendMessage(msg.chat.id, \"âŒ æŸ¥è¯¢å¤±è´¥ã€‚\"); if (rows.length === 0) return bot.sendMessage(msg.chat.id, \"ğŸ” æ²¡æœ‰åŒ¹é…çš„æ–‡ä»¶ã€‚\"); let text = `ğŸ” æœç´¢ç»“æœï¼š\\n\\n`; rows.forEach((r) =\u003e { text += `#${r.id} ${r.file_name} [${r.category}]\\n`; }); bot.sendMessage(msg.chat.id, text); } ); }); // å›å¤ /getfile id æ¥å–å›æ–‡ä»¶ bot.onText(/\\/getfile (\\d+)/, (msg, match) =\u003e { const id = match[1]; db.get( `SELECT file_id, file_name FROM files WHERE id = ?`, [id], (err, row) =\u003e { if (!row) return bot.sendMessage(msg.chat.id, \"âŒ æ–‡ä»¶ä¸å­˜åœ¨ã€‚\"); // æ ¹æ®æ‰©å±•åç±»å‹å‘é€ä¸åŒæ¶ˆæ¯ if (row.file_name.endsWith(\".jpg\")) { bot.sendPhoto(msg.chat.id, row.file_id, { caption: row.file_name }); } else if (row.file_name.endsWith(\".mp4\")) { bot.sendVideo(msg.chat.id, row.file_id, { caption: row.file_name }); } else { bot.sendDocument(msg.chat.id, row.file_id, {}, { filename: row.file_name }); } } ); }); list const TelegramBot = require(\"node-telegram-bot-api\"); const db = require(\"./db\"); const token = \"XXXTOKEN\"; const bot = new TelegramBot(token, { polling: true }); // ä¿å­˜åˆ†ç±»ä¿¡æ¯ï¼ˆç”¨æˆ· -\u003e å½“å‰é€‰æ‹©çš„åˆ†ç±»ï¼‰ const userCategory = {}; // é¢„è®¾åˆ†ç±» const categories = [\"å·¥ä½œ\", \"å­¦ä¹ \", \"ç”Ÿæ´»\", \"å…¶ä»–\"]; // æ¯é¡µæ˜¾ç¤ºæ¡æ•° const PAGE_SIZE = 5; // /start å‘½ä»¤ bot.onText(/\\/start/, (msg) =\u003e { bot.sendMessage( msg.chat.id, \"æ¬¢è¿ä½¿ç”¨æ–‡ä»¶å­˜å‚¨æœºå™¨äººï¼\\n\\nå‘½ä»¤ï¼š\\n\" + \"/setcategory è®¾ç½®åˆ†ç±»\\n\" + \"/myfiles æŸ¥çœ‹æœ€è¿‘æ–‡ä»¶(æ–‡å­—åˆ—è¡¨)\\n\" + \"/myfilelist [é¡µç ] æ–‡ä»¶é¢„è§ˆåˆ†é¡µ\\n\" + \"/search å…³é”®å­— æœç´¢æ–‡ä»¶\\n\" + \"/getfile id è·å–æ–‡ä»¶\" ); }); // /setcategory æ˜¾ç¤ºæŒ‰é’® bot.onText(/\\/setcategory/, (msg) =\u003e { const opts = { reply_markup: { inline_keyboard: categories.map((c) =\u003e [{ text: c, callback_data: `cat_${c}` }]), }, }; bot.sendMessage(msg.chat.id, \"è¯·é€‰æ‹©åˆ†ç±»ï¼š\", opts); }); // å¤„ç†æŒ‰é’®ç‚¹å‡» bot.on(\"callback_query\", (query) =\u003e { const userId = query.from.id; const chatId = query.message.chat.id; if (query.data.startsWith(\"cat_\")) { const category = query.data.replace(\"cat_\", \"\"); userCategory[userId] = category; bot.sendMessage(chatId, `âœ… å·²è®¾ç½®åˆ†ç±»ä¸ºï¼š${category}`); } bot.answerCallbackQuery(query.id); // æ”¶èµ·æŒ‰é’® loading }); // é€šç”¨ä¿å­˜å‡½æ•° function saveFile(msg, fileId, fileName, type) { const userId = msg.from.id; const chatId = msg.chat.id; const category = userCategory[userId] || \"æœªåˆ†ç±»\"; db.run( `INSERT INTO files (file_id, file_name, category, user_id) VALUES (?, ?, ?, ?)`, [fileId, fileName, category, userId], function (err) { if (err) { console.error(err); bot.sendMessage(chatId, \"âŒ å­˜å‚¨å¤±è´¥ã€‚\"); } else { bot.sendMessage( chatId, `ğŸ“¦ å·²ä¿å­˜ ${type}\\nID: ${this.lastID}\\næ–‡ä»¶å: ${fileName}\\nåˆ†ç±»: ${category}` ); } } ); } // ç›‘å¬æ–‡æ¡£ bot.on(\"document\", (msg) =\u003e { const fileId = msg.document.file_id; const fileName = msg.document.file_name; saveFile(msg, fileId, fileName, \"æ–‡æ¡£\"); }); // ç›‘å¬å›¾ç‰‡ bot.on(\"photo\", (msg) =\u003e { const photo = msg.photo[msg.photo.length - 1]; const fileId = photo.file_id; const fileName = `photo_${Date.now()}.jpg`; saveFile(msg, fileId, fileName, \"å›¾ç‰‡\"); }); // ç›‘å¬è§†é¢‘ bot.on(\"video\", (msg) =\u003e { const fileId = msg.video.file_id; const fileName = msg.video.file_name || `video_${Date.now()}.mp4`; saveFile(msg, fileId, fileName, \"è§†é¢‘\"); }); // /myfiles æ–‡æœ¬åˆ—è¡¨ bot.onText(/\\/myfiles/, (msg) =\u003e { const userId = msg.from.id; db.all( `SELECT id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT 10`, [userId], (err, rows) =\u003e { if (err) return bot.sendMessage(msg.chat.id, \"âŒ æŸ¥è¯¢å¤±è´¥ã€‚\"); if (rows.length === 0) return bot.sendMessage(msg.chat.id, \"ğŸ“­ æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶ã€‚\"); let text = \"ğŸ“‚ æœ€è¿‘çš„æ–‡ä»¶ï¼š\\n\\n\"; rows.forEach((r) =\u003e { text += `#${r.id} ${r.file_name} [${r.category}]\\n`; }); bot.sendMessage(msg.chat.id, text); } ); }); // /myfilelist [é¡µç ] æ–‡ä»¶é¢„è§ˆåˆ†é¡µ bot.onText(/\\/myfilelist ?(\\d+)?/, (msg, match) =\u003e { const userId = msg.from.id; const page = parseInt(match[1]) || 1; const offset = (page - 1) * PAGE_SIZE; db.all( `SELECT id, file_id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT ? OFFSET ?`, [userId, PAGE_SIZE, offset], async (err, rows) =\u003e { if (err) return bot.sendMessage(msg.chat.id, \"âŒ æŸ¥è¯¢å¤±è´¥ã€‚\"); if (rows.length === 0) return bot.sendMessage(msg.chat.id, \"ğŸ“­ æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶ã€‚\"); bot.sendMessage(msg.chat.id, `ğŸ“‘ ç¬¬ ${page} é¡µï¼ˆæ¯é¡µ ${PAGE_SIZE} æ¡ï¼‰`); for (const r of rows) { const caption = `#${r.id} ${r.file_name}\\nåˆ†ç±»ï¼š${r.category}`; if (r.file_name.endsWith(\".jpg\")) { await bot.sendPhoto(msg.chat.id, r.file_id, { caption }); } else if (r.file_name.endsWith(\".mp4\")) { await bot.sendVideo(msg.chat.id, r.file_id, { caption }); } else { await bot.sendDocument(msg.chat.id, r.file_id, {}, { filename: r.file_name }); await bot.sendMessage(msg.chat.id, caption); } } } ); }); // /search å…³é”®å­— bot.onText(/\\/search (.+)/, (msg, match) =\u003e { const keyword = `%${match[1]}%`; const userId = msg.from.id; db.all( `SELECT id, file_name, category FROM files WHERE user_id = ? AND file_name LIKE ? ORDER BY date DESC LIMIT 10`, [userId, keyword], (err, rows) =\u003e { if (err) return bot.sendMessage(msg.chat.id, \"âŒ æŸ¥è¯¢å¤±è´¥ã€‚\"); if (rows.length === 0) return bot.sendMessage(msg.chat.id, \"ğŸ” æ²¡æœ‰åŒ¹é…çš„æ–‡ä»¶ã€‚\"); let text = `ğŸ” æœç´¢ç»“æœï¼š\\n\\n`; rows.forEach((r) =\u003e { text += `#${r.id} ${r.file_name} [${r.category}]\\n`; }); bot.sendMessage(msg.chat.id, text); } ); }); // /getfile id bot.onText(/\\/getfile (\\d+)/, (msg, match) =\u003e { const id = match[1]; db.get( `SELECT file_id, file_name FROM files WHERE id = ?`, [id], (err, row) =\u003e { if (!row) return bot.sendMessage(msg.chat.id, \"âŒ æ–‡ä»¶ä¸å­˜åœ¨ã€‚\"); if (row.file_name.endsWith(\".jpg\")) { bot.sendPhoto(msg.chat.id, row.file_id, { caption: row.file_name }); } else if (row.file_name.endsWith(\".mp4\")) { bot.sendVideo(msg.chat.id, row.file_id, { caption: row.file_name }); } else { bot.sendDocument(msg.chat.id, row.file_id, {}, { filename: row.file_name }); } } ); }); del //bot const TelegramBot = require(\"node-telegram-bot-api\"); const db = require(\"./db\"); const token = \"XXXTOKEN\"; const bot = new TelegramBot(token, { polling: true }); // ä¿å­˜åˆ†ç±»ä¿¡æ¯ï¼ˆç”¨æˆ· -\u003e å½“å‰é€‰æ‹©çš„åˆ†ç±»ï¼‰ const userCategory = {}; // é¢„è®¾åˆ†ç±» const categories = [\"å·¥ä½œ\", \"å­¦ä¹ \", \"ç”Ÿæ´»\", \"å…¶ä»–\"]; // æ¯é¡µæ˜¾ç¤ºæ¡æ•° const PAGE_SIZE = 5; // /start å‘½ä»¤ bot.onText(/\\/start/, (msg) =\u003e { bot.sendMessage( msg.chat.id, \"æ¬¢è¿ä½¿ç”¨æ–‡ä»¶å­˜å‚¨æœºå™¨äººï¼\\n\\nå‘½ä»¤ï¼š\\n\" + \"/setcategory è®¾ç½®åˆ†ç±»\\n\" + \"/myfiles æŸ¥çœ‹æœ€è¿‘æ–‡ä»¶(æ–‡å­—åˆ—è¡¨)\\n\" + \"/myfilelist [é¡µç ] æ–‡ä»¶é¢„è§ˆåˆ†é¡µ\\n\" + \"/search å…³é”®å­— æœç´¢æ–‡ä»¶\\n\" + \"/getfile id è·å–æ–‡ä»¶\\n\" + \"/delete id åˆ é™¤æ–‡ä»¶\" ); }); // /setcategory æ˜¾ç¤ºæŒ‰é’® bot.onText(/\\/setcategory/, (msg) =\u003e { const opts = { reply_markup: { inline_keyboard: categories.map((c) =\u003e [{ text: c, callback_data: `cat_${c}` }]), }, }; bot.sendMessage(msg.chat.id, \"è¯·é€‰æ‹©åˆ†ç±»ï¼š\", opts); }); // é€šç”¨ä¿å­˜å‡½æ•° function saveFile(msg, fileId, fileName, type) { const userId = msg.from.id; const chatId = msg.chat.id; const category = userCategory[userId] || \"æœªåˆ†ç±»\"; db.run( `INSERT INTO files (file_id, file_name, category, user_id) VALUES (?, ?, ?, ?)`, [fileId, fileName, category, userId], function (err) { if (err) { console.error(err); bot.sendMessage(chatId, \"âŒ å­˜å‚¨å¤±è´¥ã€‚\"); } else { bot.sendMessage( chatId, `ğŸ“¦ å·²ä¿å­˜ ${type}\\nID: ${this.lastID}\\næ–‡ä»¶å: ${fileName}\\nåˆ†ç±»: ${category}` ); } } ); } // ç›‘å¬æ–‡æ¡£ bot.on(\"document\", (msg) =\u003e { const fileId = msg.document.file_id; const fileName = msg.document.file_name; saveFile(msg, fileId, fileName, \"æ–‡æ¡£\"); }); // ç›‘å¬å›¾ç‰‡ bot.on(\"photo\", (msg) =\u003e { const photo = msg.photo[msg.photo.length - 1]; const fileId = photo.file_id; const fileName = `photo_${Date.now()}.jpg`; saveFile(msg, fileId, fileName, \"å›¾ç‰‡\"); }); // ç›‘å¬è§†é¢‘ bot.on(\"video\", (msg) =\u003e { const fileId = msg.video.file_id; const fileName = msg.video.file_name || `video_${Date.now()}.mp4`; saveFile(msg, fileId, fileName, \"è§†é¢‘\"); }); // /myfiles æ–‡æœ¬åˆ—è¡¨ bot.onText(/\\/myfiles/, (msg) =\u003e { const userId = msg.from.id; db.all( `SELECT id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT 10`, [userId], (err, rows) =\u003e { if (err) return bot.sendMessage(msg.chat.id, \"âŒ æŸ¥è¯¢å¤±è´¥ã€‚\"); if (rows.length === 0) return bot.sendMessage(msg.chat.id, \"ğŸ“­ æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶ã€‚\"); let text = \"ğŸ“‚ æœ€è¿‘çš„æ–‡ä»¶ï¼š\\n\\n\"; rows.forEach((r) =\u003e { text += `#${r.id} ${r.file_name} [${r.category}]\\n`; }); bot.sendMessage(msg.chat.id, text); } ); }); // /myfilelist [é¡µç ] æ–‡ä»¶é¢„è§ˆåˆ†é¡µ bot.onText(/\\/myfilelist ?(\\d+)?/, (msg, match) =\u003e { const userId = msg.from.id; const page = parseInt(match[1]) || 1; const offset = (page - 1) * PAGE_SIZE; db.all( `SELECT id, file_id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT ? OFFSET ?`, [userId, PAGE_SIZE, offset], async (err, rows) =\u003e { if (err) return bot.sendMessage(msg.chat.id, \"âŒ æŸ¥è¯¢å¤±è´¥ã€‚\"); if (rows.length === 0) return bot.sendMessage(msg.chat.id, \"ğŸ“­ æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶ã€‚\"); bot.sendMessage(msg.chat.id, `ğŸ“‘ ç¬¬ ${page} é¡µï¼ˆæ¯é¡µ ${PAGE_SIZE} æ¡ï¼‰`); for (const r of rows) { const caption = `#${r.id} ${r.file_name}\\nåˆ†ç±»ï¼š${r.category}`; const opts = { reply_markup: { inline_keyboard: [[{ text: \"âŒ åˆ é™¤\", callback_data: `del_${r.id}` }]], }, }; if (r.file_name.endsWith(\".jpg\")) { await bot.sendPhoto(msg.chat.id, r.file_id, { caption, ...opts }); } else if (r.file_name.endsWith(\".mp4\")) { await bot.sendVideo(msg.chat.id, r.file_id, { caption, ...opts }); } else { await bot.sendDocument(msg.chat.id, r.file_id, {}, { filename: r.file_name }); await bot.sendMessage(msg.chat.id, caption, opts); } } } ); }); // /search å…³é”®å­— bot.onText(/\\/search (.+)/, (msg, match) =\u003e { const keyword = `%${match[1]}%`; const userId = msg.from.id; db.all( `SELECT id, file_name, category FROM files WHERE user_id = ? AND file_name LIKE ? ORDER BY date DESC LIMIT 10`, [userId, keyword], (err, rows) =\u003e { if (err) return bot.sendMessage(msg.chat.id, \"âŒ æŸ¥è¯¢å¤±è´¥ã€‚\"); if (rows.length === 0) return bot.sendMessage(msg.chat.id, \"ğŸ” æ²¡æœ‰åŒ¹é…çš„æ–‡ä»¶ã€‚\"); let text = `ğŸ” æœç´¢ç»“æœï¼š\\n\\n`; rows.forEach((r) =\u003e { text += `#${r.id} ${r.file_name} [${r.category}]\\n`; }); bot.sendMessage(msg.chat.id, text); } ); }); // /getfile id bot.onText(/\\/getfile (\\d+)/, (msg, match) =\u003e { const id = match[1]; db.get( `SELECT file_id, file_name FROM files WHERE id = ?`, [id], (err, row) =\u003e { if (!row) return bot.sendMessage(msg.chat.id, \"âŒ æ–‡ä»¶ä¸å­˜åœ¨ã€‚\"); if (row.file_name.endsWith(\".jpg\")) { bot.sendPhoto(msg.chat.id, row.file_id, { caption: row.file_name }); } else if (row.file_name.endsWith(\".mp4\")) { bot.sendVideo(msg.chat.id, row.file_id, { caption: row.file_name }); } else { bot.sendDocument(msg.chat.id, row.file_id, {}, { filename: row.file_name }); } } ); }); // /delete id å‘½ä»¤åˆ é™¤ bot.onText(/\\/delete (\\d+)/, (msg, match) =\u003e { const id = match[1]; const userId = msg.from.id; db.run(`DELETE FROM files WHERE id = ? AND user_id = ?`, [id, userId], function (err) { if (err) { console.error(err); return bot.sendMessage(msg.chat.id, \"âŒ åˆ é™¤å¤±è´¥ã€‚\"); } if (this.changes === 0) { bot.sendMessage(msg.chat.id, \"âš ï¸ æ²¡æ‰¾åˆ°è¯¥æ–‡ä»¶æˆ–æ— æƒé™åˆ é™¤ã€‚\"); } else { bot.sendMessage(msg.chat.id, `âœ… æ–‡ä»¶(ID=${id}) å·²åˆ é™¤ã€‚`); } }); }); // callback_query ç»Ÿä¸€å¤„ç† bot.on(\"callback_query\", (query) =\u003e { const userId = query.from.id; const chatId = query.message.chat.id; // åˆ†ç±»æŒ‰é’® if (query.data.startsWith(\"cat_\")) { const category = query.data.replace(\"cat_\", \"\"); userCategory[userId] = category; bot.sendMessage(chatId, `âœ… å·²è®¾ç½®åˆ†ç±»ä¸ºï¼š${category}`); } // åˆ é™¤æŒ‰é’®ï¼ˆç¬¬ä¸€æ­¥ï¼šå¼¹å‡ºç¡®è®¤ï¼‰ if (query.data.startsWith(\"del_\")) { const fileId = query.data.replace(\"del_\", \"\"); const confirmOpts = { reply_markup: { inline_keyboard: [ [ { text: \"âœ… ç¡®è®¤åˆ é™¤\", callback_data: `confirmdel_${fileId}` }, { text: \"âŒ å–æ¶ˆ\", callback_data: `cancel_${fileId}` }, ], ], }, }; bot.sendMessage(chatId, `âš ï¸ ç¡®è®¤è¦åˆ é™¤æ–‡ä»¶(ID=${fileId})å—ï¼Ÿ`, confirmOpts); } // ç¡®è®¤åˆ é™¤ï¼ˆç¬¬äºŒæ­¥ï¼‰ if (query.data.startsWith(\"confirmdel_\")) { const fileId = query.data.replace(\"confirmdel_\", \"\"); db.run( `DELETE FROM files WHERE id = ? AND user_id = ?`, [fileId, userId], function (err) { if (err) { console.error(err); return bot.sendMessage(chatId, \"âŒ åˆ é™¤å¤±è´¥ã€‚\"); } if (this.changes === 0) { bot.sendMessage(chatId, \"âš ï¸ æ²¡æ‰¾åˆ°è¯¥æ–‡ä»¶æˆ–æ— æƒé™åˆ é™¤ã€‚\"); } else { bot.sendMessage(chatId, `âœ… æ–‡ä»¶(ID=${fileId}) å·²åˆ é™¤ã€‚`); } } ); } // å–æ¶ˆåˆ é™¤ if (query.data.startsWith(\"cancel_\")) { const fileId = query.data.replace(\"cancel_\", \"\"); bot.sendMessage(chatId, `â å·²å–æ¶ˆåˆ é™¤æ–‡ä»¶(ID=${fileId})ã€‚`); } bot.answerCallbackQuery(query.id); }); Loacl DownloadFile const TelegramBot = require(\"node-telegram-bot-api\"); const db = require(\"./db\"); const fs = require(\"fs\"); const path = require(\"path\"); const axios = require(\"axios\"); const token = \"TKTKg\"; const bot = new TelegramBot(token, { polling: true }); // ä¿å­˜åˆ†ç±»ä¿¡æ¯ï¼ˆç”¨æˆ· -\u003e å½“å‰é€‰æ‹©çš„åˆ†ç±»ï¼‰ const userCategory = {}; // é¢„è®¾åˆ†ç±» const categories = [\"work\", \"study\", \"life\", \"other\",\"yo\",\"yo2\"]; // æ¯é¡µæ˜¾ç¤ºæ¡æ•° const PAGE_SIZE = 5; // æœ¬åœ°å­˜å‚¨æ ¹ç›®å½• const STORAGE_DIR = path.join(__dirname, \"files\"); if (!fs.existsSync(STORAGE_DIR)) fs.mkdirSync(STORAGE_DIR); // /start å‘½ä»¤ bot.onText(/\\/start/, (msg) =\u003e { bot.sendMessage( msg.chat.id, \"æ¬¢è¿ä½¿ç”¨æ–‡ä»¶å­˜å‚¨æœºå™¨äººï¼\\n\\nå‘½ä»¤ï¼š\\n\" + \"/setcategory è®¾ç½®åˆ†ç±»\\n\" + \"/myfiles æŸ¥çœ‹æœ€è¿‘æ–‡ä»¶(æ–‡å­—åˆ—è¡¨)\\n\" + \"/myfilelist [é¡µç ] æ–‡ä»¶é¢„è§ˆåˆ†é¡µ\\n\" + \"/search å…³é”®å­— æœç´¢æ–‡ä»¶\\n\" + \"/getfile id è·å–æ–‡ä»¶\\n\" + \"/delete id åˆ é™¤æ–‡ä»¶\\n\" + \"ğŸ“¥ ç‚¹å‡»æ–‡ä»¶åçš„â€œä¸‹è½½æœ¬åœ°â€æŒ‰é’®å¯ä¿å­˜åˆ°æœåŠ¡å™¨æœ¬åœ°\" ); }); // /setcategory æ˜¾ç¤ºæŒ‰é’® bot.onText(/\\/setcategory/, (msg) =\u003e { const opts = { reply_markup: { inline_keyboard: categories.map((c) =\u003e [{ text: c, callback_data: `cat_${c}` }]), }, }; bot.sendMessage(msg.chat.id, \"è¯·é€‰æ‹©åˆ†ç±»ï¼š\", opts); }); // é€šç”¨ä¿å­˜å‡½æ•° function saveFile(msg, fileId, fileName, type) { const userId = msg.from.id; const chatId = msg.chat.id; const category = userCategory[userId] || \"æœªåˆ†ç±»\"; db.run( `INSERT INTO files (file_id, file_name, category, user_id) VALUES (?, ?, ?, ?)`, [fileId, fileName, category, userId], function (err) { if (err) { console.error(err); bot.sendMessage(chatId, \"âŒ å­˜å‚¨å¤±è´¥ã€‚\"); } else { bot.sendMessage( chatId, `ğŸ“¦ å·²ä¿å­˜ ${type}\\nID: ${this.lastID}\\næ–‡ä»¶å: ${fileName}\\nåˆ†ç±»: ${category}` ); } } ); } // ä¸‹è½½æ–‡ä»¶åˆ°æœ¬åœ° async function downloadFile(fileId, fileName, category) { try { const url = await bot.getFileLink(fileId); const dir = path.join(STORAGE_DIR, category); if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true }); const filePath = path.join(dir, fileName); const writer = fs.createWriteStream(filePath); const response = await axios({ url, method: 'GET', responseType: 'stream' }); response.data.pipe(writer); return new Promise((resolve, reject) =\u003e { writer.on('finish', () =\u003e resolve(filePath)); writer.on('error', reject); }); } catch (err) { console.error(\"ä¸‹è½½æ–‡ä»¶å¤±è´¥:\", err); throw err; } } // ç»Ÿä¸€å¤„ç†æ¶ˆæ¯ï¼ˆæ™®é€šæ¶ˆæ¯å’Œè½¬å‘æ¶ˆæ¯ï¼‰ bot.on(\"message\", (msg) =\u003e { const hasFile = msg.document || msg.photo || msg.video; const isForward = msg.forward_from || msg.forward_from_chat; if (!hasFile) return; const typePrefix = isForward ? \"è½¬å‘\" : \"\"; // æ–‡æ¡£ if (msg.document) { saveFile(msg, msg.document.file_id, msg.document.file_name, `${typePrefix}æ–‡æ¡£`); } // å›¾ç‰‡ if (msg.photo) { const photo = msg.photo[msg.photo.length - 1]; const fileName = `photo_${Date.now()}.jpg`; saveFile(msg, photo.file_id, fileName, `${typePrefix}å›¾ç‰‡`); } // è§†é¢‘ if (msg.video) { const fileName = msg.video.file_name || `video_${Date.now()}.mp4`; saveFile(msg, msg.video.file_id, fileName, `${typePrefix}è§†é¢‘`); } }); // /myfiles æ–‡æœ¬åˆ—è¡¨ bot.onText(/\\/myfiles/, (msg) =\u003e { const userId = msg.from.id; db.all( `SELECT id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT 10`, [userId], (err, rows) =\u003e { if (err) return bot.sendMessage(msg.chat.id, \"âŒ æŸ¥è¯¢å¤±è´¥ã€‚\"); if (rows.length === 0) return bot.sendMessage(msg.chat.id, \"ğŸ“­ æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶ã€‚\"); let text = \"ğŸ“‚ æœ€è¿‘çš„æ–‡ä»¶ï¼š\\n\\n\"; rows.forEach((r) =\u003e { text += `#${r.id} ${r.file_name} [${r.category}]\\n`; }); bot.sendMessage(msg.chat.id, text); } ); }); // /myfilelist åˆ†é¡µæ˜¾ç¤º async function sendFilePage(chatId, userId, page = 1, messageId = null) { const offset = (page - 1) * PAGE_SIZE; db.all( `SELECT id, file_id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT ? OFFSET ?`, [userId, PAGE_SIZE, offset], async (err, rows) =\u003e { if (err) return bot.sendMessage(chatId, \"âŒ æŸ¥è¯¢å¤±è´¥ã€‚\"); if (rows.length === 0) return bot.sendMessage(chatId, \"ğŸ“­ æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶ã€‚\"); if (messageId) { await bot.editMessageText(`ğŸ“‘ ç¬¬ ${page} é¡µï¼ˆæ¯é¡µ ${PAGE_SIZE} æ¡ï¼‰`, { chat_id: chatId, message_id: messageId, }); } else { await bot.sendMessage(chatId, `ğŸ“‘ ç¬¬ ${page} é¡µï¼ˆæ¯é¡µ ${PAGE_SIZE} æ¡ï¼‰`); } for (const r of rows) { const caption = `#${r.id} ${r.file_name}\\nåˆ†ç±»ï¼š${r.category}`; const opts = { reply_markup: { inline_keyboard: [ [{ text: \"âŒ åˆ é™¤\", callback_data: `del_${r.id}` }], [{ text: \"â¬‡ï¸ ä¸‹è½½æœ¬åœ°\", callback_data: `download_${r.id}` }], ], }, }; if (r.file_name.endsWith(\".jpg\")) { await bot.sendPhoto(chatId, r.file_id, { caption, ...opts }); } else if (r.file_name.endsWith(\".mp4\")) { await bot.sendVideo(chatId, r.file_id, { caption, ...opts }); } else { await bot.sendDocument(chatId, r.file_id, {}, { filename: r.file_name }); await bot.sendMessage(chatId, caption, opts); } } // ç¿»é¡µæŒ‰é’® const totalCountRow = await new Promise((resolve) =\u003e db.get(`SELECT COUNT(*) as cnt FROM files WHERE user_id = ?`, [userId], (err, row) =\u003e resolve(row)) ); const totalPages = Math.ceil(totalCountRow.cnt / PAGE_SIZE); const navOpts = { reply_markup: { inline_keyboard: [ [ { text: \"â¬…ï¸ ä¸Šä¸€é¡µ\", callback_data: `page_${page - 1}` }, { text: \"â¡ï¸ ä¸‹ä¸€é¡µ\", callback_data: `page_${page + 1}` }, ], ], }, }; await bot.sendMessage(chatId, `åˆ†é¡µå¯¼èˆªï¼šç¬¬ ${page}/${totalPages} é¡µ`, navOpts); } ); } bot.onText(/\\/myfilelist ?(\\d+)?/, (msg, match) =\u003e { const page = parseInt(match[1]) || 1; sendFilePage(msg.chat.id, msg.from.id, page); }); // /search å…³é”®å­— bot.onText(/\\/search (.+)/, (msg, match) =\u003e { const keyword = `%${match[1]}%`; const userId = msg.from.id; db.all( `SELECT id, file_name, category FROM files WHERE user_id = ? AND file_name LIKE ? ORDER BY date DESC LIMIT 10`, [userId, keyword], (err, rows) =\u003e { if (err) return bot.sendMessage(msg.chat.id, \"âŒ æŸ¥è¯¢å¤±è´¥ã€‚\"); if (rows.length === 0) return bot.sendMessage(msg.chat.id, \"ğŸ” æ²¡æœ‰åŒ¹é…çš„æ–‡ä»¶ã€‚\"); let text = `ğŸ” æœç´¢ç»“æœï¼š\\n\\n`; rows.forEach((r) =\u003e { text += `#${r.id} ${r.file_name} [${r.category}]\\n`; }); bot.sendMessage(msg.chat.id, text); } ); }); // /getfile id bot.onText(/\\/getfile (\\d+)/, (msg, match) =\u003e { const id = match[1]; db.get(`SELECT file_id, file_name FROM files WHERE id = ?`, [id], (err, row) =\u003e { if (!row) return bot.sendMessage(msg.chat.id, \"âŒ æ–‡ä»¶ä¸å­˜åœ¨ã€‚\"); if (row.file_name.endsWith(\".jpg\")) { bot.sendPhoto(msg.chat.id, row.file_id, { caption: row.file_name }); } else if (row.file_name.endsWith(\".mp4\")) { bot.sendVideo(msg.chat.id, row.file_id, { caption: row.file_name }); } else { bot.sendDocument(msg.chat.id, row.file_id, {}, { filename: row.file_name }); } }); }); // /delete id bot.onText(/\\/delete (\\d+)/, (msg, match) =\u003e { const id = match[1]; const userId = msg.from.id; db.run(`DELETE FROM files WHERE id = ? AND user_id = ?`, [id, userId], function (err) { if (err) return bot.sendMessage(msg.chat.id, \"âŒ åˆ é™¤å¤±è´¥ã€‚\"); if (this.changes === 0) return bot.sendMessage(msg.chat.id, \"âš ï¸ æ²¡æ‰¾åˆ°è¯¥æ–‡ä»¶æˆ–æ— æƒé™åˆ é™¤ã€‚\"); bot.sendMessage(msg.chat.id, `âœ… æ–‡ä»¶(ID=${id}) å·²åˆ é™¤ã€‚`); }); }); // callback_query ç»Ÿä¸€å¤„ç† bot.on(\"callback_query\", async (query) =\u003e { const userId = query.from.id; const chatId = query.message.chat.id; // åˆ†ç±»æŒ‰é’® if (query.data.startsWith(\"cat_\")) { const category = query.data.replace(\"cat_\", \"\"); userCategory[userId] = category; bot.sendMessage(chatId, `âœ… å·²è®¾ç½®åˆ†ç±»ä¸ºï¼š${category}`); } // åˆ é™¤æŒ‰é’® if (query.data.startsWith(\"del_\")) { const fileId = query.data.replace(\"del_\", \"\"); const confirmOpts = { reply_markup: { inline_keyboard: [ [ { text: \"âœ… ç¡®è®¤åˆ é™¤\", callback_data: `confirmdel_${fileId}` }, { text: \"âŒ å–æ¶ˆ\", callback_data: `cancel_${fileId}` }, ], ], }, }; bot.sendMessage(chatId, `âš ï¸ ç¡®è®¤è¦åˆ é™¤æ–‡ä»¶(ID=${fileId})å—ï¼Ÿ`, confirmOpts); } // ç¡®è®¤åˆ é™¤ if (query.data.startsWith(\"confirmdel_\")) { const fileId = query.data.replace(\"confirmdel_\", \"\"); db.run(`DELETE FROM files WHERE id = ? AND user_id = ?`, [fileId, userId], function (err) { if (err) return bot.sendMessage(chatId, \"âŒ åˆ é™¤å¤±è´¥ã€‚\"); if (this.changes === 0) return bot.sendMessage(chatId, \"âš ï¸ æ²¡æ‰¾åˆ°è¯¥æ–‡ä»¶æˆ–æ— æƒé™åˆ é™¤ã€‚\"); bot.sendMessage(chatId, `âœ… æ–‡ä»¶(ID=${fileId}) å·²åˆ é™¤ã€‚`); }); } // å–æ¶ˆåˆ é™¤ if (query.data.startsWith(\"cancel_\")) { const fileId = query.data.replace(\"cancel_\", \"\"); bot.sendMessage(chatId, `â å·²å–æ¶ˆåˆ é™¤æ–‡ä»¶(ID=${fileId})ã€‚`); } // åˆ†é¡µæŒ‰é’® if (query.data.startsWith(\"page_\")) { const page = parseInt(query.data.replace(\"page_\", \"\")); if (page \u003c 1) return bot.answerCallbackQuery(query.id, { text: \"å·²ç»æ˜¯ç¬¬ä¸€é¡µ\" }); sendFilePage(chatId, userId, page, query.message.message_id); } // ä¸‹è½½åˆ°æœ¬åœ°æŒ‰é’® if (query.data.startsWith(\"download_\")) { const id = query.data.replace(\"download_\", \"\"); db.get(`SELECT file_id, file_name, category FROM files WHERE id = ? AND user_id = ?`, [id, userId], async (err, row) =\u003e { if (!row) return bot.sendMessage(chatId, \"âŒ æ–‡ä»¶ä¸å­˜åœ¨æˆ–æ— æƒé™ä¸‹è½½ã€‚\"); try { const filePath = await downloadFile(row.file_id, row.file_name, row.category); bot.sendMessage(chatId, `âœ… æ–‡ä»¶å·²ä¸‹è½½åˆ°æœåŠ¡å™¨æœ¬åœ°ï¼š${filePath}`); } catch { bot.sendMessage(chatId, \"âŒ ä¸‹è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚\"); } }); } bot.answerCallbackQuery(query.id); }); Mv const TelegramBot = require(\"node-telegram-bot-api\"); const db = require(\"./db\"); const fs = require(\"fs\"); const path = require(\"path\"); const axios = require(\"axios\"); const token = \"TKTK\"; const bot = new TelegramBot(token, { polling: true }); // ä¿å­˜åˆ†ç±»ä¿¡æ¯ï¼ˆç”¨æˆ· -\u003e å½“å‰é€‰æ‹©çš„åˆ†ç±»ï¼‰ const userCategory = {}; // é¢„è®¾åˆ†ç±» const categories = [\"work\", \"study\", \"life\", \"other\",\"yo\",\"yo2\"]; // æ¯é¡µæ˜¾ç¤ºæ¡æ•° const PAGE_SIZE = 5; // æœ¬åœ°å­˜å‚¨æ ¹ç›®å½• const STORAGE_DIR = path.join(__dirname, \"files\"); if (!fs.existsSync(STORAGE_DIR)) fs.mkdirSync(STORAGE_DIR); // /start å‘½ä»¤ bot.onText(/\\/start/, (msg) =\u003e { bot.sendMessage( msg.chat.id, \"æ¬¢è¿ä½¿ç”¨æ–‡ä»¶å­˜å‚¨æœºå™¨äººï¼\\n\\nå‘½ä»¤ï¼š\\n\" + \"/setcategory è®¾ç½®åˆ†ç±»\\n\" + \"/myfiles æŸ¥çœ‹æœ€è¿‘æ–‡ä»¶(æ–‡å­—åˆ—è¡¨)\\n\" + \"/myfilelist [é¡µç ] æ–‡ä»¶åˆ†é¡µæ˜¾ç¤º\\n\" + \"/search å…³é”®å­— æœç´¢æ–‡ä»¶\\n\" + \"/getfile id è·å–æ–‡ä»¶\\n\" + \"/delete id åˆ é™¤æ–‡ä»¶\\n\" + \"ğŸ“¥ ç‚¹å‡»æ–‡ä»¶åçš„â€œä¸‹è½½æœ¬åœ°â€æŒ‰é’®å¯ä¿å­˜åˆ°æœåŠ¡å™¨æœ¬åœ°\" ); }); // /setcategory æ˜¾ç¤ºæŒ‰é’® bot.onText(/\\/setcategory/, (msg) =\u003e { const opts = { reply_markup: { inline_keyboard: categories.map((c) =\u003e [{ text: c, callback_data: `cat_${c}` }]), }, }; bot.sendMessage(msg.chat.id, \"è¯·é€‰æ‹©åˆ†ç±»ï¼š\", opts); }); // é€šç”¨ä¿å­˜å‡½æ•° function saveFile(msg, fileId, fileName, type) { const userId = msg.from.id; const chatId = msg.chat.id; const category = userCategory[userId] || \"æœªåˆ†ç±»\"; db.run( `INSERT INTO files (file_id, file_name, category, user_id) VALUES (?, ?, ?, ?)`, [fileId, fileName, category, userId], function (err) { if (err) { console.error(err); bot.sendMessage(chatId, \"âŒ å­˜å‚¨å¤±è´¥ã€‚\"); } else { bot.sendMessage( chatId, `ğŸ“¦ å·²ä¿å­˜ ${type}\\nID: ${this.lastID}\\næ–‡ä»¶å: ${fileName}\\nåˆ†ç±»: ${category}` ); } } ); } // ä¸‹è½½æ–‡ä»¶åˆ°æœ¬åœ°ï¼ˆå¸¦é‡è¯•å’Œæ—¥å¿—ï¼‰ async function downloadFile(fileId, fileName, category, retries = 3) { const dir = path.join(STORAGE_DIR, category); if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true }); const filePath = path.join(dir, fileName); for (let attempt = 1; attempt \u003c= retries; attempt++) { try { console.log(`ä¸‹è½½æ–‡ä»¶å°è¯• ${attempt}/${retries}ï¼š${fileName}`); const url = await bot.getFileLink(fileId); // è·å–æ–‡ä»¶é“¾æ¥ const writer = fs.createWriteStream(filePath); const response = await axios({ url, method: 'GET', responseType: 'stream', timeout: 30000 // 30ç§’è¶…æ—¶ }); response.data.pipe(writer); await new Promise((resolve, reject) =\u003e { writer.on('finish', resolve); writer.on('error', reject); }); console.log(`âœ… æ–‡ä»¶ä¸‹è½½æˆåŠŸï¼š${filePath}`); return filePath; } catch (err) { console.error(`âŒ ä¸‹è½½æ–‡ä»¶å¤±è´¥ï¼ˆå°è¯• ${attempt}ï¼‰ï¼š${fileName}`, err); if (attempt === retries) { throw new Error(`ä¸‹è½½æ–‡ä»¶å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ï¼š${fileName}`); } // ç­‰å¾… 1 ç§’åé‡è¯• await new Promise(res =\u003e setTimeout(res, 1000)); } } } // ç»Ÿä¸€å¤„ç†æ¶ˆæ¯ï¼ˆæ™®é€šæ¶ˆæ¯å’Œè½¬å‘æ¶ˆæ¯ï¼‰ bot.on(\"message\", (msg) =\u003e { const hasFile = msg.document || msg.photo || msg.video; const isForward = msg.forward_from || msg.forward_from_chat; if (!hasFile) return; const typePrefix = isForward ? \"è½¬å‘\" : \"\"; // æ–‡æ¡£ if (msg.document) { saveFile(msg, msg.document.file_id, msg.document.file_name, `${typePrefix}æ–‡æ¡£`); } // å›¾ç‰‡ if (msg.photo) { const photo = msg.photo[msg.photo.length - 1]; const fileName = `photo_${Date.now()}.jpg`; saveFile(msg, photo.file_id, fileName, `${typePrefix}å›¾ç‰‡`); } // è§†é¢‘ if (msg.video) { const fileName = msg.video.file_name || `video_${Date.now()}.mp4`; saveFile(msg, msg.video.file_id, fileName, `${typePrefix}è§†é¢‘`); } }); // /myfiles æ–‡æœ¬åˆ—è¡¨ bot.onText(/\\/myfiles/, (msg) =\u003e { const userId = msg.from.id; db.all( `SELECT id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT 10`, [userId], (err, rows) =\u003e { if (err) return bot.sendMessage(msg.chat.id, \"âŒ æŸ¥è¯¢å¤±è´¥ã€‚\"); if (rows.length === 0) return bot.sendMessage(msg.chat.id, \"ğŸ“­ æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶ã€‚\"); let text = \"ğŸ“‚ æœ€è¿‘çš„æ–‡ä»¶ï¼š\\n\\n\"; rows.forEach((r) =\u003e { text += `#${r.id} ${r.file_name} [${r.category}]\\n`; }); bot.sendMessage(msg.chat.id, text); } ); }); // /myfilelist åˆ†é¡µæ˜¾ç¤ºï¼ˆä¼˜åŒ–ï¼šæ”¯æŒå›¾ç‰‡ç¼©ç•¥å›¾ï¼‰ async function sendFilePage(chatId, userId, page = 1, messageId = null) { const offset = (page - 1) * PAGE_SIZE; db.all( `SELECT id, file_id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT ? OFFSET ?`, [userId, PAGE_SIZE, offset], async (err, rows) =\u003e { if (err) return bot.sendMessage(chatId, \"âŒ æŸ¥è¯¢å¤±è´¥ã€‚\"); if (rows.length === 0) return bot.sendMessage(chatId, \"ğŸ“­ æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶ã€‚\"); // æ‹¼æ¥æ–‡ä»¶åˆ—è¡¨æ–‡å­— let text = `ğŸ“‘ ç¬¬ ${page} é¡µï¼ˆæ¯é¡µ ${PAGE_SIZE} æ¡ï¼‰\\n\\n`; const inline_keyboard = []; const mediaGroup = []; for (const r of rows) { text += `#${r.id} ${r.file_name} [${r.category}]\\n`; // æ¯ä¸ªæ–‡ä»¶å•ç‹¬ä¸¤æŒ‰é’®è¡Œï¼šåˆ é™¤+ä¸‹è½½ inline_keyboard.push([ { text: \"âŒ åˆ é™¤\", callback_data: `del_${r.id}` }, { text: \"â¬‡ï¸ ä¸‹è½½æœ¬åœ°\", callback_data: `download_${r.id}` }, ]); // å¦‚æœæ˜¯å›¾ç‰‡ï¼ŒåŠ å…¥ç¼©ç•¥å›¾åˆ° mediaGroup if (r.file_name.endsWith(\".jpg\") || r.file_name.endsWith(\".png\")) { mediaGroup.push({ type: \"photo\", media: r.file_id, caption: `#${r.id} ${r.file_name}` }); } } // ç¿»é¡µæŒ‰é’® const totalCountRow = await new Promise((resolve) =\u003e db.get(`SELECT COUNT(*) as cnt FROM files WHERE user_id = ?`, [userId], (err, row) =\u003e resolve(row)) ); const totalPages = Math.ceil(totalCountRow.cnt / PAGE_SIZE); inline_keyboard.push([ { text: \"â¬…ï¸ ä¸Šä¸€é¡µ\", callback_data: `page_${page - 1}` }, { text: \"â¡ï¸ ä¸‹ä¸€é¡µ\", callback_data: `page_${page + 1}` }, ]); const opts = { reply_markup: { inline_keyboard } }; if (mediaGroup.length \u003e 0) { // å…ˆå‘é€å›¾ç‰‡ç¼©ç•¥å›¾ç»„ try { await bot.sendMediaGroup(chatId, mediaGroup); } catch (err) { console.error(\"å‘é€ç¼©ç•¥å›¾å¤±è´¥:\", err); } } if (messageId) { // ç¼–è¾‘å·²æœ‰æ¶ˆæ¯ await bot.editMessageText(text, { chat_id: chatId, message_id: messageId, reply_markup: opts.reply_markup, }); } else { await bot.sendMessage(chatId, text, opts); } } ); } bot.onText(/\\/myfilelist ?(\\d+)?/, (msg, match) =\u003e { const page = parseInt(match[1]) || 1; sendFilePage(msg.chat.id, msg.from.id, page); }); // /search å…³é”®å­— bot.onText(/\\/search (.+)/, (msg, match) =\u003e { const keyword = `%${match[1]}%`; const userId = msg.from.id; db.all( `SELECT id, file_name, category FROM files WHERE user_id = ? AND file_name LIKE ? ORDER BY date DESC LIMIT 10`, [userId, keyword], (err, rows) =\u003e { if (err) return bot.sendMessage(msg.chat.id, \"âŒ æŸ¥è¯¢å¤±è´¥ã€‚\"); if (rows.length === 0) return bot.sendMessage(msg.chat.id, \"ğŸ” æ²¡æœ‰åŒ¹é…çš„æ–‡ä»¶ã€‚\"); let text = `ğŸ” æœç´¢ç»“æœï¼š\\n\\n`; rows.forEach((r) =\u003e { text += `#${r.id} ${r.file_name} [${r.category}]\\n`; }); bot.sendMessage(msg.chat.id, text); } ); }); // /getfile id bot.onText(/\\/getfile (\\d+)/, (msg, match) =\u003e { const id = match[1]; db.get(`SELECT file_id, file_name FROM files WHERE id = ?`, [id], (err, row) =\u003e { if (!row) return bot.sendMessage(msg.chat.id, \"âŒ æ–‡ä»¶ä¸å­˜åœ¨ã€‚\"); if (row.file_name.endsWith(\".jpg\")) { bot.sendPhoto(msg.chat.id, row.file_id, { caption: row.file_name }); } else if (row.file_name.endsWith(\".mp4\")) { bot.sendVideo(msg.chat.id, row.file_id, { caption: row.file_name }); } else { bot.sendDocument(msg.chat.id, row.file_id, {}, { filename: row.file_name }); } }); }); // /delete id bot.onText(/\\/delete (\\d+)/, (msg, match) =\u003e { const id = match[1]; const userId = msg.from.id; db.run(`DELETE FROM files WHERE id = ? AND user_id = ?`, [id, userId], function (err) { if (err) return bot.sendMessage(msg.chat.id, \"âŒ åˆ é™¤å¤±è´¥ã€‚\"); if (this.changes === 0) return bot.sendMessage(msg.chat.id, \"âš ï¸ æ²¡æ‰¾åˆ°è¯¥æ–‡ä»¶æˆ–æ— æƒé™åˆ é™¤ã€‚\"); bot.sendMessage(msg.chat.id, `âœ… æ–‡ä»¶(ID=${id}) å·²åˆ é™¤ã€‚`); }); }); // callback_query ç»Ÿä¸€å¤„ç† bot.on(\"callback_query\", async (query) =\u003e { const userId = query.from.id; const chatId = query.message.chat.id; // åˆ†ç±»æŒ‰é’® if (query.data.startsWith(\"cat_\")) { const category = query.data.replace(\"cat_\", \"\"); userCategory[userId] = category; bot.sendMessage(chatId, `âœ… å·²è®¾ç½®åˆ†ç±»ä¸ºï¼š${category}`); } // åˆ é™¤æŒ‰é’® if (query.data.startsWith(\"del_\")) { const fileId = query.data.replace(\"del_\", \"\"); const confirmOpts = { reply_markup: { inline_keyboard: [ [ { text: \"âœ… ç¡®è®¤åˆ é™¤\", callback_data: `confirmdel_${fileId}` }, { text: \"âŒ å–æ¶ˆ\", callback_data: `cancel_${fileId}` }, ], ], }, }; bot.sendMessage(chatId, `âš ï¸ ç¡®è®¤è¦åˆ é™¤æ–‡ä»¶(ID=${fileId})å—ï¼Ÿ`, confirmOpts); } // ç¡®è®¤åˆ é™¤ if (query.data.startsWith(\"confirmdel_\")) { const fileId = query.data.replace(\"confirmdel_\", \"\"); db.run(`DELETE FROM files WHERE id = ? AND user_id = ?`, [fileId, userId], function (err) { if (err) return bot.sendMessage(chatId, \"âŒ åˆ é™¤å¤±è´¥ã€‚\"); if (this.changes === 0) return bot.sendMessage(chatId, \"âš ï¸ æ²¡æ‰¾åˆ°è¯¥æ–‡ä»¶æˆ–æ— æƒé™åˆ é™¤ã€‚\"); bot.sendMessage(chatId, `âœ… æ–‡ä»¶(ID=${fileId}) å·²åˆ é™¤ã€‚`); }); } // å–æ¶ˆåˆ é™¤ if (query.data.startsWith(\"cancel_\")) { const fileId = query.data.replace(\"cancel_\", \"\"); bot.sendMessage(chatId, `â å·²å–æ¶ˆåˆ é™¤æ–‡ä»¶(ID=${fileId})ã€‚`); } // åˆ†é¡µæŒ‰é’® if (query.data.startsWith(\"page_\")) { const page = parseInt(query.data.replace(\"page_\", \"\")); if (page \u003c 1) return bot.answerCallbackQuery(query.id, { text: \"å·²ç»æ˜¯ç¬¬ä¸€é¡µ\" }); sendFilePage(chatId, userId, page, query.message.message_id); } // ä¸‹è½½åˆ°æœ¬åœ°æŒ‰é’® if (query.data.startsWith(\"download_\")) { const id = query.data.replace(\"download_\", \"\"); db.get(`SELECT file_id, file_name, category FROM files WHERE id = ? AND user_id = ?`, [id, userId], async (err, row) =\u003e { if (!row) return bot.sendMessage(chatId, \"âŒ æ–‡ä»¶ä¸å­˜åœ¨æˆ–æ— æƒé™ä¸‹è½½ã€‚\"); try { const filePath = await downloadFile(row.file_id, row.file_name, row.category); bot.sendMessage(chatId, `âœ… æ–‡ä»¶å·²ä¸‹è½½åˆ°æœåŠ¡å™¨æœ¬åœ°ï¼š${filePath}`); } catch (err) { console.error(err); bot.sendMessage(chatId, `âŒ ${err.message}`); } }); } bot.answerCallbackQuery(query.id); }); config.js configbot.js\n// configbot.js module.exports = { token: \"t\", // Telegram Bot Token categories: [\"work\", \"study\", \"life\", \"other\", \"yo\", \"yo2\"], // åˆ†ç±» pageSize: 5 // æ¯é¡µæ˜¾ç¤ºæ¡æ•° }; //bot.js const TelegramBot = require(\"node-telegram-bot-api\"); const db = require(\"./db\"); const fs = require(\"fs\"); const path = require(\"path\"); const axios = require(\"axios\"); const config = require(\"./configbot\"); // å¼•å…¥é…ç½®æ–‡ä»¶ const token = config.token; const categories = config.categories; const PAGE_SIZE = config.pageSize; const bot = new TelegramBot(token, { polling: true }); login //config module.exports = { token: \"BOT_TOKEN\", categories: [\"c1\", \"c2\", \"c2\"], pageSize: 5, adminPassword: \"admin123\" // æœºå™¨äººè®¿é—®å¯†ç  }; const TelegramBot = require(\"node-telegram-bot-api\"); const db = require(\"./db\"); const fs = require(\"fs\"); const path = require(\"path\"); const axios = require(\"axios\"); const config = require(\"./configbot\"); // å¼•å…¥é…ç½®æ–‡ä»¶ const token = config.token; const categories = config.categories; const PAGE_SIZE = config.pageSize; // ä»é…ç½®è¯»å– const ADMIN_PASSWORD = config.adminPassword; // ç®¡ç†å¯†ç  const bot = new TelegramBot(token, { polling: true }); // ä¿å­˜åˆ†ç±»ä¿¡æ¯ï¼ˆç”¨æˆ· -\u003e å½“å‰é€‰æ‹©çš„åˆ†ç±»ï¼‰ const userCategory = {}; // ä¿å­˜å·²ç™»å½•ç”¨æˆ· const authenticatedUsers = new Set(); // æœ¬åœ°å­˜å‚¨æ ¹ç›®å½• const STORAGE_DIR = path.join(__dirname, \"files\"); if (!fs.existsSync(STORAGE_DIR)) fs.mkdirSync(STORAGE_DIR); // æ£€æŸ¥æ˜¯å¦å·²é‰´æƒ function checkAuth(msg) { const userId = msg.from.id; if (!authenticatedUsers.has(userId)) { bot.sendMessage(msg.chat.id, \"âš ï¸ è¯·å…ˆä½¿ç”¨ /login \u003cå¯†ç \u003e ç™»å½•ã€‚\"); return false; } return true; } // /login å‘½ä»¤ bot.onText(/\\/login (.+)/, (msg, match) =\u003e { const password = match[1]; const userId = msg.from.id; if (password === ADMIN_PASSWORD) { authenticatedUsers.add(userId); bot.sendMessage(msg.chat.id, \"âœ… ç™»å½•æˆåŠŸï¼Œæ‚¨å·²è·å¾—è®¿é—®æƒé™ã€‚\"); } else { bot.sendMessage(msg.chat.id, \"âŒ å¯†ç é”™è¯¯ã€‚\"); } }); // /start å‘½ä»¤ bot.onText(/\\/start/, (msg) =\u003e { if (!checkAuth(msg)) return; bot.sendMessage( msg.chat.id, \"æ¬¢è¿ä½¿ç”¨æ–‡ä»¶å­˜å‚¨æœºå™¨äººï¼\\n\\nå‘½ä»¤ï¼š\\n\" + \"/setcategory è®¾ç½®åˆ†ç±»\\n\" + \"/myfiles æŸ¥çœ‹æœ€è¿‘æ–‡ä»¶(æ–‡å­—åˆ—è¡¨)\\n\" + \"/myfilelist [é¡µç ] æ–‡ä»¶åˆ†é¡µæ˜¾ç¤º\\n\" + \"/search å…³é”®å­— æœç´¢æ–‡ä»¶\\n\" + \"/getfile id è·å–æ–‡ä»¶\\n\" + \"/delete id åˆ é™¤æ–‡ä»¶\\n\" + \"ğŸ“¥ ç‚¹å‡»æ–‡ä»¶åçš„â€œä¸‹è½½æœ¬åœ°â€æŒ‰é’®å¯ä¿å­˜åˆ°æœåŠ¡å™¨æœ¬åœ°\" ); }); // /setcategory æ˜¾ç¤ºæŒ‰é’® bot.onText(/\\/setcategory/, (msg) =\u003e { if (!checkAuth(msg)) return; const opts = { reply_markup: { inline_keyboard: categories.map((c) =\u003e [{ text: c, callback_data: `cat_${c}` }]), }, }; bot.sendMessage(msg.chat.id, \"è¯·é€‰æ‹©åˆ†ç±»ï¼š\", opts); }); // é€šç”¨ä¿å­˜å‡½æ•° function saveFile(msg, fileId, fileName, type) { const userId = msg.from.id; const chatId = msg.chat.id; const category = userCategory[userId] || \"æœªåˆ†ç±»\"; db.run( `INSERT INTO files (file_id, file_name, category, user_id) VALUES (?, ?, ?, ?)`, [fileId, fileName, category, userId], function (err) { if (err) { console.error(err); bot.sendMessage(chatId, \"âŒ å­˜å‚¨å¤±è´¥ã€‚\"); } else { bot.sendMessage( chatId, `ğŸ“¦ å·²ä¿å­˜ ${type}\\nID: ${this.lastID}\\næ–‡ä»¶å: ${fileName}\\nåˆ†ç±»: ${category}` ); } } ); } // ä¸‹è½½æ–‡ä»¶åˆ°æœ¬åœ°ï¼ˆå¸¦é‡è¯•å’Œæ—¥å¿—ï¼‰ async function downloadFile(fileId, fileName, category, retries = 3) { const dir = path.join(STORAGE_DIR, category); if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true }); const filePath = path.join(dir, fileName); for (let attempt = 1; attempt \u003c= retries; attempt++) { try { console.log(`ä¸‹è½½æ–‡ä»¶å°è¯• ${attempt}/${retries}ï¼š${fileName}`); const url = await bot.getFileLink(fileId); // è·å–æ–‡ä»¶é“¾æ¥ const writer = fs.createWriteStream(filePath); const response = await axios({ url, method: \"GET\", responseType: \"stream\", timeout: 30000, // 30ç§’è¶…æ—¶ }); response.data.pipe(writer); await new Promise((resolve, reject) =\u003e { writer.on(\"finish\", resolve); writer.on(\"error\", reject); }); console.log(`âœ… æ–‡ä»¶ä¸‹è½½æˆåŠŸï¼š${filePath}`); return filePath; } catch (err) { console.error(`âŒ ä¸‹è½½æ–‡ä»¶å¤±è´¥ï¼ˆå°è¯• ${attempt}ï¼‰ï¼š${fileName}`, err); if (attempt === retries) { throw new Error(`ä¸‹è½½æ–‡ä»¶å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ï¼š${fileName}`); } // ç­‰å¾… 1 ç§’åé‡è¯• await new Promise((res) =\u003e setTimeout(res, 1000)); } } } // ç»Ÿä¸€å¤„ç†æ¶ˆæ¯ï¼ˆæ™®é€šæ¶ˆæ¯å’Œè½¬å‘æ¶ˆæ¯ï¼‰ bot.on(\"message\", (msg) =\u003e { if (!checkAuth(msg)) return; const hasFile = msg.document || msg.photo || msg.video; const isForward = msg.forward_from || msg.forward_from_chat; if (!hasFile) return; const typePrefix = isForward ? \"è½¬å‘\" : \"\"; // æ–‡æ¡£ if (msg.document) { saveFile(msg, msg.document.file_id, msg.document.file_name, `${typePrefix}æ–‡æ¡£`); } // å›¾ç‰‡ if (msg.photo) { const photo = msg.photo[msg.photo.length - 1]; const fileName = `photo_${Date.now()}.jpg`; saveFile(msg, photo.file_id, fileName, `${typePrefix}å›¾ç‰‡`); } // è§†é¢‘ if (msg.video) { const fileName = msg.video.file_name || `video_${Date.now()}.mp4`; saveFile(msg, msg.video.file_id, fileName, `${typePrefix}è§†é¢‘`); } }); // /myfiles æ–‡æœ¬åˆ—è¡¨ bot.onText(/\\/myfiles/, (msg) =\u003e { if (!checkAuth(msg)) return; const userId = msg.from.id; db.all( `SELECT id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT 10`, [userId], (err, rows) =\u003e { if (err) return bot.sendMessage(msg.chat.id, \"âŒ æŸ¥è¯¢å¤±è´¥ã€‚\"); if (rows.length === 0) return bot.sendMessage(msg.chat.id, \"ğŸ“­ æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶ã€‚\"); let text = \"ğŸ“‚ æœ€è¿‘çš„æ–‡ä»¶ï¼š\\n\\n\"; rows.forEach((r) =\u003e { text += `#${r.id} ${r.file_name} [${r.category}]\\n`; }); bot.sendMessage(msg.chat.id, text); } ); }); // /myfilelist åˆ†é¡µæ˜¾ç¤º async function sendFilePage(chatId, userId, page = 1, messageId = null) { const offset = (page - 1) * PAGE_SIZE; db.all( `SELECT id, file_id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT ? OFFSET ?`, [userId, PAGE_SIZE, offset], async (err, rows) =\u003e { if (err) return bot.sendMessage(chatId, \"âŒ æŸ¥è¯¢å¤±è´¥ã€‚\"); if (rows.length === 0) return bot.sendMessage(chatId, \"ğŸ“­ æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶ã€‚\"); let text = `ğŸ“‘ ç¬¬ ${page} é¡µï¼ˆæ¯é¡µ ${PAGE_SIZE} æ¡ï¼‰\\n\\n`; const inline_keyboard = []; const mediaGroup = []; for (const r of rows) { text += `#${r.id} ${r.file_name} [${r.category}]\\n`; inline_keyboard.push([ { text: \"âŒ åˆ é™¤\", callback_data: `del_${r.id}` }, { text: \"â¬‡ï¸ ä¸‹è½½æœ¬åœ°\", callback_data: `download_${r.id}` }, ]); if (r.file_name.endsWith(\".jpg\") || r.file_name.endsWith(\".png\")) { mediaGroup.push({ type: \"photo\", media: r.file_id, caption: `#${r.id} ${r.file_name}` }); } } const totalCountRow = await new Promise((resolve) =\u003e db.get(`SELECT COUNT(*) as cnt FROM files WHERE user_id = ?`, [userId], (err, row) =\u003e resolve(row) ) ); const totalPages = Math.ceil(totalCountRow.cnt / PAGE_SIZE); inline_keyboard.push([ { text: \"â¬…ï¸ ä¸Šä¸€é¡µ\", callback_data: `page_${page - 1}` }, { text: \"â¡ï¸ ä¸‹ä¸€é¡µ\", callback_data: `page_${page + 1}` }, ]); const opts = { reply_markup: { inline_keyboard } }; if (mediaGroup.length \u003e 0) { try { await bot.sendMediaGroup(chatId, mediaGroup); } catch (err) { console.error(\"å‘é€ç¼©ç•¥å›¾å¤±è´¥:\", err); } } if (messageId) { await bot.editMessageText(text, { chat_id: chatId, message_id: messageId, reply_markup: opts.reply_markup, }); } else { await bot.sendMessage(chatId, text, opts); } } ); } bot.onText(/\\/myfilelist ?(\\d+)?/, (msg, match) =\u003e { if (!checkAuth(msg)) return; const page = parseInt(match[1]) || 1; sendFilePage(msg.chat.id, msg.from.id, page); }); // /search å…³é”®å­— bot.onText(/\\/search (.+)/, (msg, match) =\u003e { if (!checkAuth(msg)) return; const keyword = `%${match[1]}%`; const userId = msg.from.id; db.all( `SELECT id, file_name, category FROM files WHERE user_id = ? AND file_name LIKE ? ORDER BY date DESC LIMIT 10`, [userId, keyword], (err, rows) =\u003e { if (err) return bot.sendMessage(msg.chat.id, \"âŒ æŸ¥è¯¢å¤±è´¥ã€‚\"); if (rows.length === 0) return bot.sendMessage(msg.chat.id, \"ğŸ” æ²¡æœ‰åŒ¹é…çš„æ–‡ä»¶ã€‚\"); let text = `ğŸ” æœç´¢ç»“æœï¼š\\n\\n`; rows.forEach((r) =\u003e { text += `#${r.id} ${r.file_name} [${r.category}]\\n`; }); bot.sendMessage(msg.chat.id, text); } ); }); // /getfile id bot.onText(/\\/getfile (\\d+)/, (msg, match) =\u003e { if (!checkAuth(msg)) return; const id = match[1]; db.get(`SELECT file_id, file_name FROM files WHERE id = ?`, [id], (err, row) =\u003e { if (!row) return bot.sendMessage(msg.chat.id, \"âŒ æ–‡ä»¶ä¸å­˜åœ¨ã€‚\"); if (row.file_name.endsWith(\".jpg\")) { bot.sendPhoto(msg.chat.id, row.file_id, { caption: row.file_name }); } else if (row.file_name.endsWith(\".mp4\")) { bot.sendVideo(msg.chat.id, row.file_id, { caption: row.file_name }); } else { bot.sendDocument(msg.chat.id, row.file_id, {}, { filename: row.file_name }); } }); }); // /delete id bot.onText(/\\/delete (\\d+)/, (msg, match) =\u003e { if (!checkAuth(msg)) return; const id = match[1]; const userId = msg.from.id; db.run(`DELETE FROM files WHERE id = ? AND user_id = ?`, [id, userId], function (err) { if (err) return bot.sendMessage(msg.chat.id, \"âŒ åˆ é™¤å¤±è´¥ã€‚\"); if (this.changes === 0) return bot.sendMessage(msg.chat.id, \"âš ï¸ æ²¡æ‰¾åˆ°è¯¥æ–‡ä»¶æˆ–æ— æƒé™åˆ é™¤ã€‚\"); bot.sendMessage(msg.chat.id, `âœ… æ–‡ä»¶(ID=${id}) å·²åˆ é™¤ã€‚`); }); }); // callback_query ç»Ÿä¸€å¤„ç† bot.on(\"callback_query\", async (query) =\u003e { const userId = query.from.id; const chatId = query.message.chat.id; if (!authenticatedUsers.has(userId)) { return bot.answerCallbackQuery(query.id, { text: \"âš ï¸ è¯·å…ˆç™»å½• /login \u003cå¯†ç \u003e\" }); } if (query.data.startsWith(\"cat_\")) { const category = query.data.replace(\"cat_\", \"\"); userCategory[userId] = category; bot.sendMessage(chatId, `âœ… å·²è®¾ç½®åˆ†ç±»ä¸ºï¼š${category}`); } if (query.data.startsWith(\"del_\")) { const fileId = query.data.replace(\"del_\", \"\"); const confirmOpts = { reply_markup: { inline_keyboard: [ [ { text: \"âœ… ç¡®è®¤åˆ é™¤\", callback_data: `confirmdel_${fileId}` }, { text: \"âŒ å–æ¶ˆ\", callback_data: `cancel_${fileId}` }, ], ], }, }; bot.sendMessage(chatId, `âš ï¸ ç¡®è®¤è¦åˆ é™¤æ–‡ä»¶(ID=${fileId})å—ï¼Ÿ`, confirmOpts); } if (query.data.startsWith(\"confirmdel_\")) { const fileId = query.data.replace(\"confirmdel_\", \"\"); db.run(`DELETE FROM files WHERE id = ? AND user_id = ?`, [fileId, userId], function (err) { if (err) return bot.sendMessage(chatId, \"âŒ åˆ é™¤å¤±è´¥ã€‚\"); if (this.changes === 0) return bot.sendMessage(chatId, \"âš ï¸ æ²¡æ‰¾åˆ°è¯¥æ–‡ä»¶æˆ–æ— æƒé™åˆ é™¤ã€‚\"); bot.sendMessage(chatId, `âœ… æ–‡ä»¶(ID=${fileId}) å·²åˆ é™¤ã€‚`); }); } if (query.data.startsWith(\"cancel_\")) { const fileId = query.data.replace(\"cancel_\", \"\"); bot.sendMessage(chatId, `â å·²å–æ¶ˆåˆ é™¤æ–‡ä»¶(ID=${fileId})ã€‚`); } if (query.data.startsWith(\"page_\")) { const page = parseInt(query.data.replace(\"page_\", \"\")); if (page \u003c 1) return bot.answerCallbackQuery(query.id, { text: \"å·²ç»æ˜¯ç¬¬ä¸€é¡µ\" }); sendFilePage(chatId, userId, page, query.message.message_id); } if (query.data.startsWith(\"download_\")) { const id = query.data.replace(\"download_\", \"\"); db.get( `SELECT file_id, file_name, category FROM files WHERE id = ? AND user_id = ?`, [id, userId], async (err, row) =\u003e { if (!row) return bot.sendMessage(chatId, \"âŒ æ–‡ä»¶ä¸å­˜åœ¨æˆ–æ— æƒé™ä¸‹è½½ã€‚\"); try { const filePath = await downloadFile(row.file_id, row.file_name, row.category); bot.sendMessage(chatId, `âœ… æ–‡ä»¶å·²ä¸‹è½½åˆ°æœåŠ¡å™¨æœ¬åœ°ï¼š${filePath}`); } catch (err) { console.error(err); bot.sendMessage(chatId, `âŒ ${err.message}`); } } ); } bot.answerCallbackQuery(query.id); }); ç”¨æˆ·å¿…é¡»å…ˆè¾“å…¥ /login admin123ï¼Œå¦åˆ™æ‰€æœ‰å‘½ä»¤éƒ½ä¼šæç¤º âš ï¸ è¯·å…ˆä½¿ç”¨ /login \u003cå¯†ç \u003e ç™»å½•ã€‚\nç™»å½•æˆåŠŸåï¼Œæ‰å¯ä»¥æ­£å¸¸ä½¿ç”¨ /startã€ä¸Šä¼ æ–‡ä»¶ã€æœç´¢ã€åˆ†é¡µã€åˆ é™¤ã€ä¸‹è½½ç­‰åŠŸèƒ½ã€‚\nlist detail const TelegramBot = require(\"node-telegram-bot-api\"); const db = require(\"./db\"); const fs = require(\"fs\"); const path = require(\"path\"); const axios = require(\"axios\"); const config = require(\"./configbot\"); // å¼•å…¥é…ç½®æ–‡ä»¶ const token = config.token; const categories = config.categories; const PAGE_SIZE = config.pageSize; // ä»é…ç½®è¯»å– const ADMIN_PASSWORD = config.adminPassword; // ç®¡ç†å¯†ç  const bot = new TelegramBot(token, { polling: true }); // ä¿å­˜åˆ†ç±»ä¿¡æ¯ï¼ˆç”¨æˆ· -\u003e å½“å‰é€‰æ‹©çš„åˆ†ç±»ï¼‰ const userCategory = {}; // ä¿å­˜å·²ç™»å½•ç”¨æˆ· const authenticatedUsers = new Set(); // æœ¬åœ°å­˜å‚¨æ ¹ç›®å½• const STORAGE_DIR = path.join(__dirname, \"files\"); if (!fs.existsSync(STORAGE_DIR)) fs.mkdirSync(STORAGE_DIR); // æ£€æŸ¥æ˜¯å¦å·²é‰´æƒ function checkAuth(msg) { const userId = msg.from.id; if (!authenticatedUsers.has(userId)) { bot.sendMessage(msg.chat.id, \"âš ï¸ è¯·å…ˆä½¿ç”¨ /login \u003cå¯†ç \u003e ç™»å½•ã€‚\"); return false; } return true; } // /login å‘½ä»¤ bot.onText(/\\/login (.+)/, (msg, match) =\u003e { const password = match[1]; const userId = msg.from.id; if (password === ADMIN_PASSWORD) { authenticatedUsers.add(userId); bot.sendMessage(msg.chat.id, \"âœ… ç™»å½•æˆåŠŸï¼Œæ‚¨å·²è·å¾—è®¿é—®æƒé™ã€‚\"); } else { bot.sendMessage(msg.chat.id, \"âŒ å¯†ç é”™è¯¯ã€‚\"); } }); // /start å‘½ä»¤ bot.onText(/\\/start/, (msg) =\u003e { if (!checkAuth(msg)) return; bot.sendMessage( msg.chat.id, \"æ¬¢è¿ä½¿ç”¨æ–‡ä»¶å­˜å‚¨æœºå™¨äººï¼\\n\\nå‘½ä»¤ï¼š\\n\" + \"/setcategory è®¾ç½®åˆ†ç±»\\n\" + \"/myfiles æŸ¥çœ‹æœ€è¿‘æ–‡ä»¶(æ–‡å­—åˆ—è¡¨)\\n\" + \"/myfilelist [é¡µç ] æ–‡ä»¶åˆ†é¡µæ˜¾ç¤º\\n\" + \"/search å…³é”®å­— æœç´¢æ–‡ä»¶\\n\" + \"/getfile id è·å–æ–‡ä»¶\\n\" + \"/delete id åˆ é™¤æ–‡ä»¶\\n\" + \"ğŸ“¥ ç‚¹å‡»æ–‡ä»¶åçš„â€œä¸‹è½½æœ¬åœ°â€æˆ–â€œæŸ¥çœ‹è¯¦æƒ…â€æŒ‰é’®æ“ä½œ\" ); }); // /setcategory æ˜¾ç¤ºæŒ‰é’® bot.onText(/\\/setcategory/, (msg) =\u003e { if (!checkAuth(msg)) return; const opts = { reply_markup: { inline_keyboard: categories.map((c) =\u003e [{ text: c, callback_data: `cat_${c}` }]), }, }; bot.sendMessage(msg.chat.id, \"è¯·é€‰æ‹©åˆ†ç±»ï¼š\", opts); }); // é€šç”¨ä¿å­˜å‡½æ•° function saveFile(msg, fileId, fileName, type) { const userId = msg.from.id; const chatId = msg.chat.id; const category = userCategory[userId] || \"æœªåˆ†ç±»\"; db.run( `INSERT INTO files (file_id, file_name, category, user_id, date) VALUES (?, ?, ?, ?, datetime('now'))`, [fileId, fileName, category, userId], function (err) { if (err) { console.error(err); bot.sendMessage(chatId, \"âŒ å­˜å‚¨å¤±è´¥ã€‚\"); } else { bot.sendMessage( chatId, `ğŸ“¦ å·²ä¿å­˜ ${type}\\nID: ${this.lastID}\\næ–‡ä»¶å: ${fileName}\\nåˆ†ç±»: ${category}` ); } } ); } // ä¸‹è½½æ–‡ä»¶åˆ°æœ¬åœ°ï¼ˆå¸¦é‡è¯•å’Œæ—¥å¿—ï¼‰ async function downloadFile(fileId, fileName, category, retries = 3) { const dir = path.join(STORAGE_DIR, category); if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true }); const filePath = path.join(dir, fileName); for (let attempt = 1; attempt \u003c= retries; attempt++) { try { console.log(`ä¸‹è½½æ–‡ä»¶å°è¯• ${attempt}/${retries}ï¼š${fileName}`); const url = await bot.getFileLink(fileId); // è·å–æ–‡ä»¶é“¾æ¥ const writer = fs.createWriteStream(filePath); const response = await axios({ url, method: \"GET\", responseType: \"stream\", timeout: 30000, // 30ç§’è¶…æ—¶ }); response.data.pipe(writer); await new Promise((resolve, reject) =\u003e { writer.on(\"finish\", resolve); writer.on(\"error\", reject); }); console.log(`âœ… æ–‡ä»¶ä¸‹è½½æˆåŠŸï¼š${filePath}`); return filePath; } catch (err) { console.error(`âŒ ä¸‹è½½æ–‡ä»¶å¤±è´¥ï¼ˆå°è¯• ${attempt}ï¼‰ï¼š${fileName}`, err); if (attempt === retries) { throw new Error(`ä¸‹è½½æ–‡ä»¶å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ï¼š${fileName}`); } // ç­‰å¾… 1 ç§’åé‡è¯• await new Promise((res) =\u003e setTimeout(res, 1000)); } } } // ç»Ÿä¸€å¤„ç†æ¶ˆæ¯ï¼ˆæ™®é€šæ¶ˆæ¯å’Œè½¬å‘æ¶ˆæ¯ï¼‰ bot.on(\"message\", (msg) =\u003e { if (!checkAuth(msg)) return; const hasFile = msg.document || msg.photo || msg.video; const isForward = msg.forward_from || msg.forward_from_chat; if (!hasFile) return; const typePrefix = isForward ? \"è½¬å‘\" : \"\"; // æ–‡æ¡£ if (msg.document) { saveFile(msg, msg.document.file_id, msg.document.file_name, `${typePrefix}æ–‡æ¡£`); } // å›¾ç‰‡ if (msg.photo) { const photo = msg.photo[msg.photo.length - 1]; const fileName = `photo_${Date.now()}.jpg`; saveFile(msg, photo.file_id, fileName, `${typePrefix}å›¾ç‰‡`); } // è§†é¢‘ if (msg.video) { const fileName = msg.video.file_name || `video_${Date.now()}.mp4`; saveFile(msg, msg.video.file_id, fileName, `${typePrefix}è§†é¢‘`); } }); // /myfiles æ–‡æœ¬åˆ—è¡¨ bot.onText(/\\/myfiles/, (msg) =\u003e { if (!checkAuth(msg)) return; const userId = msg.from.id; db.all( `SELECT id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT 10`, [userId], (err, rows) =\u003e { if (err) return bot.sendMessage(msg.chat.id, \"âŒ æŸ¥è¯¢å¤±è´¥ã€‚\"); if (rows.length === 0) return bot.sendMessage(msg.chat.id, \"ğŸ“­ æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶ã€‚\"); let text = \"ğŸ“‚ æœ€è¿‘çš„æ–‡ä»¶ï¼š\\n\\n\"; const inline_keyboard = []; rows.forEach((r) =\u003e { text += `#${r.id} ${r.file_name} [${r.category}]\\n`; inline_keyboard.push([{ text: \"â„¹ï¸ æŸ¥çœ‹è¯¦æƒ…\", callback_data: `detail_${r.id}` }]); }); bot.sendMessage(msg.chat.id, text, { reply_markup: { inline_keyboard } }); } ); }); // /myfilelist åˆ†é¡µæ˜¾ç¤º async function sendFilePage(chatId, userId, page = 1, messageId = null) { const offset = (page - 1) * PAGE_SIZE; db.all( `SELECT id, file_id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT ? OFFSET ?`, [userId, PAGE_SIZE, offset], async (err, rows) =\u003e { if (err) return bot.sendMessage(chatId, \"âŒ æŸ¥è¯¢å¤±è´¥ã€‚\"); if (rows.length === 0) return bot.sendMessage(chatId, \"ğŸ“­ æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶ã€‚\"); let text = `ğŸ“‘ ç¬¬ ${page} é¡µï¼ˆæ¯é¡µ ${PAGE_SIZE} æ¡ï¼‰\\n\\n`; const inline_keyboard = []; const mediaGroup = []; for (const r of rows) { text += `#${r.id} ${r.file_name} [${r.category}]\\n`; inline_keyboard.push([ { text: \"â„¹ï¸ æŸ¥çœ‹è¯¦æƒ…\", callback_data: `detail_${r.id}` }, { text: \"âŒ åˆ é™¤\", callback_data: `del_${r.id}` }, { text: \"â¬‡ï¸ ä¸‹è½½æœ¬åœ°\", callback_data: `download_${r.id}` }, ]); if (r.file_name.endsWith(\".jpg\") || r.file_name.endsWith(\".png\")) { mediaGroup.push({ type: \"photo\", media: r.file_id, caption: `#${r.id} ${r.file_name}` }); } } const totalCountRow = await new Promise((resolve) =\u003e db.get(`SELECT COUNT(*) as cnt FROM files WHERE user_id = ?`, [userId], (err, row) =\u003e resolve(row) ) ); const totalPages = Math.ceil(totalCountRow.cnt / PAGE_SIZE); inline_keyboard.push([ { text: \"â¬…ï¸ ä¸Šä¸€é¡µ\", callback_data: `page_${page - 1}` }, { text: \"â¡ï¸ ä¸‹ä¸€é¡µ\", callback_data: `page_${page + 1}` }, ]); const opts = { reply_markup: { inline_keyboard } }; if (mediaGroup.length \u003e 0) { try { await bot.sendMediaGroup(chatId, mediaGroup); } catch (err) { console.error(\"å‘é€ç¼©ç•¥å›¾å¤±è´¥:\", err); } } if (messageId) { await bot.editMessageText(text, { chat_id: chatId, message_id: messageId, reply_markup: opts.reply_markup, }); } else { await bot.sendMessage(chatId, text, opts); } } ); } bot.onText(/\\/myfilelist ?(\\d+)?/, (msg, match) =\u003e { if (!checkAuth(msg)) return; const page = parseInt(match[1]) || 1; sendFilePage(msg.chat.id, msg.from.id, page); }); // /search å…³é”®å­— bot.onText(/\\/search (.+)/, (msg, match) =\u003e { if (!checkAuth(msg)) return; const keyword = `%${match[1]}%`; const userId = msg.from.id; db.all( `SELECT id, file_name, category FROM files WHERE user_id = ? AND file_name LIKE ? ORDER BY date DESC LIMIT 10`, [userId, keyword], (err, rows) =\u003e { if (err) return bot.sendMessage(msg.chat.id, \"âŒ æŸ¥è¯¢å¤±è´¥ã€‚\"); if (rows.length === 0) return bot.sendMessage(msg.chat.id, \"ğŸ” æ²¡æœ‰åŒ¹é…çš„æ–‡ä»¶ã€‚\"); let text = `ğŸ” æœç´¢ç»“æœï¼š\\n\\n`; const inline_keyboard = []; rows.forEach((r) =\u003e { text += `#${r.id} ${r.file_name} [${r.category}]\\n`; inline_keyboard.push([{ text: \"â„¹ï¸ æŸ¥çœ‹è¯¦æƒ…\", callback_data: `detail_${r.id}` }]); }); bot.sendMessage(msg.chat.id, text, { reply_markup: { inline_keyboard } }); } ); }); // /getfile id bot.onText(/\\/getfile (\\d+)/, (msg, match) =\u003e { if (!checkAuth(msg)) return; const id = match[1]; db.get(`SELECT file_id, file_name FROM files WHERE id = ?`, [id], (err, row) =\u003e { if (!row) return bot.sendMessage(msg.chat.id, \"âŒ æ–‡ä»¶ä¸å­˜åœ¨ã€‚\"); if (row.file_name.endsWith(\".jpg\")) { bot.sendPhoto(msg.chat.id, row.file_id, { caption: row.file_name }); } else if (row.file_name.endsWith(\".mp4\")) { bot.sendVideo(msg.chat.id, row.file_id, { caption: row.file_name }); } else { bot.sendDocument(msg.chat.id, row.file_id, {}, { filename: row.file_name }); } }); }); // /delete id bot.onText(/\\/delete (\\d+)/, (msg, match) =\u003e { if (!checkAuth(msg)) return; const id = match[1]; const userId = msg.from.id; db.run(`DELETE FROM files WHERE id = ? AND user_id = ?`, [id, userId], function (err) { if (err) return bot.sendMessage(msg.chat.id, \"âŒ åˆ é™¤å¤±è´¥ã€‚\"); if (this.changes === 0) return bot.sendMessage(msg.chat.id, \"âš ï¸ æ²¡æ‰¾åˆ°è¯¥æ–‡ä»¶æˆ–æ— æƒé™åˆ é™¤ã€‚\"); bot.sendMessage(msg.chat.id, `âœ… æ–‡ä»¶(ID=${id}) å·²åˆ é™¤ã€‚`); }); }); // callback_query ç»Ÿä¸€å¤„ç† bot.on(\"callback_query\", async (query) =\u003e { const userId = query.from.id; const chatId = query.message.chat.id; if (!authenticatedUsers.has(userId)) { return bot.answerCallbackQuery(query.id, { text: \"âš ï¸ è¯·å…ˆç™»å½• /login \u003cå¯†ç \u003e\" }); } if (query.data.startsWith(\"cat_\")) { const category = query.data.replace(\"cat_\", \"\"); userCategory[userId] = category; bot.sendMessage(chatId, `âœ… å·²è®¾ç½®åˆ†ç±»ä¸ºï¼š${category}`); } if (query.data.startsWith(\"del_\")) { const fileId = query.data.replace(\"del_\", \"\"); const confirmOpts = { reply_markup: { inline_keyboard: [ [ { text: \"âœ… ç¡®è®¤åˆ é™¤\", callback_data: `confirmdel_${fileId}` }, { text: \"âŒ å–æ¶ˆ\", callback_data: `cancel_${fileId}` }, ], ], }, }; bot.sendMessage(chatId, `âš ï¸ ç¡®è®¤è¦åˆ é™¤æ–‡ä»¶(ID=${fileId})å—ï¼Ÿ`, confirmOpts); } if (query.data.startsWith(\"confirmdel_\")) { const fileId = query.data.replace(\"confirmdel_\", \"\"); db.run(`DELETE FROM files WHERE id = ? AND user_id = ?`, [fileId, userId], function (err) { if (err) return bot.sendMessage(chatId, \"âŒ åˆ é™¤å¤±è´¥ã€‚\"); if (this.changes === 0) return bot.sendMessage(chatId, \"âš ï¸ æ²¡æ‰¾åˆ°è¯¥æ–‡ä»¶æˆ–æ— æƒé™åˆ é™¤ã€‚\"); bot.sendMessage(chatId, `âœ… æ–‡ä»¶(ID=${fileId}) å·²åˆ é™¤ã€‚`); }); } if (query.data.startsWith(\"cancel_\")) { const fileId = query.data.replace(\"cancel_\", \"\"); bot.sendMessage(chatId, `â å·²å–æ¶ˆåˆ é™¤æ–‡ä»¶(ID=${fileId})ã€‚`); } if (query.data.startsWith(\"page_\")) { const page = parseInt(query.data.replace(\"page_\", \"\")); if (page \u003c 1) return bot.answerCallbackQuery(query.id, { text: \"å·²ç»æ˜¯ç¬¬ä¸€é¡µ\" }); sendFilePage(chatId, userId, page, query.message.message_id); } if (query.data.startsWith(\"download_\")) { const id = query.data.replace(\"download_\", \"\"); db.get( `SELECT file_id, file_name, category FROM files WHERE id = ? AND user_id = ?`, [id, userId], async (err, row) =\u003e { if (!row) return bot.sendMessage(chatId, \"âŒ æ–‡ä»¶ä¸å­˜åœ¨æˆ–æ— æƒé™ä¸‹è½½ã€‚\"); try { const filePath = await downloadFile(row.file_id, row.file_name, row.category); bot.sendMessage(chatId, `âœ… æ–‡ä»¶å·²ä¸‹è½½åˆ°æœåŠ¡å™¨æœ¬åœ°ï¼š${filePath}`); } catch (err) { console.error(err); bot.sendMessage(chatId, `âŒ ${err.message}`); } } ); } if (query.data.startsWith(\"detail_\")) { const id = query.data.replace(\"detail_\", \"\"); db.get( `SELECT id, file_id, file_name, category, date, user_id FROM files WHERE id = ? AND user_id = ?`, [id, userId], (err, row) =\u003e { if (!row) return bot.sendMessage(chatId, \"âŒ æ–‡ä»¶ä¸å­˜åœ¨æˆ–æ— æƒé™æŸ¥çœ‹ã€‚\"); const text = `ğŸ“‹ æ–‡ä»¶è¯¦æƒ…\\n\\n` + `ID: ${row.id}\\n` + `æ–‡ä»¶å: ${row.file_name}\\n` + `åˆ†ç±»: ${row.category}\\n` + `ä¸Šä¼ æ—¶é—´: ${row.date}\\n` + `ç”¨æˆ·ID: ${row.user_id}`; bot.sendMessage(chatId, text).then(() =\u003e { // è‡ªåŠ¨å‘é€æ–‡ä»¶ if (row.file_name.endsWith(\".jpg\") || row.file_name.endsWith(\".png\")) { bot.sendPhoto(chatId, row.file_id, { caption: row.file_name }); } else if (row.file_name.endsWith(\".mp4\")) { bot.sendVideo(chatId, row.file_id, { caption: row.file_name }); } else { bot.sendDocument(chatId, row.file_id, {}, { filename: row.file_name }); } }); } ); } bot.answerCallbackQuery(query.id); }); Docker # ä½¿ç”¨å®˜æ–¹ Node.js é•œåƒ FROM node:20 # è®¾ç½®å·¥ä½œç›®å½• WORKDIR /app # å¤åˆ¶ package.json å’Œ package-lock.json COPY package*.json ./ # å®‰è£…ä¾èµ– RUN npm install --production # å¤åˆ¶é¡¹ç›®ä»£ç  COPY . . # æš´éœ²ç«¯å£ï¼ˆæ ¹æ® app.js ç›‘å¬çš„ç«¯å£ï¼‰ EXPOSE 3000 # å®¹å™¨å¯åŠ¨å‘½ä»¤ CMD [\"node\", \"bot.js\"] docker build -t my-node-app . docker run -d \\ --name node-app \\ -p 3000:3000 \\ -v $(pwd):/app \\ --restart unless-stopped \\ my-node-app åŸå§‹æ¶ˆæ¯ æ•°æ®åº“ç»“æ„æ›´æ–° (db.js) æ·»åŠ äº†è½¬å‘æ¶ˆæ¯ç›¸å…³å­—æ®µï¼š is_forward: æ˜¯å¦ä¸ºè½¬å‘æ¶ˆæ¯ forward_from_chat_id: æ¥æºç¾¤ç»„ID forward_from_chat_title: æ¥æºç¾¤ç»„åç§° forward_from_chat_type: ç¾¤ç»„ç±»å‹ forward_from_chat_username: ç¾¤ç»„ç”¨æˆ·å forward_message_id: è½¬å‘æ¶ˆæ¯ID jump_link: è·³è½¬é“¾æ¥\nè½¬å‘æ¶ˆæ¯å¤„ç† (bot.js) ä¿å­˜ç¾¤ç»„ä¿¡æ¯ï¼šæ£€æµ‹è½¬å‘æ¶ˆæ¯å¹¶ä¿å­˜å®Œæ•´çš„ç¾¤ç»„ä¿¡æ¯ ç”Ÿæˆè·³è½¬é“¾æ¥ï¼š å…¬å¼€ç¾¤ç»„/é¢‘é“ï¼šhttps://t.me/{username}/{message_id} ç§æœ‰ç¾¤ç»„ï¼šhttps://t.me/c/{chat_id}/{message_id} æ˜¾ç¤ºæ¥æºï¼šåœ¨æ–‡ä»¶åˆ—è¡¨ä¸­æ˜¾ç¤ºæ¥æºç¾¤ç»„åç§°\næŒ‰é’®å¸ƒå±€æ›´æ–° å°†åŸæ¥çš„æŒ‰é’®å¸ƒå±€æ”¹ä¸ºï¼š\nâ„¹ï¸ è¯¦æƒ… - æŸ¥çœ‹æ–‡ä»¶è¯¦ç»†ä¿¡æ¯ âŒ åˆ é™¤ - åˆ é™¤æ–‡ä»¶ â¬‡ï¸ ä¸‹è½½ - ä¸‹è½½æ–‡ä»¶åˆ°æœåŠ¡å™¨æœ¬åœ° ğŸ”— è·³è½¬ - è·³è½¬åˆ°åŸå§‹æ¶ˆæ¯ï¼ˆä»…è½¬å‘æ¶ˆæ¯æ˜¾ç¤ºï¼‰\nè¯¦æƒ…é¡µé¢å¢å¼º æ˜¾ç¤ºæ˜¯å¦ä¸ºè½¬å‘æ¶ˆæ¯ æ˜¾ç¤ºæ¥æºç¾¤ç»„ä¿¡æ¯ æ˜¾ç¤ºç¾¤ç»„ç±»å‹ æ˜¾ç¤ºè·³è½¬é“¾æ¥\nè‡ªåŠ¨è¯†åˆ«å¹¶ä¿å­˜è½¬å‘çš„ç¾¤ç»„æ¶ˆæ¯ ä¸ºæ¯ä¸ªè½¬å‘æ¶ˆæ¯ç”Ÿæˆå¯ç‚¹å‡»çš„è·³è½¬é“¾æ¥ åœ¨æ–‡ä»¶åˆ—è¡¨ä¸­æ˜¾ç¤ºç»Ÿä¸€çš„å››ä¸ªæŒ‰é’®ï¼šè¯¦æƒ…ã€åˆ é™¤ã€ä¸‹è½½ã€è·³è½¬ åŒºåˆ†å…¬å¼€ç¾¤å’Œç§æœ‰ç¾¤ï¼Œç”Ÿæˆæ­£ç¡®çš„é“¾æ¥æ ¼å¼\n// é€šç”¨ä¿å­˜å‡½æ•° function saveFile(msg, fileId, fileName, type) { const userId = msg.from.id; const chatId = msg.chat.id; const category = userCategory[userId] || \"æœªåˆ†ç±»\"; // æ£€æŸ¥æ˜¯å¦ä¸ºè½¬å‘æ¶ˆæ¯ const isForward = msg.forward_from || msg.forward_from_chat; let forwardInfo = { is_forward: isForward ? 1 : 0, forward_from_chat_id: null, forward_from_chat_title: null, forward_from_chat_type: null, forward_from_chat_username: null, forward_message_id: null, jump_link: null }; if (isForward \u0026\u0026 msg.forward_from_chat) { const forwardChat = msg.forward_from_chat; forwardInfo.forward_from_chat_id = forwardChat.id; forwardInfo.forward_from_chat_title = forwardChat.title; forwardInfo.forward_from_chat_type = forwardChat.type; forwardInfo.forward_from_chat_username = forwardChat.username; forwardInfo.forward_message_id = msg.forward_from_message_id; // ç”Ÿæˆè·³è½¬é“¾æ¥ if (forwardChat.username) { // å…¬å¼€ç¾¤ç»„/é¢‘é“ forwardInfo.jump_link = `https://t.me/${forwardChat.username}/${msg.forward_from_message_id}`; } else { // ç§æœ‰ç¾¤ç»„ forwardInfo.jump_link = `https://t.me/c/${Math.abs(forwardChat.id).toString().substring(4)}/${msg.forward_from_message_id}`; } } db.run( `INSERT INTO files (file_id, file_name, category, user_id, date, is_forward, forward_from_chat_id, forward_from_chat_title, forward_from_chat_type, forward_from_chat_username, forward_message_id, jump_link) VALUES (?, ?, ?, ?, datetime('now'), ?, ?, ?, ?, ?, ?, ?)`, [fileId, fileName, category, userId, forwardInfo.is_forward, forwardInfo.forward_from_chat_id, forwardInfo.forward_from_chat_title, forwardInfo.forward_from_chat_type, forwardInfo.forward_from_chat_username, forwardInfo.forward_message_id, forwardInfo.jump_link], function (err) { if (err) { console.error(err); bot.sendMessage(chatId, \"âŒ å­˜å‚¨å¤±è´¥ã€‚\"); } else { let message = `ğŸ“¦ å·²ä¿å­˜ ${type}\\nID: ${this.lastID}\\næ–‡ä»¶å: ${fileName}\\nåˆ†ç±»: ${category}`; if (forwardInfo.is_forward \u0026\u0026 forwardInfo.forward_from_chat_title) { message += `\\næ¥æºç¾¤ç»„: ${forwardInfo.forward_from_chat_title}`; } bot.sendMessage(chatId, message); } } ); } bots https://github.com/AZeC4/TelegramBot\nhttps://github.com/itgoyo/TelegramBot\nhttps://github.com/itgoyo/TelegramGroup\nNext TGBOT LocalWeb Manage\ngo txt config æ–°å»º å›å¤ Q:A é€‚ç”¨äºç¾¤å›å¤\nåˆ†ç±» åˆ—è¡¨ å¯¹åº”åˆ†ç±» sqlå¤‡ä»½ å‰ç«¯åå°ç­‰\n","wordCount":"7956","inLanguage":"en","datePublished":"2025-08-26T22:51:47+08:00","dateModified":"2025-08-26T22:51:47+08:00","author":{"@type":"Person","name":"dwd"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://qfsyso.github.io/posts/node-tg-filebot/"},"publisher":{"@type":"Organization","name":"MLOG","logo":{"@type":"ImageObject","url":"https://qfsyso.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://qfsyso.github.io/ accesskey=h title="MLOG (Alt + H)">MLOG</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://qfsyso.github.io/posts/ title=Archive><span>Archive</span></a></li><li><a href=https://qfsyso.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://qfsyso.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Node TG FileBot</h1><div class=post-meta><span title='2025-08-26 22:51:47 +0800 +0800'>August 26, 2025</span>&nbsp;Â·&nbsp;38 min&nbsp;Â·&nbsp;dwd</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e5%8a%9f%e8%83%bd aria-label=åŠŸèƒ½>åŠŸèƒ½</a><ul><li><a href=#%e5%91%bd%e4%bb%a4 aria-label=å‘½ä»¤ï¼š>å‘½ä»¤ï¼š</a></li><li><a href=#%e6%8c%89%e9%92%ae%e6%93%8d%e4%bd%9c aria-label=æŒ‰é’®æ“ä½œï¼š>æŒ‰é’®æ“ä½œï¼š</a></li><li><a href=#%e6%96%87%e4%bb%b6%e5%ad%98%e5%82%a8 aria-label=æ–‡ä»¶å­˜å‚¨>æ–‡ä»¶å­˜å‚¨</a></li><li><a href=#%e4%be%9d%e8%b5%96 aria-label=ä¾èµ–>ä¾èµ–</a></li><li><a href=#%e9%a1%b9%e7%9b%ae%e7%9b%ae%e5%bd%95%e7%bb%93%e6%9e%84 aria-label=é¡¹ç›®ç›®å½•ç»“æ„>é¡¹ç›®ç›®å½•ç»“æ„</a></li><li><a href=#%e6%b3%a8%e6%84%8f%e4%ba%8b%e9%a1%b9 aria-label=æ³¨æ„äº‹é¡¹>æ³¨æ„äº‹é¡¹</a></li></ul></li><li><a href=#bot aria-label=Bot>Bot</a><ul><li><a href=#%e5%9c%a8-botfather-%e5%88%9b%e5%bb%ba%e6%9c%ba%e5%99%a8%e4%ba%ba aria-label="åœ¨ BotFather åˆ›å»ºæœºå™¨äºº">åœ¨ BotFather åˆ›å»ºæœºå™¨äºº</a></li><li><a href=#nodejs-%e9%a1%b9%e7%9b%ae%e5%88%9d%e5%a7%8b%e5%8c%96 aria-label="Node.js é¡¹ç›®åˆå§‹åŒ–">Node.js é¡¹ç›®åˆå§‹åŒ–</a></li><li><a href=#%e5%bb%ba-sqlite-%e6%95%b0%e6%8d%ae%e5%ba%93%e8%a1%a8 aria-label="å»º SQLite æ•°æ®åº“è¡¨">å»º SQLite æ•°æ®åº“è¡¨</a></li><li><a href=#bot-1 aria-label=bot>bot</a></li><li><a href=#run aria-label=run>run</a></li></ul></li><li><a href=#inline-keyboard----search aria-label="inline keyboard    search">inline keyboard search</a></li><li><a href=#pic-video aria-label="pic video">pic video</a></li><li><a href=#list aria-label=list>list</a></li><li><a href=#del aria-label=del>del</a></li><li><a href=#loacl-downloadfile aria-label="Loacl DownloadFile">Loacl DownloadFile</a></li><li><a href=#mv aria-label=Mv>Mv</a></li><li><a href=#configjs aria-label=config.js>config.js</a></li><li><a href=#login aria-label=login>login</a></li><li><a href=#list-detail aria-label="list detail">list detail</a></li><li><a href=#docker aria-label=Docker>Docker</a></li><li><a href=#%e5%8e%9f%e5%a7%8b%e6%b6%88%e6%81%af aria-label=åŸå§‹æ¶ˆæ¯>åŸå§‹æ¶ˆæ¯</a><ul><li><a href=#%e6%95%b0%e6%8d%ae%e5%ba%93%e7%bb%93%e6%9e%84%e6%9b%b4%e6%96%b0-dbjs aria-label="æ•°æ®åº“ç»“æ„æ›´æ–° (db.js)">æ•°æ®åº“ç»“æ„æ›´æ–° (db.js)</a></li><li><a href=#%e8%bd%ac%e5%8f%91%e6%b6%88%e6%81%af%e5%a4%84%e7%90%86-botjs aria-label="è½¬å‘æ¶ˆæ¯å¤„ç† (bot.js)">è½¬å‘æ¶ˆæ¯å¤„ç† (bot.js)</a></li><li><a href=#%e6%8c%89%e9%92%ae%e5%b8%83%e5%b1%80%e6%9b%b4%e6%96%b0 aria-label=æŒ‰é’®å¸ƒå±€æ›´æ–°>æŒ‰é’®å¸ƒå±€æ›´æ–°</a></li><li><a href=#%e8%af%a6%e6%83%85%e9%a1%b5%e9%9d%a2%e5%a2%9e%e5%bc%ba aria-label=è¯¦æƒ…é¡µé¢å¢å¼º>è¯¦æƒ…é¡µé¢å¢å¼º</a></li></ul></li><li><a href=#bots aria-label=bots>bots</a></li><li><a href=#next-tgbot aria-label="Next TGBOT">Next TGBOT</a></li></ul></div></details></div><div class=post-content><p>Node.js TG æ–‡ä»¶ç®¡ç†æœºå™¨äººï¼Œæ”¯æŒåˆ†ç±»å­˜å‚¨ã€åˆ†é¡µæµè§ˆã€æœç´¢ã€ä¸‹è½½ã€åˆ é™¤æ–‡ä»¶ï¼ŒåŒæ—¶æ”¯æŒå›¾ç‰‡ç¼©ç•¥å›¾é¢„è§ˆå’ŒæœåŠ¡å™¨æœ¬åœ°ä¸‹è½½ã€‚</p><h1 id=åŠŸèƒ½>åŠŸèƒ½<a hidden class=anchor aria-hidden=true href=#åŠŸèƒ½>#</a></h1><p>æ–‡ä»¶åˆ†ç±»ç®¡ç†ï¼šæ”¯æŒç”¨æˆ·è‡ªå®šä¹‰åˆ†ç±»ã€‚</p><p>æ–‡ä»¶ä¸Šä¼ è‡ªåŠ¨ä¿å­˜ï¼šæ”¯æŒæ–‡æ¡£ã€å›¾ç‰‡ã€è§†é¢‘ï¼Œå¹¶è®°å½•ä¸Šä¼ ç”¨æˆ·å’Œåˆ†ç±»ã€‚</p><p>åˆ†é¡µæŸ¥çœ‹æ–‡ä»¶åˆ—è¡¨ï¼šå¯åˆ†é¡µæ˜¾ç¤ºæœ€è¿‘ä¸Šä¼ çš„æ–‡ä»¶ã€‚</p><p>å›¾ç‰‡ç¼©ç•¥å›¾ï¼šåœ¨åˆ†é¡µåˆ—è¡¨ä¸­æ˜¾ç¤ºå›¾ç‰‡ç¼©ç•¥å›¾ã€‚</p><p>æ–‡ä»¶æœç´¢ï¼šæŒ‰æ–‡ä»¶åå…³é”®å­—æœç´¢æ–‡ä»¶ã€‚</p><p>è·å–æ–‡ä»¶ï¼šæ”¯æŒå‘é€æ–‡ä»¶å› Telegramã€‚</p><p>åˆ é™¤æ–‡ä»¶ï¼šæ”¯æŒå•ä¸ªæ–‡ä»¶åˆ é™¤ï¼Œå¸¦ç¡®è®¤æœºåˆ¶ã€‚</p><p>ä¸‹è½½åˆ°æœ¬åœ°ï¼šå°†æ–‡ä»¶ä¸‹è½½åˆ°æœåŠ¡å™¨æœ¬åœ°ï¼Œæ”¯æŒé‡è¯•å’Œé”™è¯¯æç¤ºã€‚</p><h2 id=å‘½ä»¤>å‘½ä»¤ï¼š<a hidden class=anchor aria-hidden=true href=#å‘½ä»¤>#</a></h2><p>/start # æ¬¢è¿ä¿¡æ¯å’Œæ“ä½œæç¤º
/setcategory # è®¾ç½®æ–‡ä»¶åˆ†ç±»
/myfiles # æŸ¥çœ‹æœ€è¿‘ 10 æ¡æ–‡ä»¶
/myfilelist [é¡µç ] # åˆ†é¡µæ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
/search å…³é”®å­— # æœç´¢æ–‡ä»¶
/getfile id # è·å–æ–‡ä»¶åˆ° Telegram
/delete id # åˆ é™¤æ–‡ä»¶</p><h2 id=æŒ‰é’®æ“ä½œ>æŒ‰é’®æ“ä½œï¼š<a hidden class=anchor aria-hidden=true href=#æŒ‰é’®æ“ä½œ>#</a></h2><p>åˆ†ç±»é€‰æ‹©ï¼šåœ¨ /setcategory åç‚¹å‡»æŒ‰é’®è®¾ç½®åˆ†ç±»ã€‚</p><p>åˆ é™¤æ–‡ä»¶ï¼šç‚¹å‡»â€œåˆ é™¤â€æŒ‰é’®ï¼Œå¸¦ç¡®è®¤æ“ä½œã€‚</p><p>ä¸‹è½½æ–‡ä»¶ï¼šç‚¹å‡»â€œä¸‹è½½æœ¬åœ°â€æŒ‰é’®ï¼Œå°†æ–‡ä»¶ä¸‹è½½åˆ°æœåŠ¡å™¨æœ¬åœ°ã€‚</p><p>åˆ†é¡µï¼šç‚¹å‡»ä¸Šä¸€é¡µ/ä¸‹ä¸€é¡µç¿»é¡µã€‚</p><h2 id=æ–‡ä»¶å­˜å‚¨>æ–‡ä»¶å­˜å‚¨<a hidden class=anchor aria-hidden=true href=#æ–‡ä»¶å­˜å‚¨>#</a></h2><p>é»˜è®¤æœ¬åœ°å­˜å‚¨ç›®å½•ï¼š./files/åˆ†ç±»å/æ–‡ä»¶å</p><p>æ”¯æŒè‡ªåŠ¨åˆ›å»ºåˆ†ç±»ç›®å½•ã€‚</p><p>å›¾ç‰‡ä¼šåœ¨åˆ†é¡µåˆ—è¡¨æ˜¾ç¤ºç¼©ç•¥å›¾ã€‚</p><p>é”™è¯¯å¤„ç†å’Œæ—¥å¿—</p><p>æ–‡ä»¶ä¸‹è½½æ”¯æŒ 3 æ¬¡é‡è¯•ï¼Œå¤±è´¥ä¼šè¾“å‡ºæ§åˆ¶å°æ—¥å¿—ã€‚</p><p>ç”¨æˆ·ç«¯æ”¶åˆ°å‹å¥½æç¤ºï¼Œä¸ä¼šå¯¼è‡´ bot å´©æ‰ã€‚</p><h2 id=ä¾èµ–>ä¾èµ–<a hidden class=anchor aria-hidden=true href=#ä¾èµ–>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>node-telegram-bot-api
</span></span><span style=display:flex><span>sqlite3
</span></span><span style=display:flex><span>axios
</span></span><span style=display:flex><span>Node.js &gt;<span style=color:#f92672>=</span> <span style=color:#ae81ff>16</span>
</span></span></code></pre></div><h2 id=é¡¹ç›®ç›®å½•ç»“æ„>é¡¹ç›®ç›®å½•ç»“æ„<a hidden class=anchor aria-hidden=true href=#é¡¹ç›®ç›®å½•ç»“æ„>#</a></h2><p>bot.js # ä¸»ç¨‹åº
db.js # SQLite æ•°æ®åº“å°è£…
files/ # æœ¬åœ°æ–‡ä»¶å­˜å‚¨ç›®å½•
node_modules/ # ä¾èµ–åº“
package.json</p><h2 id=æ³¨æ„äº‹é¡¹>æ³¨æ„äº‹é¡¹<a hidden class=anchor aria-hidden=true href=#æ³¨æ„äº‹é¡¹>#</a></h2><p>ç¡®ä¿æœåŠ¡å™¨å¯ä»¥è®¿é—® Telegram APIï¼ˆå›½å†…å¯èƒ½éœ€è¦ä»£ç†ï¼‰ã€‚</p><p>token å¿…é¡»æ­£ç¡®ï¼Œä¸” bot æœ‰æ–‡ä»¶è¯»å–æƒé™ã€‚</p><p>å›¾ç‰‡ç¼©ç•¥å›¾é€šè¿‡ Telegram sendMediaGroup å®ç°ï¼Œå…¶ä»–æ–‡ä»¶æ˜¾ç¤ºä¸ºæ–‡å­—åˆ—è¡¨ã€‚</p><p>ä¸‹è½½æ–‡ä»¶åˆ°æœ¬åœ°æ—¶ï¼Œå¦‚æœå¤±è´¥ä¼šé‡è¯• 3 æ¬¡å¹¶è®°å½•æ—¥å¿—ã€‚</p><h1 id=bot>Bot<a hidden class=anchor aria-hidden=true href=#bot>#</a></h1><h2 id=åœ¨-botfather-åˆ›å»ºæœºå™¨äºº>åœ¨ BotFather åˆ›å»ºæœºå™¨äºº<a hidden class=anchor aria-hidden=true href=#åœ¨-botfather-åˆ›å»ºæœºå™¨äºº>#</a></h2><p>æ‰“å¼€ TGï¼Œæœç´¢ BotFatherã€‚</p><p>è¾“å…¥ /startã€‚</p><p>è¾“å…¥ /newbot â†’ æŒ‰æç¤ºç»™æœºå™¨äººå–åå­—ï¼ˆä¾‹å¦‚ï¼šFileStorageBotï¼‰ã€‚</p><p>BotFather ä¼šè¿”å›ä¸€ä¸ª HTTP API Tokenï¼Œç±»ä¼¼ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>1234567890:ABCdefGhIjKlmNoPQRstuVWxyZ
</span></span></code></pre></div><p>è¿™ä¸ªå°±æ˜¯ Node.js ä»£ç é‡Œè¦ç”¨çš„ BOT_TOKENã€‚</p><h2 id=nodejs-é¡¹ç›®åˆå§‹åŒ–>Node.js é¡¹ç›®åˆå§‹åŒ–<a hidden class=anchor aria-hidden=true href=#nodejs-é¡¹ç›®åˆå§‹åŒ–>#</a></h2><p>åœ¨æœåŠ¡å™¨æˆ–æœ¬åœ°ç¯å¢ƒé‡Œæ‰§è¡Œï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir tg-file-storage-bot
</span></span><span style=display:flex><span>cd tg-file-storage-bot
</span></span><span style=display:flex><span>npm init -y
</span></span><span style=display:flex><span>npm install node-telegram-bot-api sqlite3
</span></span></code></pre></div><p>node-telegram-bot-api â†’ Telegram æœºå™¨äºº SDK</p><p>sqlite3 â†’ å­˜å‚¨æ–‡ä»¶ä¿¡æ¯ï¼ˆæ–‡ä»¶åˆ†ç±»ã€è·¯å¾„ç­‰ï¼‰</p><h2 id=å»º-sqlite-æ•°æ®åº“è¡¨>å»º SQLite æ•°æ®åº“è¡¨<a hidden class=anchor aria-hidden=true href=#å»º-sqlite-æ•°æ®åº“è¡¨>#</a></h2><p>æ–°å»ºä¸€ä¸ª db.jsï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>sqlite3</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;sqlite3&#39;</span>).<span style=color:#a6e22e>verbose</span>();
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>db</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>sqlite3</span>.<span style=color:#a6e22e>Database</span>(<span style=color:#e6db74>&#39;./files.db&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>serialize</span>(() =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>run</span>(<span style=color:#e6db74>`
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    CREATE TABLE IF NOT EXISTS files (
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      id INTEGER PRIMARY KEY AUTOINCREMENT,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      file_id TEXT,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      file_name TEXT,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      category TEXT,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      user_id TEXT,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      date DATETIME DEFAULT CURRENT_TIMESTAMP
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    )
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  `</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>db</span>;
</span></span></code></pre></div><h2 id=bot-1>bot<a hidden class=anchor aria-hidden=true href=#bot-1>#</a></h2><p>æ–°å»º bot.jsï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>TelegramBot</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;node-telegram-bot-api&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>db</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;./db&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;TOKEN&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>bot</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>TelegramBot</span>(<span style=color:#a6e22e>token</span>, { <span style=color:#a6e22e>polling</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ä¿å­˜åˆ†ç±»ä¿¡æ¯ï¼ˆç”¨æˆ· -&gt; å½“å‰é€‰æ‹©çš„åˆ†ç±»ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userCategory</span> <span style=color:#f92672>=</span> {};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /start å‘½ä»¤
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/start/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;æ¬¢è¿ä½¿ç”¨æ–‡ä»¶å­˜å‚¨æœºå™¨äººï¼\n\nå‘½ä»¤ï¼š\n/setcategory åˆ†ç±»å\n/myfiles æŸ¥çœ‹æˆ‘çš„æ–‡ä»¶&#34;</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// è®¾ç½®åˆ†ç±»
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/setcategory (.+)/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>category</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>userCategory</span>[<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>category</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>`âœ… å·²è®¾ç½®åˆ†ç±»ä¸ºï¼š</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\nè¯·ç›´æ¥å‘é€æ–‡ä»¶ï¼Œæˆ‘ä¼šå¸®å­˜å‚¨ã€‚`</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// æ¥æ”¶æ–‡ä»¶ï¼ˆæ–‡æ¡£ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;document&#34;</span>, <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.document.<span style=color:#a6e22e>file_id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileName</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.document.<span style=color:#a6e22e>file_name</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>category</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>userCategory</span>[<span style=color:#a6e22e>userId</span>] <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;æœªåˆ†ç±»&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>run</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`INSERT INTO files (file_id, file_name, category, user_id) VALUES (?, ?, ?, ?)`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#a6e22e>category</span>, <span style=color:#a6e22e>userId</span>],
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>err</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;âŒ å­˜å‚¨å¤±è´¥ã€‚&#34;</span>);
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>`ğŸ“‚ æ–‡ä»¶å·²ä¿å­˜ï¼š</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\nåˆ†ç±»ï¼š</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// æŸ¥çœ‹æ–‡ä»¶åˆ—è¡¨
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/myfiles/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>all</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT 10`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>userId</span>],
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>rows</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;âŒ æŸ¥è¯¢å¤±è´¥ã€‚&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;ğŸ“­ æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶ã€‚&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>text</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ğŸ“‚ æœ€è¿‘çš„æ–‡ä»¶ï¼š\n\n&#34;</span>;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>r</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>text</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74> [</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>]\n`</span>;
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>text</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// å›å¤ /getfile id æ¥å–å›æ–‡ä»¶
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/getfile (\d+)/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>`SELECT file_id, file_name FROM files WHERE id = ?`</span>, [<span style=color:#a6e22e>id</span>], (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>row</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>row</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;âŒ æ–‡ä»¶ä¸å­˜åœ¨ã€‚&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendDocument</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, {}, { <span style=color:#a6e22e>filename</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><h2 id=run>run<a hidden class=anchor aria-hidden=true href=#run>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>node bot.js
</span></span></code></pre></div><p>ç„¶ååœ¨ TG é‡Œæ‰“å¼€æœºå™¨äººï¼š</p><p>/setcategory å·¥ä½œèµ„æ–™ â†’ è®¾ç½®åˆ†ç±»</p><p>ä¸Šä¼ æ–‡ä»¶ï¼ˆæ–‡æ¡£ã€PDFã€Zip ç­‰ï¼‰</p><p>/myfiles â†’ æŸ¥çœ‹è‡ªå·±å­˜çš„æ–‡ä»¶</p><p>/getfile 1 â†’ è·å– ID=1 çš„æ–‡ä»¶</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>
</span></span><span style=display:flex><span>XXX, <span style=color:#f92672>[</span>2025/8/26 9:37<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>/start
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mybot1, <span style=color:#f92672>[</span>2025/8/26 9:37<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>æ¬¢è¿ä½¿ç”¨æ–‡ä»¶å­˜å‚¨æœºå™¨äººï¼
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>å‘½ä»¤ï¼š
</span></span><span style=display:flex><span>/setcategory åˆ†ç±»å
</span></span><span style=display:flex><span>/myfiles æŸ¥çœ‹æˆ‘çš„æ–‡ä»¶
</span></span></code></pre></div><h1 id=inline-keyboard----search>inline keyboard search<a hidden class=anchor aria-hidden=true href=#inline-keyboard----search>#</a></h1><p>æ–°å¢åˆ†ç±» æœç´¢</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>//bot.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>TelegramBot</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;node-telegram-bot-api&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>db</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;./db&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;XXXTOKEN&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>bot</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>TelegramBot</span>(<span style=color:#a6e22e>token</span>, { <span style=color:#a6e22e>polling</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ä¿å­˜åˆ†ç±»ä¿¡æ¯ï¼ˆç”¨æˆ· -&gt; å½“å‰é€‰æ‹©çš„åˆ†ç±»ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userCategory</span> <span style=color:#f92672>=</span> {};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// é¢„è®¾åˆ†ç±»
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>categories</span> <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;å·¥ä½œ&#34;</span>, <span style=color:#e6db74>&#34;å­¦ä¹ &#34;</span>, <span style=color:#e6db74>&#34;ç”Ÿæ´»&#34;</span>, <span style=color:#e6db74>&#34;å…¶ä»–&#34;</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /start å‘½ä»¤
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/start/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;æ¬¢è¿ä½¿ç”¨æ–‡ä»¶å­˜å‚¨æœºå™¨äººï¼\n\nå‘½ä»¤ï¼š\n/setcategory è®¾ç½®åˆ†ç±»\n/myfiles æŸ¥çœ‹æˆ‘çš„æ–‡ä»¶\n/search å…³é”®å­— æœç´¢æ–‡ä»¶\n/getfile id è·å–æ–‡ä»¶&#34;</span>
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /setcategory æ˜¾ç¤ºæŒ‰é’®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/setcategory/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>opts</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reply_markup</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>inline_keyboard</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>categories</span>.<span style=color:#a6e22e>map</span>((<span style=color:#a6e22e>c</span>) =&gt; [{ <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`cat_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>c</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> }]),
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;è¯·é€‰æ‹©åˆ†ç±»ï¼š&#34;</span>, <span style=color:#a6e22e>opts</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// å¤„ç†æŒ‰é’®ç‚¹å‡»
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;callback_query&#34;</span>, (<span style=color:#a6e22e>query</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>chatId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;cat_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>category</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;cat_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>userCategory</span>[<span style=color:#a6e22e>userId</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>category</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`âœ… å·²è®¾ç½®åˆ†ç±»ä¸ºï¼š</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>answerCallbackQuery</span>(<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>id</span>); <span style=color:#75715e>// æ”¶èµ·æŒ‰é’® loading
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// æ¥æ”¶æ–‡ä»¶
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;document&#34;</span>, <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.document.<span style=color:#a6e22e>file_id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileName</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.document.<span style=color:#a6e22e>file_name</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>category</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>userCategory</span>[<span style=color:#a6e22e>userId</span>] <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;æœªåˆ†ç±»&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>run</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`INSERT INTO files (file_id, file_name, category, user_id) VALUES (?, ?, ?, ?)`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#a6e22e>category</span>, <span style=color:#a6e22e>userId</span>],
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>err</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;âŒ å­˜å‚¨å¤±è´¥ã€‚&#34;</span>);
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>`ğŸ“‚ æ–‡ä»¶å·²ä¿å­˜ï¼š</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\nåˆ†ç±»ï¼š</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// æŸ¥çœ‹æ–‡ä»¶åˆ—è¡¨
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/myfiles/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>all</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT 10`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>userId</span>],
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>rows</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;âŒ æŸ¥è¯¢å¤±è´¥ã€‚&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;ğŸ“­ æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶ã€‚&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>text</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ğŸ“‚ æœ€è¿‘çš„æ–‡ä»¶ï¼š\n\n&#34;</span>;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>r</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>text</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74> [</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>]\n`</span>;
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>text</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// æœç´¢æ–‡ä»¶
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/search (.+)/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>keyword</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`%</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>%`</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>all</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT id, file_name, category FROM files WHERE user_id = ? AND file_name LIKE ? ORDER BY date DESC LIMIT 10`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>userId</span>, <span style=color:#a6e22e>keyword</span>],
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>rows</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;âŒ æŸ¥è¯¢å¤±è´¥ã€‚&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;ğŸ” æ²¡æœ‰åŒ¹é…çš„æ–‡ä»¶ã€‚&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>text</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`ğŸ” æœç´¢ç»“æœï¼š\n\n`</span>;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>r</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>text</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74> [</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>]\n`</span>;
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>text</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// å›å¤ /getfile id æ¥å–å›æ–‡ä»¶
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/getfile (\d+)/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>get</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT file_id, file_name FROM files WHERE id = ?`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>id</span>],
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>row</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>row</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;âŒ æ–‡ä»¶ä¸å­˜åœ¨ã€‚&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendDocument</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, {}, { <span style=color:#a6e22e>filename</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>
</span></span><span style=display:flex><span>XXX, <span style=color:#f92672>[</span>2025/8/26 9:37<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>/start
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mybot1, <span style=color:#f92672>[</span>2025/8/26 9:37<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>æ¬¢è¿ä½¿ç”¨æ–‡ä»¶å­˜å‚¨æœºå™¨äººï¼
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>å‘½ä»¤ï¼š
</span></span><span style=display:flex><span>/setcategory åˆ†ç±»å
</span></span><span style=display:flex><span>/myfiles æŸ¥çœ‹æˆ‘çš„æ–‡ä»¶
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>XXX, <span style=color:#f92672>[</span>2025/8/26 9:43<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>/start
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mybot1, <span style=color:#f92672>[</span>2025/8/26 9:43<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>æ¬¢è¿ä½¿ç”¨æ–‡ä»¶å­˜å‚¨æœºå™¨äººï¼
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>å‘½ä»¤ï¼š
</span></span><span style=display:flex><span>/setcategory è®¾ç½®åˆ†ç±»
</span></span><span style=display:flex><span>/myfiles æŸ¥çœ‹æˆ‘çš„æ–‡ä»¶
</span></span><span style=display:flex><span>/search å…³é”®å­— æœç´¢æ–‡ä»¶
</span></span><span style=display:flex><span>/getfile id è·å–æ–‡ä»¶
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>XXX, <span style=color:#f92672>[</span>2025/8/26 9:43<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>/setcategory
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mybot1, <span style=color:#f92672>[</span>2025/8/26 9:43<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>è¯·é€‰æ‹©åˆ†ç±»ï¼š
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mybot1, <span style=color:#f92672>[</span>2025/8/26 9:43<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>âœ… å·²è®¾ç½®åˆ†ç±»ä¸ºï¼šå…¶ä»–
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mybot1, <span style=color:#f92672>[</span>2025/8/26 9:45<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>ğŸ“‚ æ–‡ä»¶å·²ä¿å­˜ï¼šttsbot.zip
</span></span><span style=display:flex><span>åˆ†ç±»ï¼šå…¶ä»–
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>XXX, <span style=color:#f92672>[</span>2025/8/26 9:46<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>/search tts
</span></span></code></pre></div><h1 id=pic-video>pic video<a hidden class=anchor aria-hidden=true href=#pic-video>#</a></h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>//bot.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>TelegramBot</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;node-telegram-bot-api&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>db</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;./db&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;XXXTOKEN&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>bot</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>TelegramBot</span>(<span style=color:#a6e22e>token</span>, { <span style=color:#a6e22e>polling</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ä¿å­˜åˆ†ç±»ä¿¡æ¯ï¼ˆç”¨æˆ· -&gt; å½“å‰é€‰æ‹©çš„åˆ†ç±»ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userCategory</span> <span style=color:#f92672>=</span> {};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// é¢„è®¾åˆ†ç±»
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>categories</span> <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;å·¥ä½œ&#34;</span>, <span style=color:#e6db74>&#34;å­¦ä¹ &#34;</span>, <span style=color:#e6db74>&#34;ç”Ÿæ´»&#34;</span>, <span style=color:#e6db74>&#34;å…¶ä»–&#34;</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /start å‘½ä»¤
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/start/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;æ¬¢è¿ä½¿ç”¨æ–‡ä»¶å­˜å‚¨æœºå™¨äººï¼\n\nå‘½ä»¤ï¼š\n/setcategory è®¾ç½®åˆ†ç±»\n/myfiles æŸ¥çœ‹æ–‡ä»¶\n/search å…³é”®å­— æœç´¢æ–‡ä»¶\n/getfile id è·å–æ–‡ä»¶&#34;</span>
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /setcategory æ˜¾ç¤ºæŒ‰é’®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/setcategory/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>opts</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reply_markup</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>inline_keyboard</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>categories</span>.<span style=color:#a6e22e>map</span>((<span style=color:#a6e22e>c</span>) =&gt; [{ <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`cat_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>c</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> }]),
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;è¯·é€‰æ‹©åˆ†ç±»ï¼š&#34;</span>, <span style=color:#a6e22e>opts</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// å¤„ç†æŒ‰é’®ç‚¹å‡»
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;callback_query&#34;</span>, (<span style=color:#a6e22e>query</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>chatId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;cat_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>category</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;cat_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>userCategory</span>[<span style=color:#a6e22e>userId</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>category</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`âœ… å·²è®¾ç½®åˆ†ç±»ä¸ºï¼š</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>answerCallbackQuery</span>(<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>id</span>); <span style=color:#75715e>// æ”¶èµ·æŒ‰é’® loading
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// é€šç”¨ä¿å­˜å‡½æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#a6e22e>type</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>chatId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>category</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>userCategory</span>[<span style=color:#a6e22e>userId</span>] <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;æœªåˆ†ç±»&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>run</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`INSERT INTO files (file_id, file_name, category, user_id) VALUES (?, ?, ?, ?)`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#a6e22e>category</span>, <span style=color:#a6e22e>userId</span>],
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;âŒ å­˜å‚¨å¤±è´¥ã€‚&#34;</span>);
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>chatId</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>`ğŸ“¦ å·²ä¿å­˜ </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>type</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\nID: </span><span style=color:#e6db74>${</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>lastID</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\næ–‡ä»¶å: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\nåˆ†ç±»: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ç›‘å¬æ–‡æ¡£ï¼ˆPDF, ZIP ç­‰ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;document&#34;</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.document.<span style=color:#a6e22e>file_id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileName</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.document.<span style=color:#a6e22e>file_name</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#e6db74>&#34;æ–‡æ¡£&#34;</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ç›‘å¬å›¾ç‰‡ï¼ˆåŒ…æ‹¬è½¬å‘çš„ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;photo&#34;</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// photo æ˜¯æ•°ç»„ï¼Œé€‰æœ€é«˜åˆ†è¾¨ç‡çš„
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>photo</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>photo</span>[<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>photo</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>photo</span>.<span style=color:#a6e22e>file_id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileName</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`photo_</span><span style=color:#e6db74>${</span>Date.<span style=color:#a6e22e>now</span>()<span style=color:#e6db74>}</span><span style=color:#e6db74>.jpg`</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#e6db74>&#34;å›¾ç‰‡&#34;</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ç›‘å¬è§†é¢‘ï¼ˆåŒ…æ‹¬è½¬å‘çš„ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;video&#34;</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>video</span>.<span style=color:#a6e22e>file_id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileName</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>video</span>.<span style=color:#a6e22e>file_name</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>`video_</span><span style=color:#e6db74>${</span>Date.<span style=color:#a6e22e>now</span>()<span style=color:#e6db74>}</span><span style=color:#e6db74>.mp4`</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#e6db74>&#34;è§†é¢‘&#34;</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// æŸ¥çœ‹æ–‡ä»¶åˆ—è¡¨
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/myfiles/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>all</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT 10`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>userId</span>],
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>rows</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;âŒ æŸ¥è¯¢å¤±è´¥ã€‚&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;ğŸ“­ æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶ã€‚&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>text</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ğŸ“‚ æœ€è¿‘çš„æ–‡ä»¶ï¼š\n\n&#34;</span>;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>r</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>text</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74> [</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>]\n`</span>;
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>text</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// æœç´¢æ–‡ä»¶
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/search (.+)/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>keyword</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`%</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>%`</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>all</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT id, file_name, category FROM files WHERE user_id = ? AND file_name LIKE ? ORDER BY date DESC LIMIT 10`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>userId</span>, <span style=color:#a6e22e>keyword</span>],
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>rows</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;âŒ æŸ¥è¯¢å¤±è´¥ã€‚&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;ğŸ” æ²¡æœ‰åŒ¹é…çš„æ–‡ä»¶ã€‚&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>text</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`ğŸ” æœç´¢ç»“æœï¼š\n\n`</span>;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>r</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>text</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74> [</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>]\n`</span>;
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>text</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// å›å¤ /getfile id æ¥å–å›æ–‡ä»¶
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/getfile (\d+)/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>get</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT file_id, file_name FROM files WHERE id = ?`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>id</span>],
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>row</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>row</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;âŒ æ–‡ä»¶ä¸å­˜åœ¨ã€‚&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// æ ¹æ®æ‰©å±•åç±»å‹å‘é€ä¸åŒæ¶ˆæ¯
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.jpg&#34;</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendPhoto</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, { <span style=color:#a6e22e>caption</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.mp4&#34;</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendVideo</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, { <span style=color:#a6e22e>caption</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendDocument</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, {}, { <span style=color:#a6e22e>filename</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><h1 id=list>list<a hidden class=anchor aria-hidden=true href=#list>#</a></h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-JS data-lang=JS><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>TelegramBot</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;node-telegram-bot-api&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>db</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;./db&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;XXXTOKEN&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>bot</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>TelegramBot</span>(<span style=color:#a6e22e>token</span>, { <span style=color:#a6e22e>polling</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ä¿å­˜åˆ†ç±»ä¿¡æ¯ï¼ˆç”¨æˆ· -&gt; å½“å‰é€‰æ‹©çš„åˆ†ç±»ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userCategory</span> <span style=color:#f92672>=</span> {};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// é¢„è®¾åˆ†ç±»
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>categories</span> <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;å·¥ä½œ&#34;</span>, <span style=color:#e6db74>&#34;å­¦ä¹ &#34;</span>, <span style=color:#e6db74>&#34;ç”Ÿæ´»&#34;</span>, <span style=color:#e6db74>&#34;å…¶ä»–&#34;</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// æ¯é¡µæ˜¾ç¤ºæ¡æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>PAGE_SIZE</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /start å‘½ä»¤
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/start/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;æ¬¢è¿ä½¿ç”¨æ–‡ä»¶å­˜å‚¨æœºå™¨äººï¼\n\nå‘½ä»¤ï¼š\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/setcategory è®¾ç½®åˆ†ç±»\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/myfiles æŸ¥çœ‹æœ€è¿‘æ–‡ä»¶(æ–‡å­—åˆ—è¡¨)\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/myfilelist [é¡µç ] æ–‡ä»¶é¢„è§ˆåˆ†é¡µ\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/search å…³é”®å­— æœç´¢æ–‡ä»¶\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/getfile id è·å–æ–‡ä»¶&#34;</span>
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /setcategory æ˜¾ç¤ºæŒ‰é’®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/setcategory/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>opts</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reply_markup</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>inline_keyboard</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>categories</span>.<span style=color:#a6e22e>map</span>((<span style=color:#a6e22e>c</span>) =&gt; [{ <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`cat_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>c</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> }]),
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;è¯·é€‰æ‹©åˆ†ç±»ï¼š&#34;</span>, <span style=color:#a6e22e>opts</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// å¤„ç†æŒ‰é’®ç‚¹å‡»
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;callback_query&#34;</span>, (<span style=color:#a6e22e>query</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>chatId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;cat_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>category</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;cat_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>userCategory</span>[<span style=color:#a6e22e>userId</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>category</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`âœ… å·²è®¾ç½®åˆ†ç±»ä¸ºï¼š</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>answerCallbackQuery</span>(<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>id</span>); <span style=color:#75715e>// æ”¶èµ·æŒ‰é’® loading
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// é€šç”¨ä¿å­˜å‡½æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#a6e22e>type</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>chatId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>category</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>userCategory</span>[<span style=color:#a6e22e>userId</span>] <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;æœªåˆ†ç±»&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>run</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`INSERT INTO files (file_id, file_name, category, user_id) VALUES (?, ?, ?, ?)`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#a6e22e>category</span>, <span style=color:#a6e22e>userId</span>],
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;âŒ å­˜å‚¨å¤±è´¥ã€‚&#34;</span>);
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>chatId</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>`ğŸ“¦ å·²ä¿å­˜ </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>type</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\nID: </span><span style=color:#e6db74>${</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>lastID</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\næ–‡ä»¶å: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\nåˆ†ç±»: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ç›‘å¬æ–‡æ¡£
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;document&#34;</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.document.<span style=color:#a6e22e>file_id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileName</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.document.<span style=color:#a6e22e>file_name</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#e6db74>&#34;æ–‡æ¡£&#34;</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ç›‘å¬å›¾ç‰‡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;photo&#34;</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>photo</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>photo</span>[<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>photo</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>photo</span>.<span style=color:#a6e22e>file_id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileName</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`photo_</span><span style=color:#e6db74>${</span>Date.<span style=color:#a6e22e>now</span>()<span style=color:#e6db74>}</span><span style=color:#e6db74>.jpg`</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#e6db74>&#34;å›¾ç‰‡&#34;</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ç›‘å¬è§†é¢‘
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;video&#34;</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>video</span>.<span style=color:#a6e22e>file_id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileName</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>video</span>.<span style=color:#a6e22e>file_name</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>`video_</span><span style=color:#e6db74>${</span>Date.<span style=color:#a6e22e>now</span>()<span style=color:#e6db74>}</span><span style=color:#e6db74>.mp4`</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#e6db74>&#34;è§†é¢‘&#34;</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /myfiles æ–‡æœ¬åˆ—è¡¨
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/myfiles/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>all</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT 10`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>userId</span>],
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>rows</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;âŒ æŸ¥è¯¢å¤±è´¥ã€‚&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;ğŸ“­ æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶ã€‚&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>text</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ğŸ“‚ æœ€è¿‘çš„æ–‡ä»¶ï¼š\n\n&#34;</span>;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>r</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>text</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74> [</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>]\n`</span>;
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>text</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /myfilelist [é¡µç ] æ–‡ä»¶é¢„è§ˆåˆ†é¡µ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/myfilelist ?(\d+)?/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>page</span> <span style=color:#f92672>=</span> parseInt(<span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>]) <span style=color:#f92672>||</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>offset</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>page</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>*</span> <span style=color:#a6e22e>PAGE_SIZE</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>all</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT id, file_id, file_name, category 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     FROM files WHERE user_id = ? ORDER BY date DESC LIMIT ? OFFSET ?`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>userId</span>, <span style=color:#a6e22e>PAGE_SIZE</span>, <span style=color:#a6e22e>offset</span>],
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>rows</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;âŒ æŸ¥è¯¢å¤±è´¥ã€‚&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;ğŸ“­ æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶ã€‚&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>`ğŸ“‘ ç¬¬ </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>page</span><span style=color:#e6db74>}</span><span style=color:#e6db74> é¡µï¼ˆæ¯é¡µ </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>PAGE_SIZE</span><span style=color:#e6db74>}</span><span style=color:#e6db74> æ¡ï¼‰`</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>r</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>rows</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>caption</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\nåˆ†ç±»ï¼š</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.jpg&#34;</span>)) {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendPhoto</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_id</span>, { <span style=color:#a6e22e>caption</span> });
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.mp4&#34;</span>)) {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendVideo</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_id</span>, { <span style=color:#a6e22e>caption</span> });
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendDocument</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_id</span>, {}, { <span style=color:#a6e22e>filename</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>caption</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /search å…³é”®å­—
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/search (.+)/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>keyword</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`%</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>%`</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>all</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT id, file_name, category FROM files WHERE user_id = ? AND file_name LIKE ? ORDER BY date DESC LIMIT 10`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>userId</span>, <span style=color:#a6e22e>keyword</span>],
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>rows</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;âŒ æŸ¥è¯¢å¤±è´¥ã€‚&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;ğŸ” æ²¡æœ‰åŒ¹é…çš„æ–‡ä»¶ã€‚&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>text</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`ğŸ” æœç´¢ç»“æœï¼š\n\n`</span>;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>r</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>text</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74> [</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>]\n`</span>;
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>text</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /getfile id
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/getfile (\d+)/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>get</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT file_id, file_name FROM files WHERE id = ?`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>id</span>],
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>row</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>row</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;âŒ æ–‡ä»¶ä¸å­˜åœ¨ã€‚&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.jpg&#34;</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendPhoto</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, { <span style=color:#a6e22e>caption</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.mp4&#34;</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendVideo</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, { <span style=color:#a6e22e>caption</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendDocument</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, {}, { <span style=color:#a6e22e>filename</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><h1 id=del>del<a hidden class=anchor aria-hidden=true href=#del>#</a></h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>//bot
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>TelegramBot</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;node-telegram-bot-api&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>db</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;./db&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;XXXTOKEN&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>bot</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>TelegramBot</span>(<span style=color:#a6e22e>token</span>, { <span style=color:#a6e22e>polling</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ä¿å­˜åˆ†ç±»ä¿¡æ¯ï¼ˆç”¨æˆ· -&gt; å½“å‰é€‰æ‹©çš„åˆ†ç±»ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userCategory</span> <span style=color:#f92672>=</span> {};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// é¢„è®¾åˆ†ç±»
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>categories</span> <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;å·¥ä½œ&#34;</span>, <span style=color:#e6db74>&#34;å­¦ä¹ &#34;</span>, <span style=color:#e6db74>&#34;ç”Ÿæ´»&#34;</span>, <span style=color:#e6db74>&#34;å…¶ä»–&#34;</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// æ¯é¡µæ˜¾ç¤ºæ¡æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>PAGE_SIZE</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /start å‘½ä»¤
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/start/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;æ¬¢è¿ä½¿ç”¨æ–‡ä»¶å­˜å‚¨æœºå™¨äººï¼\n\nå‘½ä»¤ï¼š\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/setcategory è®¾ç½®åˆ†ç±»\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/myfiles æŸ¥çœ‹æœ€è¿‘æ–‡ä»¶(æ–‡å­—åˆ—è¡¨)\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/myfilelist [é¡µç ] æ–‡ä»¶é¢„è§ˆåˆ†é¡µ\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/search å…³é”®å­— æœç´¢æ–‡ä»¶\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/getfile id è·å–æ–‡ä»¶\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/delete id åˆ é™¤æ–‡ä»¶&#34;</span>
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /setcategory æ˜¾ç¤ºæŒ‰é’®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/setcategory/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>opts</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reply_markup</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>inline_keyboard</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>categories</span>.<span style=color:#a6e22e>map</span>((<span style=color:#a6e22e>c</span>) =&gt; [{ <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`cat_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>c</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> }]),
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;è¯·é€‰æ‹©åˆ†ç±»ï¼š&#34;</span>, <span style=color:#a6e22e>opts</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// é€šç”¨ä¿å­˜å‡½æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#a6e22e>type</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>chatId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>category</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>userCategory</span>[<span style=color:#a6e22e>userId</span>] <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;æœªåˆ†ç±»&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>run</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`INSERT INTO files (file_id, file_name, category, user_id) VALUES (?, ?, ?, ?)`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#a6e22e>category</span>, <span style=color:#a6e22e>userId</span>],
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;âŒ å­˜å‚¨å¤±è´¥ã€‚&#34;</span>);
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>chatId</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>`ğŸ“¦ å·²ä¿å­˜ </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>type</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\nID: </span><span style=color:#e6db74>${</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>lastID</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\næ–‡ä»¶å: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\nåˆ†ç±»: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ç›‘å¬æ–‡æ¡£
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;document&#34;</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.document.<span style=color:#a6e22e>file_id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileName</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.document.<span style=color:#a6e22e>file_name</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#e6db74>&#34;æ–‡æ¡£&#34;</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ç›‘å¬å›¾ç‰‡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;photo&#34;</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>photo</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>photo</span>[<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>photo</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>photo</span>.<span style=color:#a6e22e>file_id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileName</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`photo_</span><span style=color:#e6db74>${</span>Date.<span style=color:#a6e22e>now</span>()<span style=color:#e6db74>}</span><span style=color:#e6db74>.jpg`</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#e6db74>&#34;å›¾ç‰‡&#34;</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ç›‘å¬è§†é¢‘
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;video&#34;</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>video</span>.<span style=color:#a6e22e>file_id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileName</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>video</span>.<span style=color:#a6e22e>file_name</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>`video_</span><span style=color:#e6db74>${</span>Date.<span style=color:#a6e22e>now</span>()<span style=color:#e6db74>}</span><span style=color:#e6db74>.mp4`</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#e6db74>&#34;è§†é¢‘&#34;</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /myfiles æ–‡æœ¬åˆ—è¡¨
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/myfiles/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>all</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT 10`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>userId</span>],
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>rows</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;âŒ æŸ¥è¯¢å¤±è´¥ã€‚&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;ğŸ“­ æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶ã€‚&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>text</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ğŸ“‚ æœ€è¿‘çš„æ–‡ä»¶ï¼š\n\n&#34;</span>;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>r</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>text</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74> [</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>]\n`</span>;
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>text</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /myfilelist [é¡µç ] æ–‡ä»¶é¢„è§ˆåˆ†é¡µ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/myfilelist ?(\d+)?/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>page</span> <span style=color:#f92672>=</span> parseInt(<span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>]) <span style=color:#f92672>||</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>offset</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>page</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>*</span> <span style=color:#a6e22e>PAGE_SIZE</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>all</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT id, file_id, file_name, category 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     FROM files WHERE user_id = ? ORDER BY date DESC LIMIT ? OFFSET ?`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>userId</span>, <span style=color:#a6e22e>PAGE_SIZE</span>, <span style=color:#a6e22e>offset</span>],
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>rows</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;âŒ æŸ¥è¯¢å¤±è´¥ã€‚&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;ğŸ“­ æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶ã€‚&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>`ğŸ“‘ ç¬¬ </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>page</span><span style=color:#e6db74>}</span><span style=color:#e6db74> é¡µï¼ˆæ¯é¡µ </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>PAGE_SIZE</span><span style=color:#e6db74>}</span><span style=color:#e6db74> æ¡ï¼‰`</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>r</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>rows</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>caption</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\nåˆ†ç±»ï¼š</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>opts</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>reply_markup</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>inline_keyboard</span><span style=color:#f92672>:</span> [[{ <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;âŒ åˆ é™¤&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`del_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> }]],
</span></span><span style=display:flex><span>          },
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.jpg&#34;</span>)) {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendPhoto</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_id</span>, { <span style=color:#a6e22e>caption</span>, ...<span style=color:#a6e22e>opts</span> });
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.mp4&#34;</span>)) {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendVideo</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_id</span>, { <span style=color:#a6e22e>caption</span>, ...<span style=color:#a6e22e>opts</span> });
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendDocument</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_id</span>, {}, { <span style=color:#a6e22e>filename</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>caption</span>, <span style=color:#a6e22e>opts</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /search å…³é”®å­—
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/search (.+)/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>keyword</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`%</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>%`</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>all</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT id, file_name, category FROM files WHERE user_id = ? AND file_name LIKE ? ORDER BY date DESC LIMIT 10`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>userId</span>, <span style=color:#a6e22e>keyword</span>],
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>rows</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;âŒ æŸ¥è¯¢å¤±è´¥ã€‚&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;ğŸ” æ²¡æœ‰åŒ¹é…çš„æ–‡ä»¶ã€‚&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>text</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`ğŸ” æœç´¢ç»“æœï¼š\n\n`</span>;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>r</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>text</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74> [</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>]\n`</span>;
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>text</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /getfile id
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/getfile (\d+)/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>get</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT file_id, file_name FROM files WHERE id = ?`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>id</span>],
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>row</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>row</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;âŒ æ–‡ä»¶ä¸å­˜åœ¨ã€‚&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.jpg&#34;</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendPhoto</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, { <span style=color:#a6e22e>caption</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.mp4&#34;</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendVideo</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, { <span style=color:#a6e22e>caption</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendDocument</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, {}, { <span style=color:#a6e22e>filename</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /delete id å‘½ä»¤åˆ é™¤
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/delete (\d+)/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>run</span>(<span style=color:#e6db74>`DELETE FROM files WHERE id = ? AND user_id = ?`</span>, [<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>userId</span>], <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;âŒ åˆ é™¤å¤±è´¥ã€‚&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>changes</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;âš ï¸ æ²¡æ‰¾åˆ°è¯¥æ–‡ä»¶æˆ–æ— æƒé™åˆ é™¤ã€‚&#34;</span>);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>`âœ… æ–‡ä»¶(ID=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>) å·²åˆ é™¤ã€‚`</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// callback_query ç»Ÿä¸€å¤„ç†
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;callback_query&#34;</span>, (<span style=color:#a6e22e>query</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>chatId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// åˆ†ç±»æŒ‰é’®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;cat_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>category</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;cat_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>userCategory</span>[<span style=color:#a6e22e>userId</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>category</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`âœ… å·²è®¾ç½®åˆ†ç±»ä¸ºï¼š</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// åˆ é™¤æŒ‰é’®ï¼ˆç¬¬ä¸€æ­¥ï¼šå¼¹å‡ºç¡®è®¤ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;del_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;del_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>confirmOpts</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>reply_markup</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>inline_keyboard</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>          [
</span></span><span style=display:flex><span>            { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;âœ… ç¡®è®¤åˆ é™¤&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`confirmdel_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>            { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;âŒ å–æ¶ˆ&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`cancel_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>          ],
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`âš ï¸ ç¡®è®¤è¦åˆ é™¤æ–‡ä»¶(ID=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>)å—ï¼Ÿ`</span>, <span style=color:#a6e22e>confirmOpts</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ç¡®è®¤åˆ é™¤ï¼ˆç¬¬äºŒæ­¥ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;confirmdel_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;confirmdel_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>run</span>(
</span></span><span style=display:flex><span>      <span style=color:#e6db74>`DELETE FROM files WHERE id = ? AND user_id = ?`</span>,
</span></span><span style=display:flex><span>      [<span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>userId</span>],
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;âŒ åˆ é™¤å¤±è´¥ã€‚&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>changes</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;âš ï¸ æ²¡æ‰¾åˆ°è¯¥æ–‡ä»¶æˆ–æ— æƒé™åˆ é™¤ã€‚&#34;</span>);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`âœ… æ–‡ä»¶(ID=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>) å·²åˆ é™¤ã€‚`</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// å–æ¶ˆåˆ é™¤
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;cancel_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;cancel_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`â å·²å–æ¶ˆåˆ é™¤æ–‡ä»¶(ID=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>)ã€‚`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>answerCallbackQuery</span>(<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>id</span>);
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><h1 id=loacl-downloadfile>Loacl DownloadFile<a hidden class=anchor aria-hidden=true href=#loacl-downloadfile>#</a></h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>TelegramBot</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;node-telegram-bot-api&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>db</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;./db&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fs</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;fs&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>path</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;path&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>axios</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;axios&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;TKTKg&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>bot</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>TelegramBot</span>(<span style=color:#a6e22e>token</span>, { <span style=color:#a6e22e>polling</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ä¿å­˜åˆ†ç±»ä¿¡æ¯ï¼ˆç”¨æˆ· -&gt; å½“å‰é€‰æ‹©çš„åˆ†ç±»ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userCategory</span> <span style=color:#f92672>=</span> {};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// é¢„è®¾åˆ†ç±»
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>categories</span> <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;work&#34;</span>, <span style=color:#e6db74>&#34;study&#34;</span>, <span style=color:#e6db74>&#34;life&#34;</span>, <span style=color:#e6db74>&#34;other&#34;</span>,<span style=color:#e6db74>&#34;yo&#34;</span>,<span style=color:#e6db74>&#34;yo2&#34;</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// æ¯é¡µæ˜¾ç¤ºæ¡æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>PAGE_SIZE</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// æœ¬åœ°å­˜å‚¨æ ¹ç›®å½•
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>STORAGE_DIR</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>join</span>(<span style=color:#a6e22e>__dirname</span>, <span style=color:#e6db74>&#34;files&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>existsSync</span>(<span style=color:#a6e22e>STORAGE_DIR</span>)) <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>mkdirSync</span>(<span style=color:#a6e22e>STORAGE_DIR</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /start å‘½ä»¤
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/start/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;æ¬¢è¿ä½¿ç”¨æ–‡ä»¶å­˜å‚¨æœºå™¨äººï¼\n\nå‘½ä»¤ï¼š\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/setcategory è®¾ç½®åˆ†ç±»\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/myfiles æŸ¥çœ‹æœ€è¿‘æ–‡ä»¶(æ–‡å­—åˆ—è¡¨)\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/myfilelist [é¡µç ] æ–‡ä»¶é¢„è§ˆåˆ†é¡µ\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/search å…³é”®å­— æœç´¢æ–‡ä»¶\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/getfile id è·å–æ–‡ä»¶\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/delete id åˆ é™¤æ–‡ä»¶\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;ğŸ“¥ ç‚¹å‡»æ–‡ä»¶åçš„â€œä¸‹è½½æœ¬åœ°â€æŒ‰é’®å¯ä¿å­˜åˆ°æœåŠ¡å™¨æœ¬åœ°&#34;</span>
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /setcategory æ˜¾ç¤ºæŒ‰é’®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/setcategory/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>opts</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reply_markup</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>inline_keyboard</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>categories</span>.<span style=color:#a6e22e>map</span>((<span style=color:#a6e22e>c</span>) =&gt; [{ <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`cat_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>c</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> }]),
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;è¯·é€‰æ‹©åˆ†ç±»ï¼š&#34;</span>, <span style=color:#a6e22e>opts</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// é€šç”¨ä¿å­˜å‡½æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#a6e22e>type</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>chatId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>category</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>userCategory</span>[<span style=color:#a6e22e>userId</span>] <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;æœªåˆ†ç±»&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>run</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`INSERT INTO files (file_id, file_name, category, user_id) VALUES (?, ?, ?, ?)`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#a6e22e>category</span>, <span style=color:#a6e22e>userId</span>],
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;âŒ å­˜å‚¨å¤±è´¥ã€‚&#34;</span>);
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>chatId</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>`ğŸ“¦ å·²ä¿å­˜ </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>type</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\nID: </span><span style=color:#e6db74>${</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>lastID</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\næ–‡ä»¶å: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\nåˆ†ç±»: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ä¸‹è½½æ–‡ä»¶åˆ°æœ¬åœ°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>downloadFile</span>(<span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#a6e22e>category</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>url</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>getFileLink</span>(<span style=color:#a6e22e>fileId</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>dir</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>join</span>(<span style=color:#a6e22e>STORAGE_DIR</span>, <span style=color:#a6e22e>category</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>existsSync</span>(<span style=color:#a6e22e>dir</span>)) <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>mkdirSync</span>(<span style=color:#a6e22e>dir</span>, { <span style=color:#a6e22e>recursive</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> });
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>filePath</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>join</span>(<span style=color:#a6e22e>dir</span>, <span style=color:#a6e22e>fileName</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>writer</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>createWriteStream</span>(<span style=color:#a6e22e>filePath</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>axios</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>url</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>method</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;GET&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>responseType</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;stream&#39;</span>
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>pipe</span>(<span style=color:#a6e22e>writer</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Promise((<span style=color:#a6e22e>resolve</span>, <span style=color:#a6e22e>reject</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>writer</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;finish&#39;</span>, () =&gt; <span style=color:#a6e22e>resolve</span>(<span style=color:#a6e22e>filePath</span>));
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>writer</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;error&#39;</span>, <span style=color:#a6e22e>reject</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#34;ä¸‹è½½æ–‡ä»¶å¤±è´¥:&#34;</span>, <span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> <span style=color:#a6e22e>err</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ç»Ÿä¸€å¤„ç†æ¶ˆæ¯ï¼ˆæ™®é€šæ¶ˆæ¯å’Œè½¬å‘æ¶ˆæ¯ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;message&#34;</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>hasFile</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.document <span style=color:#f92672>||</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>photo</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>video</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>isForward</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>forward_from</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>forward_from_chat</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>hasFile</span>) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>typePrefix</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>isForward</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;è½¬å‘&#34;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// æ–‡æ¡£
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>msg</span>.document) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>msg</span>.document.<span style=color:#a6e22e>file_id</span>, <span style=color:#a6e22e>msg</span>.document.<span style=color:#a6e22e>file_name</span>, <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>typePrefix</span><span style=color:#e6db74>}</span><span style=color:#e6db74>æ–‡æ¡£`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// å›¾ç‰‡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>photo</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>photo</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>photo</span>[<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>photo</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileName</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`photo_</span><span style=color:#e6db74>${</span>Date.<span style=color:#a6e22e>now</span>()<span style=color:#e6db74>}</span><span style=color:#e6db74>.jpg`</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>photo</span>.<span style=color:#a6e22e>file_id</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>typePrefix</span><span style=color:#e6db74>}</span><span style=color:#e6db74>å›¾ç‰‡`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// è§†é¢‘
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>video</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileName</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>video</span>.<span style=color:#a6e22e>file_name</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>`video_</span><span style=color:#e6db74>${</span>Date.<span style=color:#a6e22e>now</span>()<span style=color:#e6db74>}</span><span style=color:#e6db74>.mp4`</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>video</span>.<span style=color:#a6e22e>file_id</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>typePrefix</span><span style=color:#e6db74>}</span><span style=color:#e6db74>è§†é¢‘`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /myfiles æ–‡æœ¬åˆ—è¡¨
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/myfiles/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>all</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT 10`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>userId</span>],
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>rows</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;âŒ æŸ¥è¯¢å¤±è´¥ã€‚&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;ğŸ“­ æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶ã€‚&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>text</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ğŸ“‚ æœ€è¿‘çš„æ–‡ä»¶ï¼š\n\n&#34;</span>;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>r</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>text</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74> [</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>]\n`</span>;
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>text</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /myfilelist åˆ†é¡µæ˜¾ç¤º
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>sendFilePage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#a6e22e>userId</span>, <span style=color:#a6e22e>page</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>messageId</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>offset</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>page</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>*</span> <span style=color:#a6e22e>PAGE_SIZE</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>all</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT id, file_id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT ? OFFSET ?`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>userId</span>, <span style=color:#a6e22e>PAGE_SIZE</span>, <span style=color:#a6e22e>offset</span>],
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>rows</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;âŒ æŸ¥è¯¢å¤±è´¥ã€‚&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;ğŸ“­ æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶ã€‚&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>messageId</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>editMessageText</span>(<span style=color:#e6db74>`ğŸ“‘ ç¬¬ </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>page</span><span style=color:#e6db74>}</span><span style=color:#e6db74> é¡µï¼ˆæ¯é¡µ </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>PAGE_SIZE</span><span style=color:#e6db74>}</span><span style=color:#e6db74> æ¡ï¼‰`</span>, {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>chat_id</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>chatId</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>message_id</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>messageId</span>,
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`ğŸ“‘ ç¬¬ </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>page</span><span style=color:#e6db74>}</span><span style=color:#e6db74> é¡µï¼ˆæ¯é¡µ </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>PAGE_SIZE</span><span style=color:#e6db74>}</span><span style=color:#e6db74> æ¡ï¼‰`</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>r</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>rows</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>caption</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\nåˆ†ç±»ï¼š</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>opts</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>reply_markup</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>inline_keyboard</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>              [{ <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;âŒ åˆ é™¤&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`del_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> }],
</span></span><span style=display:flex><span>              [{ <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;â¬‡ï¸ ä¸‹è½½æœ¬åœ°&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`download_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> }],
</span></span><span style=display:flex><span>            ],
</span></span><span style=display:flex><span>          },
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.jpg&#34;</span>)) {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendPhoto</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_id</span>, { <span style=color:#a6e22e>caption</span>, ...<span style=color:#a6e22e>opts</span> });
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.mp4&#34;</span>)) {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendVideo</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_id</span>, { <span style=color:#a6e22e>caption</span>, ...<span style=color:#a6e22e>opts</span> });
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendDocument</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_id</span>, {}, { <span style=color:#a6e22e>filename</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#a6e22e>caption</span>, <span style=color:#a6e22e>opts</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// ç¿»é¡µæŒ‰é’®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>totalCountRow</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>new</span> Promise((<span style=color:#a6e22e>resolve</span>) =&gt;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>`SELECT COUNT(*) as cnt FROM files WHERE user_id = ?`</span>, [<span style=color:#a6e22e>userId</span>], (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>row</span>) =&gt; <span style=color:#a6e22e>resolve</span>(<span style=color:#a6e22e>row</span>))
</span></span><span style=display:flex><span>      );
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>totalPages</span> <span style=color:#f92672>=</span> Math.<span style=color:#a6e22e>ceil</span>(<span style=color:#a6e22e>totalCountRow</span>.<span style=color:#a6e22e>cnt</span> <span style=color:#f92672>/</span> <span style=color:#a6e22e>PAGE_SIZE</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>navOpts</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>reply_markup</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>inline_keyboard</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>            [
</span></span><span style=display:flex><span>              { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;â¬…ï¸ ä¸Šä¸€é¡µ&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`page_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>page</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>              { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;â¡ï¸ ä¸‹ä¸€é¡µ&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`page_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>page</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>            ],
</span></span><span style=display:flex><span>          ],
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`åˆ†é¡µå¯¼èˆªï¼šç¬¬ </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>page</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>totalPages</span><span style=color:#e6db74>}</span><span style=color:#e6db74> é¡µ`</span>, <span style=color:#a6e22e>navOpts</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/myfilelist ?(\d+)?/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>page</span> <span style=color:#f92672>=</span> parseInt(<span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>]) <span style=color:#f92672>||</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>sendFilePage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>page</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /search å…³é”®å­—
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/search (.+)/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>keyword</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`%</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>%`</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>all</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT id, file_name, category FROM files WHERE user_id = ? AND file_name LIKE ? ORDER BY date DESC LIMIT 10`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>userId</span>, <span style=color:#a6e22e>keyword</span>],
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>rows</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;âŒ æŸ¥è¯¢å¤±è´¥ã€‚&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;ğŸ” æ²¡æœ‰åŒ¹é…çš„æ–‡ä»¶ã€‚&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>text</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`ğŸ” æœç´¢ç»“æœï¼š\n\n`</span>;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>r</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>text</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74> [</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>]\n`</span>;
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>text</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /getfile id
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/getfile (\d+)/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>`SELECT file_id, file_name FROM files WHERE id = ?`</span>, [<span style=color:#a6e22e>id</span>], (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>row</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>row</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;âŒ æ–‡ä»¶ä¸å­˜åœ¨ã€‚&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.jpg&#34;</span>)) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendPhoto</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, { <span style=color:#a6e22e>caption</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.mp4&#34;</span>)) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendVideo</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, { <span style=color:#a6e22e>caption</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendDocument</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, {}, { <span style=color:#a6e22e>filename</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /delete id
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/delete (\d+)/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>run</span>(<span style=color:#e6db74>`DELETE FROM files WHERE id = ? AND user_id = ?`</span>, [<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>userId</span>], <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;âŒ åˆ é™¤å¤±è´¥ã€‚&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>changes</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;âš ï¸ æ²¡æ‰¾åˆ°è¯¥æ–‡ä»¶æˆ–æ— æƒé™åˆ é™¤ã€‚&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>`âœ… æ–‡ä»¶(ID=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>) å·²åˆ é™¤ã€‚`</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// callback_query ç»Ÿä¸€å¤„ç†
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;callback_query&#34;</span>, <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>query</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>chatId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// åˆ†ç±»æŒ‰é’®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;cat_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>category</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;cat_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>userCategory</span>[<span style=color:#a6e22e>userId</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>category</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`âœ… å·²è®¾ç½®åˆ†ç±»ä¸ºï¼š</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// åˆ é™¤æŒ‰é’®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;del_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;del_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>confirmOpts</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>reply_markup</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>inline_keyboard</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>          [
</span></span><span style=display:flex><span>            { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;âœ… ç¡®è®¤åˆ é™¤&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`confirmdel_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>            { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;âŒ å–æ¶ˆ&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`cancel_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>          ],
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`âš ï¸ ç¡®è®¤è¦åˆ é™¤æ–‡ä»¶(ID=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>)å—ï¼Ÿ`</span>, <span style=color:#a6e22e>confirmOpts</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ç¡®è®¤åˆ é™¤
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;confirmdel_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;confirmdel_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>run</span>(<span style=color:#e6db74>`DELETE FROM files WHERE id = ? AND user_id = ?`</span>, [<span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>userId</span>], <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;âŒ åˆ é™¤å¤±è´¥ã€‚&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>changes</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;âš ï¸ æ²¡æ‰¾åˆ°è¯¥æ–‡ä»¶æˆ–æ— æƒé™åˆ é™¤ã€‚&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`âœ… æ–‡ä»¶(ID=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>) å·²åˆ é™¤ã€‚`</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// å–æ¶ˆåˆ é™¤
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;cancel_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;cancel_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`â å·²å–æ¶ˆåˆ é™¤æ–‡ä»¶(ID=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>)ã€‚`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// åˆ†é¡µæŒ‰é’®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;page_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>page</span> <span style=color:#f92672>=</span> parseInt(<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;page_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>page</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>answerCallbackQuery</span>(<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>id</span>, { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;å·²ç»æ˜¯ç¬¬ä¸€é¡µ&#34;</span> });
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sendFilePage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#a6e22e>userId</span>, <span style=color:#a6e22e>page</span>, <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>message_id</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ä¸‹è½½åˆ°æœ¬åœ°æŒ‰é’®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;download_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;download_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>`SELECT file_id, file_name, category FROM files WHERE id = ? AND user_id = ?`</span>, [<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>userId</span>], <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>row</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>row</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;âŒ æ–‡ä»¶ä¸å­˜åœ¨æˆ–æ— æƒé™ä¸‹è½½ã€‚&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>filePath</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>downloadFile</span>(<span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>category</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`âœ… æ–‡ä»¶å·²ä¸‹è½½åˆ°æœåŠ¡å™¨æœ¬åœ°ï¼š</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>filePath</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>catch</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;âŒ ä¸‹è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚&#34;</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>answerCallbackQuery</span>(<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>id</span>);
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><h1 id=mv>Mv<a hidden class=anchor aria-hidden=true href=#mv>#</a></h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>TelegramBot</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;node-telegram-bot-api&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>db</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;./db&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fs</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;fs&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>path</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;path&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>axios</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;axios&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;TKTK&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>bot</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>TelegramBot</span>(<span style=color:#a6e22e>token</span>, { <span style=color:#a6e22e>polling</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ä¿å­˜åˆ†ç±»ä¿¡æ¯ï¼ˆç”¨æˆ· -&gt; å½“å‰é€‰æ‹©çš„åˆ†ç±»ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userCategory</span> <span style=color:#f92672>=</span> {};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// é¢„è®¾åˆ†ç±»
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>categories</span> <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;work&#34;</span>, <span style=color:#e6db74>&#34;study&#34;</span>, <span style=color:#e6db74>&#34;life&#34;</span>, <span style=color:#e6db74>&#34;other&#34;</span>,<span style=color:#e6db74>&#34;yo&#34;</span>,<span style=color:#e6db74>&#34;yo2&#34;</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// æ¯é¡µæ˜¾ç¤ºæ¡æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>PAGE_SIZE</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// æœ¬åœ°å­˜å‚¨æ ¹ç›®å½•
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>STORAGE_DIR</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>join</span>(<span style=color:#a6e22e>__dirname</span>, <span style=color:#e6db74>&#34;files&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>existsSync</span>(<span style=color:#a6e22e>STORAGE_DIR</span>)) <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>mkdirSync</span>(<span style=color:#a6e22e>STORAGE_DIR</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /start å‘½ä»¤
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/start/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;æ¬¢è¿ä½¿ç”¨æ–‡ä»¶å­˜å‚¨æœºå™¨äººï¼\n\nå‘½ä»¤ï¼š\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/setcategory è®¾ç½®åˆ†ç±»\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/myfiles æŸ¥çœ‹æœ€è¿‘æ–‡ä»¶(æ–‡å­—åˆ—è¡¨)\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/myfilelist [é¡µç ] æ–‡ä»¶åˆ†é¡µæ˜¾ç¤º\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/search å…³é”®å­— æœç´¢æ–‡ä»¶\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/getfile id è·å–æ–‡ä»¶\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/delete id åˆ é™¤æ–‡ä»¶\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;ğŸ“¥ ç‚¹å‡»æ–‡ä»¶åçš„â€œä¸‹è½½æœ¬åœ°â€æŒ‰é’®å¯ä¿å­˜åˆ°æœåŠ¡å™¨æœ¬åœ°&#34;</span>
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /setcategory æ˜¾ç¤ºæŒ‰é’®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/setcategory/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>opts</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reply_markup</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>inline_keyboard</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>categories</span>.<span style=color:#a6e22e>map</span>((<span style=color:#a6e22e>c</span>) =&gt; [{ <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`cat_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>c</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> }]),
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;è¯·é€‰æ‹©åˆ†ç±»ï¼š&#34;</span>, <span style=color:#a6e22e>opts</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// é€šç”¨ä¿å­˜å‡½æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#a6e22e>type</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>chatId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>category</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>userCategory</span>[<span style=color:#a6e22e>userId</span>] <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;æœªåˆ†ç±»&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>run</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`INSERT INTO files (file_id, file_name, category, user_id) VALUES (?, ?, ?, ?)`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#a6e22e>category</span>, <span style=color:#a6e22e>userId</span>],
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;âŒ å­˜å‚¨å¤±è´¥ã€‚&#34;</span>);
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>chatId</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>`ğŸ“¦ å·²ä¿å­˜ </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>type</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\nID: </span><span style=color:#e6db74>${</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>lastID</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\næ–‡ä»¶å: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\nåˆ†ç±»: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ä¸‹è½½æ–‡ä»¶åˆ°æœ¬åœ°ï¼ˆå¸¦é‡è¯•å’Œæ—¥å¿—ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>downloadFile</span>(<span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#a6e22e>category</span>, <span style=color:#a6e22e>retries</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>dir</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>join</span>(<span style=color:#a6e22e>STORAGE_DIR</span>, <span style=color:#a6e22e>category</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>existsSync</span>(<span style=color:#a6e22e>dir</span>)) <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>mkdirSync</span>(<span style=color:#a6e22e>dir</span>, { <span style=color:#a6e22e>recursive</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> });
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>filePath</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>join</span>(<span style=color:#a6e22e>dir</span>, <span style=color:#a6e22e>fileName</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>attempt</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>; <span style=color:#a6e22e>attempt</span> <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>retries</span>; <span style=color:#a6e22e>attempt</span><span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`ä¸‹è½½æ–‡ä»¶å°è¯• </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>attempt</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>retries</span><span style=color:#e6db74>}</span><span style=color:#e6db74>ï¼š</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>url</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>getFileLink</span>(<span style=color:#a6e22e>fileId</span>); <span style=color:#75715e>// è·å–æ–‡ä»¶é“¾æ¥
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>writer</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>createWriteStream</span>(<span style=color:#a6e22e>filePath</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>axios</span>({
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>url</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>method</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;GET&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>responseType</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;stream&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>timeout</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>30000</span> <span style=color:#75715e>// 30ç§’è¶…æ—¶
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>pipe</span>(<span style=color:#a6e22e>writer</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>new</span> Promise((<span style=color:#a6e22e>resolve</span>, <span style=color:#a6e22e>reject</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>writer</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;finish&#39;</span>, <span style=color:#a6e22e>resolve</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>writer</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;error&#39;</span>, <span style=color:#a6e22e>reject</span>);
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`âœ… æ–‡ä»¶ä¸‹è½½æˆåŠŸï¼š</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>filePath</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>filePath</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>`âŒ ä¸‹è½½æ–‡ä»¶å¤±è´¥ï¼ˆå°è¯• </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>attempt</span><span style=color:#e6db74>}</span><span style=color:#e6db74>ï¼‰ï¼š</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>, <span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>attempt</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>retries</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>`ä¸‹è½½æ–‡ä»¶å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ï¼š</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// ç­‰å¾… 1 ç§’åé‡è¯•
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>new</span> Promise(<span style=color:#a6e22e>res</span> =&gt; <span style=color:#a6e22e>setTimeout</span>(<span style=color:#a6e22e>res</span>, <span style=color:#ae81ff>1000</span>));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ç»Ÿä¸€å¤„ç†æ¶ˆæ¯ï¼ˆæ™®é€šæ¶ˆæ¯å’Œè½¬å‘æ¶ˆæ¯ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;message&#34;</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>hasFile</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.document <span style=color:#f92672>||</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>photo</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>video</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>isForward</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>forward_from</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>forward_from_chat</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>hasFile</span>) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>typePrefix</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>isForward</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;è½¬å‘&#34;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// æ–‡æ¡£
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>msg</span>.document) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>msg</span>.document.<span style=color:#a6e22e>file_id</span>, <span style=color:#a6e22e>msg</span>.document.<span style=color:#a6e22e>file_name</span>, <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>typePrefix</span><span style=color:#e6db74>}</span><span style=color:#e6db74>æ–‡æ¡£`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// å›¾ç‰‡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>photo</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>photo</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>photo</span>[<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>photo</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileName</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`photo_</span><span style=color:#e6db74>${</span>Date.<span style=color:#a6e22e>now</span>()<span style=color:#e6db74>}</span><span style=color:#e6db74>.jpg`</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>photo</span>.<span style=color:#a6e22e>file_id</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>typePrefix</span><span style=color:#e6db74>}</span><span style=color:#e6db74>å›¾ç‰‡`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// è§†é¢‘
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>video</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileName</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>video</span>.<span style=color:#a6e22e>file_name</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>`video_</span><span style=color:#e6db74>${</span>Date.<span style=color:#a6e22e>now</span>()<span style=color:#e6db74>}</span><span style=color:#e6db74>.mp4`</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>video</span>.<span style=color:#a6e22e>file_id</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>typePrefix</span><span style=color:#e6db74>}</span><span style=color:#e6db74>è§†é¢‘`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /myfiles æ–‡æœ¬åˆ—è¡¨
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/myfiles/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>all</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT 10`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>userId</span>],
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>rows</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;âŒ æŸ¥è¯¢å¤±è´¥ã€‚&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;ğŸ“­ æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶ã€‚&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>text</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ğŸ“‚ æœ€è¿‘çš„æ–‡ä»¶ï¼š\n\n&#34;</span>;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>r</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>text</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74> [</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>]\n`</span>;
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>text</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /myfilelist åˆ†é¡µæ˜¾ç¤ºï¼ˆä¼˜åŒ–ï¼šæ”¯æŒå›¾ç‰‡ç¼©ç•¥å›¾ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>sendFilePage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#a6e22e>userId</span>, <span style=color:#a6e22e>page</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>messageId</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>offset</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>page</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>*</span> <span style=color:#a6e22e>PAGE_SIZE</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>all</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT id, file_id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT ? OFFSET ?`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>userId</span>, <span style=color:#a6e22e>PAGE_SIZE</span>, <span style=color:#a6e22e>offset</span>],
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>rows</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;âŒ æŸ¥è¯¢å¤±è´¥ã€‚&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;ğŸ“­ æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶ã€‚&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// æ‹¼æ¥æ–‡ä»¶åˆ—è¡¨æ–‡å­—
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>text</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`ğŸ“‘ ç¬¬ </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>page</span><span style=color:#e6db74>}</span><span style=color:#e6db74> é¡µï¼ˆæ¯é¡µ </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>PAGE_SIZE</span><span style=color:#e6db74>}</span><span style=color:#e6db74> æ¡ï¼‰\n\n`</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>inline_keyboard</span> <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>mediaGroup</span> <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>r</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>rows</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>text</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74> [</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>]\n`</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// æ¯ä¸ªæ–‡ä»¶å•ç‹¬ä¸¤æŒ‰é’®è¡Œï¼šåˆ é™¤+ä¸‹è½½
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>inline_keyboard</span>.<span style=color:#a6e22e>push</span>([
</span></span><span style=display:flex><span>          { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;âŒ åˆ é™¤&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`del_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>          { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;â¬‡ï¸ ä¸‹è½½æœ¬åœ°&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`download_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>        ]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// å¦‚æœæ˜¯å›¾ç‰‡ï¼ŒåŠ å…¥ç¼©ç•¥å›¾åˆ° mediaGroup
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.jpg&#34;</span>) <span style=color:#f92672>||</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.png&#34;</span>)) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>mediaGroup</span>.<span style=color:#a6e22e>push</span>({ <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;photo&#34;</span>, <span style=color:#a6e22e>media</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_id</span>, <span style=color:#a6e22e>caption</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> });
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// ç¿»é¡µæŒ‰é’®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>totalCountRow</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>new</span> Promise((<span style=color:#a6e22e>resolve</span>) =&gt;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>`SELECT COUNT(*) as cnt FROM files WHERE user_id = ?`</span>, [<span style=color:#a6e22e>userId</span>], (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>row</span>) =&gt; <span style=color:#a6e22e>resolve</span>(<span style=color:#a6e22e>row</span>))
</span></span><span style=display:flex><span>      );
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>totalPages</span> <span style=color:#f92672>=</span> Math.<span style=color:#a6e22e>ceil</span>(<span style=color:#a6e22e>totalCountRow</span>.<span style=color:#a6e22e>cnt</span> <span style=color:#f92672>/</span> <span style=color:#a6e22e>PAGE_SIZE</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>inline_keyboard</span>.<span style=color:#a6e22e>push</span>([
</span></span><span style=display:flex><span>        { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;â¬…ï¸ ä¸Šä¸€é¡µ&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`page_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>page</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>        { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;â¡ï¸ ä¸‹ä¸€é¡µ&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`page_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>page</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>      ]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>opts</span> <span style=color:#f92672>=</span> { <span style=color:#a6e22e>reply_markup</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>inline_keyboard</span> } };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>mediaGroup</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// å…ˆå‘é€å›¾ç‰‡ç¼©ç•¥å›¾ç»„
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMediaGroup</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#a6e22e>mediaGroup</span>);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#34;å‘é€ç¼©ç•¥å›¾å¤±è´¥:&#34;</span>, <span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>messageId</span>) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ç¼–è¾‘å·²æœ‰æ¶ˆæ¯
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>editMessageText</span>(<span style=color:#a6e22e>text</span>, {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>chat_id</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>chatId</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>message_id</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>messageId</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>reply_markup</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>opts</span>.<span style=color:#a6e22e>reply_markup</span>,
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#a6e22e>text</span>, <span style=color:#a6e22e>opts</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/myfilelist ?(\d+)?/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>page</span> <span style=color:#f92672>=</span> parseInt(<span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>]) <span style=color:#f92672>||</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>sendFilePage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>page</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /search å…³é”®å­—
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/search (.+)/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>keyword</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`%</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>%`</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>all</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT id, file_name, category FROM files WHERE user_id = ? AND file_name LIKE ? ORDER BY date DESC LIMIT 10`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>userId</span>, <span style=color:#a6e22e>keyword</span>],
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>rows</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;âŒ æŸ¥è¯¢å¤±è´¥ã€‚&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;ğŸ” æ²¡æœ‰åŒ¹é…çš„æ–‡ä»¶ã€‚&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>text</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`ğŸ” æœç´¢ç»“æœï¼š\n\n`</span>;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>r</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>text</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74> [</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>]\n`</span>;
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>text</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /getfile id
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/getfile (\d+)/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>`SELECT file_id, file_name FROM files WHERE id = ?`</span>, [<span style=color:#a6e22e>id</span>], (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>row</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>row</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;âŒ æ–‡ä»¶ä¸å­˜åœ¨ã€‚&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.jpg&#34;</span>)) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendPhoto</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, { <span style=color:#a6e22e>caption</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.mp4&#34;</span>)) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendVideo</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, { <span style=color:#a6e22e>caption</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendDocument</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, {}, { <span style=color:#a6e22e>filename</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /delete id
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/delete (\d+)/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>run</span>(<span style=color:#e6db74>`DELETE FROM files WHERE id = ? AND user_id = ?`</span>, [<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>userId</span>], <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;âŒ åˆ é™¤å¤±è´¥ã€‚&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>changes</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;âš ï¸ æ²¡æ‰¾åˆ°è¯¥æ–‡ä»¶æˆ–æ— æƒé™åˆ é™¤ã€‚&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>`âœ… æ–‡ä»¶(ID=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>) å·²åˆ é™¤ã€‚`</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// callback_query ç»Ÿä¸€å¤„ç†
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;callback_query&#34;</span>, <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>query</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>chatId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// åˆ†ç±»æŒ‰é’®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;cat_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>category</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;cat_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>userCategory</span>[<span style=color:#a6e22e>userId</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>category</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`âœ… å·²è®¾ç½®åˆ†ç±»ä¸ºï¼š</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// åˆ é™¤æŒ‰é’®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;del_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;del_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>confirmOpts</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>reply_markup</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>inline_keyboard</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>          [
</span></span><span style=display:flex><span>            { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;âœ… ç¡®è®¤åˆ é™¤&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`confirmdel_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>            { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;âŒ å–æ¶ˆ&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`cancel_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>          ],
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`âš ï¸ ç¡®è®¤è¦åˆ é™¤æ–‡ä»¶(ID=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>)å—ï¼Ÿ`</span>, <span style=color:#a6e22e>confirmOpts</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ç¡®è®¤åˆ é™¤
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;confirmdel_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;confirmdel_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>run</span>(<span style=color:#e6db74>`DELETE FROM files WHERE id = ? AND user_id = ?`</span>, [<span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>userId</span>], <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;âŒ åˆ é™¤å¤±è´¥ã€‚&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>changes</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;âš ï¸ æ²¡æ‰¾åˆ°è¯¥æ–‡ä»¶æˆ–æ— æƒé™åˆ é™¤ã€‚&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`âœ… æ–‡ä»¶(ID=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>) å·²åˆ é™¤ã€‚`</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// å–æ¶ˆåˆ é™¤
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;cancel_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;cancel_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`â å·²å–æ¶ˆåˆ é™¤æ–‡ä»¶(ID=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>)ã€‚`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// åˆ†é¡µæŒ‰é’®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;page_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>page</span> <span style=color:#f92672>=</span> parseInt(<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;page_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>page</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>answerCallbackQuery</span>(<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>id</span>, { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;å·²ç»æ˜¯ç¬¬ä¸€é¡µ&#34;</span> });
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sendFilePage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#a6e22e>userId</span>, <span style=color:#a6e22e>page</span>, <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>message_id</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ä¸‹è½½åˆ°æœ¬åœ°æŒ‰é’®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;download_&#34;</span>)) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;download_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>`SELECT file_id, file_name, category FROM files WHERE id = ? AND user_id = ?`</span>, [<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>userId</span>], <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>row</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>row</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;âŒ æ–‡ä»¶ä¸å­˜åœ¨æˆ–æ— æƒé™ä¸‹è½½ã€‚&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>filePath</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>downloadFile</span>(<span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>category</span>);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`âœ… æ–‡ä»¶å·²ä¸‹è½½åˆ°æœåŠ¡å™¨æœ¬åœ°ï¼š</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>filePath</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`âŒ </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>message</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>answerCallbackQuery</span>(<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>id</span>);
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><h1 id=configjs>config.js<a hidden class=anchor aria-hidden=true href=#configjs>#</a></h1><p>configbot.js</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// configbot.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>token</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;t&#34;</span>, <span style=color:#75715e>//  Telegram Bot Token
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>categories</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#34;work&#34;</span>, <span style=color:#e6db74>&#34;study&#34;</span>, <span style=color:#e6db74>&#34;life&#34;</span>, <span style=color:#e6db74>&#34;other&#34;</span>, <span style=color:#e6db74>&#34;yo&#34;</span>, <span style=color:#e6db74>&#34;yo2&#34;</span>], <span style=color:#75715e>// åˆ†ç±»
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>pageSize</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>5</span> <span style=color:#75715e>// æ¯é¡µæ˜¾ç¤ºæ¡æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>};
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>//bot.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>TelegramBot</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;node-telegram-bot-api&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>db</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;./db&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fs</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;fs&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>path</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;path&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>axios</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;axios&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>config</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;./configbot&#34;</span>); <span style=color:#75715e>// å¼•å…¥é…ç½®æ–‡ä»¶
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>token</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>categories</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>categories</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>PAGE_SIZE</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>pageSize</span>; 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>bot</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>TelegramBot</span>(<span style=color:#a6e22e>token</span>, { <span style=color:#a6e22e>polling</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> });
</span></span></code></pre></div><h1 id=login>login<a hidden class=anchor aria-hidden=true href=#login>#</a></h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>//config
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>token</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;BOT_TOKEN&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>categories</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#34;c1&#34;</span>, <span style=color:#e6db74>&#34;c2&#34;</span>, <span style=color:#e6db74>&#34;c2&#34;</span>],
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>pageSize</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>5</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>adminPassword</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;admin123&#34;</span> <span style=color:#75715e>// æœºå™¨äººè®¿é—®å¯†ç 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>};
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>TelegramBot</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;node-telegram-bot-api&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>db</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;./db&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fs</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;fs&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>path</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;path&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>axios</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;axios&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>config</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;./configbot&#34;</span>); <span style=color:#75715e>// å¼•å…¥é…ç½®æ–‡ä»¶
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>token</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>categories</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>categories</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>PAGE_SIZE</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>pageSize</span>; <span style=color:#75715e>// ä»é…ç½®è¯»å–
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>ADMIN_PASSWORD</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>adminPassword</span>; <span style=color:#75715e>// ç®¡ç†å¯†ç 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>bot</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>TelegramBot</span>(<span style=color:#a6e22e>token</span>, { <span style=color:#a6e22e>polling</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ä¿å­˜åˆ†ç±»ä¿¡æ¯ï¼ˆç”¨æˆ· -&gt; å½“å‰é€‰æ‹©çš„åˆ†ç±»ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userCategory</span> <span style=color:#f92672>=</span> {};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ä¿å­˜å·²ç™»å½•ç”¨æˆ·
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>authenticatedUsers</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Set</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// æœ¬åœ°å­˜å‚¨æ ¹ç›®å½•
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>STORAGE_DIR</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>join</span>(<span style=color:#a6e22e>__dirname</span>, <span style=color:#e6db74>&#34;files&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>existsSync</span>(<span style=color:#a6e22e>STORAGE_DIR</span>)) <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>mkdirSync</span>(<span style=color:#a6e22e>STORAGE_DIR</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// æ£€æŸ¥æ˜¯å¦å·²é‰´æƒ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>checkAuth</span>(<span style=color:#a6e22e>msg</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>authenticatedUsers</span>.<span style=color:#a6e22e>has</span>(<span style=color:#a6e22e>userId</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;âš ï¸ è¯·å…ˆä½¿ç”¨ /login &lt;å¯†ç &gt; ç™»å½•ã€‚&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /login å‘½ä»¤
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/login (.+)/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>password</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>password</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>ADMIN_PASSWORD</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>authenticatedUsers</span>.<span style=color:#a6e22e>add</span>(<span style=color:#a6e22e>userId</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;âœ… ç™»å½•æˆåŠŸï¼Œæ‚¨å·²è·å¾—è®¿é—®æƒé™ã€‚&#34;</span>);
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;âŒ å¯†ç é”™è¯¯ã€‚&#34;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /start å‘½ä»¤
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/start/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>checkAuth</span>(<span style=color:#a6e22e>msg</span>)) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;æ¬¢è¿ä½¿ç”¨æ–‡ä»¶å­˜å‚¨æœºå™¨äººï¼\n\nå‘½ä»¤ï¼š\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/setcategory è®¾ç½®åˆ†ç±»\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/myfiles æŸ¥çœ‹æœ€è¿‘æ–‡ä»¶(æ–‡å­—åˆ—è¡¨)\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/myfilelist [é¡µç ] æ–‡ä»¶åˆ†é¡µæ˜¾ç¤º\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/search å…³é”®å­— æœç´¢æ–‡ä»¶\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/getfile id è·å–æ–‡ä»¶\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/delete id åˆ é™¤æ–‡ä»¶\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;ğŸ“¥ ç‚¹å‡»æ–‡ä»¶åçš„â€œä¸‹è½½æœ¬åœ°â€æŒ‰é’®å¯ä¿å­˜åˆ°æœåŠ¡å™¨æœ¬åœ°&#34;</span>
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /setcategory æ˜¾ç¤ºæŒ‰é’®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/setcategory/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>checkAuth</span>(<span style=color:#a6e22e>msg</span>)) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>opts</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reply_markup</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>inline_keyboard</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>categories</span>.<span style=color:#a6e22e>map</span>((<span style=color:#a6e22e>c</span>) =&gt; [{ <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`cat_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>c</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> }]),
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;è¯·é€‰æ‹©åˆ†ç±»ï¼š&#34;</span>, <span style=color:#a6e22e>opts</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// é€šç”¨ä¿å­˜å‡½æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#a6e22e>type</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>chatId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>category</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>userCategory</span>[<span style=color:#a6e22e>userId</span>] <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;æœªåˆ†ç±»&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>run</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`INSERT INTO files (file_id, file_name, category, user_id) VALUES (?, ?, ?, ?)`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#a6e22e>category</span>, <span style=color:#a6e22e>userId</span>],
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;âŒ å­˜å‚¨å¤±è´¥ã€‚&#34;</span>);
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>chatId</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>`ğŸ“¦ å·²ä¿å­˜ </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>type</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\nID: </span><span style=color:#e6db74>${</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>lastID</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\næ–‡ä»¶å: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\nåˆ†ç±»: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ä¸‹è½½æ–‡ä»¶åˆ°æœ¬åœ°ï¼ˆå¸¦é‡è¯•å’Œæ—¥å¿—ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>downloadFile</span>(<span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#a6e22e>category</span>, <span style=color:#a6e22e>retries</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>dir</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>join</span>(<span style=color:#a6e22e>STORAGE_DIR</span>, <span style=color:#a6e22e>category</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>existsSync</span>(<span style=color:#a6e22e>dir</span>)) <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>mkdirSync</span>(<span style=color:#a6e22e>dir</span>, { <span style=color:#a6e22e>recursive</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> });
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>filePath</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>join</span>(<span style=color:#a6e22e>dir</span>, <span style=color:#a6e22e>fileName</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>attempt</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>; <span style=color:#a6e22e>attempt</span> <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>retries</span>; <span style=color:#a6e22e>attempt</span><span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`ä¸‹è½½æ–‡ä»¶å°è¯• </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>attempt</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>retries</span><span style=color:#e6db74>}</span><span style=color:#e6db74>ï¼š</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>url</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>getFileLink</span>(<span style=color:#a6e22e>fileId</span>); <span style=color:#75715e>// è·å–æ–‡ä»¶é“¾æ¥
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>writer</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>createWriteStream</span>(<span style=color:#a6e22e>filePath</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>axios</span>({
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>url</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>method</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;GET&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>responseType</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;stream&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>timeout</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>30000</span>, <span style=color:#75715e>// 30ç§’è¶…æ—¶
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>pipe</span>(<span style=color:#a6e22e>writer</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>new</span> Promise((<span style=color:#a6e22e>resolve</span>, <span style=color:#a6e22e>reject</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>writer</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;finish&#34;</span>, <span style=color:#a6e22e>resolve</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>writer</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;error&#34;</span>, <span style=color:#a6e22e>reject</span>);
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`âœ… æ–‡ä»¶ä¸‹è½½æˆåŠŸï¼š</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>filePath</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>filePath</span>;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>`âŒ ä¸‹è½½æ–‡ä»¶å¤±è´¥ï¼ˆå°è¯• </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>attempt</span><span style=color:#e6db74>}</span><span style=color:#e6db74>ï¼‰ï¼š</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>, <span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>attempt</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>retries</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>`ä¸‹è½½æ–‡ä»¶å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ï¼š</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// ç­‰å¾… 1 ç§’åé‡è¯•
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>new</span> Promise((<span style=color:#a6e22e>res</span>) =&gt; <span style=color:#a6e22e>setTimeout</span>(<span style=color:#a6e22e>res</span>, <span style=color:#ae81ff>1000</span>));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ç»Ÿä¸€å¤„ç†æ¶ˆæ¯ï¼ˆæ™®é€šæ¶ˆæ¯å’Œè½¬å‘æ¶ˆæ¯ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;message&#34;</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>checkAuth</span>(<span style=color:#a6e22e>msg</span>)) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>hasFile</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.document <span style=color:#f92672>||</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>photo</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>video</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>isForward</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>forward_from</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>forward_from_chat</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>hasFile</span>) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>typePrefix</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>isForward</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;è½¬å‘&#34;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// æ–‡æ¡£
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>msg</span>.document) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>msg</span>.document.<span style=color:#a6e22e>file_id</span>, <span style=color:#a6e22e>msg</span>.document.<span style=color:#a6e22e>file_name</span>, <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>typePrefix</span><span style=color:#e6db74>}</span><span style=color:#e6db74>æ–‡æ¡£`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// å›¾ç‰‡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>photo</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>photo</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>photo</span>[<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>photo</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileName</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`photo_</span><span style=color:#e6db74>${</span>Date.<span style=color:#a6e22e>now</span>()<span style=color:#e6db74>}</span><span style=color:#e6db74>.jpg`</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>photo</span>.<span style=color:#a6e22e>file_id</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>typePrefix</span><span style=color:#e6db74>}</span><span style=color:#e6db74>å›¾ç‰‡`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// è§†é¢‘
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>video</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileName</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>video</span>.<span style=color:#a6e22e>file_name</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>`video_</span><span style=color:#e6db74>${</span>Date.<span style=color:#a6e22e>now</span>()<span style=color:#e6db74>}</span><span style=color:#e6db74>.mp4`</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>video</span>.<span style=color:#a6e22e>file_id</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>typePrefix</span><span style=color:#e6db74>}</span><span style=color:#e6db74>è§†é¢‘`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /myfiles æ–‡æœ¬åˆ—è¡¨
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/myfiles/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>checkAuth</span>(<span style=color:#a6e22e>msg</span>)) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>all</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT 10`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>userId</span>],
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>rows</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;âŒ æŸ¥è¯¢å¤±è´¥ã€‚&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;ğŸ“­ æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶ã€‚&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>text</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ğŸ“‚ æœ€è¿‘çš„æ–‡ä»¶ï¼š\n\n&#34;</span>;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>r</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>text</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74> [</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>]\n`</span>;
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>text</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /myfilelist åˆ†é¡µæ˜¾ç¤º
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>sendFilePage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#a6e22e>userId</span>, <span style=color:#a6e22e>page</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>messageId</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>offset</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>page</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>*</span> <span style=color:#a6e22e>PAGE_SIZE</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>all</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT id, file_id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT ? OFFSET ?`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>userId</span>, <span style=color:#a6e22e>PAGE_SIZE</span>, <span style=color:#a6e22e>offset</span>],
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>rows</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;âŒ æŸ¥è¯¢å¤±è´¥ã€‚&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;ğŸ“­ æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶ã€‚&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>text</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`ğŸ“‘ ç¬¬ </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>page</span><span style=color:#e6db74>}</span><span style=color:#e6db74> é¡µï¼ˆæ¯é¡µ </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>PAGE_SIZE</span><span style=color:#e6db74>}</span><span style=color:#e6db74> æ¡ï¼‰\n\n`</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>inline_keyboard</span> <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>mediaGroup</span> <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>r</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>rows</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>text</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74> [</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>]\n`</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>inline_keyboard</span>.<span style=color:#a6e22e>push</span>([
</span></span><span style=display:flex><span>          { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;âŒ åˆ é™¤&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`del_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>          { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;â¬‡ï¸ ä¸‹è½½æœ¬åœ°&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`download_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>        ]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.jpg&#34;</span>) <span style=color:#f92672>||</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.png&#34;</span>)) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>mediaGroup</span>.<span style=color:#a6e22e>push</span>({ <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;photo&#34;</span>, <span style=color:#a6e22e>media</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_id</span>, <span style=color:#a6e22e>caption</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> });
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>totalCountRow</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>new</span> Promise((<span style=color:#a6e22e>resolve</span>) =&gt;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>`SELECT COUNT(*) as cnt FROM files WHERE user_id = ?`</span>, [<span style=color:#a6e22e>userId</span>], (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>row</span>) =&gt;
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>resolve</span>(<span style=color:#a6e22e>row</span>)
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>      );
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>totalPages</span> <span style=color:#f92672>=</span> Math.<span style=color:#a6e22e>ceil</span>(<span style=color:#a6e22e>totalCountRow</span>.<span style=color:#a6e22e>cnt</span> <span style=color:#f92672>/</span> <span style=color:#a6e22e>PAGE_SIZE</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>inline_keyboard</span>.<span style=color:#a6e22e>push</span>([
</span></span><span style=display:flex><span>        { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;â¬…ï¸ ä¸Šä¸€é¡µ&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`page_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>page</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>        { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;â¡ï¸ ä¸‹ä¸€é¡µ&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`page_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>page</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>      ]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>opts</span> <span style=color:#f92672>=</span> { <span style=color:#a6e22e>reply_markup</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>inline_keyboard</span> } };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>mediaGroup</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMediaGroup</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#a6e22e>mediaGroup</span>);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#34;å‘é€ç¼©ç•¥å›¾å¤±è´¥:&#34;</span>, <span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>messageId</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>editMessageText</span>(<span style=color:#a6e22e>text</span>, {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>chat_id</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>chatId</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>message_id</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>messageId</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>reply_markup</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>opts</span>.<span style=color:#a6e22e>reply_markup</span>,
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#a6e22e>text</span>, <span style=color:#a6e22e>opts</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/myfilelist ?(\d+)?/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>checkAuth</span>(<span style=color:#a6e22e>msg</span>)) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>page</span> <span style=color:#f92672>=</span> parseInt(<span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>]) <span style=color:#f92672>||</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>sendFilePage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>page</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /search å…³é”®å­—
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/search (.+)/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>checkAuth</span>(<span style=color:#a6e22e>msg</span>)) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>keyword</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`%</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>%`</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>all</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT id, file_name, category FROM files WHERE user_id = ? AND file_name LIKE ? ORDER BY date DESC LIMIT 10`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>userId</span>, <span style=color:#a6e22e>keyword</span>],
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>rows</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;âŒ æŸ¥è¯¢å¤±è´¥ã€‚&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;ğŸ” æ²¡æœ‰åŒ¹é…çš„æ–‡ä»¶ã€‚&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>text</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`ğŸ” æœç´¢ç»“æœï¼š\n\n`</span>;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>r</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>text</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74> [</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>]\n`</span>;
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>text</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /getfile id
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/getfile (\d+)/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>checkAuth</span>(<span style=color:#a6e22e>msg</span>)) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>`SELECT file_id, file_name FROM files WHERE id = ?`</span>, [<span style=color:#a6e22e>id</span>], (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>row</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>row</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;âŒ æ–‡ä»¶ä¸å­˜åœ¨ã€‚&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.jpg&#34;</span>)) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendPhoto</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, { <span style=color:#a6e22e>caption</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.mp4&#34;</span>)) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendVideo</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, { <span style=color:#a6e22e>caption</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendDocument</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, {}, { <span style=color:#a6e22e>filename</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /delete id
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/delete (\d+)/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>checkAuth</span>(<span style=color:#a6e22e>msg</span>)) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>run</span>(<span style=color:#e6db74>`DELETE FROM files WHERE id = ? AND user_id = ?`</span>, [<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>userId</span>], <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;âŒ åˆ é™¤å¤±è´¥ã€‚&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>changes</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;âš ï¸ æ²¡æ‰¾åˆ°è¯¥æ–‡ä»¶æˆ–æ— æƒé™åˆ é™¤ã€‚&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>`âœ… æ–‡ä»¶(ID=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>) å·²åˆ é™¤ã€‚`</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// callback_query ç»Ÿä¸€å¤„ç†
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;callback_query&#34;</span>, <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>query</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>chatId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>authenticatedUsers</span>.<span style=color:#a6e22e>has</span>(<span style=color:#a6e22e>userId</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>answerCallbackQuery</span>(<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>id</span>, { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;âš ï¸ è¯·å…ˆç™»å½• /login &lt;å¯†ç &gt;&#34;</span> });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;cat_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>category</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;cat_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>userCategory</span>[<span style=color:#a6e22e>userId</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>category</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`âœ… å·²è®¾ç½®åˆ†ç±»ä¸ºï¼š</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;del_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;del_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>confirmOpts</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>reply_markup</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>inline_keyboard</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>          [
</span></span><span style=display:flex><span>            { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;âœ… ç¡®è®¤åˆ é™¤&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`confirmdel_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>            { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;âŒ å–æ¶ˆ&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`cancel_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>          ],
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`âš ï¸ ç¡®è®¤è¦åˆ é™¤æ–‡ä»¶(ID=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>)å—ï¼Ÿ`</span>, <span style=color:#a6e22e>confirmOpts</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;confirmdel_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;confirmdel_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>run</span>(<span style=color:#e6db74>`DELETE FROM files WHERE id = ? AND user_id = ?`</span>, [<span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>userId</span>], <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;âŒ åˆ é™¤å¤±è´¥ã€‚&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>changes</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;âš ï¸ æ²¡æ‰¾åˆ°è¯¥æ–‡ä»¶æˆ–æ— æƒé™åˆ é™¤ã€‚&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`âœ… æ–‡ä»¶(ID=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>) å·²åˆ é™¤ã€‚`</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;cancel_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;cancel_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`â å·²å–æ¶ˆåˆ é™¤æ–‡ä»¶(ID=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>)ã€‚`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;page_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>page</span> <span style=color:#f92672>=</span> parseInt(<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;page_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>page</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>answerCallbackQuery</span>(<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>id</span>, { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;å·²ç»æ˜¯ç¬¬ä¸€é¡µ&#34;</span> });
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sendFilePage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#a6e22e>userId</span>, <span style=color:#a6e22e>page</span>, <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>message_id</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;download_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;download_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>get</span>(
</span></span><span style=display:flex><span>      <span style=color:#e6db74>`SELECT file_id, file_name, category FROM files WHERE id = ? AND user_id = ?`</span>,
</span></span><span style=display:flex><span>      [<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>userId</span>],
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>row</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>row</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;âŒ æ–‡ä»¶ä¸å­˜åœ¨æˆ–æ— æƒé™ä¸‹è½½ã€‚&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>filePath</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>downloadFile</span>(<span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>category</span>);
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`âœ… æ–‡ä»¶å·²ä¸‹è½½åˆ°æœåŠ¡å™¨æœ¬åœ°ï¼š</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>filePath</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`âŒ </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>message</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>answerCallbackQuery</span>(<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>id</span>);
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>ç”¨æˆ·å¿…é¡»å…ˆè¾“å…¥ /login admin123ï¼Œå¦åˆ™æ‰€æœ‰å‘½ä»¤éƒ½ä¼šæç¤º âš ï¸ è¯·å…ˆä½¿ç”¨ /login &lt;å¯†ç > ç™»å½•ã€‚</p><p>ç™»å½•æˆåŠŸåï¼Œæ‰å¯ä»¥æ­£å¸¸ä½¿ç”¨ /startã€ä¸Šä¼ æ–‡ä»¶ã€æœç´¢ã€åˆ†é¡µã€åˆ é™¤ã€ä¸‹è½½ç­‰åŠŸèƒ½ã€‚</p><h1 id=list-detail>list detail<a hidden class=anchor aria-hidden=true href=#list-detail>#</a></h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>TelegramBot</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;node-telegram-bot-api&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>db</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;./db&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fs</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;fs&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>path</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;path&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>axios</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;axios&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>config</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;./configbot&#34;</span>); <span style=color:#75715e>// å¼•å…¥é…ç½®æ–‡ä»¶
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>token</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>categories</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>categories</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>PAGE_SIZE</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>pageSize</span>; <span style=color:#75715e>// ä»é…ç½®è¯»å–
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>ADMIN_PASSWORD</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>adminPassword</span>; <span style=color:#75715e>// ç®¡ç†å¯†ç 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>bot</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>TelegramBot</span>(<span style=color:#a6e22e>token</span>, { <span style=color:#a6e22e>polling</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ä¿å­˜åˆ†ç±»ä¿¡æ¯ï¼ˆç”¨æˆ· -&gt; å½“å‰é€‰æ‹©çš„åˆ†ç±»ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userCategory</span> <span style=color:#f92672>=</span> {};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ä¿å­˜å·²ç™»å½•ç”¨æˆ·
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>authenticatedUsers</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Set</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// æœ¬åœ°å­˜å‚¨æ ¹ç›®å½•
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>STORAGE_DIR</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>join</span>(<span style=color:#a6e22e>__dirname</span>, <span style=color:#e6db74>&#34;files&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>existsSync</span>(<span style=color:#a6e22e>STORAGE_DIR</span>)) <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>mkdirSync</span>(<span style=color:#a6e22e>STORAGE_DIR</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// æ£€æŸ¥æ˜¯å¦å·²é‰´æƒ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>checkAuth</span>(<span style=color:#a6e22e>msg</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>authenticatedUsers</span>.<span style=color:#a6e22e>has</span>(<span style=color:#a6e22e>userId</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;âš ï¸ è¯·å…ˆä½¿ç”¨ /login &lt;å¯†ç &gt; ç™»å½•ã€‚&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /login å‘½ä»¤
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/login (.+)/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>password</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>password</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>ADMIN_PASSWORD</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>authenticatedUsers</span>.<span style=color:#a6e22e>add</span>(<span style=color:#a6e22e>userId</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;âœ… ç™»å½•æˆåŠŸï¼Œæ‚¨å·²è·å¾—è®¿é—®æƒé™ã€‚&#34;</span>);
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;âŒ å¯†ç é”™è¯¯ã€‚&#34;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /start å‘½ä»¤
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/start/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>checkAuth</span>(<span style=color:#a6e22e>msg</span>)) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;æ¬¢è¿ä½¿ç”¨æ–‡ä»¶å­˜å‚¨æœºå™¨äººï¼\n\nå‘½ä»¤ï¼š\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/setcategory è®¾ç½®åˆ†ç±»\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/myfiles æŸ¥çœ‹æœ€è¿‘æ–‡ä»¶(æ–‡å­—åˆ—è¡¨)\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/myfilelist [é¡µç ] æ–‡ä»¶åˆ†é¡µæ˜¾ç¤º\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/search å…³é”®å­— æœç´¢æ–‡ä»¶\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/getfile id è·å–æ–‡ä»¶\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/delete id åˆ é™¤æ–‡ä»¶\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;ğŸ“¥ ç‚¹å‡»æ–‡ä»¶åçš„â€œä¸‹è½½æœ¬åœ°â€æˆ–â€œæŸ¥çœ‹è¯¦æƒ…â€æŒ‰é’®æ“ä½œ&#34;</span>
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /setcategory æ˜¾ç¤ºæŒ‰é’®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/setcategory/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>checkAuth</span>(<span style=color:#a6e22e>msg</span>)) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>opts</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reply_markup</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>inline_keyboard</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>categories</span>.<span style=color:#a6e22e>map</span>((<span style=color:#a6e22e>c</span>) =&gt; [{ <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`cat_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>c</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> }]),
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;è¯·é€‰æ‹©åˆ†ç±»ï¼š&#34;</span>, <span style=color:#a6e22e>opts</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// é€šç”¨ä¿å­˜å‡½æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#a6e22e>type</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>chatId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>category</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>userCategory</span>[<span style=color:#a6e22e>userId</span>] <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;æœªåˆ†ç±»&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>run</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`INSERT INTO files (file_id, file_name, category, user_id, date) VALUES (?, ?, ?, ?, datetime(&#39;now&#39;))`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#a6e22e>category</span>, <span style=color:#a6e22e>userId</span>],
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;âŒ å­˜å‚¨å¤±è´¥ã€‚&#34;</span>);
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>chatId</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>`ğŸ“¦ å·²ä¿å­˜ </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>type</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\nID: </span><span style=color:#e6db74>${</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>lastID</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\næ–‡ä»¶å: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\nåˆ†ç±»: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ä¸‹è½½æ–‡ä»¶åˆ°æœ¬åœ°ï¼ˆå¸¦é‡è¯•å’Œæ—¥å¿—ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>downloadFile</span>(<span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#a6e22e>category</span>, <span style=color:#a6e22e>retries</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>dir</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>join</span>(<span style=color:#a6e22e>STORAGE_DIR</span>, <span style=color:#a6e22e>category</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>existsSync</span>(<span style=color:#a6e22e>dir</span>)) <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>mkdirSync</span>(<span style=color:#a6e22e>dir</span>, { <span style=color:#a6e22e>recursive</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> });
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>filePath</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>join</span>(<span style=color:#a6e22e>dir</span>, <span style=color:#a6e22e>fileName</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>attempt</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>; <span style=color:#a6e22e>attempt</span> <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>retries</span>; <span style=color:#a6e22e>attempt</span><span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`ä¸‹è½½æ–‡ä»¶å°è¯• </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>attempt</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>retries</span><span style=color:#e6db74>}</span><span style=color:#e6db74>ï¼š</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>url</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>getFileLink</span>(<span style=color:#a6e22e>fileId</span>); <span style=color:#75715e>// è·å–æ–‡ä»¶é“¾æ¥
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>writer</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>createWriteStream</span>(<span style=color:#a6e22e>filePath</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>axios</span>({
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>url</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>method</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;GET&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>responseType</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;stream&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>timeout</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>30000</span>, <span style=color:#75715e>// 30ç§’è¶…æ—¶
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>pipe</span>(<span style=color:#a6e22e>writer</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>new</span> Promise((<span style=color:#a6e22e>resolve</span>, <span style=color:#a6e22e>reject</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>writer</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;finish&#34;</span>, <span style=color:#a6e22e>resolve</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>writer</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;error&#34;</span>, <span style=color:#a6e22e>reject</span>);
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`âœ… æ–‡ä»¶ä¸‹è½½æˆåŠŸï¼š</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>filePath</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>filePath</span>;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>`âŒ ä¸‹è½½æ–‡ä»¶å¤±è´¥ï¼ˆå°è¯• </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>attempt</span><span style=color:#e6db74>}</span><span style=color:#e6db74>ï¼‰ï¼š</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>, <span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>attempt</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>retries</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>`ä¸‹è½½æ–‡ä»¶å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ï¼š</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// ç­‰å¾… 1 ç§’åé‡è¯•
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>new</span> Promise((<span style=color:#a6e22e>res</span>) =&gt; <span style=color:#a6e22e>setTimeout</span>(<span style=color:#a6e22e>res</span>, <span style=color:#ae81ff>1000</span>));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ç»Ÿä¸€å¤„ç†æ¶ˆæ¯ï¼ˆæ™®é€šæ¶ˆæ¯å’Œè½¬å‘æ¶ˆæ¯ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;message&#34;</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>checkAuth</span>(<span style=color:#a6e22e>msg</span>)) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>hasFile</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.document <span style=color:#f92672>||</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>photo</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>video</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>isForward</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>forward_from</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>forward_from_chat</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>hasFile</span>) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>typePrefix</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>isForward</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;è½¬å‘&#34;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// æ–‡æ¡£
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>msg</span>.document) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>msg</span>.document.<span style=color:#a6e22e>file_id</span>, <span style=color:#a6e22e>msg</span>.document.<span style=color:#a6e22e>file_name</span>, <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>typePrefix</span><span style=color:#e6db74>}</span><span style=color:#e6db74>æ–‡æ¡£`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// å›¾ç‰‡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>photo</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>photo</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>photo</span>[<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>photo</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileName</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`photo_</span><span style=color:#e6db74>${</span>Date.<span style=color:#a6e22e>now</span>()<span style=color:#e6db74>}</span><span style=color:#e6db74>.jpg`</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>photo</span>.<span style=color:#a6e22e>file_id</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>typePrefix</span><span style=color:#e6db74>}</span><span style=color:#e6db74>å›¾ç‰‡`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// è§†é¢‘
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>video</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileName</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>video</span>.<span style=color:#a6e22e>file_name</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>`video_</span><span style=color:#e6db74>${</span>Date.<span style=color:#a6e22e>now</span>()<span style=color:#e6db74>}</span><span style=color:#e6db74>.mp4`</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>video</span>.<span style=color:#a6e22e>file_id</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>typePrefix</span><span style=color:#e6db74>}</span><span style=color:#e6db74>è§†é¢‘`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /myfiles æ–‡æœ¬åˆ—è¡¨
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/myfiles/</span>, (<span style=color:#a6e22e>msg</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>checkAuth</span>(<span style=color:#a6e22e>msg</span>)) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>all</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT 10`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>userId</span>],
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>rows</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;âŒ æŸ¥è¯¢å¤±è´¥ã€‚&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;ğŸ“­ æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶ã€‚&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>text</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ğŸ“‚ æœ€è¿‘çš„æ–‡ä»¶ï¼š\n\n&#34;</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>inline_keyboard</span> <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>r</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>text</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74> [</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>]\n`</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>inline_keyboard</span>.<span style=color:#a6e22e>push</span>([{ <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;â„¹ï¸ æŸ¥çœ‹è¯¦æƒ…&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`detail_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> }]);
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>text</span>, { <span style=color:#a6e22e>reply_markup</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>inline_keyboard</span> } });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /myfilelist åˆ†é¡µæ˜¾ç¤º
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>sendFilePage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#a6e22e>userId</span>, <span style=color:#a6e22e>page</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>messageId</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>offset</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>page</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>*</span> <span style=color:#a6e22e>PAGE_SIZE</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>all</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT id, file_id, file_name, category FROM files WHERE user_id = ? ORDER BY date DESC LIMIT ? OFFSET ?`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>userId</span>, <span style=color:#a6e22e>PAGE_SIZE</span>, <span style=color:#a6e22e>offset</span>],
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>rows</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;âŒ æŸ¥è¯¢å¤±è´¥ã€‚&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;ğŸ“­ æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶ã€‚&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>text</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`ğŸ“‘ ç¬¬ </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>page</span><span style=color:#e6db74>}</span><span style=color:#e6db74> é¡µï¼ˆæ¯é¡µ </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>PAGE_SIZE</span><span style=color:#e6db74>}</span><span style=color:#e6db74> æ¡ï¼‰\n\n`</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>inline_keyboard</span> <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>mediaGroup</span> <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>r</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>rows</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>text</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74> [</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>]\n`</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>inline_keyboard</span>.<span style=color:#a6e22e>push</span>([
</span></span><span style=display:flex><span>          { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;â„¹ï¸ æŸ¥çœ‹è¯¦æƒ…&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`detail_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>          { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;âŒ åˆ é™¤&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`del_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>          { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;â¬‡ï¸ ä¸‹è½½æœ¬åœ°&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`download_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>        ]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.jpg&#34;</span>) <span style=color:#f92672>||</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.png&#34;</span>)) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>mediaGroup</span>.<span style=color:#a6e22e>push</span>({ <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;photo&#34;</span>, <span style=color:#a6e22e>media</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_id</span>, <span style=color:#a6e22e>caption</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> });
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>totalCountRow</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>new</span> Promise((<span style=color:#a6e22e>resolve</span>) =&gt;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>`SELECT COUNT(*) as cnt FROM files WHERE user_id = ?`</span>, [<span style=color:#a6e22e>userId</span>], (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>row</span>) =&gt;
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>resolve</span>(<span style=color:#a6e22e>row</span>)
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>      );
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>totalPages</span> <span style=color:#f92672>=</span> Math.<span style=color:#a6e22e>ceil</span>(<span style=color:#a6e22e>totalCountRow</span>.<span style=color:#a6e22e>cnt</span> <span style=color:#f92672>/</span> <span style=color:#a6e22e>PAGE_SIZE</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>inline_keyboard</span>.<span style=color:#a6e22e>push</span>([
</span></span><span style=display:flex><span>        { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;â¬…ï¸ ä¸Šä¸€é¡µ&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`page_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>page</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>        { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;â¡ï¸ ä¸‹ä¸€é¡µ&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`page_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>page</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>      ]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>opts</span> <span style=color:#f92672>=</span> { <span style=color:#a6e22e>reply_markup</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>inline_keyboard</span> } };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>mediaGroup</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMediaGroup</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#a6e22e>mediaGroup</span>);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#34;å‘é€ç¼©ç•¥å›¾å¤±è´¥:&#34;</span>, <span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>messageId</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>editMessageText</span>(<span style=color:#a6e22e>text</span>, {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>chat_id</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>chatId</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>message_id</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>messageId</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>reply_markup</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>opts</span>.<span style=color:#a6e22e>reply_markup</span>,
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#a6e22e>text</span>, <span style=color:#a6e22e>opts</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/myfilelist ?(\d+)?/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>checkAuth</span>(<span style=color:#a6e22e>msg</span>)) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>page</span> <span style=color:#f92672>=</span> parseInt(<span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>]) <span style=color:#f92672>||</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>sendFilePage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>page</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /search å…³é”®å­—
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/search (.+)/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>checkAuth</span>(<span style=color:#a6e22e>msg</span>)) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>keyword</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`%</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>%`</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>all</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT id, file_name, category FROM files WHERE user_id = ? AND file_name LIKE ? ORDER BY date DESC LIMIT 10`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>userId</span>, <span style=color:#a6e22e>keyword</span>],
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>rows</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;âŒ æŸ¥è¯¢å¤±è´¥ã€‚&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;ğŸ” æ²¡æœ‰åŒ¹é…çš„æ–‡ä»¶ã€‚&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>text</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`ğŸ” æœç´¢ç»“æœï¼š\n\n`</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>inline_keyboard</span> <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>rows</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>r</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>text</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>`#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74> [</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>]\n`</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>inline_keyboard</span>.<span style=color:#a6e22e>push</span>([{ <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;â„¹ï¸ æŸ¥çœ‹è¯¦æƒ…&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`detail_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> }]);
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>text</span>, { <span style=color:#a6e22e>reply_markup</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>inline_keyboard</span> } });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /getfile id
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/getfile (\d+)/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>checkAuth</span>(<span style=color:#a6e22e>msg</span>)) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>`SELECT file_id, file_name FROM files WHERE id = ?`</span>, [<span style=color:#a6e22e>id</span>], (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>row</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>row</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;âŒ æ–‡ä»¶ä¸å­˜åœ¨ã€‚&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.jpg&#34;</span>)) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendPhoto</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, { <span style=color:#a6e22e>caption</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.mp4&#34;</span>)) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendVideo</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, { <span style=color:#a6e22e>caption</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendDocument</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, {}, { <span style=color:#a6e22e>filename</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /delete id
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>onText</span>(<span style=color:#e6db74>/\/delete (\d+)/</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>match</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>checkAuth</span>(<span style=color:#a6e22e>msg</span>)) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>match</span>[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>run</span>(<span style=color:#e6db74>`DELETE FROM files WHERE id = ? AND user_id = ?`</span>, [<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>userId</span>], <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;âŒ åˆ é™¤å¤±è´¥ã€‚&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>changes</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>&#34;âš ï¸ æ²¡æ‰¾åˆ°è¯¥æ–‡ä»¶æˆ–æ— æƒé™åˆ é™¤ã€‚&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>, <span style=color:#e6db74>`âœ… æ–‡ä»¶(ID=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>) å·²åˆ é™¤ã€‚`</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// callback_query ç»Ÿä¸€å¤„ç†
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;callback_query&#34;</span>, <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>query</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>chatId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>authenticatedUsers</span>.<span style=color:#a6e22e>has</span>(<span style=color:#a6e22e>userId</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>answerCallbackQuery</span>(<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>id</span>, { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;âš ï¸ è¯·å…ˆç™»å½• /login &lt;å¯†ç &gt;&#34;</span> });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;cat_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>category</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;cat_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>userCategory</span>[<span style=color:#a6e22e>userId</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>category</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`âœ… å·²è®¾ç½®åˆ†ç±»ä¸ºï¼š</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;del_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;del_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>confirmOpts</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>reply_markup</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>inline_keyboard</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>          [
</span></span><span style=display:flex><span>            { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;âœ… ç¡®è®¤åˆ é™¤&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`confirmdel_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>            { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;âŒ å–æ¶ˆ&#34;</span>, <span style=color:#a6e22e>callback_data</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`cancel_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>          ],
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`âš ï¸ ç¡®è®¤è¦åˆ é™¤æ–‡ä»¶(ID=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>)å—ï¼Ÿ`</span>, <span style=color:#a6e22e>confirmOpts</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;confirmdel_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;confirmdel_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>run</span>(<span style=color:#e6db74>`DELETE FROM files WHERE id = ? AND user_id = ?`</span>, [<span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>userId</span>], <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;âŒ åˆ é™¤å¤±è´¥ã€‚&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>changes</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;âš ï¸ æ²¡æ‰¾åˆ°è¯¥æ–‡ä»¶æˆ–æ— æƒé™åˆ é™¤ã€‚&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`âœ… æ–‡ä»¶(ID=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>) å·²åˆ é™¤ã€‚`</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;cancel_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;cancel_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`â å·²å–æ¶ˆåˆ é™¤æ–‡ä»¶(ID=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>)ã€‚`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;page_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>page</span> <span style=color:#f92672>=</span> parseInt(<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;page_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>page</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>answerCallbackQuery</span>(<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>id</span>, { <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;å·²ç»æ˜¯ç¬¬ä¸€é¡µ&#34;</span> });
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sendFilePage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#a6e22e>userId</span>, <span style=color:#a6e22e>page</span>, <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>message_id</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;download_&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;download_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>get</span>(
</span></span><span style=display:flex><span>      <span style=color:#e6db74>`SELECT file_id, file_name, category FROM files WHERE id = ? AND user_id = ?`</span>,
</span></span><span style=display:flex><span>      [<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>userId</span>],
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>row</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>row</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;âŒ æ–‡ä»¶ä¸å­˜åœ¨æˆ–æ— æƒé™ä¸‹è½½ã€‚&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>filePath</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>downloadFile</span>(<span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>category</span>);
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`âœ… æ–‡ä»¶å·²ä¸‹è½½åˆ°æœåŠ¡å™¨æœ¬åœ°ï¼š</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>filePath</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>`âŒ </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>message</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;detail_&#34;</span>)) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;detail_&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>get</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`SELECT id, file_id, file_name, category, date, user_id FROM files WHERE id = ? AND user_id = ?`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>userId</span>],
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>row</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>row</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;âŒ æ–‡ä»¶ä¸å­˜åœ¨æˆ–æ— æƒé™æŸ¥çœ‹ã€‚&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>text</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>`ğŸ“‹ æ–‡ä»¶è¯¦æƒ…\n\n`</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>`ID: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\n`</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>`æ–‡ä»¶å: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\n`</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>`åˆ†ç±»: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\n`</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>`ä¸Šä¼ æ—¶é—´: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>date</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\n`</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>`ç”¨æˆ·ID: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>user_id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#a6e22e>text</span>).<span style=color:#a6e22e>then</span>(() =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// è‡ªåŠ¨å‘é€æ–‡ä»¶
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.jpg&#34;</span>) <span style=color:#f92672>||</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.png&#34;</span>)) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendPhoto</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, { <span style=color:#a6e22e>caption</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;.mp4&#34;</span>)) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendVideo</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, { <span style=color:#a6e22e>caption</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendDocument</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_id</span>, {}, { <span style=color:#a6e22e>filename</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>file_name</span> });
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>answerCallbackQuery</span>(<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>id</span>);
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><h1 id=docker>Docker<a hidden class=anchor aria-hidden=true href=#docker>#</a></h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># ä½¿ç”¨å®˜æ–¹ Node.js é•œåƒ</span>
</span></span><span style=display:flex><span>FROM node:20
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># è®¾ç½®å·¥ä½œç›®å½•</span>
</span></span><span style=display:flex><span>WORKDIR /app
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># å¤åˆ¶ package.json å’Œ package-lock.json</span>
</span></span><span style=display:flex><span>COPY package*.json ./
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># å®‰è£…ä¾èµ–</span>
</span></span><span style=display:flex><span>RUN npm install --production
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># å¤åˆ¶é¡¹ç›®ä»£ç </span>
</span></span><span style=display:flex><span>COPY . .
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># æš´éœ²ç«¯å£ï¼ˆæ ¹æ® app.js ç›‘å¬çš„ç«¯å£ï¼‰</span>
</span></span><span style=display:flex><span>EXPOSE <span style=color:#ae81ff>3000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># å®¹å™¨å¯åŠ¨å‘½ä»¤</span>
</span></span><span style=display:flex><span>CMD <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;node&#34;</span>, <span style=color:#e6db74>&#34;bot.js&#34;</span><span style=color:#f92672>]</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker build -t my-node-app .
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker run -d <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --name node-app <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -p 3000:3000 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -v <span style=color:#66d9ef>$(</span>pwd<span style=color:#66d9ef>)</span>:/app <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --restart unless-stopped <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  my-node-app
</span></span></code></pre></div><h1 id=åŸå§‹æ¶ˆæ¯>åŸå§‹æ¶ˆæ¯<a hidden class=anchor aria-hidden=true href=#åŸå§‹æ¶ˆæ¯>#</a></h1><h2 id=æ•°æ®åº“ç»“æ„æ›´æ–°-dbjs>æ•°æ®åº“ç»“æ„æ›´æ–° (db.js)<a hidden class=anchor aria-hidden=true href=#æ•°æ®åº“ç»“æ„æ›´æ–°-dbjs>#</a></h2><p>æ·»åŠ äº†è½¬å‘æ¶ˆæ¯ç›¸å…³å­—æ®µï¼š
is_forward: æ˜¯å¦ä¸ºè½¬å‘æ¶ˆæ¯
forward_from_chat_id: æ¥æºç¾¤ç»„ID
forward_from_chat_title: æ¥æºç¾¤ç»„åç§°
forward_from_chat_type: ç¾¤ç»„ç±»å‹
forward_from_chat_username: ç¾¤ç»„ç”¨æˆ·å
forward_message_id: è½¬å‘æ¶ˆæ¯ID
jump_link: è·³è½¬é“¾æ¥</p><h2 id=è½¬å‘æ¶ˆæ¯å¤„ç†-botjs>è½¬å‘æ¶ˆæ¯å¤„ç† (bot.js)<a hidden class=anchor aria-hidden=true href=#è½¬å‘æ¶ˆæ¯å¤„ç†-botjs>#</a></h2><p>ä¿å­˜ç¾¤ç»„ä¿¡æ¯ï¼šæ£€æµ‹è½¬å‘æ¶ˆæ¯å¹¶ä¿å­˜å®Œæ•´çš„ç¾¤ç»„ä¿¡æ¯
ç”Ÿæˆè·³è½¬é“¾æ¥ï¼š
å…¬å¼€ç¾¤ç»„/é¢‘é“ï¼šhttps://t.me/{username}/{message_id}
ç§æœ‰ç¾¤ç»„ï¼šhttps://t.me/c/{chat_id}/{message_id}
æ˜¾ç¤ºæ¥æºï¼šåœ¨æ–‡ä»¶åˆ—è¡¨ä¸­æ˜¾ç¤ºæ¥æºç¾¤ç»„åç§°</p><h2 id=æŒ‰é’®å¸ƒå±€æ›´æ–°>æŒ‰é’®å¸ƒå±€æ›´æ–°<a hidden class=anchor aria-hidden=true href=#æŒ‰é’®å¸ƒå±€æ›´æ–°>#</a></h2><p>å°†åŸæ¥çš„æŒ‰é’®å¸ƒå±€æ”¹ä¸ºï¼š</p><p>â„¹ï¸ è¯¦æƒ… - æŸ¥çœ‹æ–‡ä»¶è¯¦ç»†ä¿¡æ¯
âŒ åˆ é™¤ - åˆ é™¤æ–‡ä»¶
â¬‡ï¸ ä¸‹è½½ - ä¸‹è½½æ–‡ä»¶åˆ°æœåŠ¡å™¨æœ¬åœ°
ğŸ”— è·³è½¬ - è·³è½¬åˆ°åŸå§‹æ¶ˆæ¯ï¼ˆä»…è½¬å‘æ¶ˆæ¯æ˜¾ç¤ºï¼‰</p><h2 id=è¯¦æƒ…é¡µé¢å¢å¼º>è¯¦æƒ…é¡µé¢å¢å¼º<a hidden class=anchor aria-hidden=true href=#è¯¦æƒ…é¡µé¢å¢å¼º>#</a></h2><p>æ˜¾ç¤ºæ˜¯å¦ä¸ºè½¬å‘æ¶ˆæ¯
æ˜¾ç¤ºæ¥æºç¾¤ç»„ä¿¡æ¯
æ˜¾ç¤ºç¾¤ç»„ç±»å‹
æ˜¾ç¤ºè·³è½¬é“¾æ¥</p><p>è‡ªåŠ¨è¯†åˆ«å¹¶ä¿å­˜è½¬å‘çš„ç¾¤ç»„æ¶ˆæ¯
ä¸ºæ¯ä¸ªè½¬å‘æ¶ˆæ¯ç”Ÿæˆå¯ç‚¹å‡»çš„è·³è½¬é“¾æ¥
åœ¨æ–‡ä»¶åˆ—è¡¨ä¸­æ˜¾ç¤ºç»Ÿä¸€çš„å››ä¸ªæŒ‰é’®ï¼šè¯¦æƒ…ã€åˆ é™¤ã€ä¸‹è½½ã€è·³è½¬
åŒºåˆ†å…¬å¼€ç¾¤å’Œç§æœ‰ç¾¤ï¼Œç”Ÿæˆæ­£ç¡®çš„é“¾æ¥æ ¼å¼</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// é€šç”¨ä¿å­˜å‡½æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>saveFile</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#a6e22e>type</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>from</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>chatId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>category</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>userCategory</span>[<span style=color:#a6e22e>userId</span>] <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;æœªåˆ†ç±»&#34;</span>;
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e>// æ£€æŸ¥æ˜¯å¦ä¸ºè½¬å‘æ¶ˆæ¯
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>isForward</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>forward_from</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>forward_from_chat</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>forwardInfo</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>is_forward</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>isForward</span> <span style=color:#f92672>?</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>:</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>forward_from_chat_id</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>forward_from_chat_title</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>forward_from_chat_type</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>forward_from_chat_username</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>forward_message_id</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>jump_link</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>isForward</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>forward_from_chat</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>forwardChat</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>forward_from_chat</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>forwardInfo</span>.<span style=color:#a6e22e>forward_from_chat_id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>forwardChat</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>forwardInfo</span>.<span style=color:#a6e22e>forward_from_chat_title</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>forwardChat</span>.<span style=color:#a6e22e>title</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>forwardInfo</span>.<span style=color:#a6e22e>forward_from_chat_type</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>forwardChat</span>.<span style=color:#a6e22e>type</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>forwardInfo</span>.<span style=color:#a6e22e>forward_from_chat_username</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>forwardChat</span>.<span style=color:#a6e22e>username</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>forwardInfo</span>.<span style=color:#a6e22e>forward_message_id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>forward_from_message_id</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ç”Ÿæˆè·³è½¬é“¾æ¥
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>forwardChat</span>.<span style=color:#a6e22e>username</span>) {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// å…¬å¼€ç¾¤ç»„/é¢‘é“
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>forwardInfo</span>.<span style=color:#a6e22e>jump_link</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`https://t.me/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>forwardChat</span>.<span style=color:#a6e22e>username</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>forward_from_message_id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// ç§æœ‰ç¾¤ç»„
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>forwardInfo</span>.<span style=color:#a6e22e>jump_link</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`https://t.me/c/</span><span style=color:#e6db74>${</span>Math.<span style=color:#a6e22e>abs</span>(<span style=color:#a6e22e>forwardChat</span>.<span style=color:#a6e22e>id</span>).<span style=color:#a6e22e>toString</span>().<span style=color:#a6e22e>substring</span>(<span style=color:#ae81ff>4</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>forward_from_message_id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>run</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`INSERT INTO files (file_id, file_name, category, user_id, date, is_forward, forward_from_chat_id, forward_from_chat_title, forward_from_chat_type, forward_from_chat_username, forward_message_id, jump_link) VALUES (?, ?, ?, ?, datetime(&#39;now&#39;), ?, ?, ?, ?, ?, ?, ?)`</span>,
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>fileId</span>, <span style=color:#a6e22e>fileName</span>, <span style=color:#a6e22e>category</span>, <span style=color:#a6e22e>userId</span>, <span style=color:#a6e22e>forwardInfo</span>.<span style=color:#a6e22e>is_forward</span>, <span style=color:#a6e22e>forwardInfo</span>.<span style=color:#a6e22e>forward_from_chat_id</span>, <span style=color:#a6e22e>forwardInfo</span>.<span style=color:#a6e22e>forward_from_chat_title</span>, <span style=color:#a6e22e>forwardInfo</span>.<span style=color:#a6e22e>forward_from_chat_type</span>, <span style=color:#a6e22e>forwardInfo</span>.<span style=color:#a6e22e>forward_from_chat_username</span>, <span style=color:#a6e22e>forwardInfo</span>.<span style=color:#a6e22e>forward_message_id</span>, <span style=color:#a6e22e>forwardInfo</span>.<span style=color:#a6e22e>jump_link</span>],
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#e6db74>&#34;âŒ å­˜å‚¨å¤±è´¥ã€‚&#34;</span>);
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>message</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`ğŸ“¦ å·²ä¿å­˜ </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>type</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\nID: </span><span style=color:#e6db74>${</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>lastID</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\næ–‡ä»¶å: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fileName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\nåˆ†ç±»: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>category</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>forwardInfo</span>.<span style=color:#a6e22e>is_forward</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>forwardInfo</span>.<span style=color:#a6e22e>forward_from_chat_title</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>message</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>`\næ¥æºç¾¤ç»„: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>forwardInfo</span>.<span style=color:#a6e22e>forward_from_chat_title</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>bot</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>chatId</span>, <span style=color:#a6e22e>message</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h1 id=bots>bots<a hidden class=anchor aria-hidden=true href=#bots>#</a></h1><p><a href=https://github.com/AZeC4/TelegramBot>https://github.com/AZeC4/TelegramBot</a></p><p><a href=https://github.com/itgoyo/TelegramBot>https://github.com/itgoyo/TelegramBot</a></p><p><a href=https://github.com/itgoyo/TelegramGroup>https://github.com/itgoyo/TelegramGroup</a></p><h1 id=next-tgbot>Next TGBOT<a hidden class=anchor aria-hidden=true href=#next-tgbot>#</a></h1><p>LocalWeb Manage</p><p>go txt config æ–°å»º å›å¤ Q:A é€‚ç”¨äºç¾¤å›å¤</p><p>åˆ†ç±» åˆ—è¡¨ å¯¹åº”åˆ†ç±»
sqlå¤‡ä»½ å‰ç«¯åå°ç­‰</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://qfsyso.github.io/tags/tg/>TG</a></li><li><a href=https://qfsyso.github.io/tags/node/>Node</a></li><li><a href=https://qfsyso.github.io/tags/server/>Server</a></li><li><a href=https://qfsyso.github.io/tags/docker/>Docker</a></li></ul><nav class=paginav><a class=prev href=https://qfsyso.github.io/posts/push-tg-bot/><span class=title>Â« Prev</span><br><span>Push TG Bot</span>
</a><a class=next href=https://qfsyso.github.io/posts/go-file-manager/><span class=title>Next Â»</span><br><span>Go File Manager</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Node TG FileBot on x" href="https://x.com/intent/tweet/?text=Node%20TG%20FileBot&amp;url=https%3a%2f%2fqfsyso.github.io%2fposts%2fnode-tg-filebot%2f&amp;hashtags=TG%2cNode%2cServer%2cDocker"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Node TG FileBot on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fqfsyso.github.io%2fposts%2fnode-tg-filebot%2f&amp;title=Node%20TG%20FileBot&amp;summary=Node%20TG%20FileBot&amp;source=https%3a%2f%2fqfsyso.github.io%2fposts%2fnode-tg-filebot%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Node TG FileBot on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fqfsyso.github.io%2fposts%2fnode-tg-filebot%2f&title=Node%20TG%20FileBot"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Node TG FileBot on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fqfsyso.github.io%2fposts%2fnode-tg-filebot%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Node TG FileBot on whatsapp" href="https://api.whatsapp.com/send?text=Node%20TG%20FileBot%20-%20https%3a%2f%2fqfsyso.github.io%2fposts%2fnode-tg-filebot%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Node TG FileBot on telegram" href="https://telegram.me/share/url?text=Node%20TG%20FileBot&amp;url=https%3a%2f%2fqfsyso.github.io%2fposts%2fnode-tg-filebot%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Node TG FileBot on ycombinator" href="https://news.ycombinator.com/submitlink?t=Node%20TG%20FileBot&u=https%3a%2f%2fqfsyso.github.io%2fposts%2fnode-tg-filebot%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><div class=wtime><div class=wtime2>CST<span id=beijingTime></span> GMT <span id=londonTime></span> EST <span id=newYorkTime></span> PST<span id=losAngelesTime></span></div><div class=wtime2 style=display:none>ä¸œäº¬<span id=tokyoTime></span></div><div class=wtime2 style=display:none>æ¬§æ´²-å·´é»<span id=parisTime></span></div><div class=wtime2 style=display:none>UTC<span id=utcTime></span></div></div><span>&copy; 2025 <a href=https://qfsyso.github.io/>MLOG</a></span> Â·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a>
</span><script type=text/javascript>const timeZoneOffsets={beijing:8,tokyo:9,paris:[1,2],london:[0,1],newYork:[-5,-4],losAngeles:[-8,-7]};function padZero(e){return e<10?"0"+e:e}function formatTime(e){const t=e.getFullYear(),n=padZero(e.getMonth()+1),s=padZero(e.getDate()),o=padZero(e.getHours()),i=padZero(e.getMinutes()),a=padZero(e.getSeconds());return`${t}-${n}-${s} ${o}:${i}:${a}`}function isDaylightSavingTime(e,t){const o=e.getMonth(),n=new Date(e.getFullYear(),3,8,2,0,0),s=new Date(e.getFullYear(),10,1,2,0,0);return(t==="paris"||t==="london"||t==="newYork"||t==="losAngeles")&&e>=n&&e<s}function updateTime(){const e=new Date,t=new Date(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds()),n=formatTime(t);document.getElementById("utcTime").innerHTML=n;for(const n in timeZoneOffsets){const e=timeZoneOffsets[n];let s;Array.isArray(e)?s=isDaylightSavingTime(t,n)?e[1]:e[0]:s=e;const o=new Date(t.getTime()+s*60*60*1e3);document.getElementById(n+"Time").innerHTML=formatTime(o)}setTimeout(updateTime,1e3)}window.onload=function(){updateTime()};function notfound(e){var n=e.src,t=n.split("/"),s=t[t.length-1];e.src="https://47.115.223.75:8080/group1/v2/"+s+"?timestamp="+Date.now(),e.onerror=null}</script></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>