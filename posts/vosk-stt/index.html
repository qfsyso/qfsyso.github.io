<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Vosk STT | MLOG</title>
<meta name=keywords content><meta name=description content='Vosk STT 一、准备环境（Debian） sudo apt update sudo apt install -y python3 python3-pip ffmpeg pip3 install --user vosk 二、下载微型中文模型（≈ 40 MB） wget https://alphacephei.com/vosk/models/vosk-model-small-cn-0.22.zip unzip vosk-model-small-cn-0.22.zip 三、保存以下脚本为 listen.py #!/usr/bin/env python3 import sys, json, os from vosk import Model, KaldiRecognizer import wave MAP = { "空调": 1, "电视": 2, "风扇": 3, "卧室灯": 4, "客厅灯": 5 } def wav2text(path): wf = wave.open(path, "rb") if wf.getnchannels() != 1 or wf.getsampwidth() != 2 or wf.getframerate() != 16000: raise ValueError("音频必须是 16 kHz 16-bit 单声道 WAV") model = Model("vosk-model-small-cn-0.'><meta name=author content="dwd"><link rel=canonical href=https://qfsyso.github.io/posts/vosk-stt/><link crossorigin=anonymous href=/assets/css/stylesheet.f49d66caae9ea0fd43f21f29e71a8d3e284517ed770f2aa86fa012953ad3c9ef.css integrity="sha256-9J1myq6eoP1D8h8p5xqNPihFF+13Dyqob6ASlTrTye8=" rel="preload stylesheet" as=style><link rel=icon href=https://qfsyso.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://qfsyso.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://qfsyso.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://qfsyso.github.io/apple-touch-icon.png><link rel=mask-icon href=https://qfsyso.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://qfsyso.github.io/posts/vosk-stt/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://qfsyso.github.io/posts/vosk-stt/"><meta property="og:site_name" content="MLOG"><meta property="og:title" content="Vosk STT"><meta property="og:description" content='Vosk STT 一、准备环境（Debian） sudo apt update sudo apt install -y python3 python3-pip ffmpeg pip3 install --user vosk 二、下载微型中文模型（≈ 40 MB） wget https://alphacephei.com/vosk/models/vosk-model-small-cn-0.22.zip unzip vosk-model-small-cn-0.22.zip 三、保存以下脚本为 listen.py #!/usr/bin/env python3 import sys, json, os from vosk import Model, KaldiRecognizer import wave MAP = { "空调": 1, "电视": 2, "风扇": 3, "卧室灯": 4, "客厅灯": 5 } def wav2text(path): wf = wave.open(path, "rb") if wf.getnchannels() != 1 or wf.getsampwidth() != 2 or wf.getframerate() != 16000: raise ValueError("音频必须是 16 kHz 16-bit 单声道 WAV") model = Model("vosk-model-small-cn-0.'><meta property="og:locale" content="zh-CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-07-17T21:36:01+08:00"><meta property="article:modified_time" content="2025-07-17T21:36:01+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Vosk STT"><meta name=twitter:description content='Vosk STT 一、准备环境（Debian） sudo apt update sudo apt install -y python3 python3-pip ffmpeg pip3 install --user vosk 二、下载微型中文模型（≈ 40 MB） wget https://alphacephei.com/vosk/models/vosk-model-small-cn-0.22.zip unzip vosk-model-small-cn-0.22.zip 三、保存以下脚本为 listen.py #!/usr/bin/env python3 import sys, json, os from vosk import Model, KaldiRecognizer import wave MAP = { "空调": 1, "电视": 2, "风扇": 3, "卧室灯": 4, "客厅灯": 5 } def wav2text(path): wf = wave.open(path, "rb") if wf.getnchannels() != 1 or wf.getsampwidth() != 2 or wf.getframerate() != 16000: raise ValueError("音频必须是 16 kHz 16-bit 单声道 WAV") model = Model("vosk-model-small-cn-0.'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://qfsyso.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Vosk STT","item":"https://qfsyso.github.io/posts/vosk-stt/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Vosk STT","name":"Vosk STT","description":"Vosk STT 一、准备环境（Debian） sudo apt update sudo apt install -y python3 python3-pip ffmpeg pip3 install --user vosk 二、下载微型中文模型（≈ 40 MB） wget https://alphacephei.com/vosk/models/vosk-model-small-cn-0.22.zip unzip vosk-model-small-cn-0.22.zip 三、保存以下脚本为 listen.py #!/usr/bin/env python3 import sys, json, os from vosk import Model, KaldiRecognizer import wave MAP = { \u0026#34;空调\u0026#34;: 1, \u0026#34;电视\u0026#34;: 2, \u0026#34;风扇\u0026#34;: 3, \u0026#34;卧室灯\u0026#34;: 4, \u0026#34;客厅灯\u0026#34;: 5 } def wav2text(path): wf = wave.open(path, \u0026#34;rb\u0026#34;) if wf.getnchannels() != 1 or wf.getsampwidth() != 2 or wf.getframerate() != 16000: raise ValueError(\u0026#34;音频必须是 16 kHz 16-bit 单声道 WAV\u0026#34;) model = Model(\u0026#34;vosk-model-small-cn-0.","keywords":[],"articleBody":"Vosk STT 一、准备环境（Debian） sudo apt update sudo apt install -y python3 python3-pip ffmpeg pip3 install --user vosk 二、下载微型中文模型（≈ 40 MB） wget https://alphacephei.com/vosk/models/vosk-model-small-cn-0.22.zip unzip vosk-model-small-cn-0.22.zip 三、保存以下脚本为 listen.py #!/usr/bin/env python3 import sys, json, os from vosk import Model, KaldiRecognizer import wave MAP = { \"空调\": 1, \"电视\": 2, \"风扇\": 3, \"卧室灯\": 4, \"客厅灯\": 5 } def wav2text(path): wf = wave.open(path, \"rb\") if wf.getnchannels() != 1 or wf.getsampwidth() != 2 or wf.getframerate() != 16000: raise ValueError(\"音频必须是 16 kHz 16-bit 单声道 WAV\") model = Model(\"vosk-model-small-cn-0.22\") rec = KaldiRecognizer(model, wf.getframerate()) rec.SetWords(True) text = \"\" while True: data = wf.readframes(4000) if len(data) == 0: break if rec.AcceptWaveform(data): text += json.loads(rec.Result())[\"text\"] text += json.loads(rec.FinalResult())[\"text\"] return text.replace(\" \", \"\") def find_index(text): for key, idx in MAP.items(): if key in text: return idx return 0 if __name__ == \"__main__\": if len(sys.argv) \u003c 2: print(\"用法: python3 listen.py \") sys.exit(1) t = wav2text(sys.argv[1]) print(\"识别文本:\", t) print(\"对应序号:\", find_index(t)) 四、运行示例 python3 listen.py wsd.wav 如果音频内容是「我是登」，识别结果里包含「卧室灯」，脚本会输出\n识别文本: 我是登卧室灯 对应序号: 4 若未命中任何关键词则输出 对应序号: 0。 打包docker运行 listen.py #!/usr/bin/env python3 import sys, json, os from vosk import Model, KaldiRecognizer import wave MAP = { \"空调\": 1, \"电视\": 2, \"风扇\": 3, \"卧室灯\": 4, \"客厅灯\": 5 } def wav2text(path): wf = wave.open(path, \"rb\") if wf.getnchannels() != 1 or wf.getsampwidth() != 2 or wf.getframerate() != 16000: raise ValueError(\"音频必须是 16 kHz 16-bit 单声道 WAV\") model = Model(\"/opt\") rec = KaldiRecognizer(model, wf.getframerate()) rec.SetWords(True) text = \"\" while True: data = wf.readframes(4000) if len(data) == 0: break if rec.AcceptWaveform(data): text += json.loads(rec.Result())[\"text\"] text += json.loads(rec.FinalResult())[\"text\"] return text.replace(\" \", \"\") def find_index(text): for key, idx in MAP.items(): if key in text: return idx return 0 if __name__ == \"__main__\": if len(sys.argv) \u003c 2: print(\"用法: python3 listen.py \") sys.exit(1) t = wav2text(sys.argv[1]) print(\"识别文本:\", t) print(\"对应序号:\", find_index(t)) dockerfile # ---- 1. 基础镜像 ---- FROM python:3.11-slim-bookworm # ---- 2. 系统依赖 \u0026 ffmpeg ---- RUN apt-get update \u0026\u0026 \\ apt-get install -y --no-install-recommends \\ ffmpeg \\ wget \\ unzip \u0026\u0026 \\ rm -rf /var/lib/apt/lists/* # ---- 3. 安装 Vosk ---- RUN pip install --no-cache-dir vosk==0.3.45 # ---- 4. 下载并解压中文小模型 ---- WORKDIR /opt RUN wget -q https://alphacephei.com/vosk/models/vosk-model-small-cn-0.22.zip \u0026\u0026 \\ unzip -q vosk-model-small-cn-0.22.zip \u0026\u0026 \\ mv vosk-model-small-cn-0.22/* ./ \u0026\u0026 \\ rmdir vosk-model-small-cn-0.22 \u0026\u0026 \\ rm vosk-model-small-cn-0.22.zip # ---- 5. 复制脚本 ---- COPY listen.py /opt/listen.py RUN chmod +x /opt/listen.py # ---- 6. 入口脚本：自动转码 + 识别 ---- # 创建一个小脚本作为 ENTRYPOINT RUN printf '#!/bin/bash\\n\\ set -e\\n\\ IN=\"$1\"\\n\\ BASE=$(basename \"$IN\" .wav)\\n\\ OUT=\"${BASE}_16k.wav\"\\n\\ echo \"Converting $IN -\u003e $OUT ...\"\\n\\ ffmpeg -y -i \"$IN\" -ar 16000 -ac 1 -sample_fmt s16 \"$OUT\" \u003e/dev/null 2\u003e\u00261\\n\\ echo \"Running Vosk on $OUT ...\"\\n\\ exec python3 /opt/listen.py \"$OUT\"\\n' \u003e /opt/entry.sh \u0026\u0026 chmod +x /opt/entry.sh WORKDIR /workspace ENTRYPOINT [\"/opt/entry.sh\"] 构建使用 docker build -t stt-cn-mini . docker run --rm -v $(pwd):/workspace stt-cn-mini wsd.wav 使用pypinyin进行纠错 下面给出「整句拼音容错」的完整实现： 用 pypinyin 把整句话转拼音（带声调）， 再与标准关键词的拼音做模糊匹配， 支持「登」→「灯」，「客厅」→「客厅灯」等任意同音/近音组合。 只改 listen.py，其余不变。\n1. 安装依赖（Dockerfile 里加一行即可） RUN pip install --no-cache-dir vosk==0.3.45 pypinyin fuzzywuzzy python-Levenshtein 2. 新的 listen.py（直接替换） #!/usr/bin/env python3 import sys, json, os, re from vosk import Model, KaldiRecognizer import wave from pypinyin import lazy_pinyin from fuzzywuzzy import fuzz # 关键词→序号 KEYWORD2ID = { \"空调\": 1, \"电视\": 2, \"风扇\": 3, \"卧室灯\": 4, \"客厅灯\": 5, } # 预先把关键词转成拼音列表，避免每次重复计算 KW_PINYIN = {kw: \"\".join(lazy_pinyin(kw)) for kw in KEYWORD2ID} def wav2text(path): wf = wave.open(path, \"rb\") if wf.getnchannels() != 1 or wf.getsampwidth() != 2 or wf.getframerate() != 16000: raise ValueError(\"音频必须是 16 kHz 16-bit 单声道 WAV\") model = Model(\"/opt\") rec = KaldiRecognizer(model, wf.getframerate()) rec.SetWords(True) text = \"\" while True: data = wf.readframes(4000) if len(data) == 0: break if rec.AcceptWaveform(data): text += json.loads(rec.Result())[\"text\"] text += json.loads(rec.FinalResult())[\"text\"] return text.replace(\" \", \"\") def fuzzy_match(text: str) -\u003e int: \"\"\"基于拼音的模糊匹配，返回最相似关键词的序号\"\"\" text_py = \"\".join(lazy_pinyin(text)) # 整句话转拼音 best_kw, best_score = \"\", 0 for kw, kw_py in KW_PINYIN.items(): score = fuzz.partial_ratio(text_py, kw_py) if score \u003e best_score: best_kw, best_score = kw, score # 阈值可自己调，80 以上基本可接受 if best_score \u003e= 80: return KEYWORD2ID[best_kw] return 0 if __name__ == \"__main__\": if len(sys.argv) \u003c 2: print(\"用法: python3 listen.py \") sys.exit(1) t = wav2text(sys.argv[1]) idx = fuzzy_match(t) print(\"识别文本:\", t) print(\"对应序号:\", idx) 3. 构建 \u0026 运行 docker build -t stt-cn-mini . docker run --rm -v $(pwd):/workspace stt-cn-mini wsd.wav 示例结果\n识别文本: 我是登 对应序号: 4 # 因为 \"woshideng\" 与 \"woshideng\" 完全匹配 \"卧室灯\" 4. 效果说明 pypinyin.lazy_pinyin() → 把整句话转拼音（带数字声调）。 fuzz.partial_ratio() → 计算句子拼音与关键词拼音的相似度。\n阈值 80 以上即可覆盖常见同音/近音错误，调低或调高视实际效果。\n结果 docker run --rm -v $(pwd):/workspace stt-cn-mini test_wsd.wav Converting test_wsd.wav -\u003e test_wsd_16k.wav ... Running Vosk on test_wsd_16k.wav ... 识别文本: 小爱同学帮我打开我是灯 对应序号: 4 web API 轻量级 FastAPI 服务 容器化部署（Debian 基础镜像 + Vosk + 中文拼音容错）。 通过 HTTP POST /recognize 提交 JSON：\n{\"url\": \"http:///.wav\"} 返回同音容错后的结果：\n{ \"text\": \"我是登\", \"matched\": \"卧室灯\", \"id\": 4 } 1. 目录结构 stt-api/ ├── Dockerfile ├── requirements.txt └── app.py\n2. app.py from fastapi import FastAPI, HTTPException from pydantic import BaseModel, HttpUrl import tempfile, os, requests, wave, json from vosk import Model, KaldiRecognizer from pypinyin import lazy_pinyin from fuzzywuzzy import fuzz app = FastAPI(title=\"STT-CN-API\", version=\"1.0\") # 关键词配置 KEYWORD2ID = {\"空调\": 1, \"电视\": 2, \"风扇\": 3, \"卧室灯\": 4, \"客厅灯\": 5} KW_PINYIN = {kw: \"\".join(lazy_pinyin(kw)) for kw in KEYWORD2ID} # 全局加载一次模型 MODEL = Model(\"/opt/models\") def wav2text(path: str) -\u003e str: with wave.open(path, \"rb\") as wf: if wf.getnchannels() != 1 or wf.getsampwidth() != 2 or wf.getframerate() != 16000: raise ValueError(\"音频必须是 16 kHz 16-bit 单声道 WAV\") rec = KaldiRecognizer(MODEL, wf.getframerate()) rec.SetWords(True) result = [] while True: data = wf.readframes(4000) if len(data) == 0: break if rec.AcceptWaveform(data): result.append(json.loads(rec.Result())[\"text\"]) result.append(json.loads(rec.FinalResult())[\"text\"]) return \"\".join(result).strip() def fuzzy_match(text: str): text_py = \"\".join(lazy_pinyin(text)) best_kw, best_score = \"\", 0 for kw, kw_py in KW_PINYIN.items(): score = fuzz.partial_ratio(text_py, kw_py) if score \u003e best_score: best_kw, best_score = kw, score return best_kw if best_score \u003e= 70 else None class RecognizeRequest(BaseModel): url: HttpUrl @app.post(\"/recognize\") async def recognize(req: RecognizeRequest): wav_url = str(req.url) try: # 下载到临时文件 with tempfile.NamedTemporaryFile(suffix=\".wav\", delete=False) as tmp: tmp.write(requests.get(wav_url, timeout=10).content) tmp_path = tmp.name # 转码（Vosk 只认 16k/16bit/单声道） out_path = tmp_path + \"_16k.wav\" os.system( f\"ffmpeg -y -i {tmp_path} -ar 16000 -ac 1 -sample_fmt s16 {out_path} \u003e/dev/null 2\u003e\u00261\" ) # 识别 text = wav2text(out_path) matched = fuzzy_match(text) resp = {\"text\": text, \"matched\": matched, \"id\": KEYWORD2ID.get(matched, 0)} except Exception as e: raise HTTPException(status_code=500, detail=str(e)) finally: for p in (tmp_path, out_path): if os.path.exists(p): os.remove(p) return resp 3. requirements.txt fastapi==0.110.2 uvicorn[standard]==0.29.0 vosk==0.3.45 pypinyin==0.51.0 fuzzywuzzy==0.18.0 python-Levenshtein==0.25.1 requests==2.32.3 4. Dockerfile FROM python:3.11-slim-bookworm RUN apt-get update \u0026\u0026 \\ apt-get install -y --no-install-recommends \\ ffmpeg wget unzip \u0026\u0026 \\ rm -rf /var/lib/apt/lists/* WORKDIR /opt # 下载并解压模型到 /opt/models RUN wget -q https://alphacephei.com/vosk/models/vosk-model-small-cn-0.22.zip \u0026\u0026 \\ unzip -q vosk-model-small-cn-0.22.zip \u0026\u0026 \\ mv vosk-model-small-cn-0.22 models \u0026\u0026 \\ rm vosk-model-small-cn-0.22.zip WORKDIR /app COPY requirements.txt . RUN pip install --no-cache-dir -r requirements.txt COPY app.py . EXPOSE 8000 CMD [\"uvicorn\", \"app:app\", \"--host\", \"0.0.0.0\", \"--port\", \"8000\"] 5. 构建 \u0026 运行 docker build -t stt-api . docker run -d --name stt -p 8000:8000 stt-api 6. 调用示例 curl -X POST http://localhost:8000/recognize \\ -H \"Content-Type: application/json\" \\ -d '{\"url\":\"http://192.168.80.47:16552/wsd.wav\"}' 返回：\n{ \"text\": \"我是登\", \"matched\": \"卧室灯\", \"id\": 4 } 可使用 tts 进行生成语音测试 ttsfm https://github.com/dbccccccc/ttsfm ChatTTS-ui https://github.com/tianhm/ChatTTS-ui\ndebian nodocker webapi 直接裸机部署、无需 Docker” 的 Vosk + 中文拼音容错 WebAPI 完整代码。 已在 Ubuntu / Debian ≥20.04 + Python 3.8+ 验证通过，仅需 5 步即可上线。\n1. 系统依赖（一次性） sudo apt update sudo apt install -y python3 python3-pip ffmpeg wget unzip 2. 下载并放置中文小模型 # 在任意目录，例如 /opt/vosk-model sudo mkdir -p /opt/vosk-model cd /opt/vosk-model sudo wget https://alphacephei.com/vosk/models/vosk-model-small-cn-0.22.zip sudo unzip vosk-model-small-cn-0.22.zip sudo mv vosk-model-small-cn-0.22/* ./ \u0026\u0026 sudo rmdir vosk-model-small-cn-0.22 3. 安装 Python 依赖 pip3 install --user \\ fastapi uvicorn vosk pypinyin fuzzywuzzy python-Levenshtein requests 4. 完整代码 app.py 保存为 ~/stt_api/app.py（路径随意）。\n#!/usr/bin/env python3 import os, tempfile, wave, json, requests from fastapi import FastAPI, HTTPException from pydantic import BaseModel, HttpUrl from vosk import Model, KaldiRecognizer from pypinyin import lazy_pinyin from fuzzywuzzy import fuzz # ------------- 全局配置 ------------- KEYWORD2ID = {\"空调\": 1, \"电视\": 2, \"风扇\": 3, \"卧室灯\": 4, \"客厅灯\": 5} KW_PINYIN = {kw: \"\".join(lazy_pinyin(kw)) for kw in KEYWORD2ID} MODEL_DIR = \"/opt/vosk-model\" # 与步骤2一致 MODEL = Model(MODEL_DIR) app = FastAPI(title=\"Vosk-CN-API\", version=\"1.0\") # ------------- 工具函数 ------------- def wav2text(path: str) -\u003e str: with wave.open(path, \"rb\") as wf: if wf.getnchannels() != 1 or wf.getsampwidth() != 2 or wf.getframerate() != 16000: raise ValueError(\"音频需 16kHz/16-bit/单声道\") rec = KaldiRecognizer(MODEL, wf.getframerate()) rec.SetWords(True) result = [] while True: data = wf.readframes(4000) if len(data) == 0: break if rec.AcceptWaveform(data): result.append(json.loads(rec.Result())[\"text\"]) result.append(json.loads(rec.FinalResult())[\"text\"]) return \"\".join(result).strip() def fuzzy_match(text: str): txt_py = \"\".join(lazy_pinyin(text)) best_kw, best_score = \"\", 0 for kw, kw_py in KW_PINYIN.items(): score = fuzz.partial_ratio(txt_py, kw_py) if score \u003e best_score: best_kw, best_score = kw, score return best_kw if best_score \u003e= 70 else None # ------------- 接口 ------------- class RecognizeRequest(BaseModel): url: HttpUrl @app.post(\"/recognize\") def recognize(req: RecognizeRequest): wav_url = str(req.url) try: with tempfile.NamedTemporaryFile(suffix=\".wav\", delete=False) as tmp: tmp.write(requests.get(wav_url, timeout=10).content) tmp_path = tmp.name # 转码 out_path = tmp_path + \"_16k.wav\" os.system( f\"ffmpeg -y -i {tmp_path} -ar 16000 -ac 1 -sample_fmt s16 {out_path} \u003e/dev/null 2\u003e\u00261\" ) text = wav2text(out_path) matched = fuzzy_match(text) return {\"text\": text, \"matched\": matched, \"id\": KEYWORD2ID.get(matched, 0)} except Exception as e: raise HTTPException(status_code=500, detail=str(e)) finally: for p in (tmp_path, out_path): if os.path.exists(p): os.remove(p) # ------------- 本地调试 ------------- if __name__ == \"__main__\": import uvicorn uvicorn.run(app, host=\"0.0.0.0\", port=8000) 5. 启动服务 mkdir -p ~/stt_api \u0026\u0026 cd ~/stt_api nano app.py # 粘贴上面代码 python3 app.py # 前台运行，或后台用 nohup / systemd 6. 调用示例 curl -X POST http://\u003c服务器IP\u003e:8000/recognize \\ -H \"Content-Type: application/json\" \\ -d '{\"url\":\"http://192.168.80.47:16552/wsd.wav\"}' 返回：\n{ \"text\": \"我是登\", \"matched\": \"卧室灯\", \"id\": 4 } 7. 开机自启（可选） 创建 systemd 文件 /etc/systemd/system/stt.service：\n[Unit] Description=Vosk-CN-API After=network.target [Service] Type=exec ExecStart=/usr/bin/python3 /home/ubuntu/stt_api/app.py Restart=always User=ubuntu WorkingDirectory=/home/ubuntu/stt_api [Install] WantedBy=multi-user.target sudo systemctl daemon-reload sudo systemctl enable --now stt 至此，无需 Docker 的 Vosk WebAPI 已部署完成。\nPEP668 Debian 12 / Ubuntu 23.04+ 启用了 PEP668，禁止用 pip3 –user 或 sudo pip 往系统 Python 里装包。 虚拟环境\n安装系统包（只需一次）\nsudo apt update sudo apt install -y python3-venv python3-pip ffmpeg wget unzip 创建并激活虚拟环境\npython3 -m venv ~/stt_venv source ~/stt_venv/bin/activate # 以后每次运行前都先激活 在虚拟环境里安装依赖\npip install --upgrade pip pip install fastapi uvicorn vosk pypinyin fuzzywuzzy python-Levenshtein requests cd ~/stt_api ~/stt_venv/bin/python app.py # 或 uvicorn app:app --host 0.0.0.0 --port 8000 测试\ncurl -X POST http://localhost:8000/recognize \\ -H \"Content-Type: application/json\" \\ -d '{\"url\":\"http://192.168.80.47:16552/wsd.wav\"}' Whisper版本 Whisper 是 OpenAI 出的开源语音识别模型（支持多语言，含中文）\nwhisper.cpp 是 Whisper 的轻量 C/C++ 版本，专门针对 CPU 做了优化\n有 Python binding，也可命令行直接跑\n体积小，tiny/base 模型几十 MB\n优点\n开源，完全离线，专门针对 CPU 做了优化\n缺点\n对比 Vosk 稍微吃一点 CPU（但 tiny 模型负载很低）\n不支持流式识别（一次识别一段音频）\nwhisper-api\n使用 轻量版 Whisper（openai-whisper CPU 推理即可，无需 GPU）。 其余逻辑不变：接收 URL → 下载 → 转码 → 中文同音纠错 → 返回 JSON。\n1. 目录结构 whisper-api/ ├── Dockerfile ├── requirements.txt └── app.py\n2. requirements.txt fastapi==0.110.2 uvicorn[standard]==0.29.0 openai-whisper==20231117 pypinyin==0.51.0 fuzzywuzzy==0.18.0 python-Levenshtein==0.25.1 requests==2.32.3 3. app.py（完全替换旧版本） from fastapi import FastAPI, HTTPException from pydantic import BaseModel, HttpUrl import tempfile, os, requests import whisper from pypinyin import lazy_pinyin from fuzzywuzzy import fuzz app = FastAPI(title=\"Whisper-CN-API\", version=\"1.1\") # 关键词配置 KEYWORD2ID = {\"空调\": 1, \"电视\": 2, \"风扇\": 3, \"卧室灯\": 4, \"客厅灯\": 5} KW_PINYIN = {kw: \"\".join(lazy_pinyin(kw)) for kw in KEYWORD2ID} # 全局加载一次模型（base 体积小，中文够用） MODEL = whisper.load_model(\"base\") class RecognizeRequest(BaseModel): url: HttpUrl def fuzzy_match(text: str): text_py = \"\".join(lazy_pinyin(text)) best_kw, best_score = \"\", 0 for kw, kw_py in KW_PINYIN.items(): score = fuzz.partial_ratio(text_py, kw_py) if score \u003e best_score: best_kw, best_score = kw, score return best_kw if best_score \u003e= 70 else None @app.post(\"/recognize\") async def recognize(req: RecognizeRequest): wav_url = str(req.url) try: # 下载到临时文件 with tempfile.NamedTemporaryFile(suffix=\".wav\", delete=False) as tmp: tmp.write(requests.get(wav_url, timeout=10).content) tmp_path = tmp.name # 转码 16k/16bit/单声道（Whisper 会自动重采样，但统一格式更稳） out_path = tmp_path + \"_16k.wav\" os.system( f\"ffmpeg -y -i {tmp_path} -ar 16000 -ac 1 -sample_fmt s16 {out_path} \u003e/dev/null 2\u003e\u00261\" ) # Whisper 识别 result = MODEL.transcribe(out_path, language=\"zh\", fp16=False) text = result[\"text\"].strip() matched = fuzzy_match(text) resp = {\"text\": text, \"matched\": matched, \"id\": KEYWORD2ID.get(matched, 0)} except Exception as e: raise HTTPException(status_code=500, detail=str(e)) finally: for p in (tmp_path, out_path): if os.path.exists(p): os.remove(p) return resp 4. Dockerfile FROM python:3.11-slim-bookworm RUN apt-get update \u0026\u0026 \\ apt-get install -y --no-install-recommends \\ ffmpeg wget \u0026\u0026 \\ rm -rf /var/lib/apt/lists/* WORKDIR /app COPY requirements.txt . RUN pip install --no-cache-dir -r requirements.txt COPY app.py . EXPOSE 8000 CMD [\"uvicorn\", \"app:app\", \"--host\", \"0.0.0.0\", \"--port\", \"8000\"] 5. 构建 \u0026 运行 docker build -t whisper-api . docker run -d --name whisper -p 8000:8000 whisper-api 6. 调用示例（与之前完全一致） curl -X POST http://localhost:8000/recognize \\ -H \"Content-Type: application/json\" \\ -d '{\"url\":\"http://192.168.80.47:16552/wsd.wav\"}' 返回示例：\n{ \"text\": \"我是登\", \"matched\": \"卧室灯\", \"id\": 4 } 7. 模型大小说明 模型\t体积\tCPU 推理速度 tiny\t39 MB\t非常快 base\t74 MB\t推荐（已用） small\t244 MB\t更准但更慢\n如需更准，把 load_model(“base”) 换成 “small” 即可，无需改其他代码。\nvosk-qwen 1. 系统依赖（一次性） sudo apt update sudo apt install -y python3-venv ffmpeg wget unzip git git-lfs 2. 虚拟环境 \u0026 依赖 python3 -m venv ~/qwen_stt source ~/qwen_stt/bin/activate pip install --upgrade pip pip install vosk transformers torch accelerate \\ pypinyin fuzzywuzzy python-Levenshtein \\ fastapi uvicorn aiohttp aiofiles requests 3. 下载模型（≈ 1.5 GB） mkdir -p ~/qwen_stt/models \u0026\u0026 cd ~/qwen_stt/models # 1. Vosk 中文小模型 wget https://alphacephei.com/vosk/models/vosk-model-small-cn-0.22.zip unzip vosk-model-small-cn-0.22.zip \u0026\u0026 mv vosk-model-small-cn-0.22 vosk # 2. Qwen2.5-0.5B-it git lfs install git clone https://huggingface.co/Qwen/Qwen2.5-0.5B-Instruct qwen2.5-0.5b 4. 单文件 app.py 保存为 ~/qwen_stt/app.py 即可运行。\n#!/usr/bin/env python3 \"\"\" Vosk 关键词（拼音匹配） + Qwen2.5-0.5B（未命中） - 命中关键词 → 返回 id - 未命中 → 用 Vosk 原文对话 \"\"\" import torch import os, tempfile, wave, json, asyncio, aiofiles, aiohttp from fastapi import FastAPI, HTTPException, UploadFile, File from pydantic import BaseModel, HttpUrl from vosk import Model, KaldiRecognizer from pypinyin import lazy_pinyin from fuzzywuzzy import fuzz from transformers import AutoTokenizer, AutoModelForCausalLM ############################################################################### KEYWORD2ID = {\"空调\": 1, \"电视\": 2, \"风扇\": 3, \"卧室灯\": 4, \"客厅灯\": 5} QWEN_PATH = os.path.join(os.path.dirname(__file__), \"models\", \"qwen2.5-0.5b\") VOSK_PATH = os.path.join(os.path.dirname(__file__), \"models\", \"vosk\") vosk_model = Model(VOSK_PATH) tok = AutoTokenizer.from_pretrained(QWEN_PATH, trust_remote_code=True) chat_model = AutoModelForCausalLM.from_pretrained( QWEN_PATH, torch_dtype=torch.float16, device_map=\"auto\", trust_remote_code=True ).eval() app = FastAPI(title=\"Vosk-Key-Qwen\", version=\"1.0\") ############################################################################### def wav2text(path: str) -\u003e str: with wave.open(path, \"rb\") as wf: if wf.getnchannels() != 1 or wf.getsampwidth() != 2 or wf.getframerate() != 16000: raise ValueError(\"音频需 16 kHz 16-bit 单声道\") rec = KaldiRecognizer(vosk_model, wf.getframerate()) res = [] while True: data = wf.readframes(4000) if not data: break if rec.AcceptWaveform(data): res.append(json.loads(rec.Result())[\"text\"]) res.append(json.loads(rec.FinalResult())[\"text\"]) return \"\".join(res).strip() def fuzzy_match(text: str): \"\"\"拼音匹配\"\"\" txt_py = \"\".join(lazy_pinyin(text)) for kw, kid in KEYWORD2ID.items(): if fuzz.partial_ratio(\"\".join(lazy_pinyin(kw)), txt_py) \u003e= 70: return kw, kid return None, 0 def qwen_chat(prompt: str) -\u003e str: msgs = [{\"role\": \"user\", \"content\": prompt}] text = tok.apply_chat_template(msgs, tokenize=False, add_generation_prompt=True) inputs = tok(text, return_tensors=\"pt\") out = chat_model.generate(**inputs, max_new_tokens=64, do_sample=True, temperature=0.7) return tok.decode(out[0][len(inputs.input_ids[0]):], skip_special_tokens=True).strip() ############################################################################### class RecURL(BaseModel): url: HttpUrl async def _do_recognize(audio_path: str) -\u003e dict: text = await asyncio.to_thread(wav2text, audio_path) kw, kid = fuzzy_match(text) if kw: return {\"text\": text, \"keyword\": kw, \"id\": kid} reply = await asyncio.to_thread(qwen_chat, text) return {\"text\": text, \"keyword\": None, \"id\": 0, \"chat\": reply} ############################################################################### @app.post(\"/recognize\") async def recognize_url(req: RecURL): try: async with aiohttp.ClientSession(timeout=aiohttp.ClientTimeout(total=10)) as session: async with session.get(str(req.url)) as resp: if resp.status != 200: raise HTTPException(status_code=400, detail=f\"远程文件 {resp.status}\") data = await resp.read() with tempfile.NamedTemporaryFile(suffix=\".wav\", delete=False) as tmp: tmp.write(data) tmp_path = tmp.name out_path = tmp_path + \"_16k.wav\" await asyncio.to_thread(lambda: os.system(f\"ffmpeg -y -i {tmp_path} -ar 16000 -ac 1 -sample_fmt s16 {out_path} \u003e/dev/null 2\u003e\u00261\")) return await asyncio.wait_for(_do_recognize(out_path), timeout=15) except asyncio.TimeoutError: raise HTTPException(status_code=504, detail=\"处理超时\") except Exception as e: raise HTTPException(status_code=500, detail=str(e)) finally: for p in (tmp_path, out_path) if 'tmp_path' in locals() else (): if os.path.exists(p): os.remove(p) @app.post(\"/upload\") async def upload_file(file: UploadFile = File(...)): try: with tempfile.NamedTemporaryFile(suffix=\".wav\", delete=False) as tmp: async with aiofiles.open(tmp.name, \"wb\") as f: await f.write(await file.read()) out = tmp.name + \"_16k.wav\" await asyncio.to_thread(lambda: os.system(f\"ffmpeg -y -i {tmp.name} -ar 16000 -ac 1 -sample_fmt s16 {out} \u003e/dev/null 2\u003e\u00261\")) return await asyncio.wait_for(_do_recognize(out), timeout=15) except asyncio.TimeoutError: raise HTTPException(status_code=504, detail=\"处理超时\") except Exception as e: raise HTTPException(status_code=500, detail=str(e)) finally: for p in (tmp.name, out) if 'tmp.name' in locals() else (): if os.path.exists(p): os.remove(p) ############################################################################### if __name__ == \"__main__\": import uvicorn uvicorn.run(app, host=\"0.0.0.0\", port=8000) 启动 source ~/qwen_stt/bin/activate python ~/qwen_stt/app.py 调用示例 # 远程 curl -X POST http://localhost:8000/recognize \\ -H \"Content-Type: application/json\" \\ -d '{\"url\":\"http://192.168.80.47:16552/test.wav\"}' # 本地 curl -X POST http://localhost:8000/upload \\ -F \"file=@/home/ubuntu/test.wav\" 返回（命中卧室灯）：\n{ \"text\": \"帮我打开卧室灯\", \"keyword\": \"卧室灯\", \"id\": 4, \"chat\": \"已为您打开卧室灯！\" } 未命中：\n{ \"text\": \"今天天气怎么样\", \"keyword\": null, \"id\": 0, \"chat\": \"今天北京晴，25℃。\" } multipart err pip install python-multipart ","wordCount":"2488","inLanguage":"en","datePublished":"2025-07-17T21:36:01+08:00","dateModified":"2025-07-17T21:36:01+08:00","author":{"@type":"Person","name":"dwd"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://qfsyso.github.io/posts/vosk-stt/"},"publisher":{"@type":"Organization","name":"MLOG","logo":{"@type":"ImageObject","url":"https://qfsyso.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://qfsyso.github.io/ accesskey=h title="MLOG (Alt + H)">MLOG</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://qfsyso.github.io/posts/ title=Archive><span>Archive</span></a></li><li><a href=https://qfsyso.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://qfsyso.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Vosk STT</h1><div class=post-meta><span title='2025-07-17 21:36:01 +0800 +0800'>July 17, 2025</span>&nbsp;·&nbsp;12 min&nbsp;·&nbsp;dwd</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#vosk-stt aria-label="Vosk STT">Vosk STT</a><ul><li><a href=#%e4%b8%80%e5%87%86%e5%a4%87%e7%8e%af%e5%a2%83debian aria-label=一、准备环境（Debian）>一、准备环境（Debian）</a></li><li><a href=#%e4%ba%8c%e4%b8%8b%e8%bd%bd%e5%be%ae%e5%9e%8b%e4%b8%ad%e6%96%87%e6%a8%a1%e5%9e%8b-40-mb aria-label="二、下载微型中文模型（≈ 40 MB）">二、下载微型中文模型（≈ 40 MB）</a></li><li><a href=#%e4%b8%89%e4%bf%9d%e5%ad%98%e4%bb%a5%e4%b8%8b%e8%84%9a%e6%9c%ac%e4%b8%ba-listenpy aria-label="三、保存以下脚本为 listen.py">三、保存以下脚本为 listen.py</a></li><li><a href=#%e5%9b%9b%e8%bf%90%e8%a1%8c%e7%a4%ba%e4%be%8b aria-label=四、运行示例>四、运行示例</a></li></ul></li><li><a href=#%e6%89%93%e5%8c%85docker%e8%bf%90%e8%a1%8c aria-label=打包docker运行>打包docker运行</a><ul><li><a href=#listenpy aria-label=listen.py>listen.py</a></li><li><a href=#dockerfile aria-label=dockerfile>dockerfile</a></li><li><a href=#%e6%9e%84%e5%bb%ba%e4%bd%bf%e7%94%a8 aria-label=构建使用>构建使用</a></li></ul></li><li><a href=#%e4%bd%bf%e7%94%a8pypinyin%e8%bf%9b%e8%a1%8c%e7%ba%a0%e9%94%99 aria-label=使用pypinyin进行纠错>使用pypinyin进行纠错</a><ul><li><a href=#1-%e5%ae%89%e8%a3%85%e4%be%9d%e8%b5%96dockerfile-%e9%87%8c%e5%8a%a0%e4%b8%80%e8%a1%8c%e5%8d%b3%e5%8f%af aria-label="1. 安装依赖（Dockerfile 里加一行即可）">1. 安装依赖（Dockerfile 里加一行即可）</a></li><li><a href=#2-%e6%96%b0%e7%9a%84-listenpy%e7%9b%b4%e6%8e%a5%e6%9b%bf%e6%8d%a2 aria-label="2. 新的 listen.py（直接替换）">2. 新的 listen.py（直接替换）</a></li><li><a href=#3-%e6%9e%84%e5%bb%ba--%e8%bf%90%e8%a1%8c aria-label="3. 构建 & 运行">3. 构建 & 运行</a></li><li><a href=#4-%e6%95%88%e6%9e%9c%e8%af%b4%e6%98%8e aria-label="4. 效果说明">4. 效果说明</a></li><li><a href=#%e7%bb%93%e6%9e%9c aria-label=结果>结果</a></li></ul></li><li><a href=#web-api aria-label="web API">web API</a><ul><li><a href=#1-%e7%9b%ae%e5%bd%95%e7%bb%93%e6%9e%84 aria-label="1. 目录结构">1. 目录结构</a></li><li><a href=#2-apppy aria-label="2. app.py">2. app.py</a></li><li><a href=#3-requirementstxt aria-label="3. requirements.txt">3. requirements.txt</a></li><li><a href=#4-dockerfile aria-label="4. Dockerfile">4. Dockerfile</a></li><li><a href=#5-%e6%9e%84%e5%bb%ba--%e8%bf%90%e8%a1%8c aria-label="5. 构建 & 运行">5. 构建 & 运行</a></li><li><a href=#6-%e8%b0%83%e7%94%a8%e7%a4%ba%e4%be%8b aria-label="6. 调用示例">6. 调用示例</a></li></ul></li><li><a href=#debian-nodocker-webapi aria-label="debian nodocker webapi">debian nodocker webapi</a><ul><li><a href=#1-%e7%b3%bb%e7%bb%9f%e4%be%9d%e8%b5%96%e4%b8%80%e6%ac%a1%e6%80%a7 aria-label="1. 系统依赖（一次性）">1. 系统依赖（一次性）</a></li><li><a href=#2-%e4%b8%8b%e8%bd%bd%e5%b9%b6%e6%94%be%e7%bd%ae%e4%b8%ad%e6%96%87%e5%b0%8f%e6%a8%a1%e5%9e%8b aria-label="2. 下载并放置中文小模型">2. 下载并放置中文小模型</a></li><li><a href=#3-%e5%ae%89%e8%a3%85-python-%e4%be%9d%e8%b5%96 aria-label="3. 安装 Python 依赖">3. 安装 Python 依赖</a></li><li><a href=#4-%e5%ae%8c%e6%95%b4%e4%bb%a3%e7%a0%81-apppy aria-label="4. 完整代码 app.py">4. 完整代码 app.py</a></li><li><a href=#5-%e5%90%af%e5%8a%a8%e6%9c%8d%e5%8a%a1 aria-label="5. 启动服务">5. 启动服务</a></li><li><a href=#6-%e8%b0%83%e7%94%a8%e7%a4%ba%e4%be%8b-1 aria-label="6. 调用示例">6. 调用示例</a></li><li><a href=#7-%e5%bc%80%e6%9c%ba%e8%87%aa%e5%90%af%e5%8f%af%e9%80%89 aria-label="7. 开机自启（可选）">7. 开机自启（可选）</a></li></ul></li><li><a href=#pep668 aria-label=PEP668>PEP668</a></li><li><a href=#whisper%e7%89%88%e6%9c%ac aria-label=Whisper版本>Whisper版本</a><ul><li><a href=#1-%e7%9b%ae%e5%bd%95%e7%bb%93%e6%9e%84-1 aria-label="1. 目录结构">1. 目录结构</a></li><li><a href=#2-requirementstxt aria-label="2. requirements.txt">2. requirements.txt</a></li><li><a href=#3-apppy%e5%ae%8c%e5%85%a8%e6%9b%bf%e6%8d%a2%e6%97%a7%e7%89%88%e6%9c%ac aria-label="3. app.py（完全替换旧版本）">3. app.py（完全替换旧版本）</a></li><li><a href=#4-dockerfile-1 aria-label="4. Dockerfile">4. Dockerfile</a></li><li><a href=#5-%e6%9e%84%e5%bb%ba--%e8%bf%90%e8%a1%8c-1 aria-label="5. 构建 & 运行">5. 构建 & 运行</a></li><li><a href=#6-%e8%b0%83%e7%94%a8%e7%a4%ba%e4%be%8b%e4%b8%8e%e4%b9%8b%e5%89%8d%e5%ae%8c%e5%85%a8%e4%b8%80%e8%87%b4 aria-label="6. 调用示例（与之前完全一致）">6. 调用示例（与之前完全一致）</a></li><li><a href=#7-%e6%a8%a1%e5%9e%8b%e5%a4%a7%e5%b0%8f%e8%af%b4%e6%98%8e aria-label="7. 模型大小说明">7. 模型大小说明</a></li></ul></li><li><a href=#vosk-qwen aria-label=vosk-qwen>vosk-qwen</a><ul><li><a href=#1-%e7%b3%bb%e7%bb%9f%e4%be%9d%e8%b5%96%e4%b8%80%e6%ac%a1%e6%80%a7-1 aria-label="1. 系统依赖（一次性）">1. 系统依赖（一次性）</a></li><li><a href=#2-%e8%99%9a%e6%8b%9f%e7%8e%af%e5%a2%83--%e4%be%9d%e8%b5%96 aria-label="2. 虚拟环境 & 依赖">2. 虚拟环境 & 依赖</a></li><li><a href=#3-%e4%b8%8b%e8%bd%bd%e6%a8%a1%e5%9e%8b-15-gb aria-label="3. 下载模型（≈ 1.5 GB）">3. 下载模型（≈ 1.5 GB）</a></li><li><a href=#4-%e5%8d%95%e6%96%87%e4%bb%b6-apppy aria-label="4. 单文件 app.py">4. 单文件 app.py</a></li><li><a href=#%e5%90%af%e5%8a%a8 aria-label=启动>启动</a></li><li><a href=#%e8%b0%83%e7%94%a8%e7%a4%ba%e4%be%8b aria-label=调用示例>调用示例</a></li><li><a href=#multipart-err aria-label="multipart err">multipart err</a></li></ul></li></ul></div></details></div><div class=post-content><h1 id=vosk-stt>Vosk STT<a hidden class=anchor aria-hidden=true href=#vosk-stt>#</a></h1><h2 id=一准备环境debian>一、准备环境（Debian）<a hidden class=anchor aria-hidden=true href=#一准备环境debian>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt update
</span></span><span style=display:flex><span>sudo apt install -y python3 python3-pip ffmpeg
</span></span><span style=display:flex><span>pip3 install --user vosk
</span></span></code></pre></div><h2 id=二下载微型中文模型-40-mb>二、下载微型中文模型（≈ 40 MB）<a hidden class=anchor aria-hidden=true href=#二下载微型中文模型-40-mb>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>wget https://alphacephei.com/vosk/models/vosk-model-small-cn-0.22.zip
</span></span><span style=display:flex><span>unzip vosk-model-small-cn-0.22.zip
</span></span></code></pre></div><h2 id=三保存以下脚本为-listenpy>三、保存以下脚本为 listen.py<a hidden class=anchor aria-hidden=true href=#三保存以下脚本为-listenpy>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Python data-lang=Python><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/env python3</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> sys<span style=color:#f92672>,</span> json<span style=color:#f92672>,</span> os
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> vosk <span style=color:#f92672>import</span> Model, KaldiRecognizer
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> wave
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>MAP <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;空调&#34;</span>: <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;电视&#34;</span>: <span style=color:#ae81ff>2</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;风扇&#34;</span>: <span style=color:#ae81ff>3</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;卧室灯&#34;</span>: <span style=color:#ae81ff>4</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;客厅灯&#34;</span>: <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>wav2text</span>(path):
</span></span><span style=display:flex><span>    wf <span style=color:#f92672>=</span> wave<span style=color:#f92672>.</span>open(path, <span style=color:#e6db74>&#34;rb&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> wf<span style=color:#f92672>.</span>getnchannels() <span style=color:#f92672>!=</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>or</span> wf<span style=color:#f92672>.</span>getsampwidth() <span style=color:#f92672>!=</span> <span style=color:#ae81ff>2</span> <span style=color:#f92672>or</span> wf<span style=color:#f92672>.</span>getframerate() <span style=color:#f92672>!=</span> <span style=color:#ae81ff>16000</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>ValueError</span>(<span style=color:#e6db74>&#34;音频必须是 16 kHz 16-bit 单声道 WAV&#34;</span>)
</span></span><span style=display:flex><span>    model <span style=color:#f92672>=</span> Model(<span style=color:#e6db74>&#34;vosk-model-small-cn-0.22&#34;</span>)
</span></span><span style=display:flex><span>    rec <span style=color:#f92672>=</span> KaldiRecognizer(model, wf<span style=color:#f92672>.</span>getframerate())
</span></span><span style=display:flex><span>    rec<span style=color:#f92672>.</span>SetWords(<span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>    text <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>        data <span style=color:#f92672>=</span> wf<span style=color:#f92672>.</span>readframes(<span style=color:#ae81ff>4000</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> len(data) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> rec<span style=color:#f92672>.</span>AcceptWaveform(data):
</span></span><span style=display:flex><span>            text <span style=color:#f92672>+=</span> json<span style=color:#f92672>.</span>loads(rec<span style=color:#f92672>.</span>Result())[<span style=color:#e6db74>&#34;text&#34;</span>]
</span></span><span style=display:flex><span>    text <span style=color:#f92672>+=</span> json<span style=color:#f92672>.</span>loads(rec<span style=color:#f92672>.</span>FinalResult())[<span style=color:#e6db74>&#34;text&#34;</span>]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> text<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#34; &#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>find_index</span>(text):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> key, idx <span style=color:#f92672>in</span> MAP<span style=color:#f92672>.</span>items():
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> key <span style=color:#f92672>in</span> text:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> idx
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(sys<span style=color:#f92672>.</span>argv) <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>2</span>:
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#34;用法: python3 listen.py &lt;wav路径&gt;&#34;</span>)
</span></span><span style=display:flex><span>        sys<span style=color:#f92672>.</span>exit(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    t <span style=color:#f92672>=</span> wav2text(sys<span style=color:#f92672>.</span>argv[<span style=color:#ae81ff>1</span>])
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;识别文本:&#34;</span>, t)
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;对应序号:&#34;</span>, find_index(t))
</span></span></code></pre></div><h2 id=四运行示例>四、运行示例<a hidden class=anchor aria-hidden=true href=#四运行示例>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>python3 listen.py wsd.wav
</span></span></code></pre></div><p>如果音频内容是「我是登」，识别结果里包含「卧室灯」，脚本会输出</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>识别文本: 我是登卧室灯
</span></span><span style=display:flex><span>对应序号: <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>若未命中任何关键词则输出 对应序号: 0。
</span></span></code></pre></div><h1 id=打包docker运行>打包docker运行<a hidden class=anchor aria-hidden=true href=#打包docker运行>#</a></h1><h2 id=listenpy>listen.py<a hidden class=anchor aria-hidden=true href=#listenpy>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/env python3</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> sys<span style=color:#f92672>,</span> json<span style=color:#f92672>,</span> os
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> vosk <span style=color:#f92672>import</span> Model, KaldiRecognizer
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> wave
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>MAP <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;空调&#34;</span>: <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;电视&#34;</span>: <span style=color:#ae81ff>2</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;风扇&#34;</span>: <span style=color:#ae81ff>3</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;卧室灯&#34;</span>: <span style=color:#ae81ff>4</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;客厅灯&#34;</span>: <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>wav2text</span>(path):
</span></span><span style=display:flex><span>    wf <span style=color:#f92672>=</span> wave<span style=color:#f92672>.</span>open(path, <span style=color:#e6db74>&#34;rb&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> wf<span style=color:#f92672>.</span>getnchannels() <span style=color:#f92672>!=</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>or</span> wf<span style=color:#f92672>.</span>getsampwidth() <span style=color:#f92672>!=</span> <span style=color:#ae81ff>2</span> <span style=color:#f92672>or</span> wf<span style=color:#f92672>.</span>getframerate() <span style=color:#f92672>!=</span> <span style=color:#ae81ff>16000</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>ValueError</span>(<span style=color:#e6db74>&#34;音频必须是 16 kHz 16-bit 单声道 WAV&#34;</span>)
</span></span><span style=display:flex><span>    model <span style=color:#f92672>=</span> Model(<span style=color:#e6db74>&#34;/opt&#34;</span>)
</span></span><span style=display:flex><span>    rec <span style=color:#f92672>=</span> KaldiRecognizer(model, wf<span style=color:#f92672>.</span>getframerate())
</span></span><span style=display:flex><span>    rec<span style=color:#f92672>.</span>SetWords(<span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>    text <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>        data <span style=color:#f92672>=</span> wf<span style=color:#f92672>.</span>readframes(<span style=color:#ae81ff>4000</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> len(data) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> rec<span style=color:#f92672>.</span>AcceptWaveform(data):
</span></span><span style=display:flex><span>            text <span style=color:#f92672>+=</span> json<span style=color:#f92672>.</span>loads(rec<span style=color:#f92672>.</span>Result())[<span style=color:#e6db74>&#34;text&#34;</span>]
</span></span><span style=display:flex><span>    text <span style=color:#f92672>+=</span> json<span style=color:#f92672>.</span>loads(rec<span style=color:#f92672>.</span>FinalResult())[<span style=color:#e6db74>&#34;text&#34;</span>]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> text<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#34; &#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>find_index</span>(text):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> key, idx <span style=color:#f92672>in</span> MAP<span style=color:#f92672>.</span>items():
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> key <span style=color:#f92672>in</span> text:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> idx
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(sys<span style=color:#f92672>.</span>argv) <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>2</span>:
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#34;用法: python3 listen.py &lt;wav路径&gt;&#34;</span>)
</span></span><span style=display:flex><span>        sys<span style=color:#f92672>.</span>exit(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    t <span style=color:#f92672>=</span> wav2text(sys<span style=color:#f92672>.</span>argv[<span style=color:#ae81ff>1</span>])
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;识别文本:&#34;</span>, t)
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;对应序号:&#34;</span>, find_index(t))
</span></span></code></pre></div><h2 id=dockerfile>dockerfile<a hidden class=anchor aria-hidden=true href=#dockerfile>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># ---- 1. 基础镜像 ----</span>
</span></span><span style=display:flex><span>FROM python:3.11-slim-bookworm
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ---- 2. 系统依赖 &amp; ffmpeg ----</span>
</span></span><span style=display:flex><span>RUN apt-get update <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    apt-get install -y --no-install-recommends <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        ffmpeg <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        wget <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        unzip <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    rm -rf /var/lib/apt/lists/*
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ---- 3. 安装 Vosk ----</span>
</span></span><span style=display:flex><span>RUN pip install --no-cache-dir vosk<span style=color:#f92672>==</span>0.3.45
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ---- 4. 下载并解压中文小模型 ----</span>
</span></span><span style=display:flex><span>WORKDIR /opt
</span></span><span style=display:flex><span>RUN wget -q https://alphacephei.com/vosk/models/vosk-model-small-cn-0.22.zip <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    unzip -q vosk-model-small-cn-0.22.zip <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    mv vosk-model-small-cn-0.22/* ./ <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    rmdir vosk-model-small-cn-0.22 <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    rm vosk-model-small-cn-0.22.zip
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ---- 5. 复制脚本 ----</span>
</span></span><span style=display:flex><span>COPY listen.py /opt/listen.py
</span></span><span style=display:flex><span>RUN chmod +x /opt/listen.py
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ---- 6. 入口脚本：自动转码 + 识别 ----</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 创建一个小脚本作为 ENTRYPOINT</span>
</span></span><span style=display:flex><span>RUN printf <span style=color:#e6db74>&#39;#!/bin/bash\n\
</span></span></span><span style=display:flex><span><span style=color:#e6db74>set -e\n\
</span></span></span><span style=display:flex><span><span style=color:#e6db74>IN=&#34;$1&#34;\n\
</span></span></span><span style=display:flex><span><span style=color:#e6db74>BASE=$(basename &#34;$IN&#34; .wav)\n\
</span></span></span><span style=display:flex><span><span style=color:#e6db74>OUT=&#34;${BASE}_16k.wav&#34;\n\
</span></span></span><span style=display:flex><span><span style=color:#e6db74>echo &#34;Converting $IN -&gt; $OUT ...&#34;\n\
</span></span></span><span style=display:flex><span><span style=color:#e6db74>ffmpeg -y -i &#34;$IN&#34; -ar 16000 -ac 1 -sample_fmt s16 &#34;$OUT&#34; &gt;/dev/null 2&gt;&amp;1\n\
</span></span></span><span style=display:flex><span><span style=color:#e6db74>echo &#34;Running Vosk on $OUT ...&#34;\n\
</span></span></span><span style=display:flex><span><span style=color:#e6db74>exec python3 /opt/listen.py &#34;$OUT&#34;\n&#39;</span> &gt; /opt/entry.sh <span style=color:#f92672>&amp;&amp;</span> chmod +x /opt/entry.sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>WORKDIR /workspace
</span></span><span style=display:flex><span>ENTRYPOINT <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;/opt/entry.sh&#34;</span><span style=color:#f92672>]</span>
</span></span></code></pre></div><h2 id=构建使用>构建使用<a hidden class=anchor aria-hidden=true href=#构建使用>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>
</span></span><span style=display:flex><span>docker build -t stt-cn-mini .
</span></span><span style=display:flex><span>docker run --rm -v <span style=color:#66d9ef>$(</span>pwd<span style=color:#66d9ef>)</span>:/workspace stt-cn-mini wsd.wav
</span></span></code></pre></div><h1 id=使用pypinyin进行纠错>使用pypinyin进行纠错<a hidden class=anchor aria-hidden=true href=#使用pypinyin进行纠错>#</a></h1><p>下面给出「整句拼音容错」的完整实现：
用 pypinyin 把整句话转拼音（带声调），
再与标准关键词的拼音做模糊匹配，
支持「登」→「灯」，「客厅」→「客厅灯」等任意同音/近音组合。
只改 listen.py，其余不变。</p><h2 id=1-安装依赖dockerfile-里加一行即可>1. 安装依赖（Dockerfile 里加一行即可）<a hidden class=anchor aria-hidden=true href=#1-安装依赖dockerfile-里加一行即可>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#66d9ef>RUN</span> pip install --no-cache-dir vosk<span style=color:#f92672>==</span>0.3.45 pypinyin fuzzywuzzy python-Levenshtein<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h2 id=2-新的-listenpy直接替换>2. 新的 listen.py（直接替换）<a hidden class=anchor aria-hidden=true href=#2-新的-listenpy直接替换>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Python data-lang=Python><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/env python3</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> sys<span style=color:#f92672>,</span> json<span style=color:#f92672>,</span> os<span style=color:#f92672>,</span> re
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> vosk <span style=color:#f92672>import</span> Model, KaldiRecognizer
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> wave
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> pypinyin <span style=color:#f92672>import</span> lazy_pinyin
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> fuzzywuzzy <span style=color:#f92672>import</span> fuzz
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 关键词→序号</span>
</span></span><span style=display:flex><span>KEYWORD2ID <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;空调&#34;</span>: <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;电视&#34;</span>: <span style=color:#ae81ff>2</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;风扇&#34;</span>: <span style=color:#ae81ff>3</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;卧室灯&#34;</span>: <span style=color:#ae81ff>4</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;客厅灯&#34;</span>: <span style=color:#ae81ff>5</span>,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 预先把关键词转成拼音列表，避免每次重复计算</span>
</span></span><span style=display:flex><span>KW_PINYIN <span style=color:#f92672>=</span> {kw: <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>.</span>join(lazy_pinyin(kw)) <span style=color:#66d9ef>for</span> kw <span style=color:#f92672>in</span> KEYWORD2ID}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>wav2text</span>(path):
</span></span><span style=display:flex><span>    wf <span style=color:#f92672>=</span> wave<span style=color:#f92672>.</span>open(path, <span style=color:#e6db74>&#34;rb&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> wf<span style=color:#f92672>.</span>getnchannels() <span style=color:#f92672>!=</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>or</span> wf<span style=color:#f92672>.</span>getsampwidth() <span style=color:#f92672>!=</span> <span style=color:#ae81ff>2</span> <span style=color:#f92672>or</span> wf<span style=color:#f92672>.</span>getframerate() <span style=color:#f92672>!=</span> <span style=color:#ae81ff>16000</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>ValueError</span>(<span style=color:#e6db74>&#34;音频必须是 16 kHz 16-bit 单声道 WAV&#34;</span>)
</span></span><span style=display:flex><span>    model <span style=color:#f92672>=</span> Model(<span style=color:#e6db74>&#34;/opt&#34;</span>)
</span></span><span style=display:flex><span>    rec <span style=color:#f92672>=</span> KaldiRecognizer(model, wf<span style=color:#f92672>.</span>getframerate())
</span></span><span style=display:flex><span>    rec<span style=color:#f92672>.</span>SetWords(<span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>    text <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>        data <span style=color:#f92672>=</span> wf<span style=color:#f92672>.</span>readframes(<span style=color:#ae81ff>4000</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> len(data) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> rec<span style=color:#f92672>.</span>AcceptWaveform(data):
</span></span><span style=display:flex><span>            text <span style=color:#f92672>+=</span> json<span style=color:#f92672>.</span>loads(rec<span style=color:#f92672>.</span>Result())[<span style=color:#e6db74>&#34;text&#34;</span>]
</span></span><span style=display:flex><span>    text <span style=color:#f92672>+=</span> json<span style=color:#f92672>.</span>loads(rec<span style=color:#f92672>.</span>FinalResult())[<span style=color:#e6db74>&#34;text&#34;</span>]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> text<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#34; &#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>fuzzy_match</span>(text: str) <span style=color:#f92672>-&gt;</span> int:
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;基于拼音的模糊匹配，返回最相似关键词的序号&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    text_py <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>.</span>join(lazy_pinyin(text))  <span style=color:#75715e># 整句话转拼音</span>
</span></span><span style=display:flex><span>    best_kw, best_score <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> kw, kw_py <span style=color:#f92672>in</span> KW_PINYIN<span style=color:#f92672>.</span>items():
</span></span><span style=display:flex><span>        score <span style=color:#f92672>=</span> fuzz<span style=color:#f92672>.</span>partial_ratio(text_py, kw_py)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> score <span style=color:#f92672>&gt;</span> best_score:
</span></span><span style=display:flex><span>            best_kw, best_score <span style=color:#f92672>=</span> kw, score
</span></span><span style=display:flex><span>    <span style=color:#75715e># 阈值可自己调，80 以上基本可接受</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> best_score <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>80</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> KEYWORD2ID[best_kw]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(sys<span style=color:#f92672>.</span>argv) <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>2</span>:
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#34;用法: python3 listen.py &lt;wav路径&gt;&#34;</span>)
</span></span><span style=display:flex><span>        sys<span style=color:#f92672>.</span>exit(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    t <span style=color:#f92672>=</span> wav2text(sys<span style=color:#f92672>.</span>argv[<span style=color:#ae81ff>1</span>])
</span></span><span style=display:flex><span>    idx <span style=color:#f92672>=</span> fuzzy_match(t)
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;识别文本:&#34;</span>, t)
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;对应序号:&#34;</span>, idx)
</span></span></code></pre></div><h2 id=3-构建--运行>3. 构建 & 运行<a hidden class=anchor aria-hidden=true href=#3-构建--运行>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker build -t stt-cn-mini .
</span></span><span style=display:flex><span>docker run --rm -v <span style=color:#66d9ef>$(</span>pwd<span style=color:#66d9ef>)</span>:/workspace stt-cn-mini wsd.wav
</span></span></code></pre></div><p>示例结果</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>识别文本: 我是登
</span></span><span style=display:flex><span>对应序号: <span style=color:#ae81ff>4</span>          <span style=color:#75715e># 因为 &#34;woshideng&#34; 与 &#34;woshideng&#34; 完全匹配 &#34;卧室灯&#34;</span>
</span></span></code></pre></div><h2 id=4-效果说明>4. 效果说明<a hidden class=anchor aria-hidden=true href=#4-效果说明>#</a></h2><p>pypinyin.lazy_pinyin() → 把整句话转拼音（带数字声调）。
fuzz.partial_ratio() → 计算句子拼音与关键词拼音的相似度。</p><p>阈值 80 以上即可覆盖常见同音/近音错误，调低或调高视实际效果。</p><h2 id=结果>结果<a hidden class=anchor aria-hidden=true href=#结果>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run --rm -v <span style=color:#66d9ef>$(</span>pwd<span style=color:#66d9ef>)</span>:/workspace stt-cn-mini test_wsd.wav
</span></span><span style=display:flex><span>Converting test_wsd.wav -&gt; test_wsd_16k.wav ...
</span></span><span style=display:flex><span>Running Vosk on test_wsd_16k.wav ...
</span></span><span style=display:flex><span>识别文本: 小爱同学帮我打开我是灯
</span></span><span style=display:flex><span>对应序号: <span style=color:#ae81ff>4</span>
</span></span></code></pre></div><h1 id=web-api>web API<a hidden class=anchor aria-hidden=true href=#web-api>#</a></h1><p>轻量级 FastAPI 服务
容器化部署（Debian 基础镜像 + Vosk + 中文拼音容错）。
通过 HTTP POST /recognize 提交 JSON：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-JSON data-lang=JSON><span style=display:flex><span>{<span style=color:#f92672>&#34;url&#34;</span>: <span style=color:#e6db74>&#34;http://&lt;host&gt;/&lt;file&gt;.wav&#34;</span>}
</span></span></code></pre></div><p>返回同音容错后的结果：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-JSON data-lang=JSON><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;text&#34;</span>: <span style=color:#e6db74>&#34;我是登&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;matched&#34;</span>: <span style=color:#e6db74>&#34;卧室灯&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=1-目录结构>1. 目录结构<a hidden class=anchor aria-hidden=true href=#1-目录结构>#</a></h2><p>stt-api/
├── Dockerfile
├── requirements.txt
└── app.py</p><h2 id=2-apppy>2. app.py<a hidden class=anchor aria-hidden=true href=#2-apppy>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Python data-lang=Python><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> fastapi <span style=color:#f92672>import</span> FastAPI, HTTPException
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> pydantic <span style=color:#f92672>import</span> BaseModel, HttpUrl
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> tempfile<span style=color:#f92672>,</span> os<span style=color:#f92672>,</span> requests<span style=color:#f92672>,</span> wave<span style=color:#f92672>,</span> json
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> vosk <span style=color:#f92672>import</span> Model, KaldiRecognizer
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> pypinyin <span style=color:#f92672>import</span> lazy_pinyin
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> fuzzywuzzy <span style=color:#f92672>import</span> fuzz
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app <span style=color:#f92672>=</span> FastAPI(title<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;STT-CN-API&#34;</span>, version<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;1.0&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 关键词配置</span>
</span></span><span style=display:flex><span>KEYWORD2ID <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;空调&#34;</span>: <span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#34;电视&#34;</span>: <span style=color:#ae81ff>2</span>, <span style=color:#e6db74>&#34;风扇&#34;</span>: <span style=color:#ae81ff>3</span>, <span style=color:#e6db74>&#34;卧室灯&#34;</span>: <span style=color:#ae81ff>4</span>, <span style=color:#e6db74>&#34;客厅灯&#34;</span>: <span style=color:#ae81ff>5</span>}
</span></span><span style=display:flex><span>KW_PINYIN <span style=color:#f92672>=</span> {kw: <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>.</span>join(lazy_pinyin(kw)) <span style=color:#66d9ef>for</span> kw <span style=color:#f92672>in</span> KEYWORD2ID}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 全局加载一次模型</span>
</span></span><span style=display:flex><span>MODEL <span style=color:#f92672>=</span> Model(<span style=color:#e6db74>&#34;/opt/models&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>wav2text</span>(path: str) <span style=color:#f92672>-&gt;</span> str:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> wave<span style=color:#f92672>.</span>open(path, <span style=color:#e6db74>&#34;rb&#34;</span>) <span style=color:#66d9ef>as</span> wf:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> wf<span style=color:#f92672>.</span>getnchannels() <span style=color:#f92672>!=</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>or</span> wf<span style=color:#f92672>.</span>getsampwidth() <span style=color:#f92672>!=</span> <span style=color:#ae81ff>2</span> <span style=color:#f92672>or</span> wf<span style=color:#f92672>.</span>getframerate() <span style=color:#f92672>!=</span> <span style=color:#ae81ff>16000</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>ValueError</span>(<span style=color:#e6db74>&#34;音频必须是 16 kHz 16-bit 单声道 WAV&#34;</span>)
</span></span><span style=display:flex><span>        rec <span style=color:#f92672>=</span> KaldiRecognizer(MODEL, wf<span style=color:#f92672>.</span>getframerate())
</span></span><span style=display:flex><span>        rec<span style=color:#f92672>.</span>SetWords(<span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>        result <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>            data <span style=color:#f92672>=</span> wf<span style=color:#f92672>.</span>readframes(<span style=color:#ae81ff>4000</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> len(data) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> rec<span style=color:#f92672>.</span>AcceptWaveform(data):
</span></span><span style=display:flex><span>                result<span style=color:#f92672>.</span>append(json<span style=color:#f92672>.</span>loads(rec<span style=color:#f92672>.</span>Result())[<span style=color:#e6db74>&#34;text&#34;</span>])
</span></span><span style=display:flex><span>        result<span style=color:#f92672>.</span>append(json<span style=color:#f92672>.</span>loads(rec<span style=color:#f92672>.</span>FinalResult())[<span style=color:#e6db74>&#34;text&#34;</span>])
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>.</span>join(result)<span style=color:#f92672>.</span>strip()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>fuzzy_match</span>(text: str):
</span></span><span style=display:flex><span>    text_py <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>.</span>join(lazy_pinyin(text))
</span></span><span style=display:flex><span>    best_kw, best_score <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> kw, kw_py <span style=color:#f92672>in</span> KW_PINYIN<span style=color:#f92672>.</span>items():
</span></span><span style=display:flex><span>        score <span style=color:#f92672>=</span> fuzz<span style=color:#f92672>.</span>partial_ratio(text_py, kw_py)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> score <span style=color:#f92672>&gt;</span> best_score:
</span></span><span style=display:flex><span>            best_kw, best_score <span style=color:#f92672>=</span> kw, score
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> best_kw <span style=color:#66d9ef>if</span> best_score <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>70</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RecognizeRequest</span>(BaseModel):
</span></span><span style=display:flex><span>    url: HttpUrl
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@app.post</span>(<span style=color:#e6db74>&#34;/recognize&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>recognize</span>(req: RecognizeRequest):
</span></span><span style=display:flex><span>    wav_url <span style=color:#f92672>=</span> str(req<span style=color:#f92672>.</span>url)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        <span style=color:#75715e># 下载到临时文件</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>with</span> tempfile<span style=color:#f92672>.</span>NamedTemporaryFile(suffix<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;.wav&#34;</span>, delete<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>) <span style=color:#66d9ef>as</span> tmp:
</span></span><span style=display:flex><span>            tmp<span style=color:#f92672>.</span>write(requests<span style=color:#f92672>.</span>get(wav_url, timeout<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>)<span style=color:#f92672>.</span>content)
</span></span><span style=display:flex><span>            tmp_path <span style=color:#f92672>=</span> tmp<span style=color:#f92672>.</span>name
</span></span><span style=display:flex><span>        <span style=color:#75715e># 转码（Vosk 只认 16k/16bit/单声道）</span>
</span></span><span style=display:flex><span>        out_path <span style=color:#f92672>=</span> tmp_path <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;_16k.wav&#34;</span>
</span></span><span style=display:flex><span>        os<span style=color:#f92672>.</span>system(
</span></span><span style=display:flex><span>            <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;ffmpeg -y -i </span><span style=color:#e6db74>{</span>tmp_path<span style=color:#e6db74>}</span><span style=color:#e6db74> -ar 16000 -ac 1 -sample_fmt s16 </span><span style=color:#e6db74>{</span>out_path<span style=color:#e6db74>}</span><span style=color:#e6db74> &gt;/dev/null 2&gt;&amp;1&#34;</span>
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>        <span style=color:#75715e># 识别</span>
</span></span><span style=display:flex><span>        text <span style=color:#f92672>=</span> wav2text(out_path)
</span></span><span style=display:flex><span>        matched <span style=color:#f92672>=</span> fuzzy_match(text)
</span></span><span style=display:flex><span>        resp <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;text&#34;</span>: text, <span style=color:#e6db74>&#34;matched&#34;</span>: matched, <span style=color:#e6db74>&#34;id&#34;</span>: KEYWORD2ID<span style=color:#f92672>.</span>get(matched, <span style=color:#ae81ff>0</span>)}
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> HTTPException(status_code<span style=color:#f92672>=</span><span style=color:#ae81ff>500</span>, detail<span style=color:#f92672>=</span>str(e))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>finally</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> p <span style=color:#f92672>in</span> (tmp_path, out_path):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>exists(p):
</span></span><span style=display:flex><span>                os<span style=color:#f92672>.</span>remove(p)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> resp
</span></span></code></pre></div><h2 id=3-requirementstxt>3. requirements.txt<a hidden class=anchor aria-hidden=true href=#3-requirementstxt>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>fastapi<span style=color:#f92672>==</span>0.110.2
</span></span><span style=display:flex><span>uvicorn<span style=color:#f92672>[</span>standard<span style=color:#f92672>]==</span>0.29.0
</span></span><span style=display:flex><span>vosk<span style=color:#f92672>==</span>0.3.45
</span></span><span style=display:flex><span>pypinyin<span style=color:#f92672>==</span>0.51.0
</span></span><span style=display:flex><span>fuzzywuzzy<span style=color:#f92672>==</span>0.18.0
</span></span><span style=display:flex><span>python-Levenshtein<span style=color:#f92672>==</span>0.25.1
</span></span><span style=display:flex><span>requests<span style=color:#f92672>==</span>2.32.3
</span></span></code></pre></div><h2 id=4-dockerfile>4. Dockerfile<a hidden class=anchor aria-hidden=true href=#4-dockerfile>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> python:3.11-slim-bookworm</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apt-get update <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    apt-get install -y --no-install-recommends <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        ffmpeg wget unzip <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    rm -rf /var/lib/apt/lists/*<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /opt</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 下载并解压模型到 /opt/models</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> wget -q https://alphacephei.com/vosk/models/vosk-model-small-cn-0.22.zip <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    unzip -q vosk-model-small-cn-0.22.zip <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    mv vosk-model-small-cn-0.22 models <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    rm vosk-model-small-cn-0.22.zip<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> requirements.txt .<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> pip install --no-cache-dir -r requirements.txt<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> app.py .<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>EXPOSE</span><span style=color:#e6db74> 8000</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> [<span style=color:#e6db74>&#34;uvicorn&#34;</span>, <span style=color:#e6db74>&#34;app:app&#34;</span>, <span style=color:#e6db74>&#34;--host&#34;</span>, <span style=color:#e6db74>&#34;0.0.0.0&#34;</span>, <span style=color:#e6db74>&#34;--port&#34;</span>, <span style=color:#e6db74>&#34;8000&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h2 id=5-构建--运行>5. 构建 & 运行<a hidden class=anchor aria-hidden=true href=#5-构建--运行>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker build -t stt-api .
</span></span><span style=display:flex><span>docker run -d --name stt -p 8000:8000 stt-api
</span></span></code></pre></div><h2 id=6-调用示例>6. 调用示例<a hidden class=anchor aria-hidden=true href=#6-调用示例>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>
</span></span><span style=display:flex><span>curl -X POST http://localhost:8000/recognize <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>     -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>     -d <span style=color:#e6db74>&#39;{&#34;url&#34;:&#34;http://192.168.80.47:16552/wsd.wav&#34;}&#39;</span>
</span></span></code></pre></div><p>返回：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-JSON data-lang=JSON><span style=display:flex><span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;text&#34;</span>: <span style=color:#e6db74>&#34;我是登&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;matched&#34;</span>: <span style=color:#e6db74>&#34;卧室灯&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>可使用 tts 进行生成语音测试
ttsfm
<a href=https://github.com/dbccccccc/ttsfm>https://github.com/dbccccccc/ttsfm</a>
ChatTTS-ui
<a href=https://github.com/tianhm/ChatTTS-ui>https://github.com/tianhm/ChatTTS-ui</a></p><h1 id=debian-nodocker-webapi>debian nodocker webapi<a hidden class=anchor aria-hidden=true href=#debian-nodocker-webapi>#</a></h1><p>直接裸机部署、无需 Docker” 的 Vosk + 中文拼音容错 WebAPI 完整代码。
已在 Ubuntu / Debian ≥20.04 + Python 3.8+ 验证通过，仅需 5 步即可上线。</p><h2 id=1-系统依赖一次性>1. 系统依赖（一次性）<a hidden class=anchor aria-hidden=true href=#1-系统依赖一次性>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt update
</span></span><span style=display:flex><span>sudo apt install -y python3 python3-pip ffmpeg wget unzip
</span></span></code></pre></div><h2 id=2-下载并放置中文小模型>2. 下载并放置中文小模型<a hidden class=anchor aria-hidden=true href=#2-下载并放置中文小模型>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 在任意目录，例如 /opt/vosk-model</span>
</span></span><span style=display:flex><span>sudo mkdir -p /opt/vosk-model
</span></span><span style=display:flex><span>cd /opt/vosk-model
</span></span><span style=display:flex><span>sudo wget https://alphacephei.com/vosk/models/vosk-model-small-cn-0.22.zip
</span></span><span style=display:flex><span>sudo unzip vosk-model-small-cn-0.22.zip
</span></span><span style=display:flex><span>sudo mv vosk-model-small-cn-0.22/* ./ <span style=color:#f92672>&amp;&amp;</span> sudo rmdir vosk-model-small-cn-0.22
</span></span></code></pre></div><h2 id=3-安装-python-依赖>3. 安装 Python 依赖<a hidden class=anchor aria-hidden=true href=#3-安装-python-依赖>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pip3 install --user <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  fastapi uvicorn vosk pypinyin fuzzywuzzy python-Levenshtein requests
</span></span></code></pre></div><h2 id=4-完整代码-apppy>4. 完整代码 app.py<a hidden class=anchor aria-hidden=true href=#4-完整代码-apppy>#</a></h2><p>保存为 ~/stt_api/app.py（路径随意）。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Python data-lang=Python><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/env python3</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> os<span style=color:#f92672>,</span> tempfile<span style=color:#f92672>,</span> wave<span style=color:#f92672>,</span> json<span style=color:#f92672>,</span> requests
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> fastapi <span style=color:#f92672>import</span> FastAPI, HTTPException
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> pydantic <span style=color:#f92672>import</span> BaseModel, HttpUrl
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> vosk <span style=color:#f92672>import</span> Model, KaldiRecognizer
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> pypinyin <span style=color:#f92672>import</span> lazy_pinyin
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> fuzzywuzzy <span style=color:#f92672>import</span> fuzz
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ------------- 全局配置 -------------</span>
</span></span><span style=display:flex><span>KEYWORD2ID <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;空调&#34;</span>: <span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#34;电视&#34;</span>: <span style=color:#ae81ff>2</span>, <span style=color:#e6db74>&#34;风扇&#34;</span>: <span style=color:#ae81ff>3</span>, <span style=color:#e6db74>&#34;卧室灯&#34;</span>: <span style=color:#ae81ff>4</span>, <span style=color:#e6db74>&#34;客厅灯&#34;</span>: <span style=color:#ae81ff>5</span>}
</span></span><span style=display:flex><span>KW_PINYIN <span style=color:#f92672>=</span> {kw: <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>.</span>join(lazy_pinyin(kw)) <span style=color:#66d9ef>for</span> kw <span style=color:#f92672>in</span> KEYWORD2ID}
</span></span><span style=display:flex><span>MODEL_DIR <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/opt/vosk-model&#34;</span>                     <span style=color:#75715e># 与步骤2一致</span>
</span></span><span style=display:flex><span>MODEL <span style=color:#f92672>=</span> Model(MODEL_DIR)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app <span style=color:#f92672>=</span> FastAPI(title<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Vosk-CN-API&#34;</span>, version<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;1.0&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ------------- 工具函数 -------------</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>wav2text</span>(path: str) <span style=color:#f92672>-&gt;</span> str:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> wave<span style=color:#f92672>.</span>open(path, <span style=color:#e6db74>&#34;rb&#34;</span>) <span style=color:#66d9ef>as</span> wf:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> wf<span style=color:#f92672>.</span>getnchannels() <span style=color:#f92672>!=</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>or</span> wf<span style=color:#f92672>.</span>getsampwidth() <span style=color:#f92672>!=</span> <span style=color:#ae81ff>2</span> <span style=color:#f92672>or</span> wf<span style=color:#f92672>.</span>getframerate() <span style=color:#f92672>!=</span> <span style=color:#ae81ff>16000</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>ValueError</span>(<span style=color:#e6db74>&#34;音频需 16kHz/16-bit/单声道&#34;</span>)
</span></span><span style=display:flex><span>        rec <span style=color:#f92672>=</span> KaldiRecognizer(MODEL, wf<span style=color:#f92672>.</span>getframerate())
</span></span><span style=display:flex><span>        rec<span style=color:#f92672>.</span>SetWords(<span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>        result <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>            data <span style=color:#f92672>=</span> wf<span style=color:#f92672>.</span>readframes(<span style=color:#ae81ff>4000</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> len(data) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> rec<span style=color:#f92672>.</span>AcceptWaveform(data):
</span></span><span style=display:flex><span>                result<span style=color:#f92672>.</span>append(json<span style=color:#f92672>.</span>loads(rec<span style=color:#f92672>.</span>Result())[<span style=color:#e6db74>&#34;text&#34;</span>])
</span></span><span style=display:flex><span>        result<span style=color:#f92672>.</span>append(json<span style=color:#f92672>.</span>loads(rec<span style=color:#f92672>.</span>FinalResult())[<span style=color:#e6db74>&#34;text&#34;</span>])
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>.</span>join(result)<span style=color:#f92672>.</span>strip()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>fuzzy_match</span>(text: str):
</span></span><span style=display:flex><span>    txt_py <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>.</span>join(lazy_pinyin(text))
</span></span><span style=display:flex><span>    best_kw, best_score <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> kw, kw_py <span style=color:#f92672>in</span> KW_PINYIN<span style=color:#f92672>.</span>items():
</span></span><span style=display:flex><span>        score <span style=color:#f92672>=</span> fuzz<span style=color:#f92672>.</span>partial_ratio(txt_py, kw_py)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> score <span style=color:#f92672>&gt;</span> best_score:
</span></span><span style=display:flex><span>            best_kw, best_score <span style=color:#f92672>=</span> kw, score
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> best_kw <span style=color:#66d9ef>if</span> best_score <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>70</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ------------- 接口 -------------</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RecognizeRequest</span>(BaseModel):
</span></span><span style=display:flex><span>    url: HttpUrl
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@app.post</span>(<span style=color:#e6db74>&#34;/recognize&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>recognize</span>(req: RecognizeRequest):
</span></span><span style=display:flex><span>    wav_url <span style=color:#f92672>=</span> str(req<span style=color:#f92672>.</span>url)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>with</span> tempfile<span style=color:#f92672>.</span>NamedTemporaryFile(suffix<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;.wav&#34;</span>, delete<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>) <span style=color:#66d9ef>as</span> tmp:
</span></span><span style=display:flex><span>            tmp<span style=color:#f92672>.</span>write(requests<span style=color:#f92672>.</span>get(wav_url, timeout<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>)<span style=color:#f92672>.</span>content)
</span></span><span style=display:flex><span>            tmp_path <span style=color:#f92672>=</span> tmp<span style=color:#f92672>.</span>name
</span></span><span style=display:flex><span>        <span style=color:#75715e># 转码</span>
</span></span><span style=display:flex><span>        out_path <span style=color:#f92672>=</span> tmp_path <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;_16k.wav&#34;</span>
</span></span><span style=display:flex><span>        os<span style=color:#f92672>.</span>system(
</span></span><span style=display:flex><span>            <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;ffmpeg -y -i </span><span style=color:#e6db74>{</span>tmp_path<span style=color:#e6db74>}</span><span style=color:#e6db74> -ar 16000 -ac 1 -sample_fmt s16 </span><span style=color:#e6db74>{</span>out_path<span style=color:#e6db74>}</span><span style=color:#e6db74> &gt;/dev/null 2&gt;&amp;1&#34;</span>
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>        text <span style=color:#f92672>=</span> wav2text(out_path)
</span></span><span style=display:flex><span>        matched <span style=color:#f92672>=</span> fuzzy_match(text)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> {<span style=color:#e6db74>&#34;text&#34;</span>: text, <span style=color:#e6db74>&#34;matched&#34;</span>: matched, <span style=color:#e6db74>&#34;id&#34;</span>: KEYWORD2ID<span style=color:#f92672>.</span>get(matched, <span style=color:#ae81ff>0</span>)}
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> HTTPException(status_code<span style=color:#f92672>=</span><span style=color:#ae81ff>500</span>, detail<span style=color:#f92672>=</span>str(e))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>finally</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> p <span style=color:#f92672>in</span> (tmp_path, out_path):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>exists(p):
</span></span><span style=display:flex><span>                os<span style=color:#f92672>.</span>remove(p)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ------------- 本地调试 -------------</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>import</span> uvicorn
</span></span><span style=display:flex><span>    uvicorn<span style=color:#f92672>.</span>run(app, host<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;0.0.0.0&#34;</span>, port<span style=color:#f92672>=</span><span style=color:#ae81ff>8000</span>)
</span></span></code></pre></div><h2 id=5-启动服务>5. 启动服务<a hidden class=anchor aria-hidden=true href=#5-启动服务>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p ~/stt_api <span style=color:#f92672>&amp;&amp;</span> cd ~/stt_api
</span></span><span style=display:flex><span>nano app.py          <span style=color:#75715e># 粘贴上面代码</span>
</span></span><span style=display:flex><span>python3 app.py       <span style=color:#75715e># 前台运行，或后台用 nohup / systemd</span>
</span></span></code></pre></div><h2 id=6-调用示例-1>6. 调用示例<a hidden class=anchor aria-hidden=true href=#6-调用示例-1>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -X POST http://&lt;服务器IP&gt;:8000/recognize <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>     -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>     -d <span style=color:#e6db74>&#39;{&#34;url&#34;:&#34;http://192.168.80.47:16552/wsd.wav&#34;}&#39;</span>
</span></span></code></pre></div><p>返回：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-JSON data-lang=JSON><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;text&#34;</span>: <span style=color:#e6db74>&#34;我是登&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;matched&#34;</span>: <span style=color:#e6db74>&#34;卧室灯&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=7-开机自启可选>7. 开机自启（可选）<a hidden class=anchor aria-hidden=true href=#7-开机自启可选>#</a></h2><p>创建 systemd 文件 /etc/systemd/system/stt.service：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[Unit]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Description</span><span style=color:#f92672>=</span><span style=color:#e6db74>Vosk-CN-API</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>After</span><span style=color:#f92672>=</span><span style=color:#e6db74>network.target</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[Service]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Type</span><span style=color:#f92672>=</span><span style=color:#e6db74>exec</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStart</span><span style=color:#f92672>=</span><span style=color:#e6db74>/usr/bin/python3 /home/ubuntu/stt_api/app.py</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Restart</span><span style=color:#f92672>=</span><span style=color:#e6db74>always</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>User</span><span style=color:#f92672>=</span><span style=color:#e6db74>ubuntu</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>WorkingDirectory</span><span style=color:#f92672>=</span><span style=color:#e6db74>/home/ubuntu/stt_api</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[Install]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>WantedBy</span><span style=color:#f92672>=</span><span style=color:#e6db74>multi-user.target</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo systemctl daemon-reload
</span></span><span style=display:flex><span>sudo systemctl enable --now stt
</span></span></code></pre></div><p>至此，无需 Docker 的 Vosk WebAPI 已部署完成。</p><h1 id=pep668>PEP668<a hidden class=anchor aria-hidden=true href=#pep668>#</a></h1><p>Debian 12 / Ubuntu 23.04+ 启用了 PEP668，禁止用 pip3 &ndash;user 或 sudo pip 往系统 Python 里装包。
虚拟环境</p><p>安装系统包（只需一次）</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo apt update
</span></span><span style=display:flex><span>sudo apt install -y python3-venv python3-pip ffmpeg wget unzip
</span></span></code></pre></div><p>创建并激活虚拟环境</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>python3 -m venv ~/stt_venv
</span></span><span style=display:flex><span>source ~/stt_venv/bin/activate   <span style=color:#75715e># 以后每次运行前都先激活</span>
</span></span></code></pre></div><p>在虚拟环境里安装依赖</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>
</span></span><span style=display:flex><span>pip install --upgrade pip
</span></span><span style=display:flex><span>pip install fastapi uvicorn vosk pypinyin fuzzywuzzy python-Levenshtein requests
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>
</span></span><span style=display:flex><span>cd ~/stt_api
</span></span><span style=display:flex><span>~/stt_venv/bin/python app.py          <span style=color:#75715e># 或 uvicorn app:app --host 0.0.0.0 --port 8000</span>
</span></span></code></pre></div><p>测试</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -X POST http://localhost:8000/recognize <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>     -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>     -d <span style=color:#e6db74>&#39;{&#34;url&#34;:&#34;http://192.168.80.47:16552/wsd.wav&#34;}&#39;</span>
</span></span></code></pre></div><h1 id=whisper版本>Whisper版本<a hidden class=anchor aria-hidden=true href=#whisper版本>#</a></h1><p>Whisper 是 OpenAI 出的开源语音识别模型（支持多语言，含中文）</p><p>whisper.cpp 是 Whisper 的轻量 C/C++ 版本，专门针对 CPU 做了优化</p><p>有 Python binding，也可命令行直接跑</p><p>体积小，tiny/base 模型几十 MB</p><p><strong>优点</strong></p><p>开源，完全离线，专门针对 CPU 做了优化</p><p><strong>缺点</strong></p><p>对比 Vosk 稍微吃一点 CPU（但 tiny 模型负载很低）</p><p>不支持流式识别（一次识别一段音频）</p><p><strong>whisper-api</strong></p><p>使用 轻量版 Whisper（openai-whisper CPU 推理即可，无需 GPU）。
其余逻辑不变：接收 URL → 下载 → 转码 → 中文同音纠错 → 返回 JSON。</p><h2 id=1-目录结构-1>1. 目录结构<a hidden class=anchor aria-hidden=true href=#1-目录结构-1>#</a></h2><p>whisper-api/
├── Dockerfile
├── requirements.txt
└── app.py</p><h2 id=2-requirementstxt>2. requirements.txt<a hidden class=anchor aria-hidden=true href=#2-requirementstxt>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>fastapi<span style=color:#f92672>==</span>0.110.2
</span></span><span style=display:flex><span>uvicorn<span style=color:#f92672>[</span>standard<span style=color:#f92672>]==</span>0.29.0
</span></span><span style=display:flex><span>openai-whisper<span style=color:#f92672>==</span><span style=color:#ae81ff>20231117</span>
</span></span><span style=display:flex><span>pypinyin<span style=color:#f92672>==</span>0.51.0
</span></span><span style=display:flex><span>fuzzywuzzy<span style=color:#f92672>==</span>0.18.0
</span></span><span style=display:flex><span>python-Levenshtein<span style=color:#f92672>==</span>0.25.1
</span></span><span style=display:flex><span>requests<span style=color:#f92672>==</span>2.32.3
</span></span></code></pre></div><h2 id=3-apppy完全替换旧版本>3. app.py（完全替换旧版本）<a hidden class=anchor aria-hidden=true href=#3-apppy完全替换旧版本>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Python data-lang=Python><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> fastapi <span style=color:#f92672>import</span> FastAPI, HTTPException
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> pydantic <span style=color:#f92672>import</span> BaseModel, HttpUrl
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> tempfile<span style=color:#f92672>,</span> os<span style=color:#f92672>,</span> requests
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> whisper
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> pypinyin <span style=color:#f92672>import</span> lazy_pinyin
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> fuzzywuzzy <span style=color:#f92672>import</span> fuzz
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app <span style=color:#f92672>=</span> FastAPI(title<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Whisper-CN-API&#34;</span>, version<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;1.1&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 关键词配置</span>
</span></span><span style=display:flex><span>KEYWORD2ID <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;空调&#34;</span>: <span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#34;电视&#34;</span>: <span style=color:#ae81ff>2</span>, <span style=color:#e6db74>&#34;风扇&#34;</span>: <span style=color:#ae81ff>3</span>, <span style=color:#e6db74>&#34;卧室灯&#34;</span>: <span style=color:#ae81ff>4</span>, <span style=color:#e6db74>&#34;客厅灯&#34;</span>: <span style=color:#ae81ff>5</span>}
</span></span><span style=display:flex><span>KW_PINYIN <span style=color:#f92672>=</span> {kw: <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>.</span>join(lazy_pinyin(kw)) <span style=color:#66d9ef>for</span> kw <span style=color:#f92672>in</span> KEYWORD2ID}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 全局加载一次模型（base 体积小，中文够用）</span>
</span></span><span style=display:flex><span>MODEL <span style=color:#f92672>=</span> whisper<span style=color:#f92672>.</span>load_model(<span style=color:#e6db74>&#34;base&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RecognizeRequest</span>(BaseModel):
</span></span><span style=display:flex><span>    url: HttpUrl
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>fuzzy_match</span>(text: str):
</span></span><span style=display:flex><span>    text_py <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>.</span>join(lazy_pinyin(text))
</span></span><span style=display:flex><span>    best_kw, best_score <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> kw, kw_py <span style=color:#f92672>in</span> KW_PINYIN<span style=color:#f92672>.</span>items():
</span></span><span style=display:flex><span>        score <span style=color:#f92672>=</span> fuzz<span style=color:#f92672>.</span>partial_ratio(text_py, kw_py)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> score <span style=color:#f92672>&gt;</span> best_score:
</span></span><span style=display:flex><span>            best_kw, best_score <span style=color:#f92672>=</span> kw, score
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> best_kw <span style=color:#66d9ef>if</span> best_score <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>70</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@app.post</span>(<span style=color:#e6db74>&#34;/recognize&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>recognize</span>(req: RecognizeRequest):
</span></span><span style=display:flex><span>    wav_url <span style=color:#f92672>=</span> str(req<span style=color:#f92672>.</span>url)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        <span style=color:#75715e># 下载到临时文件</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>with</span> tempfile<span style=color:#f92672>.</span>NamedTemporaryFile(suffix<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;.wav&#34;</span>, delete<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>) <span style=color:#66d9ef>as</span> tmp:
</span></span><span style=display:flex><span>            tmp<span style=color:#f92672>.</span>write(requests<span style=color:#f92672>.</span>get(wav_url, timeout<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>)<span style=color:#f92672>.</span>content)
</span></span><span style=display:flex><span>            tmp_path <span style=color:#f92672>=</span> tmp<span style=color:#f92672>.</span>name
</span></span><span style=display:flex><span>        <span style=color:#75715e># 转码 16k/16bit/单声道（Whisper 会自动重采样，但统一格式更稳）</span>
</span></span><span style=display:flex><span>        out_path <span style=color:#f92672>=</span> tmp_path <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;_16k.wav&#34;</span>
</span></span><span style=display:flex><span>        os<span style=color:#f92672>.</span>system(
</span></span><span style=display:flex><span>            <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;ffmpeg -y -i </span><span style=color:#e6db74>{</span>tmp_path<span style=color:#e6db74>}</span><span style=color:#e6db74> -ar 16000 -ac 1 -sample_fmt s16 </span><span style=color:#e6db74>{</span>out_path<span style=color:#e6db74>}</span><span style=color:#e6db74> &gt;/dev/null 2&gt;&amp;1&#34;</span>
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>        <span style=color:#75715e># Whisper 识别</span>
</span></span><span style=display:flex><span>        result <span style=color:#f92672>=</span> MODEL<span style=color:#f92672>.</span>transcribe(out_path, language<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;zh&#34;</span>, fp16<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>)
</span></span><span style=display:flex><span>        text <span style=color:#f92672>=</span> result[<span style=color:#e6db74>&#34;text&#34;</span>]<span style=color:#f92672>.</span>strip()
</span></span><span style=display:flex><span>        matched <span style=color:#f92672>=</span> fuzzy_match(text)
</span></span><span style=display:flex><span>        resp <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;text&#34;</span>: text, <span style=color:#e6db74>&#34;matched&#34;</span>: matched, <span style=color:#e6db74>&#34;id&#34;</span>: KEYWORD2ID<span style=color:#f92672>.</span>get(matched, <span style=color:#ae81ff>0</span>)}
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> HTTPException(status_code<span style=color:#f92672>=</span><span style=color:#ae81ff>500</span>, detail<span style=color:#f92672>=</span>str(e))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>finally</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> p <span style=color:#f92672>in</span> (tmp_path, out_path):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>exists(p):
</span></span><span style=display:flex><span>                os<span style=color:#f92672>.</span>remove(p)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> resp
</span></span></code></pre></div><h2 id=4-dockerfile-1>4. Dockerfile<a hidden class=anchor aria-hidden=true href=#4-dockerfile-1>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> python:3.11-slim-bookworm</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apt-get update <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    apt-get install -y --no-install-recommends <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        ffmpeg wget <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    rm -rf /var/lib/apt/lists/*<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> requirements.txt .<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> pip install --no-cache-dir -r requirements.txt<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> app.py .<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>EXPOSE</span><span style=color:#e6db74> 8000</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> [<span style=color:#e6db74>&#34;uvicorn&#34;</span>, <span style=color:#e6db74>&#34;app:app&#34;</span>, <span style=color:#e6db74>&#34;--host&#34;</span>, <span style=color:#e6db74>&#34;0.0.0.0&#34;</span>, <span style=color:#e6db74>&#34;--port&#34;</span>, <span style=color:#e6db74>&#34;8000&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h2 id=5-构建--运行-1>5. 构建 & 运行<a hidden class=anchor aria-hidden=true href=#5-构建--运行-1>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker build -t whisper-api .
</span></span><span style=display:flex><span>docker run -d --name whisper -p 8000:8000 whisper-api
</span></span></code></pre></div><h2 id=6-调用示例与之前完全一致>6. 调用示例（与之前完全一致）<a hidden class=anchor aria-hidden=true href=#6-调用示例与之前完全一致>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -X POST http://localhost:8000/recognize <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>     -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>     -d <span style=color:#e6db74>&#39;{&#34;url&#34;:&#34;http://192.168.80.47:16552/wsd.wav&#34;}&#39;</span>
</span></span></code></pre></div><p>返回示例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-JSON data-lang=JSON><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;text&#34;</span>: <span style=color:#e6db74>&#34;我是登&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;matched&#34;</span>: <span style=color:#e6db74>&#34;卧室灯&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=7-模型大小说明>7. 模型大小说明<a hidden class=anchor aria-hidden=true href=#7-模型大小说明>#</a></h2><p>模型 体积 CPU 推理速度
tiny 39 MB 非常快
base 74 MB 推荐（已用）
small 244 MB 更准但更慢</p><p>如需更准，把 load_model(&ldquo;base&rdquo;) 换成 &ldquo;small&rdquo; 即可，无需改其他代码。</p><h1 id=vosk-qwen>vosk-qwen<a hidden class=anchor aria-hidden=true href=#vosk-qwen>#</a></h1><h2 id=1-系统依赖一次性-1>1. 系统依赖（一次性）<a hidden class=anchor aria-hidden=true href=#1-系统依赖一次性-1>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt update
</span></span><span style=display:flex><span>sudo apt install -y python3-venv ffmpeg wget unzip git git-lfs
</span></span></code></pre></div><h2 id=2-虚拟环境--依赖>2. 虚拟环境 & 依赖<a hidden class=anchor aria-hidden=true href=#2-虚拟环境--依赖>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>python3 -m venv ~/qwen_stt
</span></span><span style=display:flex><span>source ~/qwen_stt/bin/activate
</span></span><span style=display:flex><span>pip install --upgrade pip
</span></span><span style=display:flex><span>pip install vosk transformers torch accelerate <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>            pypinyin fuzzywuzzy python-Levenshtein <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>            fastapi uvicorn aiohttp aiofiles requests
</span></span></code></pre></div><h2 id=3-下载模型-15-gb>3. 下载模型（≈ 1.5 GB）<a hidden class=anchor aria-hidden=true href=#3-下载模型-15-gb>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p ~/qwen_stt/models <span style=color:#f92672>&amp;&amp;</span> cd ~/qwen_stt/models
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 1. Vosk 中文小模型</span>
</span></span><span style=display:flex><span>wget https://alphacephei.com/vosk/models/vosk-model-small-cn-0.22.zip
</span></span><span style=display:flex><span>unzip vosk-model-small-cn-0.22.zip <span style=color:#f92672>&amp;&amp;</span> mv vosk-model-small-cn-0.22 vosk
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2. Qwen2.5-0.5B-it</span>
</span></span><span style=display:flex><span>git lfs install
</span></span><span style=display:flex><span>git clone https://huggingface.co/Qwen/Qwen2.5-0.5B-Instruct qwen2.5-0.5b
</span></span></code></pre></div><h2 id=4-单文件-apppy>4. 单文件 app.py<a hidden class=anchor aria-hidden=true href=#4-单文件-apppy>#</a></h2><p>保存为 ~/qwen_stt/app.py 即可运行。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/env python3</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Vosk 关键词（拼音匹配） + Qwen2.5-0.5B（未命中）
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- 命中关键词 → 返回 id
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- 未命中 → 用 Vosk 原文对话
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> torch 
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> os<span style=color:#f92672>,</span> tempfile<span style=color:#f92672>,</span> wave<span style=color:#f92672>,</span> json<span style=color:#f92672>,</span> asyncio<span style=color:#f92672>,</span> aiofiles<span style=color:#f92672>,</span> aiohttp
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> fastapi <span style=color:#f92672>import</span> FastAPI, HTTPException, UploadFile, File
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> pydantic <span style=color:#f92672>import</span> BaseModel, HttpUrl
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> vosk <span style=color:#f92672>import</span> Model, KaldiRecognizer
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> pypinyin <span style=color:#f92672>import</span> lazy_pinyin
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> fuzzywuzzy <span style=color:#f92672>import</span> fuzz
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> transformers <span style=color:#f92672>import</span> AutoTokenizer, AutoModelForCausalLM
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>###############################################################################</span>
</span></span><span style=display:flex><span>KEYWORD2ID <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;空调&#34;</span>: <span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#34;电视&#34;</span>: <span style=color:#ae81ff>2</span>, <span style=color:#e6db74>&#34;风扇&#34;</span>: <span style=color:#ae81ff>3</span>, <span style=color:#e6db74>&#34;卧室灯&#34;</span>: <span style=color:#ae81ff>4</span>, <span style=color:#e6db74>&#34;客厅灯&#34;</span>: <span style=color:#ae81ff>5</span>}
</span></span><span style=display:flex><span>QWEN_PATH <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>dirname(__file__), <span style=color:#e6db74>&#34;models&#34;</span>, <span style=color:#e6db74>&#34;qwen2.5-0.5b&#34;</span>)
</span></span><span style=display:flex><span>VOSK_PATH <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>dirname(__file__), <span style=color:#e6db74>&#34;models&#34;</span>, <span style=color:#e6db74>&#34;vosk&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>vosk_model <span style=color:#f92672>=</span> Model(VOSK_PATH)
</span></span><span style=display:flex><span>tok <span style=color:#f92672>=</span> AutoTokenizer<span style=color:#f92672>.</span>from_pretrained(QWEN_PATH, trust_remote_code<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>chat_model <span style=color:#f92672>=</span> AutoModelForCausalLM<span style=color:#f92672>.</span>from_pretrained(
</span></span><span style=display:flex><span>    QWEN_PATH,
</span></span><span style=display:flex><span>    torch_dtype<span style=color:#f92672>=</span>torch<span style=color:#f92672>.</span>float16,
</span></span><span style=display:flex><span>    device_map<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;auto&#34;</span>,
</span></span><span style=display:flex><span>    trust_remote_code<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>)<span style=color:#f92672>.</span>eval()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app <span style=color:#f92672>=</span> FastAPI(title<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Vosk-Key-Qwen&#34;</span>, version<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;1.0&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>###############################################################################</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>wav2text</span>(path: str) <span style=color:#f92672>-&gt;</span> str:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> wave<span style=color:#f92672>.</span>open(path, <span style=color:#e6db74>&#34;rb&#34;</span>) <span style=color:#66d9ef>as</span> wf:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> wf<span style=color:#f92672>.</span>getnchannels() <span style=color:#f92672>!=</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>or</span> wf<span style=color:#f92672>.</span>getsampwidth() <span style=color:#f92672>!=</span> <span style=color:#ae81ff>2</span> <span style=color:#f92672>or</span> wf<span style=color:#f92672>.</span>getframerate() <span style=color:#f92672>!=</span> <span style=color:#ae81ff>16000</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>ValueError</span>(<span style=color:#e6db74>&#34;音频需 16 kHz 16-bit 单声道&#34;</span>)
</span></span><span style=display:flex><span>        rec <span style=color:#f92672>=</span> KaldiRecognizer(vosk_model, wf<span style=color:#f92672>.</span>getframerate())
</span></span><span style=display:flex><span>        res <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>            data <span style=color:#f92672>=</span> wf<span style=color:#f92672>.</span>readframes(<span style=color:#ae81ff>4000</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> data:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> rec<span style=color:#f92672>.</span>AcceptWaveform(data):
</span></span><span style=display:flex><span>                res<span style=color:#f92672>.</span>append(json<span style=color:#f92672>.</span>loads(rec<span style=color:#f92672>.</span>Result())[<span style=color:#e6db74>&#34;text&#34;</span>])
</span></span><span style=display:flex><span>        res<span style=color:#f92672>.</span>append(json<span style=color:#f92672>.</span>loads(rec<span style=color:#f92672>.</span>FinalResult())[<span style=color:#e6db74>&#34;text&#34;</span>])
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>.</span>join(res)<span style=color:#f92672>.</span>strip()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>fuzzy_match</span>(text: str):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;拼音匹配&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    txt_py <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>.</span>join(lazy_pinyin(text))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> kw, kid <span style=color:#f92672>in</span> KEYWORD2ID<span style=color:#f92672>.</span>items():
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> fuzz<span style=color:#f92672>.</span>partial_ratio(<span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>.</span>join(lazy_pinyin(kw)), txt_py) <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>70</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> kw, kid
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>None</span>, <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>qwen_chat</span>(prompt: str) <span style=color:#f92672>-&gt;</span> str:
</span></span><span style=display:flex><span>    msgs <span style=color:#f92672>=</span> [{<span style=color:#e6db74>&#34;role&#34;</span>: <span style=color:#e6db74>&#34;user&#34;</span>, <span style=color:#e6db74>&#34;content&#34;</span>: prompt}]
</span></span><span style=display:flex><span>    text <span style=color:#f92672>=</span> tok<span style=color:#f92672>.</span>apply_chat_template(msgs, tokenize<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>, add_generation_prompt<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>    inputs <span style=color:#f92672>=</span> tok(text, return_tensors<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;pt&#34;</span>)
</span></span><span style=display:flex><span>    out <span style=color:#f92672>=</span> chat_model<span style=color:#f92672>.</span>generate(<span style=color:#f92672>**</span>inputs, max_new_tokens<span style=color:#f92672>=</span><span style=color:#ae81ff>64</span>, do_sample<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>, temperature<span style=color:#f92672>=</span><span style=color:#ae81ff>0.7</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> tok<span style=color:#f92672>.</span>decode(out[<span style=color:#ae81ff>0</span>][len(inputs<span style=color:#f92672>.</span>input_ids[<span style=color:#ae81ff>0</span>]):], skip_special_tokens<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)<span style=color:#f92672>.</span>strip()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>###############################################################################</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RecURL</span>(BaseModel):
</span></span><span style=display:flex><span>    url: HttpUrl
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_do_recognize</span>(audio_path: str) <span style=color:#f92672>-&gt;</span> dict:
</span></span><span style=display:flex><span>    text <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> asyncio<span style=color:#f92672>.</span>to_thread(wav2text, audio_path)
</span></span><span style=display:flex><span>    kw, kid <span style=color:#f92672>=</span> fuzzy_match(text)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> kw:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> {<span style=color:#e6db74>&#34;text&#34;</span>: text, <span style=color:#e6db74>&#34;keyword&#34;</span>: kw, <span style=color:#e6db74>&#34;id&#34;</span>: kid}
</span></span><span style=display:flex><span>    reply <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> asyncio<span style=color:#f92672>.</span>to_thread(qwen_chat, text)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {<span style=color:#e6db74>&#34;text&#34;</span>: text, <span style=color:#e6db74>&#34;keyword&#34;</span>: <span style=color:#66d9ef>None</span>, <span style=color:#e6db74>&#34;id&#34;</span>: <span style=color:#ae81ff>0</span>, <span style=color:#e6db74>&#34;chat&#34;</span>: reply}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>###############################################################################</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@app.post</span>(<span style=color:#e6db74>&#34;/recognize&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>recognize_url</span>(req: RecURL):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>with</span> aiohttp<span style=color:#f92672>.</span>ClientSession(timeout<span style=color:#f92672>=</span>aiohttp<span style=color:#f92672>.</span>ClientTimeout(total<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>)) <span style=color:#66d9ef>as</span> session:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>with</span> session<span style=color:#f92672>.</span>get(str(req<span style=color:#f92672>.</span>url)) <span style=color:#66d9ef>as</span> resp:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> resp<span style=color:#f92672>.</span>status <span style=color:#f92672>!=</span> <span style=color:#ae81ff>200</span>:
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>raise</span> HTTPException(status_code<span style=color:#f92672>=</span><span style=color:#ae81ff>400</span>, detail<span style=color:#f92672>=</span><span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;远程文件 </span><span style=color:#e6db74>{</span>resp<span style=color:#f92672>.</span>status<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>                data <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> resp<span style=color:#f92672>.</span>read()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>with</span> tempfile<span style=color:#f92672>.</span>NamedTemporaryFile(suffix<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;.wav&#34;</span>, delete<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>) <span style=color:#66d9ef>as</span> tmp:
</span></span><span style=display:flex><span>            tmp<span style=color:#f92672>.</span>write(data)
</span></span><span style=display:flex><span>            tmp_path <span style=color:#f92672>=</span> tmp<span style=color:#f92672>.</span>name
</span></span><span style=display:flex><span>        out_path <span style=color:#f92672>=</span> tmp_path <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;_16k.wav&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> asyncio<span style=color:#f92672>.</span>to_thread(<span style=color:#66d9ef>lambda</span>: os<span style=color:#f92672>.</span>system(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;ffmpeg -y -i </span><span style=color:#e6db74>{</span>tmp_path<span style=color:#e6db74>}</span><span style=color:#e6db74> -ar 16000 -ac 1 -sample_fmt s16 </span><span style=color:#e6db74>{</span>out_path<span style=color:#e6db74>}</span><span style=color:#e6db74> &gt;/dev/null 2&gt;&amp;1&#34;</span>))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> asyncio<span style=color:#f92672>.</span>wait_for(_do_recognize(out_path), timeout<span style=color:#f92672>=</span><span style=color:#ae81ff>15</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> asyncio<span style=color:#f92672>.</span>TimeoutError:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> HTTPException(status_code<span style=color:#f92672>=</span><span style=color:#ae81ff>504</span>, detail<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;处理超时&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> HTTPException(status_code<span style=color:#f92672>=</span><span style=color:#ae81ff>500</span>, detail<span style=color:#f92672>=</span>str(e))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>finally</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> p <span style=color:#f92672>in</span> (tmp_path, out_path) <span style=color:#66d9ef>if</span> <span style=color:#e6db74>&#39;tmp_path&#39;</span> <span style=color:#f92672>in</span> locals() <span style=color:#66d9ef>else</span> ():
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>exists(p):
</span></span><span style=display:flex><span>                os<span style=color:#f92672>.</span>remove(p)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@app.post</span>(<span style=color:#e6db74>&#34;/upload&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>upload_file</span>(file: UploadFile <span style=color:#f92672>=</span> File(<span style=color:#f92672>...</span>)):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>with</span> tempfile<span style=color:#f92672>.</span>NamedTemporaryFile(suffix<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;.wav&#34;</span>, delete<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>) <span style=color:#66d9ef>as</span> tmp:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>with</span> aiofiles<span style=color:#f92672>.</span>open(tmp<span style=color:#f92672>.</span>name, <span style=color:#e6db74>&#34;wb&#34;</span>) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>await</span> f<span style=color:#f92672>.</span>write(<span style=color:#66d9ef>await</span> file<span style=color:#f92672>.</span>read())
</span></span><span style=display:flex><span>            out <span style=color:#f92672>=</span> tmp<span style=color:#f92672>.</span>name <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;_16k.wav&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>await</span> asyncio<span style=color:#f92672>.</span>to_thread(<span style=color:#66d9ef>lambda</span>: os<span style=color:#f92672>.</span>system(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;ffmpeg -y -i </span><span style=color:#e6db74>{</span>tmp<span style=color:#f92672>.</span>name<span style=color:#e6db74>}</span><span style=color:#e6db74> -ar 16000 -ac 1 -sample_fmt s16 </span><span style=color:#e6db74>{</span>out<span style=color:#e6db74>}</span><span style=color:#e6db74> &gt;/dev/null 2&gt;&amp;1&#34;</span>))
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> asyncio<span style=color:#f92672>.</span>wait_for(_do_recognize(out), timeout<span style=color:#f92672>=</span><span style=color:#ae81ff>15</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> asyncio<span style=color:#f92672>.</span>TimeoutError:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> HTTPException(status_code<span style=color:#f92672>=</span><span style=color:#ae81ff>504</span>, detail<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;处理超时&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> HTTPException(status_code<span style=color:#f92672>=</span><span style=color:#ae81ff>500</span>, detail<span style=color:#f92672>=</span>str(e))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>finally</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> p <span style=color:#f92672>in</span> (tmp<span style=color:#f92672>.</span>name, out) <span style=color:#66d9ef>if</span> <span style=color:#e6db74>&#39;tmp.name&#39;</span> <span style=color:#f92672>in</span> locals() <span style=color:#66d9ef>else</span> ():
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>exists(p):
</span></span><span style=display:flex><span>                os<span style=color:#f92672>.</span>remove(p)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>###############################################################################</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>import</span> uvicorn
</span></span><span style=display:flex><span>    uvicorn<span style=color:#f92672>.</span>run(app, host<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;0.0.0.0&#34;</span>, port<span style=color:#f92672>=</span><span style=color:#ae81ff>8000</span>)
</span></span></code></pre></div><h2 id=启动>启动<a hidden class=anchor aria-hidden=true href=#启动>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>source ~/qwen_stt/bin/activate
</span></span><span style=display:flex><span>python ~/qwen_stt/app.py
</span></span></code></pre></div><h2 id=调用示例>调用示例<a hidden class=anchor aria-hidden=true href=#调用示例>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 远程</span>
</span></span><span style=display:flex><span>curl -X POST http://localhost:8000/recognize <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>     -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>     -d <span style=color:#e6db74>&#39;{&#34;url&#34;:&#34;http://192.168.80.47:16552/test.wav&#34;}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 本地</span>
</span></span><span style=display:flex><span>curl -X POST http://localhost:8000/upload <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>     -F <span style=color:#e6db74>&#34;file=@/home/ubuntu/test.wav&#34;</span>
</span></span></code></pre></div><p>返回（命中卧室灯）：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-JSON data-lang=JSON><span style=display:flex><span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;text&#34;</span>: <span style=color:#e6db74>&#34;帮我打开卧室灯&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;keyword&#34;</span>: <span style=color:#e6db74>&#34;卧室灯&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#ae81ff>4</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;chat&#34;</span>: <span style=color:#e6db74>&#34;已为您打开卧室灯！&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>未命中：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-JSON data-lang=JSON><span style=display:flex><span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;text&#34;</span>: <span style=color:#e6db74>&#34;今天天气怎么样&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;keyword&#34;</span>: <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;chat&#34;</span>: <span style=color:#e6db74>&#34;今天北京晴，25℃。&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=multipart-err>multipart err<a hidden class=anchor aria-hidden=true href=#multipart-err>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pip install python-multipart
</span></span></code></pre></div><hr></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://qfsyso.github.io/posts/immich/><span class=title>« Prev</span><br><span>Immich</span>
</a><a class=next href=https://qfsyso.github.io/posts/api-signature/><span class=title>Next »</span><br><span>API Signature</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Vosk STT on x" href="https://x.com/intent/tweet/?text=Vosk%20STT&amp;url=https%3a%2f%2fqfsyso.github.io%2fposts%2fvosk-stt%2f&amp;hashtags="><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Vosk STT on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fqfsyso.github.io%2fposts%2fvosk-stt%2f&amp;title=Vosk%20STT&amp;summary=Vosk%20STT&amp;source=https%3a%2f%2fqfsyso.github.io%2fposts%2fvosk-stt%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Vosk STT on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fqfsyso.github.io%2fposts%2fvosk-stt%2f&title=Vosk%20STT"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Vosk STT on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fqfsyso.github.io%2fposts%2fvosk-stt%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Vosk STT on whatsapp" href="https://api.whatsapp.com/send?text=Vosk%20STT%20-%20https%3a%2f%2fqfsyso.github.io%2fposts%2fvosk-stt%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Vosk STT on telegram" href="https://telegram.me/share/url?text=Vosk%20STT&amp;url=https%3a%2f%2fqfsyso.github.io%2fposts%2fvosk-stt%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Vosk STT on ycombinator" href="https://news.ycombinator.com/submitlink?t=Vosk%20STT&u=https%3a%2f%2fqfsyso.github.io%2fposts%2fvosk-stt%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><div class=wtime><div class=wtime2>CST<span id=beijingTime></span> GMT <span id=londonTime></span> EST <span id=newYorkTime></span> PST<span id=losAngelesTime></span></div><div class=wtime2 style=display:none>东京<span id=tokyoTime></span></div><div class=wtime2 style=display:none>欧洲-巴黎<span id=parisTime></span></div><div class=wtime2 style=display:none>UTC<span id=utcTime></span></div></div><span>&copy; 2025 <a href=https://qfsyso.github.io/>MLOG</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a>
</span><script type=text/javascript>const timeZoneOffsets={beijing:8,tokyo:9,paris:[1,2],london:[0,1],newYork:[-5,-4],losAngeles:[-8,-7]};function padZero(e){return e<10?"0"+e:e}function formatTime(e){const t=e.getFullYear(),n=padZero(e.getMonth()+1),s=padZero(e.getDate()),o=padZero(e.getHours()),i=padZero(e.getMinutes()),a=padZero(e.getSeconds());return`${t}-${n}-${s} ${o}:${i}:${a}`}function isDaylightSavingTime(e,t){const o=e.getMonth(),n=new Date(e.getFullYear(),3,8,2,0,0),s=new Date(e.getFullYear(),10,1,2,0,0);return(t==="paris"||t==="london"||t==="newYork"||t==="losAngeles")&&e>=n&&e<s}function updateTime(){const e=new Date,t=new Date(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds()),n=formatTime(t);document.getElementById("utcTime").innerHTML=n;for(const n in timeZoneOffsets){const e=timeZoneOffsets[n];let s;Array.isArray(e)?s=isDaylightSavingTime(t,n)?e[1]:e[0]:s=e;const o=new Date(t.getTime()+s*60*60*1e3);document.getElementById(n+"Time").innerHTML=formatTime(o)}setTimeout(updateTime,1e3)}window.onload=function(){updateTime()};function notfound(e){var n=e.src,t=n.split("/"),s=t[t.length-1];e.src="https://47.115.223.75:8080/group1/v2/"+s+"?timestamp="+Date.now(),e.onerror=null}</script></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>