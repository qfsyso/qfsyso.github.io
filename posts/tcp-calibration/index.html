<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>TCP Calibration | MLOG</title>
<meta name="keywords" content="C#">
<meta name="description" content="初始化数据
Newtonsoft.Json
//config.json

{
 &#34;Lu1Items&#34;: [
   {
     &#34;ID&#34;: 1,
     &#34;Name&#34;: &#34;1路&#34;
   },
   {
     &#34;ID&#34;: 2,
     &#34;Name&#34;: &#34;2路&#34;
   },
   {
     &#34;ID&#34;: 3,
     &#34;Name&#34;: &#34;3路&#34;
   },
   {
     &#34;ID&#34;: 4,
     &#34;Name&#34;: &#34;4路&#34;
   },
   {
     &#34;ID&#34;: 5,
     &#34;Name&#34;: &#34;5路&#34;
   },
   {
     &#34;ID&#34;: 6,
     &#34;Name&#34;: &#34;6路&#34;
   },
   {
     &#34;ID&#34;: 7,
     &#34;Name&#34;: &#34;7路&#34;
   },
   {
     &#34;ID&#34;: 8,
     &#34;Name&#34;: &#34;8路&#34;
   }
 ],
 &#34;Value1Items&#34;: [
   {
     &#34;ID&#34;: 0,
     &#34;Name&#34;: &#34;0V&#34;
   },
   {
     &#34;ID&#34;: 5,
     &#34;Name&#34;: &#34;5V&#34;
   },
   {
     &#34;ID&#34;: 10,
     &#34;Name&#34;: &#34;10V&#34;
   }
 ]
}
数据处理
using System;
using System.Collections.Generic;
using System.IO;
using System.Windows.Forms;
using Newtonsoft.Json;

namespace ComboBoxJsonLoader
{
    /// &lt;summary&gt;
    /// 带ID的下拉列表项模型
    /// &lt;/summary&gt;
    public class ComboBoxItem
    {
        [JsonProperty(&#34;ID&#34;)]
        public int ID { get; set; }
        
        [JsonProperty(&#34;Name&#34;)]
        public string Name { get; set; }

        /// &lt;summary&gt;
        /// 重写ToString方法，使ComboBox显示Name属性
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public override string ToString()
        {
            return Name;
        }
    }

    /// &lt;summary&gt;
    /// 包含两个下拉列表数据的模型
    /// &lt;/summary&gt;
    public class ComboBoxData
    {
        [JsonProperty(&#34;Level1Items&#34;)]
        public List&lt;ComboBoxItem&gt; Level1Items { get; set; }
        
        [JsonProperty(&#34;Value1Items&#34;)]
        public List&lt;ComboBoxItem&gt; Value1Items { get; set; }
    }

    /// &lt;summary&gt;
    /// JSON数据加载器，负责从文件读取数据并填充到ComboBox
    /// &lt;/summary&gt;
    public class JsonDataLoader
    {
        /// &lt;summary&gt;
        /// 从JSON文件加载带ID的数据并填充到ComboBox
        /// &lt;/summary&gt;
        /// &lt;param name=&#34;jsonFilePath&#34;&gt;JSON文件路径&lt;/param&gt;
        /// &lt;param name=&#34;comboBoxL1&#34;&gt;第一个ComboBox控件&lt;/param&gt;
        /// &lt;param name=&#34;comboBoxV1&#34;&gt;第二个ComboBox控件&lt;/param&gt;
        public void LoadDataToComboBoxes(string jsonFilePath, ComboBox comboBoxL1, ComboBox comboBoxV1)
        {
            try
            {
                // 检查文件是否存在
                if (!File.Exists(jsonFilePath))
                {
                    MessageBox.Show($&#34;文件不存在: {jsonFilePath}&#34;, &#34;错误&#34;, 
                                    MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }

                // 读取JSON文件内容
                string jsonContent = File.ReadAllText(jsonFilePath);
                
                // 反序列化为对象
                ComboBoxData data = JsonConvert.DeserializeObject&lt;ComboBoxData&gt;(jsonContent);
                
                // 检查反序列化结果
                if (data == null)
                {
                    MessageBox.Show(&#34;无法解析JSON数据&#34;, &#34;错误&#34;, 
                                    MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }

                // 填充第一个ComboBox
                if (data.Level1Items != null &amp;&amp; data.Level1Items.Count &gt; 0)
                {
                    comboBoxL1.DataSource = data.Level1Items;
                    comboBoxL1.DisplayMember = &#34;Name&#34;;
                    comboBoxL1.ValueMember = &#34;ID&#34;;
                }
                else
                {
                    MessageBox.Show(&#34;Level1Items数据为空或不存在&#34;, &#34;警告&#34;, 
                                    MessageBoxButtons.OK, MessageBoxIcon.Warning);
                }

                // 填充第二个ComboBox
                if (data.Value1Items != null &amp;&amp; data.Value1Items.Count &gt; 0)
                {
                    comboBoxV1.DataSource = data.Value1Items;
                    comboBoxV1.DisplayMember = &#34;Name&#34;;
                    comboBoxV1.ValueMember = &#34;ID&#34;;
                }
                else
                {
                    MessageBox.Show(&#34;Value1Items数据为空或不存在&#34;, &#34;警告&#34;, 
                                    MessageBoxButtons.OK, MessageBoxIcon.Warning);
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($&#34;加载数据时出错: {ex.Message}&#34;, &#34;错误&#34;, 
                                MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }
    }
}
//Designer.cs
namespace ColorCWinFormsApp1
{

        partial class Form1
        {
            /// &lt;summary&gt;
            /// 必需的设计器变量。
            /// &lt;/summary&gt;
            private System.ComponentModel.IContainer components = null;

            /// &lt;summary&gt;
            /// 清理所有正在使用的资源。
            /// &lt;/summary&gt;
            /// &lt;param name=&#34;disposing&#34;&gt;如果应释放托管资源，为 true；否则为 false。&lt;/param&gt;
            protected override void Dispose(bool disposing)
            {
                if (disposing &amp;&amp; (components != null))
                {
                    components.Dispose();
                }
                base.Dispose(disposing);
            }

        #region Windows 窗体设计器生成的代码

        /// &lt;summary&gt;
        /// 设计器支持所需的方法 - 不要修改
        /// 使用代码编辑器修改此方法的内容。
        /// &lt;/summary&gt;
        private void InitializeComponent()
        {
            comboBoxL1 = new ComboBox();
            comboBoxV1 = new ComboBox();
            label1 = new Label();
            label2 = new Label();
            statusStrip1 = new StatusStrip();
            toolStripStatusLabel1 = new ToolStripStatusLabel();
            toolStripStatusLabel2 = new ToolStripStatusLabel();
            toolStrip1 = new ToolStrip();
            toolStripButtonRefresh = new ToolStripButton();
            statusStrip1.SuspendLayout();
            toolStrip1.SuspendLayout();
            SuspendLayout();
            // 
            // comboBoxL1
            // 
            comboBoxL1.DropDownStyle = ComboBoxStyle.DropDownList;
            comboBoxL1.FormattingEnabled = true;
            comboBoxL1.Location = new Point(12, 43);
            comboBoxL1.Name = &#34;comboBoxL1&#34;;
            comboBoxL1.Size = new Size(250, 25);
            comboBoxL1.TabIndex = 0;
            // 
            // comboBoxV1
            // 
            comboBoxV1.DropDownStyle = ComboBoxStyle.DropDownList;
            comboBoxV1.FormattingEnabled = true;
            comboBoxV1.Location = new Point(12, 111);
            comboBoxV1.Name = &#34;comboBoxV1&#34;;
            comboBoxV1.Size = new Size(250, 25);
            comboBoxV1.TabIndex = 1;
            // 
            // label1
            // 
            label1.AutoSize = true;
            label1.Location = new Point(12, 23);
            label1.Name = &#34;label1&#34;;
            label1.Size = new Size(39, 17);
            label1.TabIndex = 2;
            label1.Text = &#34;路数 :&#34;;
            // 
            // label2
            // 
            label2.AutoSize = true;
            label2.Location = new Point(12, 91);
            label2.Name = &#34;label2&#34;;
            label2.Size = new Size(39, 17);
            label2.TabIndex = 3;
            label2.Text = &#34;电压 :&#34;;
            // 
            // statusStrip1
            // 
            statusStrip1.Items.AddRange(new ToolStripItem[] { toolStripStatusLabel1, toolStripStatusLabel2 });
            statusStrip1.Location = new Point(0, 438);
            statusStrip1.Name = &#34;statusStrip1&#34;;
            statusStrip1.Size = new Size(606, 22);
            statusStrip1.TabIndex = 4;
            statusStrip1.Text = &#34;statusStrip1&#34;;
            // 
            // toolStripStatusLabel1
            // 
            toolStripStatusLabel1.Name = &#34;toolStripStatusLabel1&#34;;
            toolStripStatusLabel1.Size = new Size(131, 17);
            toolStripStatusLabel1.Text = &#34;toolStripStatusLabel1&#34;;
            // 
            // toolStripStatusLabel2
            // 
            toolStripStatusLabel2.Name = &#34;toolStripStatusLabel2&#34;;
            toolStripStatusLabel2.Size = new Size(131, 17);
            toolStripStatusLabel2.Text = &#34;toolStripStatusLabel2&#34;;
            // 
            // toolStrip1
            // 
            toolStrip1.Items.AddRange(new ToolStripItem[] { toolStripButtonRefresh });
            toolStrip1.Location = new Point(0, 0);
            toolStrip1.Name = &#34;toolStrip1&#34;;
            toolStrip1.Size = new Size(606, 25);
            toolStrip1.TabIndex = 5;
            toolStrip1.Text = &#34;toolStrip1&#34;;
            // 
            // toolStripButtonRefresh
            // 
            toolStripButtonRefresh.DisplayStyle = ToolStripItemDisplayStyle.Text;
            toolStripButtonRefresh.ImageTransparentColor = Color.Magenta;
            toolStripButtonRefresh.Name = &#34;toolStripButtonRefresh&#34;;
            toolStripButtonRefresh.Size = new Size(36, 22);
            toolStripButtonRefresh.Text = &#34;刷新&#34;;
            toolStripButtonRefresh.Click &#43;= toolStripButtonRefresh_Click;
            // 
            // Form1
            // 
            AutoScaleDimensions = new SizeF(7F, 17F);
            AutoScaleMode = AutoScaleMode.Font;
            ClientSize = new Size(606, 460);
            Controls.Add(toolStrip1);
            Controls.Add(statusStrip1);
            Controls.Add(label2);
            Controls.Add(label1);
            Controls.Add(comboBoxV1);
            Controls.Add(comboBoxL1);
            Name = &#34;Form1&#34;;
            Text = &#34;Color&#34;;
            statusStrip1.ResumeLayout(false);
            statusStrip1.PerformLayout();
            toolStrip1.ResumeLayout(false);
            toolStrip1.PerformLayout();
            ResumeLayout(false);
            PerformLayout();
        }

        #endregion

        private System.Windows.Forms.ComboBox comboBoxL1;
            private System.Windows.Forms.ComboBox comboBoxV1;
            private System.Windows.Forms.Label label1;
            private System.Windows.Forms.Label label2;
            private System.Windows.Forms.StatusStrip statusStrip1;
            private System.Windows.Forms.ToolStripStatusLabel toolStripStatusLabel1;
            private System.Windows.Forms.ToolStripStatusLabel toolStripStatusLabel2;
            private System.Windows.Forms.ToolStrip toolStrip1;
            private System.Windows.Forms.ToolStripButton toolStripButtonRefresh;
        }
   
}
//Form1.cs
namespace ColorCWinFormsApp1
{
    public partial class Form1 : Form
    { // 数据加载器实例
        private readonly JsonDataLoader _dataLoader;
        
     // JSON文件路径
     private const string JsonFilePath = &#34;ColorConifg.json&#34;;

     public Form1()
     {
         InitializeComponent();
         _dataLoader = new JsonDataLoader();

         // 注册事件
         Load &#43;= Form1_Load;
         comboBoxL1.SelectedIndexChanged &#43;= ComboBoxL1_SelectedIndexChanged;
         comboBoxV1.SelectedIndexChanged &#43;= ComboBoxV1_SelectedIndexChanged;
     }

     private void Form1_Load(object sender, EventArgs e)
     {
         // 加载数据到ComboBox
         LoadComboBoxData();
     }

     /// &lt;summary&gt;
     /// 从JSON文件加载数据到ComboBox
     /// &lt;/summary&gt;
     private void LoadComboBoxData()
     {
         try
         {
             _dataLoader.LoadDataToComboBoxes(JsonFilePath, comboBoxL1, comboBoxV1);

             // 如果有数据，默认选中第一项
             if (comboBoxL1.Items.Count &gt; 0)
                 comboBoxL1.SelectedIndex = 0;

             if (comboBoxV1.Items.Count &gt; 0)
                 comboBoxV1.SelectedIndex = 0;
         }
         catch (Exception ex)
         {
             MessageBox.Show($&#34;加载数据失败: {ex.Message}&#34;, &#34;错误&#34;,
                             MessageBoxButtons.OK, MessageBoxIcon.Error);
         }
     }

     /// &lt;summary&gt;
     /// 第一个ComboBox选中项变化事件
     /// &lt;/summary&gt;
     private void ComboBoxL1_SelectedIndexChanged(object sender, EventArgs e)
     {
         if (comboBoxL1.SelectedItem is ComboBoxItem selectedItem)
         {
             // 显示选中项的信息 
             toolStripStatusLabel1.Text =
                 $&#34;选中的路数: {selectedItem.Name} (ID: {selectedItem.ID})&#34;;
         }
     }

     /// &lt;summary&gt;
     /// 第二个ComboBox选中项变化事件
     /// &lt;/summary&gt;
     private void ComboBoxV1_SelectedIndexChanged(object sender, EventArgs e)
     {
         if (comboBoxV1.SelectedItem is ComboBoxItem selectedItem)
         {
             // 显示选中项的信息 
             toolStripStatusLabel2.Text =
                 $&#34;选中的电压: {selectedItem.Name} (ID: {selectedItem.ID})&#34;;
         }
     }    
}
可以通过comboBoxL1.SelectedValue直接获取选中项的 ID
可以通过comboBoxL1.SelectedItem获取完整的选项对象">
<meta name="author" content="dwd">
<link rel="canonical" href="http://localhost:1313/posts/tcp-calibration/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.6da9a63d25a9608bca2f7f907a030e887a7dd3c3f3918e4cc113129361414bda.css" integrity="sha256-bammPSWpYIvKL3&#43;QegMOiHp908PzkY5MwRMSk2FBS9o=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/tcp-calibration/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="MLOG (Alt + H)">MLOG</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/posts/" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      TCP Calibration
    </h1>
    <div class="post-meta"><span title='2025-10-08 21:59:42 +0800 CST'>October 8, 2025</span>&nbsp;·&nbsp;15 min&nbsp;·&nbsp;dwd

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e5%88%9d%e5%a7%8b%e5%8c%96%e6%95%b0%e6%8d%ae" aria-label="初始化数据">初始化数据</a></li>
                <li>
                    <a href="#%e6%95%b0%e6%8d%ae%e5%a4%84%e7%90%86" aria-label="数据处理">数据处理</a></li>
                <li>
                    <a href="#tcp%e6%9c%8d%e5%8a%a1%e5%99%a8%e6%b5%8b%e8%af%95---%e5%8f%af%e9%80%89" aria-label="TCP服务器测试 - 可选">TCP服务器测试 - 可选</a></li>
                <li>
                    <a href="#%e8%bf%9e%e6%8e%a5%e4%b8%b2%e5%8f%a3%e6%9c%8d%e5%8a%a1%e5%99%a8" aria-label="连接串口服务器">连接串口服务器</a></li>
                <li>
                    <a href="#%e4%bc%98%e5%8c%96-%e5%8f%91%e9%80%81%e6%b6%88%e6%81%af%e4%b8%8e%e7%ba%bf%e7%a8%8b%e5%ae%89%e5%85%a8" aria-label="优化 发送消息与线程安全">优化 发送消息与线程安全</a></li>
                <li>
                    <a href="#crc-16-modbus%e8%ae%a1%e7%ae%97" aria-label="CRC-16-MODBUS计算">CRC-16-MODBUS计算</a></li>
                <li>
                    <a href="#16%e8%bf%9b%e5%88%b6%e5%a4%84%e7%90%86" aria-label="16进制处理">16进制处理</a></li>
                <li>
                    <a href="#%e5%8f%82%e6%95%b0%e7%ae%97%e6%b3%95" aria-label="参数算法">参数算法</a></li>
                <li>
                    <a href="#crc-checkbox" aria-label="CRC CheckBox">CRC CheckBox</a></li>
                <li>
                    <a href="#%e5%85%a8%e9%80%89chk" aria-label="全选chk">全选chk</a></li>
                <li>
                    <a href="#%e9%80%89%e4%b8%ad%e9%a1%b9" aria-label="选中项">选中项</a></li>
                <li>
                    <a href="#log" aria-label="Log">Log</a></li>
                <li>
                    <a href="#%e8%ae%be%e5%a4%87%e8%bd%ac16%e8%bf%9b%e5%88%b6" aria-label="设备转16进制">设备转16进制</a></li>
                <li>
                    <a href="#16%e8%bf%9b%e5%88%b6%e6%95%b0%e6%8d%ae" aria-label="16进制数据">16进制数据</a></li>
                <li>
                    <a href="#ep-w100-%e8%ae%be%e7%bd%ae" aria-label="EP-W100 设置">EP-W100 设置</a></li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%ae%e4%bf%9d%e5%ad%98" aria-label="配置保存">配置保存</a></li>
                <li>
                    <a href="#%e6%8e%a7%e5%88%b6%e9%80%89%e6%8b%a9" aria-label="控制选择">控制选择</a><ul>
                        
                <li>
                    <a href="#4%e4%bd%8d%e5%8d%81%e5%85%ad%e8%bf%9b%e5%88%b6-2%e4%bd%8d16%e8%bf%9b%e5%88%b6-0000-00" aria-label="4位十六进制 2位16进制 0000 00">4位十六进制 2位16进制 0000 00</a></li></ul>
                </li>
                <li>
                    <a href="#%e8%b0%83%e5%85%89%e8%b0%83%e8%89%b2%e6%8e%a7%e5%88%b6%e5%99%a8" aria-label="调光调色&amp;控制器">调光调色&amp;控制器</a><ul>
                        
                <li>
                    <a href="#%e8%bf%9e%e6%8e%a5%e8%b6%85%e6%97%b6" aria-label="连接超时">连接超时</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%8f%91%e9%80%81%e5%bb%b6%e6%97%b6-%e8%a7%a3%e5%86%b3%e6%89%b9%e9%87%8f%e5%8f%91%e9%80%81%e9%97%ae%e9%a2%98" aria-label="发送延时-解决批量发送问题">发送延时-解决批量发送问题</a></li>
                <li>
                    <a href="#%e4%b8%b2%e5%8f%a3%e8%b0%83%e8%af%95%e5%b7%a5%e5%85%b7-sscom-v5131" aria-label="串口调试工具 SSCOM V5.13.1">串口调试工具 SSCOM V5.13.1</a><ul>
                        
                <li>
                    <a href="#%e6%96%b0%e6%8c%87%e4%bb%a4%e6%b8%85%e9%99%a4%e6%97%a7%e5%86%85%e5%ae%b9" aria-label="新指令清除旧内容">新指令清除旧内容</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%89%a9%e5%b1%95" aria-label="扩展">扩展</a></li>
                <li>
                    <a href="#next" aria-label="Next">Next</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="初始化数据">初始化数据<a hidden class="anchor" aria-hidden="true" href="#初始化数据">#</a></h1>
<p>Newtonsoft.Json</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#75715e">//config.json
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34;Lu1Items&#34;</span><span style="color:#f92672">:</span> [
</span></span><span style="display:flex;"><span>   {
</span></span><span style="display:flex;"><span>     <span style="color:#e6db74">&#34;ID&#34;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>     <span style="color:#e6db74">&#34;Name&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;1路&#34;</span>
</span></span><span style="display:flex;"><span>   },
</span></span><span style="display:flex;"><span>   {
</span></span><span style="display:flex;"><span>     <span style="color:#e6db74">&#34;ID&#34;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">2</span>,
</span></span><span style="display:flex;"><span>     <span style="color:#e6db74">&#34;Name&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;2路&#34;</span>
</span></span><span style="display:flex;"><span>   },
</span></span><span style="display:flex;"><span>   {
</span></span><span style="display:flex;"><span>     <span style="color:#e6db74">&#34;ID&#34;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">3</span>,
</span></span><span style="display:flex;"><span>     <span style="color:#e6db74">&#34;Name&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;3路&#34;</span>
</span></span><span style="display:flex;"><span>   },
</span></span><span style="display:flex;"><span>   {
</span></span><span style="display:flex;"><span>     <span style="color:#e6db74">&#34;ID&#34;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">4</span>,
</span></span><span style="display:flex;"><span>     <span style="color:#e6db74">&#34;Name&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;4路&#34;</span>
</span></span><span style="display:flex;"><span>   },
</span></span><span style="display:flex;"><span>   {
</span></span><span style="display:flex;"><span>     <span style="color:#e6db74">&#34;ID&#34;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">5</span>,
</span></span><span style="display:flex;"><span>     <span style="color:#e6db74">&#34;Name&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;5路&#34;</span>
</span></span><span style="display:flex;"><span>   },
</span></span><span style="display:flex;"><span>   {
</span></span><span style="display:flex;"><span>     <span style="color:#e6db74">&#34;ID&#34;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">6</span>,
</span></span><span style="display:flex;"><span>     <span style="color:#e6db74">&#34;Name&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;6路&#34;</span>
</span></span><span style="display:flex;"><span>   },
</span></span><span style="display:flex;"><span>   {
</span></span><span style="display:flex;"><span>     <span style="color:#e6db74">&#34;ID&#34;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">7</span>,
</span></span><span style="display:flex;"><span>     <span style="color:#e6db74">&#34;Name&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;7路&#34;</span>
</span></span><span style="display:flex;"><span>   },
</span></span><span style="display:flex;"><span>   {
</span></span><span style="display:flex;"><span>     <span style="color:#e6db74">&#34;ID&#34;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">8</span>,
</span></span><span style="display:flex;"><span>     <span style="color:#e6db74">&#34;Name&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;8路&#34;</span>
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span> ],
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34;Value1Items&#34;</span><span style="color:#f92672">:</span> [
</span></span><span style="display:flex;"><span>   {
</span></span><span style="display:flex;"><span>     <span style="color:#e6db74">&#34;ID&#34;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>     <span style="color:#e6db74">&#34;Name&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;0V&#34;</span>
</span></span><span style="display:flex;"><span>   },
</span></span><span style="display:flex;"><span>   {
</span></span><span style="display:flex;"><span>     <span style="color:#e6db74">&#34;ID&#34;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">5</span>,
</span></span><span style="display:flex;"><span>     <span style="color:#e6db74">&#34;Name&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;5V&#34;</span>
</span></span><span style="display:flex;"><span>   },
</span></span><span style="display:flex;"><span>   {
</span></span><span style="display:flex;"><span>     <span style="color:#e6db74">&#34;ID&#34;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">10</span>,
</span></span><span style="display:flex;"><span>     <span style="color:#e6db74">&#34;Name&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;10V&#34;</span>
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span> ]
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="数据处理">数据处理<a hidden class="anchor" aria-hidden="true" href="#数据处理">#</a></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System.Collections.Generic;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System.IO;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System.Windows.Forms;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> Newtonsoft.Json;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">namespace</span> ComboBoxJsonLoader
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// 带ID的下拉列表项模型</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ComboBoxItem</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">        [JsonProperty(&#34;ID&#34;)]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> ID { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">        
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">        [JsonProperty(&#34;Name&#34;)]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> Name { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// 重写ToString方法，使ComboBox显示Name属性</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;returns&gt;&lt;/returns&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">string</span> ToString()
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> Name;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// 包含两个下拉列表数据的模型</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ComboBoxData</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">        [JsonProperty(&#34;Level1Items&#34;)]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> List&lt;ComboBoxItem&gt; Level1Items { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">        
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">        [JsonProperty(&#34;Value1Items&#34;)]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> List&lt;ComboBoxItem&gt; Value1Items { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// JSON数据加载器，负责从文件读取数据并填充到ComboBox</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">JsonDataLoader</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// 从JSON文件加载带ID的数据并填充到ComboBox</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;jsonFilePath&#34;&gt;JSON文件路径&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;comboBoxL1&#34;&gt;第一个ComboBox控件&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;comboBoxV1&#34;&gt;第二个ComboBox控件&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> LoadDataToComboBoxes(<span style="color:#66d9ef">string</span> jsonFilePath, ComboBox comboBoxL1, ComboBox comboBoxV1)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span>
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 检查文件是否存在</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (!File.Exists(jsonFilePath))
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    MessageBox.Show(<span style="color:#e6db74">$&#34;文件不存在: {jsonFilePath}&#34;</span>, <span style="color:#e6db74">&#34;错误&#34;</span>, 
</span></span><span style="display:flex;"><span>                                    MessageBoxButtons.OK, MessageBoxIcon.Error);
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 读取JSON文件内容</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">string</span> jsonContent = File.ReadAllText(jsonFilePath);
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 反序列化为对象</span>
</span></span><span style="display:flex;"><span>                ComboBoxData data = JsonConvert.DeserializeObject&lt;ComboBoxData&gt;(jsonContent);
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 检查反序列化结果</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (data == <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    MessageBox.Show(<span style="color:#e6db74">&#34;无法解析JSON数据&#34;</span>, <span style="color:#e6db74">&#34;错误&#34;</span>, 
</span></span><span style="display:flex;"><span>                                    MessageBoxButtons.OK, MessageBoxIcon.Error);
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 填充第一个ComboBox</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (data.Level1Items != <span style="color:#66d9ef">null</span> &amp;&amp; data.Level1Items.Count &gt; <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    comboBoxL1.DataSource = data.Level1Items;
</span></span><span style="display:flex;"><span>                    comboBoxL1.DisplayMember = <span style="color:#e6db74">&#34;Name&#34;</span>;
</span></span><span style="display:flex;"><span>                    comboBoxL1.ValueMember = <span style="color:#e6db74">&#34;ID&#34;</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    MessageBox.Show(<span style="color:#e6db74">&#34;Level1Items数据为空或不存在&#34;</span>, <span style="color:#e6db74">&#34;警告&#34;</span>, 
</span></span><span style="display:flex;"><span>                                    MessageBoxButtons.OK, MessageBoxIcon.Warning);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 填充第二个ComboBox</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (data.Value1Items != <span style="color:#66d9ef">null</span> &amp;&amp; data.Value1Items.Count &gt; <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    comboBoxV1.DataSource = data.Value1Items;
</span></span><span style="display:flex;"><span>                    comboBoxV1.DisplayMember = <span style="color:#e6db74">&#34;Name&#34;</span>;
</span></span><span style="display:flex;"><span>                    comboBoxV1.ValueMember = <span style="color:#e6db74">&#34;ID&#34;</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    MessageBox.Show(<span style="color:#e6db74">&#34;Value1Items数据为空或不存在&#34;</span>, <span style="color:#e6db74">&#34;警告&#34;</span>, 
</span></span><span style="display:flex;"><span>                                    MessageBoxButtons.OK, MessageBoxIcon.Warning);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">catch</span> (Exception ex)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                MessageBox.Show(<span style="color:#e6db74">$&#34;加载数据时出错: {ex.Message}&#34;</span>, <span style="color:#e6db74">&#34;错误&#34;</span>, 
</span></span><span style="display:flex;"><span>                                MessageBoxButtons.OK, MessageBoxIcon.Error);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">//Designer.cs</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">namespace</span> ColorCWinFormsApp1
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">partial</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Form1</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">/// 必需的设计器变量。</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">private</span> System.ComponentModel.IContainer components = <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">/// 清理所有正在使用的资源。</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">/// &lt;param name=&#34;disposing&#34;&gt;如果应释放托管资源，为 true；否则为 false。&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">void</span> Dispose(<span style="color:#66d9ef">bool</span> disposing)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (disposing &amp;&amp; (components != <span style="color:#66d9ef">null</span>))
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    components.Dispose();
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">base</span>.Dispose(disposing);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#region</span> Windows <span style="color:#960050;background-color:#1e0010">窗体设计器生成的代码</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// 设计器支持所需的方法 - 不要修改</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// 使用代码编辑器修改此方法的内容。</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> InitializeComponent()
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            comboBoxL1 = <span style="color:#66d9ef">new</span> ComboBox();
</span></span><span style="display:flex;"><span>            comboBoxV1 = <span style="color:#66d9ef">new</span> ComboBox();
</span></span><span style="display:flex;"><span>            label1 = <span style="color:#66d9ef">new</span> Label();
</span></span><span style="display:flex;"><span>            label2 = <span style="color:#66d9ef">new</span> Label();
</span></span><span style="display:flex;"><span>            statusStrip1 = <span style="color:#66d9ef">new</span> StatusStrip();
</span></span><span style="display:flex;"><span>            toolStripStatusLabel1 = <span style="color:#66d9ef">new</span> ToolStripStatusLabel();
</span></span><span style="display:flex;"><span>            toolStripStatusLabel2 = <span style="color:#66d9ef">new</span> ToolStripStatusLabel();
</span></span><span style="display:flex;"><span>            toolStrip1 = <span style="color:#66d9ef">new</span> ToolStrip();
</span></span><span style="display:flex;"><span>            toolStripButtonRefresh = <span style="color:#66d9ef">new</span> ToolStripButton();
</span></span><span style="display:flex;"><span>            statusStrip1.SuspendLayout();
</span></span><span style="display:flex;"><span>            toolStrip1.SuspendLayout();
</span></span><span style="display:flex;"><span>            SuspendLayout();
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// </span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// comboBoxL1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// </span>
</span></span><span style="display:flex;"><span>            comboBoxL1.DropDownStyle = ComboBoxStyle.DropDownList;
</span></span><span style="display:flex;"><span>            comboBoxL1.FormattingEnabled = <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>            comboBoxL1.Location = <span style="color:#66d9ef">new</span> Point(<span style="color:#ae81ff">12</span>, <span style="color:#ae81ff">43</span>);
</span></span><span style="display:flex;"><span>            comboBoxL1.Name = <span style="color:#e6db74">&#34;comboBoxL1&#34;</span>;
</span></span><span style="display:flex;"><span>            comboBoxL1.Size = <span style="color:#66d9ef">new</span> Size(<span style="color:#ae81ff">250</span>, <span style="color:#ae81ff">25</span>);
</span></span><span style="display:flex;"><span>            comboBoxL1.TabIndex = <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// </span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// comboBoxV1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// </span>
</span></span><span style="display:flex;"><span>            comboBoxV1.DropDownStyle = ComboBoxStyle.DropDownList;
</span></span><span style="display:flex;"><span>            comboBoxV1.FormattingEnabled = <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>            comboBoxV1.Location = <span style="color:#66d9ef">new</span> Point(<span style="color:#ae81ff">12</span>, <span style="color:#ae81ff">111</span>);
</span></span><span style="display:flex;"><span>            comboBoxV1.Name = <span style="color:#e6db74">&#34;comboBoxV1&#34;</span>;
</span></span><span style="display:flex;"><span>            comboBoxV1.Size = <span style="color:#66d9ef">new</span> Size(<span style="color:#ae81ff">250</span>, <span style="color:#ae81ff">25</span>);
</span></span><span style="display:flex;"><span>            comboBoxV1.TabIndex = <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// </span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// label1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// </span>
</span></span><span style="display:flex;"><span>            label1.AutoSize = <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>            label1.Location = <span style="color:#66d9ef">new</span> Point(<span style="color:#ae81ff">12</span>, <span style="color:#ae81ff">23</span>);
</span></span><span style="display:flex;"><span>            label1.Name = <span style="color:#e6db74">&#34;label1&#34;</span>;
</span></span><span style="display:flex;"><span>            label1.Size = <span style="color:#66d9ef">new</span> Size(<span style="color:#ae81ff">39</span>, <span style="color:#ae81ff">17</span>);
</span></span><span style="display:flex;"><span>            label1.TabIndex = <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>            label1.Text = <span style="color:#e6db74">&#34;路数 :&#34;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// </span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// label2</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// </span>
</span></span><span style="display:flex;"><span>            label2.AutoSize = <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>            label2.Location = <span style="color:#66d9ef">new</span> Point(<span style="color:#ae81ff">12</span>, <span style="color:#ae81ff">91</span>);
</span></span><span style="display:flex;"><span>            label2.Name = <span style="color:#e6db74">&#34;label2&#34;</span>;
</span></span><span style="display:flex;"><span>            label2.Size = <span style="color:#66d9ef">new</span> Size(<span style="color:#ae81ff">39</span>, <span style="color:#ae81ff">17</span>);
</span></span><span style="display:flex;"><span>            label2.TabIndex = <span style="color:#ae81ff">3</span>;
</span></span><span style="display:flex;"><span>            label2.Text = <span style="color:#e6db74">&#34;电压 :&#34;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// </span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// statusStrip1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// </span>
</span></span><span style="display:flex;"><span>            statusStrip1.Items.AddRange(<span style="color:#66d9ef">new</span> ToolStripItem[] { toolStripStatusLabel1, toolStripStatusLabel2 });
</span></span><span style="display:flex;"><span>            statusStrip1.Location = <span style="color:#66d9ef">new</span> Point(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">438</span>);
</span></span><span style="display:flex;"><span>            statusStrip1.Name = <span style="color:#e6db74">&#34;statusStrip1&#34;</span>;
</span></span><span style="display:flex;"><span>            statusStrip1.Size = <span style="color:#66d9ef">new</span> Size(<span style="color:#ae81ff">606</span>, <span style="color:#ae81ff">22</span>);
</span></span><span style="display:flex;"><span>            statusStrip1.TabIndex = <span style="color:#ae81ff">4</span>;
</span></span><span style="display:flex;"><span>            statusStrip1.Text = <span style="color:#e6db74">&#34;statusStrip1&#34;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// </span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// toolStripStatusLabel1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// </span>
</span></span><span style="display:flex;"><span>            toolStripStatusLabel1.Name = <span style="color:#e6db74">&#34;toolStripStatusLabel1&#34;</span>;
</span></span><span style="display:flex;"><span>            toolStripStatusLabel1.Size = <span style="color:#66d9ef">new</span> Size(<span style="color:#ae81ff">131</span>, <span style="color:#ae81ff">17</span>);
</span></span><span style="display:flex;"><span>            toolStripStatusLabel1.Text = <span style="color:#e6db74">&#34;toolStripStatusLabel1&#34;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// </span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// toolStripStatusLabel2</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// </span>
</span></span><span style="display:flex;"><span>            toolStripStatusLabel2.Name = <span style="color:#e6db74">&#34;toolStripStatusLabel2&#34;</span>;
</span></span><span style="display:flex;"><span>            toolStripStatusLabel2.Size = <span style="color:#66d9ef">new</span> Size(<span style="color:#ae81ff">131</span>, <span style="color:#ae81ff">17</span>);
</span></span><span style="display:flex;"><span>            toolStripStatusLabel2.Text = <span style="color:#e6db74">&#34;toolStripStatusLabel2&#34;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// </span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// toolStrip1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// </span>
</span></span><span style="display:flex;"><span>            toolStrip1.Items.AddRange(<span style="color:#66d9ef">new</span> ToolStripItem[] { toolStripButtonRefresh });
</span></span><span style="display:flex;"><span>            toolStrip1.Location = <span style="color:#66d9ef">new</span> Point(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>            toolStrip1.Name = <span style="color:#e6db74">&#34;toolStrip1&#34;</span>;
</span></span><span style="display:flex;"><span>            toolStrip1.Size = <span style="color:#66d9ef">new</span> Size(<span style="color:#ae81ff">606</span>, <span style="color:#ae81ff">25</span>);
</span></span><span style="display:flex;"><span>            toolStrip1.TabIndex = <span style="color:#ae81ff">5</span>;
</span></span><span style="display:flex;"><span>            toolStrip1.Text = <span style="color:#e6db74">&#34;toolStrip1&#34;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// </span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// toolStripButtonRefresh</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// </span>
</span></span><span style="display:flex;"><span>            toolStripButtonRefresh.DisplayStyle = ToolStripItemDisplayStyle.Text;
</span></span><span style="display:flex;"><span>            toolStripButtonRefresh.ImageTransparentColor = Color.Magenta;
</span></span><span style="display:flex;"><span>            toolStripButtonRefresh.Name = <span style="color:#e6db74">&#34;toolStripButtonRefresh&#34;</span>;
</span></span><span style="display:flex;"><span>            toolStripButtonRefresh.Size = <span style="color:#66d9ef">new</span> Size(<span style="color:#ae81ff">36</span>, <span style="color:#ae81ff">22</span>);
</span></span><span style="display:flex;"><span>            toolStripButtonRefresh.Text = <span style="color:#e6db74">&#34;刷新&#34;</span>;
</span></span><span style="display:flex;"><span>            toolStripButtonRefresh.Click += toolStripButtonRefresh_Click;
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// </span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Form1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// </span>
</span></span><span style="display:flex;"><span>            AutoScaleDimensions = <span style="color:#66d9ef">new</span> SizeF(<span style="color:#ae81ff">7F</span>, <span style="color:#ae81ff">17F</span>);
</span></span><span style="display:flex;"><span>            AutoScaleMode = AutoScaleMode.Font;
</span></span><span style="display:flex;"><span>            ClientSize = <span style="color:#66d9ef">new</span> Size(<span style="color:#ae81ff">606</span>, <span style="color:#ae81ff">460</span>);
</span></span><span style="display:flex;"><span>            Controls.Add(toolStrip1);
</span></span><span style="display:flex;"><span>            Controls.Add(statusStrip1);
</span></span><span style="display:flex;"><span>            Controls.Add(label2);
</span></span><span style="display:flex;"><span>            Controls.Add(label1);
</span></span><span style="display:flex;"><span>            Controls.Add(comboBoxV1);
</span></span><span style="display:flex;"><span>            Controls.Add(comboBoxL1);
</span></span><span style="display:flex;"><span>            Name = <span style="color:#e6db74">&#34;Form1&#34;</span>;
</span></span><span style="display:flex;"><span>            Text = <span style="color:#e6db74">&#34;Color&#34;</span>;
</span></span><span style="display:flex;"><span>            statusStrip1.ResumeLayout(<span style="color:#66d9ef">false</span>);
</span></span><span style="display:flex;"><span>            statusStrip1.PerformLayout();
</span></span><span style="display:flex;"><span>            toolStrip1.ResumeLayout(<span style="color:#66d9ef">false</span>);
</span></span><span style="display:flex;"><span>            toolStrip1.PerformLayout();
</span></span><span style="display:flex;"><span>            ResumeLayout(<span style="color:#66d9ef">false</span>);
</span></span><span style="display:flex;"><span>            PerformLayout();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#endregion</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> System.Windows.Forms.ComboBox comboBoxL1;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">private</span> System.Windows.Forms.ComboBox comboBoxV1;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">private</span> System.Windows.Forms.Label label1;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">private</span> System.Windows.Forms.Label label2;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">private</span> System.Windows.Forms.StatusStrip statusStrip1;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">private</span> System.Windows.Forms.ToolStripStatusLabel toolStripStatusLabel1;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">private</span> System.Windows.Forms.ToolStripStatusLabel toolStripStatusLabel2;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">private</span> System.Windows.Forms.ToolStrip toolStrip1;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">private</span> System.Windows.Forms.ToolStripButton toolStripButtonRefresh;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">//Form1.cs</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">namespace</span> ColorCWinFormsApp1
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">partial</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Form1</span> : Form
</span></span><span style="display:flex;"><span>    { <span style="color:#75715e">// 数据加载器实例</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">readonly</span> JsonDataLoader _dataLoader;
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">// JSON文件路径</span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">string</span> JsonFilePath = <span style="color:#e6db74">&#34;ColorConifg.json&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">public</span> Form1()
</span></span><span style="display:flex;"><span>     {
</span></span><span style="display:flex;"><span>         InitializeComponent();
</span></span><span style="display:flex;"><span>         _dataLoader = <span style="color:#66d9ef">new</span> JsonDataLoader();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>         <span style="color:#75715e">// 注册事件</span>
</span></span><span style="display:flex;"><span>         Load += Form1_Load;
</span></span><span style="display:flex;"><span>         comboBoxL1.SelectedIndexChanged += ComboBoxL1_SelectedIndexChanged;
</span></span><span style="display:flex;"><span>         comboBoxV1.SelectedIndexChanged += ComboBoxV1_SelectedIndexChanged;
</span></span><span style="display:flex;"><span>     }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> Form1_Load(<span style="color:#66d9ef">object</span> sender, EventArgs e)
</span></span><span style="display:flex;"><span>     {
</span></span><span style="display:flex;"><span>         <span style="color:#75715e">// 加载数据到ComboBox</span>
</span></span><span style="display:flex;"><span>         LoadComboBoxData();
</span></span><span style="display:flex;"><span>     }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">/// 从JSON文件加载数据到ComboBox</span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> LoadComboBoxData()
</span></span><span style="display:flex;"><span>     {
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">try</span>
</span></span><span style="display:flex;"><span>         {
</span></span><span style="display:flex;"><span>             _dataLoader.LoadDataToComboBoxes(JsonFilePath, comboBoxL1, comboBoxV1);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>             <span style="color:#75715e">// 如果有数据，默认选中第一项</span>
</span></span><span style="display:flex;"><span>             <span style="color:#66d9ef">if</span> (comboBoxL1.Items.Count &gt; <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>                 comboBoxL1.SelectedIndex = <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>             <span style="color:#66d9ef">if</span> (comboBoxV1.Items.Count &gt; <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>                 comboBoxV1.SelectedIndex = <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>         }
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">catch</span> (Exception ex)
</span></span><span style="display:flex;"><span>         {
</span></span><span style="display:flex;"><span>             MessageBox.Show(<span style="color:#e6db74">$&#34;加载数据失败: {ex.Message}&#34;</span>, <span style="color:#e6db74">&#34;错误&#34;</span>,
</span></span><span style="display:flex;"><span>                             MessageBoxButtons.OK, MessageBoxIcon.Error);
</span></span><span style="display:flex;"><span>         }
</span></span><span style="display:flex;"><span>     }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">/// 第一个ComboBox选中项变化事件</span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> ComboBoxL1_SelectedIndexChanged(<span style="color:#66d9ef">object</span> sender, EventArgs e)
</span></span><span style="display:flex;"><span>     {
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">if</span> (comboBoxL1.SelectedItem <span style="color:#66d9ef">is</span> ComboBoxItem selectedItem)
</span></span><span style="display:flex;"><span>         {
</span></span><span style="display:flex;"><span>             <span style="color:#75715e">// 显示选中项的信息 </span>
</span></span><span style="display:flex;"><span>             toolStripStatusLabel1.Text =
</span></span><span style="display:flex;"><span>                 <span style="color:#e6db74">$&#34;选中的路数: {selectedItem.Name} (ID: {selectedItem.ID})&#34;</span>;
</span></span><span style="display:flex;"><span>         }
</span></span><span style="display:flex;"><span>     }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">/// 第二个ComboBox选中项变化事件</span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> ComboBoxV1_SelectedIndexChanged(<span style="color:#66d9ef">object</span> sender, EventArgs e)
</span></span><span style="display:flex;"><span>     {
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">if</span> (comboBoxV1.SelectedItem <span style="color:#66d9ef">is</span> ComboBoxItem selectedItem)
</span></span><span style="display:flex;"><span>         {
</span></span><span style="display:flex;"><span>             <span style="color:#75715e">// 显示选中项的信息 </span>
</span></span><span style="display:flex;"><span>             toolStripStatusLabel2.Text =
</span></span><span style="display:flex;"><span>                 <span style="color:#e6db74">$&#34;选中的电压: {selectedItem.Name} (ID: {selectedItem.ID})&#34;</span>;
</span></span><span style="display:flex;"><span>         }
</span></span><span style="display:flex;"><span>     }    
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>可以通过comboBoxL1.SelectedValue直接获取选中项的 ID
可以通过comboBoxL1.SelectedItem获取完整的选项对象</p>
<h1 id="tcp服务器测试---可选">TCP服务器测试 - 可选<a hidden class="anchor" aria-hidden="true" href="#tcp服务器测试---可选">#</a></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System.Net;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System.Net.Sockets;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System.Text;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System.Threading.Tasks;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System.Windows.Forms;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">namespace</span> TcpServerExample
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">partial</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MainForm</span> : Form
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> TcpListener server;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">bool</span> isServerRunning = <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> MainForm()
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            InitializeComponent();
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 初始化UI</span>
</span></span><span style="display:flex;"><span>            InitializeUI();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> InitializeUI()
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 设置窗体标题</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.Text = <span style="color:#e6db74">&#34;TCP服务器&#34;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.Size = <span style="color:#66d9ef">new</span> System.Drawing.Size(<span style="color:#ae81ff">600</span>, <span style="color:#ae81ff">400</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 创建日志文本框</span>
</span></span><span style="display:flex;"><span>            txtLog = <span style="color:#66d9ef">new</span> TextBox();
</span></span><span style="display:flex;"><span>            txtLog.Multiline = <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>            txtLog.ScrollBars = ScrollBars.Vertical;
</span></span><span style="display:flex;"><span>            txtLog.Dock = DockStyle.Fill;
</span></span><span style="display:flex;"><span>            txtLog.ReadOnly = <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 创建按钮</span>
</span></span><span style="display:flex;"><span>            buttonTestSer = <span style="color:#66d9ef">new</span> Button();
</span></span><span style="display:flex;"><span>            buttonTestSer.Text = <span style="color:#e6db74">&#34;启动TCP服务器&#34;</span>;
</span></span><span style="display:flex;"><span>            buttonTestSer.Dock = DockStyle.Top;
</span></span><span style="display:flex;"><span>            buttonTestSer.Height = <span style="color:#ae81ff">40</span>;
</span></span><span style="display:flex;"><span>            buttonTestSer.Click += buttonTestSer_Click;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 创建端口输入框</span>
</span></span><span style="display:flex;"><span>            txtPort = <span style="color:#66d9ef">new</span> TextBox();
</span></span><span style="display:flex;"><span>            txtPort.Dock = DockStyle.Top;
</span></span><span style="display:flex;"><span>            txtPort.Text = <span style="color:#e6db74">&#34;8888&#34;</span>;
</span></span><span style="display:flex;"><span>            txtPort.Height = <span style="color:#ae81ff">30</span>;
</span></span><span style="display:flex;"><span>            txtPort.PlaceholderText = <span style="color:#e6db74">&#34;输入端口号&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 添加控件到窗体</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.Controls.Add(txtLog);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.Controls.Add(buttonTestSer);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.Controls.Add(txtPort);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 注册窗体关闭事件</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.FormClosing += MainForm_FormClosing;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> buttonTestSer_Click(<span style="color:#66d9ef">object</span> sender, EventArgs e)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (!isServerRunning)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 启动服务器</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">int</span>.TryParse(txtPort.Text, <span style="color:#66d9ef">out</span> <span style="color:#66d9ef">int</span> port) &amp;&amp; port &gt; <span style="color:#ae81ff">0</span> &amp;&amp; port &lt;= <span style="color:#ae81ff">65535</span>)
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    Task.Run(() =&gt; StartTcpServer(port));
</span></span><span style="display:flex;"><span>                    buttonTestSer.Text = <span style="color:#e6db74">&#34;停止TCP服务器&#34;</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    MessageBox.Show(<span style="color:#e6db74">&#34;请输入有效的端口号（1-65535）&#34;</span>, <span style="color:#e6db74">&#34;输入错误&#34;</span>, MessageBoxButtons.OK, MessageBoxIcon.Error);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 停止服务器</span>
</span></span><span style="display:flex;"><span>                StopTcpServer();
</span></span><span style="display:flex;"><span>                buttonTestSer.Text = <span style="color:#e6db74">&#34;启动TCP服务器&#34;</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> StartTcpServer(<span style="color:#66d9ef">int</span> port)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span>
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 初始化TCP监听器</span>
</span></span><span style="display:flex;"><span>                server = <span style="color:#66d9ef">new</span> TcpListener(IPAddress.Any, port);
</span></span><span style="display:flex;"><span>                server.Start();
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>                isServerRunning = <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>                UpdateStatus(<span style="color:#e6db74">$&#34;服务器已启动，监听端口: {port}&#34;</span>);
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 循环接受客户端连接</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">while</span> (isServerRunning)
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// 等待客户端连接</span>
</span></span><span style="display:flex;"><span>                    TcpClient client = server.AcceptTcpClient();
</span></span><span style="display:flex;"><span>                    UpdateStatus(<span style="color:#e6db74">&#34;客户端已连接&#34;</span>);
</span></span><span style="display:flex;"><span>                    
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// 处理客户端通信（使用新线程避免阻塞接受其他连接）</span>
</span></span><span style="display:flex;"><span>                    Task.Run(() =&gt; HandleClient(client));
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">catch</span> (Exception ex)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (isServerRunning) <span style="color:#75715e">// 只有在服务器应该运行时才显示错误</span>
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    UpdateStatus(<span style="color:#e6db74">$&#34;服务器错误: {ex.Message}&#34;</span>);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> StopTcpServer()
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            isServerRunning = <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>            server?.Stop();
</span></span><span style="display:flex;"><span>            UpdateStatus(<span style="color:#e6db74">&#34;服务器已停止&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> HandleClient(TcpClient client)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span>
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 获取网络流</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">using</span> (NetworkStream stream = client.GetStream())
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">byte</span>[] buffer = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span>[<span style="color:#ae81ff">1024</span>];
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">int</span> bytesRead;
</span></span><span style="display:flex;"><span>                    
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// 读取客户端发送的数据</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">while</span> ((bytesRead = stream.Read(buffer, <span style="color:#ae81ff">0</span>, buffer.Length)) != <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>                    {
</span></span><span style="display:flex;"><span>                        <span style="color:#75715e">// 转换为字符串</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">string</span> clientMessage = Encoding.UTF8.GetString(buffer, <span style="color:#ae81ff">0</span>, bytesRead);
</span></span><span style="display:flex;"><span>                        UpdateStatus(<span style="color:#e6db74">$&#34;收到消息: {clientMessage}&#34;</span>);
</span></span><span style="display:flex;"><span>                        
</span></span><span style="display:flex;"><span>                        <span style="color:#75715e">// 追加OK并转换为字节数组</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">string</span> response = <span style="color:#e6db74">$&#34;{clientMessage}OK&#34;</span>;
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">byte</span>[] responseBytes = Encoding.UTF8.GetBytes(response);
</span></span><span style="display:flex;"><span>                        
</span></span><span style="display:flex;"><span>                        <span style="color:#75715e">// 发送回复</span>
</span></span><span style="display:flex;"><span>                        stream.Write(responseBytes, <span style="color:#ae81ff">0</span>, responseBytes.Length);
</span></span><span style="display:flex;"><span>                        UpdateStatus(<span style="color:#e6db74">$&#34;已回复: {response}&#34;</span>);
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>                UpdateStatus(<span style="color:#e6db74">&#34;客户端已断开连接&#34;</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">catch</span> (Exception ex)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                UpdateStatus(<span style="color:#e6db74">$&#34;客户端处理错误: {ex.Message}&#34;</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">finally</span>
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 关闭客户端连接</span>
</span></span><span style="display:flex;"><span>                client.Close();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 更新状态显示（跨线程安全）</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> UpdateStatus(<span style="color:#66d9ef">string</span> message)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (InvokeRequired)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                Invoke(<span style="color:#66d9ef">new</span> Action&lt;<span style="color:#66d9ef">string</span>&gt;(UpdateStatus), message);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 显示日志信息</span>
</span></span><span style="display:flex;"><span>            txtLog.AppendText(<span style="color:#e6db74">$&#34;{DateTime.Now:HH:mm:ss} {message}\r\n&#34;</span>);
</span></span><span style="display:flex;"><span>            txtLog.ScrollToCaret();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 窗体关闭时停止服务器</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> MainForm_FormClosing(<span style="color:#66d9ef">object</span> sender, FormClosingEventArgs e)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            StopTcpServer();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#region</span> <span style="color:#960050;background-color:#1e0010">自动生成的控件定义</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> TextBox txtLog;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> Button buttonTestSer;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> TextBox txtPort;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#endregion</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>    
</span></span></code></pre></div><p>运行</p>
<p>XX:52:09 服务器已启动，监听端口: 8881</p>
<h1 id="连接串口服务器">连接串口服务器<a hidden class="anchor" aria-hidden="true" href="#连接串口服务器">#</a></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">void</span> buttonCon1_Click(<span style="color:#66d9ef">object</span> sender, EventArgs e)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">string</span> ip1 = textBoxIP1.Text;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">string</span> port1 = textBoxPort1.Text;
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//MessageBox.Show(ip1 + &#34;:&#34;+port1);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 验证输入</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">string</span>.IsNullOrWhiteSpace(ip1) || <span style="color:#66d9ef">string</span>.IsNullOrWhiteSpace(port1))
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                MessageBox.Show(<span style="color:#e6db74">&#34;请输入IP地址和端口号&#34;</span>, <span style="color:#e6db74">&#34;输入错误&#34;</span>, MessageBoxButtons.OK, MessageBoxIcon.Error);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (!<span style="color:#66d9ef">int</span>.TryParse(port1, <span style="color:#66d9ef">out</span> <span style="color:#66d9ef">int</span> port) || port &lt; <span style="color:#ae81ff">1</span> || port &gt; <span style="color:#ae81ff">65535</span>)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                MessageBox.Show(<span style="color:#e6db74">&#34;请输入有效的端口号(1-65535)&#34;</span>, <span style="color:#e6db74">&#34;输入错误&#34;</span>, MessageBoxButtons.OK, MessageBoxIcon.Error);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span>
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 创建TCP客户端并连接服务器</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">using</span> (TcpClient client = <span style="color:#66d9ef">new</span> TcpClient())
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// 异步连接，避免UI卡顿</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">await</span> client.ConnectAsync(ip1, port);
</span></span><span style="display:flex;"><span>                    MessageBox.Show(<span style="color:#e6db74">$&#34;已成功连接到 {ip1}:{port}&#34;</span>, <span style="color:#e6db74">&#34;连接成功&#34;</span>, MessageBoxButtons.OK, MessageBoxIcon.Information);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// 准备要发送的消息</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">string</span> message = <span style="color:#e6db74">&#34;Hello from client!&#34;</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">byte</span>[] data = System.Text.Encoding.UTF8.GetBytes(message);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// 获取网络流并发送数据</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">using</span> (NetworkStream stream = client.GetStream())
</span></span><span style="display:flex;"><span>                    {
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">await</span> stream.WriteAsync(data, <span style="color:#ae81ff">0</span>, data.Length);
</span></span><span style="display:flex;"><span>                        MessageBox.Show(<span style="color:#e6db74">$&#34;已发送消息: {message}&#34;</span>, <span style="color:#e6db74">&#34;发送成功&#34;</span>, MessageBoxButtons.OK, MessageBoxIcon.Information);
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// 发送完成后关闭连接</span>
</span></span><span style="display:flex;"><span>                    client.Close();
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">catch</span> (Exception ex)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                MessageBox.Show(<span style="color:#e6db74">$&#34;连接或发送失败: {ex.Message}&#34;</span>, <span style="color:#e6db74">&#34;错误&#34;</span>, MessageBoxButtons.OK, MessageBoxIcon.Error);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span></code></pre></div><h1 id="优化-发送消息与线程安全">优化 发送消息与线程安全<a hidden class="anchor" aria-hidden="true" href="#优化-发送消息与线程安全">#</a></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> TcpClient client;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> NetworkStream stream;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">void</span> buttonCon1_Click(<span style="color:#66d9ef">object</span> sender, EventArgs e)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">string</span> ip1 = textBoxIP1.Text;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">string</span> port1 = textBoxPort1.Text;
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//MessageBox.Show(ip1 + &#34;:&#34;+port1);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 验证输入</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">string</span>.IsNullOrWhiteSpace(ip1) || <span style="color:#66d9ef">string</span>.IsNullOrWhiteSpace(port1))
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                MessageBox.Show(<span style="color:#e6db74">&#34;请输入IP地址和端口号&#34;</span>, <span style="color:#e6db74">&#34;输入错误&#34;</span>, MessageBoxButtons.OK, MessageBoxIcon.Error);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (!<span style="color:#66d9ef">int</span>.TryParse(port1, <span style="color:#66d9ef">out</span> <span style="color:#66d9ef">int</span> port) || port &lt; <span style="color:#ae81ff">1</span> || port &gt; <span style="color:#ae81ff">65535</span>)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                MessageBox.Show(<span style="color:#e6db74">&#34;请输入有效的端口号(1-65535)&#34;</span>, <span style="color:#e6db74">&#34;输入错误&#34;</span>, MessageBoxButtons.OK, MessageBoxIcon.Error);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span>
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                client = <span style="color:#66d9ef">new</span> TcpClient();
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// 异步连接，避免UI卡顿</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">await</span> client.ConnectAsync(ip1, port);
</span></span><span style="display:flex;"><span>                    MessageBox.Show(<span style="color:#e6db74">$&#34;已成功连接到 {ip1}:{port}&#34;</span>, <span style="color:#e6db74">&#34;连接成功&#34;</span>, MessageBoxButtons.OK, MessageBoxIcon.Information);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">catch</span> (Exception ex)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                MessageBox.Show(<span style="color:#e6db74">$&#34;连接或发送失败: {ex.Message}&#34;</span>, <span style="color:#e6db74">&#34;错误&#34;</span>, MessageBoxButtons.OK, MessageBoxIcon.Error);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">void</span> SendMsg1(<span style="color:#66d9ef">string</span> str)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (client == <span style="color:#66d9ef">null</span> || !client.Connected)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                UpdateStatus(<span style="color:#e6db74">&#34;未连接到服务器，请先建立连接&#34;</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">string</span> message = str;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span>
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 不要使用 using，保持流的持续打开</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (stream == <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>                    stream = client.GetStream();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 发送消息</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">byte</span>[] sendData = System.Text.Encoding.UTF8.GetBytes(message);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">await</span> stream.WriteAsync(sendData, <span style="color:#ae81ff">0</span>, sendData.Length);
</span></span><span style="display:flex;"><span>                UpdateStatus(<span style="color:#e6db74">$&#34;已发送: {message}&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 接收服务器响应</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">byte</span>[] receiveBuffer = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span>[<span style="color:#ae81ff">1024</span>];
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">int</span> bytesRead = <span style="color:#66d9ef">await</span> stream.ReadAsync(receiveBuffer, <span style="color:#ae81ff">0</span>, receiveBuffer.Length);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">string</span> response = System.Text.Encoding.UTF8.GetString(receiveBuffer, <span style="color:#ae81ff">0</span>, bytesRead);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                UpdateStatus(<span style="color:#e6db74">$&#34;收到响应: {response}&#34;</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">catch</span> (Exception ex)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                UpdateStatus(<span style="color:#e6db74">$&#34;发送失败: {ex.Message}&#34;</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 建议添加一个专门的关闭连接方法</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> CloseConnection()
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (stream != <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                stream.Dispose();
</span></span><span style="display:flex;"><span>                stream = <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (client != <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                client.Close();
</span></span><span style="display:flex;"><span>                client = <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>                UpdateStatus(<span style="color:#e6db74">&#34;连接已关闭&#34;</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 更新状态显示（跨线程安全）</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">void</span> UpdateStatus(<span style="color:#66d9ef">string</span> message)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (InvokeRequired)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                Invoke(<span style="color:#66d9ef">new</span> Action&lt;<span style="color:#66d9ef">string</span>&gt;(UpdateStatus), message);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 显示日志信息</span>
</span></span><span style="display:flex;"><span>            textBoxLog.AppendText(<span style="color:#e6db74">$&#34;{DateTime.Now:HH:mm:ss} {message}\r\n&#34;</span>);
</span></span><span style="display:flex;"><span>            textBoxLog.ScrollToCaret();
</span></span><span style="display:flex;"><span>        }
</span></span></code></pre></div><h1 id="crc-16-modbus计算">CRC-16-MODBUS计算<a hidden class="anchor" aria-hidden="true" href="#crc-16-modbus计算">#</a></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">string</span> CalculateModbusCRC16(<span style="color:#66d9ef">string</span> hexString)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 去除字符串中的空格</span>
</span></span><span style="display:flex;"><span>            hexString = hexString.Replace(<span style="color:#e6db74">&#34; &#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 验证输入的16进制字符串是否合法</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (hexString.Length % <span style="color:#ae81ff">2</span> != <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ArgumentException(<span style="color:#e6db74">&#34;Invalid hex string length&#34;</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 将16进制字符串转换为字节数组</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">byte</span>[] byteArray = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span>[hexString.Length / <span style="color:#ae81ff">2</span>];
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i = <span style="color:#ae81ff">0</span>; i &lt; hexString.Length; i += <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                byteArray[i / <span style="color:#ae81ff">2</span>] = Convert.ToByte(hexString.Substring(i, <span style="color:#ae81ff">2</span>), <span style="color:#ae81ff">16</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 初始化CRC值</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">ushort</span> crc = <span style="color:#ae81ff">0xFFFF</span>;  <span style="color:#75715e">// CRC初始值为0xFFFF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// CRC16算法</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">foreach</span> (<span style="color:#66d9ef">byte</span> b <span style="color:#66d9ef">in</span> byteArray)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                crc ^= b;  <span style="color:#75715e">// 对当前字节和CRC值进行异或操作</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> j = <span style="color:#ae81ff">0</span>; j &lt; <span style="color:#ae81ff">8</span>; j++)  <span style="color:#75715e">// 遍历每一个比特位</span>
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> ((crc &amp; <span style="color:#ae81ff">0x0001</span>) != <span style="color:#ae81ff">0</span>)  <span style="color:#75715e">// 检查最低位是否为1</span>
</span></span><span style="display:flex;"><span>                    {
</span></span><span style="display:flex;"><span>                        crc = (<span style="color:#66d9ef">ushort</span>)((crc &gt;&gt; <span style="color:#ae81ff">1</span>) ^ <span style="color:#ae81ff">0xA001</span>);  <span style="color:#75715e">// 如果是1，右移并进行多项式异或</span>
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>                    {
</span></span><span style="display:flex;"><span>                        crc &gt;&gt;= <span style="color:#ae81ff">1</span>;  <span style="color:#75715e">// 如果不是1，只右移</span>
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 返回CRC值，低字节和高字节(小端字节序)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">byte</span> lowByte = (<span style="color:#66d9ef">byte</span>)(crc &amp; <span style="color:#ae81ff">0xFF</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">byte</span> highByte = (<span style="color:#66d9ef">byte</span>)((crc &gt;&gt; <span style="color:#ae81ff">8</span>) &amp; <span style="color:#ae81ff">0xFF</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#e6db74">$&#34;{lowByte:X2}{highByte:X2}&#34;</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>           <span style="color:#75715e">// 使用示例</span>
</span></span><span style="display:flex;"><span>           <span style="color:#66d9ef">string</span> crc = CalculateModbusCRC16(<span style="color:#e6db74">&#34;0106000B2710&#34;</span>);
</span></span><span style="display:flex;"><span>           Console.WriteLine(crc);
</span></span><span style="display:flex;"><span>           
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">CRC16</span>(<span style="color:#a6e22e">hexString</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 去除字符串中的空格
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">hexString</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">hexString</span>.<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">/\s+/g</span>, <span style="color:#e6db74">&#39;&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 验证输入的16进制字符串是否合法
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">hexString</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">%</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">!==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#34;Invalid hex string length&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 将16进制字符串转换为字节数组
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">byteArray</span> <span style="color:#f92672">=</span> [];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">hexString</span>.<span style="color:#a6e22e">length</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">+=</span> <span style="color:#ae81ff">2</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">byte</span> <span style="color:#f92672">=</span> parseInt(<span style="color:#a6e22e">hexString</span>.<span style="color:#a6e22e">substr</span>(<span style="color:#a6e22e">i</span>, <span style="color:#ae81ff">2</span>), <span style="color:#ae81ff">16</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">byteArray</span>.<span style="color:#a6e22e">push</span>(<span style="color:#66d9ef">byte</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 初始化CRC值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">crc</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xFFFF</span>;  <span style="color:#75715e">// CRC初始值为0xFFFF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// CRC16算法
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">byteArray</span>.<span style="color:#a6e22e">length</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">crc</span> <span style="color:#f92672">^=</span> <span style="color:#a6e22e">byteArray</span>[<span style="color:#a6e22e">i</span>];  <span style="color:#75715e">// 对当前字节和CRC值进行异或操作
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">j</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">j</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">8</span>; <span style="color:#a6e22e">j</span><span style="color:#f92672">++</span>) {  <span style="color:#75715e">// 遍历每一个比特位
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">crc</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x0001</span>) {  <span style="color:#75715e">// 检查最低位是否为1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#a6e22e">crc</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">crc</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">^</span> <span style="color:#ae81ff">0xA001</span>;  <span style="color:#75715e">// 如果是1，右移并进行多项式异或
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">crc</span> <span style="color:#f92672">&gt;&gt;=</span> <span style="color:#ae81ff">1</span>;  <span style="color:#75715e">// 如果不是1，只右移
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 返回CRC值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">//return ((crc &gt;&gt; 8) &amp; 0xFF).toString(16).padStart(2, &#39;0&#39;) + (crc &amp; 0xFF).toString(16).padStart(2, &#39;0&#39;);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 返回CRC值，低字节和高字节(小端字节序)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> (<span style="color:#a6e22e">crc</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFF</span>).<span style="color:#a6e22e">toString</span>(<span style="color:#ae81ff">16</span>).<span style="color:#a6e22e">padStart</span>(<span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#39;0&#39;</span>).<span style="color:#a6e22e">toUpperCase</span>() <span style="color:#f92672">+</span> ((<span style="color:#a6e22e">crc</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">8</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFF</span>).<span style="color:#a6e22e">toString</span>(<span style="color:#ae81ff">16</span>).<span style="color:#a6e22e">padStart</span>(<span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#39;0&#39;</span>).<span style="color:#a6e22e">toUpperCase</span>();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 获取输入的16进制字符串（假设msg.payload是输入的16进制字符串）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">hexString</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">payload</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 计算CRC
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">crc</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">calculateModbusCRC16</span>(<span style="color:#a6e22e">hexString</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">payload</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">payload</span>.<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">/\s+/g</span>, <span style="color:#e6db74">&#39;&#39;</span>) <span style="color:#f92672">+</span> <span style="color:#a6e22e">crc</span>; 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 返回计算后的消息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">return</span> <span style="color:#a6e22e">msg</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//01 10 00 0A 00 02 04 13 88 13 88   0110000A00020413881388
</span></span></span></code></pre></div><h1 id="16进制处理">16进制处理<a hidden class="anchor" aria-hidden="true" href="#16进制处理">#</a></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>         <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">string</span> ToCustomHex(<span style="color:#66d9ef">int</span> number)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">int</span> result = number + <span style="color:#ae81ff">9</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> result.ToString(<span style="color:#e6db74">&#34;X4&#34;</span>); <span style="color:#75715e">// 转为4位十六进制，不足补0</span>
</span></span><span style="display:flex;"><span>	}
</span></span></code></pre></div><h1 id="参数算法">参数算法<a hidden class="anchor" aria-hidden="true" href="#参数算法">#</a></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>            <span style="color:#66d9ef">int</span> nv1 = Convert.ToInt32(sv1);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">int</span> nl1 = Convert.ToInt32(sl1);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">string</span> slu1 = ColorCHelper.ToCustomHex(nl1);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">string</span> svv1 = <span style="color:#e6db74">&#34;&#34;</span>;<span style="color:#75715e">// ColorCHelper.ToCustomHex(nv1);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (nv1 == <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                svv1 = <span style="color:#e6db74">&#34;0000&#34;</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (nv1 == <span style="color:#ae81ff">5</span>)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                svv1 = <span style="color:#e6db74">&#34;1388&#34;</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (nv1 == <span style="color:#ae81ff">10</span>)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                svv1 = <span style="color:#e6db74">&#34;2710&#34;</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            List&lt;<span style="color:#66d9ef">string</span> &gt; strlist = <span style="color:#66d9ef">new</span> List&lt;<span style="color:#66d9ef">string</span>&gt;();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">string</span> stemp11 = <span style="color:#e6db74">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i = <span style="color:#ae81ff">1</span>; i &lt;=nl1; i++)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">//f4</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">string</span> stemp = <span style="color:#e6db74">&#34;0106&#34;</span>;<span style="color:#75715e">//设备</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">string</span> inti1 = ColorCHelper.ToCustomHex(i);
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>                stemp = stemp + inti1 + svv1;<span style="color:#75715e">//4+4+4</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">string</span> s1 = ColorCHelper.CalculateModbusCRC16(stemp);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">string</span> srs1 = stemp + s1;
</span></span><span style="display:flex;"><span>                strlist.Add(srs1);
</span></span><span style="display:flex;"><span>                stemp11 +=  srs1+<span style="color:#e6db74">&#34;,&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            }
</span></span></code></pre></div><h1 id="crc-checkbox">CRC CheckBox<a hidden class="anchor" aria-hidden="true" href="#crc-checkbox">#</a></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span> <span style="color:#75715e">// 清空旧的内容</span>
</span></span><span style="display:flex;"><span>    panelZ.Controls.Clear();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> startY = <span style="color:#ae81ff">10</span>;      <span style="color:#75715e">// 起始 Y 坐标</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> spacing = <span style="color:#ae81ff">30</span>;     <span style="color:#75715e">// 每个 CheckBox 的间距</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i = <span style="color:#ae81ff">0</span>; i &lt; items.Count; i++)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        CheckBox chk = <span style="color:#66d9ef">new</span> CheckBox();
</span></span><span style="display:flex;"><span>        chk.Text = items[i];
</span></span><span style="display:flex;"><span>        chk.AutoSize = <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>        chk.Location = <span style="color:#66d9ef">new</span> Point(<span style="color:#ae81ff">10</span>, startY + i * spacing);
</span></span><span style="display:flex;"><span>        chk.Tag = items[i]; <span style="color:#75715e">// 可选：存储原始值</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 绑定事件（如果需要）</span>
</span></span><span style="display:flex;"><span>        chk.CheckedChanged += (sender, e) =&gt;
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> c = sender <span style="color:#66d9ef">as</span> CheckBox;
</span></span><span style="display:flex;"><span>            Console.WriteLine(<span style="color:#e6db74">$&#34;[{c.Text}] 状态: {c.Checked}&#34;</span>);
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 添加到 panelZ</span>
</span></span><span style="display:flex;"><span>        panelZ.Controls.Add(chk);
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><h1 id="全选chk">全选chk<a hidden class="anchor" aria-hidden="true" href="#全选chk">#</a></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>     <span style="color:#66d9ef">private</span> List&lt;CheckBox&gt; checkBoxes = <span style="color:#66d9ef">new</span> List&lt;CheckBox&gt;();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">///...</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//add chk</span>
</span></span><span style="display:flex;"><span>       <span style="color:#75715e">// 添加到 panelZ</span>
</span></span><span style="display:flex;"><span>       panelZ.Controls.Add(chk);
</span></span><span style="display:flex;"><span>       checkBoxes.Add(chk);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">///...</span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> checkBox1_CheckedChanged(<span style="color:#66d9ef">object</span> sender, EventArgs e)
</span></span><span style="display:flex;"><span>   {
</span></span><span style="display:flex;"><span>       <span style="color:#75715e">// 判断当前是否已经全选</span>
</span></span><span style="display:flex;"><span>       <span style="color:#66d9ef">bool</span> allChecked = checkBoxes.All(c =&gt; c.Checked);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>       <span style="color:#75715e">// 如果全选，则取消全选；否则全选</span>
</span></span><span style="display:flex;"><span>       <span style="color:#66d9ef">foreach</span> (<span style="color:#66d9ef">var</span> chk <span style="color:#66d9ef">in</span> checkBoxes)
</span></span><span style="display:flex;"><span>       {
</span></span><span style="display:flex;"><span>           chk.Checked = !allChecked;
</span></span><span style="display:flex;"><span>       }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>       <span style="color:#75715e">// 按钮文字切换</span>
</span></span><span style="display:flex;"><span>       checkBox1.Text = allChecked ? <span style="color:#e6db74">&#34;全选&#34;</span> : <span style="color:#e6db74">&#34;全不选&#34;</span>;
</span></span><span style="display:flex;"><span>   }
</span></span></code></pre></div><h1 id="选中项">选中项<a hidden class="anchor" aria-hidden="true" href="#选中项">#</a></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> selectedItems = checkBoxes
</span></span><span style="display:flex;"><span>       .Where(c =&gt; c.Checked)
</span></span><span style="display:flex;"><span>       .Select(c =&gt; c.Text)
</span></span><span style="display:flex;"><span>       .ToList();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (selectedItems.Count == <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                MessageBox.Show(<span style="color:#e6db74">&#34;没有选中任何项！&#34;</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">string</span> result = <span style="color:#66d9ef">string</span>.Join(<span style="color:#e6db74">&#34;, &#34;</span>, selectedItems);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">foreach</span> (<span style="color:#66d9ef">var</span> item <span style="color:#66d9ef">in</span> selectedItems)
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    SendMsg1(item +<span style="color:#e6db74">&#34; 设备：&#34;</span> + str1);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">//MessageBox.Show(&#34;选中的项: &#34; + result);</span>
</span></span><span style="display:flex;"><span>            }
</span></span></code></pre></div><h1 id="log">Log<a hidden class="anchor" aria-hidden="true" href="#log">#</a></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// 将内容追加到指定日志文件</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;param name=&#34;fileName&#34;&gt;文件名&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;param name=&#34;content&#34;&gt;要写入的内容&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> AppendToLogFile(<span style="color:#66d9ef">string</span> fileName, <span style="color:#66d9ef">string</span> content)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 获取当前应用程序目录作为日志保存路径</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">string</span> logPath = Path.Combine(Application.StartupPath, fileName);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 追加内容到文件，若文件不存在则创建</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 第二个参数true表示追加模式</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">using</span> (StreamWriter sw = <span style="color:#66d9ef">new</span> StreamWriter(logPath, <span style="color:#66d9ef">true</span>))
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 写入时间戳和内容</span>
</span></span><span style="display:flex;"><span>            sw.WriteLine(<span style="color:#e6db74">$&#34;[{DateTime.Now:yyyy-MM-dd HH:mm:ss}] {content}&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">catch</span> (Exception ex)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        MessageBox.Show(<span style="color:#e6db74">$&#34;保存日志失败: {ex.Message}&#34;</span>, <span style="color:#e6db74">&#34;错误&#34;</span>, MessageBoxButtons.OK, MessageBoxIcon.Error);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">///使用</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 获取TextBox中的文本内容</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">string</span> content = textBoxLog.Text;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (!<span style="color:#66d9ef">string</span>.IsNullOrEmpty(content))
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 生成以当前日期时分秒为名称的文件名</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">string</span> fileName = DateTime.Now.ToString(<span style="color:#e6db74">&#34;yyyyMMddHHmmss&#34;</span>) + <span style="color:#e6db74">&#34;.txt&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 调用方法将内容追加到日志文件</span>
</span></span><span style="display:flex;"><span>        AppendToLogFile(fileName, content);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        MessageBox.Show(<span style="color:#e6db74">&#34;日志已保存&#34;</span>, <span style="color:#e6db74">&#34;提示&#34;</span>, MessageBoxButtons.OK, MessageBoxIcon.Information);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        MessageBox.Show(<span style="color:#e6db74">&#34;TextBox内容不能为空&#34;</span>, <span style="color:#e6db74">&#34;警告&#34;</span>, MessageBoxButtons.OK, MessageBoxIcon.Warning);
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><h1 id="设备转16进制">设备转16进制<a hidden class="anchor" aria-hidden="true" href="#设备转16进制">#</a></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>      <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">string</span> ToCustomHexXXX(<span style="color:#66d9ef">int</span> number)
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">int</span> result = number;
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">return</span> result.ToString(<span style="color:#e6db74">&#34;X&#34;</span>); 
</span></span><span style="display:flex;"><span>	}
</span></span></code></pre></div><p>如 48 变成 30</p>
<p>30设备号，06写，
000A第一路(000F第六路，0010第七路），
2710十进制为10000，即10v，</p>
<h1 id="16进制数据">16进制数据<a hidden class="anchor" aria-hidden="true" href="#16进制数据">#</a></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>   <span style="color:#75715e">// 发送消息 - 转换为16进制字节数组</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// message是十六进制字符串，如&#34;FFAABBC1D2&#34;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">byte</span>[] sendData = ColorCHelper.StringToByteArray(message);
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">await</span> stream.WriteAsync(sendData, <span style="color:#ae81ff">0</span>, sendData.Length);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   UpdateStatus(<span style="color:#e6db74">$&#34;已发送: {message}&#34;</span>);
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// 接收服务器响应 - 以16进制形式处理</span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">byte</span>[] receiveBuffer = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span>[<span style="color:#ae81ff">1024</span>];
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">int</span> bytesRead = <span style="color:#66d9ef">await</span> stream.ReadAsync(receiveBuffer, <span style="color:#ae81ff">0</span>, receiveBuffer.Length);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// 将接收到的字节转换为十六进制字符串</span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">string</span> responseHex = BitConverter.ToString(receiveBuffer, <span style="color:#ae81ff">0</span>, bytesRead).Replace(<span style="color:#e6db74">&#34;-&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   UpdateStatus(<span style="color:#e6db74">$&#34;收到响应: {responseHex}&#34;</span>);
</span></span></code></pre></div><h1 id="ep-w100-设置">EP-W100 设置<a hidden class="anchor" aria-hidden="true" href="#ep-w100-设置">#</a></h1>
<p>输入输出模块设置
+-AB</p>
<p>EP-W100 设置
+-AB线电源线
设置SSID
DHCP OFF
设置WANIP
设置端口1 波特率如57600
保存重启</p>
<h1 id="配置保存">配置保存<a hidden class="anchor" aria-hidden="true" href="#配置保存">#</a></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span> <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// App配置项模型</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AppItem</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">    [JsonProperty(&#34;AIP&#34;)]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> AIP { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }  <span style="color:#75715e">// IP地址</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">    [JsonProperty(&#34;APort&#34;)]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> APort { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }  <span style="color:#75715e">// 端口号</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">    [JsonProperty(&#34;ASB&#34;)]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> ASB { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }  <span style="color:#75715e">// 其他属性</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">    [JsonProperty(&#34;AII1&#34;)]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> AII1 { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }  <span style="color:#75715e">// 其他属性</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// 包含下拉列表数据和App配置项的数据模型</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ComboBoxData</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">    [JsonProperty(&#34;Level1Items&#34;)]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> List&lt;ComboBoxItem&gt; Level1Items { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">    [JsonProperty(&#34;Value1Items&#34;)]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> List&lt;ComboBoxItem&gt; Value1Items { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">    [JsonProperty(&#34;AppItem&#34;)]</span>  <span style="color:#75715e">// 新增AppItem属性</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> AppItem AppItem { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// JSON数据加载器，负责从文件读取数据并填充到控件，以及保存数据</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">JsonDataLoader</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// 从JSON文件加载带ID的数据并填充到ComboBox和TextBox</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;jsonFilePath&#34;&gt;JSON文件路径&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;comboBoxL1&#34;&gt;第一个ComboBox控件&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;comboBoxV1&#34;&gt;第二个ComboBox控件&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;ipTextBox&#34;&gt;IP地址TextBox&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;portTextBox&#34;&gt;端口号TextBox&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> LoadData(<span style="color:#66d9ef">string</span> jsonFilePath, ComboBox comboBoxL1, ComboBox comboBoxV1, 
</span></span><span style="display:flex;"><span>                         TextBox ipTextBox, TextBox portTextBox)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 检查文件是否存在</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (!File.Exists(jsonFilePath))
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                MessageBox.Show(<span style="color:#e6db74">$&#34;文件不存在: {jsonFilePath}&#34;</span>, <span style="color:#e6db74">&#34;错误&#34;</span>,
</span></span><span style="display:flex;"><span>                                MessageBoxButtons.OK, MessageBoxIcon.Error);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 读取JSON文件内容</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">string</span> jsonContent = File.ReadAllText(jsonFilePath);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 反序列化为对象</span>
</span></span><span style="display:flex;"><span>            ComboBoxData data = JsonConvert.DeserializeObject&lt;ComboBoxData&gt;(jsonContent);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 检查反序列化结果</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (data == <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                MessageBox.Show(<span style="color:#e6db74">&#34;无法解析JSON数据&#34;</span>, <span style="color:#e6db74">&#34;错误&#34;</span>,
</span></span><span style="display:flex;"><span>                                MessageBoxButtons.OK, MessageBoxIcon.Error);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 填充第一个ComboBox</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (data.Level1Items != <span style="color:#66d9ef">null</span> &amp;&amp; data.Level1Items.Count &gt; <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                comboBoxL1.DataSource = data.Level1Items;
</span></span><span style="display:flex;"><span>                comboBoxL1.DisplayMember = <span style="color:#e6db74">&#34;Name&#34;</span>;
</span></span><span style="display:flex;"><span>                comboBoxL1.ValueMember = <span style="color:#e6db74">&#34;ID&#34;</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                MessageBox.Show(<span style="color:#e6db74">&#34;Level1Items数据为空或不存在&#34;</span>, <span style="color:#e6db74">&#34;警告&#34;</span>,
</span></span><span style="display:flex;"><span>                                MessageBoxButtons.OK, MessageBoxIcon.Warning);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 填充第二个ComboBox</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (data.Value1Items != <span style="color:#66d9ef">null</span> &amp;&amp; data.Value1Items.Count &gt; <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                comboBoxV1.DataSource = data.Value1Items;
</span></span><span style="display:flex;"><span>                comboBoxV1.DisplayMember = <span style="color:#e6db74">&#34;Name&#34;</span>;
</span></span><span style="display:flex;"><span>                comboBoxV1.ValueMember = <span style="color:#e6db74">&#34;ID&#34;</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                MessageBox.Show(<span style="color:#e6db74">&#34;Value1Items数据为空或不存在&#34;</span>, <span style="color:#e6db74">&#34;警告&#34;</span>,
</span></span><span style="display:flex;"><span>                                MessageBoxButtons.OK, MessageBoxIcon.Warning);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 填充AppItem到TextBox</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (data.AppItem != <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                ipTextBox.Text = data.AppItem.AIP;
</span></span><span style="display:flex;"><span>                portTextBox.Text = data.AppItem.APort;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                MessageBox.Show(<span style="color:#e6db74">&#34;AppItem数据为空或不存在&#34;</span>, <span style="color:#e6db74">&#34;警告&#34;</span>,
</span></span><span style="display:flex;"><span>                                MessageBoxButtons.OK, MessageBoxIcon.Warning);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">catch</span> (Exception ex)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            MessageBox.Show(<span style="color:#e6db74">$&#34;加载数据时出错: {ex.Message}&#34;</span>, <span style="color:#e6db74">&#34;错误&#34;</span>,
</span></span><span style="display:flex;"><span>                            MessageBoxButtons.OK, MessageBoxIcon.Error);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// 保存TextBox中的IP和Port到JSON文件</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;jsonFilePath&#34;&gt;JSON文件路径&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;ip&#34;&gt;IP地址&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// &lt;param name=&#34;port&#34;&gt;端口号&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> SaveAppSettings(<span style="color:#66d9ef">string</span> jsonFilePath, <span style="color:#66d9ef">string</span> ip, <span style="color:#66d9ef">string</span> port)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (!File.Exists(jsonFilePath))
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                MessageBox.Show(<span style="color:#e6db74">$&#34;文件不存在: {jsonFilePath}&#34;</span>, <span style="color:#e6db74">&#34;错误&#34;</span>,
</span></span><span style="display:flex;"><span>                                MessageBoxButtons.OK, MessageBoxIcon.Error);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 读取现有数据</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">string</span> jsonContent = File.ReadAllText(jsonFilePath);
</span></span><span style="display:flex;"><span>            ComboBoxData data = JsonConvert.DeserializeObject&lt;ComboBoxData&gt;(jsonContent);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (data == <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                MessageBox.Show(<span style="color:#e6db74">&#34;无法解析JSON数据&#34;</span>, <span style="color:#e6db74">&#34;错误&#34;</span>,
</span></span><span style="display:flex;"><span>                                MessageBoxButtons.OK, MessageBoxIcon.Error);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 如果AppItem不存在则创建</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (data.AppItem == <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                data.AppItem = <span style="color:#66d9ef">new</span> AppItem();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 更新IP和Port</span>
</span></span><span style="display:flex;"><span>            data.AppItem.AIP = ip;
</span></span><span style="display:flex;"><span>            data.AppItem.APort = port;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 序列化并保存</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">string</span> updatedJson = JsonConvert.SerializeObject(data, Formatting.Indented);
</span></span><span style="display:flex;"><span>            File.WriteAllText(jsonFilePath, updatedJson);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            MessageBox.Show(<span style="color:#e6db74">&#34;配置已成功保存&#34;</span>, <span style="color:#e6db74">&#34;成功&#34;</span>,
</span></span><span style="display:flex;"><span>                            MessageBoxButtons.OK, MessageBoxIcon.Information);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">catch</span> (Exception ex)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            MessageBox.Show(<span style="color:#e6db74">$&#34;保存数据时出错: {ex.Message}&#34;</span>, <span style="color:#e6db74">&#34;错误&#34;</span>,
</span></span><span style="display:flex;"><span>                            MessageBoxButtons.OK, MessageBoxIcon.Error);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">///...load</span>
</span></span><span style="display:flex;"><span>           <span style="color:#75715e">//_dataLoader.LoadDataToComboBoxes(JsonFilePath, comboBoxL1, comboBoxV1);</span>
</span></span><span style="display:flex;"><span>           _dataLoader.LoadData(JsonFilePath, comboBoxL1, comboBoxV1, textBoxIP1, textBoxPort1, textBoxSB1);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">///save</span>
</span></span><span style="display:flex;"><span> _dataLoader.SaveAppSettings(JsonFilePath, textBoxIP1.Text, textBoxPort1.Text, textBoxSB1.Text);
</span></span><span style="display:flex;"><span> UpdateStatus(<span style="color:#e6db74">&#34;保存成功!&#34;</span>);
</span></span></code></pre></div><h1 id="控制选择">控制选择<a hidden class="anchor" aria-hidden="true" href="#控制选择">#</a></h1>
<p>formload</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>       <span style="color:#75715e">//加载控制选择</span>
</span></span><span style="display:flex;"><span>       List&lt;ComboBoxItem&gt; cbis= <span style="color:#66d9ef">new</span> List&lt;ComboBoxItem&gt;();
</span></span><span style="display:flex;"><span>       cbis.Add(<span style="color:#66d9ef">new</span> ComboBoxItem() { ID = <span style="color:#ae81ff">201</span>, Name = <span style="color:#e6db74">&#34;颜色&#34;</span> });
</span></span><span style="display:flex;"><span>       cbis.Add(<span style="color:#66d9ef">new</span> ComboBoxItem() { ID = <span style="color:#ae81ff">202</span>, Name = <span style="color:#e6db74">&#34;开继电器&#34;</span> });
</span></span><span style="display:flex;"><span>       cbis.Add(<span style="color:#66d9ef">new</span> ComboBoxItem() { ID = <span style="color:#ae81ff">203</span>, Name = <span style="color:#e6db74">&#34;关继电器&#34;</span> });
</span></span><span style="display:flex;"><span>       comboBoxMd1.DataSource = cbis;
</span></span><span style="display:flex;"><span>       comboBoxMd1.DisplayMember = <span style="color:#e6db74">&#34;Name&#34;</span>;
</span></span><span style="display:flex;"><span>       comboBoxMd1.ValueMember = <span style="color:#e6db74">&#34;ID&#34;</span>;
</span></span><span style="display:flex;"><span>       <span style="color:#75715e">//comboBoxMd1.Items.Add(&#34;颜色&#34;);</span>
</span></span><span style="display:flex;"><span>       <span style="color:#75715e">//comboBoxMd1.Items.Add(&#34;继电器&#34;);</span>
</span></span><span style="display:flex;"><span>       comboBoxMd1.SelectedIndex = <span style="color:#ae81ff">0</span>;
</span></span></code></pre></div><h2 id="4位十六进制-2位16进制-0000-00">4位十六进制 2位16进制 0000 00<a hidden class="anchor" aria-hidden="true" href="#4位十六进制-2位16进制-0000-00">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>       <span style="color:#66d9ef">int</span> result = number;
</span></span><span style="display:flex;"><span>       <span style="color:#66d9ef">return</span> result.ToString(<span style="color:#e6db74">&#34;X&#34;</span>); <span style="color:#75715e">// 转为2位十六进制，不足补0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">int</span> result = number;
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">return</span> result.ToString(<span style="color:#e6db74">&#34;X4&#34;</span>); <span style="color:#75715e">// 转为4位十六进制，不足补0</span>
</span></span></code></pre></div><p>&ndash;</p>
<h1 id="调光调色控制器">调光调色&amp;控制器<a hidden class="anchor" aria-hidden="true" href="#调光调色控制器">#</a></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> Form1_Load(<span style="color:#66d9ef">object</span> sender, EventArgs e)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 加载数据到ComboBox</span>
</span></span><span style="display:flex;"><span>            LoadComboBoxData();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//加载控制选择</span>
</span></span><span style="display:flex;"><span>            List&lt;ComboBoxItem&gt; cbis= <span style="color:#66d9ef">new</span> List&lt;ComboBoxItem&gt;();
</span></span><span style="display:flex;"><span>            cbis.Add(<span style="color:#66d9ef">new</span> ComboBoxItem() { ID = <span style="color:#ae81ff">201</span>, Name = <span style="color:#e6db74">&#34;调光调色&#34;</span> });
</span></span><span style="display:flex;"><span>            cbis.Add(<span style="color:#66d9ef">new</span> ComboBoxItem() { ID = <span style="color:#ae81ff">202</span>, Name = <span style="color:#e6db74">&#34;开继电器&#34;</span> });
</span></span><span style="display:flex;"><span>            cbis.Add(<span style="color:#66d9ef">new</span> ComboBoxItem() { ID = <span style="color:#ae81ff">203</span>, Name = <span style="color:#e6db74">&#34;关继电器&#34;</span> });
</span></span><span style="display:flex;"><span>            cbis.Add(<span style="color:#66d9ef">new</span> ComboBoxItem() { ID = <span style="color:#ae81ff">204</span>, Name = <span style="color:#e6db74">&#34;全开关继电器&#34;</span> });
</span></span><span style="display:flex;"><span>          <span style="color:#75715e">//  cbis.Add(new ComboBoxItem() { ID = 203, Name = &#34;关继电器&#34; });</span>
</span></span><span style="display:flex;"><span>            comboBoxMd1.DataSource = cbis;
</span></span><span style="display:flex;"><span>            comboBoxMd1.DisplayMember = <span style="color:#e6db74">&#34;Name&#34;</span>;
</span></span><span style="display:flex;"><span>            comboBoxMd1.ValueMember = <span style="color:#e6db74">&#34;ID&#34;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//comboBoxMd1.Items.Add(&#34;颜色&#34;);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//comboBoxMd1.Items.Add(&#34;继电器&#34;);</span>
</span></span><span style="display:flex;"><span>            comboBoxMd1.SelectedIndex = <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">///...</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">///算法调整</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (skz1 == <span style="color:#e6db74">&#34;204&#34;</span>)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">//开关继电器 全开全关 00340001 </span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">string</span> stemp = strsb1 + <span style="color:#e6db74">&#34;06&#34;</span>;<span style="color:#75715e">//设备 + 写寄存器</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">string</span> s1 = <span style="color:#e6db74">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">string</span> srs1 = <span style="color:#e6db74">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                stemp = stemp + <span style="color:#e6db74">&#34;00340001&#34;</span>;<span style="color:#75715e">//4+4+4</span>
</span></span><span style="display:flex;"><span>                s1 = ColorCHelper.CalculateModbusCRC16(stemp);
</span></span><span style="display:flex;"><span>                srs1 = stemp + s1;
</span></span><span style="display:flex;"><span>                strlist.Add(srs1);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                stemp = strsb1 + <span style="color:#e6db74">&#34;06&#34;</span>;
</span></span><span style="display:flex;"><span>                stemp = stemp + <span style="color:#e6db74">&#34;00340000&#34;</span> ;<span style="color:#75715e">//4+4+4</span>
</span></span><span style="display:flex;"><span>                s1 = ColorCHelper.CalculateModbusCRC16(stemp);
</span></span><span style="display:flex;"><span>                srs1 = stemp + s1;
</span></span><span style="display:flex;"><span>                strlist.Add(srs1);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">//调光调色&amp;开关</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i = <span style="color:#ae81ff">1</span>; i &lt;= nl1; i++)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">//f4</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">string</span> stemp = strsb1 + <span style="color:#e6db74">&#34;06&#34;</span>;<span style="color:#75715e">//设备 + 写寄存器</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">string</span> inti1 = <span style="color:#e6db74">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> (skz1 == <span style="color:#e6db74">&#34;201&#34;</span>)
</span></span><span style="display:flex;"><span>                    {
</span></span><span style="display:flex;"><span>                        inti1 = ColorCHelper.ToCustomHex(i);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (skz1 == <span style="color:#e6db74">&#34;202&#34;</span>)
</span></span><span style="display:flex;"><span>                    {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                        inti1 = ColorCHelper.ToCustomHex0(i - <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (skz1 == <span style="color:#e6db74">&#34;203&#34;</span>)
</span></span><span style="display:flex;"><span>                    {
</span></span><span style="display:flex;"><span>                        inti1 = ColorCHelper.ToCustomHex0(i - <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    stemp = stemp + inti1 + svv1;<span style="color:#75715e">//4+4+4</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">string</span> s1 = ColorCHelper.CalculateModbusCRC16(stemp);
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">string</span> srs1 = stemp + s1;
</span></span><span style="display:flex;"><span>                    strlist.Add(srs1);
</span></span><span style="display:flex;"><span>                    stemp11 += srs1 + <span style="color:#e6db74">&#34;,&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span><span style="color:#75715e">///...</span>
</span></span></code></pre></div><h2 id="连接超时">连接超时<a hidden class="anchor" aria-hidden="true" href="#连接超时">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> Task ConnectWithTimeout(<span style="color:#66d9ef">string</span> ipAddress, <span style="color:#66d9ef">int</span> port)
</span></span><span style="display:flex;"><span>   {
</span></span><span style="display:flex;"><span>        client = <span style="color:#66d9ef">new</span> TcpClient();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>       <span style="color:#75715e">// 创建连接任务</span>
</span></span><span style="display:flex;"><span>       Task connectTask = client.ConnectAsync(ipAddress, port);
</span></span><span style="display:flex;"><span>       <span style="color:#75715e">// 创建10秒延迟任务</span>
</span></span><span style="display:flex;"><span>       Task timeoutTask = Task.Delay(<span style="color:#ae81ff">10000</span>); <span style="color:#75715e">// 10000毫秒 = 10秒</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>       <span style="color:#75715e">// 等待任一任务完成</span>
</span></span><span style="display:flex;"><span>       Task completedTask = <span style="color:#66d9ef">await</span> Task.WhenAny(connectTask, timeoutTask);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>       <span style="color:#66d9ef">if</span> (completedTask == timeoutTask)
</span></span><span style="display:flex;"><span>       {
</span></span><span style="display:flex;"><span>           <span style="color:#75715e">// 超时任务先完成，说明连接超时</span>
</span></span><span style="display:flex;"><span>           <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> TimeoutException(<span style="color:#e6db74">&#34;连接超时，超过10秒未成功连接到服务器&#34;</span>);
</span></span><span style="display:flex;"><span>       }
</span></span><span style="display:flex;"><span>       <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>       {
</span></span><span style="display:flex;"><span>           <span style="color:#75715e">// 连接任务先完成，需要检查是否有异常</span>
</span></span><span style="display:flex;"><span>           <span style="color:#66d9ef">await</span> connectTask; <span style="color:#75715e">// 如果连接出错，这里会抛出异常</span>
</span></span><span style="display:flex;"><span>           Console.WriteLine(<span style="color:#e6db74">&#34;连接成功&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>           <span style="color:#75715e">// 这里可以继续使用client进行后续操作</span>
</span></span><span style="display:flex;"><span>           <span style="color:#75715e">// ...</span>
</span></span><span style="display:flex;"><span>       }
</span></span><span style="display:flex;"><span>   }
</span></span></code></pre></div><h1 id="发送延时-解决批量发送问题">发送延时-解决批量发送问题<a hidden class="anchor" aria-hidden="true" href="#发送延时-解决批量发送问题">#</a></h1>
<h1 id="串口调试工具-sscom-v5131">串口调试工具 SSCOM V5.13.1<a hidden class="anchor" aria-hidden="true" href="#串口调试工具-sscom-v5131">#</a></h1>
<p>选择串口/TCP  RTU 发送串口数据 010600000001480A 测试</p>
<p>tip
调光调色波特率  57600
继电器波特率 默认38400 默认设备ID 01 按复位5秒插拔电源重置</p>
<h2 id="新指令清除旧内容">新指令清除旧内容<a hidden class="anchor" aria-hidden="true" href="#新指令清除旧内容">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 清空旧的内容</span>
</span></span><span style="display:flex;"><span>            panelZ.Controls.Clear();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">int</span> startY = <span style="color:#ae81ff">10</span>;      <span style="color:#75715e">// 起始 Y 坐标</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">int</span> spacing = <span style="color:#ae81ff">30</span>;     <span style="color:#75715e">// 每个 CheckBox 的间距</span>
</span></span><span style="display:flex;"><span>            checkBoxes.Clear(); <span style="color:#75715e">//清除所选</span>
</span></span><span style="display:flex;"><span>            checkBox1.Text = <span style="color:#e6db74">&#34;全选&#34;</span>;<span style="color:#75715e">// 清除cbxall</span>
</span></span></code></pre></div><h1 id="扩展">扩展<a hidden class="anchor" aria-hidden="true" href="#扩展">#</a></h1>
<p>调光全开，如：全部12路设成5V				
01 10 00 0A 00 0C 18 13 88 13 88 13 88 13 88 13 88 13 88 13 88 13 88 13 88 13 88 13 88 13 88 crc crc				
01设备号，10写多个，00 0A从第一路写起(要从第二路写起就要写00 0B),00 0C写12路,18为十进制的24，表示后面要写24个字节的数据，即要写12个13 88，两个字节crc校验码</p>
<h1 id="next">Next<a hidden class="anchor" aria-hidden="true" href="#next">#</a></h1>
<p>参考 crc验证
<a href="http://bbs.rkckth.com/home/crc.html">http://bbs.rkckth.com/home/crc.html</a></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/c%23/">C#</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/posts/soft-copyright/">
    <span class="title">« Prev</span>
    <br>
    <span>Soft Copyright</span>
  </a>
  <a class="next" href="http://localhost:1313/posts/rxsg2/">
    <span class="title">Next »</span>
    <br>
    <span>RXSG2</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share TCP Calibration on x"
            href="https://x.com/intent/tweet/?text=TCP%20Calibration&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2ftcp-calibration%2f&amp;hashtags=C%23">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share TCP Calibration on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2ftcp-calibration%2f&amp;title=TCP%20Calibration&amp;summary=TCP%20Calibration&amp;source=http%3a%2f%2flocalhost%3a1313%2fposts%2ftcp-calibration%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share TCP Calibration on reddit"
            href="https://reddit.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fposts%2ftcp-calibration%2f&title=TCP%20Calibration">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share TCP Calibration on facebook"
            href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2fposts%2ftcp-calibration%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share TCP Calibration on whatsapp"
            href="https://api.whatsapp.com/send?text=TCP%20Calibration%20-%20http%3a%2f%2flocalhost%3a1313%2fposts%2ftcp-calibration%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share TCP Calibration on telegram"
            href="https://telegram.me/share/url?text=TCP%20Calibration&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2ftcp-calibration%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share TCP Calibration on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=TCP%20Calibration&u=http%3a%2f%2flocalhost%3a1313%2fposts%2ftcp-calibration%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">

    <div class="wtime">
        <div class="wtime2">CST<span id="beijingTime"></span> GMT <span id="londonTime"></span> EST <span id="newYorkTime"></span>  PST<span id="losAngelesTime"></span></div>
        <div class="wtime2" style="display: none;"> 东京<span id="tokyoTime"></span></div>
        <div class="wtime2" style="display: none;">欧洲-巴黎<span id="parisTime"></span></div>

        <div  class="wtime2" style="display: none;">UTC<span id="utcTime"></span></div>
    </div>
        <span>&copy; 2025 <a href="http://localhost:1313/">MLOG</a></span> · 


    <span>
 
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>



<script type="text/javascript">

    
    const timeZoneOffsets = {
            'beijing': 8,  
            'tokyo': 9,  
            'paris': [1, 2],  
            'london': [0, 1],  
            'newYork': [-5, -4],  
            'losAngeles': [-8, -7]  
        };

        function padZero(num) {
            return num < 10? '0' + num : num;
        }

        function formatTime(date) {
            const year = date.getFullYear();
            const month = padZero(date.getMonth() + 1);
            const day = padZero(date.getDate());
            const hours = padZero(date.getHours());
            const minutes = padZero(date.getMinutes());
            const seconds = padZero(date.getSeconds());
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }

        function isDaylightSavingTime(date, zone) {
            const month = date.getMonth();
            const dstStart = new Date(date.getFullYear(), 3, 8, 2, 0, 0);  
            const dstEnd = new Date(date.getFullYear(), 10, 1, 2, 0, 0);  
            if (zone === 'paris' || zone === 'london' || zone === 'newYork' || zone === 'losAngeles') {
                return date >= dstStart && date < dstEnd;
            }
            return false;
        }

        function updateTime() {
            const now = new Date();
            const utcDate = new Date(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), now.getUTCHours(),
                now.getUTCMinutes(), now.getUTCSeconds());
            const utcTime = formatTime(utcDate);
            document.getElementById('utcTime').innerHTML = utcTime;

            for (const zone in timeZoneOffsets) {
                const offsets = timeZoneOffsets[zone];
                let offset;
                if (Array.isArray(offsets)) {
                    offset = isDaylightSavingTime(utcDate, zone)? offsets[1] : offsets[0];
                } else {
                    offset = offsets;
                }
                const zoneDate = new Date(utcDate.getTime() + offset * 60 * 60 * 1000);
                document.getElementById(zone + 'Time').innerHTML = formatTime(zoneDate);
            }

            setTimeout(updateTime, 1000);
        }

        window.onload = function () {
            updateTime();
        };
    function notfound(imgElement) {  
            var src = imgElement.src;  
            var parts = src.split('/'); 
            var filename = parts[parts.length - 1]; 
            
      
            imgElement.src = "https://47.115.223.75:8080/group1/v2/" + filename+"?timestamp=" + Date.now();
    
            imgElement.onerror = null; 
        }  

    </script>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
