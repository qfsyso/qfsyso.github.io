<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>jwt redis | MLOG</title>
<meta name=keywords content="Jwt,Token,Redis"><meta name=description content="Redis JWT 在 .NET 中使用 Redis 来存储 JWT（JSON Web Token）可以通过多种方式实现， 例如在用户登录时将生成的 JWT 存储在 Redis 中以便于后续验证和管理。
实现步骤
引入依赖 确保你的项目引入了以下必要的 NuGet 包：
Microsoft.AspNetCore.Authentication.JwtBearer：用于 JWT 身份验证。 StackExchange.Redis：用于与 Redis 通信。
dotnet add package Microsoft.AspNetCore.Authentication.JwtBearer dotnet add package StackExchange.Redis 配置 Redis 客户端 设置 Redis 的连接和操作。
生成 JWT 根据用户信息生成 JWT 并将其存储到 Redis。
验证 JWT 在验证阶段从 Redis 检查 token 是否有效。
实现 Token 的失效机制 利用 Redis 的 TTL（过期时间）特性来管理 token 的生命周期。
代码实现 1. 配置 Redis 客户端 在 Program.cs 或 Startup."><meta name=author content="dwd"><link rel=canonical href=https://qfsyso.github.io/posts/jwt-redis/><link crossorigin=anonymous href=/assets/css/stylesheet.f49d66caae9ea0fd43f21f29e71a8d3e284517ed770f2aa86fa012953ad3c9ef.css integrity="sha256-9J1myq6eoP1D8h8p5xqNPihFF+13Dyqob6ASlTrTye8=" rel="preload stylesheet" as=style><link rel=icon href=https://qfsyso.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://qfsyso.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://qfsyso.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://qfsyso.github.io/apple-touch-icon.png><link rel=mask-icon href=https://qfsyso.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://qfsyso.github.io/posts/jwt-redis/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://qfsyso.github.io/posts/jwt-redis/"><meta property="og:site_name" content="MLOG"><meta property="og:title" content="jwt redis"><meta property="og:description" content="Redis JWT 在 .NET 中使用 Redis 来存储 JWT（JSON Web Token）可以通过多种方式实现， 例如在用户登录时将生成的 JWT 存储在 Redis 中以便于后续验证和管理。
实现步骤
引入依赖 确保你的项目引入了以下必要的 NuGet 包：
Microsoft.AspNetCore.Authentication.JwtBearer：用于 JWT 身份验证。 StackExchange.Redis：用于与 Redis 通信。
dotnet add package Microsoft.AspNetCore.Authentication.JwtBearer dotnet add package StackExchange.Redis 配置 Redis 客户端 设置 Redis 的连接和操作。
生成 JWT 根据用户信息生成 JWT 并将其存储到 Redis。
验证 JWT 在验证阶段从 Redis 检查 token 是否有效。
实现 Token 的失效机制 利用 Redis 的 TTL（过期时间）特性来管理 token 的生命周期。
代码实现 1. 配置 Redis 客户端 在 Program.cs 或 Startup."><meta property="og:locale" content="zh-CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-12-03T01:20:03+00:00"><meta property="article:modified_time" content="2024-12-03T01:20:03+00:00"><meta property="article:tag" content="JWT"><meta property="article:tag" content="Token"><meta property="article:tag" content="Redis"><meta name=twitter:card content="summary"><meta name=twitter:title content="jwt redis"><meta name=twitter:description content="Redis JWT 在 .NET 中使用 Redis 来存储 JWT（JSON Web Token）可以通过多种方式实现， 例如在用户登录时将生成的 JWT 存储在 Redis 中以便于后续验证和管理。
实现步骤
引入依赖 确保你的项目引入了以下必要的 NuGet 包：
Microsoft.AspNetCore.Authentication.JwtBearer：用于 JWT 身份验证。 StackExchange.Redis：用于与 Redis 通信。
dotnet add package Microsoft.AspNetCore.Authentication.JwtBearer dotnet add package StackExchange.Redis 配置 Redis 客户端 设置 Redis 的连接和操作。
生成 JWT 根据用户信息生成 JWT 并将其存储到 Redis。
验证 JWT 在验证阶段从 Redis 检查 token 是否有效。
实现 Token 的失效机制 利用 Redis 的 TTL（过期时间）特性来管理 token 的生命周期。
代码实现 1. 配置 Redis 客户端 在 Program.cs 或 Startup."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://qfsyso.github.io/posts/"},{"@type":"ListItem","position":2,"name":"jwt redis","item":"https://qfsyso.github.io/posts/jwt-redis/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"jwt redis","name":"jwt redis","description":"Redis JWT 在 .NET 中使用 Redis 来存储 JWT（JSON Web Token）可以通过多种方式实现， 例如在用户登录时将生成的 JWT 存储在 Redis 中以便于后续验证和管理。\n实现步骤\n引入依赖 确保你的项目引入了以下必要的 NuGet 包：\nMicrosoft.AspNetCore.Authentication.JwtBearer：用于 JWT 身份验证。 StackExchange.Redis：用于与 Redis 通信。\ndotnet add package Microsoft.AspNetCore.Authentication.JwtBearer dotnet add package StackExchange.Redis 配置 Redis 客户端 设置 Redis 的连接和操作。\n生成 JWT 根据用户信息生成 JWT 并将其存储到 Redis。\n验证 JWT 在验证阶段从 Redis 检查 token 是否有效。\n实现 Token 的失效机制 利用 Redis 的 TTL（过期时间）特性来管理 token 的生命周期。\n代码实现 1. 配置 Redis 客户端 在 Program.cs 或 Startup.","keywords":["Jwt","Token","Redis"],"articleBody":"Redis JWT 在 .NET 中使用 Redis 来存储 JWT（JSON Web Token）可以通过多种方式实现， 例如在用户登录时将生成的 JWT 存储在 Redis 中以便于后续验证和管理。\n实现步骤\n引入依赖 确保你的项目引入了以下必要的 NuGet 包：\nMicrosoft.AspNetCore.Authentication.JwtBearer：用于 JWT 身份验证。 StackExchange.Redis：用于与 Redis 通信。\ndotnet add package Microsoft.AspNetCore.Authentication.JwtBearer dotnet add package StackExchange.Redis 配置 Redis 客户端 设置 Redis 的连接和操作。\n生成 JWT 根据用户信息生成 JWT 并将其存储到 Redis。\n验证 JWT 在验证阶段从 Redis 检查 token 是否有效。\n实现 Token 的失效机制 利用 Redis 的 TTL（过期时间）特性来管理 token 的生命周期。\n代码实现 1. 配置 Redis 客户端 在 Program.cs 或 Startup.cs 中配置 Redis 和 JWT 身份验证：\nusing Microsoft.AspNetCore.Authentication.JwtBearer; using Microsoft.Extensions.DependencyInjection; using Microsoft.IdentityModel.Tokens; using StackExchange.Redis; using System.Text; var builder = WebApplication.CreateBuilder(args); // Redis 配置 builder.Services.AddSingleton(sp =\u003e ConnectionMultiplexer.Connect(\"localhost:6379\")); // 替换为你的 Redis 地址 // JWT 配置 var key = \"YourSecretKeyForJwt\"; // 替换为你的密钥 builder.Services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme) .AddJwtBearer(options =\u003e { options.TokenValidationParameters = new TokenValidationParameters { ValidateIssuerSigningKey = true, IssuerSigningKey = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(key)), ValidateIssuer = false, ValidateAudience = false }; }); builder.Services.AddAuthorization(); var app = builder.Build(); app.UseAuthentication(); app.UseAuthorization(); app.MapControllers(); app.Run(); 2. 生成和存储 JWT 在 Controller 中生成 JWT 并将其存储到 Redis。\nusing Microsoft.AspNetCore.Mvc; using Microsoft.IdentityModel.Tokens; using StackExchange.Redis; using System.IdentityModel.Tokens.Jwt; using System.Security.Claims; using System.Text; [ApiController] [Route(\"api/[controller]\")] public class AuthController : ControllerBase { private readonly IConnectionMultiplexer _redis; private readonly string _jwtKey = \"YourSecretKeyForJwt\"; // 替换为你的密钥 public AuthController(IConnectionMultiplexer redis) { _redis = redis; } [HttpPost(\"login\")] public IActionResult Login(string username) { // 创建 JWT token var claims = new[] { new Claim(ClaimTypes.Name, username) }; var key = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(_jwtKey)); var creds = new SigningCredentials(key, SecurityAlgorithms.HmacSha256); var token = new JwtSecurityToken( claims: claims, expires: DateTime.UtcNow.AddHours(1), signingCredentials: creds); var jwt = new JwtSecurityTokenHandler().WriteToken(token); // 将 token 存储到 Redis var db = _redis.GetDatabase(); db.StringSet($\"jwt:{username}\", jwt, TimeSpan.FromHours(1)); return Ok(new { token = jwt }); } } 3. 验证 JWT 在中间件或验证逻辑中从 Redis 检查 JWT 是否有效。\n[HttpGet(\"validate\")] public IActionResult ValidateToken() { var authHeader = Request.Headers[\"Authorization\"].ToString(); if (string.IsNullOrEmpty(authHeader) || !authHeader.StartsWith(\"Bearer \")) return Unauthorized(); var token = authHeader.Replace(\"Bearer \", \"\"); var username = User.Identity?.Name; var db = _redis.GetDatabase(); var storedToken = db.StringGet($\"jwt:{username}\"); if (storedToken.IsNullOrEmpty || storedToken != token) return Unauthorized(); return Ok(\"Token is valid\"); } 4. Token 失效机制 利用 Redis 的 TTL 设置 token 的自动过期：\n在存储 token 时设置过期时间。 用户注销时可以手动删除 Redis 中的 token。 注销示例：\n[HttpPost(\"logout\")] public IActionResult Logout() { var username = User.Identity?.Name; var db = _redis.GetDatabase(); db.KeyDelete($\"jwt:{username}\"); return Ok(\"Logged out\"); } 总结 通过 Redis 存储 JWT，可以实现以下功能：\n集中管理 JWT：便于实时撤销或查询。 自动过期：Redis 自带 TTL，可以简化 token 的管理。 扩展性好：适用于分布式系统。 根据实际需求，还可以扩展功能，例如黑名单机制或支持多设备登录等。\ndebian redis setup 1: 更新软件包列表 首先，确保的软件包列表是最新的。打开终端并执行以下命令：\nsudo apt update 2: 安装Redis 更新完软件包列表后，可以通过apt包管理器来安装Redis服务器：\nsudo apt install redis-server 这将安装Redis及其依赖项，并自动启动Redis服务。\n3: 检查Redis状态 安装完成后，可以检查Redis服务是否正在运行：\nsudo systemctl status redis-server 如果服务正在运行，会看到类似“active (running)”的状态信息。\n4: 配置Redis Redis的配置文件位于/etc/redis/redis.conf。可能想要编辑这个文件来更改默认设置，例如绑定地址、端口号、要求密码等。使用文本编辑器打开它：\nsudo nano /etc/redis/redis.conf 做出必要的更改后保存文件并退出编辑器。\n5: 重启Redis服务 如果对配置文件做了任何修改，记得重启Redis服务以使更改生效：\nsudo systemctl restart redis-server 6: 设置Redis开机自启 为了确保Redis在系统启动时自动启动，可以使用以下命令启用开机自启：\nsudo systemctl enable redis-server 7: 测试Redis安装 可以通过连接到本地Redis服务器来测试安装是否成功。使用redis-cli命令行工具连接到Redis：\nredis-cli 一旦进入Redis CLI，可以尝试运行ping命令，如果Redis服务器响应PONG，则说明安装和配置都正常工作。\n127.0.0.1:6379\u003e ping PONG Redis 配置文件 编辑 Redis 的配置文件（通常是 /etc/redis/redis.conf）。\n确保允许远程连接：\nbind 0.0.0.0 （默认仅允许本地连接，127.0.0.1）。 确保未设置 protected-mode 为 yes，或者明确配置授权规则：\nprotected-mode no 重启 Redis 服务以应用更改：\nsudo systemctl restart redis err 500 Undocumented Error: Internal Server Error Response body System.InvalidOperationException: Multiple constructors accepting all given argument types have been found in type ‘userApiController’. There should only be one applicable constructor. at Microsoft.Extensions.DependencyInjection.ActivatorUtilities.TryFindMatchingConstructor(Type instanceType, Type[] argumentTypes, ConstructorInfo\u0026 matchingConstructor, Nullable1[]\u0026 parameterMap) at Microsoft.Extensions.DependencyInjection.ActivatorUtilities.FindApplicableConstructor(Type instanceType, Type[] argumentTypes, ConstructorInfo\u0026 matchingConstructor, Nullable1[]\u0026 matchingParameterMap) at Microsoft.Extensions.DependencyInjection.ActivatorUtilities.CreateFactoryInternal(Type instanceType, Type[] argumentTypes, ParameterExpression\u0026 provider, ParameterExpression\u0026 argumentArray, Expression\u0026 factoryExpressionBody)\n问题是由于依赖注入系统在实例化 userApiController 时发现有多个构造函数可以匹配传递的参数，因此无法确定使用哪个构造函数。这种情况会导致 System.InvalidOperationException 异常。多个改成一个。\nSystem.InvalidOperationException: 、 Unable to resolve service for type ‘JwtHelper’ while attempting to activate ‘userApiController’. at Microsoft.Extensions.DependencyInjection.ActivatorUtilities.ThrowHelperUnableToResolveService(Type type, Type requiredBy) at lambda_method69(Closure, IServiceProvider, Object[])\n这个错误表明 wtHelper 类型未在依赖注入 (DI) 容器中注册，而 IM.Controllers.userApiController 需要它作为依赖。DI 系统在尝试解析 JwtHelper 时失败，导致 Internal Server Error。\n检查依赖注册 确保在 Program.cs 或 Startup.cs 文件中注册了 JwtHelper 服务。如果 JwtHelper 是一个自定义工具类或服务，你需要将它添加到 DI 容器中。\nbuilder.Services.AddScoped(); 如果 JwtHelper 需要构造函数注入的依赖项，也要确保这些依赖已注册。 如果 JwtHelper 是无状态的，考虑使用 AddSingleton。\nStackExchange.Redis.RedisConnectionException: “It was not possible to connect to the redis server(s). Error connecting right now. To allow this multiplexer to continue retrying until it’s able to connect, use abortConnect=false in your connection string or AbortOnConnectFail=false; in your code.”\n检查 Redis 的配置文件（通常是 /etc/redis/redis.conf）。 确保允许远程连接： bind 0.0.0.0 .Connect(“XXXX:6379,abortConnect=false”));\n重启redis\nRedis 保护模式 Redis 处于保护模式，默认情况下禁止外部连接。\n解决方法： 修改 redis.conf 中的 protected-mode 设置：\nprotected-mode no 重启 Redis：\nsudo systemctl restart redis 程序测试redis .NET\n// Redis 服务器地址和端口 string redisConnectionString = \"199.24x.x.x:6379\"; // 默认 Redis 端口是 6379 // 创建连接到 Redis 的实例 ConnectionMultiplexer redis = null; try { redis = ConnectionMultiplexer.Connect(redisConnectionString); Console.WriteLine(\"连接成功!\"); } catch (Exception ex) { Console.WriteLine($\"连接到 Redis 失败: {ex.Message}\"); return; } // 获取 Redis 数据库实例 IDatabase db = redis.GetDatabase(); // 写入数据 string key = \"myKey22\"; string value = \"Hello, Redis!\"; db.StringSet(key, value); Console.WriteLine($\"已写入: {key} - {value}\"); // 读取数据 string retrievedValue = db.StringGet(key); Console.WriteLine($\"读取到: {key} - {retrievedValue}\"); // 删除数据 db.KeyDelete(key); Console.WriteLine($\"已删除: {key}\"); // 关闭连接 redis.Close(); Console.WriteLine(\"连接关闭\"); node\nnpm i redis const redis = require('redis'); // 创建Redis客户端连接 const client = redis.createClient({ host: '199.24x.x.x', port: 6379 }); // 监听连接事件，当成功连接到Redis时执行回调函数 client.on('connect', () =\u003e { console.log('成功连接到Redis服务器'); }); // 监听错误事件，当出现错误时执行回调函数 client.on('error', (err) =\u003e { console.log('连接Redis服务器时出现错误：', err); }); // 设置一个键值对 client.set('myKey', 'myValue', (err, reply) =\u003e { if (err) { console.log('设置键值对时出现错误：', err); } else { console.log('设置键值对成功，回复：', reply); } }); // 获取键值对 client.get('myKey', (err, value) =\u003e { if (err) { console.log('获取键值对时出现错误：', err); } else { console.log('获取到的键值对的值为：', value); } }); // 删除键值对 client.del('myKey', (err, reply) =\u003e { if (err) { console.log('删除键值对时出现错误：', err); } else { console.log('删除键值对成功，回复：', reply); } }); // 关闭Redis客户端连接 client.quit(); return; redis设置密码 1. 编辑 Redis 配置文件 Redis 的配置文件通常位于 /etc/redis/redis.conf 或 /etc/redis.conf。用你喜欢的文本编辑器打开它，例如：\nsudo nano /etc/redis/redis.conf 2. 找到并修改 requirepass 参数 在配置文件中找到以下行（可能被注释掉）：\n# requirepass foobared 将其取消注释并替换为你的密码，例如：\nrequirepass your_secure_password 3. 重启 Redis 服务 保存并退出文件后，重启 Redis 服务以应用更改：\nsudo systemctl restart redis 4. 测试密码功能 你可以通过以下命令测试 Redis 是否需要密码：\n使用 redis-cli 连接 尝试未输入密码的命令：\nredis-cli \u003e get key 如果设置了密码，Redis 会返回类似如下的错误：\n(error) NOAUTH Authentication required. 使用 AUTH 命令验证：\nredis-cli \u003e auth your_secure_password OK \u003e get key 如果密码正确，后续操作将生效。\n5. 链接修改 199.x.x.xxx:6379,password=123X.zx 更改redis链接\nredis缓存json RedisHelper 方法添加 Redis 缓存，可以通过以下方式扩展代码：\n实现思路 定义 Redis 缓存逻辑：\n先尝试从 Redis 缓存中读取数据。 如果缓存命中，则直接返回数据。 如果缓存未命中，则查询数据库，处理数据后存入 Redis，并设置适当的过期时间。 定义 Redis 键：\n使用一个唯一键，例如 CityInfoList:{id}，确保缓存区分不同 id 的数据。 序列化和反序列化：\n使用 JSON 格式存储数据，方便跨语言和跨系统的兼容性。 扩展后的代码 以下是添加 Redis 缓存后的完整实现：\npublic List FindIMCityInfoListByPIDS(string id) { // 定义 Redis 缓存键 string redisKey = $\"IMCityInfoList:{id}\"; // 尝试从 Redis 获取数据 string cachedData = RedisHelper.GetString(redisKey); // RedisHelper 是 Redis 操作工具类 if (!string.IsNullOrEmpty(cachedData)) { // 如果缓存命中，反序列化并返回数据 return JsonConvert.DeserializeObject","wordCount":"1083","inLanguage":"en","datePublished":"2024-12-03T01:20:03Z","dateModified":"2024-12-03T01:20:03Z","author":{"@type":"Person","name":"dwd"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://qfsyso.github.io/posts/jwt-redis/"},"publisher":{"@type":"Organization","name":"MLOG","logo":{"@type":"ImageObject","url":"https://qfsyso.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://qfsyso.github.io/ accesskey=h title="MLOG (Alt + H)">MLOG</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://qfsyso.github.io/posts/ title=Archive><span>Archive</span></a></li><li><a href=https://qfsyso.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://qfsyso.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">jwt redis</h1><div class=post-meta><span title='2024-12-03 01:20:03 +0000 UTC'>December 3, 2024</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;dwd</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#redis-jwt aria-label="Redis JWT">Redis JWT</a></li><li><a href=#%e5%bc%95%e5%85%a5%e4%be%9d%e8%b5%96 aria-label=引入依赖>引入依赖</a></li><li><a href=#%e9%85%8d%e7%bd%ae-redis-%e5%ae%a2%e6%88%b7%e7%ab%af aria-label="配置 Redis 客户端">配置 Redis 客户端</a></li><li><a href=#%e7%94%9f%e6%88%90-jwt aria-label="生成 JWT">生成 JWT</a></li><li><a href=#%e9%aa%8c%e8%af%81-jwt aria-label="验证 JWT">验证 JWT</a></li><li><a href=#%e5%ae%9e%e7%8e%b0-token-%e7%9a%84%e5%a4%b1%e6%95%88%e6%9c%ba%e5%88%b6 aria-label="实现 Token 的失效机制">实现 Token 的失效机制</a></li><li><a href=#%e4%bb%a3%e7%a0%81%e5%ae%9e%e7%8e%b0 aria-label=代码实现>代码实现</a><ul><li><a href=#1-%e9%85%8d%e7%bd%ae-redis-%e5%ae%a2%e6%88%b7%e7%ab%af aria-label="1. 配置 Redis 客户端">1. 配置 Redis 客户端</a></li><li><a href=#2-%e7%94%9f%e6%88%90%e5%92%8c%e5%ad%98%e5%82%a8-jwt aria-label="2. 生成和存储 JWT">2. 生成和存储 JWT</a></li><li><a href=#3-%e9%aa%8c%e8%af%81-jwt aria-label="3. 验证 JWT">3. 验证 JWT</a></li><li><a href=#4-token-%e5%a4%b1%e6%95%88%e6%9c%ba%e5%88%b6 aria-label="4. Token 失效机制">4. Token 失效机制</a></li></ul></li><li><a href=#%e6%80%bb%e7%bb%93 aria-label=总结>总结</a></li><li><a href=#debian-redis-setup aria-label="debian redis setup">debian redis setup</a></li><li><a href=#1-%e6%9b%b4%e6%96%b0%e8%bd%af%e4%bb%b6%e5%8c%85%e5%88%97%e8%a1%a8 aria-label="1: 更新软件包列表">1: 更新软件包列表</a></li><li><a href=#2-%e5%ae%89%e8%a3%85redis aria-label="2: 安装Redis">2: 安装Redis</a></li><li><a href=#3-%e6%a3%80%e6%9f%a5redis%e7%8a%b6%e6%80%81 aria-label="3: 检查Redis状态">3: 检查Redis状态</a></li><li><a href=#4-%e9%85%8d%e7%bd%aeredis aria-label="4: 配置Redis">4: 配置Redis</a></li><li><a href=#5-%e9%87%8d%e5%90%afredis%e6%9c%8d%e5%8a%a1 aria-label="5: 重启Redis服务">5: 重启Redis服务</a></li><li><a href=#6-%e8%ae%be%e7%bd%aeredis%e5%bc%80%e6%9c%ba%e8%87%aa%e5%90%af aria-label="6: 设置Redis开机自启">6: 设置Redis开机自启</a></li><li><a href=#7-%e6%b5%8b%e8%af%95redis%e5%ae%89%e8%a3%85 aria-label="7: 测试Redis安装">7: 测试Redis安装</a><ul><li><a href=#redis-%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6 aria-label="Redis 配置文件">Redis 配置文件</a></li></ul></li><li><a href=#err aria-label=err>err</a><ul><li><a href=#500-undocumented aria-label="500 Undocumented">500 Undocumented</a></li><li><a href=#systeminvalidoperationexception- aria-label="System.InvalidOperationException: 、">System.InvalidOperationException: 、</a></li><li><a href=#stackexchangeredisredisconnectionexception aria-label=StackExchange.Redis.RedisConnectionException:>StackExchange.Redis.RedisConnectionException:</a></li></ul></li><li><a href=#redis-%e4%bf%9d%e6%8a%a4%e6%a8%a1%e5%bc%8f aria-label="Redis 保护模式">Redis 保护模式</a><ul><li><a href=#%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95 aria-label=解决方法：>解决方法：</a></li></ul></li><li><a href=#%e7%a8%8b%e5%ba%8f%e6%b5%8b%e8%af%95redis aria-label=程序测试redis>程序测试redis</a></li><li><a href=#redis%e8%ae%be%e7%bd%ae%e5%af%86%e7%a0%81 aria-label=redis设置密码>redis设置密码</a><ul><li><a href=#1-%e7%bc%96%e8%be%91-redis-%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6 aria-label="1. 编辑 Redis 配置文件">1. 编辑 Redis 配置文件</a></li><li><a href=#2-%e6%89%be%e5%88%b0%e5%b9%b6%e4%bf%ae%e6%94%b9-requirepass-%e5%8f%82%e6%95%b0 aria-label="2. 找到并修改 requirepass 参数">2. 找到并修改 requirepass 参数</a></li><li><a href=#3-%e9%87%8d%e5%90%af-redis-%e6%9c%8d%e5%8a%a1 aria-label="3. 重启 Redis 服务">3. 重启 Redis 服务</a></li><li><a href=#4-%e6%b5%8b%e8%af%95%e5%af%86%e7%a0%81%e5%8a%9f%e8%83%bd aria-label="4. 测试密码功能">4. 测试密码功能</a></li><li><a href=#5-%e9%93%be%e6%8e%a5%e4%bf%ae%e6%94%b9 aria-label="5. 链接修改">5. 链接修改</a></li></ul></li><li><a href=#redis%e7%bc%93%e5%ad%98json-redishelper aria-label="redis缓存json RedisHelper">redis缓存json RedisHelper</a><ul><li><a href=#%e5%ae%9e%e7%8e%b0%e6%80%9d%e8%b7%af aria-label=实现思路>实现思路</a></li><li><a href=#redishelper-%e5%b7%a5%e5%85%b7%e7%b1%bb aria-label="RedisHelper 工具类">RedisHelper 工具类</a></li><li><a href=#%e4%bd%bf%e7%94%a8%e6%b3%a8%e6%84%8f%e4%ba%8b%e9%a1%b9 aria-label=使用注意事项>使用注意事项</a></li></ul></li></ul></div></details></div><div class=post-content><h1 id=redis-jwt>Redis JWT<a hidden class=anchor aria-hidden=true href=#redis-jwt>#</a></h1><p>在 .NET 中使用 Redis 来存储 JWT（JSON Web Token）可以通过多种方式实现，
例如在用户登录时将生成的 JWT 存储在 Redis 中以便于后续验证和管理。</p><p>实现步骤</p><h1 id=引入依赖>引入依赖<a hidden class=anchor aria-hidden=true href=#引入依赖>#</a></h1><p>确保你的项目引入了以下必要的 NuGet 包：</p><p>Microsoft.AspNetCore.Authentication.JwtBearer：用于 JWT 身份验证。
StackExchange.Redis：用于与 Redis 通信。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>dotnet add package Microsoft.AspNetCore.Authentication.JwtBearer
</span></span><span style=display:flex><span>dotnet add package StackExchange.Redis
</span></span></code></pre></div><h1 id=配置-redis-客户端>配置 Redis 客户端<a hidden class=anchor aria-hidden=true href=#配置-redis-客户端>#</a></h1><p>设置 Redis 的连接和操作。</p><h1 id=生成-jwt>生成 JWT<a hidden class=anchor aria-hidden=true href=#生成-jwt>#</a></h1><p>根据用户信息生成 JWT 并将其存储到 Redis。</p><h1 id=验证-jwt>验证 JWT<a hidden class=anchor aria-hidden=true href=#验证-jwt>#</a></h1><p>在验证阶段从 Redis 检查 token 是否有效。</p><h1 id=实现-token-的失效机制>实现 Token 的失效机制<a hidden class=anchor aria-hidden=true href=#实现-token-的失效机制>#</a></h1><p>利用 Redis 的 TTL（过期时间）特性来管理 token 的生命周期。</p><h1 id=代码实现>代码实现<a hidden class=anchor aria-hidden=true href=#代码实现>#</a></h1><h2 id=1-配置-redis-客户端>1. 配置 Redis 客户端<a hidden class=anchor aria-hidden=true href=#1-配置-redis-客户端>#</a></h2><p>在 Program.cs 或 Startup.cs 中配置 Redis 和 JWT 身份验证：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>using</span> Microsoft.AspNetCore.Authentication.JwtBearer;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> Microsoft.Extensions.DependencyInjection;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> Microsoft.IdentityModel.Tokens;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> StackExchange.Redis;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> System.Text;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> builder = WebApplication.CreateBuilder(args);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Redis 配置</span>
</span></span><span style=display:flex><span>builder.Services.AddSingleton&lt;IConnectionMultiplexer&gt;(sp =&gt;
</span></span><span style=display:flex><span>    ConnectionMultiplexer.Connect(<span style=color:#e6db74>&#34;localhost:6379&#34;</span>)); <span style=color:#75715e>// 替换为你的 Redis 地址</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// JWT 配置</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> key = <span style=color:#e6db74>&#34;YourSecretKeyForJwt&#34;</span>; <span style=color:#75715e>// 替换为你的密钥</span>
</span></span><span style=display:flex><span>builder.Services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
</span></span><span style=display:flex><span>    .AddJwtBearer(options =&gt;
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        options.TokenValidationParameters = <span style=color:#66d9ef>new</span> TokenValidationParameters
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            ValidateIssuerSigningKey = <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>            IssuerSigningKey = <span style=color:#66d9ef>new</span> SymmetricSecurityKey(Encoding.UTF8.GetBytes(key)),
</span></span><span style=display:flex><span>            ValidateIssuer = <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>            ValidateAudience = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>builder.Services.AddAuthorization();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> app = builder.Build();
</span></span><span style=display:flex><span>app.UseAuthentication();
</span></span><span style=display:flex><span>app.UseAuthorization();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app.MapControllers();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app.Run();
</span></span></code></pre></div><h2 id=2-生成和存储-jwt>2. 生成和存储 JWT<a hidden class=anchor aria-hidden=true href=#2-生成和存储-jwt>#</a></h2><p>在 Controller 中生成 JWT 并将其存储到 Redis。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>using</span> Microsoft.AspNetCore.Mvc;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> Microsoft.IdentityModel.Tokens;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> StackExchange.Redis;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> System.IdentityModel.Tokens.Jwt;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> System.Security.Claims;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> System.Text;
</span></span><span style=display:flex><span><span style=color:#a6e22e>
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>[ApiController]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>[Route(&#34;api/[controller]</span><span style=color:#e6db74>&#34;)]
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AuthController</span> : ControllerBase
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> IConnectionMultiplexer _redis;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> <span style=color:#66d9ef>string</span> _jwtKey = <span style=color:#e6db74>&#34;YourSecretKeyForJwt&#34;</span>; <span style=color:#75715e>// 替换为你的密钥</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> AuthController(IConnectionMultiplexer redis)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        _redis = redis;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span><span style=color:#a6e22e>
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>    [HttpPost(&#34;login&#34;)]</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> IActionResult Login(<span style=color:#66d9ef>string</span> username)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 创建 JWT token</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> claims = <span style=color:#66d9ef>new</span>[]
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>new</span> Claim(ClaimTypes.Name, username)
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> key = <span style=color:#66d9ef>new</span> SymmetricSecurityKey(Encoding.UTF8.GetBytes(_jwtKey));
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> creds = <span style=color:#66d9ef>new</span> SigningCredentials(key, SecurityAlgorithms.HmacSha256);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> token = <span style=color:#66d9ef>new</span> JwtSecurityToken(
</span></span><span style=display:flex><span>            claims: claims,
</span></span><span style=display:flex><span>            expires: DateTime.UtcNow.AddHours(<span style=color:#ae81ff>1</span>),
</span></span><span style=display:flex><span>            signingCredentials: creds);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> jwt = <span style=color:#66d9ef>new</span> JwtSecurityTokenHandler().WriteToken(token);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 将 token 存储到 Redis</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> db = _redis.GetDatabase();
</span></span><span style=display:flex><span>        db.StringSet(<span style=color:#e6db74>$&#34;jwt:{username}&#34;</span>, jwt, TimeSpan.FromHours(<span style=color:#ae81ff>1</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Ok(<span style=color:#66d9ef>new</span> { token = jwt });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=3-验证-jwt>3. 验证 JWT<a hidden class=anchor aria-hidden=true href=#3-验证-jwt>#</a></h2><p>在中间件或验证逻辑中从 Redis 检查 JWT 是否有效。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#a6e22e>[HttpGet(&#34;validate&#34;)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> IActionResult ValidateToken()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> authHeader = Request.Headers[<span style=color:#e6db74>&#34;Authorization&#34;</span>].ToString();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>string</span>.IsNullOrEmpty(authHeader) || !authHeader.StartsWith(<span style=color:#e6db74>&#34;Bearer &#34;</span>))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Unauthorized();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> token = authHeader.Replace(<span style=color:#e6db74>&#34;Bearer &#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> username = User.Identity?.Name;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> db = _redis.GetDatabase();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> storedToken = db.StringGet(<span style=color:#e6db74>$&#34;jwt:{username}&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (storedToken.IsNullOrEmpty || storedToken != token)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Unauthorized();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> Ok(<span style=color:#e6db74>&#34;Token is valid&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=4-token-失效机制>4. Token 失效机制<a hidden class=anchor aria-hidden=true href=#4-token-失效机制>#</a></h2><p>利用 Redis 的 TTL 设置 token 的自动过期：</p><p>在存储 token 时设置过期时间。
用户注销时可以手动删除 Redis 中的 token。
注销示例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#a6e22e>[HttpPost(&#34;logout&#34;)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> IActionResult Logout()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> username = User.Identity?.Name;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> db = _redis.GetDatabase();
</span></span><span style=display:flex><span>    db.KeyDelete(<span style=color:#e6db74>$&#34;jwt:{username}&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> Ok(<span style=color:#e6db74>&#34;Logged out&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h1 id=总结>总结<a hidden class=anchor aria-hidden=true href=#总结>#</a></h1><p>通过 Redis 存储 JWT，可以实现以下功能：</p><p>集中管理 JWT：便于实时撤销或查询。
自动过期：Redis 自带 TTL，可以简化 token 的管理。
扩展性好：适用于分布式系统。
根据实际需求，还可以扩展功能，例如黑名单机制或支持多设备登录等。</p><h1 id=debian-redis-setup>debian redis setup<a hidden class=anchor aria-hidden=true href=#debian-redis-setup>#</a></h1><h1 id=1-更新软件包列表>1: 更新软件包列表<a hidden class=anchor aria-hidden=true href=#1-更新软件包列表>#</a></h1><p>首先，确保的软件包列表是最新的。打开终端并执行以下命令：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt update
</span></span></code></pre></div><h1 id=2-安装redis>2: 安装Redis<a hidden class=anchor aria-hidden=true href=#2-安装redis>#</a></h1><p>更新完软件包列表后，可以通过apt包管理器来安装Redis服务器：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt install redis-server
</span></span></code></pre></div><p>这将安装Redis及其依赖项，并自动启动Redis服务。</p><h1 id=3-检查redis状态>3: 检查Redis状态<a hidden class=anchor aria-hidden=true href=#3-检查redis状态>#</a></h1><p>安装完成后，可以检查Redis服务是否正在运行：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo systemctl status redis-server
</span></span></code></pre></div><p>如果服务正在运行，会看到类似“active (running)”的状态信息。</p><h1 id=4-配置redis>4: 配置Redis<a hidden class=anchor aria-hidden=true href=#4-配置redis>#</a></h1><p>Redis的配置文件位于/etc/redis/redis.conf。可能想要编辑这个文件来更改默认设置，例如绑定地址、端口号、要求密码等。使用文本编辑器打开它：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo nano /etc/redis/redis.conf
</span></span></code></pre></div><p>做出必要的更改后保存文件并退出编辑器。</p><h1 id=5-重启redis服务>5: 重启Redis服务<a hidden class=anchor aria-hidden=true href=#5-重启redis服务>#</a></h1><p>如果对配置文件做了任何修改，记得重启Redis服务以使更改生效：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo systemctl restart redis-server
</span></span></code></pre></div><h1 id=6-设置redis开机自启>6: 设置Redis开机自启<a hidden class=anchor aria-hidden=true href=#6-设置redis开机自启>#</a></h1><p>为了确保Redis在系统启动时自动启动，可以使用以下命令启用开机自启：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo systemctl enable redis-server
</span></span></code></pre></div><h1 id=7-测试redis安装>7: 测试Redis安装<a hidden class=anchor aria-hidden=true href=#7-测试redis安装>#</a></h1><p>可以通过连接到本地Redis服务器来测试安装是否成功。使用redis-cli命令行工具连接到Redis：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>redis-cli
</span></span></code></pre></div><p>一旦进入Redis CLI，可以尝试运行ping命令，如果Redis服务器响应PONG，则说明安装和配置都正常工作。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>
</span></span><span style=display:flex><span>127.0.0.1:6379&gt; ping
</span></span><span style=display:flex><span>PONG
</span></span></code></pre></div><h2 id=redis-配置文件>Redis 配置文件<a hidden class=anchor aria-hidden=true href=#redis-配置文件>#</a></h2><p>编辑 Redis 的配置文件（通常是 /etc/redis/redis.conf）。</p><p>确保允许远程连接：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bind 0.0.0.0
</span></span></code></pre></div><p>（默认仅允许本地连接，127.0.0.1）。
确保未设置 protected-mode 为 yes，或者明确配置授权规则：</p><p>protected-mode no
重启 Redis 服务以应用更改：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo systemctl restart redis
</span></span></code></pre></div><h1 id=err>err<a hidden class=anchor aria-hidden=true href=#err>#</a></h1><h2 id=500-undocumented>500 Undocumented<a hidden class=anchor aria-hidden=true href=#500-undocumented>#</a></h2><p>Error: Internal Server Error
Response body
System.InvalidOperationException: Multiple constructors accepting all given argument types have been found in type &lsquo;userApiController&rsquo;. There should only be one applicable constructor.
at Microsoft.Extensions.DependencyInjection.ActivatorUtilities.TryFindMatchingConstructor(Type instanceType, Type[] argumentTypes, ConstructorInfo& matchingConstructor, Nullable<code>1[]& parameterMap) at Microsoft.Extensions.DependencyInjection.ActivatorUtilities.FindApplicableConstructor(Type instanceType, Type[] argumentTypes, ConstructorInfo& matchingConstructor, Nullable</code>1[]& matchingParameterMap)
at Microsoft.Extensions.DependencyInjection.ActivatorUtilities.CreateFactoryInternal(Type instanceType, Type[] argumentTypes, ParameterExpression& provider, ParameterExpression& argumentArray, Expression& factoryExpressionBody)</p><p>问题是由于依赖注入系统在实例化 userApiController 时发现有多个构造函数可以匹配传递的参数，因此无法确定使用哪个构造函数。这种情况会导致 System.InvalidOperationException 异常。多个改成一个。</p><h2 id=systeminvalidoperationexception->System.InvalidOperationException: 、<a hidden class=anchor aria-hidden=true href=#systeminvalidoperationexception->#</a></h2><p>Unable to resolve service for type &lsquo;JwtHelper&rsquo; while attempting to activate &lsquo;userApiController&rsquo;.
at Microsoft.Extensions.DependencyInjection.ActivatorUtilities.ThrowHelperUnableToResolveService(Type type, Type requiredBy)
at lambda_method69(Closure, IServiceProvider, Object[])</p><p>这个错误表明 wtHelper 类型未在依赖注入 (DI) 容器中注册，而 IM.Controllers.userApiController 需要它作为依赖。DI 系统在尝试解析 JwtHelper 时失败，导致 Internal Server Error。</p><p><strong>检查依赖注册</strong>
确保在 Program.cs 或 Startup.cs 文件中注册了 JwtHelper 服务。如果 JwtHelper 是一个自定义工具类或服务，你需要将它添加到 DI 容器中。</p><p>builder.Services.AddScoped<jwthelper>();
如果 JwtHelper 需要构造函数注入的依赖项，也要确保这些依赖已注册。
如果 JwtHelper 是无状态的，考虑使用 AddSingleton。</p><h2 id=stackexchangeredisredisconnectionexception>StackExchange.Redis.RedisConnectionException:<a hidden class=anchor aria-hidden=true href=#stackexchangeredisredisconnectionexception>#</a></h2><p>“It was not possible to connect to the redis server(s). Error connecting right now. To allow this multiplexer to continue retrying until it&rsquo;s able to connect, use abortConnect=false in your connection string or AbortOnConnectFail=false; in your code.”</p><p>检查 Redis 的配置文件（通常是 /etc/redis/redis.conf）。
<strong>确保允许远程连接</strong>：
bind 0.0.0.0
.Connect(&ldquo;XXXX:6379,abortConnect=false&rdquo;));</p><p>重启redis</p><h1 id=redis-保护模式>Redis 保护模式<a hidden class=anchor aria-hidden=true href=#redis-保护模式>#</a></h1><p>Redis 处于保护模式，默认情况下禁止外部连接。</p><h2 id=解决方法>解决方法：<a hidden class=anchor aria-hidden=true href=#解决方法>#</a></h2><p>修改 redis.conf 中的 protected-mode 设置：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>protected-mode no
</span></span></code></pre></div><p>重启 Redis：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo systemctl restart redis
</span></span></code></pre></div><h1 id=程序测试redis>程序测试redis<a hidden class=anchor aria-hidden=true href=#程序测试redis>#</a></h1><p>.NET</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span>     <span style=color:#75715e>// Redis 服务器地址和端口</span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>string</span> redisConnectionString = <span style=color:#e6db74>&#34;199.24x.x.x:6379&#34;</span>; <span style=color:#75715e>// 默认 Redis 端口是 6379</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#75715e>// 创建连接到 Redis 的实例</span>
</span></span><span style=display:flex><span>     ConnectionMultiplexer redis = <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>try</span>
</span></span><span style=display:flex><span>     {
</span></span><span style=display:flex><span>         redis = ConnectionMultiplexer.Connect(redisConnectionString);
</span></span><span style=display:flex><span>         Console.WriteLine(<span style=color:#e6db74>&#34;连接成功!&#34;</span>);
</span></span><span style=display:flex><span>     }
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>catch</span> (Exception ex)
</span></span><span style=display:flex><span>     {
</span></span><span style=display:flex><span>         Console.WriteLine(<span style=color:#e6db74>$&#34;连接到 Redis 失败: {ex.Message}&#34;</span>);
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>     }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#75715e>// 获取 Redis 数据库实例</span>
</span></span><span style=display:flex><span>     IDatabase db = redis.GetDatabase();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#75715e>// 写入数据</span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>string</span> key = <span style=color:#e6db74>&#34;myKey22&#34;</span>;
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>string</span> <span style=color:#66d9ef>value</span> = <span style=color:#e6db74>&#34;Hello, Redis!&#34;</span>;
</span></span><span style=display:flex><span>     db.StringSet(key, <span style=color:#66d9ef>value</span>);
</span></span><span style=display:flex><span>     Console.WriteLine(<span style=color:#e6db74>$&#34;已写入: {key} - {value}&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#75715e>// 读取数据</span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>string</span> retrievedValue = db.StringGet(key);
</span></span><span style=display:flex><span>     Console.WriteLine(<span style=color:#e6db74>$&#34;读取到: {key} - {retrievedValue}&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#75715e>// 删除数据</span>
</span></span><span style=display:flex><span>     db.KeyDelete(key);
</span></span><span style=display:flex><span>     Console.WriteLine(<span style=color:#e6db74>$&#34;已删除: {key}&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#75715e>// 关闭连接</span>
</span></span><span style=display:flex><span>     redis.Close();
</span></span><span style=display:flex><span>     Console.WriteLine(<span style=color:#e6db74>&#34;连接关闭&#34;</span>);
</span></span></code></pre></div><p>node</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>npm i redis
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>redis</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;redis&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 创建Redis客户端连接
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>client</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>redis</span>.<span style=color:#a6e22e>createClient</span>({
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>host</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;199.24x.x.x&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>port</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>6379</span>
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 监听连接事件，当成功连接到Redis时执行回调函数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;connect&#39;</span>, () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;成功连接到Redis服务器&#39;</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 监听错误事件，当出现错误时执行回调函数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;error&#39;</span>, (<span style=color:#a6e22e>err</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;连接Redis服务器时出现错误：&#39;</span>, <span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 设置一个键值对
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>set</span>(<span style=color:#e6db74>&#39;myKey&#39;</span>, <span style=color:#e6db74>&#39;myValue&#39;</span>, (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>reply</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;设置键值对时出现错误：&#39;</span>, <span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;设置键值对成功，回复：&#39;</span>, <span style=color:#a6e22e>reply</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 获取键值对
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;myKey&#39;</span>, (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>value</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;获取键值对时出现错误：&#39;</span>, <span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;获取到的键值对的值为：&#39;</span>, <span style=color:#a6e22e>value</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 删除键值对
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>del</span>(<span style=color:#e6db74>&#39;myKey&#39;</span>, (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>reply</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;删除键值对时出现错误：&#39;</span>, <span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;删除键值对成功，回复：&#39;</span>, <span style=color:#a6e22e>reply</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 关闭Redis客户端连接
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>quit</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>return</span>;
</span></span></code></pre></div><h1 id=redis设置密码>redis设置密码<a hidden class=anchor aria-hidden=true href=#redis设置密码>#</a></h1><h2 id=1-编辑-redis-配置文件>1. 编辑 Redis 配置文件<a hidden class=anchor aria-hidden=true href=#1-编辑-redis-配置文件>#</a></h2><p>Redis 的配置文件通常位于 /etc/redis/redis.conf 或 /etc/redis.conf。用你喜欢的文本编辑器打开它，例如：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo nano /etc/redis/redis.conf
</span></span></code></pre></div><h2 id=2-找到并修改-requirepass-参数>2. 找到并修改 requirepass 参数<a hidden class=anchor aria-hidden=true href=#2-找到并修改-requirepass-参数>#</a></h2><p>在配置文件中找到以下行（可能被注释掉）：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># requirepass foobared</span>
</span></span></code></pre></div><p>将其取消注释并替换为你的密码，例如：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>requirepass your_secure_password
</span></span></code></pre></div><h2 id=3-重启-redis-服务>3. 重启 Redis 服务<a hidden class=anchor aria-hidden=true href=#3-重启-redis-服务>#</a></h2><p>保存并退出文件后，重启 Redis 服务以应用更改：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo systemctl restart redis
</span></span></code></pre></div><h2 id=4-测试密码功能>4. 测试密码功能<a hidden class=anchor aria-hidden=true href=#4-测试密码功能>#</a></h2><p>你可以通过以下命令测试 Redis 是否需要密码：</p><p>使用 redis-cli 连接
尝试未输入密码的命令：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>redis-cli
</span></span><span style=display:flex><span>&gt; get key
</span></span></code></pre></div><p>如果设置了密码，Redis 会返回类似如下的错误：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>(</span>error<span style=color:#f92672>)</span> NOAUTH Authentication required.
</span></span></code></pre></div><p>使用 AUTH 命令验证：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>redis-cli
</span></span><span style=display:flex><span>&gt; auth your_secure_password
</span></span><span style=display:flex><span>OK
</span></span><span style=display:flex><span>&gt; get key
</span></span></code></pre></div><p>如果密码正确，后续操作将生效。</p><h2 id=5-链接修改>5. 链接修改<a hidden class=anchor aria-hidden=true href=#5-链接修改>#</a></h2><p>199.x.x.xxx:6379,password=123X.zx 更改redis链接</p><h1 id=redis缓存json-redishelper>redis缓存json RedisHelper<a hidden class=anchor aria-hidden=true href=#redis缓存json-redishelper>#</a></h1><p>方法添加 Redis 缓存，可以通过以下方式扩展代码：</p><h2 id=实现思路>实现思路<a hidden class=anchor aria-hidden=true href=#实现思路>#</a></h2><p>定义 Redis 缓存逻辑：</p><p>先尝试从 Redis 缓存中读取数据。
如果缓存命中，则直接返回数据。
如果缓存未命中，则查询数据库，处理数据后存入 Redis，并设置适当的过期时间。
定义 Redis 键：</p><p>使用一个唯一键，例如 <strong>CityInfoList:{id}</strong>，确保缓存区分不同 id 的数据。
序列化和反序列化：</p><p>使用 JSON 格式存储数据，方便跨语言和跨系统的兼容性。
扩展后的代码
以下是添加 Redis 缓存后的完整实现：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> List&lt;CityInfoS&gt; FindIMCityInfoListByPIDS(<span style=color:#66d9ef>string</span> id)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 定义 Redis 缓存键</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>string</span> redisKey = <span style=color:#e6db74>$&#34;IMCityInfoList:{id}&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 尝试从 Redis 获取数据</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>string</span> cachedData = RedisHelper.GetString(redisKey); <span style=color:#75715e>// RedisHelper 是 Redis 操作工具类</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (!<span style=color:#66d9ef>string</span>.IsNullOrEmpty(cachedData))
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 如果缓存命中，反序列化并返回数据</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> JsonConvert.DeserializeObject&lt;List&lt;IMCityInfoS&gt;&gt;(cachedData);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 缓存未命中，从数据库查询</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>string</span> sql = <span style=color:#e6db74>@&#34;SELECT `CtId`, `Pid`, `PidS`, `CityCode`, `CityName`, 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                          `PostCode`, `AreaCode`, `Ctime`, `CtimeInt`, `LangType`, `HasSon`
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                   FROM `IMCityInfoS` 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                   WHERE PID = @PID&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> parameters = <span style=color:#66d9ef>new</span> MySqlParameter[] { <span style=color:#66d9ef>new</span> MySqlParameter(<span style=color:#e6db74>&#34;@PID&#34;</span>, id) };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    DataSet ds = DbHelperMySQL.Query(sql, parameters);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (ds != <span style=color:#66d9ef>null</span> &amp;&amp; ds.Tables[<span style=color:#ae81ff>0</span>].Rows.Count &gt; <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 转换查询结果为 JSON</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>string</span> json = JsonConvert.SerializeObject(ds.Tables[<span style=color:#ae81ff>0</span>]);
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 设置缓存并指定过期时间（例如30分钟）</span>
</span></span><span style=display:flex><span>        RedisHelper.SetString(redisKey, json, TimeSpan.FromMinutes(<span style=color:#ae81ff>30</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 反序列化为对象列表并返回</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> JsonConvert.DeserializeObject&lt;List&lt;IMCityInfoS&gt;&gt;(json);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果查询无结果，返回空</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=redishelper-工具类>RedisHelper 工具类<a hidden class=anchor aria-hidden=true href=#redishelper-工具类>#</a></h2><p>如果你尚未实现 RedisHelper，可以参考以下示例代码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>using</span> StackExchange.Redis;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> System;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RedisHelper</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>readonly</span> ConnectionMultiplexer redis = ConnectionMultiplexer.Connect(<span style=color:#e6db74>&#34;localhost&#34;</span>); <span style=color:#75715e>// 替换为你的 Redis 地址</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>readonly</span> IDatabase db = redis.GetDatabase();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 获取字符串数据</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>string</span> GetString(<span style=color:#66d9ef>string</span> key)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> db.StringGet(key);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 设置字符串数据并指定过期时间</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> SetString(<span style=color:#66d9ef>string</span> key, <span style=color:#66d9ef>string</span> <span style=color:#66d9ef>value</span>, TimeSpan? expiry = <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        db.StringSet(key, <span style=color:#66d9ef>value</span>, expiry);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=使用注意事项>使用注意事项<a hidden class=anchor aria-hidden=true href=#使用注意事项>#</a></h2><p>Redis 连接池：实际生产中，建议使用 Redis 连接池来管理连接，避免连接过多导致资源占用。
异常处理：在 Redis 读写操作中，添加异常捕获逻辑，确保即使 Redis 出现问题，也不会影响数据库查询。
过期时间：根据业务需求设置合理的过期时间，避免缓存数据过期或无效。</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://qfsyso.github.io/tags/jwt/>JWT</a></li><li><a href=https://qfsyso.github.io/tags/token/>Token</a></li><li><a href=https://qfsyso.github.io/tags/redis/>Redis</a></li></ul><nav class=paginav><a class=prev href=https://qfsyso.github.io/posts/navigation/><span class=title>« Prev</span><br><span>Navigation</span>
</a><a class=next href=https://qfsyso.github.io/posts/cashrp-opencv/><span class=title>Next »</span><br><span>cashrp opencv</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share jwt redis on x" href="https://x.com/intent/tweet/?text=jwt%20redis&amp;url=https%3a%2f%2fqfsyso.github.io%2fposts%2fjwt-redis%2f&amp;hashtags=Jwt%2cToken%2cRedis"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share jwt redis on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fqfsyso.github.io%2fposts%2fjwt-redis%2f&amp;title=jwt%20redis&amp;summary=jwt%20redis&amp;source=https%3a%2f%2fqfsyso.github.io%2fposts%2fjwt-redis%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share jwt redis on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fqfsyso.github.io%2fposts%2fjwt-redis%2f&title=jwt%20redis"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share jwt redis on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fqfsyso.github.io%2fposts%2fjwt-redis%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share jwt redis on whatsapp" href="https://api.whatsapp.com/send?text=jwt%20redis%20-%20https%3a%2f%2fqfsyso.github.io%2fposts%2fjwt-redis%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share jwt redis on telegram" href="https://telegram.me/share/url?text=jwt%20redis&amp;url=https%3a%2f%2fqfsyso.github.io%2fposts%2fjwt-redis%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share jwt redis on ycombinator" href="https://news.ycombinator.com/submitlink?t=jwt%20redis&u=https%3a%2f%2fqfsyso.github.io%2fposts%2fjwt-redis%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><div class=wtime><div class=wtime2>CST<span id=beijingTime></span> GMT <span id=londonTime></span> EST <span id=newYorkTime></span> PST<span id=losAngelesTime></span></div><div class=wtime2 style=display:none>东京<span id=tokyoTime></span></div><div class=wtime2 style=display:none>欧洲-巴黎<span id=parisTime></span></div><div class=wtime2 style=display:none>UTC<span id=utcTime></span></div></div><span>&copy; 2025 <a href=https://qfsyso.github.io/>MLOG</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a>
</span><script type=text/javascript>const timeZoneOffsets={beijing:8,tokyo:9,paris:[1,2],london:[0,1],newYork:[-5,-4],losAngeles:[-8,-7]};function padZero(e){return e<10?"0"+e:e}function formatTime(e){const t=e.getFullYear(),n=padZero(e.getMonth()+1),s=padZero(e.getDate()),o=padZero(e.getHours()),i=padZero(e.getMinutes()),a=padZero(e.getSeconds());return`${t}-${n}-${s} ${o}:${i}:${a}`}function isDaylightSavingTime(e,t){const o=e.getMonth(),n=new Date(e.getFullYear(),3,8,2,0,0),s=new Date(e.getFullYear(),10,1,2,0,0);return(t==="paris"||t==="london"||t==="newYork"||t==="losAngeles")&&e>=n&&e<s}function updateTime(){const e=new Date,t=new Date(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds()),n=formatTime(t);document.getElementById("utcTime").innerHTML=n;for(const n in timeZoneOffsets){const e=timeZoneOffsets[n];let s;Array.isArray(e)?s=isDaylightSavingTime(t,n)?e[1]:e[0]:s=e;const o=new Date(t.getTime()+s*60*60*1e3);document.getElementById(n+"Time").innerHTML=formatTime(o)}setTimeout(updateTime,1e3)}window.onload=function(){updateTime()};function notfound(e){var n=e.src,t=n.split("/"),s=t[t.length-1];e.src="https://47.115.223.75:8080/group1/v2/"+s+"?timestamp="+Date.now(),e.onerror=null}</script></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>