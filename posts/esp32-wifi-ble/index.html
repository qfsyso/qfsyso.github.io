<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>ESP32 WIFI BLE | MLOG</title>
<meta name=keywords content="ESP32,C"><meta name=description content='hello world #include <stdio.h> #include <inttypes.h> #include "sdkconfig.h" #include "freertos/FreeRTOS.h" #include "freertos/task.h" #include "esp_chip_info.h" #include "esp_flash.h" #include "esp_system.h" void app_main(void) { printf("Hello world!\n"); /* Print chip information */ esp_chip_info_t chip_info; uint32_t flash_size; esp_chip_info(&amp;chip_info); printf("This is %s chip with %d CPU core(s), %s%s%s%s, ", CONFIG_IDF_TARGET, chip_info.cores, (chip_info.features & CHIP_FEATURE_WIFI_BGN) ? "WiFi/" : "", (chip_info.features & CHIP_FEATURE_BT) ? "BT" : "", (chip_info.features & CHIP_FEATURE_BLE) ? "BLE" : "", (chip_info.features & CHIP_FEATURE_IEEE802154) ? ", 802.'><meta name=author content="dwd"><link rel=canonical href=https://qfsyso.github.io/posts/esp32-wifi-ble/><link crossorigin=anonymous href=/assets/css/stylesheet.f49d66caae9ea0fd43f21f29e71a8d3e284517ed770f2aa86fa012953ad3c9ef.css integrity="sha256-9J1myq6eoP1D8h8p5xqNPihFF+13Dyqob6ASlTrTye8=" rel="preload stylesheet" as=style><link rel=icon href=https://qfsyso.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://qfsyso.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://qfsyso.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://qfsyso.github.io/apple-touch-icon.png><link rel=mask-icon href=https://qfsyso.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://qfsyso.github.io/posts/esp32-wifi-ble/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://qfsyso.github.io/posts/esp32-wifi-ble/"><meta property="og:site_name" content="MLOG"><meta property="og:title" content="ESP32 WIFI BLE"><meta property="og:description" content='hello world #include <stdio.h> #include <inttypes.h> #include "sdkconfig.h" #include "freertos/FreeRTOS.h" #include "freertos/task.h" #include "esp_chip_info.h" #include "esp_flash.h" #include "esp_system.h" void app_main(void) { printf("Hello world!\n"); /* Print chip information */ esp_chip_info_t chip_info; uint32_t flash_size; esp_chip_info(&amp;chip_info); printf("This is %s chip with %d CPU core(s), %s%s%s%s, ", CONFIG_IDF_TARGET, chip_info.cores, (chip_info.features & CHIP_FEATURE_WIFI_BGN) ? "WiFi/" : "", (chip_info.features & CHIP_FEATURE_BT) ? "BT" : "", (chip_info.features & CHIP_FEATURE_BLE) ? "BLE" : "", (chip_info.features & CHIP_FEATURE_IEEE802154) ? ", 802.'><meta property="og:locale" content="zh-CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-11-03T01:57:21+08:00"><meta property="article:modified_time" content="2025-11-03T01:57:21+08:00"><meta property="article:tag" content="ESP32"><meta property="article:tag" content="C"><meta name=twitter:card content="summary"><meta name=twitter:title content="ESP32 WIFI BLE"><meta name=twitter:description content='hello world #include <stdio.h> #include <inttypes.h> #include "sdkconfig.h" #include "freertos/FreeRTOS.h" #include "freertos/task.h" #include "esp_chip_info.h" #include "esp_flash.h" #include "esp_system.h" void app_main(void) { printf("Hello world!\n"); /* Print chip information */ esp_chip_info_t chip_info; uint32_t flash_size; esp_chip_info(&amp;chip_info); printf("This is %s chip with %d CPU core(s), %s%s%s%s, ", CONFIG_IDF_TARGET, chip_info.cores, (chip_info.features & CHIP_FEATURE_WIFI_BGN) ? "WiFi/" : "", (chip_info.features & CHIP_FEATURE_BT) ? "BT" : "", (chip_info.features & CHIP_FEATURE_BLE) ? "BLE" : "", (chip_info.features & CHIP_FEATURE_IEEE802154) ? ", 802.'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://qfsyso.github.io/posts/"},{"@type":"ListItem","position":2,"name":"ESP32 WIFI BLE","item":"https://qfsyso.github.io/posts/esp32-wifi-ble/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"ESP32 WIFI BLE","name":"ESP32 WIFI BLE","description":"hello world #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;inttypes.h\u0026gt; #include \u0026#34;sdkconfig.h\u0026#34; #include \u0026#34;freertos/FreeRTOS.h\u0026#34; #include \u0026#34;freertos/task.h\u0026#34; #include \u0026#34;esp_chip_info.h\u0026#34; #include \u0026#34;esp_flash.h\u0026#34; #include \u0026#34;esp_system.h\u0026#34; void app_main(void) { printf(\u0026#34;Hello world!\\n\u0026#34;); /* Print chip information */ esp_chip_info_t chip_info; uint32_t flash_size; esp_chip_info(\u0026amp;chip_info); printf(\u0026#34;This is %s chip with %d CPU core(s), %s%s%s%s, \u0026#34;, CONFIG_IDF_TARGET, chip_info.cores, (chip_info.features \u0026amp; CHIP_FEATURE_WIFI_BGN) ? \u0026#34;WiFi/\u0026#34; : \u0026#34;\u0026#34;, (chip_info.features \u0026amp; CHIP_FEATURE_BT) ? \u0026#34;BT\u0026#34; : \u0026#34;\u0026#34;, (chip_info.features \u0026amp; CHIP_FEATURE_BLE) ? \u0026#34;BLE\u0026#34; : \u0026#34;\u0026#34;, (chip_info.features \u0026amp; CHIP_FEATURE_IEEE802154) ? \u0026#34;, 802.","keywords":["ESP32","C"],"articleBody":"hello world #include #include #include \"sdkconfig.h\" #include \"freertos/FreeRTOS.h\" #include \"freertos/task.h\" #include \"esp_chip_info.h\" #include \"esp_flash.h\" #include \"esp_system.h\" void app_main(void) { printf(\"Hello world!\\n\"); /* Print chip information */ esp_chip_info_t chip_info; uint32_t flash_size; esp_chip_info(\u0026chip_info); printf(\"This is %s chip with %d CPU core(s), %s%s%s%s, \", CONFIG_IDF_TARGET, chip_info.cores, (chip_info.features \u0026 CHIP_FEATURE_WIFI_BGN) ? \"WiFi/\" : \"\", (chip_info.features \u0026 CHIP_FEATURE_BT) ? \"BT\" : \"\", (chip_info.features \u0026 CHIP_FEATURE_BLE) ? \"BLE\" : \"\", (chip_info.features \u0026 CHIP_FEATURE_IEEE802154) ? \", 802.15.4 (Zigbee/Thread)\" : \"\"); unsigned major_rev = chip_info.revision / 100; unsigned minor_rev = chip_info.revision % 100; printf(\"silicon revision v%d.%d, \", major_rev, minor_rev); if(esp_flash_get_size(NULL, \u0026flash_size) != ESP_OK) { printf(\"Get flash size failed\"); return; } printf(\"%\" PRIu32 \"MB %s flash\\n\", flash_size / (uint32_t)(1024 * 1024), (chip_info.features \u0026 CHIP_FEATURE_EMB_FLASH) ? \"embedded\" : \"external\"); printf(\"Minimum free heap size: %\" PRIu32 \" bytes\\n\", esp_get_minimum_free_heap_size()); for (int i = 10; i \u003e= 0; i--) { printf(\"Restarting in %d seconds...\\n\", i); vTaskDelay(1000 / portTICK_PERIOD_MS); } printf(\"Restarting now.\\n\"); fflush(stdout); esp_restart(); } æ„å»ºçƒ§å½•ç›‘è§†\nI (272) main_task: Started on CPU0 I (282) main_task: Calling app_main() Hello world! This is esp32 chip with 2 CPU core(s), WiFi/BTBLE, silicon revision v3.1, 2MB external flash Minimum free heap size: 306072 bytes Restarting in 10 seconds... debug æ¢å¦ä¸€ä¸ªå£ [è°ƒè¯•å£] æ­¤æ—¶è®¾å¤‡ç®¡ç†å™¨å¯ä»¥çœ‹åˆ° -é€šç”¨ä¸²è¡Œæ€»çº¿è®¾å¤‡ -USB JTAG/serial debug unit\nIDE é€‰æ‹©ä¸²å£ é€‰æ‹©eps32 JTAG ç‚¹debug å¼€å§‹å•æ­¥/æ–­ç‚¹è°ƒè¯•\nhttps://www.bilibili.com/video/BV1GZ42187U4\näº®ç¯ #include #include \"driver/gpio.h\" #define LED_PIN GPIO_NUM_23 // ä½¿ç”¨ GPIO23 æ§åˆ¶è¾“å‡º void app_main(void) { gpio_config_t io_config = { .pin_bit_mask = (1ULL \u003c\u003c LED_PIN), .mode = GPIO_MODE_OUTPUT, .pull_up_en = GPIO_PULLUP_DISABLE, .pull_down_en = GPIO_PULLDOWN_DISABLE, .intr_type = GPIO_INTR_DISABLE, }; gpio_config(\u0026io_config); gpio_set_level(LED_PIN, 1); // è¾“å‡ºé«˜ç”µå¹³ï¼ˆ3.3Vï¼‰ while (1) { // ä¿æŒé«˜ç”µå¹³è¾“å‡º } } æ¥çº¿ï¼š GPIO23 â†’ ç”µé˜»ï¼ˆ220Î©~330Î©ï¼‰ â†’ LED æ­£æï¼ˆé•¿è„šï¼‰ LED è´Ÿæï¼ˆçŸ­è„šï¼‰ â†’ GND\né—´éš”1s #include #include \"driver/gpio.h\" #include \"freertos/FreeRTOS.h\" #include \"freertos/task.h\" #define LED_PIN GPIO_NUM_23 // ä½¿ç”¨ GPIO23 æ§åˆ¶ LED void app_main(void) { // é…ç½® GPIO23 ä¸ºè¾“å‡ºæ¨¡å¼ gpio_config_t io_config = { .pin_bit_mask = (1ULL \u003c\u003c LED_PIN), .mode = GPIO_MODE_OUTPUT, .pull_up_en = GPIO_PULLUP_DISABLE, .pull_down_en = GPIO_PULLDOWN_DISABLE, .intr_type = GPIO_INTR_DISABLE, }; gpio_config(\u0026io_config); // å¾ªç¯é—ªçƒ while (1) { gpio_set_level(LED_PIN, 1); // è¾“å‡ºé«˜ç”µå¹³ -\u003e LEDäº® vTaskDelay(pdMS_TO_TICKS(1000)); // å»¶æ—¶1ç§’ gpio_set_level(LED_PIN, 0); // è¾“å‡ºä½ç”µå¹³ -\u003e LEDç­ vTaskDelay(pdMS_TO_TICKS(1000)); // å»¶æ—¶1ç§’ } } å¤–éƒ¨ä¸­æ–­ ï¼ˆæŒ‰é”®ï¼‰ #include #include \"driver/gpio.h\" #include \"freertos/FreeRTOS.h\" #include \"freertos/task.h\" #include \"esp_log.h\" #include \"esp_timer.h\" // ç”¨äºè·å–æ—¶é—´æˆ³ï¼ˆå¾®ç§’ï¼‰ #define LED_PIN GPIO_NUM_23 #define BUTTON_PIN GPIO_NUM_0 // æŒ‰é”®æ¥GPIO0ï¼Œä¸€ç«¯æ¥GND static const char *TAG = \"LED_BUTTON\"; volatile int led_state = 0; // 0=ç­ï¼Œ1=äº® volatile int64_t last_press_time = 0; // ä¸Šæ¬¡æŒ‰é”®æ—¶é—´ï¼ˆé˜²æŠ–ï¼‰ // ä¸­æ–­æœåŠ¡å‡½æ•°ï¼ˆISRï¼‰ static void IRAM_ATTR button_isr_handler(void* arg) { int64_t now = esp_timer_get_time(); // å½“å‰æ—¶é—´ï¼ˆå¾®ç§’ï¼‰ // é˜²æŠ–ï¼šåˆ¤æ–­ä¸¤æ¬¡æŒ‰ä¸‹é—´éš”æ˜¯å¦è¶…è¿‡ 200msï¼ˆ200000å¾®ç§’ï¼‰ if (now - last_press_time \u003e 200000) { led_state = !led_state; // ç¿»è½¬ LED çŠ¶æ€ gpio_set_level(LED_PIN, led_state); last_press_time = now; } } void app_main(void) { // é…ç½® LED è¾“å‡º gpio_config_t io_conf_led = { .pin_bit_mask = (1ULL \u003c\u003c LED_PIN), .mode = GPIO_MODE_OUTPUT, .pull_up_en = GPIO_PULLUP_DISABLE, .pull_down_en = GPIO_PULLDOWN_DISABLE, .intr_type = GPIO_INTR_DISABLE }; gpio_config(\u0026io_conf_led); // åˆå§‹çŠ¶æ€ LEDç­ gpio_set_level(LED_PIN, 0); // é…ç½®æŒ‰é”®è¾“å…¥ï¼ˆå¸¦ä¸Šæ‹‰ï¼‰ gpio_config_t io_conf_btn = { .pin_bit_mask = (1ULL \u003c\u003c BUTTON_PIN), .mode = GPIO_MODE_INPUT, .pull_up_en = GPIO_PULLUP_ENABLE, .pull_down_en = GPIO_PULLDOWN_DISABLE, .intr_type = GPIO_INTR_NEGEDGE // æ£€æµ‹ä¸‹é™æ²¿ï¼ˆæŒ‰ä¸‹ï¼‰ }; gpio_config(\u0026io_conf_btn); // æ³¨å†Œä¸­æ–­æœåŠ¡ gpio_install_isr_service(0); gpio_isr_handler_add(BUTTON_PIN, button_isr_handler, NULL); ESP_LOGI(TAG, \"System ready. Press button to toggle LED.\"); // ä¸»å¾ªç¯ç©ºè½¬å³å¯ while (1) { vTaskDelay(pdMS_TO_TICKS(1000)); } } æ¥çº¿ å…ƒä»¶\tè¿æ¥åˆ° ESP32 LED æ­£æï¼ˆé•¿è„šï¼‰\tGPIO23 â†’ ç”µé˜»ï¼ˆ220Î©~330Î©ï¼‰ LED è´Ÿæï¼ˆçŸ­è„šï¼‰\tGND æŒ‰é”®ä¸€ç«¯\tGPIO0 æŒ‰é”®å¦ä¸€ç«¯\tGND\nå®šæ—¶å™¨ æ–‡æ¡£https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/\nAPIå‚è€ƒ å¤–è®¾API é€šç”¨ç¡¬ä»¶å®šæ—¶å™¨ GPTimer\nGPTimer åˆ›å»ºå’Œé…ç½®\nä½¿ç”¨ gptimer_config_t è®¾ç½®è®¡æ•°æ–¹å‘å’Œç²¾åº¦ã€‚\nä½¿ç”¨ gptimer_new_timer åˆ›å»ºå®šæ—¶å™¨å¥æŸ„ã€‚\nESP_LOGI(TAG, \"Create timer handle\"); gptimer_handle_t gptimer = NULL; // å®šæ—¶å™¨å¥æŸ„ gptimer_config_t timer_config = { .clk_src = GPTIMER_CLK_SRC_DEFAULT, // é»˜è®¤æ—¶é’Ÿæº .direction = GPTIMER_COUNT_UP, // å‘ä¸Šè®¡æ•° .resolution_hz = 1000000, // è®¡æ•°ç²¾åº¦1MHzï¼ˆ1 tick = 1 usï¼‰ }; ESP_ERROR_CHECK(gptimer_new_timer(\u0026timer_config, \u0026gptimer)); // åˆ›å»ºå®šæ—¶å™¨ ,æŒ‡é’ˆ ESP_ERROR_CHECK(gptimer_enable(gptimer));//åœæ­¢ Wifi åˆå§‹åŒ– nvs_flash_init nvså­˜wifi\nesp_netif_init ç½‘ç»œæ¥å£\nesp_event_loop_create_default åˆ›å»ºäº‹ä»¶å¾ªç¯\nesp_netif_create_default_wifi_sta åˆ›å»ºwifi stationç½‘ç»œæ¥å£\næ³¨å†Œwifi ipäº‹ä»¶å›è°ƒ esp_event_handler_instance_register\né…ç½®wifiå¯åŠ¨ ä½¿ç”¨esp_wifiinitåˆå§‹åŒ–wifiï¼Œä½¿ç”¨esp_wifi_set_modeè®¾ç½®wifiä¸ºstationæ¨¡å¼ã€‚ ä½¿ç”¨esp_wifisetconfigè®¾ç½®è¦è¿æ¥wifiçš„åç§°ä¸å¯†ç ã€‚ ä½¿ç”¨esp_wifistartå¯åŠ¨wifiï¼Œåœ¨äº‹ä»¶å›è°ƒä¸­ä½¿ç”¨esp_wifi_connectè¿æ¥wifiã€‚\n#include #include \"esp_wifi.h\" #include \"freertos/FreeRTos.h\" #include \"nvs_flash.h\" #include \"esp_log.h\" void test_esp_event_cb(void *event_handler_arg, esp_event_base_t event_base, int32_t event_id, void *event_data) { if (event_base == WIFI_EVENT \u0026\u0026 event_id == WIFI_EVENT_STA_START) { esp_wifi_connect(); } else if (event_base == IP_EVENT \u0026\u0026 event_id == IP_EVENT_STA_GOT_IP) { // IP_EVENT_ETH_GOT_IP ä»¥å¤ªç½‘ ip_event_t *event = (ip_event_t *)event_data; ip_event_got_ip_t *getInfostruct = (ip_event_got_ip_t *)event_data; esp_ip4_addr_t ip = getInfostruct-\u003eip_info.ip; printf(\"getip success!\" IPSTR \"\\n\", IP2STR(\u0026ip)); } } void init_wifi1() { nvs_flash_init(); esp_netif_init(); esp_event_loop_create_default(); esp_netif_create_default_wifi_sta(); // æ³¨å†Œå›è°ƒ esp_event_handler_instance_t wifi_event_handler; esp_event_handler_instance_register(WIFI_EVENT, ESP_EVENT_ANY_ID, test_esp_event_cb, NULL, \u0026wifi_event_handler); esp_event_handler_instance_register(IP_EVENT, ESP_EVENT_ANY_ID, test_esp_event_cb, NULL, \u0026wifi_event_handler); // åˆå§‹åŒ–wifi wifi_init_config_t cfg = WIFI_INIT_CONFIG_DEFAULT(); esp_wifi_init(\u0026cfg); esp_wifi_set_mode(WIFI_MODE_STA); wifi_interface_t interface; // wifi_config_t wifi_config; // memset(\u0026wifi_config, 0, sizeof(wifi_config)); // strcpy((char *)wifi_config.sta.ssid, \"\"); // strcpy((char *)wifi_config.sta.password, \"\"); // esp_wifi_set_config(WIFI_IF_STA, \u0026wifi_config); wifi_config_t wifi_config = { .sta = { .ssid = \"RTCTW\", .password = \"123123*123\", .bssid_set = false, }, }; esp_wifi_set_config(WIFI_IF_STA, \u0026wifi_config); esp_wifi_start(); } void app_main(void) { init_wifi1(); while (1) { vTaskDelay(1000 / portTICK_PERIOD_MS); } } è¿è¡Œ çœ‹åˆ°getip success!åˆ™è¿æ¥æˆåŠŸ\nI (3915) esp_netif_handlers: sta ip: 192.168.80.44, mask: 255.255.255.0, gw: 192.168.80.1 getip success!192.168.80.44 ESP_LOGI(TAG, \"IP:\" IPSTR, IP2STR(\u0026ip.ip)); ESP_LOGI(TAG, \"MASK:\" IPSTR, IP2STR(\u0026ip.netmask)); ESP_LOGI(TAG, \"GW:\" IPSTR, IP2STR(\u0026ip.gw)); è“ç‰™é…ç½‘ åˆå§‹åŒ–nvsç½‘ç»œæ¥å£ äº‹ä»¶å›è°ƒWIFIE_VENTï¼ŒWIFI_PROV_EVENTï¼ŒIP_EVENTç­‰ é…ç½‘åˆå§‹åŒ–ä¸å¯åŠ¨ (1)ä½¿ç”¨wifi_prov_mgrinitåˆå§‹åŒ–é…ç½‘ç®¡ç†å™¨ã€‚ (2)ä½¿ç”¨wifi_prov_mgr_start_provisioningå¯åŠ¨é…ç½‘ã€‚\nDOC\u0026ä¸‹è½½é…ç½‘å·¥å…· https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/provisioning/provisioning.html#id9 è“ç‰™ BLE , WIFI SoftAP\nBLE #include #include #include \"freertos/FreeRTOS.h\" #include \"freertos/task.h\" #include \"freertos/event_groups.h\" #include #include \"esp_wifi.h\" #include \"freertos/FreeRTos.h\" #include \"nvs_flash.h\" #include \"esp_log.h\" #include #include #define TAG \"prov-demo\" void test_esp_event_cb(void *event_handler_arg, esp_event_base_t event_base, int32_t event_id, void *event_data) { if (event_base == WIFI_EVENT) { /* code */ } else if (event_base == WIFI_PROV_EVENT) { /* code */ switch ((event_id)) { case WIFI_PROV_START: /* code */ ESP_LOGI(TAG, \"WIFI_PROV_START\\n \"); break; case WIFI_PROV_CRED_RECV: wifi_sta_config_t *wifi_sta_cfg = (wifi_sta_config_t *)event_data; ESP_LOGI(TAG, \"Received Wi-Fi credentials\" \"\\n\\tSSID : %s\\n\\tPassword : %s\\n \", (const char *)wifi_sta_cfg-\u003essid, (const char *)wifi_sta_cfg-\u003epassword); break; case WIFI_PROV_CRED_FAIL: ESP_LOGI(TAG, \"WIFI_PROV_CRED_FAIL\\n \"); break; case WIFI_PROV_CRED_SUCCESS: ESP_LOGI(TAG, \"WIFI_PROV_CRED_SUCCESS\\n \"); break; case WIFI_PROV_END: ESP_LOGI(TAG, \"WIFI_PROV_END\\n \"); wifi_prov_mgr_deinit(); vTaskDelete(NULL); break; default: break; } } else if (event_base == IP_EVENT) { } } void app_main(void) { // åˆå§‹åŒ– nvs_flash_init(); esp_netif_init(); esp_event_loop_create_default(); esp_netif_create_default_wifi_sta(); wifi_init_config_t cfg = WIFI_INIT_CONFIG_DEFAULT(); esp_wifi_init(\u0026cfg); // æ³¨å†Œå›è°ƒ esp_event_handler_register(WIFI_EVENT, ESP_EVENT_ANY_ID, test_esp_event_cb, NULL); esp_event_handler_register(WIFI_PROV_EVENT, ESP_EVENT_ANY_ID, test_esp_event_cb, NULL); esp_event_handler_register(IP_EVENT, ESP_EVENT_ANY_ID, test_esp_event_cb, NULL); wifi_prov_mgr_config_t config = { .scheme = wifi_prov_scheme_ble, .scheme_event_handler = WIFI_PROV_SCHEME_BLE_EVENT_HANDLER_FREE_BLE, }; wifi_prov_mgr_init(config); wifi_prov_mgr_start_provisioning(WIFI_PROV_SECURITY_1, \"123123\", \"PROV_Hello_LM_QF\", NULL); // wifi_prov_mgr_start_provisioning ç¬¬ä¸€ä¸ªå‚æ•° wifi_prov_security_t security ä¸‰ç§å®‰å…¨æ–¹å¼ // é…ç½‘å é‡Šæ”¾æ‰å†…å­˜ while (1) { vTaskDelay(1000 / portTICK_PERIOD_MS); } } include å¤´æ–‡ä»¶/æ–°å¢ç»„ä»¶ CMakeLists.txt\nidf_component_register( SRCS \"wifi_eap_fast_main.c\" # æºæ–‡ä»¶åˆ—è¡¨ INCLUDE_DIRS \".\" # å¤´æ–‡ä»¶æœç´¢ç›®å½• # ç§æœ‰ä¾èµ–ï¼ˆå½“å‰ç»„ä»¶å†…éƒ¨ä½¿ç”¨ï¼Œä¸æš´éœ²ç»™ä¾èµ–å®ƒçš„å…¶ä»–ç»„ä»¶ï¼‰ PRIV_REQUIRES esp_wifi wpa_supplicant nvs_flash wifi_provisioning # æ–°å¢éœ€è¦çš„ç»„ä»¶ï¼ˆä¾‹å¦‚wifi_provisioningï¼‰ esp_event # ç¤ºä¾‹ï¼šè‹¥ç”¨åˆ°äº‹ä»¶å¾ªç¯ï¼Œå¯æ·»åŠ  # åµŒå…¥çš„æ–‡æœ¬æ–‡ä»¶ï¼ˆè¯ä¹¦ã€é…ç½®æ–‡ä»¶ç­‰ï¼Œä¿æŒä¸å˜ï¼‰ EMBED_TXTFILES ca.pem pac_file.pac ) æˆ–è€…åº•éƒ¨é½¿è½® menuconfigé…ç½®\nç¼–è¯‘å¤±è´¥menuconfig bleé…ç½® æ‰“å¼€è“ç‰™ BLE-only\næ¸…ç†æ„å»º\nERR needed by â€˜partition_table/partition-table.binâ€™, missing and no known rule to make it åˆ›å»º partitions.csv æ–‡ä»¶ åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º partitions.csvè¿›å…¥ä½ çš„é¡¹ç›®æ–‡ä»¶å¤¹ E:/ESP32/ble/t22/project-namet22/ï¼Œæ–°å»ºä¸€ä¸ªåä¸º partitions.csv çš„æ–‡ä»¶ï¼ˆç”¨è®°äº‹æœ¬æˆ– VS Code ç­‰å·¥å…·åˆ›å»ºï¼‰ã€‚ å†™å…¥åˆ†åŒºè¡¨å†…å®¹æ ¹æ®ä½ çš„éœ€æ±‚ï¼Œåœ¨ partitions.csv ä¸­å¡«å…¥ä»¥ä¸‹å†…å®¹ï¼ˆç¤ºä¾‹ï¼Œé‡ç‚¹æ˜¯å¢å¤§ factory åˆ†åŒºå¤§å°ï¼‰ï¼š\n# Name, Type, SubType, Offset, Size, Flags nvs, data, nvs, 0x9000, 0x6000, phy_init, data, phy, 0xf000, 0x1000, factory, app, factory, 0x10000, 0x180000, # è¿™é‡Œå°†å¤§å°æ”¹ä¸º 0x180000ï¼ˆ1.5MBï¼‰ï¼Œå¤§äºä½ çš„å›ºä»¶å¤§å° 0x137c10 è¯´æ˜ï¼š0x180000 æ˜¯åˆ†é…ç»™åº”ç”¨ç¨‹åºï¼ˆfactoryï¼‰çš„ç©ºé—´ï¼Œå¯æ ¹æ®éœ€è¦è°ƒæ•´ï¼ˆç¡®ä¿å¤§äºå›ºä»¶å®é™…å¤§å° 0x137c10ï¼‰ã€‚ å…¶ä»–åˆ†åŒºï¼ˆnvsã€phy_initï¼‰æ˜¯ ESP32 å¿…éœ€çš„ï¼Œä¿æŒé»˜è®¤å¤§å°å³å¯ã€‚ é‡æ–°ç¼–è¯‘ä¿å­˜ partitions.csv åï¼Œå†æ¬¡æ‰§è¡Œ idf.py buildï¼Œç¼–è¯‘ç³»ç»Ÿä¼šæ‰¾åˆ°è¯¥æ–‡ä»¶å¹¶ç”Ÿæˆæ­£ç¡®çš„åˆ†åŒºè¡¨ï¼Œè§£å†³ç¼ºå¤±æ–‡ä»¶çš„é”™è¯¯ã€‚\næ„å»ºçƒ§å½•æˆåŠŸåï¼Œæ‰“å¼€ä¸‹è½½çš„APP è¿æ¥è“ç‰™ PROV_Hello_LM_QF è¾“å…¥å¯†ç  123123 ç„¶åè¿ä¸Šwifiåˆ™å¯ä»¥åœ¨PCçœ‹åˆ°wifiä¿¡æ¯\né…ç½‘æˆåŠŸæ˜¾ç¤º\nI (142241) prov-demo: Received Wi-Fi credentials SSID : RTCT123 Password : 123123123123 I (149221) esp_netif_handlers: sta ip: 192.168.80.44, mask: 255.255.255.0, gw: 192.168.80.1 I (149221) wifi_prov_mgr: STA Got IP I (149221) prov-demo: WIFI_PROV_CRED_SUCCESS W (150661) BT_HCI: hci cmd send: disconnect: hdl 0x0, rsn:0x13 W (150761) BT_HCI: hcif disc complete: hdl 0x0, rsn 0x16 dev_find 1 I (151771) wifi_prov_mgr: Provisioning stopped I (151771) prov-demo: WIFI_PROV_END I (151771) wifi_prov_scheme_ble: BLE memory released æºç å‚è€ƒï¼šhttps://github.com/espressif/esp-idf/blob/v5.1.3/examples/provisioning/wifi_prov_mgr/main/app_main.c\nä¼˜åŒ–å·²ç»é…ç½‘çš„æƒ…å†µ #include #include #include #include \"freertos/FreeRTOS.h\" #include \"freertos/task.h\" #include \"freertos/event_groups.h\" #include \"esp_wifi.h\" #include \"nvs_flash.h\" #include \"esp_log.h\" #include \"esp_event.h\" #include \"esp_netif.h\" #include \"wifi_provisioning/manager.h\" #include \"wifi_provisioning/scheme_ble.h\" #define TAG \"prov-demo\" static void wifi_init_sta(void); /* WiFiäº‹ä»¶å›è°ƒ */ static void test_esp_event_cb(void *event_handler_arg, esp_event_base_t event_base, int32_t event_id, void *event_data) { if (event_base == WIFI_EVENT) { switch (event_id) { case WIFI_EVENT_STA_START: esp_wifi_connect(); ESP_LOGI(TAG, \"Wi-Fi STA start\"); break; case WIFI_EVENT_STA_CONNECTED: ESP_LOGI(TAG, \"Wi-Fi connected\"); break; case WIFI_EVENT_STA_DISCONNECTED: ESP_LOGW(TAG, \"Wi-Fi disconnected, retrying...\"); esp_wifi_connect(); break; default: break; } } else if (event_base == WIFI_PROV_EVENT) { switch (event_id) { case WIFI_PROV_START: ESP_LOGI(TAG, \"Provisioning started via BLE\"); break; case WIFI_PROV_CRED_RECV: { wifi_sta_config_t *wifi_sta_cfg = (wifi_sta_config_t *)event_data; ESP_LOGI(TAG, \"Received Wi-Fi credentials\\n\\tSSID: %s\\n\\tPassword: %s\", (const char *)wifi_sta_cfg-\u003essid, (const char *)wifi_sta_cfg-\u003epassword); break; } case WIFI_PROV_CRED_FAIL: ESP_LOGE(TAG, \"Provisioning failed! Check credentials.\"); break; case WIFI_PROV_CRED_SUCCESS: ESP_LOGI(TAG, \"Provisioning successful!\"); break; case WIFI_PROV_END: ESP_LOGI(TAG, \"Provisioning finished, deinitializing manager\"); wifi_prov_mgr_deinit(); // å¼€å§‹ STA æ¨¡å¼è¿æ¥ WiFi wifi_init_sta(); break; default: break; } } else if (event_base == IP_EVENT) { if (event_id == IP_EVENT_STA_GOT_IP) { ip_event_got_ip_t *event = (ip_event_got_ip_t *)event_data; ESP_LOGI(TAG, \"Got IP: \" IPSTR, IP2STR(\u0026event-\u003eip_info.ip)); } } } /* åˆå§‹åŒ– WiFi STA æ¨¡å¼ */ static void wifi_init_sta(void) { wifi_config_t wifi_config; esp_wifi_get_config(WIFI_IF_STA, \u0026wifi_config); ESP_ERROR_CHECK(esp_wifi_set_mode(WIFI_MODE_STA)); ESP_ERROR_CHECK(esp_wifi_start()); ESP_LOGI(TAG, \"Connecting to saved Wi-Fi: %s\", wifi_config.sta.ssid); esp_wifi_connect(); } /* ä¸»å‡½æ•° */ void app_main(void) { // åˆå§‹åŒ– NVS ESP_ERROR_CHECK(nvs_flash_init()); ESP_ERROR_CHECK(esp_netif_init()); ESP_ERROR_CHECK(esp_event_loop_create_default()); esp_netif_create_default_wifi_sta(); wifi_init_config_t cfg = WIFI_INIT_CONFIG_DEFAULT(); ESP_ERROR_CHECK(esp_wifi_init(\u0026cfg)); // æ³¨å†Œäº‹ä»¶ ESP_ERROR_CHECK(esp_event_handler_register(WIFI_EVENT, ESP_EVENT_ANY_ID, test_esp_event_cb, NULL)); ESP_ERROR_CHECK(esp_event_handler_register(WIFI_PROV_EVENT, ESP_EVENT_ANY_ID, test_esp_event_cb, NULL)); ESP_ERROR_CHECK(esp_event_handler_register(IP_EVENT, IP_EVENT_STA_GOT_IP, test_esp_event_cb, NULL)); /* é…ç½‘ç®¡ç†å™¨é…ç½® */ wifi_prov_mgr_config_t prov_cfg = { .scheme = wifi_prov_scheme_ble, .scheme_event_handler = WIFI_PROV_SCHEME_BLE_EVENT_HANDLER_FREE_BLE, }; /* åˆå§‹åŒ–é…ç½‘ç®¡ç†å™¨ */ ESP_ERROR_CHECK(wifi_prov_mgr_init(prov_cfg)); bool provisioned = false; ESP_ERROR_CHECK(wifi_prov_mgr_is_provisioned(\u0026provisioned)); if (provisioned) { ESP_LOGI(TAG, \"Device already provisioned, connecting to saved Wi-Fi...\"); wifi_prov_mgr_deinit(); // ä¸å†éœ€è¦é…ç½‘åŠŸèƒ½ wifi_init_sta(); // ç›´æ¥è¿æ¥ Wi-Fi } else { ESP_LOGI(TAG, \"Starting BLE provisioning...\"); // å¼€å§‹ BLE é…ç½‘ wifi_prov_mgr_start_provisioning(WIFI_PROV_SECURITY_1, \"123123\", // proof of possession \"BLE_PROV\", NULL); } while (1) { vTaskDelay(pdMS_TO_TICKS(1000)); } } æ–°å¢å‡½æ•° wifi_init_sta() å½“æ£€æµ‹åˆ°è®¾å¤‡å·²ç»é…ç½‘è¿‡ï¼Œå°±ç›´æ¥è¿æ¥ Wi-Fiã€‚\nä½¿ç”¨ wifi_prov_mgr_is_provisioned() åˆ¤æ–­çŠ¶æ€ é¿å…æ¯æ¬¡éƒ½è¿›å…¥ BLE é…ç½‘æ¨¡å¼ã€‚\näº‹ä»¶å›è°ƒæ›´å®Œå–„ èƒ½æ­£ç¡®å¤„ç† Wi-Fi è¿æ¥ã€æ–­å¼€ã€è·å– IPã€é…ç½‘ç»“æŸç­‰äº‹ä»¶ã€‚\né…ç½‘æˆåŠŸåè‡ªåŠ¨åˆ‡æ¢ä¸º STA æ¨¡å¼è¿æ¥ Wi-Fiã€‚\nI2C IÂ²Cï¼ˆInter-Integrated Circuitï¼Œé›†æˆç”µè·¯é—´æ€»çº¿ï¼‰æ˜¯ä¸€ç§ç”± Philipsï¼ˆç° NXPï¼‰ äº 1982 å¹´å‘æ˜çš„ ä¸²è¡Œé€šä¿¡æ€»çº¿åè®®ï¼Œå¹¿æ³›ç”¨äºå¾®æ§åˆ¶å™¨ä¸å¤–å›´è®¾å¤‡ï¼ˆä¼ æ„Ÿå™¨ã€EEPROMã€æ˜¾ç¤ºå±ç­‰ï¼‰ä¹‹é—´çš„çŸ­è·ç¦»é€šä¿¡ã€‚\nç‰¹æ€§\tè¯´æ˜ é€šä¿¡æ–¹å¼\tåŒæ­¥ã€åŠåŒå·¥ã€ä¸²è¡Œé€šä¿¡ ä¼ è¾“çº¿\tä¸¤æ¡ä¿¡å·çº¿ï¼šSCLï¼ˆæ—¶é’Ÿï¼‰+ SDAï¼ˆæ•°æ®ï¼‰ è¿æ¥æ–¹å¼\tå¤šä¸»å¤šä»ï¼ˆMulti-Master, Multi-Slaveï¼‰ é€šä¿¡è·ç¦»\té€šå¸¸ä¸è¶…è¿‡ 1 ç±³ï¼ˆä¾èµ–é€Ÿç‡ä¸ç”µå®¹ï¼‰ é€šä¿¡é€Ÿç‡\tæ ‡å‡†æ¨¡å¼ï¼ˆ100 kHzï¼‰ã€å¿«é€Ÿæ¨¡å¼ï¼ˆ400 kHzï¼‰ã€é«˜é€Ÿæ¨¡å¼ï¼ˆ3.4 MHzï¼‰ã€è¶…é«˜é€Ÿæ¨¡å¼ï¼ˆ5 MHzï¼‰\nåè®® çº¿æ•° é€šä¿¡æ¨¡å¼ é€Ÿç‡ ä¼˜ç‚¹ å…¸å‹ç”¨é€” IÂ²C 2 åŒæ­¥åŠåŒå·¥ â‰¤ 3.4 Mbps ç®€å•ã€çœçº¿ã€å¤šä»æœº ä¼ æ„Ÿå™¨ã€é…ç½®æ¥å£ SPI 4+ å…¨åŒå·¥ â‰¤ 10 Mbps é«˜é€Ÿã€ç¨³å®š å­˜å‚¨å™¨ã€æ˜¾ç¤ºå± UART 2 å¼‚æ­¥ â‰¤ 1 Mbps ç®€å•ç‚¹å¯¹ç‚¹ ä¸²å£é€šä¿¡ è¯»å†™ IÂ²C çš„è¯»å†™è¿‡ç¨‹åˆ†ä¸º å†™æ“ä½œï¼ˆMaster â†’ Slaveï¼‰ å’Œ è¯»æ“ä½œï¼ˆSlave â†’ Masterï¼‰ ä¸¤ç§ã€‚ä¸‹é¢è¯¦ç»†è¯´æ˜ä¸¤ç§è¿‡ç¨‹çš„æ—¶åºä¸æ­¥éª¤ ğŸ‘‡\nå†™æ“ä½œï¼ˆä¸»æœºå‘ä»æœºå†™æ•°æ®ï¼‰ æ—¶åºæµç¨‹ START â†’ [Slave Address + Write(0)] â†’ ACK â†’ [Register Address] â†’ ACK â†’ [Data Byte] â†’ ACK â†’ STOP\næ­¥éª¤è¯´æ˜\nèµ·å§‹ä¿¡å·ï¼ˆSTARTï¼‰ ä¸»æœºæ‹‰ä½ SDAï¼ˆåœ¨ SCL ä¸ºé«˜æ—¶ï¼‰è¡¨ç¤ºé€šä¿¡å¼€å§‹ã€‚\nå‘é€ä»æœºåœ°å€ + å†™æ ‡å¿—ä½ï¼ˆR/W=0ï¼‰ 7 ä½ä»æœºåœ°å€ + 1 ä½æ–¹å‘ä½ï¼ˆ0 è¡¨ç¤ºå†™ï¼‰ã€‚\nç­‰å¾…ä»æœºåº”ç­”ï¼ˆACKï¼‰ ä»æœºæ£€æµ‹åˆ°è‡ªå·±çš„åœ°å€åï¼Œæ‹‰ä½ SDA è¡¨ç¤ºåº”ç­”ã€‚\nå‘é€å¯„å­˜å™¨åœ°å€ ä¸»æœºå‘é€æƒ³å†™å…¥çš„å¯„å­˜å™¨åœ°å€ï¼ˆä¾‹å¦‚æ¸©åº¦ä¼ æ„Ÿå™¨çš„é…ç½®å¯„å­˜å™¨åœ°å€ï¼‰ã€‚\nä»æœºå†æ¬¡åº”ç­”ï¼ˆACKï¼‰\nå‘é€æ•°æ®å­—èŠ‚ ä¸»æœºå‘é€è¦å†™å…¥çš„æ•°æ®ï¼ˆ8 ä½ï¼‰ã€‚\nä»æœºåº”ç­”ï¼ˆACKï¼‰\nå‘é€åœæ­¢ä¿¡å·ï¼ˆSTOPï¼‰ ä¸»æœºåœ¨ SCL é«˜ç”µå¹³æ—¶é‡Šæ”¾ SDAï¼ˆç”±ä½å˜é«˜ï¼‰ï¼Œè¡¨ç¤ºé€šä¿¡ç»“æŸã€‚\nè¯»æ“ä½œï¼ˆä¸»æœºä»ä»æœºè¯»æ•°æ®ï¼‰ IÂ²C è¯»æ“ä½œé€šå¸¸åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š\nç›´æ¥è¯»ï¼šéƒ¨åˆ†è®¾å¤‡ä¸Šç”µåé»˜è®¤æŒ‡å‘æŸä¸ªå¯„å­˜å™¨ï¼Œå¯ç›´æ¥è¯»å–ã€‚\nå¯„å­˜å™¨å¯»å€è¯»ï¼šå…ˆå†™å…¥å¯„å­˜å™¨åœ°å€ï¼Œå†é‡æ–°å¯åŠ¨è¯»ã€‚\nâ€œå¯„å­˜å™¨å¯»å€è¯»â€æµç¨‹ï¼ˆæœ€å¸¸è§ï¼‰ START â†’ [Slave Address + Write(0)] â†’ ACK â†’ [Register Address] â†’ ACK â†’ REPEATED START â†’ [Slave Address + Read(1)] â†’ ACK â†’ [Data Byte] â†’ NACK â†’ STOP\næ­¥éª¤è¯´æ˜\nå‘é€ START ä¸»æœºå‘èµ·é€šä¿¡ã€‚\nå‘é€ä»æœºåœ°å€ + å†™æ ‡å¿—ï¼ˆR/W=0ï¼‰ è¡¨ç¤ºè¦å†™å…¥å¯„å­˜å™¨åœ°å€ã€‚\nä»æœºåº”ç­”ï¼ˆACKï¼‰\nå‘é€è¦è¯»å–çš„å¯„å­˜å™¨åœ°å€\nä»æœºåº”ç­”ï¼ˆACKï¼‰\nå‘é€é‡å¤èµ·å§‹ä¿¡å·ï¼ˆREPEATED STARTï¼‰ ä¸»æœºä¸é‡Šæ”¾æ€»çº¿ï¼Œè€Œé‡æ–°å‘èµ·ä¸€æ¬¡é€šä¿¡ã€‚\nå‘é€ä»æœºåœ°å€ + è¯»æ ‡å¿—ï¼ˆR/W=1ï¼‰ è¡¨ç¤ºä¸»æœºè¦è¯»å–æ•°æ®ã€‚\nä»æœºåº”ç­”ï¼ˆACKï¼‰\nä»æœºå‘é€æ•°æ®å­—èŠ‚ï¼ˆ8 ä½ï¼‰ ä¸»æœºåœ¨ SCL é«˜ç”µå¹³æœŸé—´è¯»å– SDA ä¸Šçš„æ•°æ®ã€‚\nä¸»æœºå‘é€éåº”ç­”ï¼ˆNACKï¼‰ è¡¨ç¤ºè¯»å–ç»“æŸï¼ˆè‹¥éœ€è¯»å–å¤šä¸ªå­—èŠ‚ï¼Œåˆ™å‰é¢å­—èŠ‚éƒ½è¦å‘é€ ACKï¼Œæœ€åä¸€ä¸ªå­—èŠ‚å‘é€ NACKï¼‰ã€‚\nä¸»æœºå‘é€ STOP ä¿¡å· é€šä¿¡ç»“æŸã€‚\né™æ€IP else if (event_base == IP_EVENT) { if (event_id == IP_EVENT_STA_GOT_IP) { ip_event_got_ip_t *event = (ip_event_got_ip_t *)event_data; ESP_LOGI(TAG, \"Got IP: \" IPSTR, IP2STR(\u0026event-\u003eip_info.ip)); ESP_LOGI(TAG, \"Gateway: \" IPSTR, IP2STR(\u0026event-\u003eip_info.gw)); // ä¿®æ”¹ï¼šè§£æç½‘å…³IPï¼Œå¹¶è®¾ç½®é™æ€IP = å­ç½‘ + \".81\" uint8_t *gw_bytes = (uint8_t *)\u0026event-\u003eip_info.gw.addr; esp_netif_ip_info_t new_ip; new_ip.gw.addr = event-\u003eip_info.gw.addr; // ä¿ç•™ç½‘å…³ new_ip.netmask.addr = event-\u003eip_info.netmask.addr; // ä¿ç•™æ©ç  // ç”Ÿæˆ 192.168.80.81 ç±»ä¼¼çš„é™æ€IP new_ip.ip.addr = IPADDR4_INIT(IP4ADDR(gw_bytes[0], gw_bytes[1], gw_bytes[2], 81)); ESP_LOGI(TAG, \"Setting static IP to: \" IPSTR, IP2STR(\u0026new_ip.ip)); // å…³é—­ DHCP esp_netif_dhcpc_stop(sta_netif); // è®¾ç½®æ–°çš„é™æ€IP ESP_ERROR_CHECK(esp_netif_set_ip_info(sta_netif, \u0026new_ip)); } } è®¾ç½®å›ºå®šIP #include #include #include #include \"freertos/FreeRTOS.h\" #include \"freertos/task.h\" #include \"freertos/event_groups.h\" #include \"esp_wifi.h\" #include \"nvs_flash.h\" #include \"esp_log.h\" #include \"esp_event.h\" #include \"esp_netif.h\" #include \"wifi_provisioning/manager.h\" #include \"wifi_provisioning/scheme_ble.h\" #include \"lwip/ip4_addr.h\" #define TAG \"prov-demo\" static void wifi_init_sta(void); static bool static_ip_set = false; // é˜²æ­¢é‡å¤è®¾ç½®é™æ€IP /* WiFiäº‹ä»¶å›è°ƒ */ static void test_esp_event_cb(void *event_handler_arg, esp_event_base_t event_base, int32_t event_id, void *event_data) { if (event_base == WIFI_EVENT) { switch (event_id) { case WIFI_EVENT_STA_START: esp_wifi_connect(); ESP_LOGI(TAG, \"Wi-Fi STA start\"); break; case WIFI_EVENT_STA_CONNECTED: { ESP_LOGI(TAG, \"Wi-Fi connected\"); // âœ… åªåœ¨ç¬¬ä¸€æ¬¡è¿æ¥æ—¶è®¾ç½®é™æ€IP if (!static_ip_set) { esp_netif_t *netif = esp_netif_get_handle_from_ifkey(\"WIFI_STA_DEF\"); if (netif) { esp_netif_ip_info_t ip_info; esp_netif_get_ip_info(netif, \u0026ip_info); uint8_t *p = (uint8_t *)\u0026ip_info.gw.addr; ESP_LOGI(TAG, \"Gateway: %d.%d.%d.%d\", p[0], p[1], p[2], p[3]); // å›ºå®šé™æ€ IP = ç½‘å…³å‰ä¸‰æ®µ + .81 IP4_ADDR(\u0026ip_info.ip, p[0], p[1], p[2], 81); IP4_ADDR(\u0026ip_info.gw, p[0], p[1], p[2], 1); IP4_ADDR(\u0026ip_info.netmask, 255, 255, 255, 0); // åœæ­¢ DHCPï¼Œè®¾ç½®é™æ€ IP ESP_ERROR_CHECK(esp_netif_dhcpc_stop(netif)); ESP_ERROR_CHECK(esp_netif_set_ip_info(netif, \u0026ip_info)); static_ip_set = true; ESP_LOGI(TAG, \"Static IP set to: \" IPSTR, IP2STR(\u0026ip_info.ip)); } } break; } case WIFI_EVENT_STA_DISCONNECTED: ESP_LOGW(TAG, \"Wi-Fi disconnected, retrying...\"); esp_wifi_connect(); break; default: break; } } else if (event_base == WIFI_PROV_EVENT) { switch (event_id) { case WIFI_PROV_START: ESP_LOGI(TAG, \"Provisioning started via BLE\"); break; case WIFI_PROV_CRED_RECV: { wifi_sta_config_t *wifi_sta_cfg = (wifi_sta_config_t *)event_data; ESP_LOGI(TAG, \"Received Wi-Fi credentials\\n\\tSSID: %s\\n\\tPassword: %s\", (const char *)wifi_sta_cfg-\u003essid, (const char *)wifi_sta_cfg-\u003epassword); break; } case WIFI_PROV_CRED_FAIL: ESP_LOGE(TAG, \"Provisioning failed! Check credentials.\"); break; case WIFI_PROV_CRED_SUCCESS: ESP_LOGI(TAG, \"Provisioning successful!\"); break; case WIFI_PROV_END: ESP_LOGI(TAG, \"Provisioning finished, deinitializing manager\"); wifi_prov_mgr_deinit(); wifi_init_sta(); break; default: break; } } else if (event_base == IP_EVENT \u0026\u0026 event_id == IP_EVENT_STA_GOT_IP) { ip_event_got_ip_t *event = (ip_event_got_ip_t *)event_data; ESP_LOGI(TAG, \"Got IP: \" IPSTR, IP2STR(\u0026event-\u003eip_info.ip)); } } /* åˆå§‹åŒ– WiFi STA æ¨¡å¼ */ static void wifi_init_sta(void) { wifi_config_t wifi_config; esp_wifi_get_config(WIFI_IF_STA, \u0026wifi_config); ESP_ERROR_CHECK(esp_wifi_set_mode(WIFI_MODE_STA)); ESP_ERROR_CHECK(esp_wifi_start()); ESP_LOGI(TAG, \"Connecting to saved Wi-Fi: %s\", wifi_config.sta.ssid); esp_wifi_connect(); } /* ä¸»å‡½æ•° */ void app_main(void) { // åˆå§‹åŒ– NVS ESP_ERROR_CHECK(nvs_flash_init()); ESP_ERROR_CHECK(esp_netif_init()); ESP_ERROR_CHECK(esp_event_loop_create_default()); esp_netif_create_default_wifi_sta(); wifi_init_config_t cfg = WIFI_INIT_CONFIG_DEFAULT(); ESP_ERROR_CHECK(esp_wifi_init(\u0026cfg)); // æ³¨å†Œäº‹ä»¶ ESP_ERROR_CHECK(esp_event_handler_register(WIFI_EVENT, ESP_EVENT_ANY_ID, test_esp_event_cb, NULL)); ESP_ERROR_CHECK(esp_event_handler_register(WIFI_PROV_EVENT, ESP_EVENT_ANY_ID, test_esp_event_cb, NULL)); ESP_ERROR_CHECK(esp_event_handler_register(IP_EVENT, IP_EVENT_STA_GOT_IP, test_esp_event_cb, NULL)); /* é…ç½‘ç®¡ç†å™¨é…ç½® */ wifi_prov_mgr_config_t prov_cfg = { .scheme = wifi_prov_scheme_ble, .scheme_event_handler = WIFI_PROV_SCHEME_BLE_EVENT_HANDLER_FREE_BLE, }; /* åˆå§‹åŒ–é…ç½‘ç®¡ç†å™¨ */ ESP_ERROR_CHECK(wifi_prov_mgr_init(prov_cfg)); bool provisioned = false; ESP_ERROR_CHECK(wifi_prov_mgr_is_provisioned(\u0026provisioned)); if (provisioned) { ESP_LOGI(TAG, \"Device already provisioned, connecting to saved Wi-Fi...\"); wifi_prov_mgr_deinit(); // ä¸å†éœ€è¦é…ç½‘åŠŸèƒ½ wifi_init_sta(); // ç›´æ¥è¿æ¥ Wi-Fi } else { ESP_LOGI(TAG, \"Starting BLE provisioning...\"); // å¼€å§‹ BLE é…ç½‘ wifi_prov_mgr_start_provisioning(WIFI_PROV_SECURITY_1, \"123123\", // proof of possession \"PROV_HELLO_QF_LM2\", NULL); } while (1) { vTaskDelay(pdMS_TO_TICKS(1000)); } } é‡ç½®ESP æ‰¾åˆ°å¼€å‘æ¿ä¸Šçš„BOOTæŒ‰é”®å’ŒENï¼ˆä½¿èƒ½ï¼‰æŒ‰é”®ã€‚ å…ˆæŒ‰ä½BOOTæŒ‰é”®ä¸æ¾å¼€ï¼Œå†æŒ‰ä¸‹ENæŒ‰é”®ï¼Œéšåæ¾å¼€ENæŒ‰é”®ï¼Œä¿æŒBOOTæŒ‰é”®æŒ‰ä½å‡ ç§’åæ¾å¼€ï¼Œå³å¯å®Œæˆé‡ç½®ã€‚\n#include \"esp_system.h\" // é‡å¯ ESP32 esp_restart(); ä¼˜åŒ–\n#include #include #include #include \"freertos/FreeRTOS.h\" #include \"freertos/task.h\" #include \"freertos/event_groups.h\" #include \"esp_wifi.h\" #include \"nvs_flash.h\" #include \"esp_log.h\" #include \"esp_event.h\" #include \"esp_netif.h\" #include \"wifi_provisioning/manager.h\" #include \"wifi_provisioning/scheme_ble.h\" #include \"lwip/ip4_addr.h\" #define TAG \"prov-demo\" static bool static_ip_set = false; /* === Wi-Fi äº‹ä»¶å¤„ç†å›è°ƒ === */ static void wifi_event_handler(void *event_handler_arg, esp_event_base_t event_base, int32_t event_id, void *event_data) { if (event_base == WIFI_EVENT) { switch (event_id) { case WIFI_EVENT_STA_START: ESP_LOGI(TAG, \"Wi-Fi STA started\"); esp_wifi_connect(); break; case WIFI_EVENT_STA_DISCONNECTED: ESP_LOGW(TAG, \"Wi-Fi disconnected, retrying...\"); esp_wifi_connect(); break; default: break; } } else if (event_base == WIFI_PROV_EVENT) { switch (event_id) { case WIFI_PROV_START: ESP_LOGI(TAG, \"Provisioning started via BLE\"); break; case WIFI_PROV_CRED_RECV: { wifi_sta_config_t *wifi_sta_cfg = (wifi_sta_config_t *)event_data; ESP_LOGI(TAG, \"Received Wi-Fi credentials\\n\\tSSID: %s\\n\\tPassword: %s\", (const char *)wifi_sta_cfg-\u003essid, (const char *)wifi_sta_cfg-\u003epassword); break; } case WIFI_PROV_CRED_FAIL: ESP_LOGE(TAG, \"Provisioning failed! Check credentials.\"); break; case WIFI_PROV_CRED_SUCCESS: ESP_LOGI(TAG, \"Provisioning successful!\"); break; case WIFI_PROV_END: ESP_LOGI(TAG, \"Provisioning finished, deinitializing manager\"); wifi_prov_mgr_deinit(); esp_wifi_start(); break; default: break; } } else if (event_base == IP_EVENT \u0026\u0026 event_id == IP_EVENT_STA_GOT_IP) { ip_event_got_ip_t *event = (ip_event_got_ip_t *)event_data; esp_netif_ip_info_t ip_info = event-\u003eip_info; uint8_t *gw = (uint8_t *)\u0026ip_info.gw.addr; ESP_LOGI(TAG, \"Got IP: \" IPSTR, IP2STR(\u0026ip_info.ip)); ESP_LOGI(TAG, \"Gateway: %d.%d.%d.%d\", gw[0], gw[1], gw[2], gw[3]); // ä»…åœ¨ç¬¬ä¸€æ¬¡è¿æ¥æˆåŠŸæ—¶å°è¯•ä¿®æ”¹é™æ€ IP if (!static_ip_set) { if (ip_info.gw.addr == 0) { ESP_LOGW(TAG, \"Invalid gateway (0.0.0.0), restarting BLE provisioning...\"); vTaskDelay(pdMS_TO_TICKS(2000)); esp_restart(); // é‡æ–°å¯åŠ¨ç³»ç»Ÿï¼Œå›åˆ°é…ç½‘æ¨¡å¼ return; } esp_netif_t *netif = esp_netif_get_handle_from_ifkey(\"WIFI_STA_DEF\"); if (netif) { // åœæ­¢ DHCP å®¢æˆ·ç«¯ ESP_ERROR_CHECK(esp_netif_dhcpc_stop(netif)); // ä½¿ç”¨å½“å‰ç½‘å…³çš„å‰ä¸‰æ®µï¼Œå¹¶å›ºå®šæœ«å°¾ä¸º .83 IP4_ADDR(\u0026ip_info.ip, gw[0], gw[1], gw[2], 83); IP4_ADDR(\u0026ip_info.gw, gw[0], gw[1], gw[2], 1); IP4_ADDR(\u0026ip_info.netmask, 255, 255, 255, 0); // åº”ç”¨æ–°çš„ IP ESP_ERROR_CHECK(esp_netif_set_ip_info(netif, \u0026ip_info)); static_ip_set = true; ESP_LOGI(TAG, \"Static IP successfully set to: \" IPSTR, IP2STR(\u0026ip_info.ip)); // æ–­å¼€å¹¶é‡æ–°è¿æ¥ Wi-Fi ä»¥ä½¿ç”¨æ–° IP esp_wifi_disconnect(); vTaskDelay(pdMS_TO_TICKS(500)); esp_wifi_connect(); } } } } /* === Wi-Fi åˆå§‹åŒ– === */ static void wifi_init_sta(void) { wifi_config_t wifi_cfg = {0}; esp_wifi_get_config(WIFI_IF_STA, \u0026wifi_cfg); ESP_ERROR_CHECK(esp_wifi_set_mode(WIFI_MODE_STA)); ESP_ERROR_CHECK(esp_wifi_set_config(WIFI_IF_STA, \u0026wifi_cfg)); ESP_ERROR_CHECK(esp_wifi_start()); esp_wifi_connect(); ESP_LOGI(TAG, \"Connecting to saved Wi-Fi: %s\", wifi_cfg.sta.ssid); } /* === ä¸»å‡½æ•° === */ void app_main(void) { // åˆå§‹åŒ– NVS ESP_ERROR_CHECK(nvs_flash_init()); ESP_ERROR_CHECK(esp_netif_init()); ESP_ERROR_CHECK(esp_event_loop_create_default()); esp_netif_create_default_wifi_sta(); wifi_init_config_t cfg = WIFI_INIT_CONFIG_DEFAULT(); ESP_ERROR_CHECK(esp_wifi_init(\u0026cfg)); // æ³¨å†Œäº‹ä»¶ ESP_ERROR_CHECK(esp_event_handler_register(WIFI_EVENT, ESP_EVENT_ANY_ID, wifi_event_handler, NULL)); ESP_ERROR_CHECK(esp_event_handler_register(WIFI_PROV_EVENT, ESP_EVENT_ANY_ID, wifi_event_handler, NULL)); ESP_ERROR_CHECK(esp_event_handler_register(IP_EVENT, IP_EVENT_STA_GOT_IP, wifi_event_handler, NULL)); // BLE é…ç½‘é…ç½® wifi_prov_mgr_config_t prov_cfg = { .scheme = wifi_prov_scheme_ble, .scheme_event_handler = WIFI_PROV_SCHEME_BLE_EVENT_HANDLER_FREE_BLE, }; ESP_ERROR_CHECK(wifi_prov_mgr_init(prov_cfg)); bool provisioned = false; ESP_ERROR_CHECK(wifi_prov_mgr_is_provisioned(\u0026provisioned)); if (provisioned) { ESP_LOGI(TAG, \"Already provisioned, connecting to Wi-Fi...\"); wifi_prov_mgr_deinit(); wifi_init_sta(); } else { ESP_LOGI(TAG, \"Starting BLE provisioning...\"); wifi_prov_mgr_start_provisioning(WIFI_PROV_SECURITY_1, \"123123\", \"PROV_HELLO_QF_LM23\", NULL); } while (1) { vTaskDelay(pdMS_TO_TICKS(1000)); } } å¤šesp32é€šè®¯ æ¥æ”¶ç«¯\n#include #include #include \"freertos/FreeRTOS.h\" #include \"freertos/task.h\" #include \"esp_wifi.h\" #include \"esp_event.h\" #include \"esp_log.h\" #include \"esp_system.h\" #include \"nvs_flash.h\" #include \"lwip/err.h\" #include \"lwip/sockets.h\" #include \"lwip/sys.h\" #include \"lwip/netdb.h\" #include \"driver/i2s_std.h\" #include \"driver/gpio.h\" static const char *TAG = \"audio_receiver\"; // WiFié…ç½® #define WIFI_SSID \"RTCT2300\" #define WIFI_PASS \"123123*zxcvb\" // UDPé…ç½® #define UDP_PORT 1234 #define BUF_SIZE (1023 * 1 * 32 / 8) // MAX98357Aå¼•è„š #define MAX_DIN GPIO_NUM_15 #define MAX_BCLK GPIO_NUM_16 #define MAX_LRC GPIO_NUM_17 uint8_t audio_buf[BUF_SIZE]; i2s_chan_handle_t tx_handle; int sock = -1; bool wifi_connected = false; // æå‰å£°æ˜å‡½æ•° static void wifi_event_handler(void *arg, esp_event_base_t event_base, int32_t event_id, void *event_data); static void init_udp_socket(void); static void wifi_init(void) { ESP_LOGI(TAG, \"åˆå§‹åŒ–WiFi...\"); // åˆå§‹åŒ–TCP/IPæ ˆ ESP_ERROR_CHECK(esp_netif_init()); // åˆ›å»ºäº‹ä»¶å¾ªç¯ ESP_ERROR_CHECK(esp_event_loop_create_default()); // åˆ›å»ºé»˜è®¤çš„STAç½‘ç»œæ¥å£ esp_netif_t *sta_netif = esp_netif_create_default_wifi_sta(); assert(sta_netif); // åˆå§‹åŒ–WiFi wifi_init_config_t cfg = WIFI_INIT_CONFIG_DEFAULT(); ESP_ERROR_CHECK(esp_wifi_init(\u0026cfg)); // æ³¨å†Œäº‹ä»¶å¤„ç†å™¨ ESP_ERROR_CHECK(esp_event_handler_instance_register(WIFI_EVENT, ESP_EVENT_ANY_ID, \u0026wifi_event_handler, NULL, NULL)); ESP_ERROR_CHECK(esp_event_handler_instance_register(IP_EVENT, IP_EVENT_STA_GOT_IP, \u0026wifi_event_handler, NULL, NULL)); // é…ç½®WiFi wifi_config_t wifi_config = { .sta = { .ssid = WIFI_SSID, .password = WIFI_PASS, .threshold.authmode = WIFI_AUTH_WPA2_PSK, }, }; ESP_ERROR_CHECK(esp_wifi_set_mode(WIFI_MODE_STA)); ESP_ERROR_CHECK(esp_wifi_set_config(WIFI_IF_STA, \u0026wifi_config)); ESP_ERROR_CHECK(esp_wifi_start()); ESP_LOGI(TAG, \"WiFiåˆå§‹åŒ–å®Œæˆï¼Œå¼€å§‹è¿æ¥...\"); } // WiFiäº‹ä»¶å¤„ç† static void wifi_event_handler(void *arg, esp_event_base_t event_base, int32_t event_id, void *event_data) { ESP_LOGI(TAG, \"æ”¶åˆ°äº‹ä»¶: %s, äº‹ä»¶ID: %ld\", event_base, event_id); if (event_base == WIFI_EVENT \u0026\u0026 event_id == WIFI_EVENT_STA_START) { ESP_LOGI(TAG, \"WiFi STAå¯åŠ¨\"); esp_wifi_connect(); } else if (event_base == WIFI_EVENT \u0026\u0026 event_id == WIFI_EVENT_STA_CONNECTED) { ESP_LOGI(TAG, \"WiFiå·²è¿æ¥åˆ°AP\"); } else if (event_base == WIFI_EVENT \u0026\u0026 event_id == WIFI_EVENT_STA_DISCONNECTED) { wifi_connected = false; ESP_LOGI(TAG, \"WiFiæ–­å¼€è¿æ¥ï¼Œ5ç§’åå°è¯•é‡è¿...\"); vTaskDelay(pdMS_TO_TICKS(5000)); esp_wifi_connect(); } else if (event_base == IP_EVENT \u0026\u0026 event_id == IP_EVENT_STA_GOT_IP) { ip_event_got_ip_t *event = (ip_event_got_ip_t *)event_data; ESP_LOGI(TAG, \"WiFiè¿æ¥æˆåŠŸï¼Œè·å–åˆ°IPåœ°å€: \" IPSTR, IP2STR(\u0026event-\u003eip_info.ip)); wifi_connected = true; // åˆå§‹åŒ–UDP socket init_udp_socket(); } } // åˆå§‹åŒ–UDP socket static void init_udp_socket(void) { if (sock \u003e= 0) { close(sock); sock = -1; } sock = socket(AF_INET, SOCK_DGRAM, IPPROTO_IP); if (sock \u003c 0) { ESP_LOGE(TAG, \"åˆ›å»ºsocketå¤±è´¥: %s\", strerror(errno)); return; } // è®¾ç½®socketé€‰é¡¹ int opt = 1; setsockopt(sock, SOL_SOCKET, SO_REUSEADDR, \u0026opt, sizeof(opt)); struct sockaddr_in server_addr; memset(\u0026server_addr, 0, sizeof(server_addr)); server_addr.sin_family = AF_INET; server_addr.sin_port = htons(UDP_PORT); server_addr.sin_addr.s_addr = htonl(INADDR_ANY); if (bind(sock, (struct sockaddr *)\u0026server_addr, sizeof(server_addr)) \u003c 0) { ESP_LOGE(TAG, \"ç»‘å®šç«¯å£å¤±è´¥: %s\", strerror(errno)); close(sock); sock = -1; return; } ESP_LOGI(TAG, \"UDPæ¥æ”¶ç«¯å¯åŠ¨æˆåŠŸï¼Œç›‘å¬ç«¯å£: %d\", UDP_PORT); } // I2S TXåˆå§‹åŒ– static void i2s_tx_init(void) { ESP_LOGI(TAG, \"åˆå§‹åŒ–I2S TX...\"); i2s_chan_config_t chan_cfg = I2S_CHANNEL_DEFAULT_CONFIG(I2S_NUM_0, I2S_ROLE_MASTER); chan_cfg.dma_frame_num = 1023; esp_err_t ret = i2s_new_channel(\u0026chan_cfg, \u0026tx_handle, NULL); if (ret != ESP_OK) { ESP_LOGE(TAG, \"åˆ›å»ºI2Sé€šé“å¤±è´¥: %d\", ret); return; } i2s_std_config_t std_cfg = { .clk_cfg = I2S_STD_CLK_DEFAULT_CONFIG(44100), .slot_cfg = I2S_STD_MSB_SLOT_DEFAULT_CONFIG(I2S_DATA_BIT_WIDTH_32BIT, I2S_SLOT_MODE_MONO), .gpio_cfg = { .mclk = I2S_GPIO_UNUSED, .din = I2S_GPIO_UNUSED, .bclk = MAX_BCLK, .ws = MAX_LRC, .dout = MAX_DIN, .invert_flags = { .mclk_inv = false, .bclk_inv = false, .ws_inv = false, }, }, }; ret = i2s_channel_init_std_mode(tx_handle, \u0026std_cfg); if (ret != ESP_OK) { ESP_LOGE(TAG, \"åˆå§‹åŒ–I2Sæ ‡å‡†æ¨¡å¼å¤±è´¥: %d\", ret); return; } ret = i2s_channel_enable(tx_handle); if (ret != ESP_OK) { ESP_LOGE(TAG, \"å¯ç”¨I2Sé€šé“å¤±è´¥: %d\", ret); return; } ESP_LOGI(TAG, \"I2S TXåˆå§‹åŒ–å®Œæˆ\"); } // UDPæ¥æ”¶ä»»åŠ¡ static void udp_receive_task(void *args) { ESP_LOGI(TAG, \"UDPæ¥æ”¶ä»»åŠ¡å¯åŠ¨\"); while (1) { if (!wifi_connected) { ESP_LOGW(TAG, \"ç­‰å¾…WiFiè¿æ¥...\"); vTaskDelay(pdMS_TO_TICKS(2000)); continue; } if (sock \u003c 0) { ESP_LOGW(TAG, \"ç­‰å¾…UDP socketåˆå§‹åŒ–...\"); vTaskDelay(pdMS_TO_TICKS(1000)); continue; } struct sockaddr_in source_addr; socklen_t addr_len = sizeof(source_addr); int len = recvfrom(sock, audio_buf, BUF_SIZE, 0, (struct sockaddr *)\u0026source_addr, \u0026addr_len); if (len \u003e 0) { char source_ip[16]; inet_ntoa_r(source_addr.sin_addr, source_ip, sizeof(source_ip) - 1); ESP_LOGI(TAG, \"æ”¶åˆ°æ¥è‡ª %s çš„éŸ³é¢‘æ•°æ®ï¼Œé•¿åº¦: %d å­—èŠ‚\", source_ip, len); // æ’­æ”¾æ¥æ”¶åˆ°çš„éŸ³é¢‘æ•°æ® size_t bytes_written = 0; esp_err_t ret = i2s_channel_write(tx_handle, audio_buf, len, \u0026bytes_written, portMAX_DELAY); if (ret != ESP_OK) { ESP_LOGE(TAG, \"I2Så†™å…¥å¤±è´¥: %d\", ret); } } else if (len \u003c 0) { if (errno != EAGAIN \u0026\u0026 errno != EWOULDBLOCK) { ESP_LOGE(TAG, \"æ¥æ”¶æ•°æ®å¤±è´¥: %s\", strerror(errno)); } } vTaskDelay(pdMS_TO_TICKS(1)); } } void app_main(void) { ESP_LOGI(TAG, \"=== éŸ³é¢‘æ¥æ”¶ç«¯å¯åŠ¨ ===\"); // åˆå§‹åŒ–NVS esp_err_t ret = nvs_flash_init(); if (ret == ESP_ERR_NVS_NO_FREE_PAGES || ret == ESP_ERR_NVS_NEW_VERSION_FOUND) { ESP_LOGI(TAG, \"æ“¦é™¤NVS...\"); ESP_ERROR_CHECK(nvs_flash_erase()); ret = nvs_flash_init(); } ESP_ERROR_CHECK(ret); ESP_LOGI(TAG, \"NVSåˆå§‹åŒ–å®Œæˆ\"); // åˆå§‹åŒ–I2S i2s_tx_init(); // åˆå§‹åŒ–WiFi wifi_init(); // åˆ›å»ºUDPæ¥æ”¶ä»»åŠ¡ xTaskCreate(udp_receive_task, \"udp_receive\", 8192, NULL, 5, NULL); ESP_LOGI(TAG, \"ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼Œç­‰å¾…WiFiè¿æ¥...\"); // ä¿æŒä»»åŠ¡è¿è¡Œ while (1) { if (wifi_connected) { ESP_LOGI(TAG, \"ç³»ç»Ÿè¿è¡Œä¸­ - WiFiå·²è¿æ¥ï¼Œç­‰å¾…éŸ³é¢‘æ•°æ®...\"); } else { ESP_LOGI(TAG, \"ç³»ç»Ÿè¿è¡Œä¸­ - ç­‰å¾…WiFiè¿æ¥...\"); } vTaskDelay(pdMS_TO_TICKS(10000)); } } CMakeLists.txt\nidf_component_register(SRCS \"i2s_std_example_main.c\" PRIV_REQUIRES esp_driver_i2s esp_driver_gpio i2s_examples_common INCLUDE_DIRS \".\" REQUIRES esp_wifi esp_event esp_netif nvs_flash lwip driver esp_driver_i2s) æ¥æ”¶ç«¯è¿è¡Œ\nI (13340) wifi:dp: 1, bi: 102400, li: 3, scale listen interval from 307200 us to 307200 us I (13350) audio_receiver: æ”¶åˆ°äº‹ä»¶: WIFI_EVENT, äº‹ä»¶ID: 4 I (13350) audio_receiver: WiFiå·²è¿æ¥åˆ°AP I (13360) wifi:idx:0 (ifx:0, 50:eb:f6:ae:8e:60), tid:0, ssn:1, winSize:64 I (13410) wifi:AP's beacon interval = 102400 us, DTIM period = 1 I (14370) esp_netif_handlers: sta ip: 192.168.80.39, mask: 255.255.255.0, gw: 192.168.80.1 I (14370) audio_receiver: æ”¶åˆ°äº‹ä»¶: IP_EVENT, äº‹ä»¶ID: 0 I (14370) audio_receiver: WiFiè¿æ¥æˆåŠŸï¼Œè·å–åˆ°IPåœ°å€: 192.168.80.39 I (14380) audio_receiver: UDPæ¥æ”¶ç«¯å¯åŠ¨æˆåŠŸï¼Œç›‘å¬ç«¯å£: 1234 I (20790) audio_receiver: ç³»ç»Ÿè¿è¡Œä¸­ - WiFiå·²è¿æ¥ï¼Œç­‰å¾…éŸ³é¢‘æ•°æ®... å‘é€ç«¯\n#include #include #include \"freertos/FreeRTOS.h\" #include \"freertos/task.h\" #include \"freertos/event_groups.h\" #include \"esp_wifi.h\" #include \"esp_event.h\" #include \"esp_log.h\" #include \"esp_system.h\" #include \"nvs_flash.h\" #include \"lwip/err.h\" #include \"lwip/sockets.h\" #include \"lwip/sys.h\" #include \"lwip/netdb.h\" #include \"driver/i2s_std.h\" #include \"driver/gpio.h\" static const char *TAG = \"audio_udp\"; // WiFié…ç½® - è¯·æ ¹æ®ä½ çš„ç½‘ç»œä¿®æ”¹ #define WIFI_SSID \"RTCT2300\" #define WIFI_PASS \"123123*zxcvb\" // UDPé…ç½® - è¯·ä¿®æ”¹ä¸ºæ¥æ”¶ç«¯çš„IPåœ°å€ #define UDP_SERVER_IP \"192.168.80.39\" // æ¥æ”¶ç«¯ESP32çš„IPåœ°å€ #define UDP_PORT 1234 // UDPç«¯å£å· #define UDP_PACKET_SIZE 1024 // UDPåŒ…å¤§å° // INMPå¼•è„š #define INMP_SD GPIO_NUM_13 #define INMP_SCK GPIO_NUM_14 #define INMP_WS GPIO_NUM_27 // MAX98357Aå¼•è„š #define MAX_DIN GPIO_NUM_15 #define MAX_BCLK GPIO_NUM_16 #define MAX_LRC GPIO_NUM_17 // éŸ³é¢‘é…ç½® #define SAMPLE_RATE 44100 #define BUF_SIZE (1023 * 1 * 32 / 8) #define VOLUME_THRESHOLD 1000 // éŸ³é‡é˜ˆå€¼ï¼Œè¶…è¿‡æ­¤å€¼è®¤ä¸ºæœ‰å£°éŸ³è¾“å…¥ // å…¨å±€å˜é‡ uint8_t audio_buf[BUF_SIZE]; i2s_chan_handle_t rx_handle; i2s_chan_handle_t tx_handle; int sock = -1; struct sockaddr_in dest_addr; bool wifi_connected = false; // æå‰å£°æ˜å‡½æ•° static void wifi_event_handler(void *arg, esp_event_base_t event_base, int32_t event_id, void *event_data); static void init_udp_socket(void); // åˆå§‹åŒ–WiFi static void wifi_init(void) { ESP_LOGI(TAG, \"åˆå§‹åŒ–WiFi...\"); ESP_ERROR_CHECK(esp_netif_init()); ESP_ERROR_CHECK(esp_event_loop_create_default()); esp_netif_create_default_wifi_sta(); wifi_init_config_t cfg = WIFI_INIT_CONFIG_DEFAULT(); ESP_ERROR_CHECK(esp_wifi_init(\u0026cfg)); // æ³¨å†Œäº‹ä»¶å¤„ç†å™¨ ESP_ERROR_CHECK(esp_event_handler_instance_register(WIFI_EVENT, ESP_EVENT_ANY_ID, \u0026wifi_event_handler, NULL, NULL)); ESP_ERROR_CHECK(esp_event_handler_instance_register(IP_EVENT, IP_EVENT_STA_GOT_IP, \u0026wifi_event_handler, NULL, NULL)); wifi_config_t wifi_config = { .sta = { .ssid = WIFI_SSID, .password = WIFI_PASS, }, }; ESP_ERROR_CHECK(esp_wifi_set_mode(WIFI_MODE_STA)); ESP_ERROR_CHECK(esp_wifi_set_config(WIFI_IF_STA, \u0026wifi_config)); ESP_ERROR_CHECK(esp_wifi_start()); ESP_LOGI(TAG, \"WiFiåˆå§‹åŒ–å®Œæˆï¼Œæ­£åœ¨è¿æ¥...\"); } // WiFiäº‹ä»¶å¤„ç† static void wifi_event_handler(void *arg, esp_event_base_t event_base, int32_t event_id, void *event_data) { if (event_base == WIFI_EVENT \u0026\u0026 event_id == WIFI_EVENT_STA_START) { ESP_LOGI(TAG, \"WiFi STAå¯åŠ¨ï¼Œå¼€å§‹è¿æ¥...\"); esp_wifi_connect(); } else if (event_base == WIFI_EVENT \u0026\u0026 event_id == WIFI_EVENT_STA_DISCONNECTED) { wifi_connected = false; ESP_LOGI(TAG, \"WiFiæ–­å¼€è¿æ¥ï¼Œ5ç§’åå°è¯•é‡è¿...\"); vTaskDelay(pdMS_TO_TICKS(5000)); esp_wifi_connect(); } else if (event_base == IP_EVENT \u0026\u0026 event_id == IP_EVENT_STA_GOT_IP) { ip_event_got_ip_t *event = (ip_event_got_ip_t *)event_data; ESP_LOGI(TAG, \"WiFiè¿æ¥æˆåŠŸï¼ŒIPåœ°å€: \" IPSTR, IP2STR(\u0026event-\u003eip_info.ip)); wifi_connected = true; // åˆå§‹åŒ–UDP socket init_udp_socket(); } } // åˆå§‹åŒ–UDP socket static void init_udp_socket(void) { if (sock \u003e= 0) { close(sock); sock = -1; } sock = socket(AF_INET, SOCK_DGRAM, IPPROTO_IP); if (sock \u003c 0) { ESP_LOGE(TAG, \"åˆ›å»ºsocketå¤±è´¥: %s\", strerror(errno)); return; } // è®¾ç½®ç›®æ ‡åœ°å€ memset(\u0026dest_addr, 0, sizeof(dest_addr)); dest_addr.sin_addr.s_addr = inet_addr(UDP_SERVER_IP); dest_addr.sin_family = AF_INET; dest_addr.sin_port = htons(UDP_PORT); ESP_LOGI(TAG, \"UDP socketåˆå§‹åŒ–å®Œæˆï¼Œç›®æ ‡: %s:%d\", UDP_SERVER_IP, UDP_PORT); } // è®¡ç®—éŸ³é‡ï¼ˆRMSå€¼ï¼‰ static int32_t calculate_volume(int32_t *samples, int count) { int64_t sum = 0; for (int i = 0; i \u003c count; i++) { // å–ç»å¯¹å€¼å¹¶ç´¯åŠ  int32_t sample = samples[i] \u003e\u003e 8; // 24ä½æ•°æ®åœ¨32ä½ä¸­çš„é«˜ä½ï¼Œéœ€è¦å³ç§» if (sample \u003c 0) sample = -sample; sum += sample; } return (int32_t)(sum / count); } // åˆå§‹åŒ–I2S RXï¼ˆINMP441ï¼‰ static void i2s_rx_init(void) { i2s_chan_config_t chan_cfg = I2S_CHANNEL_DEFAULT_CONFIG(I2S_NUM_0, I2S_ROLE_MASTER); chan_cfg.dma_frame_num = 1023; esp_err_t ret = i2s_new_channel(\u0026chan_cfg, NULL, \u0026rx_handle); if (ret != ESP_OK) { ESP_LOGE(TAG, \"åˆ›å»ºI2S RXé€šé“å¤±è´¥: %d\", ret); return; } i2s_std_config_t std_cfg = { .clk_cfg = I2S_STD_CLK_DEFAULT_CONFIG(SAMPLE_RATE), .slot_cfg = I2S_STD_MSB_SLOT_DEFAULT_CONFIG(I2S_DATA_BIT_WIDTH_32BIT, I2S_SLOT_MODE_MONO), .gpio_cfg = { .mclk = I2S_GPIO_UNUSED, .dout = I2S_GPIO_UNUSED, .bclk = INMP_SCK, .ws = INMP_WS, .din = INMP_SD, .invert_flags = { .mclk_inv = false, .bclk_inv = false, .ws_inv = false, }, }, }; ret = i2s_channel_init_std_mode(rx_handle, \u0026std_cfg); if (ret != ESP_OK) { ESP_LOGE(TAG, \"åˆå§‹åŒ–I2S RXå¤±è´¥: %d\", ret); return; } i2s_channel_enable(rx_handle); ESP_LOGI(TAG, \"I2S RXåˆå§‹åŒ–å®Œæˆ\"); } // åˆå§‹åŒ–I2S TXï¼ˆMAX98357Aï¼‰ static void i2s_tx_init(void) { i2s_chan_config_t chan_cfg = I2S_CHANNEL_DEFAULT_CONFIG(I2S_NUM_1, I2S_ROLE_MASTER); chan_cfg.dma_frame_num = 1023; esp_err_t ret = i2s_new_channel(\u0026chan_cfg, \u0026tx_handle, NULL); if (ret != ESP_OK) { ESP_LOGE(TAG, \"åˆ›å»ºI2S TXé€šé“å¤±è´¥: %d\", ret); return; } i2s_std_config_t std_cfg = { .clk_cfg = I2S_STD_CLK_DEFAULT_CONFIG(SAMPLE_RATE), .slot_cfg = I2S_STD_MSB_SLOT_DEFAULT_CONFIG(I2S_DATA_BIT_WIDTH_32BIT, I2S_SLOT_MODE_MONO), .gpio_cfg = { .mclk = I2S_GPIO_UNUSED, .din = I2S_GPIO_UNUSED, .bclk = MAX_BCLK, .ws = MAX_LRC, .dout = MAX_DIN, .invert_flags = { .mclk_inv = false, .bclk_inv = false, .ws_inv = false, }, }, }; ret = i2s_channel_init_std_mode(tx_handle, \u0026std_cfg); if (ret != ESP_OK) { ESP_LOGE(TAG, \"åˆå§‹åŒ–I2S TXå¤±è´¥: %d\", ret); return; } i2s_channel_enable(tx_handle); ESP_LOGI(TAG, \"I2S TXåˆå§‹åŒ–å®Œæˆ\"); } // éŸ³é¢‘å¤„ç†ä»»åŠ¡ static void audio_task(void *args) { size_t bytes_read = 0; const float gain = 4.5f; TickType_t last_volume_print = 0; int32_t max_volume = 0; ESP_LOGI(TAG, \"éŸ³é¢‘å¤„ç†ä»»åŠ¡å¯åŠ¨\"); while (1) { if (!wifi_connected || sock \u003c 0) { ESP_LOGW(TAG, \"ç­‰å¾…WiFiè¿æ¥å’ŒUDPåˆå§‹åŒ–...\"); vTaskDelay(pdMS_TO_TICKS(1000)); continue; } if (i2s_channel_read(rx_handle, audio_buf, BUF_SIZE, \u0026bytes_read, 1000) == ESP_OK) { int32_t *samples = (int32_t *)audio_buf; int samples_count = bytes_read / sizeof(int32_t); // è®¡ç®—å½“å‰éŸ³é‡ int32_t current_volume = calculate_volume(samples, samples_count); if (current_volume \u003e max_volume) { max_volume = current_volume; } // æ¯2ç§’æ‰“å°ä¸€æ¬¡æœ€å¤§éŸ³é‡ï¼ˆå¦‚æœæœ‰å£°éŸ³è¾“å…¥ï¼‰ TickType_t current_tick = xTaskGetTickCount(); if (current_tick - last_volume_print \u003e= pdMS_TO_TICKS(2000)) { if (max_volume \u003e VOLUME_THRESHOLD) { ESP_LOGI(TAG, \"æ£€æµ‹åˆ°å£°éŸ³è¾“å…¥ï¼ŒéŸ³é‡å€¼: %ld\", max_volume); } max_volume = 0; last_volume_print = current_tick; } // åº”ç”¨å¢ç›Š for (int i = 0; i \u003c samples_count; i++) { int64_t temp = (int64_t)(samples[i] * gain); if (temp \u003e INT32_MAX) temp = INT32_MAX; else if (temp \u003c INT32_MIN) temp = INT32_MIN; samples[i] = (int32_t)temp; } // é€šè¿‡UDPå‘é€éŸ³é¢‘æ•°æ® int err = sendto(sock, audio_buf, bytes_read, 0, (struct sockaddr *)\u0026dest_addr, sizeof(dest_addr)); if (err \u003c 0) { ESP_LOGE(TAG, \"UDPå‘é€å¤±è´¥: %s\", strerror(errno)); } // æœ¬åœ°æ’­æ”¾ size_t bytes_written = 0; i2s_channel_write(tx_handle, audio_buf, bytes_read, \u0026bytes_written, 1000); } vTaskDelay(pdMS_TO_TICKS(1)); } } void app_main(void) { ESP_LOGI(TAG, \"=== éŸ³é¢‘UDPä¼ è¾“ç³»ç»Ÿå¯åŠ¨ ===\"); // åˆå§‹åŒ–NVS esp_err_t ret = nvs_flash_init(); if (ret == ESP_ERR_NVS_NO_FREE_PAGES || ret == ESP_ERR_NVS_NEW_VERSION_FOUND) { ESP_LOGI(TAG, \"æ“¦é™¤NVS...\"); ESP_ERROR_CHECK(nvs_flash_erase()); ret = nvs_flash_init(); } ESP_ERROR_CHECK(ret); ESP_LOGI(TAG, \"NVSåˆå§‹åŒ–å®Œæˆ\"); // åˆå§‹åŒ–WiFi wifi_init(); // åˆå§‹åŒ–I2S i2s_tx_init(); i2s_rx_init(); // åˆ›å»ºéŸ³é¢‘å¤„ç†ä»»åŠ¡ xTaskCreate(audio_task, \"audio_task\", 8192, NULL, 5, NULL); ESP_LOGI(TAG, \"ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼Œç­‰å¾…WiFiè¿æ¥...\"); } CMakeLists.txt\nidf_component_register(SRCS \"i2s_std_example_main.c\" PRIV_REQUIRES esp_driver_i2s esp_driver_gpio i2s_examples_common INCLUDE_DIRS \".\" REQUIRES esp_wifi esp_event esp_netif nvs_flash lwip driver esp_driver_i2s esp_driver_gpio freertos esp_system log) æ•°æ®åŒ… å‘é€\n#include #include #include #include \"freertos/FreeRTOS.h\" #include \"freertos/task.h\" #include \"freertos/event_groups.h\" #include \"esp_wifi.h\" #include \"esp_event.h\" #include \"esp_log.h\" #include \"esp_system.h\" #include \"nvs_flash.h\" #include \"lwip/err.h\" #include \"lwip/sockets.h\" #include \"lwip/sys.h\" #include \"lwip/netdb.h\" #include \"driver/i2s_std.h\" #include \"driver/gpio.h\" static const char *TAG = \"audio_udp\"; // WiFié…ç½® #define WIFI_SSID \"RTCT2300\" #define WIFI_PASS \"123123*zxcvb\" // UDPé…ç½® - ä½¿ç”¨æ¥æ”¶ç«¯çš„å®é™…IPåœ°å€ #define UDP_SERVER_IP \"192.168.80.39\" // æ¥æ”¶ç«¯å®é™…IP #define UDP_PORT 1234 // INMPå¼•è„š #define INMP_SD GPIO_NUM_13 #define INMP_SCK GPIO_NUM_14 #define INMP_WS GPIO_NUM_27 // MAX98357Aå¼•è„š #define MAX_DIN GPIO_NUM_15 #define MAX_BCLK GPIO_NUM_16 #define MAX_LRC GPIO_NUM_17 // éŸ³é¢‘é…ç½® #define SAMPLE_RATE 44100 #define BUF_SIZE (1023 * 1 * 32 / 8) #define VOLUME_THRESHOLD 1000 // å…¨å±€å˜é‡ uint8_t audio_buf[BUF_SIZE]; i2s_chan_handle_t rx_handle; i2s_chan_handle_t tx_handle; int sock = -1; struct sockaddr_in dest_addr; bool wifi_connected = false; int send_count = 0; // æå‰å£°æ˜å‡½æ•° static void wifi_event_handler(void *arg, esp_event_base_t event_base, int32_t event_id, void *event_data); static void init_udp_socket(void); static void connection_test(void); // æ·»åŠ è¿™è¡Œå£°æ˜ // è¿æ¥æµ‹è¯•å‡½æ•°ï¼ˆæ”¾åœ¨å‰é¢ï¼‰ static void connection_test(void) { char test_packet[] = \"AUDIO_TEST\"; int err = sendto(sock, test_packet, strlen(test_packet), 0, (struct sockaddr *)\u0026dest_addr, sizeof(dest_addr)); if (err \u003c 0) { ESP_LOGE(TAG, \"è¿æ¥æµ‹è¯•å¤±è´¥: %s\", strerror(errno)); } else { ESP_LOGI(TAG, \"è¿æ¥æµ‹è¯•åŒ…å‘é€æˆåŠŸ\"); } } // åˆå§‹åŒ–WiFi static void wifi_init(void) { ESP_LOGI(TAG, \"åˆå§‹åŒ–WiFi...\"); ESP_ERROR_CHECK(esp_netif_init()); ESP_ERROR_CHECK(esp_event_loop_create_default()); esp_netif_create_default_wifi_sta(); wifi_init_config_t cfg = WIFI_INIT_CONFIG_DEFAULT(); ESP_ERROR_CHECK(esp_wifi_init(\u0026cfg)); // æ³¨å†Œäº‹ä»¶å¤„ç†å™¨ ESP_ERROR_CHECK(esp_event_handler_instance_register(WIFI_EVENT, ESP_EVENT_ANY_ID, \u0026wifi_event_handler, NULL, NULL)); ESP_ERROR_CHECK(esp_event_handler_instance_register(IP_EVENT, IP_EVENT_STA_GOT_IP, \u0026wifi_event_handler, NULL, NULL)); wifi_config_t wifi_config = { .sta = { .ssid = WIFI_SSID, .password = WIFI_PASS, }, }; ESP_ERROR_CHECK(esp_wifi_set_mode(WIFI_MODE_STA)); ESP_ERROR_CHECK(esp_wifi_set_config(WIFI_IF_STA, \u0026wifi_config)); ESP_ERROR_CHECK(esp_wifi_start()); ESP_LOGI(TAG, \"WiFiåˆå§‹åŒ–å®Œæˆï¼Œæ­£åœ¨è¿æ¥...\"); } // WiFiäº‹ä»¶å¤„ç† static void wifi_event_handler(void *arg, esp_event_base_t event_base, int32_t event_id, void *event_data) { if (event_base == WIFI_EVENT \u0026\u0026 event_id == WIFI_EVENT_STA_START) { ESP_LOGI(TAG, \"WiFi STAå¯åŠ¨ï¼Œå¼€å§‹è¿æ¥...\"); esp_wifi_connect(); } else if (event_base == WIFI_EVENT \u0026\u0026 event_id == WIFI_EVENT_STA_DISCONNECTED) { wifi_connected = false; ESP_LOGI(TAG, \"WiFiæ–­å¼€è¿æ¥ï¼Œ5ç§’åå°è¯•é‡è¿...\"); vTaskDelay(pdMS_TO_TICKS(5000)); esp_wifi_connect(); } else if (event_base == IP_EVENT \u0026\u0026 event_id == IP_EVENT_STA_GOT_IP) { ip_event_got_ip_t *event = (ip_event_got_ip_t *)event_data; ESP_LOGI(TAG, \"WiFiè¿æ¥æˆåŠŸï¼ŒIPåœ°å€: \" IPSTR, IP2STR(\u0026event-\u003eip_info.ip)); ESP_LOGI(TAG, \"å­ç½‘æ©ç : \" IPSTR, IP2STR(\u0026event-\u003eip_info.netmask)); ESP_LOGI(TAG, \"ç½‘å…³: \" IPSTR, IP2STR(\u0026event-\u003eip_info.gw)); wifi_connected = true; // åˆå§‹åŒ–UDP socket init_udp_socket(); } } // åˆå§‹åŒ–UDP socket static void init_udp_socket(void) { if (sock \u003e= 0) { close(sock); sock = -1; } sock = socket(AF_INET, SOCK_DGRAM, IPPROTO_IP); if (sock \u003c 0) { ESP_LOGE(TAG, \"åˆ›å»ºsocketå¤±è´¥: %s\", strerror(errno)); return; } // è®¾ç½®socketé€‰é¡¹ int opt = 1; setsockopt(sock, SOL_SOCKET, SO_REUSEADDR, \u0026opt, sizeof(opt)); // è®¾ç½®å‘é€è¶…æ—¶ struct timeval timeout; timeout.tv_sec = 1; timeout.tv_usec = 0; setsockopt(sock, SOL_SOCKET, SO_SNDTIMEO, \u0026timeout, sizeof(timeout)); // è®¾ç½®ç›®æ ‡åœ°å€ memset(\u0026dest_addr, 0, sizeof(dest_addr)); dest_addr.sin_addr.s_addr = inet_addr(UDP_SERVER_IP); dest_addr.sin_family = AF_INET; dest_addr.sin_port = htons(UDP_PORT); ESP_LOGI(TAG, \"UDP socketåˆå§‹åŒ–å®Œæˆ\"); ESP_LOGI(TAG, \"ç›®æ ‡åœ°å€: %s:%d\", UDP_SERVER_IP, UDP_PORT); // å‘é€è¿æ¥æµ‹è¯•åŒ… connection_test(); } // è®¡ç®—éŸ³é‡ï¼ˆRMSå€¼ï¼‰ static int32_t calculate_volume(int32_t *samples, int count) { int64_t sum = 0; for (int i = 0; i \u003c count; i++) { int32_t sample = samples[i] \u003e\u003e 8; if (sample \u003c 0) sample = -sample; sum += sample; } return (int32_t)(sum / count); } // åˆå§‹åŒ–I2S RXï¼ˆINMP441ï¼‰ static void i2s_rx_init(void) { i2s_chan_config_t chan_cfg = I2S_CHANNEL_DEFAULT_CONFIG(I2S_NUM_0, I2S_ROLE_MASTER); chan_cfg.dma_frame_num = 1023; esp_err_t ret = i2s_new_channel(\u0026chan_cfg, NULL, \u0026rx_handle); if (ret != ESP_OK) { ESP_LOGE(TAG, \"åˆ›å»ºI2S RXé€šé“å¤±è´¥: %d\", ret); return; } i2s_std_config_t std_cfg = { .clk_cfg = I2S_STD_CLK_DEFAULT_CONFIG(SAMPLE_RATE), .slot_cfg = I2S_STD_MSB_SLOT_DEFAULT_CONFIG(I2S_DATA_BIT_WIDTH_32BIT, I2S_SLOT_MODE_MONO), .gpio_cfg = { .mclk = I2S_GPIO_UNUSED, .dout = I2S_GPIO_UNUSED, .bclk = INMP_SCK, .ws = INMP_WS, .din = INMP_SD, .invert_flags = { .mclk_inv = false, .bclk_inv = false, .ws_inv = false, }, }, }; ret = i2s_channel_init_std_mode(rx_handle, \u0026std_cfg); if (ret != ESP_OK) { ESP_LOGE(TAG, \"åˆå§‹åŒ–I2S RXå¤±è´¥: %d\", ret); return; } i2s_channel_enable(rx_handle); ESP_LOGI(TAG, \"I2S RXåˆå§‹åŒ–å®Œæˆ\"); } // åˆå§‹åŒ–I2S TXï¼ˆMAX98357Aï¼‰ static void i2s_tx_init(void) { i2s_chan_config_t chan_cfg = I2S_CHANNEL_DEFAULT_CONFIG(I2S_NUM_1, I2S_ROLE_MASTER); chan_cfg.dma_frame_num = 1023; esp_err_t ret = i2s_new_channel(\u0026chan_cfg, \u0026tx_handle, NULL); if (ret != ESP_OK) { ESP_LOGE(TAG, \"åˆ›å»ºI2S TXé€šé“å¤±è´¥: %d\", ret); return; } i2s_std_config_t std_cfg = { .clk_cfg = I2S_STD_CLK_DEFAULT_CONFIG(SAMPLE_RATE), .slot_cfg = I2S_STD_MSB_SLOT_DEFAULT_CONFIG(I2S_DATA_BIT_WIDTH_32BIT, I2S_SLOT_MODE_MONO), .gpio_cfg = { .mclk = I2S_GPIO_UNUSED, .din = I2S_GPIO_UNUSED, .bclk = MAX_BCLK, .ws = MAX_LRC, .dout = MAX_DIN, .invert_flags = { .mclk_inv = false, .bclk_inv = false, .ws_inv = false, }, }, }; ret = i2s_channel_init_std_mode(tx_handle, \u0026std_cfg); if (ret != ESP_OK) { ESP_LOGE(TAG, \"åˆå§‹åŒ–I2S TXå¤±è´¥: %d\", ret); return; } i2s_channel_enable(tx_handle); ESP_LOGI(TAG, \"I2S TXåˆå§‹åŒ–å®Œæˆ\"); } // éŸ³é¢‘å¤„ç†ä»»åŠ¡ static void audio_task(void *args) { size_t bytes_read = 0; const float gain = 4.5f; TickType_t last_volume_print = 0; int32_t max_volume = 0; ESP_LOGI(TAG, \"éŸ³é¢‘å¤„ç†ä»»åŠ¡å¯åŠ¨\"); while (1) { if (!wifi_connected || sock \u003c 0) { ESP_LOGW(TAG, \"ç­‰å¾…WiFiè¿æ¥å’ŒUDPåˆå§‹åŒ–...\"); vTaskDelay(pdMS_TO_TICKS(1000)); continue; } if (i2s_channel_read(rx_handle, audio_buf, BUF_SIZE, \u0026bytes_read, 1000) == ESP_OK) { int32_t *samples = (int32_t *)audio_buf; int samples_count = bytes_read / sizeof(int32_t); // è®¡ç®—å½“å‰éŸ³é‡ int32_t current_volume = calculate_volume(samples, samples_count); if (current_volume \u003e max_volume) { max_volume = current_volume; } // æ¯2ç§’æ‰“å°ä¸€æ¬¡æœ€å¤§éŸ³é‡ TickType_t current_tick = xTaskGetTickCount(); if (current_tick - last_volume_print \u003e= pdMS_TO_TICKS(2000)) { if (max_volume \u003e VOLUME_THRESHOLD) { ESP_LOGI(TAG, \"æ£€æµ‹åˆ°å£°éŸ³è¾“å…¥ï¼ŒéŸ³é‡å€¼: %ld\", max_volume); } max_volume = 0; last_volume_print = current_tick; } // åº”ç”¨å¢ç›Š for (int i = 0; i \u003c samples_count; i++) { int64_t temp = (int64_t)(samples[i] * gain); if (temp \u003e INT32_MAX) temp = INT32_MAX; else if (temp \u003c INT32_MIN) temp = INT32_MIN; samples[i] = (int32_t)temp; } // é€šè¿‡UDPå‘é€éŸ³é¢‘æ•°æ® int err = sendto(sock, audio_buf, bytes_read, 0, (struct sockaddr *)\u0026dest_addr, sizeof(dest_addr)); if (err \u003c 0) { ESP_LOGE(TAG, \"UDPå‘é€å¤±è´¥: %s\", strerror(errno)); } else { send_count++; if (send_count % 50 == 0) { ESP_LOGI(TAG, \"æˆåŠŸå‘é€æ•°æ®åŒ…#%d: %då­—èŠ‚åˆ° %s:%d\", send_count, bytes_read, UDP_SERVER_IP, UDP_PORT); } } // æœ¬åœ°æ’­æ”¾ size_t bytes_written = 0; i2s_channel_write(tx_handle, audio_buf, bytes_read, \u0026bytes_written, 1000); } vTaskDelay(pdMS_TO_TICKS(1)); } } void app_main(void) { ESP_LOGI(TAG, \"=== éŸ³é¢‘UDPå‘é€ç«¯å¯åŠ¨ ===\"); // åˆå§‹åŒ–NVS esp_err_t ret = nvs_flash_init(); if (ret == ESP_ERR_NVS_NO_FREE_PAGES || ret == ESP_ERR_NVS_NEW_VERSION_FOUND) { ESP_LOGI(TAG, \"æ“¦é™¤NVS...\"); ESP_ERROR_CHECK(nvs_flash_erase()); ret = nvs_flash_init(); } ESP_ERROR_CHECK(ret); ESP_LOGI(TAG, \"NVSåˆå§‹åŒ–å®Œæˆ\"); // åˆå§‹åŒ–WiFi wifi_init(); // åˆå§‹åŒ–I2S i2s_tx_init(); i2s_rx_init(); // åˆ›å»ºéŸ³é¢‘å¤„ç†ä»»åŠ¡ xTaskCreate(audio_task, \"audio_task\", 12288, NULL, 5, NULL); ESP_LOGI(TAG, \"ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼Œç­‰å¾…WiFiè¿æ¥...\"); } æ¥æ”¶\n#include #include #include #include \"freertos/FreeRTOS.h\" #include \"freertos/task.h\" #include \"esp_wifi.h\" #include \"esp_event.h\" #include \"esp_log.h\" #include \"esp_system.h\" #include \"nvs_flash.h\" #include \"lwip/err.h\" #include \"lwip/sockets.h\" #include \"lwip/sys.h\" #include \"lwip/netdb.h\" #include \"driver/i2s_std.h\" #include \"driver/gpio.h\" static const char *TAG = \"audio_receiver\"; // WiFié…ç½® #define WIFI_SSID \"RTCT2300\" #define WIFI_PASS \"123123*zxcvb\" // UDPé…ç½® #define UDP_PORT 1234 #define BUF_SIZE (1023 * 1 * 32 / 8) // MAX98357Aå¼•è„š #define MAX_DIN GPIO_NUM_15 #define MAX_BCLK GPIO_NUM_16 #define MAX_LRC GPIO_NUM_17 uint8_t audio_buf[BUF_SIZE]; i2s_chan_handle_t tx_handle; int sock = -1; bool wifi_connected = false; int receive_count = 0; // æå‰å£°æ˜å‡½æ•° static void wifi_event_handler(void *arg, esp_event_base_t event_base, int32_t event_id, void *event_data); static void init_udp_socket(void); static void wifi_init(void) { ESP_LOGI(TAG, \"åˆå§‹åŒ–WiFi...\"); ESP_ERROR_CHECK(esp_netif_init()); ESP_ERROR_CHECK(esp_event_loop_create_default()); esp_netif_create_default_wifi_sta(); wifi_init_config_t cfg = WIFI_INIT_CONFIG_DEFAULT(); ESP_ERROR_CHECK(esp_wifi_init(\u0026cfg)); // æ³¨å†Œäº‹ä»¶å¤„ç†å™¨ ESP_ERROR_CHECK(esp_event_handler_instance_register(WIFI_EVENT, ESP_EVENT_ANY_ID, \u0026wifi_event_handler, NULL, NULL)); ESP_ERROR_CHECK(esp_event_handler_instance_register(IP_EVENT, IP_EVENT_STA_GOT_IP, \u0026wifi_event_handler, NULL, NULL)); wifi_config_t wifi_config = { .sta = { .ssid = WIFI_SSID, .password = WIFI_PASS, }, }; ESP_ERROR_CHECK(esp_wifi_set_mode(WIFI_MODE_STA)); ESP_ERROR_CHECK(esp_wifi_set_config(WIFI_IF_STA, \u0026wifi_config)); ESP_ERROR_CHECK(esp_wifi_start()); ESP_LOGI(TAG, \"WiFiåˆå§‹åŒ–å®Œæˆï¼Œå¼€å§‹è¿æ¥...\"); } // WiFiäº‹ä»¶å¤„ç† static void wifi_event_handler(void *arg, esp_event_base_t event_base, int32_t event_id, void *event_data) { if (event_base == WIFI_EVENT \u0026\u0026 event_id == WIFI_EVENT_STA_START) { ESP_LOGI(TAG, \"WiFi STAå¯åŠ¨\"); esp_wifi_connect(); } else if (event_base == WIFI_EVENT \u0026\u0026 event_id == WIFI_EVENT_STA_CONNECTED) { ESP_LOGI(TAG, \"WiFiå·²è¿æ¥åˆ°AP\"); } else if (event_base == WIFI_EVENT \u0026\u0026 event_id == WIFI_EVENT_STA_DISCONNECTED) { wifi_connected = false; ESP_LOGI(TAG, \"WiFiæ–­å¼€è¿æ¥ï¼Œ5ç§’åå°è¯•é‡è¿...\"); vTaskDelay(pdMS_TO_TICKS(5000)); esp_wifi_connect(); } else if (event_base == IP_EVENT \u0026\u0026 event_id == IP_EVENT_STA_GOT_IP) { ip_event_got_ip_t *event = (ip_event_got_ip_t *)event_data; ESP_LOGI(TAG, \"WiFiè¿æ¥æˆåŠŸï¼Œè·å–åˆ°IPåœ°å€: \" IPSTR, IP2STR(\u0026event-\u003eip_info.ip)); ESP_LOGI(TAG, \"å­ç½‘æ©ç : \" IPSTR, IP2STR(\u0026event-\u003eip_info.netmask)); ESP_LOGI(TAG, \"ç½‘å…³: \" IPSTR, IP2STR(\u0026event-\u003eip_info.gw)); wifi_connected = true; // åˆå§‹åŒ–UDP socket init_udp_socket(); } } // åˆå§‹åŒ–UDP socket static void init_udp_socket(void) { if (sock \u003e= 0) { close(sock); sock = -1; } sock = socket(AF_INET, SOCK_DGRAM, IPPROTO_IP); if (sock \u003c 0) { ESP_LOGE(TAG, \"åˆ›å»ºsocketå¤±è´¥: %s\", strerror(errno)); return; } // è®¾ç½®socketé€‰é¡¹ int opt = 1; setsockopt(sock, SOL_SOCKET, SO_REUSEADDR, \u0026opt, sizeof(opt)); // è®¾ç½®æ¥æ”¶è¶…æ—¶ struct timeval timeout; timeout.tv_sec = 1; timeout.tv_usec = 0; setsockopt(sock, SOL_SOCKET, SO_RCVTIMEO, \u0026timeout, sizeof(timeout)); struct sockaddr_in server_addr; memset(\u0026server_addr, 0, sizeof(server_addr)); server_addr.sin_family = AF_INET; server_addr.sin_port = htons(UDP_PORT); server_addr.sin_addr.s_addr = htonl(INADDR_ANY); if (bind(sock, (struct sockaddr *)\u0026server_addr, sizeof(server_addr)) \u003c 0) { ESP_LOGE(TAG, \"ç»‘å®šç«¯å£å¤±è´¥: %s\", strerror(errno)); close(sock); sock = -1; return; } // è®¾ç½®socketä¸ºéé˜»å¡æ¨¡å¼ int flags = fcntl(sock, F_GETFL, 0); fcntl(sock, F_SETFL, flags | O_NONBLOCK); ESP_LOGI(TAG, \"UDPæ¥æ”¶ç«¯å¯åŠ¨æˆåŠŸï¼Œç›‘å¬ç«¯å£: %d\", UDP_PORT); ESP_LOGI(TAG, \"ç­‰å¾…æ¥æ”¶éŸ³é¢‘æ•°æ®...\"); } // I2S TXåˆå§‹åŒ– static void i2s_tx_init(void) { ESP_LOGI(TAG, \"åˆå§‹åŒ–I2S TX...\"); i2s_chan_config_t chan_cfg = I2S_CHANNEL_DEFAULT_CONFIG(I2S_NUM_0, I2S_ROLE_MASTER); chan_cfg.dma_frame_num = 1023; esp_err_t ret = i2s_new_channel(\u0026chan_cfg, \u0026tx_handle, NULL); if (ret != ESP_OK) { ESP_LOGE(TAG, \"åˆ›å»ºI2Sé€šé“å¤±è´¥: %d\", ret); return; } i2s_std_config_t std_cfg = { .clk_cfg = I2S_STD_CLK_DEFAULT_CONFIG(44100), .slot_cfg = I2S_STD_MSB_SLOT_DEFAULT_CONFIG(I2S_DATA_BIT_WIDTH_32BIT, I2S_SLOT_MODE_MONO), .gpio_cfg = { .mclk = I2S_GPIO_UNUSED, .din = I2S_GPIO_UNUSED, .bclk = MAX_BCLK, .ws = MAX_LRC, .dout = MAX_DIN, .invert_flags = { .mclk_inv = false, .bclk_inv = false, .ws_inv = false, }, }, }; ret = i2s_channel_init_std_mode(tx_handle, \u0026std_cfg); if (ret != ESP_OK) { ESP_LOGE(TAG, \"åˆå§‹åŒ–I2Sæ ‡å‡†æ¨¡å¼å¤±è´¥: %d\", ret); return; } ret = i2s_channel_enable(tx_handle); if (ret != ESP_OK) { ESP_LOGE(TAG, \"å¯ç”¨I2Sé€šé“å¤±è´¥: %d\", ret); return; } ESP_LOGI(TAG, \"I2S TXåˆå§‹åŒ–å®Œæˆ\"); } // UDPæ¥æ”¶ä»»åŠ¡ static void udp_receive_task(void *args) { ESP_LOGI(TAG, \"UDPæ¥æ”¶ä»»åŠ¡å¯åŠ¨\"); while (1) { if (!wifi_connected) { ESP_LOGW(TAG, \"ç­‰å¾…WiFiè¿æ¥...\"); vTaskDelay(pdMS_TO_TICKS(2000)); continue; } if (sock \u003c 0) { ESP_LOGW(TAG, \"ç­‰å¾…UDP socketåˆå§‹åŒ–...\"); vTaskDelay(pdMS_TO_TICKS(1000)); continue; } struct sockaddr_in source_addr; socklen_t addr_len = sizeof(source_addr); int len = recvfrom(sock, audio_buf, BUF_SIZE, 0, (struct sockaddr *)\u0026source_addr, \u0026addr_len); if (len \u003e 0) { char source_ip[16]; inet_ntoa_r(source_addr.sin_addr, source_ip, sizeof(source_ip) - 1); receive_count++; ESP_LOGI(TAG, \"æ”¶åˆ°æ¥è‡ª %s:%d çš„æ•°æ®åŒ…#%dï¼Œé•¿åº¦: %d å­—èŠ‚\", source_ip, ntohs(source_addr.sin_port), receive_count, len); // æ£€æŸ¥æ˜¯å¦æ˜¯æµ‹è¯•åŒ… if (len \u003c= 20) { audio_buf[len] = '\\0'; // ç¡®ä¿å­—ç¬¦ä¸²ç»“æŸ if (strstr((char *)audio_buf, \"TEST\") != NULL) { ESP_LOGI(TAG, \"æ”¶åˆ°è¿æ¥æµ‹è¯•åŒ…: %s\", audio_buf); continue; // ä¸æ’­æ”¾æµ‹è¯•åŒ… } } // æ’­æ”¾æ¥æ”¶åˆ°çš„éŸ³é¢‘æ•°æ® size_t bytes_written = 0; esp_err_t ret = i2s_channel_write(tx_handle, audio_buf, len, \u0026bytes_written, portMAX_DELAY); if (ret != ESP_OK) { ESP_LOGE(TAG, \"I2Så†™å…¥å¤±è´¥: %d\", ret); } else { if (receive_count % 10 == 0) { ESP_LOGI(TAG, \"æˆåŠŸæ’­æ”¾éŸ³é¢‘: %d å­—èŠ‚\", bytes_written); } } } else if (len \u003c 0) { if (errno == EAGAIN || errno == EWOULDBLOCK) { // éé˜»å¡æ¨¡å¼ä¸‹æ²¡æœ‰æ•°æ®æ˜¯æ­£å¸¸çš„ if (receive_count == 0 \u0026\u0026 (xTaskGetTickCount() % 10000 == 0)) { ESP_LOGW(TAG, \"ç­‰å¾…æ¥æ”¶æ•°æ®...ï¼ˆå½“å‰æ¥æ”¶åŒ…æ•°: %dï¼‰\", receive_count); } } else { ESP_LOGE(TAG, \"æ¥æ”¶æ•°æ®å¤±è´¥: %s (errno: %d)\", strerror(errno), errno); } } vTaskDelay(pdMS_TO_TICKS(10)); } } void app_main(void) { ESP_LOGI(TAG, \"=== éŸ³é¢‘æ¥æ”¶ç«¯å¯åŠ¨ ===\"); // åˆå§‹åŒ–NVS esp_err_t ret = nvs_flash_init(); if (ret == ESP_ERR_NVS_NO_FREE_PAGES || ret == ESP_ERR_NVS_NEW_VERSION_FOUND) { ESP_LOGI(TAG, \"æ“¦é™¤NVS...\"); ESP_ERROR_CHECK(nvs_flash_erase()); ret = nvs_flash_init(); } ESP_ERROR_CHECK(ret); ESP_LOGI(TAG, \"NVSåˆå§‹åŒ–å®Œæˆ\"); // åˆå§‹åŒ–I2S i2s_tx_init(); // åˆå§‹åŒ–WiFi wifi_init(); // åˆ›å»ºUDPæ¥æ”¶ä»»åŠ¡ xTaskCreate(udp_receive_task, \"udp_receive\", 12288, NULL, 5, NULL); ESP_LOGI(TAG, \"UDPæ¥æ”¶ä»»åŠ¡åˆ›å»ºå®Œæˆ\"); ESP_LOGI(TAG, \"ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼Œç­‰å¾…WiFiè¿æ¥...\"); // ä¿æŒä»»åŠ¡è¿è¡Œ while (1) { if (wifi_connected) { if (sock \u003e= 0) { ESP_LOGI(TAG, \"ç³»ç»Ÿè¿è¡Œä¸­ - WiFiå·²è¿æ¥ï¼ŒSocketå°±ç»ªï¼Œå·²æ¥æ”¶æ•°æ®åŒ…: %d\", receive_count); } else { ESP_LOGW(TAG, \"ç³»ç»Ÿè¿è¡Œä¸­ - WiFiå·²è¿æ¥ï¼Œä½†Socketæœªå°±ç»ª\"); } } else { ESP_LOGW(TAG, \"ç³»ç»Ÿè¿è¡Œä¸­ - ç­‰å¾…WiFiè¿æ¥...\"); } vTaskDelay(pdMS_TO_TICKS(10000)); } } TCP å‘é€ç«¯\n// sender_main.c #include #include #include #include \"freertos/FreeRTOS.h\" #include \"freertos/task.h\" #include \"esp_wifi.h\" #include \"esp_event.h\" #include \"esp_log.h\" #include \"nvs_flash.h\" #include \"esp_netif.h\" #include \"lwip/sockets.h\" #include \"driver/i2s_std.h\" // ======== é…ç½®éƒ¨åˆ† ======== #define WIFI_SSID \"RTCT2300\" #define WIFI_PASS \"123123*zx\" #define RECEIVER_IP \"192.168.80.39\" #define RECEIVER_PORT 5005 #define INMP_SD GPIO_NUM_13 #define INMP_SCK GPIO_NUM_14 #define INMP_WS GPIO_NUM_27 #define SAMPLE_RATE 44100 // æ³¨æ„è¯»ç¼“å†²è‡³å°‘åº”æ˜¯4å­—èŠ‚çš„å€æ•°ï¼ˆ32-bit æ ·æœ¬å®¹å™¨ï¼‰ #define READ_BUF_SIZE 1024 static const char *TAG = \"audio_sender\"; static i2s_chan_handle_t rx_handle; // åˆå§‹åŒ–éº¦å…‹é£è¾“å…¥ï¼ˆINMP441ï¼‰ï¼Œä½¿ç”¨ Philipsï¼ˆæ ‡å‡† I2Sï¼‰æ ¼å¼ï¼Œå®¹å™¨ä¿æŒ 32bit ä»¥ä¾¿è¯»åˆ°å®Œæ•´æ ·æœ¬ static void i2s_rx_init(void) { i2s_chan_config_t chan_cfg = I2S_CHANNEL_DEFAULT_CONFIG(I2S_NUM_0, I2S_ROLE_MASTER); chan_cfg.dma_frame_num = 512; i2s_new_channel(\u0026chan_cfg, NULL, \u0026rx_handle); i2s_std_config_t std_cfg = { .clk_cfg = I2S_STD_CLK_DEFAULT_CONFIG(SAMPLE_RATE), // ä½¿ç”¨ 32bit å®¹å™¨è¯»å–ï¼ˆéº¦å…‹é£é€šå¸¸æŠŠ 24bit æ”¾åœ¨ 32bit å®¹å™¨ï¼‰ .slot_cfg = I2S_STD_PHILIPS_SLOT_DEFAULT_CONFIG(I2S_DATA_BIT_WIDTH_32BIT, I2S_SLOT_MODE_MONO), .gpio_cfg = { .mclk = I2S_GPIO_UNUSED, .dout = I2S_GPIO_UNUSED, .bclk = INMP_SCK, .ws = INMP_WS, .din = INMP_SD, .invert_flags = {0}, }, }; i2s_channel_init_std_mode(rx_handle, \u0026std_cfg); i2s_channel_enable(rx_handle); ESP_LOGI(TAG, \"I2S RX (Mic) initialized (Philips, 32-bit container)\"); } // Wi-Fi äº‹ä»¶ static void wifi_event_handler(void *arg, esp_event_base_t event_base, int32_t event_id, void *event_data) { if (event_base == WIFI_EVENT \u0026\u0026 event_id == WIFI_EVENT_STA_START) { esp_wifi_connect(); ESP_LOGI(TAG, \"Connecting to Wi-Fi...\"); } else if (event_base == WIFI_EVENT \u0026\u0026 event_id == WIFI_EVENT_STA_DISCONNECTED) { ESP_LOGW(TAG, \"Wi-Fi disconnected, retrying...\"); esp_wifi_connect(); } else if (event_base == IP_EVENT \u0026\u0026 event_id == IP_EVENT_STA_GOT_IP) { ip_event_got_ip_t *event = (ip_event_got_ip_t *)event_data; ESP_LOGI(TAG, \"Got IP: \" IPSTR, IP2STR(\u0026event-\u003eip_info.ip)); } } // åˆå§‹åŒ– Wi-Fi STA æ¨¡å¼ static void wifi_init_sta(void) { ESP_ERROR_CHECK(esp_netif_init()); ESP_ERROR_CHECK(esp_event_loop_create_default()); esp_netif_create_default_wifi_sta(); wifi_init_config_t cfg = WIFI_INIT_CONFIG_DEFAULT(); ESP_ERROR_CHECK(esp_wifi_init(\u0026cfg)); esp_event_handler_instance_t instance_any_id; esp_event_handler_instance_t instance_got_ip; ESP_ERROR_CHECK(esp_event_handler_instance_register(WIFI_EVENT, ESP_EVENT_ANY_ID, \u0026wifi_event_handler, NULL, \u0026instance_any_id)); ESP_ERROR_CHECK(esp_event_handler_instance_register(IP_EVENT, IP_EVENT_STA_GOT_IP, \u0026wifi_event_handler, NULL, \u0026instance_got_ip)); wifi_config_t wifi_config = { .sta = { .ssid = WIFI_SSID, .password = WIFI_PASS, .threshold.authmode = WIFI_AUTH_WPA2_PSK, }, }; ESP_ERROR_CHECK(esp_wifi_set_mode(WIFI_MODE_STA)); ESP_ERROR_CHECK(esp_wifi_set_config(WIFI_IF_STA, \u0026wifi_config)); ESP_ERROR_CHECK(esp_wifi_start()); } // éŸ³é¢‘å‘é€ä»»åŠ¡ static void audio_send_task(void *pvParameters) { struct sockaddr_in dest_addr; int sock; // è¯»å– 32-bit å®¹å™¨æ•°æ® buffer uint8_t read_buf[READ_BUF_SIZE]; size_t bytes_read; int log_counter = 0; // ç”¨äºè½¬æ¢åˆ° 16-bit PCM çš„ç¼“å†²ï¼ˆæœ€å¤§æ ·æœ¬æ•° = READ_BUF_SIZE / 4ï¼‰ // æ¯ä¸ªæ ·æœ¬ 2 å­—èŠ‚è¾“å‡º uint8_t out_buf[READ_BUF_SIZE / 2]; while (1) { // è¿æ¥ TCP dest_addr.sin_addr.s_addr = inet_addr(RECEIVER_IP); dest_addr.sin_family = AF_INET; dest_addr.sin_port = htons(RECEIVER_PORT); sock = socket(AF_INET, SOCK_STREAM, IPPROTO_IP); if (sock \u003c 0) { ESP_LOGE(TAG, \"Unable to create socket\"); vTaskDelay(pdMS_TO_TICKS(2000)); continue; } ESP_LOGI(TAG, \"Connecting to receiver %s:%d ...\", RECEIVER_IP, RECEIVER_PORT); if (connect(sock, (struct sockaddr *)\u0026dest_addr, sizeof(dest_addr)) != 0) { ESP_LOGE(TAG, \"Connection failed\"); close(sock); vTaskDelay(pdMS_TO_TICKS(2000)); continue; } ESP_LOGI(TAG, \"Connected! Start sending audio...\"); while (1) { // ä»éº¦å…‹é£è¯»å– 32-bit å®¹å™¨æ ·æœ¬ esp_err_t r = i2s_channel_read(rx_handle, read_buf, READ_BUF_SIZE, \u0026bytes_read, 1000); if (r == ESP_OK \u0026\u0026 bytes_read \u003e 0) { // bytes_read æ˜¯å­—èŠ‚æ•°ï¼Œæ ·æœ¬æ•° = bytes_read / 4 int sample_count = bytes_read / 4; int64_t energy = 0; int32_t *samples32 = (int32_t *)read_buf; // è®¡ç®—èƒ½é‡ï¼ˆä½¿ç”¨ 32-bit åŸæ ·æœ¬ï¼‰ for (int i = 0; i \u003c sample_count; i++) { // INMP441 é€šå¸¸æ˜¯ 24-bit åœ¨é«˜ä½ï¼Œæ‰€ä»¥ llabs(samples32[i]) åˆç† energy += llabs((int64_t)samples32[i]); } if (sample_count \u003e 0) energy /= sample_count; if (energy \u003e 5000 \u0026\u0026 log_counter++ % 10 == 0) ESP_LOGI(TAG, \"ğŸ¤ Detected voice (energy=%lld)\", energy); // å°† 32-bit æ ·æœ¬é™åˆ° 16-bit PCMï¼ˆå–é«˜ 16 ä½ï¼‰ // è¾“å‡ºä¸º little-endian 16-bit for (int i = 0; i \u003c sample_count; i++) { int32_t s32 = samples32[i]; int16_t s16 = (int16_t)(s32 \u003e\u003e 16); // å–é«˜ 16 ä½ // little-endian å†™å…¥ out_buf[2 * i] = (uint8_t)(s16 \u0026 0xFF); out_buf[2 * i + 1] = (uint8_t)((s16 \u003e\u003e 8) \u0026 0xFF); } int out_bytes = sample_count * 2; int err = send(sock, out_buf, out_bytes, 0); if (err \u003c 0) { ESP_LOGE(TAG, \"Send failed (%d), reconnecting...\", err); close(sock); break; } } else { // è¶…æ—¶æˆ–è¯»å–å¤±è´¥ï¼ˆå¯èƒ½éº¦å…‹é£/é©±åŠ¨æš‚æ—¶æ²¡æ•°æ®ï¼‰ // ä¸è¦é¢‘ç¹æ‰“å°ä»¥å…åˆ·å± } } } } void app_main(void) { ESP_ERROR_CHECK(nvs_flash_init()); wifi_init_sta(); i2s_rx_init(); xTaskCreate(audio_send_task, \"audio_send_task\", 8192, NULL, 5, NULL); } æ¥æ”¶\n#include #include #include #include \"freertos/FreeRTOS.h\" #include \"freertos/task.h\" #include \"esp_wifi.h\" #include \"esp_event.h\" #include \"esp_log.h\" #include \"nvs_flash.h\" #include \"esp_netif.h\" #include \"lwip/sockets.h\" #include \"driver/i2s_std.h\" // ======== Wi-Fi \u0026 TCP é…ç½® ======== #define WIFI_SSID \"RTCT2300\" #define WIFI_PASS \"123123*zx\" #define TCP_PORT 5005 // ======== éŸ³é¢‘å‚æ•° ======== #define SAMPLE_RATE 44100 #define BUF_SIZE 1024 // ä¸å‘é€ç«¯ä¸€è‡´ // ======== MAX98357A æ¥çº¿ ======== #define MAX_BCLK GPIO_NUM_16 #define MAX_LRC GPIO_NUM_17 #define MAX_DIN GPIO_NUM_15 static const char *TAG = \"audio_receiver\"; static i2s_chan_handle_t tx_handle; // ==================== I2S åˆå§‹åŒ– ==================== static void i2s_tx_init(void) { i2s_chan_config_t chan_cfg = I2S_CHANNEL_DEFAULT_CONFIG(I2S_NUM_0, I2S_ROLE_MASTER); chan_cfg.dma_frame_num = 512; ESP_ERROR_CHECK(i2s_new_channel(\u0026chan_cfg, \u0026tx_handle, NULL)); i2s_std_config_t std_cfg = { .clk_cfg = I2S_STD_CLK_DEFAULT_CONFIG(SAMPLE_RATE), // âœ… ä½¿ç”¨æ ‡å‡† Philips æ ¼å¼ã€16-bit å•å£°é“ .slot_cfg = I2S_STD_PHILIPS_SLOT_DEFAULT_CONFIG(I2S_DATA_BIT_WIDTH_16BIT, I2S_SLOT_MODE_MONO), .gpio_cfg = { .mclk = I2S_GPIO_UNUSED, .bclk = MAX_BCLK, .ws = MAX_LRC, .dout = MAX_DIN, .din = I2S_GPIO_UNUSED, .invert_flags = { .mclk_inv = false, .bclk_inv = false, .ws_inv = false, }, }, }; ESP_ERROR_CHECK(i2s_channel_init_std_mode(tx_handle, \u0026std_cfg)); ESP_ERROR_CHECK(i2s_channel_enable(tx_handle)); ESP_LOGI(TAG, \"âœ… I2S TX initialized: 44.1kHz, 16-bit, mono\"); } // ==================== Wi-Fi äº‹ä»¶å›è°ƒ ==================== static void wifi_event_handler(void *arg, esp_event_base_t event_base, int32_t event_id, void *event_data) { if (event_base == WIFI_EVENT \u0026\u0026 event_id == WIFI_EVENT_STA_START) { esp_wifi_connect(); ESP_LOGI(TAG, \"Connecting to Wi-Fi...\"); } else if (event_base == WIFI_EVENT \u0026\u0026 event_id == WIFI_EVENT_STA_DISCONNECTED) { ESP_LOGW(TAG, \"Disconnected, retrying...\"); esp_wifi_connect(); } else if (event_base == IP_EVENT \u0026\u0026 event_id == IP_EVENT_STA_GOT_IP) { ip_event_got_ip_t *event = (ip_event_got_ip_t *)event_data; ESP_LOGI(TAG, \"Got IP: \" IPSTR, IP2STR(\u0026event-\u003eip_info.ip)); } } // ==================== Wi-Fi STA åˆå§‹åŒ– ==================== static void wifi_init_sta(void) { ESP_ERROR_CHECK(esp_netif_init()); ESP_ERROR_CHECK(esp_event_loop_create_default()); esp_netif_create_default_wifi_sta(); wifi_init_config_t cfg = WIFI_INIT_CONFIG_DEFAULT(); ESP_ERROR_CHECK(esp_wifi_init(\u0026cfg)); esp_event_handler_instance_t instance_any_id; esp_event_handler_instance_t instance_got_ip; ESP_ERROR_CHECK(esp_event_handler_instance_register(WIFI_EVENT, ESP_EVENT_ANY_ID, \u0026wifi_event_handler, NULL, \u0026instance_any_id)); ESP_ERROR_CHECK(esp_event_handler_instance_register(IP_EVENT, IP_EVENT_STA_GOT_IP, \u0026wifi_event_handler, NULL, \u0026instance_got_ip)); wifi_config_t wifi_config = { .sta = { .ssid = WIFI_SSID, .password = WIFI_PASS, .threshold.authmode = WIFI_AUTH_WPA2_PSK, }, }; ESP_ERROR_CHECK(esp_wifi_set_mode(WIFI_MODE_STA)); ESP_ERROR_CHECK(esp_wifi_set_config(WIFI_IF_STA, \u0026wifi_config)); ESP_ERROR_CHECK(esp_wifi_start()); } // ==================== éŸ³é¢‘æ¥æ”¶æ’­æ”¾ä»»åŠ¡ ==================== static void audio_receive_task(void *pvParameters) { struct sockaddr_in server_addr, client_addr; socklen_t client_len = sizeof(client_addr); int listen_sock, client_sock; char rx_buffer[BUF_SIZE]; size_t bytes_written; int packet_count = 0; listen_sock = socket(AF_INET, SOCK_STREAM, IPPROTO_IP); if (listen_sock \u003c 0) { ESP_LOGE(TAG, \"Unable to create socket\"); vTaskDelete(NULL); return; } server_addr.sin_addr.s_addr = htonl(INADDR_ANY); server_addr.sin_family = AF_INET; server_addr.sin_port = htons(TCP_PORT); bind(listen_sock, (struct sockaddr *)\u0026server_addr, sizeof(server_addr)); listen(listen_sock, 1); ESP_LOGI(TAG, \"Waiting for connection on port %d...\", TCP_PORT); while (1) { client_sock = accept(listen_sock, (struct sockaddr *)\u0026client_addr, \u0026client_len); if (client_sock \u003c 0) { ESP_LOGE(TAG, \"Unable to accept connection\"); continue; } ESP_LOGI(TAG, \"ğŸ§ Client connected from %s\", inet_ntoa(client_addr.sin_addr)); packet_count = 0; while (1) { int len = recv(client_sock, rx_buffer, sizeof(rx_buffer), 0); if (len \u003c= 0) { ESP_LOGW(TAG, \"Client disconnected\"); close(client_sock); break; } // æ¯ 50 åŒ…æ‰“å°ä¸€æ¬¡æ—¥å¿— if (++packet_count % 50 == 0) ESP_LOGI(TAG, \"ğŸµ Receiving audio... (%d packets)\", packet_count); // âœ… ç›´æ¥æ’­æ”¾ï¼Œä¸è¿›è¡Œä½ç§»æˆ–è½¬æ¢ i2s_channel_write(tx_handle, rx_buffer, len, \u0026bytes_written, portMAX_DELAY); } } } // ==================== ä¸»å‡½æ•° ==================== void app_main(void) { ESP_ERROR_CHECK(nvs_flash_init()); wifi_init_sta(); i2s_tx_init(); xTaskCreate(audio_receive_task, \"audio_receive_task\", 8192, NULL, 5, NULL); } ESP32ä¸ä¸»æœºpythonç¨‹åº TCPè¿æ¥ä¼ è¾“éŸ³é¢‘ // sender_main.c #include #include #include #include \"freertos/FreeRTOS.h\" #include \"freertos/task.h\" #include \"esp_wifi.h\" #include \"esp_event.h\" #include \"esp_log.h\" #include \"nvs_flash.h\" #include \"esp_netif.h\" #include \"lwip/sockets.h\" #include \"driver/i2s_std.h\" // ======== é…ç½®éƒ¨åˆ† ======== #define WIFI_SSID \"RTCT2300\" #define WIFI_PASS \"123123*zxcvb\" #define RECEIVER_IP \"192.168.80.77\" #define RECEIVER_PORT 5005 #define INMP_SD GPIO_NUM_13 #define INMP_SCK GPIO_NUM_14 #define INMP_WS GPIO_NUM_27 #define SAMPLE_RATE 44100 // æ³¨æ„è¯»ç¼“å†²è‡³å°‘åº”æ˜¯4å­—èŠ‚çš„å€æ•°ï¼ˆ32-bit æ ·æœ¬å®¹å™¨ï¼‰ #define READ_BUF_SIZE 1024 static const char *TAG = \"audio_sender\"; static i2s_chan_handle_t rx_handle; // åˆå§‹åŒ–éº¦å…‹é£è¾“å…¥ï¼ˆINMP441ï¼‰ï¼Œä½¿ç”¨ Philipsï¼ˆæ ‡å‡† I2Sï¼‰æ ¼å¼ï¼Œå®¹å™¨ä¿æŒ 32bit ä»¥ä¾¿è¯»åˆ°å®Œæ•´æ ·æœ¬ static void i2s_rx_init(void) { i2s_chan_config_t chan_cfg = I2S_CHANNEL_DEFAULT_CONFIG(I2S_NUM_0, I2S_ROLE_MASTER); chan_cfg.dma_frame_num = 512; i2s_new_channel(\u0026chan_cfg, NULL, \u0026rx_handle); i2s_std_config_t std_cfg = { .clk_cfg = I2S_STD_CLK_DEFAULT_CONFIG(SAMPLE_RATE), // ä½¿ç”¨ 32bit å®¹å™¨è¯»å–ï¼ˆéº¦å…‹é£é€šå¸¸æŠŠ 24bit æ”¾åœ¨ 32bit å®¹å™¨ï¼‰ .slot_cfg = I2S_STD_PHILIPS_SLOT_DEFAULT_CONFIG(I2S_DATA_BIT_WIDTH_32BIT, I2S_SLOT_MODE_MONO), .gpio_cfg = { .mclk = I2S_GPIO_UNUSED, .dout = I2S_GPIO_UNUSED, .bclk = INMP_SCK, .ws = INMP_WS, .din = INMP_SD, .invert_flags = {0}, }, }; i2s_channel_init_std_mode(rx_handle, \u0026std_cfg); i2s_channel_enable(rx_handle); ESP_LOGI(TAG, \"I2S RX (Mic) initialized (Philips, 32-bit container)\"); } // Wi-Fi äº‹ä»¶ static void wifi_event_handler(void *arg, esp_event_base_t event_base, int32_t event_id, void *event_data) { if (event_base == WIFI_EVENT \u0026\u0026 event_id == WIFI_EVENT_STA_START) { esp_wifi_connect(); ESP_LOGI(TAG, \"Connecting to Wi-Fi...\"); } else if (event_base == WIFI_EVENT \u0026\u0026 event_id == WIFI_EVENT_STA_DISCONNECTED) { ESP_LOGW(TAG, \"Wi-Fi disconnected, retrying...\"); esp_wifi_connect(); } else if (event_base == IP_EVENT \u0026\u0026 event_id == IP_EVENT_STA_GOT_IP) { ip_event_got_ip_t *event = (ip_event_got_ip_t *)event_data; ESP_LOGI(TAG, \"Got IP: \" IPSTR, IP2STR(\u0026event-\u003eip_info.ip)); } } // åˆå§‹åŒ– Wi-Fi STA æ¨¡å¼ static void wifi_init_sta(void) { ESP_ERROR_CHECK(esp_netif_init()); ESP_ERROR_CHECK(esp_event_loop_create_default()); esp_netif_create_default_wifi_sta(); wifi_init_config_t cfg = WIFI_INIT_CONFIG_DEFAULT(); ESP_ERROR_CHECK(esp_wifi_init(\u0026cfg)); esp_event_handler_instance_t instance_any_id; esp_event_handler_instance_t instance_got_ip; ESP_ERROR_CHECK(esp_event_handler_instance_register(WIFI_EVENT, ESP_EVENT_ANY_ID, \u0026wifi_event_handler, NULL, \u0026instance_any_id)); ESP_ERROR_CHECK(esp_event_handler_instance_register(IP_EVENT, IP_EVENT_STA_GOT_IP, \u0026wifi_event_handler, NULL, \u0026instance_got_ip)); wifi_config_t wifi_config = { .sta = { .ssid = WIFI_SSID, .password = WIFI_PASS, .threshold.authmode = WIFI_AUTH_WPA2_PSK, }, }; ESP_ERROR_CHECK(esp_wifi_set_mode(WIFI_MODE_STA)); ESP_ERROR_CHECK(esp_wifi_set_config(WIFI_IF_STA, \u0026wifi_config)); ESP_ERROR_CHECK(esp_wifi_start()); } // éŸ³é¢‘å‘é€ä»»åŠ¡ static void audio_send_task(void *pvParameters) { struct sockaddr_in dest_addr; int sock; // è¯»å– 32-bit å®¹å™¨æ•°æ® buffer uint8_t read_buf[READ_BUF_SIZE]; size_t bytes_read; int log_counter = 0; // ç”¨äºè½¬æ¢åˆ° 16-bit PCM çš„ç¼“å†²ï¼ˆæœ€å¤§æ ·æœ¬æ•° = READ_BUF_SIZE / 4ï¼‰ // æ¯ä¸ªæ ·æœ¬ 2 å­—èŠ‚è¾“å‡º uint8_t out_buf[READ_BUF_SIZE / 2]; while (1) { // è¿æ¥ TCP dest_addr.sin_addr.s_addr = inet_addr(RECEIVER_IP); dest_addr.sin_family = AF_INET; dest_addr.sin_port = htons(RECEIVER_PORT); sock = socket(AF_INET, SOCK_STREAM, IPPROTO_IP); if (sock \u003c 0) { ESP_LOGE(TAG, \"Unable to create socket\"); vTaskDelay(pdMS_TO_TICKS(2000)); continue; } ESP_LOGI(TAG, \"Connecting to receiver %s:%d ...\", RECEIVER_IP, RECEIVER_PORT); if (connect(sock, (struct sockaddr *)\u0026dest_addr, sizeof(dest_addr)) != 0) { ESP_LOGE(TAG, \"Connection failed\"); close(sock); vTaskDelay(pdMS_TO_TICKS(2000)); continue; } ESP_LOGI(TAG, \"Connected! Start sending audio...\"); while (1) { // ä»éº¦å…‹é£è¯»å– 32-bit å®¹å™¨æ ·æœ¬ esp_err_t r = i2s_channel_read(rx_handle, read_buf, READ_BUF_SIZE, \u0026bytes_read, 1000); if (r == ESP_OK \u0026\u0026 bytes_read \u003e 0) { // bytes_read æ˜¯å­—èŠ‚æ•°ï¼Œæ ·æœ¬æ•° = bytes_read / 4 int sample_count = bytes_read / 4; int64_t energy = 0; int32_t *samples32 = (int32_t *)read_buf; // è®¡ç®—èƒ½é‡ï¼ˆä½¿ç”¨ 32-bit åŸæ ·æœ¬ï¼‰ for (int i = 0; i \u003c sample_count; i++) { // INMP441 é€šå¸¸æ˜¯ 24-bit åœ¨é«˜ä½ï¼Œæ‰€ä»¥ llabs(samples32[i]) åˆç† energy += llabs((int64_t)samples32[i]); } if (sample_count \u003e 0) energy /= sample_count; if (energy \u003e 5000 \u0026\u0026 log_counter++ % 10 == 0) ESP_LOGI(TAG, \" Detected voice (energy=%lld)\", energy); // å°† 32-bit æ ·æœ¬é™åˆ° 16-bit PCMï¼ˆå–é«˜ 16 ä½ï¼‰ // è¾“å‡ºä¸º little-endian 16-bit for (int i = 0; i \u003c sample_count; i++) { int32_t s32 = samples32[i]; int16_t s16 = (int16_t)(s32 \u003e\u003e 16); // å–é«˜ 16 ä½ // little-endian å†™å…¥ out_buf[2 * i] = (uint8_t)(s16 \u0026 0xFF); out_buf[2 * i + 1] = (uint8_t)((s16 \u003e\u003e 8) \u0026 0xFF); } int out_bytes = sample_count * 2; int err = send(sock, out_buf, out_bytes, 0); if (err \u003c 0) { ESP_LOGE(TAG, \"Send failed (%d), reconnecting...\", err); close(sock); break; } } else { // è¶…æ—¶æˆ–è¯»å–å¤±è´¥ï¼ˆå¯èƒ½éº¦å…‹é£/é©±åŠ¨æš‚æ—¶æ²¡æ•°æ®ï¼‰ // ä¸è¦é¢‘ç¹æ‰“å°ä»¥å…åˆ·å± } } } } void app_main(void) { ESP_ERROR_CHECK(nvs_flash_init()); wifi_init_sta(); i2s_rx_init(); xTaskCreate(audio_send_task, \"audio_send_task\", 8192, NULL, 5, NULL); } ä¸»æœºç«¯\nimport socket import sounddevice as sd import numpy as np import wave import time # ===== é…ç½®éƒ¨åˆ† ===== HOST = \"0.0.0.0\" # ç›‘å¬æ‰€æœ‰ IPï¼ˆè®© ESP32 å¯ä»¥è¿æ¥è¿›æ¥ï¼‰ PORT = 5005 # å¿…é¡»å’Œ ESP32 å‘é€ç«¯ä¿æŒä¸€è‡´ SAMPLE_RATE = 44100 # é‡‡æ ·ç‡ CHANNELS = 1 # å£°é“æ•° CHUNK = 1024 # æ¯æ¬¡æ¥æ”¶çš„å­—èŠ‚æ•° # ===== åˆå§‹åŒ– ===== print(f\" Listening on TCP {HOST}:{PORT} ...\") server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM) server_socket.bind((HOST, PORT)) server_socket.listen(1) conn, addr = server_socket.accept() print(f\" Connected from {addr}\") # æ‰“å¼€éŸ³é¢‘è¾“å‡ºæµ stream = sd.OutputStream( samplerate=SAMPLE_RATE, channels=CHANNELS, dtype='int16' ) stream.start() # æ‰“å¼€ WAV æ–‡ä»¶å†™å…¥ï¼ˆ16-bit PCMï¼‰ timestamp = time.strftime(\"%Y%m%d_%H%M%S\") wav_filename = f\"test_{timestamp}.wav\" wav_file = wave.open(wav_filename, 'wb') wav_file.setnchannels(CHANNELS) wav_file.setsampwidth(2) # int16 = 2 å­—èŠ‚ wav_file.setframerate(SAMPLE_RATE) print(f\"Recording to {wav_filename} ...\") packet_count = 0 total_bytes = 0 try: while True: data = conn.recv(CHUNK) if not data: print(\" Connection closed by sender.\") break packet_count += 1 total_bytes += len(data) if packet_count % 50 == 0: seconds = total_bytes / (SAMPLE_RATE * CHANNELS * 2) print(f\" {packet_count} packets received ({total_bytes} bytes â‰ˆ {seconds:.1f}s audio)\") # æ’­æ”¾éŸ³é¢‘ samples = np.frombuffer(data, dtype=np.int16) stream.write(samples) # å†™å…¥ WAV æ–‡ä»¶ wav_file.writeframes(data) except KeyboardInterrupt: print(\"\\n Stopped by user (Ctrl+C).\") finally: # æ”¶å°¾ conn.close() server_socket.close() stream.stop() stream.close() wav_file.close() print(f\" File saved: {wav_filename}\") è¿è¡Œ\npython testpy.py Listening on TCP 0.0.0.0:5005 ... Connected from ('192.168.80.41', 55862) Recording to test_20251031_144232.wav ... 50 packets received (36512 bytes â‰ˆ 0.4s audio) 100 packets received (73536 bytes â‰ˆ 0.8s audio) 150 packets received (109536 bytes â‰ˆ 1.2s audio) 200 packets received (145952 bytes â‰ˆ 1.7s audio) 250 packets received (182976 bytes â‰ˆ 2.1s audio) 300 packets received (218976 bytes â‰ˆ 2.5s audio) 350 packets received (255392 bytes â‰ˆ 2.9s audio) 400 packets received (291392 bytes â‰ˆ 3.3s audio) 450 packets received (327392 bytes â‰ˆ 3.7s audio) 500 packets received (364832 bytes â‰ˆ 4.1s audio) 550 packets received (400832 bytes â‰ˆ 4.5s audio) 600 packets received (436832 bytes â‰ˆ 5.0s audio) Stopped by user (Ctrl+C). File saved: test_20251031_144232.wav è¿wifiæ’­æ”¾å†…ç½‘éŸ³é¢‘ #include #include #include #include \"freertos/FreeRTOS.h\" #include \"freertos/task.h\" #include \"driver/i2s_std.h\" #include \"driver/gpio.h\" #include \"esp_wifi.h\" #include \"esp_event.h\" #include \"esp_log.h\" #include \"esp_http_client.h\" #include \"nvs_flash.h\" // å¼•è„šå®šä¹‰ï¼ˆä¿æŒä¸å˜ï¼‰ #define INMP_SD GPIO_NUM_13 #define INMP_SCK GPIO_NUM_14 #define INMP_WS GPIO_NUM_27 #define MAX_DIN GPIO_NUM_15 #define MAX_BCLK GPIO_NUM_16 #define MAX_LRC GPIO_NUM_17 // WiFié…ç½® #define WIFI_SSID \"QQ1\" #define WIFI_PASS \"123123*xx\" // WAVæ–‡ä»¶URL #define WAV_URL \"http://192.168.80.77:8005/test_20251031_144232.wav\" // éŸ³é¢‘ç¼“å†²åŒºé…ç½® #define BUF_SIZE 4096 uint8_t audio_buf[BUF_SIZE]; // I2Så¥æŸ„ i2s_chan_handle_t tx_handle = NULL; // WAVæ–‡ä»¶å¤´ç»“æ„ typedef struct { char riff[4]; // \"RIFF\" uint32_t file_size; // æ–‡ä»¶å¤§å° - 8 char wave[4]; // \"WAVE\" char fmt[4]; // \"fmt \" uint32_t fmt_size; // æ ¼å¼å—å¤§å° uint16_t audio_fmt; // éŸ³é¢‘æ ¼å¼ (1 = PCM) uint16_t num_chans; // å£°é“æ•° uint32_t sample_rate; // é‡‡æ ·ç‡ uint32_t byte_rate; // å­—èŠ‚ç‡ uint16_t block_align; // å—å¯¹é½ uint16_t bits_per_samp; // æ¯æ ·æœ¬ä½æ•° } wav_header_t; static const char *TAG = \"wav_player\"; static bool wifi_connected = false; // WiFiäº‹ä»¶å¤„ç† static void event_handler(void *arg, esp_event_base_t event_base, int32_t event_id, void *event_data) { if (event_base == WIFI_EVENT \u0026\u0026 event_id == WIFI_EVENT_STA_START) { esp_wifi_connect(); } else if (event_base == WIFI_EVENT \u0026\u0026 event_id == WIFI_EVENT_STA_DISCONNECTED) { esp_wifi_connect(); ESP_LOGI(TAG, \"é‡æ–°è¿æ¥WiFi...\"); wifi_connected = false; } else if (event_base == IP_EVENT \u0026\u0026 event_id == IP_EVENT_STA_GOT_IP) { ip_event_got_ip_t *event = (ip_event_got_ip_t *)event_data; ESP_LOGI(TAG, \"è·å–IPåœ°å€:\" IPSTR, IP2STR(\u0026event-\u003eip_info.ip)); wifi_connected = true; } } // åˆå§‹åŒ–WiFi static void wifi_init_sta(void) { ESP_ERROR_CHECK(nvs_flash_init()); ESP_ERROR_CHECK(esp_netif_init()); ESP_ERROR_CHECK(esp_event_loop_create_default()); esp_netif_create_default_wifi_sta(); wifi_init_config_t cfg = WIFI_INIT_CONFIG_DEFAULT(); ESP_ERROR_CHECK(esp_wifi_init(\u0026cfg)); esp_event_handler_instance_t instance_any_id; esp_event_handler_instance_t instance_got_ip; ESP_ERROR_CHECK(esp_event_handler_instance_register(WIFI_EVENT, ESP_EVENT_ANY_ID, \u0026event_handler, NULL, \u0026instance_any_id)); ESP_ERROR_CHECK(esp_event_handler_instance_register(IP_EVENT, IP_EVENT_STA_GOT_IP, \u0026event_handler, NULL, \u0026instance_got_ip)); wifi_config_t wifi_config = { .sta = { .ssid = WIFI_SSID, .password = WIFI_PASS, }, }; ESP_ERROR_CHECK(esp_wifi_set_mode(WIFI_MODE_STA)); ESP_ERROR_CHECK(esp_wifi_set_config(WIFI_IF_STA, \u0026wifi_config)); ESP_ERROR_CHECK(esp_wifi_start()); ESP_LOGI(TAG, \"WiFiåˆå§‹åŒ–å®Œæˆ\"); } // åˆå§‹åŒ–I2Sè¾“å‡ºï¼ˆæ ¹æ®WAVå‚æ•°é…ç½®ï¼‰ static void i2s_init(uint32_t sample_rate, uint16_t bits_per_sample, uint16_t num_channels) { if (tx_handle) { i2s_channel_disable(tx_handle); i2s_del_channel(tx_handle); tx_handle = NULL; } i2s_chan_config_t chan_cfg = I2S_CHANNEL_DEFAULT_CONFIG(I2S_NUM_1, I2S_ROLE_MASTER); chan_cfg.dma_frame_num = 1024; ESP_ERROR_CHECK(i2s_new_channel(\u0026chan_cfg, \u0026tx_handle, NULL)); i2s_data_bit_width_t bit_width; switch (bits_per_sample) { case 16: bit_width = I2S_DATA_BIT_WIDTH_16BIT; break; case 24: bit_width = I2S_DATA_BIT_WIDTH_24BIT; break; case 32: bit_width = I2S_DATA_BIT_WIDTH_32BIT; break; default: ESP_LOGE(TAG, \"ä¸æ”¯æŒçš„ä½æ·±åº¦: %d\", bits_per_sample); return; } i2s_slot_mode_t slot_mode = (num_channels == 1) ? I2S_SLOT_MODE_MONO : I2S_SLOT_MODE_STEREO; i2s_std_config_t std_cfg = { .clk_cfg = I2S_STD_CLK_DEFAULT_CONFIG(sample_rate), .slot_cfg = I2S_STD_MSB_SLOT_DEFAULT_CONFIG(bit_width, slot_mode), .gpio_cfg = { .mclk = I2S_GPIO_UNUSED, .din = I2S_GPIO_UNUSED, .bclk = MAX_BCLK, .ws = MAX_LRC, .dout = MAX_DIN, .invert_flags = {.mclk_inv = false, .bclk_inv = false, .ws_inv = false}, }, }; ESP_ERROR_CHECK(i2s_channel_init_std_mode(tx_handle, \u0026std_cfg)); ESP_ERROR_CHECK(i2s_channel_enable(tx_handle)); ESP_LOGI(TAG, \"I2Såˆå§‹åŒ–å®Œæˆ - é‡‡æ ·ç‡: %d Hz, ä½æ·±åº¦: %d, å£°é“æ•°: %d\", sample_rate, bits_per_sample, num_channels); } // HTTPè¯·æ±‚å›è°ƒå‡½æ•° - æ’­æ”¾éŸ³é¢‘æ•°æ® static esp_err_t http_event_handler(esp_http_client_event_t *evt) { static wav_header_t wav_header; static bool header_parsed = false; static uint32_t data_read = 0; static uint32_t data_size = 0; switch (evt-\u003eevent_id) { case HTTP_EVENT_ON_DATA: if (!header_parsed) { // è§£æWAVæ–‡ä»¶å¤´ size_t header_needed = sizeof(wav_header) - data_read; size_t copy_len = (evt-\u003edata_len \u003c header_needed) ? evt-\u003edata_len : header_needed; memcpy(((uint8_t *)\u0026wav_header) + data_read, evt-\u003edata, copy_len); data_read += copy_len; if (data_read \u003e= sizeof(wav_header)) { // éªŒè¯WAVæ–‡ä»¶ if (memcmp(wav_header.riff, \"RIFF\", 4) != 0 || memcmp(wav_header.wave, \"WAVE\", 4) != 0 || memcmp(wav_header.fmt, \"fmt \", 4) != 0 || wav_header.audio_fmt != 1) { ESP_LOGE(TAG, \"ä¸æ˜¯æœ‰æ•ˆçš„PCM WAVæ–‡ä»¶\"); return ESP_FAIL; } // è®¡ç®—å®é™…éŸ³é¢‘æ•°æ®å¤§å° data_size = wav_header.file_size + 8 - sizeof(wav_header); // æ ¹æ®WAVå‚æ•°åˆå§‹åŒ–I2S i2s_init(wav_header.sample_rate, wav_header.bits_per_samp, wav_header.num_chans); header_parsed = true; ESP_LOGI(TAG, \"WAVæ–‡ä»¶è§£æå®Œæˆ - éŸ³é¢‘æ•°æ®å¤§å°: %d bytes\", data_size); // å‘é€å¤´éƒ¨ä¸­åŒ…å«çš„éŸ³é¢‘æ•°æ® if (copy_len \u003c evt-\u003edata_len) { size_t audio_data_len = evt-\u003edata_len - copy_len; size_t bytes_written; i2s_channel_write(tx_handle, (uint8_t *)evt-\u003edata + copy_len, audio_data_len, \u0026bytes_written, portMAX_DELAY); } } } else { // å‘é€éŸ³é¢‘æ•°æ® size_t bytes_written; i2s_channel_write(tx_handle, evt-\u003edata, evt-\u003edata_len, \u0026bytes_written, portMAX_DELAY); } break; case HTTP_EVENT_ON_FINISH: ESP_LOGI(TAG, \"WAVæ–‡ä»¶æ’­æ”¾å®Œæˆ\"); break; case HTTP_EVENT_ERROR: ESP_LOGE(TAG, \"HTTPè¯·æ±‚é”™è¯¯\"); break; default: break; } return ESP_OK; } // æ’­æ”¾WAVæ–‡ä»¶ä»»åŠ¡ static void wav_play_task(void *pvParameters) { // ç­‰å¾…WiFiè¿æ¥ while (!wifi_connected) { vTaskDelay(pdMS_TO_TICKS(100)); } ESP_LOGI(TAG, \"å¼€å§‹æ’­æ”¾WAVæ–‡ä»¶: %s\", WAV_URL); // é…ç½®HTTPå®¢æˆ·ç«¯ esp_http_client_config_t config = { .url = WAV_URL, .event_handler = http_event_handler, .timeout_ms = 10000, }; esp_http_client_handle_t client = esp_http_client_init(\u0026config); esp_err_t err = esp_http_client_perform(client); if (err != ESP_OK) { ESP_LOGE(TAG, \"HTTPè¯·æ±‚å¤±è´¥: %s\", esp_err_to_name(err)); } esp_http_client_cleanup(client); // æ’­æ”¾å®Œæˆåå…³é—­I2S if (tx_handle) { i2s_channel_disable(tx_handle); i2s_del_channel(tx_handle); tx_handle = NULL; } ESP_LOGI(TAG, \"æ’­æ”¾ä»»åŠ¡ç»“æŸ\"); vTaskDelete(NULL); } void app_main(void) { // åˆå§‹åŒ–WiFi wifi_init_sta(); // åˆ›å»ºæ’­æ”¾ä»»åŠ¡ xTaskCreate(wav_play_task, \"wav_play_task\", 1024 * 8, NULL, 5, NULL); } é€šè¿‡UDPå¹¿æ’­ESP32é€šè®¯ å‘é€ç«¯\n#include #include #include \"freertos/FreeRTOS.h\" #include \"freertos/task.h\" #include \"freertos/event_groups.h\" #include \"esp_wifi.h\" #include \"esp_event.h\" #include \"esp_log.h\" #include \"nvs_flash.h\" #include \"esp_netif.h\" #include \"driver/i2s_std.h\" #include \"lwip/sockets.h\" #include \"lwip/netdb.h\" #define WIFI_SSID \"RTCT2300\" #define WIFI_PASS \"123123*zxcvb\" #define UDP_PORT 12345 #define BROADCAST_IP \"255.255.255.255\" #define TAG \"AUDIO_TX\" #define INMP_SD GPIO_NUM_13 #define INMP_SCK GPIO_NUM_14 #define INMP_WS GPIO_NUM_27 #define SAMPLE_RATE 16000 #define I2S_NUM I2S_NUM_0 #define I2S_BUFFER_SAMPLES 256 static i2s_chan_handle_t rx_handle = NULL; static EventGroupHandle_t wifi_event_group; #define WIFI_CONNECTED_BIT BIT0 // --- WiFi äº‹ä»¶å›è°ƒ --- static void wifi_event_handler(void *arg, esp_event_base_t event_base, int32_t event_id, void *event_data) { if (event_base == WIFI_EVENT \u0026\u0026 event_id == WIFI_EVENT_STA_START) { esp_wifi_connect(); } else if (event_base == WIFI_EVENT \u0026\u0026 event_id == WIFI_EVENT_STA_DISCONNECTED) { ESP_LOGW(TAG, \"Wi-Fi disconnected, reconnecting...\"); esp_wifi_connect(); } else if (event_base == IP_EVENT \u0026\u0026 event_id == IP_EVENT_STA_GOT_IP) { xEventGroupSetBits(wifi_event_group, WIFI_CONNECTED_BIT); } } static void wifi_init_sta(void) { wifi_event_group = xEventGroupCreate(); esp_netif_init(); esp_event_loop_create_default(); esp_netif_create_default_wifi_sta(); wifi_init_config_t cfg = WIFI_INIT_CONFIG_DEFAULT(); esp_wifi_init(\u0026cfg); esp_event_handler_register(WIFI_EVENT, ESP_EVENT_ANY_ID, \u0026wifi_event_handler, NULL); esp_event_handler_register(IP_EVENT, IP_EVENT_STA_GOT_IP, \u0026wifi_event_handler, NULL); wifi_config_t wifi_config = { .sta = { .ssid = WIFI_SSID, .password = WIFI_PASS, .threshold.authmode = WIFI_AUTH_WPA2_PSK, }, }; esp_wifi_set_mode(WIFI_MODE_STA); esp_wifi_set_config(WIFI_IF_STA, \u0026wifi_config); esp_wifi_start(); ESP_LOGI(TAG, \"Connecting to Wi-Fi...\"); xEventGroupWaitBits(wifi_event_group, WIFI_CONNECTED_BIT, pdFALSE, pdTRUE, portMAX_DELAY); ESP_LOGI(TAG, \"Wi-Fi connected!\"); } static void i2s_init(void) { i2s_chan_config_t chan_cfg = I2S_CHANNEL_DEFAULT_CONFIG(I2S_NUM, I2S_ROLE_MASTER); i2s_new_channel(\u0026chan_cfg, NULL, \u0026rx_handle); i2s_std_config_t std_cfg = { .clk_cfg = I2S_STD_CLK_DEFAULT_CONFIG(SAMPLE_RATE), .slot_cfg = I2S_STD_PHILIPS_SLOT_DEFAULT_CONFIG(I2S_DATA_BIT_WIDTH_32BIT, I2S_SLOT_MODE_MONO), .gpio_cfg = { .mclk = I2S_GPIO_UNUSED, .bclk = INMP_SCK, .ws = INMP_WS, .dout = I2S_GPIO_UNUSED, .din = INMP_SD, }, }; i2s_channel_init_std_mode(rx_handle, \u0026std_cfg); i2s_channel_enable(rx_handle); } void audio_sender_task(void *pvParameters) { struct sockaddr_in dest_addr; dest_addr.sin_addr.s_addr = inet_addr(BROADCAST_IP); dest_addr.sin_family = AF_INET; dest_addr.sin_port = htons(UDP_PORT); int sock = socket(AF_INET, SOCK_DGRAM, IPPROTO_IP); int broadcastEnable = 1; setsockopt(sock, SOL_SOCKET, SO_BROADCAST, \u0026broadcastEnable, sizeof(broadcastEnable)); ESP_LOGI(TAG, \"UDP socket ready, start sending audio...\"); int32_t i2s_raw[I2S_BUFFER_SAMPLES]; int16_t pcm16[I2S_BUFFER_SAMPLES]; size_t bytes_read; while (1) { esp_err_t res = i2s_channel_read(rx_handle, i2s_raw, sizeof(i2s_raw), \u0026bytes_read, portMAX_DELAY); if (res == ESP_OK \u0026\u0026 bytes_read \u003e 0) { int samples = bytes_read / 4; // æ¯ä¸ªé‡‡æ ·32bit for (int i = 0; i \u003c samples; i++) { // INMP441 è¾“å‡ºå·¦å¯¹é½ 24bitï¼Œæœ‰æ•ˆä½åœ¨é«˜ 24 ä½ int32_t sample = (i2s_raw[i] \u003e\u003e 8); pcm16[i] = (int16_t)(sample \u003e\u003e 8); // å‹ç¼©æˆ 16bit PCM } sendto(sock, pcm16, samples * sizeof(int16_t), 0, (struct sockaddr *)\u0026dest_addr, sizeof(dest_addr)); } } close(sock); vTaskDelete(NULL); } void app_main(void) { nvs_flash_init(); wifi_init_sta(); i2s_init(); xTaskCreate(audio_sender_task, \"audio_sender_task\", 4096, NULL, 5, NULL); } æ¥æ”¶ç«¯\n#include #include #include \"freertos/FreeRTOS.h\" #include \"freertos/task.h\" #include \"freertos/event_groups.h\" #include \"esp_wifi.h\" #include \"esp_event.h\" #include \"esp_log.h\" #include \"nvs_flash.h\" #include \"esp_netif.h\" #include \"driver/i2s_std.h\" #include \"lwip/sockets.h\" #include \"lwip/netdb.h\" #define WIFI_SSID \"RTCT2300\" #define WIFI_PASS \"123123*zxcvb\" #define UDP_PORT 12345 #define TAG \"AUDIO_RX\" #define MAX_DOUT GPIO_NUM_15 #define MAX_BCLK GPIO_NUM_16 #define MAX_LRC GPIO_NUM_17 #define SAMPLE_RATE 16000 #define I2S_NUM I2S_NUM_1 #define I2S_BUFFER_SAMPLES 256 static i2s_chan_handle_t tx_handle = NULL; static EventGroupHandle_t wifi_event_group; #define WIFI_CONNECTED_BIT BIT0 static void wifi_event_handler(void *arg, esp_event_base_t event_base, int32_t event_id, void *event_data) { if (event_base == WIFI_EVENT \u0026\u0026 event_id == WIFI_EVENT_STA_START) { esp_wifi_connect(); } else if (event_base == WIFI_EVENT \u0026\u0026 event_id == WIFI_EVENT_STA_DISCONNECTED) { ESP_LOGW(TAG, \"Wi-Fi disconnected, reconnecting...\"); esp_wifi_connect(); } else if (event_base == IP_EVENT \u0026\u0026 event_id == IP_EVENT_STA_GOT_IP) { xEventGroupSetBits(wifi_event_group, WIFI_CONNECTED_BIT); } } static void wifi_init_sta(void) { wifi_event_group = xEventGroupCreate(); esp_netif_init(); esp_event_loop_create_default(); esp_netif_create_default_wifi_sta(); wifi_init_config_t cfg = WIFI_INIT_CONFIG_DEFAULT(); esp_wifi_init(\u0026cfg); esp_event_handler_register(WIFI_EVENT, ESP_EVENT_ANY_ID, \u0026wifi_event_handler, NULL); esp_event_handler_register(IP_EVENT, IP_EVENT_STA_GOT_IP, \u0026wifi_event_handler, NULL); wifi_config_t wifi_config = { .sta = { .ssid = WIFI_SSID, .password = WIFI_PASS, .threshold.authmode = WIFI_AUTH_WPA2_PSK, }, }; esp_wifi_set_mode(WIFI_MODE_STA); esp_wifi_set_config(WIFI_IF_STA, \u0026wifi_config); esp_wifi_start(); ESP_LOGI(TAG, \"Connecting to Wi-Fi...\"); xEventGroupWaitBits(wifi_event_group, WIFI_CONNECTED_BIT, pdFALSE, pdTRUE, portMAX_DELAY); ESP_LOGI(TAG, \"Wi-Fi connected!\"); } static void i2s_init(void) { i2s_chan_config_t chan_cfg = I2S_CHANNEL_DEFAULT_CONFIG(I2S_NUM, I2S_ROLE_MASTER); i2s_new_channel(\u0026chan_cfg, \u0026tx_handle, NULL); i2s_std_config_t std_cfg = { .clk_cfg = I2S_STD_CLK_DEFAULT_CONFIG(SAMPLE_RATE), .slot_cfg = I2S_STD_PHILIPS_SLOT_DEFAULT_CONFIG(I2S_DATA_BIT_WIDTH_16BIT, I2S_SLOT_MODE_MONO), .gpio_cfg = { .mclk = I2S_GPIO_UNUSED, .bclk = MAX_BCLK, .ws = MAX_LRC, .dout = MAX_DOUT, .din = I2S_GPIO_UNUSED, }, }; i2s_channel_init_std_mode(tx_handle, \u0026std_cfg); i2s_channel_enable(tx_handle); } void audio_receiver_task(void *pvParameters) { struct sockaddr_in local_addr; local_addr.sin_addr.s_addr = htonl(INADDR_ANY); local_addr.sin_family = AF_INET; local_addr.sin_port = htons(UDP_PORT); int sock = socket(AF_INET, SOCK_DGRAM, IPPROTO_IP); bind(sock, (struct sockaddr *)\u0026local_addr, sizeof(local_addr)); ESP_LOGI(TAG, \"UDP ready, waiting for audio...\"); int16_t pcm16[I2S_BUFFER_SAMPLES]; while (1) { int len = recvfrom(sock, pcm16, sizeof(pcm16), 0, NULL, NULL); if (len \u003e 0) { size_t bytes_written; i2s_channel_write(tx_handle, pcm16, len, \u0026bytes_written, portMAX_DELAY); } } close(sock); vTaskDelete(NULL); } void app_main(void) { nvs_flash_init(); wifi_init_sta(); i2s_init(); xTaskCreate(audio_receiver_task, \"audio_receiver_task\", 4096, NULL, 5, NULL); } è¾“å…¥ï¼š 16-bit PCM å•å£°é“è¾“å‡º é‡‡æ ·ç‡ 16 kHz è¾“å‡ºï¼š æ•°æ®æ ¼å¼ä¸º 16-bit PCMã€å•å£°é“ã€é‡‡æ ·ç‡ 16kHzï¼› æ¯æ¬¡åŒ…å¤§å° 512 å­—èŠ‚å·¦å³ï¼ˆ256 é‡‡æ ·ï¼‰\npython server esp32udp # multiroom_server.py import threading import socket import time import json from flask import Flask, jsonify, request, render_template_string AUDIO_PORT = 12345 CMD_PORT = 12346 HEARTBEAT_PORT = 12347 HEARTBEAT_TIMEOUT = 10.0 # seconds to consider device offline app = Flask(__name__) # device dict: ip -\u003e {id, ip, last_seen, audio_port} devices = {} devices_lock = threading.Lock() # Simple HTML UI (very minimal) INDEX_HTML = \"\"\" \u003c!doctype html\u003e Multiroom Control Multiroom æ§åˆ¶é¢æ¿ åˆ·æ–°è®¾å¤‡ å¼€å§‹äº’é€šï¼ˆé€‰ä¸­ä¸¤ä¸ªï¼‰ åœæ­¢æ‰€æœ‰é€šè¯ è®¾å¤‡åˆ—è¡¨ SelectIPIDLast seenAudio port \"\"\" @app.route('/') def index(): return render_template_string(INDEX_HTML) @app.route('/devices') def get_devices(): with devices_lock: now = time.time() out = [] for ip, info in list(devices.items()): out.append({ 'ip': ip, 'id': info.get('id'), 'audio_port': info.get('audio_port', AUDIO_PORT), 'last_seen': time.strftime(\"%Y-%m-%d %H:%M:%S\", time.localtime(info['last_seen'])) }) return jsonify(out) def send_cmd(ip, cmd_text): sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM) sock.settimeout(1.0) try: sock.sendto(cmd_text.encode('utf-8'), (ip, CMD_PORT)) except Exception as e: print(\"send_cmd err:\", e) finally: sock.close() @app.route('/start_call', methods=['POST']) def start_call(): data = request.get_json() a_ip = data['a_ip'] b_ip = data['b_ip'] # å°† A æŒ‡å‘ Bï¼ŒB æŒ‡å‘ A send_cmd(a_ip, f\"START_CALL:{b_ip}:{AUDIO_PORT}\") send_cmd(b_ip, f\"START_CALL:{a_ip}:{AUDIO_PORT}\") return jsonify({'status':'ok','msg':f'{a_ip} \u003c-\u003e {b_ip} started'}) @app.route('/stop_all', methods=['POST']) def stop_all(): with devices_lock: ips = list(devices.keys()) for ip in ips: send_cmd(ip, \"STOP_CALL\") return jsonify({'status':'ok','stopped':ips}) # Heartbeat listener thread def heartbeat_listener(): sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM) sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1) sock.bind(('', HEARTBEAT_PORT)) print(\"Heartbeat listener running on port\", HEARTBEAT_PORT) while True: try: data, addr = sock.recvfrom(1024) txt = data.decode('utf-8', errors='ignore') ip = addr[0] # æœŸæœ› heartbeat æ ¼å¼ JSON æˆ– \"heartbeat::\" parsed = {} try: parsed = json.loads(txt) except: parts = txt.strip().split(':') if parts[0].lower() == 'heartbeat': parsed = {'type':'heartbeat', 'id': parts[1] if len(parts)\u003e1 else ip, 'audio_port': int(parts[2]) if len(parts)\u003e2 else AUDIO_PORT} if parsed.get('type')=='heartbeat' or 'id' in parsed: with devices_lock: devices[ip] = { 'id': parsed.get('id', ip), 'audio_port': parsed.get('audio_port', AUDIO_PORT), 'last_seen': time.time() } except Exception as e: print(\"heartbeat_listener error:\", e) # cleanup old devices with devices_lock: now = time.time() todel = [k for k,v in devices.items() if now - v['last_seen'] \u003e HEARTBEAT_TIMEOUT] for k in todel: del devices[k] if __name__ == '__main__': t = threading.Thread(target=heartbeat_listener, daemon=True) t.start() app.run(host='0.0.0.0', port=5000) pip install flask pip install flask_socketio é«˜æ€§èƒ½å¼‚æ­¥æœåŠ¡å™¨ pip install eventlet // main.c (ä¿®æ­£ç‰ˆ) #include #include #include #include \"freertos/FreeRTOS.h\" #include \"freertos/task.h\" #include \"freertos/event_groups.h\" #include \"esp_wifi.h\" #include \"esp_event.h\" #include \"esp_log.h\" #include \"nvs_flash.h\" #include \"esp_netif.h\" #include \"driver/i2s_std.h\" #include \"lwip/sockets.h\" #include \"lwip/netdb.h\" #include \"esp_system.h\" #include \"esp_mac.h\" #include \"esp_err.h\" #define WIFI_SSID \"RTCT2300\" #define WIFI_PASS \"123123*zx\" #define TAG \"ESP32_ROOM\" #define UDP_AUDIO_PORT 12345 #define UDP_CMD_PORT 12346 #define UDP_HEARTBEAT_PORT 12347 #define BROADCAST_IP \"255.255.255.255\" #define SAMPLE_RATE 16000 #define I2S_BUFFER_SAMPLES 256 // åˆ†åˆ«ä½¿ç”¨ä¸åŒçš„ I2S å¤–è®¾å·ï¼Œé¿å…å†²çª #define I2S_RX_NUM I2S_NUM_0 // microphone input #define I2S_TX_NUM I2S_NUM_1 // speaker output // I2S pins (æŒ‰ä½ åŸæ¥æ¥çº¿) #define INMP_SD GPIO_NUM_13 #define INMP_SCK GPIO_NUM_14 #define INMP_WS GPIO_NUM_27 #define MAX_DOUT GPIO_NUM_15 #define MAX_BCLK GPIO_NUM_16 #define MAX_LRC GPIO_NUM_17 static i2s_chan_handle_t rx_handle = NULL; static i2s_chan_handle_t tx_handle = NULL; static EventGroupHandle_t wifi_event_group; #define WIFI_CONNECTED_BIT BIT0 static bool in_call = false; static char target_ip[64] = {0}; static int target_port = UDP_AUDIO_PORT; static char device_id[32] = {0}; static void wifi_event_handler(void *arg, esp_event_base_t event_base, int32_t event_id, void *event_data) { if (event_base == WIFI_EVENT \u0026\u0026 event_id == WIFI_EVENT_STA_START) { esp_wifi_connect(); } else if (event_base == WIFI_EVENT \u0026\u0026 event_id == WIFI_EVENT_STA_DISCONNECTED) { ESP_LOGW(TAG, \"Wi-Fi disconnected, reconnecting...\"); esp_wifi_connect(); } else if (event_base == IP_EVENT \u0026\u0026 event_id == IP_EVENT_STA_GOT_IP) { xEventGroupSetBits(wifi_event_group, WIFI_CONNECTED_BIT); } } static void wifi_init_sta(void) { wifi_event_group = xEventGroupCreate(); esp_netif_init(); esp_event_loop_create_default(); esp_netif_create_default_wifi_sta(); wifi_init_config_t cfg = WIFI_INIT_CONFIG_DEFAULT(); ESP_ERROR_CHECK(esp_wifi_init(\u0026cfg)); esp_event_handler_register(WIFI_EVENT, ESP_EVENT_ANY_ID, \u0026wifi_event_handler, NULL); esp_event_handler_register(IP_EVENT, IP_EVENT_STA_GOT_IP, \u0026wifi_event_handler, NULL); wifi_config_t wifi_config = { .sta = { .ssid = WIFI_SSID, .password = WIFI_PASS, .threshold.authmode = WIFI_AUTH_WPA2_PSK, }, }; ESP_ERROR_CHECK(esp_wifi_set_mode(WIFI_MODE_STA)); ESP_ERROR_CHECK(esp_wifi_set_config(WIFI_IF_STA, \u0026wifi_config)); ESP_ERROR_CHECK(esp_wifi_start()); ESP_LOGI(TAG, \"Connecting to Wi-Fi...\"); xEventGroupWaitBits(wifi_event_group, WIFI_CONNECTED_BIT, pdFALSE, pdTRUE, portMAX_DELAY); ESP_LOGI(TAG, \"Wi-Fi connected!\"); } static void i2s_init_master_rx(void) { i2s_chan_config_t chan_cfg = I2S_CHANNEL_DEFAULT_CONFIG(I2S_RX_NUM, I2S_ROLE_MASTER); esp_err_t err = i2s_new_channel(\u0026chan_cfg, NULL, \u0026rx_handle); if (err != ESP_OK) { ESP_LOGE(TAG, \"i2s_new_channel rx failed: %s\", esp_err_to_name(err)); rx_handle = NULL; return; } i2s_std_config_t std_cfg = { .clk_cfg = I2S_STD_CLK_DEFAULT_CONFIG(SAMPLE_RATE), .slot_cfg = I2S_STD_PHILIPS_SLOT_DEFAULT_CONFIG(I2S_DATA_BIT_WIDTH_32BIT, I2S_SLOT_MODE_MONO), .gpio_cfg = { .mclk = I2S_GPIO_UNUSED, .bclk = INMP_SCK, .ws = INMP_WS, .dout = I2S_GPIO_UNUSED, .din = INMP_SD, }, }; err = i2s_channel_init_std_mode(rx_handle, \u0026std_cfg); if (err != ESP_OK) { ESP_LOGE(TAG, \"i2s_channel_init_std_mode rx failed: %s\", esp_err_to_name(err)); i2s_del_channel(rx_handle); rx_handle = NULL; return; } err = i2s_channel_enable(rx_handle); if (err != ESP_OK) { ESP_LOGE(TAG, \"i2s_channel_enable rx failed: %s\", esp_err_to_name(err)); i2s_del_channel(rx_handle); rx_handle = NULL; return; } ESP_LOGI(TAG, \"I2S RX initialized (handle=%p)\", rx_handle); } static void i2s_init_master_tx(void) { i2s_chan_config_t chan_cfg = I2S_CHANNEL_DEFAULT_CONFIG(I2S_TX_NUM, I2S_ROLE_MASTER); esp_err_t err = i2s_new_channel(\u0026chan_cfg, \u0026tx_handle, NULL); if (err != ESP_OK) { ESP_LOGE(TAG, \"i2s_new_channel tx failed: %s\", esp_err_to_name(err)); tx_handle = NULL; return; } i2s_std_config_t std_cfg = { .clk_cfg = I2S_STD_CLK_DEFAULT_CONFIG(SAMPLE_RATE), .slot_cfg = I2S_STD_PHILIPS_SLOT_DEFAULT_CONFIG(I2S_DATA_BIT_WIDTH_16BIT, I2S_SLOT_MODE_MONO), .gpio_cfg = { .mclk = I2S_GPIO_UNUSED, .bclk = MAX_BCLK, .ws = MAX_LRC, .dout = MAX_DOUT, .din = I2S_GPIO_UNUSED, }, }; err = i2s_channel_init_std_mode(tx_handle, \u0026std_cfg); if (err != ESP_OK) { ESP_LOGE(TAG, \"i2s_channel_init_std_mode tx failed: %s\", esp_err_to_name(err)); i2s_del_channel(tx_handle); tx_handle = NULL; return; } err = i2s_channel_enable(tx_handle); if (err != ESP_OK) { ESP_LOGE(TAG, \"i2s_channel_enable tx failed: %s\", esp_err_to_name(err)); i2s_del_channel(tx_handle); tx_handle = NULL; return; } ESP_LOGI(TAG, \"I2S TX initialized (handle=%p)\", tx_handle); } // Heartbeat broadcaster void heartbeat_task(void *pvParameters) { int sock = socket(AF_INET, SOCK_DGRAM, IPPROTO_IP); if (sock \u003c 0) { ESP_LOGE(TAG, \"heartbeat socket create failed\"); vTaskDelete(NULL); return; } int broadcastEnable = 1; setsockopt(sock, SOL_SOCKET, SO_BROADCAST, \u0026broadcastEnable, sizeof(broadcastEnable)); struct sockaddr_in dest_addr; dest_addr.sin_family = AF_INET; dest_addr.sin_port = htons(UDP_HEARTBEAT_PORT); dest_addr.sin_addr.s_addr = inet_addr(BROADCAST_IP); char buf[128]; while (1) { snprintf(buf, sizeof(buf), \"heartbeat:%s:%d\", device_id, UDP_AUDIO_PORT); sendto(sock, buf, strlen(buf), 0, (struct sockaddr *)\u0026dest_addr, sizeof(dest_addr)); vTaskDelay(pdMS_TO_TICKS(3000)); } // never here close(sock); vTaskDelete(NULL); } // Command listener (CMD_PORT) void cmd_listener_task(void *pvParameters) { int sock = socket(AF_INET, SOCK_DGRAM, IPPROTO_IP); if (sock \u003c 0) { ESP_LOGE(TAG, \"cmd socket create failed\"); vTaskDelete(NULL); return; } struct sockaddr_in local_addr; local_addr.sin_family = AF_INET; local_addr.sin_port = htons(UDP_CMD_PORT); local_addr.sin_addr.s_addr = htonl(INADDR_ANY); if (bind(sock, (struct sockaddr *)\u0026local_addr, sizeof(local_addr)) != 0) { ESP_LOGE(TAG, \"cmd bind failed\"); } else { ESP_LOGI(TAG, \"CMD listener on %d\", UDP_CMD_PORT); } char buf[256]; while (1) { int len = recvfrom(sock, buf, sizeof(buf) - 1, 0, NULL, NULL); if (len \u003e 0) { buf[len] = 0; ESP_LOGI(TAG, \"CMD recv: %s\", buf); if (strncmp(buf, \"START_CALL:\", 11) == 0) { char ipbuf[64] = {0}; int port = UDP_AUDIO_PORT; // parse ip:port ; allow case when port missing if (sscanf(buf + 11, \"%63[^:]:%d\", ipbuf, \u0026port) \u003e= 1) { strncpy(target_ip, ipbuf, sizeof(target_ip) - 1); target_port = port; in_call = true; ESP_LOGI(TAG, \"start call to %s:%d\", target_ip, target_port); } else { ESP_LOGW(TAG, \"START_CALL parse failed\"); } } else if (strncmp(buf, \"STOP_CALL\", 9) == 0) { in_call = false; target_ip[0] = 0; ESP_LOGI(TAG, \"stop call\"); } else { ESP_LOGI(TAG, \"unknown cmd\"); } } } close(sock); vTaskDelete(NULL); } // Audio sender: when in_call true, read i2s mic and send PCM16 to target void audio_sender_task(void *pvParameters) { int sock = socket(AF_INET, SOCK_DGRAM, IPPROTO_IP); if (sock \u003c 0) { ESP_LOGE(TAG, \"audio sender socket create failed\"); vTaskDelete(NULL); return; } ESP_LOGI(TAG, \"audio sender started (sock=%d)\", sock); int32_t i2s_raw[I2S_BUFFER_SAMPLES]; int16_t pcm16[I2S_BUFFER_SAMPLES]; size_t bytes_read; while (1) { if (!in_call) { vTaskDelay(pdMS_TO_TICKS(10)); continue; } if (rx_handle == NULL) { ESP_LOGW(TAG, \"rx_handle NULL, skipping send\"); vTaskDelay(pdMS_TO_TICKS(50)); continue; } esp_err_t res = i2s_channel_read(rx_handle, i2s_raw, sizeof(i2s_raw), \u0026bytes_read, portMAX_DELAY); if (res == ESP_OK \u0026\u0026 bytes_read \u003e 0) { int samples = bytes_read / 4; // 32-bit read -\u003e samples if (samples \u003e I2S_BUFFER_SAMPLES) samples = I2S_BUFFER_SAMPLES; for (int i = 0; i \u003c samples; i++) { int32_t sample = (i2s_raw[i] \u003e\u003e 8); // 24-bit -\u003e align pcm16[i] = (int16_t)(sample \u003e\u003e 8); } if (target_ip[0]) { struct sockaddr_in dest; dest.sin_family = AF_INET; dest.sin_port = htons(target_port); dest.sin_addr.s_addr = inet_addr(target_ip); int tosend = samples * sizeof(int16_t); int r = sendto(sock, pcm16, tosend, 0, (struct sockaddr *)\u0026dest, sizeof(dest)); if (r \u003c 0) { ESP_LOGW(TAG, \"sendto failed\"); } } } else { ESP_LOGW(TAG, \"i2s_channel_read failed: %s\", esp_err_to_name(res)); } } close(sock); vTaskDelete(NULL); } // Audio receiver: listen for UDP audio on AUDIO_PORT and write to I2S tx (speaker) void audio_receiver_task(void *pvParameters) { struct sockaddr_in local_addr; local_addr.sin_family = AF_INET; local_addr.sin_port = htons(UDP_AUDIO_PORT); local_addr.sin_addr.s_addr = htonl(INADDR_ANY); int sock = socket(AF_INET, SOCK_DGRAM, IPPROTO_IP); if (sock \u003c 0) { ESP_LOGE(TAG, \"audio recv socket create failed\"); vTaskDelete(NULL); return; } if (bind(sock, (struct sockaddr *)\u0026local_addr, sizeof(local_addr)) != 0) { ESP_LOGE(TAG, \"audio recv bind failed\"); } else { ESP_LOGI(TAG, \"Audio receiver listening on %d\", UDP_AUDIO_PORT); } int16_t pcm16[I2S_BUFFER_SAMPLES]; while (1) { int len = recvfrom(sock, pcm16, sizeof(pcm16), 0, NULL, NULL); if (len \u003e 0) { if (tx_handle == NULL) { ESP_LOGW(TAG, \"tx_handle NULL, received audio dropped\"); continue; } size_t bytes_written = 0; esp_err_t res = i2s_channel_write(tx_handle, pcm16, len, \u0026bytes_written, portMAX_DELAY); if (res != ESP_OK) { ESP_LOGW(TAG, \"i2s_channel_write failed: %s\", esp_err_to_name(res)); } } } close(sock); vTaskDelete(NULL); } void app_main(void) { // generate device id from MAC uint8_t mac[6]; esp_read_mac(mac, ESP_MAC_WIFI_STA); snprintf(device_id, sizeof(device_id), \"room_%02X%02X%02X\", mac[3], mac[4], mac[5]); ESP_LOGI(TAG, \"Device id: %s\", device_id); ESP_ERROR_CHECK(nvs_flash_init()); wifi_init_sta(); // init I2S rx/tx i2s_init_master_rx(); i2s_init_master_tx(); // log handles ESP_LOGI(TAG, \"rx_handle=%p tx_handle=%p\", rx_handle, tx_handle); xTaskCreate(heartbeat_task, \"heartbeat_task\", 4096, NULL, 5, NULL); xTaskCreate(cmd_listener_task, \"cmd_listener_task\", 4096, NULL, 5, NULL); xTaskCreate(audio_sender_task, \"audio_sender_task\", 8192, NULL, 5, NULL); xTaskCreate(audio_receiver_task, \"audio_receiver_task\", 8192, NULL, 5, NULL); } nodejs server import express from \"express\"; import dgram from \"dgram\"; import cors from \"cors\"; import path from \"path\"; import { fileURLToPath } from \"url\"; const AUDIO_PORT = 12345; const CMD_PORT = 12346; const HEARTBEAT_PORT = 12347; const HEARTBEAT_TIMEOUT = 10 * 1000; // 10ç§’ const app = express(); app.use(cors()); app.use(express.json()); // è®¾å¤‡åˆ—è¡¨ const devices = new Map(); // ip -\u003e { id, audio_port, last_seen } function cleanupDevices() { const now = Date.now(); for (const [ip, info] of devices) { if (now - info.last_seen \u003e HEARTBEAT_TIMEOUT) { devices.delete(ip); } } } // UDP å‘é€å‘½ä»¤ function sendCmd(ip, text) { const sock = dgram.createSocket(\"udp4\"); const buf = Buffer.from(text, \"utf-8\"); sock.send(buf, 0, buf.length, CMD_PORT, ip, (err) =\u003e { if (err) console.error(\"sendCmd error:\", err); sock.close(); }); } // å¿ƒè·³ç›‘å¬çº¿ç¨‹ function startHeartbeatListener() { const sock = dgram.createSocket(\"udp4\"); sock.bind(HEARTBEAT_PORT, () =\u003e { console.log(`Heartbeat listener running on UDP port ${HEARTBEAT_PORT}`); }); sock.on(\"message\", (msg, rinfo) =\u003e { const ip = rinfo.address; let parsed = null; const txt = msg.toString(\"utf-8\").trim(); try { parsed = JSON.parse(txt); } catch { const parts = txt.split(\":\"); if (parts[0].toLowerCase() === \"heartbeat\") { parsed = { type: \"heartbeat\", id: parts[1] || ip, audio_port: parseInt(parts[2]) || AUDIO_PORT, }; } } if (parsed \u0026\u0026 (parsed.type === \"heartbeat\" || parsed.id)) { devices.set(ip, { id: parsed.id || ip, audio_port: parsed.audio_port || AUDIO_PORT, last_seen: Date.now(), }); } cleanupDevices(); }); } // ç®€æ˜“å‰ç«¯ HTMLï¼ˆä¸ Python ç‰ˆç­‰ä»·ï¼‰ const INDEX_HTML = ` \u003c!doctype html\u003e Multiroom æ§åˆ¶é¢æ¿ Multiroom æ§åˆ¶é¢æ¿ åˆ·æ–°è®¾å¤‡ å¼€å§‹äº’é€šï¼ˆé€‰ä¸­ä¸¤ä¸ªï¼‰ åœæ­¢æ‰€æœ‰é€šè¯ è®¾å¤‡åˆ—è¡¨ SelectIPIDLast seenAudio port `; app.get(\"/\", (req, res) =\u003e { res.send(INDEX_HTML); }); // è·å–è®¾å¤‡åˆ—è¡¨ app.get(\"/devices\", (req, res) =\u003e { cleanupDevices(); const list = []; for (const [ip, info] of devices) { list.push({ ip, id: info.id, audio_port: info.audio_port, last_seen: new Date(info.last_seen).toLocaleString(), }); } res.json(list); }); // å¼€å§‹äº’é€š app.post(\"/start_call\", (req, res) =\u003e { const { a_ip, b_ip } = req.body; sendCmd(a_ip, `START_CALL:${b_ip}:${AUDIO_PORT}`); sendCmd(b_ip, `START_CALL:${a_ip}:${AUDIO_PORT}`); res.json({ status: \"ok\", msg: `${a_ip} \u003c-\u003e ${b_ip} started` }); }); // åœæ­¢æ‰€æœ‰äº’é€š app.post(\"/stop_all\", (req, res) =\u003e { const ips = Array.from(devices.keys()); for (const ip of ips) sendCmd(ip, \"STOP_CALL\"); res.json({ status: \"ok\", stopped: ips }); }); // å¯åŠ¨ const PORT = 5000; app.listen(PORT, \"0.0.0.0\", () =\u003e { console.log(`Web server running at http://0.0.0.0:${PORT}`); }); startHeartbeatListener(); åœ¨é¡¹ç›®æ ¹ç›®å½•çš„ package.json ä¸­æ·»åŠ ï¼š\n{ â€œtypeâ€: â€œmoduleâ€ }\nnode server.js\ngoserver eps32 package main import ( \"encoding/json\" \"fmt\" \"io\" \"log\" \"net\" \"net/http\" \"strconv\" \"strings\" \"sync\" \"time\" ) const ( AUDIO_PORT = 12345 CMD_PORT = 12346 HEARTBEAT_PORT = 12347 HEARTBEAT_TIMEOUT = 10 * time.Second CLEANUP_INTERVAL = 3 * time.Second HTTP_LISTEN_ADDR = \":5000\" ) type DeviceInfo struct { ID string `json:\"id\"` AudioPort int `json:\"audio_port\"` LastSeen time.Time `json:\"last_seen\"` } var ( devices = make(map[string]*DeviceInfo) mu sync.RWMutex ) func main() { go heartbeatListener() go cleanupLoop() http.HandleFunc(\"/\", indexHandler) http.HandleFunc(\"/devices\", devicesHandler) http.HandleFunc(\"/start_call\", startCallHandler) http.HandleFunc(\"/stop_all\", stopAllHandler) log.Printf(\"âœ… Web æ§åˆ¶ç«¯å·²å¯åŠ¨: http://0.0.0.0%s\\n\", HTTP_LISTEN_ADDR) if err := http.ListenAndServe(HTTP_LISTEN_ADDR, nil); err != nil { log.Fatalf(\"ListenAndServe: %v\", err) } } func heartbeatListener() { addr := net.UDPAddr{Port: HEARTBEAT_PORT, IP: net.IPv4zero} conn, err := net.ListenUDP(\"udp4\", \u0026addr) if err != nil { log.Fatalf(\"æ— æ³•å¯åŠ¨å¿ƒè·³ç›‘å¬ç«¯å£ %d: %v\", HEARTBEAT_PORT, err) } defer conn.Close() log.Printf(\"ğŸ”„ å¿ƒè·³ç›‘å¬å·²å¯åŠ¨ (UDP %d)\", HEARTBEAT_PORT) buf := make([]byte, 2048) for { n, raddr, err := conn.ReadFromUDP(buf) if err != nil { continue } txt := strings.TrimSpace(string(buf[:n])) ip := raddr.IP.String() var parsed map[string]interface{} var id string audioPort := AUDIO_PORT if err := json.Unmarshal([]byte(txt), \u0026parsed); err == nil { if v, ok := parsed[\"id\"]; ok { id = fmt.Sprintf(\"%v\", v) } if v, ok := parsed[\"audio_port\"]; ok { switch vv := v.(type) { case float64: audioPort = int(vv) case string: if p, err := strconv.Atoi(vv); err == nil { audioPort = p } } } } else { parts := strings.Split(txt, \":\") if len(parts) \u003e= 1 \u0026\u0026 strings.ToLower(parts[0]) == \"heartbeat\" { if len(parts) \u003e= 2 { id = parts[1] } if len(parts) \u003e= 3 { if p, err := strconv.Atoi(parts[2]); err == nil { audioPort = p } } } } if id == \"\" { id = ip } mu.Lock() devices[ip] = \u0026DeviceInfo{ID: id, AudioPort: audioPort, LastSeen: time.Now()} mu.Unlock() } } func cleanupLoop() { for { time.Sleep(CLEANUP_INTERVAL) now := time.Now() mu.Lock() for ip, info := range devices { if now.Sub(info.LastSeen) \u003e HEARTBEAT_TIMEOUT { delete(devices, ip) } } mu.Unlock() } } func indexHandler(w http.ResponseWriter, r *http.Request) { w.Header().Set(\"Content-Type\", \"text/html; charset=utf-8\") io.WriteString(w, indexHTML) } func devicesHandler(w http.ResponseWriter, r *http.Request) { mu.RLock() out := make([]map[string]interface{}, 0, len(devices)) for ip, info := range devices { out = append(out, map[string]interface{}{ \"ip\": ip, \"id\": info.ID, \"audio_port\": info.AudioPort, \"last_seen\": info.LastSeen.Format(\"2006-01-02 15:04:05\"), }) } mu.RUnlock() w.Header().Set(\"Content-Type\", \"application/json; charset=utf-8\") json.NewEncoder(w).Encode(out) } func startCallHandler(w http.ResponseWriter, r *http.Request) { var payload struct { AIP string `json:\"a_ip\"` BIP string `json:\"b_ip\"` } if err := json.NewDecoder(r.Body).Decode(\u0026payload); err != nil { http.Error(w, \"bad request\", http.StatusBadRequest) return } sendUDPCommand(payload.AIP, fmt.Sprintf(\"START_CALL:%s:%d\", payload.BIP, AUDIO_PORT)) sendUDPCommand(payload.BIP, fmt.Sprintf(\"START_CALL:%s:%d\", payload.AIP, AUDIO_PORT)) w.Header().Set(\"Content-Type\", \"application/json; charset=utf-8\") json.NewEncoder(w).Encode(map[string]interface{}{ \"status\": \"ok\", \"msg\": fmt.Sprintf(\"%s \u003c-\u003e %s started\", payload.AIP, payload.BIP), }) } func stopAllHandler(w http.ResponseWriter, r *http.Request) { mu.RLock() ips := make([]string, 0, len(devices)) for ip := range devices { ips = append(ips, ip) } mu.RUnlock() for _, ip := range ips { sendUDPCommand(ip, \"STOP_CALL\") } w.Header().Set(\"Content-Type\", \"application/json; charset=utf-8\") json.NewEncoder(w).Encode(map[string]interface{}{ \"status\": \"ok\", \"stopped\": ips, }) } func sendUDPCommand(ip, txt string) { addr := net.JoinHostPort(ip, strconv.Itoa(CMD_PORT)) conn, err := net.Dial(\"udp\", addr) if err != nil { log.Printf(\"UDP è¿æ¥å¤±è´¥ %s: %v\", ip, err) return } defer conn.Close() conn.Write([]byte(txt)) } const indexHTML = ` \u003c!doctype html\u003e Multiroom æ§åˆ¶é¢æ¿ Multiroom æ§åˆ¶é¢æ¿ åˆ·æ–°è®¾å¤‡ å¼€å§‹äº’é€šï¼ˆé€‰ä¸­ä¸¤ä¸ªï¼‰ åœæ­¢æ‰€æœ‰é€šè¯ è®¾å¤‡åˆ—è¡¨ SelectIPIDLast seenAudio port ` ç¼–è¯‘ \u0026 è¿è¡Œ\nåˆå§‹åŒ– moduleï¼ˆå¯é€‰ï¼Œæ¨èï¼‰ï¼š\ngo mod init multiroom ç›´æ¥è¿è¡Œï¼š\ngo run multiroom_server.go æˆ–æ„å»ºæˆå¯æ‰§è¡Œæ–‡ä»¶ï¼š\ngo build -o multiroom_server multiroom_server.go ./multiroom_server æµè§ˆå™¨è®¿é—® http://:5000ã€‚\nESP32 å¿ƒè·³æ ¼å¼ï¼š\nheartbeat:\u003cid\u003e:\u003caudio_port\u003e æˆ–\n{\"id\":\"esp32-1\",\"audio_port\":12345} Next å¤šè®¾å¤‡é—´ç‚¹å¯¹ç‚¹é€šè¯ï¼ˆA å‘¼å« Bï¼‰éŸ³é¢‘ä¸­ç»§ï¼Ÿ\nI2Cæ¸©åº¦ä¼ æ„Ÿå™¨ https://www.bilibili.com/video/BV1Tr42157oq\nSTM32 https://pan.quark.cn/s/799d9ec89b15\nESP-IDF\nthonny micropython arduino platformIO\n","wordCount":"11650","inLanguage":"en","datePublished":"2025-11-03T01:57:21+08:00","dateModified":"2025-11-03T01:57:21+08:00","author":{"@type":"Person","name":"dwd"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://qfsyso.github.io/posts/esp32-wifi-ble/"},"publisher":{"@type":"Organization","name":"MLOG","logo":{"@type":"ImageObject","url":"https://qfsyso.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://qfsyso.github.io/ accesskey=h title="MLOG (Alt + H)">MLOG</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://qfsyso.github.io/posts/ title=Archive><span>Archive</span></a></li><li><a href=https://qfsyso.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://qfsyso.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">ESP32 WIFI BLE</h1><div class=post-meta><span title='2025-11-03 01:57:21 +0800 +0800'>November 3, 2025</span>&nbsp;Â·&nbsp;55 min&nbsp;Â·&nbsp;dwd</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#hello-world aria-label="hello world">hello world</a></li><li><a href=#debug aria-label=debug>debug</a></li><li><a href=#%e4%ba%ae%e7%81%af aria-label=äº®ç¯>äº®ç¯</a><ul><li><a href=#%e9%97%b4%e9%9a%941s aria-label=é—´éš”1s>é—´éš”1s</a></li></ul></li><li><a href=#%e5%a4%96%e9%83%a8%e4%b8%ad%e6%96%ad-%e6%8c%89%e9%94%ae aria-label="å¤–éƒ¨ä¸­æ–­ ï¼ˆæŒ‰é”®ï¼‰">å¤–éƒ¨ä¸­æ–­ ï¼ˆæŒ‰é”®ï¼‰</a></li><li><a href=#%e5%ae%9a%e6%97%b6%e5%99%a8 aria-label=å®šæ—¶å™¨>å®šæ—¶å™¨</a></li><li><a href=#wifi aria-label=Wifi>Wifi</a><ul><li><a href=#%e5%88%9d%e5%a7%8b%e5%8c%96 aria-label=åˆå§‹åŒ–>åˆå§‹åŒ–</a></li><li><a href=#%e6%b3%a8%e5%86%8cwifi-ip%e4%ba%8b%e4%bb%b6%e5%9b%9e%e8%b0%83 aria-label="æ³¨å†Œwifi ipäº‹ä»¶å›è°ƒ">æ³¨å†Œwifi ipäº‹ä»¶å›è°ƒ</a></li><li><a href=#%e9%85%8d%e7%bd%aewifi%e5%90%af%e5%8a%a8 aria-label=é…ç½®wifiå¯åŠ¨>é…ç½®wifiå¯åŠ¨</a></li></ul></li><li><a href=#%e8%93%9d%e7%89%99%e9%85%8d%e7%bd%91 aria-label=è“ç‰™é…ç½‘>è“ç‰™é…ç½‘</a><ul><li><a href=#ble aria-label=BLE>BLE</a></li><li><a href=#%e7%bc%96%e8%af%91%e5%a4%b1%e8%b4%a5menuconfig-ble%e9%85%8d%e7%bd%ae aria-label="ç¼–è¯‘å¤±è´¥menuconfig bleé…ç½®">ç¼–è¯‘å¤±è´¥menuconfig bleé…ç½®</a></li><li><a href=#err-needed-by-partition_tablepartition-tablebin-missing-and-no-known-rule-to-make-it aria-label="ERR needed by &lsquo;partition_table/partition-table.bin&rsquo;, missing and no known rule to make it">ERR needed by &lsquo;partition_table/partition-table.bin&rsquo;, missing and no known rule to make it</a><ul><li><a href=#%e5%88%9b%e5%bb%ba-partitionscsv-%e6%96%87%e4%bb%b6 aria-label="åˆ›å»º partitions.csv æ–‡ä»¶">åˆ›å»º partitions.csv æ–‡ä»¶</a></li></ul></li><li><a href=#%e6%9e%84%e5%bb%ba%e7%83%a7%e5%bd%95%e6%88%90%e5%8a%9f%e5%90%8e%e6%89%93%e5%bc%80%e4%b8%8b%e8%bd%bd%e7%9a%84app aria-label=æ„å»ºçƒ§å½•æˆåŠŸåï¼Œæ‰“å¼€ä¸‹è½½çš„APP>æ„å»ºçƒ§å½•æˆåŠŸåï¼Œæ‰“å¼€ä¸‹è½½çš„APP</a></li><li><a href=#%e4%bc%98%e5%8c%96%e5%b7%b2%e7%bb%8f%e9%85%8d%e7%bd%91%e7%9a%84%e6%83%85%e5%86%b5 aria-label=ä¼˜åŒ–å·²ç»é…ç½‘çš„æƒ…å†µ>ä¼˜åŒ–å·²ç»é…ç½‘çš„æƒ…å†µ</a></li></ul></li><li><a href=#i2c aria-label=I2C>I2C</a><ul><li><a href=#%e8%af%bb%e5%86%99 aria-label=è¯»å†™>è¯»å†™</a><ul><li><a href=#%e5%86%99%e6%93%8d%e4%bd%9c%e4%b8%bb%e6%9c%ba%e5%90%91%e4%bb%8e%e6%9c%ba%e5%86%99%e6%95%b0%e6%8d%ae aria-label=å†™æ“ä½œï¼ˆä¸»æœºå‘ä»æœºå†™æ•°æ®ï¼‰>å†™æ“ä½œï¼ˆä¸»æœºå‘ä»æœºå†™æ•°æ®ï¼‰</a></li><li><a href=#%e8%af%bb%e6%93%8d%e4%bd%9c%e4%b8%bb%e6%9c%ba%e4%bb%8e%e4%bb%8e%e6%9c%ba%e8%af%bb%e6%95%b0%e6%8d%ae aria-label=è¯»æ“ä½œï¼ˆä¸»æœºä»ä»æœºè¯»æ•°æ®ï¼‰>è¯»æ“ä½œï¼ˆä¸»æœºä»ä»æœºè¯»æ•°æ®ï¼‰</a></li></ul></li><li><a href=#%e9%9d%99%e6%80%81ip aria-label=é™æ€IP>é™æ€IP</a></li><li><a href=#%e8%ae%be%e7%bd%ae%e5%9b%ba%e5%ae%9aip aria-label=è®¾ç½®å›ºå®šIP>è®¾ç½®å›ºå®šIP</a></li></ul></li><li><a href=#%e9%87%8d%e7%bd%aeesp aria-label=é‡ç½®ESP>é‡ç½®ESP</a></li><li><a href=#%e5%a4%9aesp32%e9%80%9a%e8%ae%af aria-label=å¤šesp32é€šè®¯>å¤šesp32é€šè®¯</a><ul><li><a href=#%e6%95%b0%e6%8d%ae%e5%8c%85 aria-label=æ•°æ®åŒ…>æ•°æ®åŒ…</a></li></ul></li><li><a href=#tcp aria-label=TCP>TCP</a></li><li><a href=#esp32%e4%b8%8e%e4%b8%bb%e6%9c%bapython%e7%a8%8b%e5%ba%8f-tcp%e8%bf%9e%e6%8e%a5%e4%bc%a0%e8%be%93%e9%9f%b3%e9%a2%91 aria-label="ESP32ä¸ä¸»æœºpythonç¨‹åº TCPè¿æ¥ä¼ è¾“éŸ³é¢‘">ESP32ä¸ä¸»æœºpythonç¨‹åº TCPè¿æ¥ä¼ è¾“éŸ³é¢‘</a></li><li><a href=#%e8%bf%9ewifi%e6%92%ad%e6%94%be%e5%86%85%e7%bd%91%e9%9f%b3%e9%a2%91 aria-label=è¿wifiæ’­æ”¾å†…ç½‘éŸ³é¢‘>è¿wifiæ’­æ”¾å†…ç½‘éŸ³é¢‘</a></li><li><a href=#%e9%80%9a%e8%bf%87udp%e5%b9%bf%e6%92%adesp32%e9%80%9a%e8%ae%af aria-label=é€šè¿‡UDPå¹¿æ’­ESP32é€šè®¯>é€šè¿‡UDPå¹¿æ’­ESP32é€šè®¯</a></li><li><a href=#python-server-esp32udp aria-label="python server esp32udp">python server esp32udp</a></li><li><a href=#nodejs-server aria-label="nodejs server">nodejs server</a></li><li><a href=#goserver-eps32 aria-label="goserver eps32">goserver eps32</a></li><li><a href=#next aria-label=Next>Next</a></li></ul></div></details></div><div class=post-content><h1 id=hello-world>hello world<a hidden class=anchor aria-hidden=true href=#hello-world>#</a></h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;inttypes.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;sdkconfig.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;freertos/FreeRTOS.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;freertos/task.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_chip_info.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_flash.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_system.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>app_main</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;Hello world!</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/* Print chip information */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>esp_chip_info_t</span> chip_info;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>uint32_t</span> flash_size;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_chip_info</span>(<span style=color:#f92672>&amp;</span>chip_info);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;This is %s chip with %d CPU core(s), %s%s%s%s, &#34;</span>,
</span></span><span style=display:flex><span>           CONFIG_IDF_TARGET,
</span></span><span style=display:flex><span>           chip_info.cores,
</span></span><span style=display:flex><span>           (chip_info.features <span style=color:#f92672>&amp;</span> CHIP_FEATURE_WIFI_BGN) <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;WiFi/&#34;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>           (chip_info.features <span style=color:#f92672>&amp;</span> CHIP_FEATURE_BT) <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;BT&#34;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>           (chip_info.features <span style=color:#f92672>&amp;</span> CHIP_FEATURE_BLE) <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;BLE&#34;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>           (chip_info.features <span style=color:#f92672>&amp;</span> CHIP_FEATURE_IEEE802154) <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;, 802.15.4 (Zigbee/Thread)&#34;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unsigned</span> major_rev <span style=color:#f92672>=</span> chip_info.revision <span style=color:#f92672>/</span> <span style=color:#ae81ff>100</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unsigned</span> minor_rev <span style=color:#f92672>=</span> chip_info.revision <span style=color:#f92672>%</span> <span style=color:#ae81ff>100</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;silicon revision v%d.%d, &#34;</span>, major_rev, minor_rev);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>esp_flash_get_size</span>(NULL, <span style=color:#f92672>&amp;</span>flash_size) <span style=color:#f92672>!=</span> ESP_OK) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;Get flash size failed&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;%&#34;</span> PRIu32 <span style=color:#e6db74>&#34;MB %s flash</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, flash_size <span style=color:#f92672>/</span> (<span style=color:#66d9ef>uint32_t</span>)(<span style=color:#ae81ff>1024</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1024</span>),
</span></span><span style=display:flex><span>           (chip_info.features <span style=color:#f92672>&amp;</span> CHIP_FEATURE_EMB_FLASH) <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;embedded&#34;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;external&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;Minimum free heap size: %&#34;</span> PRIu32 <span style=color:#e6db74>&#34; bytes</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#a6e22e>esp_get_minimum_free_heap_size</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span>; i <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0</span>; i<span style=color:#f92672>--</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;Restarting in %d seconds...</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, i);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>vTaskDelay</span>(<span style=color:#ae81ff>1000</span> <span style=color:#f92672>/</span> portTICK_PERIOD_MS);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;Restarting now.</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fflush</span>(stdout);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_restart</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æ„å»ºçƒ§å½•ç›‘è§†</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>I <span style=color:#f92672>(</span>272<span style=color:#f92672>)</span> main_task: Started on CPU0
</span></span><span style=display:flex><span>I <span style=color:#f92672>(</span>282<span style=color:#f92672>)</span> main_task: Calling app_main<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>Hello world!
</span></span><span style=display:flex><span>This is esp32 chip with <span style=color:#ae81ff>2</span> CPU core<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span>, WiFi/BTBLE, silicon revision v3.1, 2MB external flash
</span></span><span style=display:flex><span>Minimum free heap size: <span style=color:#ae81ff>306072</span> bytes
</span></span><span style=display:flex><span>Restarting in <span style=color:#ae81ff>10</span> seconds...
</span></span></code></pre></div><h1 id=debug>debug<a hidden class=anchor aria-hidden=true href=#debug>#</a></h1><p>æ¢å¦ä¸€ä¸ªå£ [è°ƒè¯•å£]
æ­¤æ—¶è®¾å¤‡ç®¡ç†å™¨å¯ä»¥çœ‹åˆ°
-é€šç”¨ä¸²è¡Œæ€»çº¿è®¾å¤‡
-USB JTAG/serial debug unit</p><p>IDE é€‰æ‹©ä¸²å£ é€‰æ‹©eps32 JTAG
ç‚¹debug å¼€å§‹å•æ­¥/æ–­ç‚¹è°ƒè¯•</p><p><a href=https://www.bilibili.com/video/BV1GZ42187U4>https://www.bilibili.com/video/BV1GZ42187U4</a></p><h1 id=äº®ç¯>äº®ç¯<a hidden class=anchor aria-hidden=true href=#äº®ç¯>#</a></h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;driver/gpio.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define LED_PIN GPIO_NUM_23  </span><span style=color:#75715e>// ä½¿ç”¨ GPIO23 æ§åˆ¶è¾“å‡º
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>app_main</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>gpio_config_t</span> io_config <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        .pin_bit_mask <span style=color:#f92672>=</span> (<span style=color:#ae81ff>1ULL</span> <span style=color:#f92672>&lt;&lt;</span> LED_PIN),
</span></span><span style=display:flex><span>        .mode <span style=color:#f92672>=</span> GPIO_MODE_OUTPUT,
</span></span><span style=display:flex><span>        .pull_up_en <span style=color:#f92672>=</span> GPIO_PULLUP_DISABLE,
</span></span><span style=display:flex><span>        .pull_down_en <span style=color:#f92672>=</span> GPIO_PULLDOWN_DISABLE,
</span></span><span style=display:flex><span>        .intr_type <span style=color:#f92672>=</span> GPIO_INTR_DISABLE,
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>gpio_config</span>(<span style=color:#f92672>&amp;</span>io_config);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>gpio_set_level</span>(LED_PIN, <span style=color:#ae81ff>1</span>); <span style=color:#75715e>// è¾“å‡ºé«˜ç”µå¹³ï¼ˆ3.3Vï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> (<span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ä¿æŒé«˜ç”µå¹³è¾“å‡º
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æ¥çº¿ï¼š
GPIO23 â†’ ç”µé˜»ï¼ˆ220Î©~330Î©ï¼‰ â†’ LED æ­£æï¼ˆé•¿è„šï¼‰
LED è´Ÿæï¼ˆçŸ­è„šï¼‰ â†’ GND</p><h2 id=é—´éš”1s>é—´éš”1s<a hidden class=anchor aria-hidden=true href=#é—´éš”1s>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;driver/gpio.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;freertos/FreeRTOS.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;freertos/task.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define LED_PIN GPIO_NUM_23  </span><span style=color:#75715e>// ä½¿ç”¨ GPIO23 æ§åˆ¶ LED
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>app_main</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#75715e>// é…ç½® GPIO23 ä¸ºè¾“å‡ºæ¨¡å¼
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>gpio_config_t</span> io_config <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        .pin_bit_mask <span style=color:#f92672>=</span> (<span style=color:#ae81ff>1ULL</span> <span style=color:#f92672>&lt;&lt;</span> LED_PIN),
</span></span><span style=display:flex><span>        .mode <span style=color:#f92672>=</span> GPIO_MODE_OUTPUT,
</span></span><span style=display:flex><span>        .pull_up_en <span style=color:#f92672>=</span> GPIO_PULLUP_DISABLE,
</span></span><span style=display:flex><span>        .pull_down_en <span style=color:#f92672>=</span> GPIO_PULLDOWN_DISABLE,
</span></span><span style=display:flex><span>        .intr_type <span style=color:#f92672>=</span> GPIO_INTR_DISABLE,
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>gpio_config</span>(<span style=color:#f92672>&amp;</span>io_config);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å¾ªç¯é—ªçƒ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>while</span> (<span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>gpio_set_level</span>(LED_PIN, <span style=color:#ae81ff>1</span>);  <span style=color:#75715e>// è¾“å‡ºé«˜ç”µå¹³ -&gt; LEDäº®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>vTaskDelay</span>(<span style=color:#a6e22e>pdMS_TO_TICKS</span>(<span style=color:#ae81ff>1000</span>)); <span style=color:#75715e>// å»¶æ—¶1ç§’
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>gpio_set_level</span>(LED_PIN, <span style=color:#ae81ff>0</span>);  <span style=color:#75715e>// è¾“å‡ºä½ç”µå¹³ -&gt; LEDç­
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>vTaskDelay</span>(<span style=color:#a6e22e>pdMS_TO_TICKS</span>(<span style=color:#ae81ff>1000</span>)); <span style=color:#75715e>// å»¶æ—¶1ç§’
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h1 id=å¤–éƒ¨ä¸­æ–­-æŒ‰é”®>å¤–éƒ¨ä¸­æ–­ ï¼ˆæŒ‰é”®ï¼‰<a hidden class=anchor aria-hidden=true href=#å¤–éƒ¨ä¸­æ–­-æŒ‰é”®>#</a></h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;driver/gpio.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;freertos/FreeRTOS.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;freertos/task.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_log.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_timer.h&#34;  // ç”¨äºè·å–æ—¶é—´æˆ³ï¼ˆå¾®ç§’ï¼‰</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define LED_PIN     GPIO_NUM_23
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define BUTTON_PIN  GPIO_NUM_0   </span><span style=color:#75715e>// æŒ‰é”®æ¥GPIO0ï¼Œä¸€ç«¯æ¥GND
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>TAG <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;LED_BUTTON&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>volatile</span> <span style=color:#66d9ef>int</span> led_state <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;             <span style=color:#75715e>// 0=ç­ï¼Œ1=äº®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>volatile</span> <span style=color:#66d9ef>int64_t</span> last_press_time <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;   <span style=color:#75715e>// ä¸Šæ¬¡æŒ‰é”®æ—¶é—´ï¼ˆé˜²æŠ–ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ä¸­æ–­æœåŠ¡å‡½æ•°ï¼ˆISRï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> IRAM_ATTR <span style=color:#a6e22e>button_isr_handler</span>(<span style=color:#66d9ef>void</span><span style=color:#f92672>*</span> arg)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int64_t</span> now <span style=color:#f92672>=</span> <span style=color:#a6e22e>esp_timer_get_time</span>();  <span style=color:#75715e>// å½“å‰æ—¶é—´ï¼ˆå¾®ç§’ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// é˜²æŠ–ï¼šåˆ¤æ–­ä¸¤æ¬¡æŒ‰ä¸‹é—´éš”æ˜¯å¦è¶…è¿‡ 200msï¼ˆ200000å¾®ç§’ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (now <span style=color:#f92672>-</span> last_press_time <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>200000</span>) {
</span></span><span style=display:flex><span>        led_state <span style=color:#f92672>=</span> <span style=color:#f92672>!</span>led_state;  <span style=color:#75715e>// ç¿»è½¬ LED çŠ¶æ€
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>gpio_set_level</span>(LED_PIN, led_state);
</span></span><span style=display:flex><span>        last_press_time <span style=color:#f92672>=</span> now;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>app_main</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#75715e>// é…ç½® LED è¾“å‡º
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>gpio_config_t</span> io_conf_led <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        .pin_bit_mask <span style=color:#f92672>=</span> (<span style=color:#ae81ff>1ULL</span> <span style=color:#f92672>&lt;&lt;</span> LED_PIN),
</span></span><span style=display:flex><span>        .mode <span style=color:#f92672>=</span> GPIO_MODE_OUTPUT,
</span></span><span style=display:flex><span>        .pull_up_en <span style=color:#f92672>=</span> GPIO_PULLUP_DISABLE,
</span></span><span style=display:flex><span>        .pull_down_en <span style=color:#f92672>=</span> GPIO_PULLDOWN_DISABLE,
</span></span><span style=display:flex><span>        .intr_type <span style=color:#f92672>=</span> GPIO_INTR_DISABLE
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>gpio_config</span>(<span style=color:#f92672>&amp;</span>io_conf_led);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åˆå§‹çŠ¶æ€ LEDç­
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>gpio_set_level</span>(LED_PIN, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// é…ç½®æŒ‰é”®è¾“å…¥ï¼ˆå¸¦ä¸Šæ‹‰ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>gpio_config_t</span> io_conf_btn <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        .pin_bit_mask <span style=color:#f92672>=</span> (<span style=color:#ae81ff>1ULL</span> <span style=color:#f92672>&lt;&lt;</span> BUTTON_PIN),
</span></span><span style=display:flex><span>        .mode <span style=color:#f92672>=</span> GPIO_MODE_INPUT,
</span></span><span style=display:flex><span>        .pull_up_en <span style=color:#f92672>=</span> GPIO_PULLUP_ENABLE,
</span></span><span style=display:flex><span>        .pull_down_en <span style=color:#f92672>=</span> GPIO_PULLDOWN_DISABLE,
</span></span><span style=display:flex><span>        .intr_type <span style=color:#f92672>=</span> GPIO_INTR_NEGEDGE <span style=color:#75715e>// æ£€æµ‹ä¸‹é™æ²¿ï¼ˆæŒ‰ä¸‹ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    };
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>gpio_config</span>(<span style=color:#f92672>&amp;</span>io_conf_btn);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ³¨å†Œä¸­æ–­æœåŠ¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>gpio_install_isr_service</span>(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>gpio_isr_handler_add</span>(BUTTON_PIN, button_isr_handler, NULL);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;System ready. Press button to toggle LED.&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ä¸»å¾ªç¯ç©ºè½¬å³å¯
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>while</span> (<span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>vTaskDelay</span>(<span style=color:#a6e22e>pdMS_TO_TICKS</span>(<span style=color:#ae81ff>1000</span>));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æ¥çº¿
å…ƒä»¶ è¿æ¥åˆ° ESP32
LED æ­£æï¼ˆé•¿è„šï¼‰ GPIO23 â†’ ç”µé˜»ï¼ˆ220Î©~330Î©ï¼‰
LED è´Ÿæï¼ˆçŸ­è„šï¼‰ GND
æŒ‰é”®ä¸€ç«¯ GPIO0
æŒ‰é”®å¦ä¸€ç«¯ GND</p><h1 id=å®šæ—¶å™¨>å®šæ—¶å™¨<a hidden class=anchor aria-hidden=true href=#å®šæ—¶å™¨>#</a></h1><p>æ–‡æ¡£https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/</p><p>APIå‚è€ƒ å¤–è®¾API é€šç”¨ç¡¬ä»¶å®šæ—¶å™¨ GPTimer</p><p>GPTimer åˆ›å»ºå’Œé…ç½®</p><p>ä½¿ç”¨ gptimer_config_t è®¾ç½®è®¡æ•°æ–¹å‘å’Œç²¾åº¦ã€‚</p><p>ä½¿ç”¨ gptimer_new_timer åˆ›å»ºå®šæ—¶å™¨å¥æŸ„ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Create timer handle&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>gptimer_handle_t</span> gptimer <span style=color:#f92672>=</span> NULL; <span style=color:#75715e>// å®šæ—¶å™¨å¥æŸ„
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>gptimer_config_t</span> timer_config <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        .clk_src <span style=color:#f92672>=</span> GPTIMER_CLK_SRC_DEFAULT, <span style=color:#75715e>// é»˜è®¤æ—¶é’Ÿæº
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        .direction <span style=color:#f92672>=</span> GPTIMER_COUNT_UP,      <span style=color:#75715e>// å‘ä¸Šè®¡æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        .resolution_hz <span style=color:#f92672>=</span> <span style=color:#ae81ff>1000000</span>,           <span style=color:#75715e>// è®¡æ•°ç²¾åº¦1MHzï¼ˆ1 tick = 1 usï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    };
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>gptimer_new_timer</span>(<span style=color:#f92672>&amp;</span>timer_config, <span style=color:#f92672>&amp;</span>gptimer)); <span style=color:#75715e>// åˆ›å»ºå®šæ—¶å™¨  ,æŒ‡é’ˆ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>gptimer_enable</span>(gptimer));<span style=color:#75715e>//åœæ­¢ 
</span></span></span></code></pre></div><h1 id=wifi>Wifi<a hidden class=anchor aria-hidden=true href=#wifi>#</a></h1><h2 id=åˆå§‹åŒ–>åˆå§‹åŒ–<a hidden class=anchor aria-hidden=true href=#åˆå§‹åŒ–>#</a></h2><p>nvs_flash_init
nvså­˜wifi</p><p>esp_netif_init
ç½‘ç»œæ¥å£</p><p>esp_event_loop_create_default
åˆ›å»ºäº‹ä»¶å¾ªç¯</p><p>esp_netif_create_default_wifi_sta
åˆ›å»ºwifi stationç½‘ç»œæ¥å£</p><h2 id=æ³¨å†Œwifi-ipäº‹ä»¶å›è°ƒ>æ³¨å†Œwifi ipäº‹ä»¶å›è°ƒ<a hidden class=anchor aria-hidden=true href=#æ³¨å†Œwifi-ipäº‹ä»¶å›è°ƒ>#</a></h2><p>esp_event_handler_instance_register</p><h2 id=é…ç½®wifiå¯åŠ¨>é…ç½®wifiå¯åŠ¨<a hidden class=anchor aria-hidden=true href=#é…ç½®wifiå¯åŠ¨>#</a></h2><p>ä½¿ç”¨esp_wifiinitåˆå§‹åŒ–wifiï¼Œä½¿ç”¨esp_wifi_set_modeè®¾ç½®wifiä¸ºstationæ¨¡å¼ã€‚
ä½¿ç”¨esp_wifisetconfigè®¾ç½®è¦è¿æ¥wifiçš„åç§°ä¸å¯†ç ã€‚
ä½¿ç”¨esp_wifistartå¯åŠ¨wifiï¼Œåœ¨äº‹ä»¶å›è°ƒä¸­ä½¿ç”¨esp_wifi_connectè¿æ¥wifiã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_wifi.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;freertos/FreeRTos.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;nvs_flash.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_log.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>test_esp_event_cb</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>event_handler_arg, <span style=color:#66d9ef>esp_event_base_t</span> event_base, <span style=color:#66d9ef>int32_t</span> event_id, <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>event_data)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (event_base <span style=color:#f92672>==</span> WIFI_EVENT <span style=color:#f92672>&amp;&amp;</span> event_id <span style=color:#f92672>==</span> WIFI_EVENT_STA_START)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>esp_wifi_connect</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (event_base <span style=color:#f92672>==</span> IP_EVENT <span style=color:#f92672>&amp;&amp;</span> event_id <span style=color:#f92672>==</span> IP_EVENT_STA_GOT_IP)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// IP_EVENT_ETH_GOT_IP ä»¥å¤ªç½‘
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>ip_event_t</span> <span style=color:#f92672>*</span>event <span style=color:#f92672>=</span> (<span style=color:#66d9ef>ip_event_t</span> <span style=color:#f92672>*</span>)event_data;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>ip_event_got_ip_t</span> <span style=color:#f92672>*</span>getInfostruct <span style=color:#f92672>=</span> (<span style=color:#66d9ef>ip_event_got_ip_t</span> <span style=color:#f92672>*</span>)event_data;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>esp_ip4_addr_t</span> ip <span style=color:#f92672>=</span> getInfostruct<span style=color:#f92672>-&gt;</span>ip_info.ip;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;getip success!&#34;</span> IPSTR <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#a6e22e>IP2STR</span>(<span style=color:#f92672>&amp;</span>ip));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>init_wifi1</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nvs_flash_init</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_netif_init</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_event_loop_create_default</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_netif_create_default_wifi_sta</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ³¨å†Œå›è°ƒ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>esp_event_handler_instance_t</span> wifi_event_handler;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_event_handler_instance_register</span>(WIFI_EVENT, ESP_EVENT_ANY_ID, test_esp_event_cb, NULL, <span style=color:#f92672>&amp;</span>wifi_event_handler);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_event_handler_instance_register</span>(IP_EVENT, ESP_EVENT_ANY_ID, test_esp_event_cb, NULL, <span style=color:#f92672>&amp;</span>wifi_event_handler);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åˆå§‹åŒ–wifi
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>wifi_init_config_t</span> cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>WIFI_INIT_CONFIG_DEFAULT</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_wifi_init</span>(<span style=color:#f92672>&amp;</span>cfg);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_wifi_set_mode</span>(WIFI_MODE_STA);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>wifi_interface_t</span> interface;
</span></span><span style=display:flex><span>    <span style=color:#75715e>// wifi_config_t wifi_config;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// memset(&amp;wifi_config, 0, sizeof(wifi_config));
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// strcpy((char *)wifi_config.sta.ssid, &#34;&#34;);
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// strcpy((char *)wifi_config.sta.password, &#34;&#34;);
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// esp_wifi_set_config(WIFI_IF_STA, &amp;wifi_config);
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>wifi_config_t</span> wifi_config <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        .sta <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            .ssid <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;RTCTW&#34;</span>, 
</span></span><span style=display:flex><span>            .password <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;123123*123&#34;</span>,
</span></span><span style=display:flex><span>            .bssid_set <span style=color:#f92672>=</span> false,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_wifi_set_config</span>(WIFI_IF_STA, <span style=color:#f92672>&amp;</span>wifi_config);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_wifi_start</span>();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>app_main</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>init_wifi1</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> (<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>vTaskDelay</span>(<span style=color:#ae81ff>1000</span> <span style=color:#f92672>/</span> portTICK_PERIOD_MS);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è¿è¡Œ çœ‹åˆ°getip success!åˆ™è¿æ¥æˆåŠŸ</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>I <span style=color:#f92672>(</span>3915<span style=color:#f92672>)</span> esp_netif_handlers: sta ip: 192.168.80.44, mask: 255.255.255.0, gw: 192.168.80.1
</span></span><span style=display:flex><span>getip success!192.168.80.44
</span></span></code></pre></div><pre><code>        ESP_LOGI(TAG, &quot;IP:&quot; IPSTR, IP2STR(&amp;ip.ip));
        ESP_LOGI(TAG, &quot;MASK:&quot; IPSTR, IP2STR(&amp;ip.netmask));
        ESP_LOGI(TAG, &quot;GW:&quot; IPSTR, IP2STR(&amp;ip.gw));
</code></pre><h1 id=è“ç‰™é…ç½‘>è“ç‰™é…ç½‘<a hidden class=anchor aria-hidden=true href=#è“ç‰™é…ç½‘>#</a></h1><p>åˆå§‹åŒ–nvsç½‘ç»œæ¥å£
äº‹ä»¶å›è°ƒWIFIE_VENTï¼ŒWIFI_PROV_EVENTï¼ŒIP_EVENTç­‰
é…ç½‘åˆå§‹åŒ–ä¸å¯åŠ¨
(1)ä½¿ç”¨wifi_prov_mgrinitåˆå§‹åŒ–é…ç½‘ç®¡ç†å™¨ã€‚
(2)ä½¿ç”¨wifi_prov_mgr_start_provisioningå¯åŠ¨é…ç½‘ã€‚</p><p>DOC&ä¸‹è½½é…ç½‘å·¥å…·
<a href=https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/provisioning/provisioning.html#id9>https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/provisioning/provisioning.html#id9</a>
è“ç‰™ BLE , WIFI SoftAP</p><h2 id=ble>BLE<a hidden class=anchor aria-hidden=true href=#ble>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;string.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdlib.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;freertos/FreeRTOS.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;freertos/task.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;freertos/event_groups.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_wifi.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;freertos/FreeRTos.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;nvs_flash.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_log.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;wifi_provisioning/manager.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;wifi_provisioning/scheme_ble.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define TAG &#34;prov-demo&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>test_esp_event_cb</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>event_handler_arg, <span style=color:#66d9ef>esp_event_base_t</span> event_base, <span style=color:#66d9ef>int32_t</span> event_id, <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>event_data)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (event_base <span style=color:#f92672>==</span> WIFI_EVENT)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#75715e>/* code */</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (event_base <span style=color:#f92672>==</span> WIFI_PROV_EVENT)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#75715e>/* code */</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>switch</span> ((event_id))
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> WIFI_PROV_START:
</span></span><span style=display:flex><span>            <span style=color:#75715e>/* code */</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;WIFI_PROV_START</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74> &#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> WIFI_PROV_CRED_RECV:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>wifi_sta_config_t</span> <span style=color:#f92672>*</span>wifi_sta_cfg <span style=color:#f92672>=</span> (<span style=color:#66d9ef>wifi_sta_config_t</span> <span style=color:#f92672>*</span>)event_data;
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Received Wi-Fi credentials&#34;</span>
</span></span><span style=display:flex><span>                          <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n\t</span><span style=color:#e6db74>SSID : %s</span><span style=color:#ae81ff>\n\t</span><span style=color:#e6db74>Password : %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74> &#34;</span>,
</span></span><span style=display:flex><span>                     (<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)wifi_sta_cfg<span style=color:#f92672>-&gt;</span>ssid,
</span></span><span style=display:flex><span>                     (<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)wifi_sta_cfg<span style=color:#f92672>-&gt;</span>password);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> WIFI_PROV_CRED_FAIL:
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;WIFI_PROV_CRED_FAIL</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74> &#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> WIFI_PROV_CRED_SUCCESS:
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;WIFI_PROV_CRED_SUCCESS</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74> &#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> WIFI_PROV_END:
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;WIFI_PROV_END</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74> &#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>wifi_prov_mgr_deinit</span>();
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>vTaskDelete</span>(NULL);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (event_base <span style=color:#f92672>==</span> IP_EVENT)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>app_main</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åˆå§‹åŒ–
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>nvs_flash_init</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_netif_init</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_event_loop_create_default</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_netif_create_default_wifi_sta</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>wifi_init_config_t</span> cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>WIFI_INIT_CONFIG_DEFAULT</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_wifi_init</span>(<span style=color:#f92672>&amp;</span>cfg);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ³¨å†Œå›è°ƒ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_event_handler_register</span>(WIFI_EVENT, ESP_EVENT_ANY_ID, test_esp_event_cb, NULL);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_event_handler_register</span>(WIFI_PROV_EVENT, ESP_EVENT_ANY_ID, test_esp_event_cb, NULL);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_event_handler_register</span>(IP_EVENT, ESP_EVENT_ANY_ID, test_esp_event_cb, NULL);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>wifi_prov_mgr_config_t</span> config <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        .scheme <span style=color:#f92672>=</span> wifi_prov_scheme_ble,
</span></span><span style=display:flex><span>        .scheme_event_handler <span style=color:#f92672>=</span> WIFI_PROV_SCHEME_BLE_EVENT_HANDLER_FREE_BLE,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>wifi_prov_mgr_init</span>(config);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>wifi_prov_mgr_start_provisioning</span>(WIFI_PROV_SECURITY_1, <span style=color:#e6db74>&#34;123123&#34;</span>,
</span></span><span style=display:flex><span>                                     <span style=color:#e6db74>&#34;PROV_Hello_LM_QF&#34;</span>, NULL);
</span></span><span style=display:flex><span>    <span style=color:#75715e>// wifi_prov_mgr_start_provisioning ç¬¬ä¸€ä¸ªå‚æ•°  wifi_prov_security_t security ä¸‰ç§å®‰å…¨æ–¹å¼
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// é…ç½‘å é‡Šæ”¾æ‰å†…å­˜
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> (<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>vTaskDelay</span>(<span style=color:#ae81ff>1000</span> <span style=color:#f92672>/</span> portTICK_PERIOD_MS);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>include &lt;wifi_provisioning/manager.h>å¤´æ–‡ä»¶/æ–°å¢ç»„ä»¶
CMakeLists.txt</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>idf_component_register<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>    SRCS <span style=color:#e6db74>&#34;wifi_eap_fast_main.c&#34;</span>  <span style=color:#75715e># æºæ–‡ä»¶åˆ—è¡¨</span>
</span></span><span style=display:flex><span>    INCLUDE_DIRS <span style=color:#e6db74>&#34;.&#34;</span>             <span style=color:#75715e># å¤´æ–‡ä»¶æœç´¢ç›®å½•</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># ç§æœ‰ä¾èµ–ï¼ˆå½“å‰ç»„ä»¶å†…éƒ¨ä½¿ç”¨ï¼Œä¸æš´éœ²ç»™ä¾èµ–å®ƒçš„å…¶ä»–ç»„ä»¶ï¼‰</span>
</span></span><span style=display:flex><span>    PRIV_REQUIRES 
</span></span><span style=display:flex><span>        esp_wifi 
</span></span><span style=display:flex><span>        wpa_supplicant 
</span></span><span style=display:flex><span>        nvs_flash 
</span></span><span style=display:flex><span>        wifi_provisioning  <span style=color:#75715e># æ–°å¢éœ€è¦çš„ç»„ä»¶ï¼ˆä¾‹å¦‚wifi_provisioningï¼‰</span>
</span></span><span style=display:flex><span>        esp_event          <span style=color:#75715e># ç¤ºä¾‹ï¼šè‹¥ç”¨åˆ°äº‹ä»¶å¾ªç¯ï¼Œå¯æ·»åŠ </span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># åµŒå…¥çš„æ–‡æœ¬æ–‡ä»¶ï¼ˆè¯ä¹¦ã€é…ç½®æ–‡ä»¶ç­‰ï¼Œä¿æŒä¸å˜ï¼‰</span>
</span></span><span style=display:flex><span>    EMBED_TXTFILES 
</span></span><span style=display:flex><span>        ca.pem 
</span></span><span style=display:flex><span>        pac_file.pac
</span></span><span style=display:flex><span><span style=color:#f92672>)</span>
</span></span></code></pre></div><p>æˆ–è€…åº•éƒ¨é½¿è½® menuconfigé…ç½®</p><h2 id=ç¼–è¯‘å¤±è´¥menuconfig-bleé…ç½®>ç¼–è¯‘å¤±è´¥menuconfig bleé…ç½®<a hidden class=anchor aria-hidden=true href=#ç¼–è¯‘å¤±è´¥menuconfig-bleé…ç½®>#</a></h2><p>æ‰“å¼€è“ç‰™ BLE-only</p><p>æ¸…ç†æ„å»º</p><h2 id=err-needed-by-partition_tablepartition-tablebin-missing-and-no-known-rule-to-make-it>ERR needed by &lsquo;partition_table/partition-table.bin&rsquo;, missing and no known rule to make it<a hidden class=anchor aria-hidden=true href=#err-needed-by-partition_tablepartition-tablebin-missing-and-no-known-rule-to-make-it>#</a></h2><h3 id=åˆ›å»º-partitionscsv-æ–‡ä»¶>åˆ›å»º partitions.csv æ–‡ä»¶<a hidden class=anchor aria-hidden=true href=#åˆ›å»º-partitionscsv-æ–‡ä»¶>#</a></h3><p>åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º partitions.csvè¿›å…¥ä½ çš„é¡¹ç›®æ–‡ä»¶å¤¹ E:/ESP32/ble/t22/project-namet22/ï¼Œæ–°å»ºä¸€ä¸ªåä¸º partitions.csv çš„æ–‡ä»¶ï¼ˆç”¨è®°äº‹æœ¬æˆ– VS Code ç­‰å·¥å…·åˆ›å»ºï¼‰ã€‚
å†™å…¥åˆ†åŒºè¡¨å†…å®¹æ ¹æ®ä½ çš„éœ€æ±‚ï¼Œåœ¨ partitions.csv ä¸­å¡«å…¥ä»¥ä¸‹å†…å®¹ï¼ˆç¤ºä¾‹ï¼Œé‡ç‚¹æ˜¯å¢å¤§ factory åˆ†åŒºå¤§å°ï¼‰ï¼š</p><pre tabindex=0><code class=language-csv data-lang=csv># Name,   Type, SubType, Offset,  Size, Flags
nvs,      data, nvs,     0x9000,  0x6000,
phy_init, data, phy,     0xf000,  0x1000,
factory,  app,  factory, 0x10000, 0x180000,  # è¿™é‡Œå°†å¤§å°æ”¹ä¸º 0x180000ï¼ˆ1.5MBï¼‰ï¼Œå¤§äºä½ çš„å›ºä»¶å¤§å° 0x137c10
</code></pre><p>è¯´æ˜ï¼š0x180000 æ˜¯åˆ†é…ç»™åº”ç”¨ç¨‹åºï¼ˆfactoryï¼‰çš„ç©ºé—´ï¼Œå¯æ ¹æ®éœ€è¦è°ƒæ•´ï¼ˆç¡®ä¿å¤§äºå›ºä»¶å®é™…å¤§å° 0x137c10ï¼‰ã€‚
å…¶ä»–åˆ†åŒºï¼ˆnvsã€phy_initï¼‰æ˜¯ ESP32 å¿…éœ€çš„ï¼Œä¿æŒé»˜è®¤å¤§å°å³å¯ã€‚
é‡æ–°ç¼–è¯‘ä¿å­˜ partitions.csv åï¼Œå†æ¬¡æ‰§è¡Œ idf.py buildï¼Œç¼–è¯‘ç³»ç»Ÿä¼šæ‰¾åˆ°è¯¥æ–‡ä»¶å¹¶ç”Ÿæˆæ­£ç¡®çš„åˆ†åŒºè¡¨ï¼Œè§£å†³ç¼ºå¤±æ–‡ä»¶çš„é”™è¯¯ã€‚</p><h2 id=æ„å»ºçƒ§å½•æˆåŠŸåæ‰“å¼€ä¸‹è½½çš„app>æ„å»ºçƒ§å½•æˆåŠŸåï¼Œæ‰“å¼€ä¸‹è½½çš„APP<a hidden class=anchor aria-hidden=true href=#æ„å»ºçƒ§å½•æˆåŠŸåæ‰“å¼€ä¸‹è½½çš„app>#</a></h2><p>è¿æ¥è“ç‰™ PROV_Hello_LM_QF è¾“å…¥å¯†ç  123123
ç„¶åè¿ä¸Šwifiåˆ™å¯ä»¥åœ¨PCçœ‹åˆ°wifiä¿¡æ¯</p><p>é…ç½‘æˆåŠŸæ˜¾ç¤º</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>I <span style=color:#f92672>(</span>142241<span style=color:#f92672>)</span> prov-demo: Received Wi-Fi credentials
</span></span><span style=display:flex><span>        SSID : RTCT123
</span></span><span style=display:flex><span>        Password : <span style=color:#ae81ff>123123123123</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>I <span style=color:#f92672>(</span>149221<span style=color:#f92672>)</span> esp_netif_handlers: sta ip: 192.168.80.44, mask: 255.255.255.0, gw: 192.168.80.1
</span></span><span style=display:flex><span>I <span style=color:#f92672>(</span>149221<span style=color:#f92672>)</span> wifi_prov_mgr: STA Got IP
</span></span><span style=display:flex><span>I <span style=color:#f92672>(</span>149221<span style=color:#f92672>)</span> prov-demo: WIFI_PROV_CRED_SUCCESS
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>W <span style=color:#f92672>(</span>150661<span style=color:#f92672>)</span> BT_HCI: hci cmd send: disconnect: hdl 0x0, rsn:0x13
</span></span><span style=display:flex><span>W <span style=color:#f92672>(</span>150761<span style=color:#f92672>)</span> BT_HCI: hcif disc complete: hdl 0x0, rsn 0x16 dev_find <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>I <span style=color:#f92672>(</span>151771<span style=color:#f92672>)</span> wifi_prov_mgr: Provisioning stopped
</span></span><span style=display:flex><span>I <span style=color:#f92672>(</span>151771<span style=color:#f92672>)</span> prov-demo: WIFI_PROV_END
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>I <span style=color:#f92672>(</span>151771<span style=color:#f92672>)</span> wifi_prov_scheme_ble: BLE memory released
</span></span></code></pre></div><p>æºç å‚è€ƒï¼šhttps://github.com/espressif/esp-idf/blob/v5.1.3/examples/provisioning/wifi_prov_mgr/main/app_main.c</p><h2 id=ä¼˜åŒ–å·²ç»é…ç½‘çš„æƒ…å†µ>ä¼˜åŒ–å·²ç»é…ç½‘çš„æƒ…å†µ<a hidden class=anchor aria-hidden=true href=#ä¼˜åŒ–å·²ç»é…ç½‘çš„æƒ…å†µ>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;string.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdlib.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;freertos/FreeRTOS.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;freertos/task.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;freertos/event_groups.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_wifi.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;nvs_flash.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_log.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_event.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_netif.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;wifi_provisioning/manager.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;wifi_provisioning/scheme_ble.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define TAG &#34;prov-demo&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>wifi_init_sta</span>(<span style=color:#66d9ef>void</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* WiFiäº‹ä»¶å›è°ƒ */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>test_esp_event_cb</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>event_handler_arg,
</span></span><span style=display:flex><span>                              <span style=color:#66d9ef>esp_event_base_t</span> event_base,
</span></span><span style=display:flex><span>                              <span style=color:#66d9ef>int32_t</span> event_id,
</span></span><span style=display:flex><span>                              <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>event_data)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (event_base <span style=color:#f92672>==</span> WIFI_EVENT)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>switch</span> (event_id)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> WIFI_EVENT_STA_START:
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>esp_wifi_connect</span>();
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Wi-Fi STA start&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> WIFI_EVENT_STA_CONNECTED:
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Wi-Fi connected&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> WIFI_EVENT_STA_DISCONNECTED:
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ESP_LOGW</span>(TAG, <span style=color:#e6db74>&#34;Wi-Fi disconnected, retrying...&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>esp_wifi_connect</span>();
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (event_base <span style=color:#f92672>==</span> WIFI_PROV_EVENT)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>switch</span> (event_id)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> WIFI_PROV_START:
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Provisioning started via BLE&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> WIFI_PROV_CRED_RECV:
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>wifi_sta_config_t</span> <span style=color:#f92672>*</span>wifi_sta_cfg <span style=color:#f92672>=</span> (<span style=color:#66d9ef>wifi_sta_config_t</span> <span style=color:#f92672>*</span>)event_data;
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Received Wi-Fi credentials</span><span style=color:#ae81ff>\n\t</span><span style=color:#e6db74>SSID: %s</span><span style=color:#ae81ff>\n\t</span><span style=color:#e6db74>Password: %s&#34;</span>,
</span></span><span style=display:flex><span>                     (<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)wifi_sta_cfg<span style=color:#f92672>-&gt;</span>ssid,
</span></span><span style=display:flex><span>                     (<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)wifi_sta_cfg<span style=color:#f92672>-&gt;</span>password);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> WIFI_PROV_CRED_FAIL:
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;Provisioning failed! Check credentials.&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> WIFI_PROV_CRED_SUCCESS:
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Provisioning successful!&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> WIFI_PROV_END:
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Provisioning finished, deinitializing manager&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>wifi_prov_mgr_deinit</span>();
</span></span><span style=display:flex><span>            <span style=color:#75715e>// å¼€å§‹ STA æ¨¡å¼è¿æ¥ WiFi
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#a6e22e>wifi_init_sta</span>();
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (event_base <span style=color:#f92672>==</span> IP_EVENT)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (event_id <span style=color:#f92672>==</span> IP_EVENT_STA_GOT_IP)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>ip_event_got_ip_t</span> <span style=color:#f92672>*</span>event <span style=color:#f92672>=</span> (<span style=color:#66d9ef>ip_event_got_ip_t</span> <span style=color:#f92672>*</span>)event_data;
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Got IP: &#34;</span> IPSTR, <span style=color:#a6e22e>IP2STR</span>(<span style=color:#f92672>&amp;</span>event<span style=color:#f92672>-&gt;</span>ip_info.ip));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* åˆå§‹åŒ– WiFi STA æ¨¡å¼ */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>wifi_init_sta</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>wifi_config_t</span> wifi_config;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_wifi_get_config</span>(WIFI_IF_STA, <span style=color:#f92672>&amp;</span>wifi_config);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_wifi_set_mode</span>(WIFI_MODE_STA));
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_wifi_start</span>());
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Connecting to saved Wi-Fi: %s&#34;</span>, wifi_config.sta.ssid);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_wifi_connect</span>();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* ä¸»å‡½æ•° */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>app_main</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åˆå§‹åŒ– NVS
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>nvs_flash_init</span>());
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_netif_init</span>());
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_event_loop_create_default</span>());
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_netif_create_default_wifi_sta</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>wifi_init_config_t</span> cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>WIFI_INIT_CONFIG_DEFAULT</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_wifi_init</span>(<span style=color:#f92672>&amp;</span>cfg));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ³¨å†Œäº‹ä»¶
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_event_handler_register</span>(WIFI_EVENT, ESP_EVENT_ANY_ID, test_esp_event_cb, NULL));
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_event_handler_register</span>(WIFI_PROV_EVENT, ESP_EVENT_ANY_ID, test_esp_event_cb, NULL));
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_event_handler_register</span>(IP_EVENT, IP_EVENT_STA_GOT_IP, test_esp_event_cb, NULL));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/* é…ç½‘ç®¡ç†å™¨é…ç½® */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>wifi_prov_mgr_config_t</span> prov_cfg <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        .scheme <span style=color:#f92672>=</span> wifi_prov_scheme_ble,
</span></span><span style=display:flex><span>        .scheme_event_handler <span style=color:#f92672>=</span> WIFI_PROV_SCHEME_BLE_EVENT_HANDLER_FREE_BLE,
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/* åˆå§‹åŒ–é…ç½‘ç®¡ç†å™¨ */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>wifi_prov_mgr_init</span>(prov_cfg));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>bool</span> provisioned <span style=color:#f92672>=</span> false;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>wifi_prov_mgr_is_provisioned</span>(<span style=color:#f92672>&amp;</span>provisioned));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (provisioned)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Device already provisioned, connecting to saved Wi-Fi...&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>wifi_prov_mgr_deinit</span>(); <span style=color:#75715e>// ä¸å†éœ€è¦é…ç½‘åŠŸèƒ½
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>wifi_init_sta</span>();         <span style=color:#75715e>// ç›´æ¥è¿æ¥ Wi-Fi
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Starting BLE provisioning...&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#75715e>// å¼€å§‹ BLE é…ç½‘
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>wifi_prov_mgr_start_provisioning</span>(WIFI_PROV_SECURITY_1,
</span></span><span style=display:flex><span>                                         <span style=color:#e6db74>&#34;123123&#34;</span>, <span style=color:#75715e>// proof of possession
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                                         <span style=color:#e6db74>&#34;BLE_PROV&#34;</span>, NULL);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> (<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>vTaskDelay</span>(<span style=color:#a6e22e>pdMS_TO_TICKS</span>(<span style=color:#ae81ff>1000</span>));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æ–°å¢å‡½æ•° <strong>wifi_init_sta()</strong>
å½“æ£€æµ‹åˆ°è®¾å¤‡å·²ç»é…ç½‘è¿‡ï¼Œå°±ç›´æ¥è¿æ¥ Wi-Fiã€‚</p><p>ä½¿ç”¨ <strong>wifi_prov_mgr_is_provisioned()</strong> åˆ¤æ–­çŠ¶æ€
é¿å…æ¯æ¬¡éƒ½è¿›å…¥ BLE é…ç½‘æ¨¡å¼ã€‚</p><p><strong>äº‹ä»¶å›è°ƒæ›´å®Œå–„</strong>
èƒ½æ­£ç¡®å¤„ç† Wi-Fi è¿æ¥ã€æ–­å¼€ã€è·å– IPã€é…ç½‘ç»“æŸç­‰äº‹ä»¶ã€‚</p><p>é…ç½‘æˆåŠŸåè‡ªåŠ¨åˆ‡æ¢ä¸º STA æ¨¡å¼è¿æ¥ Wi-Fiã€‚</p><h1 id=i2c>I2C<a hidden class=anchor aria-hidden=true href=#i2c>#</a></h1><p>IÂ²Cï¼ˆInter-Integrated Circuitï¼Œé›†æˆç”µè·¯é—´æ€»çº¿ï¼‰æ˜¯ä¸€ç§ç”± Philipsï¼ˆç° NXPï¼‰ äº 1982 å¹´å‘æ˜çš„ ä¸²è¡Œé€šä¿¡æ€»çº¿åè®®ï¼Œå¹¿æ³›ç”¨äºå¾®æ§åˆ¶å™¨ä¸å¤–å›´è®¾å¤‡ï¼ˆä¼ æ„Ÿå™¨ã€EEPROMã€æ˜¾ç¤ºå±ç­‰ï¼‰ä¹‹é—´çš„çŸ­è·ç¦»é€šä¿¡ã€‚</p><p><strong>ç‰¹æ€§</strong> è¯´æ˜
é€šä¿¡æ–¹å¼ åŒæ­¥ã€åŠåŒå·¥ã€ä¸²è¡Œé€šä¿¡
ä¼ è¾“çº¿ ä¸¤æ¡ä¿¡å·çº¿ï¼šSCLï¼ˆæ—¶é’Ÿï¼‰+ SDAï¼ˆæ•°æ®ï¼‰
è¿æ¥æ–¹å¼ å¤šä¸»å¤šä»ï¼ˆMulti-Master, Multi-Slaveï¼‰
é€šä¿¡è·ç¦» é€šå¸¸ä¸è¶…è¿‡ 1 ç±³ï¼ˆä¾èµ–é€Ÿç‡ä¸ç”µå®¹ï¼‰
é€šä¿¡é€Ÿç‡ æ ‡å‡†æ¨¡å¼ï¼ˆ100 kHzï¼‰ã€å¿«é€Ÿæ¨¡å¼ï¼ˆ400 kHzï¼‰ã€é«˜é€Ÿæ¨¡å¼ï¼ˆ3.4 MHzï¼‰ã€è¶…é«˜é€Ÿæ¨¡å¼ï¼ˆ5 MHzï¼‰</p><table><thead><tr><th>åè®®</th><th>çº¿æ•°</th><th>é€šä¿¡æ¨¡å¼</th><th>é€Ÿç‡</th><th>ä¼˜ç‚¹</th><th>å…¸å‹ç”¨é€”</th></tr></thead><tbody><tr><td>IÂ²C</td><td>2</td><td>åŒæ­¥åŠåŒå·¥</td><td>â‰¤ 3.4 Mbps</td><td>ç®€å•ã€çœçº¿ã€å¤šä»æœº</td><td>ä¼ æ„Ÿå™¨ã€é…ç½®æ¥å£</td></tr><tr><td>SPI</td><td>4+</td><td>å…¨åŒå·¥</td><td>â‰¤ 10 Mbps</td><td>é«˜é€Ÿã€ç¨³å®š</td><td>å­˜å‚¨å™¨ã€æ˜¾ç¤ºå±</td></tr><tr><td>UART</td><td>2</td><td>å¼‚æ­¥</td><td>â‰¤ 1 Mbps</td><td>ç®€å•ç‚¹å¯¹ç‚¹</td><td>ä¸²å£é€šä¿¡</td></tr></tbody></table><h2 id=è¯»å†™>è¯»å†™<a hidden class=anchor aria-hidden=true href=#è¯»å†™>#</a></h2><p>IÂ²C çš„è¯»å†™è¿‡ç¨‹åˆ†ä¸º å†™æ“ä½œï¼ˆMaster â†’ Slaveï¼‰ å’Œ è¯»æ“ä½œï¼ˆSlave â†’ Masterï¼‰ ä¸¤ç§ã€‚ä¸‹é¢è¯¦ç»†è¯´æ˜ä¸¤ç§è¿‡ç¨‹çš„æ—¶åºä¸æ­¥éª¤ ğŸ‘‡</p><h3 id=å†™æ“ä½œä¸»æœºå‘ä»æœºå†™æ•°æ®>å†™æ“ä½œï¼ˆä¸»æœºå‘ä»æœºå†™æ•°æ®ï¼‰<a hidden class=anchor aria-hidden=true href=#å†™æ“ä½œä¸»æœºå‘ä»æœºå†™æ•°æ®>#</a></h3><p><strong>æ—¶åºæµç¨‹</strong>
START â†’ [Slave Address + Write(0)] â†’ ACK â†’ [Register Address] â†’ ACK â†’ [Data Byte] â†’ ACK â†’ STOP</p><p><strong>æ­¥éª¤è¯´æ˜</strong></p><p>èµ·å§‹ä¿¡å·ï¼ˆSTARTï¼‰
ä¸»æœºæ‹‰ä½ SDAï¼ˆåœ¨ SCL ä¸ºé«˜æ—¶ï¼‰è¡¨ç¤ºé€šä¿¡å¼€å§‹ã€‚</p><p>å‘é€ä»æœºåœ°å€ + å†™æ ‡å¿—ä½ï¼ˆR/W=0ï¼‰
7 ä½ä»æœºåœ°å€ + 1 ä½æ–¹å‘ä½ï¼ˆ0 è¡¨ç¤ºå†™ï¼‰ã€‚</p><p>ç­‰å¾…ä»æœºåº”ç­”ï¼ˆACKï¼‰
ä»æœºæ£€æµ‹åˆ°è‡ªå·±çš„åœ°å€åï¼Œæ‹‰ä½ SDA è¡¨ç¤ºåº”ç­”ã€‚</p><p>å‘é€å¯„å­˜å™¨åœ°å€
ä¸»æœºå‘é€æƒ³å†™å…¥çš„å¯„å­˜å™¨åœ°å€ï¼ˆä¾‹å¦‚æ¸©åº¦ä¼ æ„Ÿå™¨çš„é…ç½®å¯„å­˜å™¨åœ°å€ï¼‰ã€‚</p><p>ä»æœºå†æ¬¡åº”ç­”ï¼ˆACKï¼‰</p><p>å‘é€æ•°æ®å­—èŠ‚
ä¸»æœºå‘é€è¦å†™å…¥çš„æ•°æ®ï¼ˆ8 ä½ï¼‰ã€‚</p><p>ä»æœºåº”ç­”ï¼ˆACKï¼‰</p><p>å‘é€åœæ­¢ä¿¡å·ï¼ˆSTOPï¼‰
ä¸»æœºåœ¨ SCL é«˜ç”µå¹³æ—¶é‡Šæ”¾ SDAï¼ˆç”±ä½å˜é«˜ï¼‰ï¼Œè¡¨ç¤ºé€šä¿¡ç»“æŸã€‚</p><h3 id=è¯»æ“ä½œä¸»æœºä»ä»æœºè¯»æ•°æ®>è¯»æ“ä½œï¼ˆä¸»æœºä»ä»æœºè¯»æ•°æ®ï¼‰<a hidden class=anchor aria-hidden=true href=#è¯»æ“ä½œä¸»æœºä»ä»æœºè¯»æ•°æ®>#</a></h3><p>IÂ²C è¯»æ“ä½œé€šå¸¸åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š</p><p>ç›´æ¥è¯»ï¼šéƒ¨åˆ†è®¾å¤‡ä¸Šç”µåé»˜è®¤æŒ‡å‘æŸä¸ªå¯„å­˜å™¨ï¼Œå¯ç›´æ¥è¯»å–ã€‚</p><p>å¯„å­˜å™¨å¯»å€è¯»ï¼šå…ˆå†™å…¥å¯„å­˜å™¨åœ°å€ï¼Œå†é‡æ–°å¯åŠ¨è¯»ã€‚</p><p>â€œå¯„å­˜å™¨å¯»å€è¯»â€æµç¨‹ï¼ˆæœ€å¸¸è§ï¼‰
START â†’ [Slave Address + Write(0)] â†’ ACK â†’ [Register Address] â†’ ACK
â†’ REPEATED START â†’ [Slave Address + Read(1)] â†’ ACK â†’ [Data Byte] â†’ NACK â†’ STOP</p><p><strong>æ­¥éª¤è¯´æ˜</strong></p><p>å‘é€ START
ä¸»æœºå‘èµ·é€šä¿¡ã€‚</p><p>å‘é€ä»æœºåœ°å€ + å†™æ ‡å¿—ï¼ˆR/W=0ï¼‰
è¡¨ç¤ºè¦å†™å…¥å¯„å­˜å™¨åœ°å€ã€‚</p><p>ä»æœºåº”ç­”ï¼ˆACKï¼‰</p><p>å‘é€è¦è¯»å–çš„å¯„å­˜å™¨åœ°å€</p><p>ä»æœºåº”ç­”ï¼ˆACKï¼‰</p><p>å‘é€é‡å¤èµ·å§‹ä¿¡å·ï¼ˆREPEATED STARTï¼‰
ä¸»æœºä¸é‡Šæ”¾æ€»çº¿ï¼Œè€Œé‡æ–°å‘èµ·ä¸€æ¬¡é€šä¿¡ã€‚</p><p>å‘é€ä»æœºåœ°å€ + è¯»æ ‡å¿—ï¼ˆR/W=1ï¼‰
è¡¨ç¤ºä¸»æœºè¦è¯»å–æ•°æ®ã€‚</p><p>ä»æœºåº”ç­”ï¼ˆACKï¼‰</p><p>ä»æœºå‘é€æ•°æ®å­—èŠ‚ï¼ˆ8 ä½ï¼‰
ä¸»æœºåœ¨ SCL é«˜ç”µå¹³æœŸé—´è¯»å– SDA ä¸Šçš„æ•°æ®ã€‚</p><p>ä¸»æœºå‘é€éåº”ç­”ï¼ˆNACKï¼‰
è¡¨ç¤ºè¯»å–ç»“æŸï¼ˆè‹¥éœ€è¯»å–å¤šä¸ªå­—èŠ‚ï¼Œåˆ™å‰é¢å­—èŠ‚éƒ½è¦å‘é€ ACKï¼Œæœ€åä¸€ä¸ªå­—èŠ‚å‘é€ NACKï¼‰ã€‚</p><p>ä¸»æœºå‘é€ STOP ä¿¡å·
é€šä¿¡ç»“æŸã€‚</p><h2 id=é™æ€ip>é™æ€IP<a hidden class=anchor aria-hidden=true href=#é™æ€ip>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span> <span style=color:#66d9ef>else</span> <span style=color:#a6e22e>if</span> (event_base <span style=color:#f92672>==</span> IP_EVENT)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (event_id <span style=color:#f92672>==</span> IP_EVENT_STA_GOT_IP)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>ip_event_got_ip_t</span> <span style=color:#f92672>*</span>event <span style=color:#f92672>=</span> (<span style=color:#66d9ef>ip_event_got_ip_t</span> <span style=color:#f92672>*</span>)event_data;
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Got IP: &#34;</span> IPSTR, <span style=color:#a6e22e>IP2STR</span>(<span style=color:#f92672>&amp;</span>event<span style=color:#f92672>-&gt;</span>ip_info.ip));
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Gateway: &#34;</span> IPSTR, <span style=color:#a6e22e>IP2STR</span>(<span style=color:#f92672>&amp;</span>event<span style=color:#f92672>-&gt;</span>ip_info.gw));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>//  ä¿®æ”¹ï¼šè§£æç½‘å…³IPï¼Œå¹¶è®¾ç½®é™æ€IP = å­ç½‘ + &#34;.81&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>uint8_t</span> <span style=color:#f92672>*</span>gw_bytes <span style=color:#f92672>=</span> (<span style=color:#66d9ef>uint8_t</span> <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>event<span style=color:#f92672>-&gt;</span>ip_info.gw.addr;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>esp_netif_ip_info_t</span> new_ip;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            new_ip.gw.addr <span style=color:#f92672>=</span> event<span style=color:#f92672>-&gt;</span>ip_info.gw.addr; <span style=color:#75715e>// ä¿ç•™ç½‘å…³
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            new_ip.netmask.addr <span style=color:#f92672>=</span> event<span style=color:#f92672>-&gt;</span>ip_info.netmask.addr; <span style=color:#75715e>// ä¿ç•™æ©ç 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// ç”Ÿæˆ 192.168.80.81 ç±»ä¼¼çš„é™æ€IP
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            new_ip.ip.addr <span style=color:#f92672>=</span> <span style=color:#a6e22e>IPADDR4_INIT</span>(<span style=color:#a6e22e>IP4ADDR</span>(gw_bytes[<span style=color:#ae81ff>0</span>], gw_bytes[<span style=color:#ae81ff>1</span>], gw_bytes[<span style=color:#ae81ff>2</span>], <span style=color:#ae81ff>81</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Setting static IP to: &#34;</span> IPSTR, <span style=color:#a6e22e>IP2STR</span>(<span style=color:#f92672>&amp;</span>new_ip.ip));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// å…³é—­ DHCP
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#a6e22e>esp_netif_dhcpc_stop</span>(sta_netif);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// è®¾ç½®æ–°çš„é™æ€IP
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_netif_set_ip_info</span>(sta_netif, <span style=color:#f92672>&amp;</span>new_ip));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><h2 id=è®¾ç½®å›ºå®šip>è®¾ç½®å›ºå®šIP<a hidden class=anchor aria-hidden=true href=#è®¾ç½®å›ºå®šip>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;string.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdlib.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;freertos/FreeRTOS.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;freertos/task.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;freertos/event_groups.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_wifi.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;nvs_flash.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_log.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_event.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_netif.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;wifi_provisioning/manager.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;wifi_provisioning/scheme_ble.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;lwip/ip4_addr.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define TAG &#34;prov-demo&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>wifi_init_sta</span>(<span style=color:#66d9ef>void</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>bool</span> static_ip_set <span style=color:#f92672>=</span> false; <span style=color:#75715e>// é˜²æ­¢é‡å¤è®¾ç½®é™æ€IP
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* WiFiäº‹ä»¶å›è°ƒ */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>test_esp_event_cb</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>event_handler_arg,
</span></span><span style=display:flex><span>                              <span style=color:#66d9ef>esp_event_base_t</span> event_base,
</span></span><span style=display:flex><span>                              <span style=color:#66d9ef>int32_t</span> event_id,
</span></span><span style=display:flex><span>                              <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>event_data)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (event_base <span style=color:#f92672>==</span> WIFI_EVENT)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>switch</span> (event_id)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> WIFI_EVENT_STA_START:
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>esp_wifi_connect</span>();
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Wi-Fi STA start&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> WIFI_EVENT_STA_CONNECTED:
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Wi-Fi connected&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// âœ… åªåœ¨ç¬¬ä¸€æ¬¡è¿æ¥æ—¶è®¾ç½®é™æ€IP
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>static_ip_set)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>esp_netif_t</span> <span style=color:#f92672>*</span>netif <span style=color:#f92672>=</span> <span style=color:#a6e22e>esp_netif_get_handle_from_ifkey</span>(<span style=color:#e6db74>&#34;WIFI_STA_DEF&#34;</span>);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (netif)
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>esp_netif_ip_info_t</span> ip_info;
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>esp_netif_get_ip_info</span>(netif, <span style=color:#f92672>&amp;</span>ip_info);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>uint8_t</span> <span style=color:#f92672>*</span>p <span style=color:#f92672>=</span> (<span style=color:#66d9ef>uint8_t</span> <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>ip_info.gw.addr;
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Gateway: %d.%d.%d.%d&#34;</span>, p[<span style=color:#ae81ff>0</span>], p[<span style=color:#ae81ff>1</span>], p[<span style=color:#ae81ff>2</span>], p[<span style=color:#ae81ff>3</span>]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// å›ºå®šé™æ€ IP = ç½‘å…³å‰ä¸‰æ®µ + .81
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#a6e22e>IP4_ADDR</span>(<span style=color:#f92672>&amp;</span>ip_info.ip, p[<span style=color:#ae81ff>0</span>], p[<span style=color:#ae81ff>1</span>], p[<span style=color:#ae81ff>2</span>], <span style=color:#ae81ff>81</span>);
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>IP4_ADDR</span>(<span style=color:#f92672>&amp;</span>ip_info.gw, p[<span style=color:#ae81ff>0</span>], p[<span style=color:#ae81ff>1</span>], p[<span style=color:#ae81ff>2</span>], <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>IP4_ADDR</span>(<span style=color:#f92672>&amp;</span>ip_info.netmask, <span style=color:#ae81ff>255</span>, <span style=color:#ae81ff>255</span>, <span style=color:#ae81ff>255</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// åœæ­¢ DHCPï¼Œè®¾ç½®é™æ€ IP
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_netif_dhcpc_stop</span>(netif));
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_netif_set_ip_info</span>(netif, <span style=color:#f92672>&amp;</span>ip_info));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    static_ip_set <span style=color:#f92672>=</span> true;
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Static IP set to: &#34;</span> IPSTR, <span style=color:#a6e22e>IP2STR</span>(<span style=color:#f92672>&amp;</span>ip_info.ip));
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> WIFI_EVENT_STA_DISCONNECTED:
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ESP_LOGW</span>(TAG, <span style=color:#e6db74>&#34;Wi-Fi disconnected, retrying...&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>esp_wifi_connect</span>();
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (event_base <span style=color:#f92672>==</span> WIFI_PROV_EVENT)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>switch</span> (event_id)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> WIFI_PROV_START:
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Provisioning started via BLE&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> WIFI_PROV_CRED_RECV:
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>wifi_sta_config_t</span> <span style=color:#f92672>*</span>wifi_sta_cfg <span style=color:#f92672>=</span> (<span style=color:#66d9ef>wifi_sta_config_t</span> <span style=color:#f92672>*</span>)event_data;
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Received Wi-Fi credentials</span><span style=color:#ae81ff>\n\t</span><span style=color:#e6db74>SSID: %s</span><span style=color:#ae81ff>\n\t</span><span style=color:#e6db74>Password: %s&#34;</span>,
</span></span><span style=display:flex><span>                     (<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)wifi_sta_cfg<span style=color:#f92672>-&gt;</span>ssid,
</span></span><span style=display:flex><span>                     (<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)wifi_sta_cfg<span style=color:#f92672>-&gt;</span>password);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> WIFI_PROV_CRED_FAIL:
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;Provisioning failed! Check credentials.&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> WIFI_PROV_CRED_SUCCESS:
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Provisioning successful!&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> WIFI_PROV_END:
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Provisioning finished, deinitializing manager&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>wifi_prov_mgr_deinit</span>();
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>wifi_init_sta</span>();
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (event_base <span style=color:#f92672>==</span> IP_EVENT <span style=color:#f92672>&amp;&amp;</span> event_id <span style=color:#f92672>==</span> IP_EVENT_STA_GOT_IP)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>ip_event_got_ip_t</span> <span style=color:#f92672>*</span>event <span style=color:#f92672>=</span> (<span style=color:#66d9ef>ip_event_got_ip_t</span> <span style=color:#f92672>*</span>)event_data;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Got IP: &#34;</span> IPSTR, <span style=color:#a6e22e>IP2STR</span>(<span style=color:#f92672>&amp;</span>event<span style=color:#f92672>-&gt;</span>ip_info.ip));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* åˆå§‹åŒ– WiFi STA æ¨¡å¼ */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>wifi_init_sta</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>wifi_config_t</span> wifi_config;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_wifi_get_config</span>(WIFI_IF_STA, <span style=color:#f92672>&amp;</span>wifi_config);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_wifi_set_mode</span>(WIFI_MODE_STA));
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_wifi_start</span>());
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Connecting to saved Wi-Fi: %s&#34;</span>, wifi_config.sta.ssid);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_wifi_connect</span>();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* ä¸»å‡½æ•° */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>app_main</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åˆå§‹åŒ– NVS
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>nvs_flash_init</span>());
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_netif_init</span>());
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_event_loop_create_default</span>());
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_netif_create_default_wifi_sta</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>wifi_init_config_t</span> cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>WIFI_INIT_CONFIG_DEFAULT</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_wifi_init</span>(<span style=color:#f92672>&amp;</span>cfg));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ³¨å†Œäº‹ä»¶
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_event_handler_register</span>(WIFI_EVENT, ESP_EVENT_ANY_ID, test_esp_event_cb, NULL));
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_event_handler_register</span>(WIFI_PROV_EVENT, ESP_EVENT_ANY_ID, test_esp_event_cb, NULL));
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_event_handler_register</span>(IP_EVENT, IP_EVENT_STA_GOT_IP, test_esp_event_cb, NULL));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/* é…ç½‘ç®¡ç†å™¨é…ç½® */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>wifi_prov_mgr_config_t</span> prov_cfg <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        .scheme <span style=color:#f92672>=</span> wifi_prov_scheme_ble,
</span></span><span style=display:flex><span>        .scheme_event_handler <span style=color:#f92672>=</span> WIFI_PROV_SCHEME_BLE_EVENT_HANDLER_FREE_BLE,
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/* åˆå§‹åŒ–é…ç½‘ç®¡ç†å™¨ */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>wifi_prov_mgr_init</span>(prov_cfg));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>bool</span> provisioned <span style=color:#f92672>=</span> false;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>wifi_prov_mgr_is_provisioned</span>(<span style=color:#f92672>&amp;</span>provisioned));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (provisioned)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Device already provisioned, connecting to saved Wi-Fi...&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>wifi_prov_mgr_deinit</span>(); <span style=color:#75715e>// ä¸å†éœ€è¦é…ç½‘åŠŸèƒ½
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>wifi_init_sta</span>();        <span style=color:#75715e>// ç›´æ¥è¿æ¥ Wi-Fi
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Starting BLE provisioning...&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#75715e>// å¼€å§‹ BLE é…ç½‘
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>wifi_prov_mgr_start_provisioning</span>(WIFI_PROV_SECURITY_1,
</span></span><span style=display:flex><span>                                         <span style=color:#e6db74>&#34;123123&#34;</span>, <span style=color:#75715e>// proof of possession
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                                         <span style=color:#e6db74>&#34;PROV_HELLO_QF_LM2&#34;</span>, NULL);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> (<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>vTaskDelay</span>(<span style=color:#a6e22e>pdMS_TO_TICKS</span>(<span style=color:#ae81ff>1000</span>));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h1 id=é‡ç½®esp>é‡ç½®ESP<a hidden class=anchor aria-hidden=true href=#é‡ç½®esp>#</a></h1><p>æ‰¾åˆ°å¼€å‘æ¿ä¸Šçš„BOOTæŒ‰é”®å’ŒENï¼ˆä½¿èƒ½ï¼‰æŒ‰é”®ã€‚
å…ˆæŒ‰ä½BOOTæŒ‰é”®ä¸æ¾å¼€ï¼Œå†æŒ‰ä¸‹ENæŒ‰é”®ï¼Œéšåæ¾å¼€ENæŒ‰é”®ï¼Œä¿æŒBOOTæŒ‰é”®æŒ‰ä½å‡ ç§’åæ¾å¼€ï¼Œå³å¯å®Œæˆé‡ç½®ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_system.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// é‡å¯ ESP32
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>esp_restart</span>();
</span></span></code></pre></div><p>ä¼˜åŒ–</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;string.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdlib.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;freertos/FreeRTOS.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;freertos/task.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;freertos/event_groups.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_wifi.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;nvs_flash.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_log.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_event.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_netif.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;wifi_provisioning/manager.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;wifi_provisioning/scheme_ble.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;lwip/ip4_addr.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define TAG &#34;prov-demo&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>bool</span> static_ip_set <span style=color:#f92672>=</span> false;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* === Wi-Fi äº‹ä»¶å¤„ç†å›è°ƒ === */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>wifi_event_handler</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>event_handler_arg,
</span></span><span style=display:flex><span>                               <span style=color:#66d9ef>esp_event_base_t</span> event_base,
</span></span><span style=display:flex><span>                               <span style=color:#66d9ef>int32_t</span> event_id,
</span></span><span style=display:flex><span>                               <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>event_data)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (event_base <span style=color:#f92672>==</span> WIFI_EVENT)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>switch</span> (event_id)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> WIFI_EVENT_STA_START:
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Wi-Fi STA started&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>esp_wifi_connect</span>();
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> WIFI_EVENT_STA_DISCONNECTED:
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ESP_LOGW</span>(TAG, <span style=color:#e6db74>&#34;Wi-Fi disconnected, retrying...&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>esp_wifi_connect</span>();
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (event_base <span style=color:#f92672>==</span> WIFI_PROV_EVENT)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>switch</span> (event_id)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> WIFI_PROV_START:
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Provisioning started via BLE&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> WIFI_PROV_CRED_RECV:
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>wifi_sta_config_t</span> <span style=color:#f92672>*</span>wifi_sta_cfg <span style=color:#f92672>=</span> (<span style=color:#66d9ef>wifi_sta_config_t</span> <span style=color:#f92672>*</span>)event_data;
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Received Wi-Fi credentials</span><span style=color:#ae81ff>\n\t</span><span style=color:#e6db74>SSID: %s</span><span style=color:#ae81ff>\n\t</span><span style=color:#e6db74>Password: %s&#34;</span>,
</span></span><span style=display:flex><span>                     (<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)wifi_sta_cfg<span style=color:#f92672>-&gt;</span>ssid,
</span></span><span style=display:flex><span>                     (<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)wifi_sta_cfg<span style=color:#f92672>-&gt;</span>password);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> WIFI_PROV_CRED_FAIL:
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;Provisioning failed! Check credentials.&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> WIFI_PROV_CRED_SUCCESS:
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Provisioning successful!&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> WIFI_PROV_END:
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Provisioning finished, deinitializing manager&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>wifi_prov_mgr_deinit</span>();
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>esp_wifi_start</span>();
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (event_base <span style=color:#f92672>==</span> IP_EVENT <span style=color:#f92672>&amp;&amp;</span> event_id <span style=color:#f92672>==</span> IP_EVENT_STA_GOT_IP)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>ip_event_got_ip_t</span> <span style=color:#f92672>*</span>event <span style=color:#f92672>=</span> (<span style=color:#66d9ef>ip_event_got_ip_t</span> <span style=color:#f92672>*</span>)event_data;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>esp_netif_ip_info_t</span> ip_info <span style=color:#f92672>=</span> event<span style=color:#f92672>-&gt;</span>ip_info;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>uint8_t</span> <span style=color:#f92672>*</span>gw <span style=color:#f92672>=</span> (<span style=color:#66d9ef>uint8_t</span> <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>ip_info.gw.addr;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Got IP: &#34;</span> IPSTR, <span style=color:#a6e22e>IP2STR</span>(<span style=color:#f92672>&amp;</span>ip_info.ip));
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Gateway: %d.%d.%d.%d&#34;</span>, gw[<span style=color:#ae81ff>0</span>], gw[<span style=color:#ae81ff>1</span>], gw[<span style=color:#ae81ff>2</span>], gw[<span style=color:#ae81ff>3</span>]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ä»…åœ¨ç¬¬ä¸€æ¬¡è¿æ¥æˆåŠŸæ—¶å°è¯•ä¿®æ”¹é™æ€ IP
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>static_ip_set)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (ip_info.gw.addr <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>ESP_LOGW</span>(TAG, <span style=color:#e6db74>&#34;Invalid gateway (0.0.0.0), restarting BLE provisioning...&#34;</span>);
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>vTaskDelay</span>(<span style=color:#a6e22e>pdMS_TO_TICKS</span>(<span style=color:#ae81ff>2000</span>));
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>esp_restart</span>(); <span style=color:#75715e>// é‡æ–°å¯åŠ¨ç³»ç»Ÿï¼Œå›åˆ°é…ç½‘æ¨¡å¼
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>esp_netif_t</span> <span style=color:#f92672>*</span>netif <span style=color:#f92672>=</span> <span style=color:#a6e22e>esp_netif_get_handle_from_ifkey</span>(<span style=color:#e6db74>&#34;WIFI_STA_DEF&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (netif)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// åœæ­¢ DHCP å®¢æˆ·ç«¯
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_netif_dhcpc_stop</span>(netif));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// ä½¿ç”¨å½“å‰ç½‘å…³çš„å‰ä¸‰æ®µï¼Œå¹¶å›ºå®šæœ«å°¾ä¸º .83
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#a6e22e>IP4_ADDR</span>(<span style=color:#f92672>&amp;</span>ip_info.ip, gw[<span style=color:#ae81ff>0</span>], gw[<span style=color:#ae81ff>1</span>], gw[<span style=color:#ae81ff>2</span>], <span style=color:#ae81ff>83</span>);
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>IP4_ADDR</span>(<span style=color:#f92672>&amp;</span>ip_info.gw, gw[<span style=color:#ae81ff>0</span>], gw[<span style=color:#ae81ff>1</span>], gw[<span style=color:#ae81ff>2</span>], <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>IP4_ADDR</span>(<span style=color:#f92672>&amp;</span>ip_info.netmask, <span style=color:#ae81ff>255</span>, <span style=color:#ae81ff>255</span>, <span style=color:#ae81ff>255</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// åº”ç”¨æ–°çš„ IP
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_netif_set_ip_info</span>(netif, <span style=color:#f92672>&amp;</span>ip_info));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                static_ip_set <span style=color:#f92672>=</span> true;
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Static IP successfully set to: &#34;</span> IPSTR, <span style=color:#a6e22e>IP2STR</span>(<span style=color:#f92672>&amp;</span>ip_info.ip));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// æ–­å¼€å¹¶é‡æ–°è¿æ¥ Wi-Fi ä»¥ä½¿ç”¨æ–° IP
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#a6e22e>esp_wifi_disconnect</span>();
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>vTaskDelay</span>(<span style=color:#a6e22e>pdMS_TO_TICKS</span>(<span style=color:#ae81ff>500</span>));
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>esp_wifi_connect</span>();
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* === Wi-Fi åˆå§‹åŒ– === */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>wifi_init_sta</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>wifi_config_t</span> wifi_cfg <span style=color:#f92672>=</span> {<span style=color:#ae81ff>0</span>};
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_wifi_get_config</span>(WIFI_IF_STA, <span style=color:#f92672>&amp;</span>wifi_cfg);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_wifi_set_mode</span>(WIFI_MODE_STA));
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_wifi_set_config</span>(WIFI_IF_STA, <span style=color:#f92672>&amp;</span>wifi_cfg));
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_wifi_start</span>());
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_wifi_connect</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Connecting to saved Wi-Fi: %s&#34;</span>, wifi_cfg.sta.ssid);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* === ä¸»å‡½æ•° === */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>app_main</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åˆå§‹åŒ– NVS
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>nvs_flash_init</span>());
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_netif_init</span>());
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_event_loop_create_default</span>());
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_netif_create_default_wifi_sta</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>wifi_init_config_t</span> cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>WIFI_INIT_CONFIG_DEFAULT</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_wifi_init</span>(<span style=color:#f92672>&amp;</span>cfg));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ³¨å†Œäº‹ä»¶
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_event_handler_register</span>(WIFI_EVENT, ESP_EVENT_ANY_ID, wifi_event_handler, NULL));
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_event_handler_register</span>(WIFI_PROV_EVENT, ESP_EVENT_ANY_ID, wifi_event_handler, NULL));
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_event_handler_register</span>(IP_EVENT, IP_EVENT_STA_GOT_IP, wifi_event_handler, NULL));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// BLE é…ç½‘é…ç½®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>wifi_prov_mgr_config_t</span> prov_cfg <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        .scheme <span style=color:#f92672>=</span> wifi_prov_scheme_ble,
</span></span><span style=display:flex><span>        .scheme_event_handler <span style=color:#f92672>=</span> WIFI_PROV_SCHEME_BLE_EVENT_HANDLER_FREE_BLE,
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>wifi_prov_mgr_init</span>(prov_cfg));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>bool</span> provisioned <span style=color:#f92672>=</span> false;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>wifi_prov_mgr_is_provisioned</span>(<span style=color:#f92672>&amp;</span>provisioned));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (provisioned)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Already provisioned, connecting to Wi-Fi...&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>wifi_prov_mgr_deinit</span>();
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>wifi_init_sta</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Starting BLE provisioning...&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>wifi_prov_mgr_start_provisioning</span>(WIFI_PROV_SECURITY_1,
</span></span><span style=display:flex><span>                                         <span style=color:#e6db74>&#34;123123&#34;</span>,
</span></span><span style=display:flex><span>                                         <span style=color:#e6db74>&#34;PROV_HELLO_QF_LM23&#34;</span>,
</span></span><span style=display:flex><span>                                         NULL);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> (<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>vTaskDelay</span>(<span style=color:#a6e22e>pdMS_TO_TICKS</span>(<span style=color:#ae81ff>1000</span>));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h1 id=å¤šesp32é€šè®¯>å¤šesp32é€šè®¯<a hidden class=anchor aria-hidden=true href=#å¤šesp32é€šè®¯>#</a></h1><p>æ¥æ”¶ç«¯</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;string.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;freertos/FreeRTOS.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;freertos/task.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_wifi.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_event.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_log.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_system.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;nvs_flash.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;lwip/err.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;lwip/sockets.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;lwip/sys.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;lwip/netdb.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;driver/i2s_std.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;driver/gpio.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>TAG <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;audio_receiver&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// WiFié…ç½®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define WIFI_SSID &#34;RTCT2300&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define WIFI_PASS &#34;123123*zxcvb&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// UDPé…ç½®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define UDP_PORT 1234
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define BUF_SIZE (1023 * 1 * 32 / 8)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// MAX98357Aå¼•è„š
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define MAX_DIN GPIO_NUM_15
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define MAX_BCLK GPIO_NUM_16
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define MAX_LRC GPIO_NUM_17
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>uint8_t</span> audio_buf[BUF_SIZE];
</span></span><span style=display:flex><span><span style=color:#66d9ef>i2s_chan_handle_t</span> tx_handle;
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> sock <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>bool</span> wifi_connected <span style=color:#f92672>=</span> false;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// æå‰å£°æ˜å‡½æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>wifi_event_handler</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>arg, <span style=color:#66d9ef>esp_event_base_t</span> event_base, <span style=color:#66d9ef>int32_t</span> event_id, <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>event_data);
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>init_udp_socket</span>(<span style=color:#66d9ef>void</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>wifi_init</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;åˆå§‹åŒ–WiFi...&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åˆå§‹åŒ–TCP/IPæ ˆ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_netif_init</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åˆ›å»ºäº‹ä»¶å¾ªç¯
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_event_loop_create_default</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åˆ›å»ºé»˜è®¤çš„STAç½‘ç»œæ¥å£
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>esp_netif_t</span> <span style=color:#f92672>*</span>sta_netif <span style=color:#f92672>=</span> <span style=color:#a6e22e>esp_netif_create_default_wifi_sta</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>assert</span>(sta_netif);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åˆå§‹åŒ–WiFi
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>wifi_init_config_t</span> cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>WIFI_INIT_CONFIG_DEFAULT</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_wifi_init</span>(<span style=color:#f92672>&amp;</span>cfg));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ³¨å†Œäº‹ä»¶å¤„ç†å™¨
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_event_handler_instance_register</span>(WIFI_EVENT,
</span></span><span style=display:flex><span>                                                        ESP_EVENT_ANY_ID,
</span></span><span style=display:flex><span>                                                        <span style=color:#f92672>&amp;</span>wifi_event_handler,
</span></span><span style=display:flex><span>                                                        NULL,
</span></span><span style=display:flex><span>                                                        NULL));
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_event_handler_instance_register</span>(IP_EVENT,
</span></span><span style=display:flex><span>                                                        IP_EVENT_STA_GOT_IP,
</span></span><span style=display:flex><span>                                                        <span style=color:#f92672>&amp;</span>wifi_event_handler,
</span></span><span style=display:flex><span>                                                        NULL,
</span></span><span style=display:flex><span>                                                        NULL));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// é…ç½®WiFi
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>wifi_config_t</span> wifi_config <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        .sta <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            .ssid <span style=color:#f92672>=</span> WIFI_SSID,
</span></span><span style=display:flex><span>            .password <span style=color:#f92672>=</span> WIFI_PASS,
</span></span><span style=display:flex><span>            .threshold.authmode <span style=color:#f92672>=</span> WIFI_AUTH_WPA2_PSK,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_wifi_set_mode</span>(WIFI_MODE_STA));
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_wifi_set_config</span>(WIFI_IF_STA, <span style=color:#f92672>&amp;</span>wifi_config));
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_wifi_start</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;WiFiåˆå§‹åŒ–å®Œæˆï¼Œå¼€å§‹è¿æ¥...&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// WiFiäº‹ä»¶å¤„ç†
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>wifi_event_handler</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>arg, <span style=color:#66d9ef>esp_event_base_t</span> event_base,
</span></span><span style=display:flex><span>                               <span style=color:#66d9ef>int32_t</span> event_id, <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>event_data)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;æ”¶åˆ°äº‹ä»¶: %s, äº‹ä»¶ID: %ld&#34;</span>, event_base, event_id);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (event_base <span style=color:#f92672>==</span> WIFI_EVENT <span style=color:#f92672>&amp;&amp;</span> event_id <span style=color:#f92672>==</span> WIFI_EVENT_STA_START)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;WiFi STAå¯åŠ¨&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>esp_wifi_connect</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (event_base <span style=color:#f92672>==</span> WIFI_EVENT <span style=color:#f92672>&amp;&amp;</span> event_id <span style=color:#f92672>==</span> WIFI_EVENT_STA_CONNECTED)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;WiFiå·²è¿æ¥åˆ°AP&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (event_base <span style=color:#f92672>==</span> WIFI_EVENT <span style=color:#f92672>&amp;&amp;</span> event_id <span style=color:#f92672>==</span> WIFI_EVENT_STA_DISCONNECTED)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        wifi_connected <span style=color:#f92672>=</span> false;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;WiFiæ–­å¼€è¿æ¥ï¼Œ5ç§’åå°è¯•é‡è¿...&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>vTaskDelay</span>(<span style=color:#a6e22e>pdMS_TO_TICKS</span>(<span style=color:#ae81ff>5000</span>));
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>esp_wifi_connect</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (event_base <span style=color:#f92672>==</span> IP_EVENT <span style=color:#f92672>&amp;&amp;</span> event_id <span style=color:#f92672>==</span> IP_EVENT_STA_GOT_IP)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>ip_event_got_ip_t</span> <span style=color:#f92672>*</span>event <span style=color:#f92672>=</span> (<span style=color:#66d9ef>ip_event_got_ip_t</span> <span style=color:#f92672>*</span>)event_data;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;WiFiè¿æ¥æˆåŠŸï¼Œè·å–åˆ°IPåœ°å€: &#34;</span> IPSTR, <span style=color:#a6e22e>IP2STR</span>(<span style=color:#f92672>&amp;</span>event<span style=color:#f92672>-&gt;</span>ip_info.ip));
</span></span><span style=display:flex><span>        wifi_connected <span style=color:#f92672>=</span> true;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// åˆå§‹åŒ–UDP socket
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>init_udp_socket</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// åˆå§‹åŒ–UDP socket
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>init_udp_socket</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (sock <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>close</span>(sock);
</span></span><span style=display:flex><span>        sock <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    sock <span style=color:#f92672>=</span> <span style=color:#a6e22e>socket</span>(AF_INET, SOCK_DGRAM, IPPROTO_IP);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (sock <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;åˆ›å»ºsocketå¤±è´¥: %s&#34;</span>, <span style=color:#a6e22e>strerror</span>(errno));
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è®¾ç½®socketé€‰é¡¹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>int</span> opt <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>setsockopt</span>(sock, SOL_SOCKET, SO_REUSEADDR, <span style=color:#f92672>&amp;</span>opt, <span style=color:#66d9ef>sizeof</span>(opt));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> sockaddr_in server_addr;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>memset</span>(<span style=color:#f92672>&amp;</span>server_addr, <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>sizeof</span>(server_addr));
</span></span><span style=display:flex><span>    server_addr.sin_family <span style=color:#f92672>=</span> AF_INET;
</span></span><span style=display:flex><span>    server_addr.sin_port <span style=color:#f92672>=</span> <span style=color:#a6e22e>htons</span>(UDP_PORT);
</span></span><span style=display:flex><span>    server_addr.sin_addr.s_addr <span style=color:#f92672>=</span> <span style=color:#a6e22e>htonl</span>(INADDR_ANY);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>bind</span>(sock, (<span style=color:#66d9ef>struct</span> sockaddr <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>server_addr, <span style=color:#66d9ef>sizeof</span>(server_addr)) <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;ç»‘å®šç«¯å£å¤±è´¥: %s&#34;</span>, <span style=color:#a6e22e>strerror</span>(errno));
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>close</span>(sock);
</span></span><span style=display:flex><span>        sock <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;UDPæ¥æ”¶ç«¯å¯åŠ¨æˆåŠŸï¼Œç›‘å¬ç«¯å£: %d&#34;</span>, UDP_PORT);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// I2S TXåˆå§‹åŒ–
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>i2s_tx_init</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;åˆå§‹åŒ–I2S TX...&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>i2s_chan_config_t</span> chan_cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>I2S_CHANNEL_DEFAULT_CONFIG</span>(I2S_NUM_0, I2S_ROLE_MASTER);
</span></span><span style=display:flex><span>    chan_cfg.dma_frame_num <span style=color:#f92672>=</span> <span style=color:#ae81ff>1023</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>esp_err_t</span> ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>i2s_new_channel</span>(<span style=color:#f92672>&amp;</span>chan_cfg, <span style=color:#f92672>&amp;</span>tx_handle, NULL);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (ret <span style=color:#f92672>!=</span> ESP_OK)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;åˆ›å»ºI2Sé€šé“å¤±è´¥: %d&#34;</span>, ret);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>i2s_std_config_t</span> std_cfg <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        .clk_cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>I2S_STD_CLK_DEFAULT_CONFIG</span>(<span style=color:#ae81ff>44100</span>),
</span></span><span style=display:flex><span>        .slot_cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>I2S_STD_MSB_SLOT_DEFAULT_CONFIG</span>(I2S_DATA_BIT_WIDTH_32BIT, I2S_SLOT_MODE_MONO),
</span></span><span style=display:flex><span>        .gpio_cfg <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            .mclk <span style=color:#f92672>=</span> I2S_GPIO_UNUSED,
</span></span><span style=display:flex><span>            .din <span style=color:#f92672>=</span> I2S_GPIO_UNUSED,
</span></span><span style=display:flex><span>            .bclk <span style=color:#f92672>=</span> MAX_BCLK,
</span></span><span style=display:flex><span>            .ws <span style=color:#f92672>=</span> MAX_LRC,
</span></span><span style=display:flex><span>            .dout <span style=color:#f92672>=</span> MAX_DIN,
</span></span><span style=display:flex><span>            .invert_flags <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>                .mclk_inv <span style=color:#f92672>=</span> false,
</span></span><span style=display:flex><span>                .bclk_inv <span style=color:#f92672>=</span> false,
</span></span><span style=display:flex><span>                .ws_inv <span style=color:#f92672>=</span> false,
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>i2s_channel_init_std_mode</span>(tx_handle, <span style=color:#f92672>&amp;</span>std_cfg);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (ret <span style=color:#f92672>!=</span> ESP_OK)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;åˆå§‹åŒ–I2Sæ ‡å‡†æ¨¡å¼å¤±è´¥: %d&#34;</span>, ret);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>i2s_channel_enable</span>(tx_handle);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (ret <span style=color:#f92672>!=</span> ESP_OK)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;å¯ç”¨I2Sé€šé“å¤±è´¥: %d&#34;</span>, ret);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;I2S TXåˆå§‹åŒ–å®Œæˆ&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// UDPæ¥æ”¶ä»»åŠ¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>udp_receive_task</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>args)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;UDPæ¥æ”¶ä»»åŠ¡å¯åŠ¨&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> (<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>wifi_connected)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ESP_LOGW</span>(TAG, <span style=color:#e6db74>&#34;ç­‰å¾…WiFiè¿æ¥...&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>vTaskDelay</span>(<span style=color:#a6e22e>pdMS_TO_TICKS</span>(<span style=color:#ae81ff>2000</span>));
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (sock <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ESP_LOGW</span>(TAG, <span style=color:#e6db74>&#34;ç­‰å¾…UDP socketåˆå§‹åŒ–...&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>vTaskDelay</span>(<span style=color:#a6e22e>pdMS_TO_TICKS</span>(<span style=color:#ae81ff>1000</span>));
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>struct</span> sockaddr_in source_addr;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>socklen_t</span> addr_len <span style=color:#f92672>=</span> <span style=color:#66d9ef>sizeof</span>(source_addr);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> len <span style=color:#f92672>=</span> <span style=color:#a6e22e>recvfrom</span>(sock, audio_buf, BUF_SIZE, <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>                           (<span style=color:#66d9ef>struct</span> sockaddr <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>source_addr, <span style=color:#f92672>&amp;</span>addr_len);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (len <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>char</span> source_ip[<span style=color:#ae81ff>16</span>];
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>inet_ntoa_r</span>(source_addr.sin_addr, source_ip, <span style=color:#66d9ef>sizeof</span>(source_ip) <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;æ”¶åˆ°æ¥è‡ª %s çš„éŸ³é¢‘æ•°æ®ï¼Œé•¿åº¦: %d å­—èŠ‚&#34;</span>, source_ip, len);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// æ’­æ”¾æ¥æ”¶åˆ°çš„éŸ³é¢‘æ•°æ®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>size_t</span> bytes_written <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>esp_err_t</span> ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>i2s_channel_write</span>(tx_handle, audio_buf, len, <span style=color:#f92672>&amp;</span>bytes_written, portMAX_DELAY);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (ret <span style=color:#f92672>!=</span> ESP_OK)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;I2Så†™å…¥å¤±è´¥: %d&#34;</span>, ret);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (len <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (errno <span style=color:#f92672>!=</span> EAGAIN <span style=color:#f92672>&amp;&amp;</span> errno <span style=color:#f92672>!=</span> EWOULDBLOCK)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;æ¥æ”¶æ•°æ®å¤±è´¥: %s&#34;</span>, <span style=color:#a6e22e>strerror</span>(errno));
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>vTaskDelay</span>(<span style=color:#a6e22e>pdMS_TO_TICKS</span>(<span style=color:#ae81ff>1</span>));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>app_main</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;=== éŸ³é¢‘æ¥æ”¶ç«¯å¯åŠ¨ ===&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åˆå§‹åŒ–NVS
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>esp_err_t</span> ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>nvs_flash_init</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (ret <span style=color:#f92672>==</span> ESP_ERR_NVS_NO_FREE_PAGES <span style=color:#f92672>||</span> ret <span style=color:#f92672>==</span> ESP_ERR_NVS_NEW_VERSION_FOUND)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;æ“¦é™¤NVS...&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>nvs_flash_erase</span>());
</span></span><span style=display:flex><span>        ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>nvs_flash_init</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(ret);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;NVSåˆå§‹åŒ–å®Œæˆ&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åˆå§‹åŒ–I2S
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>i2s_tx_init</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åˆå§‹åŒ–WiFi
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>wifi_init</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åˆ›å»ºUDPæ¥æ”¶ä»»åŠ¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>xTaskCreate</span>(udp_receive_task, <span style=color:#e6db74>&#34;udp_receive&#34;</span>, <span style=color:#ae81ff>8192</span>, NULL, <span style=color:#ae81ff>5</span>, NULL);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼Œç­‰å¾…WiFiè¿æ¥...&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ä¿æŒä»»åŠ¡è¿è¡Œ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>while</span> (<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (wifi_connected)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;ç³»ç»Ÿè¿è¡Œä¸­ - WiFiå·²è¿æ¥ï¼Œç­‰å¾…éŸ³é¢‘æ•°æ®...&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;ç³»ç»Ÿè¿è¡Œä¸­ - ç­‰å¾…WiFiè¿æ¥...&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>vTaskDelay</span>(<span style=color:#a6e22e>pdMS_TO_TICKS</span>(<span style=color:#ae81ff>10000</span>));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>CMakeLists.txt</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>idf_component_register(SRCS &#34;i2s_std_example_main.c&#34;
</span></span><span style=display:flex><span>                    PRIV_REQUIRES esp_driver_i2s esp_driver_gpio i2s_examples_common
</span></span><span style=display:flex><span>                    INCLUDE_DIRS &#34;.&#34;
</span></span><span style=display:flex><span>                    REQUIRES 
</span></span><span style=display:flex><span>                        esp_wifi 
</span></span><span style=display:flex><span>                        esp_event 
</span></span><span style=display:flex><span>                        esp_netif 
</span></span><span style=display:flex><span>                        nvs_flash 
</span></span><span style=display:flex><span>                        lwip 
</span></span><span style=display:flex><span>                        driver 
</span></span><span style=display:flex><span>                        esp_driver_i2s)
</span></span></code></pre></div><p>æ¥æ”¶ç«¯è¿è¡Œ</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>I <span style=color:#f92672>(</span>13340<span style=color:#f92672>)</span> wifi:dp: 1, bi: 102400, li: 3, scale listen interval from <span style=color:#ae81ff>307200</span> us to <span style=color:#ae81ff>307200</span> us
</span></span><span style=display:flex><span>I <span style=color:#f92672>(</span>13350<span style=color:#f92672>)</span> audio_receiver: æ”¶åˆ°äº‹ä»¶: WIFI_EVENT, äº‹ä»¶ID: <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>I <span style=color:#f92672>(</span>13350<span style=color:#f92672>)</span> audio_receiver: WiFiå·²è¿æ¥åˆ°AP
</span></span><span style=display:flex><span>I <span style=color:#f92672>(</span>13360<span style=color:#f92672>)</span> wifi:&lt;ba-add&gt;idx:0 <span style=color:#f92672>(</span>ifx:0, 50:eb:f6:ae:8e:60<span style=color:#f92672>)</span>, tid:0, ssn:1, winSize:64
</span></span><span style=display:flex><span>I <span style=color:#f92672>(</span>13410<span style=color:#f92672>)</span> wifi:AP<span style=color:#960050;background-color:#1e0010>&#39;</span>s beacon interval <span style=color:#f92672>=</span> <span style=color:#ae81ff>102400</span> us, DTIM period <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>I <span style=color:#f92672>(</span>14370<span style=color:#f92672>)</span> esp_netif_handlers: sta ip: 192.168.80.39, mask: 255.255.255.0, gw: 192.168.80.1
</span></span><span style=display:flex><span>I <span style=color:#f92672>(</span>14370<span style=color:#f92672>)</span> audio_receiver: æ”¶åˆ°äº‹ä»¶: IP_EVENT, äº‹ä»¶ID: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>I <span style=color:#f92672>(</span>14370<span style=color:#f92672>)</span> audio_receiver: WiFiè¿æ¥æˆåŠŸï¼Œè·å–åˆ°IPåœ°å€: 192.168.80.39
</span></span><span style=display:flex><span>I <span style=color:#f92672>(</span>14380<span style=color:#f92672>)</span> audio_receiver: UDPæ¥æ”¶ç«¯å¯åŠ¨æˆåŠŸï¼Œç›‘å¬ç«¯å£: <span style=color:#ae81ff>1234</span>
</span></span><span style=display:flex><span>I <span style=color:#f92672>(</span>20790<span style=color:#f92672>)</span> audio_receiver: ç³»ç»Ÿè¿è¡Œä¸­ - WiFiå·²è¿æ¥ï¼Œç­‰å¾…éŸ³é¢‘æ•°æ®...
</span></span></code></pre></div><p>å‘é€ç«¯</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;string.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;freertos/FreeRTOS.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;freertos/task.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;freertos/event_groups.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_wifi.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_event.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_log.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_system.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;nvs_flash.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;lwip/err.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;lwip/sockets.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;lwip/sys.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;lwip/netdb.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;driver/i2s_std.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;driver/gpio.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>TAG <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;audio_udp&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// WiFié…ç½® - è¯·æ ¹æ®ä½ çš„ç½‘ç»œä¿®æ”¹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define WIFI_SSID &#34;RTCT2300&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define WIFI_PASS &#34;123123*zxcvb&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// UDPé…ç½® - è¯·ä¿®æ”¹ä¸ºæ¥æ”¶ç«¯çš„IPåœ°å€
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define UDP_SERVER_IP &#34;192.168.80.39&#34; </span><span style=color:#75715e>// æ¥æ”¶ç«¯ESP32çš„IPåœ°å€
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define UDP_PORT 1234                 </span><span style=color:#75715e>// UDPç«¯å£å·
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define UDP_PACKET_SIZE 1024          </span><span style=color:#75715e>// UDPåŒ…å¤§å°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// INMPå¼•è„š
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define INMP_SD GPIO_NUM_13
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define INMP_SCK GPIO_NUM_14
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define INMP_WS GPIO_NUM_27
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// MAX98357Aå¼•è„š
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define MAX_DIN GPIO_NUM_15
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define MAX_BCLK GPIO_NUM_16
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define MAX_LRC GPIO_NUM_17
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// éŸ³é¢‘é…ç½®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define SAMPLE_RATE 44100
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define BUF_SIZE (1023 * 1 * 32 / 8)
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define VOLUME_THRESHOLD 1000 </span><span style=color:#75715e>// éŸ³é‡é˜ˆå€¼ï¼Œè¶…è¿‡æ­¤å€¼è®¤ä¸ºæœ‰å£°éŸ³è¾“å…¥
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// å…¨å±€å˜é‡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>uint8_t</span> audio_buf[BUF_SIZE];
</span></span><span style=display:flex><span><span style=color:#66d9ef>i2s_chan_handle_t</span> rx_handle;
</span></span><span style=display:flex><span><span style=color:#66d9ef>i2s_chan_handle_t</span> tx_handle;
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> sock <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> sockaddr_in dest_addr;
</span></span><span style=display:flex><span><span style=color:#66d9ef>bool</span> wifi_connected <span style=color:#f92672>=</span> false;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// æå‰å£°æ˜å‡½æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>wifi_event_handler</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>arg, <span style=color:#66d9ef>esp_event_base_t</span> event_base, <span style=color:#66d9ef>int32_t</span> event_id, <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>event_data);
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>init_udp_socket</span>(<span style=color:#66d9ef>void</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// åˆå§‹åŒ–WiFi
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>wifi_init</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;åˆå§‹åŒ–WiFi...&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_netif_init</span>());
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_event_loop_create_default</span>());
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_netif_create_default_wifi_sta</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>wifi_init_config_t</span> cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>WIFI_INIT_CONFIG_DEFAULT</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_wifi_init</span>(<span style=color:#f92672>&amp;</span>cfg));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ³¨å†Œäº‹ä»¶å¤„ç†å™¨
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_event_handler_instance_register</span>(WIFI_EVENT,
</span></span><span style=display:flex><span>                                                        ESP_EVENT_ANY_ID,
</span></span><span style=display:flex><span>                                                        <span style=color:#f92672>&amp;</span>wifi_event_handler,
</span></span><span style=display:flex><span>                                                        NULL,
</span></span><span style=display:flex><span>                                                        NULL));
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_event_handler_instance_register</span>(IP_EVENT,
</span></span><span style=display:flex><span>                                                        IP_EVENT_STA_GOT_IP,
</span></span><span style=display:flex><span>                                                        <span style=color:#f92672>&amp;</span>wifi_event_handler,
</span></span><span style=display:flex><span>                                                        NULL,
</span></span><span style=display:flex><span>                                                        NULL));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>wifi_config_t</span> wifi_config <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        .sta <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            .ssid <span style=color:#f92672>=</span> WIFI_SSID,
</span></span><span style=display:flex><span>            .password <span style=color:#f92672>=</span> WIFI_PASS,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_wifi_set_mode</span>(WIFI_MODE_STA));
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_wifi_set_config</span>(WIFI_IF_STA, <span style=color:#f92672>&amp;</span>wifi_config));
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_wifi_start</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;WiFiåˆå§‹åŒ–å®Œæˆï¼Œæ­£åœ¨è¿æ¥...&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// WiFiäº‹ä»¶å¤„ç†
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>wifi_event_handler</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>arg, <span style=color:#66d9ef>esp_event_base_t</span> event_base,
</span></span><span style=display:flex><span>                               <span style=color:#66d9ef>int32_t</span> event_id, <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>event_data)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (event_base <span style=color:#f92672>==</span> WIFI_EVENT <span style=color:#f92672>&amp;&amp;</span> event_id <span style=color:#f92672>==</span> WIFI_EVENT_STA_START)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;WiFi STAå¯åŠ¨ï¼Œå¼€å§‹è¿æ¥...&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>esp_wifi_connect</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (event_base <span style=color:#f92672>==</span> WIFI_EVENT <span style=color:#f92672>&amp;&amp;</span> event_id <span style=color:#f92672>==</span> WIFI_EVENT_STA_DISCONNECTED)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        wifi_connected <span style=color:#f92672>=</span> false;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;WiFiæ–­å¼€è¿æ¥ï¼Œ5ç§’åå°è¯•é‡è¿...&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>vTaskDelay</span>(<span style=color:#a6e22e>pdMS_TO_TICKS</span>(<span style=color:#ae81ff>5000</span>));
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>esp_wifi_connect</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (event_base <span style=color:#f92672>==</span> IP_EVENT <span style=color:#f92672>&amp;&amp;</span> event_id <span style=color:#f92672>==</span> IP_EVENT_STA_GOT_IP)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>ip_event_got_ip_t</span> <span style=color:#f92672>*</span>event <span style=color:#f92672>=</span> (<span style=color:#66d9ef>ip_event_got_ip_t</span> <span style=color:#f92672>*</span>)event_data;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;WiFiè¿æ¥æˆåŠŸï¼ŒIPåœ°å€: &#34;</span> IPSTR, <span style=color:#a6e22e>IP2STR</span>(<span style=color:#f92672>&amp;</span>event<span style=color:#f92672>-&gt;</span>ip_info.ip));
</span></span><span style=display:flex><span>        wifi_connected <span style=color:#f92672>=</span> true;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// åˆå§‹åŒ–UDP socket
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>init_udp_socket</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// åˆå§‹åŒ–UDP socket
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>init_udp_socket</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (sock <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>close</span>(sock);
</span></span><span style=display:flex><span>        sock <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    sock <span style=color:#f92672>=</span> <span style=color:#a6e22e>socket</span>(AF_INET, SOCK_DGRAM, IPPROTO_IP);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (sock <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;åˆ›å»ºsocketå¤±è´¥: %s&#34;</span>, <span style=color:#a6e22e>strerror</span>(errno));
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è®¾ç½®ç›®æ ‡åœ°å€
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>memset</span>(<span style=color:#f92672>&amp;</span>dest_addr, <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>sizeof</span>(dest_addr));
</span></span><span style=display:flex><span>    dest_addr.sin_addr.s_addr <span style=color:#f92672>=</span> <span style=color:#a6e22e>inet_addr</span>(UDP_SERVER_IP);
</span></span><span style=display:flex><span>    dest_addr.sin_family <span style=color:#f92672>=</span> AF_INET;
</span></span><span style=display:flex><span>    dest_addr.sin_port <span style=color:#f92672>=</span> <span style=color:#a6e22e>htons</span>(UDP_PORT);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;UDP socketåˆå§‹åŒ–å®Œæˆï¼Œç›®æ ‡: %s:%d&#34;</span>, UDP_SERVER_IP, UDP_PORT);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// è®¡ç®—éŸ³é‡ï¼ˆRMSå€¼ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int32_t</span> <span style=color:#a6e22e>calculate_volume</span>(<span style=color:#66d9ef>int32_t</span> <span style=color:#f92672>*</span>samples, <span style=color:#66d9ef>int</span> count)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int64_t</span> sum <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> count; i<span style=color:#f92672>++</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// å–ç»å¯¹å€¼å¹¶ç´¯åŠ 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>int32_t</span> sample <span style=color:#f92672>=</span> samples[i] <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>8</span>; <span style=color:#75715e>// 24ä½æ•°æ®åœ¨32ä½ä¸­çš„é«˜ä½ï¼Œéœ€è¦å³ç§»
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> (sample <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>            sample <span style=color:#f92672>=</span> <span style=color:#f92672>-</span>sample;
</span></span><span style=display:flex><span>        sum <span style=color:#f92672>+=</span> sample;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (<span style=color:#66d9ef>int32_t</span>)(sum <span style=color:#f92672>/</span> count);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// åˆå§‹åŒ–I2S RXï¼ˆINMP441ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>i2s_rx_init</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>i2s_chan_config_t</span> chan_cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>I2S_CHANNEL_DEFAULT_CONFIG</span>(I2S_NUM_0, I2S_ROLE_MASTER);
</span></span><span style=display:flex><span>    chan_cfg.dma_frame_num <span style=color:#f92672>=</span> <span style=color:#ae81ff>1023</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>esp_err_t</span> ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>i2s_new_channel</span>(<span style=color:#f92672>&amp;</span>chan_cfg, NULL, <span style=color:#f92672>&amp;</span>rx_handle);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (ret <span style=color:#f92672>!=</span> ESP_OK)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;åˆ›å»ºI2S RXé€šé“å¤±è´¥: %d&#34;</span>, ret);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>i2s_std_config_t</span> std_cfg <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        .clk_cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>I2S_STD_CLK_DEFAULT_CONFIG</span>(SAMPLE_RATE),
</span></span><span style=display:flex><span>        .slot_cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>I2S_STD_MSB_SLOT_DEFAULT_CONFIG</span>(I2S_DATA_BIT_WIDTH_32BIT, I2S_SLOT_MODE_MONO),
</span></span><span style=display:flex><span>        .gpio_cfg <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            .mclk <span style=color:#f92672>=</span> I2S_GPIO_UNUSED,
</span></span><span style=display:flex><span>            .dout <span style=color:#f92672>=</span> I2S_GPIO_UNUSED,
</span></span><span style=display:flex><span>            .bclk <span style=color:#f92672>=</span> INMP_SCK,
</span></span><span style=display:flex><span>            .ws <span style=color:#f92672>=</span> INMP_WS,
</span></span><span style=display:flex><span>            .din <span style=color:#f92672>=</span> INMP_SD,
</span></span><span style=display:flex><span>            .invert_flags <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>                .mclk_inv <span style=color:#f92672>=</span> false,
</span></span><span style=display:flex><span>                .bclk_inv <span style=color:#f92672>=</span> false,
</span></span><span style=display:flex><span>                .ws_inv <span style=color:#f92672>=</span> false,
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>i2s_channel_init_std_mode</span>(rx_handle, <span style=color:#f92672>&amp;</span>std_cfg);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (ret <span style=color:#f92672>!=</span> ESP_OK)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;åˆå§‹åŒ–I2S RXå¤±è´¥: %d&#34;</span>, ret);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>i2s_channel_enable</span>(rx_handle);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;I2S RXåˆå§‹åŒ–å®Œæˆ&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// åˆå§‹åŒ–I2S TXï¼ˆMAX98357Aï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>i2s_tx_init</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>i2s_chan_config_t</span> chan_cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>I2S_CHANNEL_DEFAULT_CONFIG</span>(I2S_NUM_1, I2S_ROLE_MASTER);
</span></span><span style=display:flex><span>    chan_cfg.dma_frame_num <span style=color:#f92672>=</span> <span style=color:#ae81ff>1023</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>esp_err_t</span> ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>i2s_new_channel</span>(<span style=color:#f92672>&amp;</span>chan_cfg, <span style=color:#f92672>&amp;</span>tx_handle, NULL);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (ret <span style=color:#f92672>!=</span> ESP_OK)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;åˆ›å»ºI2S TXé€šé“å¤±è´¥: %d&#34;</span>, ret);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>i2s_std_config_t</span> std_cfg <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        .clk_cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>I2S_STD_CLK_DEFAULT_CONFIG</span>(SAMPLE_RATE),
</span></span><span style=display:flex><span>        .slot_cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>I2S_STD_MSB_SLOT_DEFAULT_CONFIG</span>(I2S_DATA_BIT_WIDTH_32BIT, I2S_SLOT_MODE_MONO),
</span></span><span style=display:flex><span>        .gpio_cfg <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            .mclk <span style=color:#f92672>=</span> I2S_GPIO_UNUSED,
</span></span><span style=display:flex><span>            .din <span style=color:#f92672>=</span> I2S_GPIO_UNUSED,
</span></span><span style=display:flex><span>            .bclk <span style=color:#f92672>=</span> MAX_BCLK,
</span></span><span style=display:flex><span>            .ws <span style=color:#f92672>=</span> MAX_LRC,
</span></span><span style=display:flex><span>            .dout <span style=color:#f92672>=</span> MAX_DIN,
</span></span><span style=display:flex><span>            .invert_flags <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>                .mclk_inv <span style=color:#f92672>=</span> false,
</span></span><span style=display:flex><span>                .bclk_inv <span style=color:#f92672>=</span> false,
</span></span><span style=display:flex><span>                .ws_inv <span style=color:#f92672>=</span> false,
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>i2s_channel_init_std_mode</span>(tx_handle, <span style=color:#f92672>&amp;</span>std_cfg);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (ret <span style=color:#f92672>!=</span> ESP_OK)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;åˆå§‹åŒ–I2S TXå¤±è´¥: %d&#34;</span>, ret);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>i2s_channel_enable</span>(tx_handle);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;I2S TXåˆå§‹åŒ–å®Œæˆ&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// éŸ³é¢‘å¤„ç†ä»»åŠ¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>audio_task</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>args)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>size_t</span> bytes_read <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>float</span> gain <span style=color:#f92672>=</span> <span style=color:#ae81ff>4.5f</span>;
</span></span><span style=display:flex><span>    TickType_t last_volume_print <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int32_t</span> max_volume <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;éŸ³é¢‘å¤„ç†ä»»åŠ¡å¯åŠ¨&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> (<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>wifi_connected <span style=color:#f92672>||</span> sock <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ESP_LOGW</span>(TAG, <span style=color:#e6db74>&#34;ç­‰å¾…WiFiè¿æ¥å’ŒUDPåˆå§‹åŒ–...&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>vTaskDelay</span>(<span style=color:#a6e22e>pdMS_TO_TICKS</span>(<span style=color:#ae81ff>1000</span>));
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>i2s_channel_read</span>(rx_handle, audio_buf, BUF_SIZE, <span style=color:#f92672>&amp;</span>bytes_read, <span style=color:#ae81ff>1000</span>) <span style=color:#f92672>==</span> ESP_OK)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int32_t</span> <span style=color:#f92672>*</span>samples <span style=color:#f92672>=</span> (<span style=color:#66d9ef>int32_t</span> <span style=color:#f92672>*</span>)audio_buf;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int</span> samples_count <span style=color:#f92672>=</span> bytes_read <span style=color:#f92672>/</span> <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>int32_t</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// è®¡ç®—å½“å‰éŸ³é‡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>int32_t</span> current_volume <span style=color:#f92672>=</span> <span style=color:#a6e22e>calculate_volume</span>(samples, samples_count);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (current_volume <span style=color:#f92672>&gt;</span> max_volume)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                max_volume <span style=color:#f92672>=</span> current_volume;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// æ¯2ç§’æ‰“å°ä¸€æ¬¡æœ€å¤§éŸ³é‡ï¼ˆå¦‚æœæœ‰å£°éŸ³è¾“å…¥ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            TickType_t current_tick <span style=color:#f92672>=</span> <span style=color:#a6e22e>xTaskGetTickCount</span>();
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (current_tick <span style=color:#f92672>-</span> last_volume_print <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>pdMS_TO_TICKS</span>(<span style=color:#ae81ff>2000</span>))
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (max_volume <span style=color:#f92672>&gt;</span> VOLUME_THRESHOLD)
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;æ£€æµ‹åˆ°å£°éŸ³è¾“å…¥ï¼ŒéŸ³é‡å€¼: %ld&#34;</span>, max_volume);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                max_volume <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>                last_volume_print <span style=color:#f92672>=</span> current_tick;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// åº”ç”¨å¢ç›Š
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> samples_count; i<span style=color:#f92672>++</span>)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>int64_t</span> temp <span style=color:#f92672>=</span> (<span style=color:#66d9ef>int64_t</span>)(samples[i] <span style=color:#f92672>*</span> gain);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (temp <span style=color:#f92672>&gt;</span> INT32_MAX)
</span></span><span style=display:flex><span>                    temp <span style=color:#f92672>=</span> INT32_MAX;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (temp <span style=color:#f92672>&lt;</span> INT32_MIN)
</span></span><span style=display:flex><span>                    temp <span style=color:#f92672>=</span> INT32_MIN;
</span></span><span style=display:flex><span>                samples[i] <span style=color:#f92672>=</span> (<span style=color:#66d9ef>int32_t</span>)temp;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// é€šè¿‡UDPå‘é€éŸ³é¢‘æ•°æ®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>int</span> err <span style=color:#f92672>=</span> <span style=color:#a6e22e>sendto</span>(sock, audio_buf, bytes_read, <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>                             (<span style=color:#66d9ef>struct</span> sockaddr <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>dest_addr, <span style=color:#66d9ef>sizeof</span>(dest_addr));
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (err <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;UDPå‘é€å¤±è´¥: %s&#34;</span>, <span style=color:#a6e22e>strerror</span>(errno));
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// æœ¬åœ°æ’­æ”¾
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>size_t</span> bytes_written <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>i2s_channel_write</span>(tx_handle, audio_buf, bytes_read, <span style=color:#f92672>&amp;</span>bytes_written, <span style=color:#ae81ff>1000</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>vTaskDelay</span>(<span style=color:#a6e22e>pdMS_TO_TICKS</span>(<span style=color:#ae81ff>1</span>));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>app_main</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;=== éŸ³é¢‘UDPä¼ è¾“ç³»ç»Ÿå¯åŠ¨ ===&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åˆå§‹åŒ–NVS
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>esp_err_t</span> ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>nvs_flash_init</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (ret <span style=color:#f92672>==</span> ESP_ERR_NVS_NO_FREE_PAGES <span style=color:#f92672>||</span> ret <span style=color:#f92672>==</span> ESP_ERR_NVS_NEW_VERSION_FOUND)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;æ“¦é™¤NVS...&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>nvs_flash_erase</span>());
</span></span><span style=display:flex><span>        ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>nvs_flash_init</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(ret);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;NVSåˆå§‹åŒ–å®Œæˆ&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åˆå§‹åŒ–WiFi
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>wifi_init</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åˆå§‹åŒ–I2S
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>i2s_tx_init</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>i2s_rx_init</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åˆ›å»ºéŸ³é¢‘å¤„ç†ä»»åŠ¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>xTaskCreate</span>(audio_task, <span style=color:#e6db74>&#34;audio_task&#34;</span>, <span style=color:#ae81ff>8192</span>, NULL, <span style=color:#ae81ff>5</span>, NULL);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼Œç­‰å¾…WiFiè¿æ¥...&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>CMakeLists.txt</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>idf_component_register(SRCS &#34;i2s_std_example_main.c&#34;
</span></span><span style=display:flex><span>                    PRIV_REQUIRES esp_driver_i2s esp_driver_gpio i2s_examples_common
</span></span><span style=display:flex><span>                    INCLUDE_DIRS &#34;.&#34;
</span></span><span style=display:flex><span>                    REQUIRES 
</span></span><span style=display:flex><span>                        esp_wifi
</span></span><span style=display:flex><span>                        esp_event
</span></span><span style=display:flex><span>                        esp_netif
</span></span><span style=display:flex><span>                        nvs_flash
</span></span><span style=display:flex><span>                        lwip
</span></span><span style=display:flex><span>                        driver
</span></span><span style=display:flex><span>                        esp_driver_i2s
</span></span><span style=display:flex><span>                        esp_driver_gpio
</span></span><span style=display:flex><span>                        freertos
</span></span><span style=display:flex><span>                        esp_system
</span></span><span style=display:flex><span>                        log)
</span></span></code></pre></div><h2 id=æ•°æ®åŒ…>æ•°æ®åŒ…<a hidden class=anchor aria-hidden=true href=#æ•°æ®åŒ…>#</a></h2><p>å‘é€</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;string.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;fcntl.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;freertos/FreeRTOS.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;freertos/task.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;freertos/event_groups.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_wifi.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_event.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_log.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_system.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;nvs_flash.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;lwip/err.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;lwip/sockets.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;lwip/sys.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;lwip/netdb.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;driver/i2s_std.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;driver/gpio.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>TAG <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;audio_udp&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// WiFié…ç½®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define WIFI_SSID &#34;RTCT2300&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define WIFI_PASS &#34;123123*zxcvb&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// UDPé…ç½® - ä½¿ç”¨æ¥æ”¶ç«¯çš„å®é™…IPåœ°å€
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define UDP_SERVER_IP &#34;192.168.80.39&#34; </span><span style=color:#75715e>// æ¥æ”¶ç«¯å®é™…IP
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define UDP_PORT 1234
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// INMPå¼•è„š
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define INMP_SD GPIO_NUM_13
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define INMP_SCK GPIO_NUM_14
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define INMP_WS GPIO_NUM_27
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// MAX98357Aå¼•è„š
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define MAX_DIN GPIO_NUM_15
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define MAX_BCLK GPIO_NUM_16
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define MAX_LRC GPIO_NUM_17
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// éŸ³é¢‘é…ç½®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define SAMPLE_RATE 44100
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define BUF_SIZE (1023 * 1 * 32 / 8)
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define VOLUME_THRESHOLD 1000
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// å…¨å±€å˜é‡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>uint8_t</span> audio_buf[BUF_SIZE];
</span></span><span style=display:flex><span><span style=color:#66d9ef>i2s_chan_handle_t</span> rx_handle;
</span></span><span style=display:flex><span><span style=color:#66d9ef>i2s_chan_handle_t</span> tx_handle;
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> sock <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> sockaddr_in dest_addr;
</span></span><span style=display:flex><span><span style=color:#66d9ef>bool</span> wifi_connected <span style=color:#f92672>=</span> false;
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> send_count <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// æå‰å£°æ˜å‡½æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>wifi_event_handler</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>arg, <span style=color:#66d9ef>esp_event_base_t</span> event_base, <span style=color:#66d9ef>int32_t</span> event_id, <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>event_data);
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>init_udp_socket</span>(<span style=color:#66d9ef>void</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>connection_test</span>(<span style=color:#66d9ef>void</span>); <span style=color:#75715e>// æ·»åŠ è¿™è¡Œå£°æ˜
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// è¿æ¥æµ‹è¯•å‡½æ•°ï¼ˆæ”¾åœ¨å‰é¢ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>connection_test</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> test_packet[] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;AUDIO_TEST&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> err <span style=color:#f92672>=</span> <span style=color:#a6e22e>sendto</span>(sock, test_packet, <span style=color:#a6e22e>strlen</span>(test_packet), <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>                     (<span style=color:#66d9ef>struct</span> sockaddr <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>dest_addr, <span style=color:#66d9ef>sizeof</span>(dest_addr));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (err <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;è¿æ¥æµ‹è¯•å¤±è´¥: %s&#34;</span>, <span style=color:#a6e22e>strerror</span>(errno));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;è¿æ¥æµ‹è¯•åŒ…å‘é€æˆåŠŸ&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// åˆå§‹åŒ–WiFi
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>wifi_init</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;åˆå§‹åŒ–WiFi...&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_netif_init</span>());
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_event_loop_create_default</span>());
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_netif_create_default_wifi_sta</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>wifi_init_config_t</span> cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>WIFI_INIT_CONFIG_DEFAULT</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_wifi_init</span>(<span style=color:#f92672>&amp;</span>cfg));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ³¨å†Œäº‹ä»¶å¤„ç†å™¨
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_event_handler_instance_register</span>(WIFI_EVENT,
</span></span><span style=display:flex><span>                                                        ESP_EVENT_ANY_ID,
</span></span><span style=display:flex><span>                                                        <span style=color:#f92672>&amp;</span>wifi_event_handler,
</span></span><span style=display:flex><span>                                                        NULL,
</span></span><span style=display:flex><span>                                                        NULL));
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_event_handler_instance_register</span>(IP_EVENT,
</span></span><span style=display:flex><span>                                                        IP_EVENT_STA_GOT_IP,
</span></span><span style=display:flex><span>                                                        <span style=color:#f92672>&amp;</span>wifi_event_handler,
</span></span><span style=display:flex><span>                                                        NULL,
</span></span><span style=display:flex><span>                                                        NULL));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>wifi_config_t</span> wifi_config <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        .sta <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            .ssid <span style=color:#f92672>=</span> WIFI_SSID,
</span></span><span style=display:flex><span>            .password <span style=color:#f92672>=</span> WIFI_PASS,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_wifi_set_mode</span>(WIFI_MODE_STA));
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_wifi_set_config</span>(WIFI_IF_STA, <span style=color:#f92672>&amp;</span>wifi_config));
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_wifi_start</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;WiFiåˆå§‹åŒ–å®Œæˆï¼Œæ­£åœ¨è¿æ¥...&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// WiFiäº‹ä»¶å¤„ç†
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>wifi_event_handler</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>arg, <span style=color:#66d9ef>esp_event_base_t</span> event_base,
</span></span><span style=display:flex><span>                               <span style=color:#66d9ef>int32_t</span> event_id, <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>event_data)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (event_base <span style=color:#f92672>==</span> WIFI_EVENT <span style=color:#f92672>&amp;&amp;</span> event_id <span style=color:#f92672>==</span> WIFI_EVENT_STA_START)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;WiFi STAå¯åŠ¨ï¼Œå¼€å§‹è¿æ¥...&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>esp_wifi_connect</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (event_base <span style=color:#f92672>==</span> WIFI_EVENT <span style=color:#f92672>&amp;&amp;</span> event_id <span style=color:#f92672>==</span> WIFI_EVENT_STA_DISCONNECTED)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        wifi_connected <span style=color:#f92672>=</span> false;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;WiFiæ–­å¼€è¿æ¥ï¼Œ5ç§’åå°è¯•é‡è¿...&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>vTaskDelay</span>(<span style=color:#a6e22e>pdMS_TO_TICKS</span>(<span style=color:#ae81ff>5000</span>));
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>esp_wifi_connect</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (event_base <span style=color:#f92672>==</span> IP_EVENT <span style=color:#f92672>&amp;&amp;</span> event_id <span style=color:#f92672>==</span> IP_EVENT_STA_GOT_IP)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>ip_event_got_ip_t</span> <span style=color:#f92672>*</span>event <span style=color:#f92672>=</span> (<span style=color:#66d9ef>ip_event_got_ip_t</span> <span style=color:#f92672>*</span>)event_data;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;WiFiè¿æ¥æˆåŠŸï¼ŒIPåœ°å€: &#34;</span> IPSTR, <span style=color:#a6e22e>IP2STR</span>(<span style=color:#f92672>&amp;</span>event<span style=color:#f92672>-&gt;</span>ip_info.ip));
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;å­ç½‘æ©ç : &#34;</span> IPSTR, <span style=color:#a6e22e>IP2STR</span>(<span style=color:#f92672>&amp;</span>event<span style=color:#f92672>-&gt;</span>ip_info.netmask));
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;ç½‘å…³: &#34;</span> IPSTR, <span style=color:#a6e22e>IP2STR</span>(<span style=color:#f92672>&amp;</span>event<span style=color:#f92672>-&gt;</span>ip_info.gw));
</span></span><span style=display:flex><span>        wifi_connected <span style=color:#f92672>=</span> true;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// åˆå§‹åŒ–UDP socket
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>init_udp_socket</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// åˆå§‹åŒ–UDP socket
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>init_udp_socket</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (sock <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>close</span>(sock);
</span></span><span style=display:flex><span>        sock <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    sock <span style=color:#f92672>=</span> <span style=color:#a6e22e>socket</span>(AF_INET, SOCK_DGRAM, IPPROTO_IP);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (sock <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;åˆ›å»ºsocketå¤±è´¥: %s&#34;</span>, <span style=color:#a6e22e>strerror</span>(errno));
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è®¾ç½®socketé€‰é¡¹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>int</span> opt <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>setsockopt</span>(sock, SOL_SOCKET, SO_REUSEADDR, <span style=color:#f92672>&amp;</span>opt, <span style=color:#66d9ef>sizeof</span>(opt));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è®¾ç½®å‘é€è¶…æ—¶
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>struct</span> timeval timeout;
</span></span><span style=display:flex><span>    timeout.tv_sec <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    timeout.tv_usec <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>setsockopt</span>(sock, SOL_SOCKET, SO_SNDTIMEO, <span style=color:#f92672>&amp;</span>timeout, <span style=color:#66d9ef>sizeof</span>(timeout));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è®¾ç½®ç›®æ ‡åœ°å€
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>memset</span>(<span style=color:#f92672>&amp;</span>dest_addr, <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>sizeof</span>(dest_addr));
</span></span><span style=display:flex><span>    dest_addr.sin_addr.s_addr <span style=color:#f92672>=</span> <span style=color:#a6e22e>inet_addr</span>(UDP_SERVER_IP);
</span></span><span style=display:flex><span>    dest_addr.sin_family <span style=color:#f92672>=</span> AF_INET;
</span></span><span style=display:flex><span>    dest_addr.sin_port <span style=color:#f92672>=</span> <span style=color:#a6e22e>htons</span>(UDP_PORT);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;UDP socketåˆå§‹åŒ–å®Œæˆ&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;ç›®æ ‡åœ°å€: %s:%d&#34;</span>, UDP_SERVER_IP, UDP_PORT);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å‘é€è¿æ¥æµ‹è¯•åŒ…
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>connection_test</span>();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// è®¡ç®—éŸ³é‡ï¼ˆRMSå€¼ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int32_t</span> <span style=color:#a6e22e>calculate_volume</span>(<span style=color:#66d9ef>int32_t</span> <span style=color:#f92672>*</span>samples, <span style=color:#66d9ef>int</span> count)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int64_t</span> sum <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> count; i<span style=color:#f92672>++</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int32_t</span> sample <span style=color:#f92672>=</span> samples[i] <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>8</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (sample <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>            sample <span style=color:#f92672>=</span> <span style=color:#f92672>-</span>sample;
</span></span><span style=display:flex><span>        sum <span style=color:#f92672>+=</span> sample;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (<span style=color:#66d9ef>int32_t</span>)(sum <span style=color:#f92672>/</span> count);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// åˆå§‹åŒ–I2S RXï¼ˆINMP441ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>i2s_rx_init</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>i2s_chan_config_t</span> chan_cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>I2S_CHANNEL_DEFAULT_CONFIG</span>(I2S_NUM_0, I2S_ROLE_MASTER);
</span></span><span style=display:flex><span>    chan_cfg.dma_frame_num <span style=color:#f92672>=</span> <span style=color:#ae81ff>1023</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>esp_err_t</span> ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>i2s_new_channel</span>(<span style=color:#f92672>&amp;</span>chan_cfg, NULL, <span style=color:#f92672>&amp;</span>rx_handle);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (ret <span style=color:#f92672>!=</span> ESP_OK)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;åˆ›å»ºI2S RXé€šé“å¤±è´¥: %d&#34;</span>, ret);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>i2s_std_config_t</span> std_cfg <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        .clk_cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>I2S_STD_CLK_DEFAULT_CONFIG</span>(SAMPLE_RATE),
</span></span><span style=display:flex><span>        .slot_cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>I2S_STD_MSB_SLOT_DEFAULT_CONFIG</span>(I2S_DATA_BIT_WIDTH_32BIT, I2S_SLOT_MODE_MONO),
</span></span><span style=display:flex><span>        .gpio_cfg <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            .mclk <span style=color:#f92672>=</span> I2S_GPIO_UNUSED,
</span></span><span style=display:flex><span>            .dout <span style=color:#f92672>=</span> I2S_GPIO_UNUSED,
</span></span><span style=display:flex><span>            .bclk <span style=color:#f92672>=</span> INMP_SCK,
</span></span><span style=display:flex><span>            .ws <span style=color:#f92672>=</span> INMP_WS,
</span></span><span style=display:flex><span>            .din <span style=color:#f92672>=</span> INMP_SD,
</span></span><span style=display:flex><span>            .invert_flags <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>                .mclk_inv <span style=color:#f92672>=</span> false,
</span></span><span style=display:flex><span>                .bclk_inv <span style=color:#f92672>=</span> false,
</span></span><span style=display:flex><span>                .ws_inv <span style=color:#f92672>=</span> false,
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>i2s_channel_init_std_mode</span>(rx_handle, <span style=color:#f92672>&amp;</span>std_cfg);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (ret <span style=color:#f92672>!=</span> ESP_OK)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;åˆå§‹åŒ–I2S RXå¤±è´¥: %d&#34;</span>, ret);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>i2s_channel_enable</span>(rx_handle);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;I2S RXåˆå§‹åŒ–å®Œæˆ&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// åˆå§‹åŒ–I2S TXï¼ˆMAX98357Aï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>i2s_tx_init</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>i2s_chan_config_t</span> chan_cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>I2S_CHANNEL_DEFAULT_CONFIG</span>(I2S_NUM_1, I2S_ROLE_MASTER);
</span></span><span style=display:flex><span>    chan_cfg.dma_frame_num <span style=color:#f92672>=</span> <span style=color:#ae81ff>1023</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>esp_err_t</span> ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>i2s_new_channel</span>(<span style=color:#f92672>&amp;</span>chan_cfg, <span style=color:#f92672>&amp;</span>tx_handle, NULL);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (ret <span style=color:#f92672>!=</span> ESP_OK)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;åˆ›å»ºI2S TXé€šé“å¤±è´¥: %d&#34;</span>, ret);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>i2s_std_config_t</span> std_cfg <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        .clk_cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>I2S_STD_CLK_DEFAULT_CONFIG</span>(SAMPLE_RATE),
</span></span><span style=display:flex><span>        .slot_cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>I2S_STD_MSB_SLOT_DEFAULT_CONFIG</span>(I2S_DATA_BIT_WIDTH_32BIT, I2S_SLOT_MODE_MONO),
</span></span><span style=display:flex><span>        .gpio_cfg <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            .mclk <span style=color:#f92672>=</span> I2S_GPIO_UNUSED,
</span></span><span style=display:flex><span>            .din <span style=color:#f92672>=</span> I2S_GPIO_UNUSED,
</span></span><span style=display:flex><span>            .bclk <span style=color:#f92672>=</span> MAX_BCLK,
</span></span><span style=display:flex><span>            .ws <span style=color:#f92672>=</span> MAX_LRC,
</span></span><span style=display:flex><span>            .dout <span style=color:#f92672>=</span> MAX_DIN,
</span></span><span style=display:flex><span>            .invert_flags <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>                .mclk_inv <span style=color:#f92672>=</span> false,
</span></span><span style=display:flex><span>                .bclk_inv <span style=color:#f92672>=</span> false,
</span></span><span style=display:flex><span>                .ws_inv <span style=color:#f92672>=</span> false,
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>i2s_channel_init_std_mode</span>(tx_handle, <span style=color:#f92672>&amp;</span>std_cfg);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (ret <span style=color:#f92672>!=</span> ESP_OK)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;åˆå§‹åŒ–I2S TXå¤±è´¥: %d&#34;</span>, ret);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>i2s_channel_enable</span>(tx_handle);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;I2S TXåˆå§‹åŒ–å®Œæˆ&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// éŸ³é¢‘å¤„ç†ä»»åŠ¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>audio_task</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>args)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>size_t</span> bytes_read <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>float</span> gain <span style=color:#f92672>=</span> <span style=color:#ae81ff>4.5f</span>;
</span></span><span style=display:flex><span>    TickType_t last_volume_print <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int32_t</span> max_volume <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;éŸ³é¢‘å¤„ç†ä»»åŠ¡å¯åŠ¨&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> (<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>wifi_connected <span style=color:#f92672>||</span> sock <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ESP_LOGW</span>(TAG, <span style=color:#e6db74>&#34;ç­‰å¾…WiFiè¿æ¥å’ŒUDPåˆå§‹åŒ–...&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>vTaskDelay</span>(<span style=color:#a6e22e>pdMS_TO_TICKS</span>(<span style=color:#ae81ff>1000</span>));
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>i2s_channel_read</span>(rx_handle, audio_buf, BUF_SIZE, <span style=color:#f92672>&amp;</span>bytes_read, <span style=color:#ae81ff>1000</span>) <span style=color:#f92672>==</span> ESP_OK)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int32_t</span> <span style=color:#f92672>*</span>samples <span style=color:#f92672>=</span> (<span style=color:#66d9ef>int32_t</span> <span style=color:#f92672>*</span>)audio_buf;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int</span> samples_count <span style=color:#f92672>=</span> bytes_read <span style=color:#f92672>/</span> <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>int32_t</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// è®¡ç®—å½“å‰éŸ³é‡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>int32_t</span> current_volume <span style=color:#f92672>=</span> <span style=color:#a6e22e>calculate_volume</span>(samples, samples_count);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (current_volume <span style=color:#f92672>&gt;</span> max_volume)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                max_volume <span style=color:#f92672>=</span> current_volume;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// æ¯2ç§’æ‰“å°ä¸€æ¬¡æœ€å¤§éŸ³é‡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            TickType_t current_tick <span style=color:#f92672>=</span> <span style=color:#a6e22e>xTaskGetTickCount</span>();
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (current_tick <span style=color:#f92672>-</span> last_volume_print <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>pdMS_TO_TICKS</span>(<span style=color:#ae81ff>2000</span>))
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (max_volume <span style=color:#f92672>&gt;</span> VOLUME_THRESHOLD)
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;æ£€æµ‹åˆ°å£°éŸ³è¾“å…¥ï¼ŒéŸ³é‡å€¼: %ld&#34;</span>, max_volume);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                max_volume <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>                last_volume_print <span style=color:#f92672>=</span> current_tick;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// åº”ç”¨å¢ç›Š
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> samples_count; i<span style=color:#f92672>++</span>)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>int64_t</span> temp <span style=color:#f92672>=</span> (<span style=color:#66d9ef>int64_t</span>)(samples[i] <span style=color:#f92672>*</span> gain);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (temp <span style=color:#f92672>&gt;</span> INT32_MAX)
</span></span><span style=display:flex><span>                    temp <span style=color:#f92672>=</span> INT32_MAX;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (temp <span style=color:#f92672>&lt;</span> INT32_MIN)
</span></span><span style=display:flex><span>                    temp <span style=color:#f92672>=</span> INT32_MIN;
</span></span><span style=display:flex><span>                samples[i] <span style=color:#f92672>=</span> (<span style=color:#66d9ef>int32_t</span>)temp;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// é€šè¿‡UDPå‘é€éŸ³é¢‘æ•°æ®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>int</span> err <span style=color:#f92672>=</span> <span style=color:#a6e22e>sendto</span>(sock, audio_buf, bytes_read, <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>                             (<span style=color:#66d9ef>struct</span> sockaddr <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>dest_addr, <span style=color:#66d9ef>sizeof</span>(dest_addr));
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (err <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;UDPå‘é€å¤±è´¥: %s&#34;</span>, <span style=color:#a6e22e>strerror</span>(errno));
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                send_count<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (send_count <span style=color:#f92672>%</span> <span style=color:#ae81ff>50</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;æˆåŠŸå‘é€æ•°æ®åŒ…#%d: %då­—èŠ‚åˆ° %s:%d&#34;</span>,
</span></span><span style=display:flex><span>                             send_count, bytes_read, UDP_SERVER_IP, UDP_PORT);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// æœ¬åœ°æ’­æ”¾
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>size_t</span> bytes_written <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>i2s_channel_write</span>(tx_handle, audio_buf, bytes_read, <span style=color:#f92672>&amp;</span>bytes_written, <span style=color:#ae81ff>1000</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>vTaskDelay</span>(<span style=color:#a6e22e>pdMS_TO_TICKS</span>(<span style=color:#ae81ff>1</span>));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>app_main</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;=== éŸ³é¢‘UDPå‘é€ç«¯å¯åŠ¨ ===&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åˆå§‹åŒ–NVS
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>esp_err_t</span> ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>nvs_flash_init</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (ret <span style=color:#f92672>==</span> ESP_ERR_NVS_NO_FREE_PAGES <span style=color:#f92672>||</span> ret <span style=color:#f92672>==</span> ESP_ERR_NVS_NEW_VERSION_FOUND)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;æ“¦é™¤NVS...&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>nvs_flash_erase</span>());
</span></span><span style=display:flex><span>        ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>nvs_flash_init</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(ret);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;NVSåˆå§‹åŒ–å®Œæˆ&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åˆå§‹åŒ–WiFi
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>wifi_init</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åˆå§‹åŒ–I2S
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>i2s_tx_init</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>i2s_rx_init</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åˆ›å»ºéŸ³é¢‘å¤„ç†ä»»åŠ¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>xTaskCreate</span>(audio_task, <span style=color:#e6db74>&#34;audio_task&#34;</span>, <span style=color:#ae81ff>12288</span>, NULL, <span style=color:#ae81ff>5</span>, NULL);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼Œç­‰å¾…WiFiè¿æ¥...&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æ¥æ”¶</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;string.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;fcntl.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;freertos/FreeRTOS.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;freertos/task.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_wifi.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_event.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_log.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_system.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;nvs_flash.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;lwip/err.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;lwip/sockets.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;lwip/sys.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;lwip/netdb.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;driver/i2s_std.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;driver/gpio.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>TAG <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;audio_receiver&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// WiFié…ç½®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define WIFI_SSID &#34;RTCT2300&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define WIFI_PASS &#34;123123*zxcvb&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// UDPé…ç½®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define UDP_PORT 1234
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define BUF_SIZE (1023 * 1 * 32 / 8)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// MAX98357Aå¼•è„š
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define MAX_DIN GPIO_NUM_15
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define MAX_BCLK GPIO_NUM_16
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define MAX_LRC GPIO_NUM_17
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>uint8_t</span> audio_buf[BUF_SIZE];
</span></span><span style=display:flex><span><span style=color:#66d9ef>i2s_chan_handle_t</span> tx_handle;
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> sock <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>bool</span> wifi_connected <span style=color:#f92672>=</span> false;
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> receive_count <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// æå‰å£°æ˜å‡½æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>wifi_event_handler</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>arg, <span style=color:#66d9ef>esp_event_base_t</span> event_base, <span style=color:#66d9ef>int32_t</span> event_id, <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>event_data);
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>init_udp_socket</span>(<span style=color:#66d9ef>void</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>wifi_init</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;åˆå§‹åŒ–WiFi...&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_netif_init</span>());
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_event_loop_create_default</span>());
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_netif_create_default_wifi_sta</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>wifi_init_config_t</span> cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>WIFI_INIT_CONFIG_DEFAULT</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_wifi_init</span>(<span style=color:#f92672>&amp;</span>cfg));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ³¨å†Œäº‹ä»¶å¤„ç†å™¨
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_event_handler_instance_register</span>(WIFI_EVENT,
</span></span><span style=display:flex><span>                                                        ESP_EVENT_ANY_ID,
</span></span><span style=display:flex><span>                                                        <span style=color:#f92672>&amp;</span>wifi_event_handler,
</span></span><span style=display:flex><span>                                                        NULL,
</span></span><span style=display:flex><span>                                                        NULL));
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_event_handler_instance_register</span>(IP_EVENT,
</span></span><span style=display:flex><span>                                                        IP_EVENT_STA_GOT_IP,
</span></span><span style=display:flex><span>                                                        <span style=color:#f92672>&amp;</span>wifi_event_handler,
</span></span><span style=display:flex><span>                                                        NULL,
</span></span><span style=display:flex><span>                                                        NULL));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>wifi_config_t</span> wifi_config <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        .sta <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            .ssid <span style=color:#f92672>=</span> WIFI_SSID,
</span></span><span style=display:flex><span>            .password <span style=color:#f92672>=</span> WIFI_PASS,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_wifi_set_mode</span>(WIFI_MODE_STA));
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_wifi_set_config</span>(WIFI_IF_STA, <span style=color:#f92672>&amp;</span>wifi_config));
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_wifi_start</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;WiFiåˆå§‹åŒ–å®Œæˆï¼Œå¼€å§‹è¿æ¥...&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// WiFiäº‹ä»¶å¤„ç†
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>wifi_event_handler</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>arg, <span style=color:#66d9ef>esp_event_base_t</span> event_base,
</span></span><span style=display:flex><span>                               <span style=color:#66d9ef>int32_t</span> event_id, <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>event_data)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (event_base <span style=color:#f92672>==</span> WIFI_EVENT <span style=color:#f92672>&amp;&amp;</span> event_id <span style=color:#f92672>==</span> WIFI_EVENT_STA_START)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;WiFi STAå¯åŠ¨&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>esp_wifi_connect</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (event_base <span style=color:#f92672>==</span> WIFI_EVENT <span style=color:#f92672>&amp;&amp;</span> event_id <span style=color:#f92672>==</span> WIFI_EVENT_STA_CONNECTED)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;WiFiå·²è¿æ¥åˆ°AP&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (event_base <span style=color:#f92672>==</span> WIFI_EVENT <span style=color:#f92672>&amp;&amp;</span> event_id <span style=color:#f92672>==</span> WIFI_EVENT_STA_DISCONNECTED)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        wifi_connected <span style=color:#f92672>=</span> false;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;WiFiæ–­å¼€è¿æ¥ï¼Œ5ç§’åå°è¯•é‡è¿...&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>vTaskDelay</span>(<span style=color:#a6e22e>pdMS_TO_TICKS</span>(<span style=color:#ae81ff>5000</span>));
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>esp_wifi_connect</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (event_base <span style=color:#f92672>==</span> IP_EVENT <span style=color:#f92672>&amp;&amp;</span> event_id <span style=color:#f92672>==</span> IP_EVENT_STA_GOT_IP)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>ip_event_got_ip_t</span> <span style=color:#f92672>*</span>event <span style=color:#f92672>=</span> (<span style=color:#66d9ef>ip_event_got_ip_t</span> <span style=color:#f92672>*</span>)event_data;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;WiFiè¿æ¥æˆåŠŸï¼Œè·å–åˆ°IPåœ°å€: &#34;</span> IPSTR, <span style=color:#a6e22e>IP2STR</span>(<span style=color:#f92672>&amp;</span>event<span style=color:#f92672>-&gt;</span>ip_info.ip));
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;å­ç½‘æ©ç : &#34;</span> IPSTR, <span style=color:#a6e22e>IP2STR</span>(<span style=color:#f92672>&amp;</span>event<span style=color:#f92672>-&gt;</span>ip_info.netmask));
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;ç½‘å…³: &#34;</span> IPSTR, <span style=color:#a6e22e>IP2STR</span>(<span style=color:#f92672>&amp;</span>event<span style=color:#f92672>-&gt;</span>ip_info.gw));
</span></span><span style=display:flex><span>        wifi_connected <span style=color:#f92672>=</span> true;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// åˆå§‹åŒ–UDP socket
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>init_udp_socket</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// åˆå§‹åŒ–UDP socket
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>init_udp_socket</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (sock <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>close</span>(sock);
</span></span><span style=display:flex><span>        sock <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    sock <span style=color:#f92672>=</span> <span style=color:#a6e22e>socket</span>(AF_INET, SOCK_DGRAM, IPPROTO_IP);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (sock <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;åˆ›å»ºsocketå¤±è´¥: %s&#34;</span>, <span style=color:#a6e22e>strerror</span>(errno));
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è®¾ç½®socketé€‰é¡¹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>int</span> opt <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>setsockopt</span>(sock, SOL_SOCKET, SO_REUSEADDR, <span style=color:#f92672>&amp;</span>opt, <span style=color:#66d9ef>sizeof</span>(opt));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è®¾ç½®æ¥æ”¶è¶…æ—¶
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>struct</span> timeval timeout;
</span></span><span style=display:flex><span>    timeout.tv_sec <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    timeout.tv_usec <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>setsockopt</span>(sock, SOL_SOCKET, SO_RCVTIMEO, <span style=color:#f92672>&amp;</span>timeout, <span style=color:#66d9ef>sizeof</span>(timeout));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> sockaddr_in server_addr;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>memset</span>(<span style=color:#f92672>&amp;</span>server_addr, <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>sizeof</span>(server_addr));
</span></span><span style=display:flex><span>    server_addr.sin_family <span style=color:#f92672>=</span> AF_INET;
</span></span><span style=display:flex><span>    server_addr.sin_port <span style=color:#f92672>=</span> <span style=color:#a6e22e>htons</span>(UDP_PORT);
</span></span><span style=display:flex><span>    server_addr.sin_addr.s_addr <span style=color:#f92672>=</span> <span style=color:#a6e22e>htonl</span>(INADDR_ANY);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>bind</span>(sock, (<span style=color:#66d9ef>struct</span> sockaddr <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>server_addr, <span style=color:#66d9ef>sizeof</span>(server_addr)) <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;ç»‘å®šç«¯å£å¤±è´¥: %s&#34;</span>, <span style=color:#a6e22e>strerror</span>(errno));
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>close</span>(sock);
</span></span><span style=display:flex><span>        sock <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è®¾ç½®socketä¸ºéé˜»å¡æ¨¡å¼
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>int</span> flags <span style=color:#f92672>=</span> <span style=color:#a6e22e>fcntl</span>(sock, F_GETFL, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fcntl</span>(sock, F_SETFL, flags <span style=color:#f92672>|</span> O_NONBLOCK);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;UDPæ¥æ”¶ç«¯å¯åŠ¨æˆåŠŸï¼Œç›‘å¬ç«¯å£: %d&#34;</span>, UDP_PORT);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;ç­‰å¾…æ¥æ”¶éŸ³é¢‘æ•°æ®...&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// I2S TXåˆå§‹åŒ–
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>i2s_tx_init</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;åˆå§‹åŒ–I2S TX...&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>i2s_chan_config_t</span> chan_cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>I2S_CHANNEL_DEFAULT_CONFIG</span>(I2S_NUM_0, I2S_ROLE_MASTER);
</span></span><span style=display:flex><span>    chan_cfg.dma_frame_num <span style=color:#f92672>=</span> <span style=color:#ae81ff>1023</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>esp_err_t</span> ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>i2s_new_channel</span>(<span style=color:#f92672>&amp;</span>chan_cfg, <span style=color:#f92672>&amp;</span>tx_handle, NULL);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (ret <span style=color:#f92672>!=</span> ESP_OK)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;åˆ›å»ºI2Sé€šé“å¤±è´¥: %d&#34;</span>, ret);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>i2s_std_config_t</span> std_cfg <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        .clk_cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>I2S_STD_CLK_DEFAULT_CONFIG</span>(<span style=color:#ae81ff>44100</span>),
</span></span><span style=display:flex><span>        .slot_cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>I2S_STD_MSB_SLOT_DEFAULT_CONFIG</span>(I2S_DATA_BIT_WIDTH_32BIT, I2S_SLOT_MODE_MONO),
</span></span><span style=display:flex><span>        .gpio_cfg <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            .mclk <span style=color:#f92672>=</span> I2S_GPIO_UNUSED,
</span></span><span style=display:flex><span>            .din <span style=color:#f92672>=</span> I2S_GPIO_UNUSED,
</span></span><span style=display:flex><span>            .bclk <span style=color:#f92672>=</span> MAX_BCLK,
</span></span><span style=display:flex><span>            .ws <span style=color:#f92672>=</span> MAX_LRC,
</span></span><span style=display:flex><span>            .dout <span style=color:#f92672>=</span> MAX_DIN,
</span></span><span style=display:flex><span>            .invert_flags <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>                .mclk_inv <span style=color:#f92672>=</span> false,
</span></span><span style=display:flex><span>                .bclk_inv <span style=color:#f92672>=</span> false,
</span></span><span style=display:flex><span>                .ws_inv <span style=color:#f92672>=</span> false,
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>i2s_channel_init_std_mode</span>(tx_handle, <span style=color:#f92672>&amp;</span>std_cfg);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (ret <span style=color:#f92672>!=</span> ESP_OK)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;åˆå§‹åŒ–I2Sæ ‡å‡†æ¨¡å¼å¤±è´¥: %d&#34;</span>, ret);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>i2s_channel_enable</span>(tx_handle);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (ret <span style=color:#f92672>!=</span> ESP_OK)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;å¯ç”¨I2Sé€šé“å¤±è´¥: %d&#34;</span>, ret);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;I2S TXåˆå§‹åŒ–å®Œæˆ&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// UDPæ¥æ”¶ä»»åŠ¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>udp_receive_task</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>args)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;UDPæ¥æ”¶ä»»åŠ¡å¯åŠ¨&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> (<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>wifi_connected)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ESP_LOGW</span>(TAG, <span style=color:#e6db74>&#34;ç­‰å¾…WiFiè¿æ¥...&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>vTaskDelay</span>(<span style=color:#a6e22e>pdMS_TO_TICKS</span>(<span style=color:#ae81ff>2000</span>));
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (sock <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ESP_LOGW</span>(TAG, <span style=color:#e6db74>&#34;ç­‰å¾…UDP socketåˆå§‹åŒ–...&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>vTaskDelay</span>(<span style=color:#a6e22e>pdMS_TO_TICKS</span>(<span style=color:#ae81ff>1000</span>));
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>struct</span> sockaddr_in source_addr;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>socklen_t</span> addr_len <span style=color:#f92672>=</span> <span style=color:#66d9ef>sizeof</span>(source_addr);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> len <span style=color:#f92672>=</span> <span style=color:#a6e22e>recvfrom</span>(sock, audio_buf, BUF_SIZE, <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>                           (<span style=color:#66d9ef>struct</span> sockaddr <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>source_addr, <span style=color:#f92672>&amp;</span>addr_len);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (len <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>char</span> source_ip[<span style=color:#ae81ff>16</span>];
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>inet_ntoa_r</span>(source_addr.sin_addr, source_ip, <span style=color:#66d9ef>sizeof</span>(source_ip) <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>            receive_count<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;æ”¶åˆ°æ¥è‡ª %s:%d çš„æ•°æ®åŒ…#%dï¼Œé•¿åº¦: %d å­—èŠ‚&#34;</span>,
</span></span><span style=display:flex><span>                     source_ip, <span style=color:#a6e22e>ntohs</span>(source_addr.sin_port), receive_count, len);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// æ£€æŸ¥æ˜¯å¦æ˜¯æµ‹è¯•åŒ…
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> (len <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>20</span>)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                audio_buf[len] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;\0&#39;</span>; <span style=color:#75715e>// ç¡®ä¿å­—ç¬¦ä¸²ç»“æŸ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>strstr</span>((<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)audio_buf, <span style=color:#e6db74>&#34;TEST&#34;</span>) <span style=color:#f92672>!=</span> NULL)
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;æ”¶åˆ°è¿æ¥æµ‹è¯•åŒ…: %s&#34;</span>, audio_buf);
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>continue</span>; <span style=color:#75715e>// ä¸æ’­æ”¾æµ‹è¯•åŒ…
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// æ’­æ”¾æ¥æ”¶åˆ°çš„éŸ³é¢‘æ•°æ®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>size_t</span> bytes_written <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>esp_err_t</span> ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>i2s_channel_write</span>(tx_handle, audio_buf, len, <span style=color:#f92672>&amp;</span>bytes_written, portMAX_DELAY);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (ret <span style=color:#f92672>!=</span> ESP_OK)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;I2Så†™å…¥å¤±è´¥: %d&#34;</span>, ret);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (receive_count <span style=color:#f92672>%</span> <span style=color:#ae81ff>10</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;æˆåŠŸæ’­æ”¾éŸ³é¢‘: %d å­—èŠ‚&#34;</span>, bytes_written);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (len <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (errno <span style=color:#f92672>==</span> EAGAIN <span style=color:#f92672>||</span> errno <span style=color:#f92672>==</span> EWOULDBLOCK)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// éé˜»å¡æ¨¡å¼ä¸‹æ²¡æœ‰æ•°æ®æ˜¯æ­£å¸¸çš„
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>if</span> (receive_count <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> (<span style=color:#a6e22e>xTaskGetTickCount</span>() <span style=color:#f92672>%</span> <span style=color:#ae81ff>10000</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>))
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>ESP_LOGW</span>(TAG, <span style=color:#e6db74>&#34;ç­‰å¾…æ¥æ”¶æ•°æ®...ï¼ˆå½“å‰æ¥æ”¶åŒ…æ•°: %dï¼‰&#34;</span>, receive_count);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;æ¥æ”¶æ•°æ®å¤±è´¥: %s (errno: %d)&#34;</span>, <span style=color:#a6e22e>strerror</span>(errno), errno);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>vTaskDelay</span>(<span style=color:#a6e22e>pdMS_TO_TICKS</span>(<span style=color:#ae81ff>10</span>));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>app_main</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;=== éŸ³é¢‘æ¥æ”¶ç«¯å¯åŠ¨ ===&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åˆå§‹åŒ–NVS
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>esp_err_t</span> ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>nvs_flash_init</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (ret <span style=color:#f92672>==</span> ESP_ERR_NVS_NO_FREE_PAGES <span style=color:#f92672>||</span> ret <span style=color:#f92672>==</span> ESP_ERR_NVS_NEW_VERSION_FOUND)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;æ“¦é™¤NVS...&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>nvs_flash_erase</span>());
</span></span><span style=display:flex><span>        ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>nvs_flash_init</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(ret);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;NVSåˆå§‹åŒ–å®Œæˆ&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åˆå§‹åŒ–I2S
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>i2s_tx_init</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åˆå§‹åŒ–WiFi
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>wifi_init</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åˆ›å»ºUDPæ¥æ”¶ä»»åŠ¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>xTaskCreate</span>(udp_receive_task, <span style=color:#e6db74>&#34;udp_receive&#34;</span>, <span style=color:#ae81ff>12288</span>, NULL, <span style=color:#ae81ff>5</span>, NULL);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;UDPæ¥æ”¶ä»»åŠ¡åˆ›å»ºå®Œæˆ&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼Œç­‰å¾…WiFiè¿æ¥...&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ä¿æŒä»»åŠ¡è¿è¡Œ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>while</span> (<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (wifi_connected)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (sock <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;ç³»ç»Ÿè¿è¡Œä¸­ - WiFiå·²è¿æ¥ï¼ŒSocketå°±ç»ªï¼Œå·²æ¥æ”¶æ•°æ®åŒ…: %d&#34;</span>, receive_count);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>ESP_LOGW</span>(TAG, <span style=color:#e6db74>&#34;ç³»ç»Ÿè¿è¡Œä¸­ - WiFiå·²è¿æ¥ï¼Œä½†Socketæœªå°±ç»ª&#34;</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ESP_LOGW</span>(TAG, <span style=color:#e6db74>&#34;ç³»ç»Ÿè¿è¡Œä¸­ - ç­‰å¾…WiFiè¿æ¥...&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>vTaskDelay</span>(<span style=color:#a6e22e>pdMS_TO_TICKS</span>(<span style=color:#ae81ff>10000</span>));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h1 id=tcp>TCP<a hidden class=anchor aria-hidden=true href=#tcp>#</a></h1><p>å‘é€ç«¯</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// sender_main.c
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;string.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;math.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;freertos/FreeRTOS.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;freertos/task.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_wifi.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_event.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_log.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;nvs_flash.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_netif.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;lwip/sockets.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;driver/i2s_std.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ======== é…ç½®éƒ¨åˆ† ========
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define WIFI_SSID &#34;RTCT2300&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define WIFI_PASS &#34;123123*zx&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define RECEIVER_IP &#34;192.168.80.39&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define RECEIVER_PORT 5005
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define INMP_SD GPIO_NUM_13
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define INMP_SCK GPIO_NUM_14
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define INMP_WS GPIO_NUM_27
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define SAMPLE_RATE 44100
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>// æ³¨æ„è¯»ç¼“å†²è‡³å°‘åº”æ˜¯4å­—èŠ‚çš„å€æ•°ï¼ˆ32-bit æ ·æœ¬å®¹å™¨ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define READ_BUF_SIZE 1024
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>TAG <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;audio_sender&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>i2s_chan_handle_t</span> rx_handle;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// åˆå§‹åŒ–éº¦å…‹é£è¾“å…¥ï¼ˆINMP441ï¼‰ï¼Œä½¿ç”¨ Philipsï¼ˆæ ‡å‡† I2Sï¼‰æ ¼å¼ï¼Œå®¹å™¨ä¿æŒ 32bit ä»¥ä¾¿è¯»åˆ°å®Œæ•´æ ·æœ¬
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>i2s_rx_init</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>i2s_chan_config_t</span> chan_cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>I2S_CHANNEL_DEFAULT_CONFIG</span>(I2S_NUM_0, I2S_ROLE_MASTER);
</span></span><span style=display:flex><span>    chan_cfg.dma_frame_num <span style=color:#f92672>=</span> <span style=color:#ae81ff>512</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>i2s_new_channel</span>(<span style=color:#f92672>&amp;</span>chan_cfg, NULL, <span style=color:#f92672>&amp;</span>rx_handle);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>i2s_std_config_t</span> std_cfg <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        .clk_cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>I2S_STD_CLK_DEFAULT_CONFIG</span>(SAMPLE_RATE),
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ä½¿ç”¨ 32bit å®¹å™¨è¯»å–ï¼ˆéº¦å…‹é£é€šå¸¸æŠŠ 24bit æ”¾åœ¨ 32bit å®¹å™¨ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        .slot_cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>I2S_STD_PHILIPS_SLOT_DEFAULT_CONFIG</span>(I2S_DATA_BIT_WIDTH_32BIT, I2S_SLOT_MODE_MONO),
</span></span><span style=display:flex><span>        .gpio_cfg <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            .mclk <span style=color:#f92672>=</span> I2S_GPIO_UNUSED,
</span></span><span style=display:flex><span>            .dout <span style=color:#f92672>=</span> I2S_GPIO_UNUSED,
</span></span><span style=display:flex><span>            .bclk <span style=color:#f92672>=</span> INMP_SCK,
</span></span><span style=display:flex><span>            .ws <span style=color:#f92672>=</span> INMP_WS,
</span></span><span style=display:flex><span>            .din <span style=color:#f92672>=</span> INMP_SD,
</span></span><span style=display:flex><span>            .invert_flags <span style=color:#f92672>=</span> {<span style=color:#ae81ff>0</span>},
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>i2s_channel_init_std_mode</span>(rx_handle, <span style=color:#f92672>&amp;</span>std_cfg);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>i2s_channel_enable</span>(rx_handle);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;I2S RX (Mic) initialized (Philips, 32-bit container)&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Wi-Fi äº‹ä»¶
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>wifi_event_handler</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>arg, <span style=color:#66d9ef>esp_event_base_t</span> event_base,
</span></span><span style=display:flex><span>                               <span style=color:#66d9ef>int32_t</span> event_id, <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>event_data)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (event_base <span style=color:#f92672>==</span> WIFI_EVENT <span style=color:#f92672>&amp;&amp;</span> event_id <span style=color:#f92672>==</span> WIFI_EVENT_STA_START)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>esp_wifi_connect</span>();
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Connecting to Wi-Fi...&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (event_base <span style=color:#f92672>==</span> WIFI_EVENT <span style=color:#f92672>&amp;&amp;</span> event_id <span style=color:#f92672>==</span> WIFI_EVENT_STA_DISCONNECTED)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGW</span>(TAG, <span style=color:#e6db74>&#34;Wi-Fi disconnected, retrying...&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>esp_wifi_connect</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (event_base <span style=color:#f92672>==</span> IP_EVENT <span style=color:#f92672>&amp;&amp;</span> event_id <span style=color:#f92672>==</span> IP_EVENT_STA_GOT_IP)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>ip_event_got_ip_t</span> <span style=color:#f92672>*</span>event <span style=color:#f92672>=</span> (<span style=color:#66d9ef>ip_event_got_ip_t</span> <span style=color:#f92672>*</span>)event_data;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Got IP: &#34;</span> IPSTR, <span style=color:#a6e22e>IP2STR</span>(<span style=color:#f92672>&amp;</span>event<span style=color:#f92672>-&gt;</span>ip_info.ip));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// åˆå§‹åŒ– Wi-Fi STA æ¨¡å¼
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>wifi_init_sta</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_netif_init</span>());
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_event_loop_create_default</span>());
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_netif_create_default_wifi_sta</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>wifi_init_config_t</span> cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>WIFI_INIT_CONFIG_DEFAULT</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_wifi_init</span>(<span style=color:#f92672>&amp;</span>cfg));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>esp_event_handler_instance_t</span> instance_any_id;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>esp_event_handler_instance_t</span> instance_got_ip;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_event_handler_instance_register</span>(WIFI_EVENT,
</span></span><span style=display:flex><span>                                                        ESP_EVENT_ANY_ID,
</span></span><span style=display:flex><span>                                                        <span style=color:#f92672>&amp;</span>wifi_event_handler,
</span></span><span style=display:flex><span>                                                        NULL,
</span></span><span style=display:flex><span>                                                        <span style=color:#f92672>&amp;</span>instance_any_id));
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_event_handler_instance_register</span>(IP_EVENT,
</span></span><span style=display:flex><span>                                                        IP_EVENT_STA_GOT_IP,
</span></span><span style=display:flex><span>                                                        <span style=color:#f92672>&amp;</span>wifi_event_handler,
</span></span><span style=display:flex><span>                                                        NULL,
</span></span><span style=display:flex><span>                                                        <span style=color:#f92672>&amp;</span>instance_got_ip));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>wifi_config_t</span> wifi_config <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        .sta <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            .ssid <span style=color:#f92672>=</span> WIFI_SSID,
</span></span><span style=display:flex><span>            .password <span style=color:#f92672>=</span> WIFI_PASS,
</span></span><span style=display:flex><span>            .threshold.authmode <span style=color:#f92672>=</span> WIFI_AUTH_WPA2_PSK,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_wifi_set_mode</span>(WIFI_MODE_STA));
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_wifi_set_config</span>(WIFI_IF_STA, <span style=color:#f92672>&amp;</span>wifi_config));
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_wifi_start</span>());
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// éŸ³é¢‘å‘é€ä»»åŠ¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>audio_send_task</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>pvParameters)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> sockaddr_in dest_addr;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> sock;
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è¯»å– 32-bit å®¹å™¨æ•°æ® buffer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>uint8_t</span> read_buf[READ_BUF_SIZE];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>size_t</span> bytes_read;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> log_counter <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ç”¨äºè½¬æ¢åˆ° 16-bit PCM çš„ç¼“å†²ï¼ˆæœ€å¤§æ ·æœ¬æ•° = READ_BUF_SIZE / 4ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// æ¯ä¸ªæ ·æœ¬ 2 å­—èŠ‚è¾“å‡º
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>uint8_t</span> out_buf[READ_BUF_SIZE <span style=color:#f92672>/</span> <span style=color:#ae81ff>2</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> (<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// è¿æ¥ TCP
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        dest_addr.sin_addr.s_addr <span style=color:#f92672>=</span> <span style=color:#a6e22e>inet_addr</span>(RECEIVER_IP);
</span></span><span style=display:flex><span>        dest_addr.sin_family <span style=color:#f92672>=</span> AF_INET;
</span></span><span style=display:flex><span>        dest_addr.sin_port <span style=color:#f92672>=</span> <span style=color:#a6e22e>htons</span>(RECEIVER_PORT);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        sock <span style=color:#f92672>=</span> <span style=color:#a6e22e>socket</span>(AF_INET, SOCK_STREAM, IPPROTO_IP);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (sock <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;Unable to create socket&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>vTaskDelay</span>(<span style=color:#a6e22e>pdMS_TO_TICKS</span>(<span style=color:#ae81ff>2000</span>));
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Connecting to receiver %s:%d ...&#34;</span>, RECEIVER_IP, RECEIVER_PORT);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>connect</span>(sock, (<span style=color:#66d9ef>struct</span> sockaddr <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>dest_addr, <span style=color:#66d9ef>sizeof</span>(dest_addr)) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;Connection failed&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>close</span>(sock);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>vTaskDelay</span>(<span style=color:#a6e22e>pdMS_TO_TICKS</span>(<span style=color:#ae81ff>2000</span>));
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Connected! Start sending audio...&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> (<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// ä»éº¦å…‹é£è¯»å– 32-bit å®¹å™¨æ ·æœ¬
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>esp_err_t</span> r <span style=color:#f92672>=</span> <span style=color:#a6e22e>i2s_channel_read</span>(rx_handle, read_buf, READ_BUF_SIZE, <span style=color:#f92672>&amp;</span>bytes_read, <span style=color:#ae81ff>1000</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (r <span style=color:#f92672>==</span> ESP_OK <span style=color:#f92672>&amp;&amp;</span> bytes_read <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// bytes_read æ˜¯å­—èŠ‚æ•°ï¼Œæ ·æœ¬æ•° = bytes_read / 4
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>int</span> sample_count <span style=color:#f92672>=</span> bytes_read <span style=color:#f92672>/</span> <span style=color:#ae81ff>4</span>;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>int64_t</span> energy <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>int32_t</span> <span style=color:#f92672>*</span>samples32 <span style=color:#f92672>=</span> (<span style=color:#66d9ef>int32_t</span> <span style=color:#f92672>*</span>)read_buf;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// è®¡ç®—èƒ½é‡ï¼ˆä½¿ç”¨ 32-bit åŸæ ·æœ¬ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> sample_count; i<span style=color:#f92672>++</span>)
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// INMP441 é€šå¸¸æ˜¯ 24-bit åœ¨é«˜ä½ï¼Œæ‰€ä»¥ llabs(samples32[i]) åˆç†
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    energy <span style=color:#f92672>+=</span> <span style=color:#a6e22e>llabs</span>((<span style=color:#66d9ef>int64_t</span>)samples32[i]);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (sample_count <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>                    energy <span style=color:#f92672>/=</span> sample_count;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (energy <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>5000</span> <span style=color:#f92672>&amp;&amp;</span> log_counter<span style=color:#f92672>++</span> <span style=color:#f92672>%</span> <span style=color:#ae81ff>10</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;ğŸ¤ Detected voice (energy=%lld)&#34;</span>, energy);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// å°† 32-bit æ ·æœ¬é™åˆ° 16-bit PCMï¼ˆå–é«˜ 16 ä½ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>// è¾“å‡ºä¸º little-endian 16-bit
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> sample_count; i<span style=color:#f92672>++</span>)
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>int32_t</span> s32 <span style=color:#f92672>=</span> samples32[i];
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>int16_t</span> s16 <span style=color:#f92672>=</span> (<span style=color:#66d9ef>int16_t</span>)(s32 <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>16</span>); <span style=color:#75715e>// å–é«˜ 16 ä½
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#75715e>// little-endian å†™å…¥
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    out_buf[<span style=color:#ae81ff>2</span> <span style=color:#f92672>*</span> i] <span style=color:#f92672>=</span> (<span style=color:#66d9ef>uint8_t</span>)(s16 <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0xFF</span>);
</span></span><span style=display:flex><span>                    out_buf[<span style=color:#ae81ff>2</span> <span style=color:#f92672>*</span> i <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>] <span style=color:#f92672>=</span> (<span style=color:#66d9ef>uint8_t</span>)((s16 <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>8</span>) <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0xFF</span>);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>int</span> out_bytes <span style=color:#f92672>=</span> sample_count <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>int</span> err <span style=color:#f92672>=</span> <span style=color:#a6e22e>send</span>(sock, out_buf, out_bytes, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (err <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;Send failed (%d), reconnecting...&#34;</span>, err);
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>close</span>(sock);
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// è¶…æ—¶æˆ–è¯»å–å¤±è´¥ï¼ˆå¯èƒ½éº¦å…‹é£/é©±åŠ¨æš‚æ—¶æ²¡æ•°æ®ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>// ä¸è¦é¢‘ç¹æ‰“å°ä»¥å…åˆ·å±
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>app_main</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>nvs_flash_init</span>());
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>wifi_init_sta</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>i2s_rx_init</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>xTaskCreate</span>(audio_send_task, <span style=color:#e6db74>&#34;audio_send_task&#34;</span>, <span style=color:#ae81ff>8192</span>, NULL, <span style=color:#ae81ff>5</span>, NULL);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æ¥æ”¶</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;string.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;math.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;freertos/FreeRTOS.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;freertos/task.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_wifi.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_event.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_log.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;nvs_flash.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_netif.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;lwip/sockets.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;driver/i2s_std.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ======== Wi-Fi &amp; TCP é…ç½® ========
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define WIFI_SSID &#34;RTCT2300&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define WIFI_PASS &#34;123123*zx&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define TCP_PORT 5005
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ======== éŸ³é¢‘å‚æ•° ========
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define SAMPLE_RATE 44100
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define BUF_SIZE 1024 </span><span style=color:#75715e>// ä¸å‘é€ç«¯ä¸€è‡´
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ======== MAX98357A æ¥çº¿ ========
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define MAX_BCLK GPIO_NUM_16
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define MAX_LRC GPIO_NUM_17
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define MAX_DIN GPIO_NUM_15
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>TAG <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;audio_receiver&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>i2s_chan_handle_t</span> tx_handle;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ==================== I2S åˆå§‹åŒ– ====================
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>i2s_tx_init</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>i2s_chan_config_t</span> chan_cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>I2S_CHANNEL_DEFAULT_CONFIG</span>(I2S_NUM_0, I2S_ROLE_MASTER);
</span></span><span style=display:flex><span>    chan_cfg.dma_frame_num <span style=color:#f92672>=</span> <span style=color:#ae81ff>512</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>i2s_new_channel</span>(<span style=color:#f92672>&amp;</span>chan_cfg, <span style=color:#f92672>&amp;</span>tx_handle, NULL));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>i2s_std_config_t</span> std_cfg <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        .clk_cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>I2S_STD_CLK_DEFAULT_CONFIG</span>(SAMPLE_RATE),
</span></span><span style=display:flex><span>        <span style=color:#75715e>// âœ… ä½¿ç”¨æ ‡å‡† Philips æ ¼å¼ã€16-bit å•å£°é“
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        .slot_cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>I2S_STD_PHILIPS_SLOT_DEFAULT_CONFIG</span>(I2S_DATA_BIT_WIDTH_16BIT,
</span></span><span style=display:flex><span>                                                        I2S_SLOT_MODE_MONO),
</span></span><span style=display:flex><span>        .gpio_cfg <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            .mclk <span style=color:#f92672>=</span> I2S_GPIO_UNUSED,
</span></span><span style=display:flex><span>            .bclk <span style=color:#f92672>=</span> MAX_BCLK,
</span></span><span style=display:flex><span>            .ws <span style=color:#f92672>=</span> MAX_LRC,
</span></span><span style=display:flex><span>            .dout <span style=color:#f92672>=</span> MAX_DIN,
</span></span><span style=display:flex><span>            .din <span style=color:#f92672>=</span> I2S_GPIO_UNUSED,
</span></span><span style=display:flex><span>            .invert_flags <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>                .mclk_inv <span style=color:#f92672>=</span> false,
</span></span><span style=display:flex><span>                .bclk_inv <span style=color:#f92672>=</span> false,
</span></span><span style=display:flex><span>                .ws_inv <span style=color:#f92672>=</span> false,
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>i2s_channel_init_std_mode</span>(tx_handle, <span style=color:#f92672>&amp;</span>std_cfg));
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>i2s_channel_enable</span>(tx_handle));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;âœ… I2S TX initialized: 44.1kHz, 16-bit, mono&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ==================== Wi-Fi äº‹ä»¶å›è°ƒ ====================
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>wifi_event_handler</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>arg, <span style=color:#66d9ef>esp_event_base_t</span> event_base,
</span></span><span style=display:flex><span>                               <span style=color:#66d9ef>int32_t</span> event_id, <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>event_data)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (event_base <span style=color:#f92672>==</span> WIFI_EVENT <span style=color:#f92672>&amp;&amp;</span> event_id <span style=color:#f92672>==</span> WIFI_EVENT_STA_START)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>esp_wifi_connect</span>();
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Connecting to Wi-Fi...&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (event_base <span style=color:#f92672>==</span> WIFI_EVENT <span style=color:#f92672>&amp;&amp;</span> event_id <span style=color:#f92672>==</span> WIFI_EVENT_STA_DISCONNECTED)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGW</span>(TAG, <span style=color:#e6db74>&#34;Disconnected, retrying...&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>esp_wifi_connect</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (event_base <span style=color:#f92672>==</span> IP_EVENT <span style=color:#f92672>&amp;&amp;</span> event_id <span style=color:#f92672>==</span> IP_EVENT_STA_GOT_IP)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>ip_event_got_ip_t</span> <span style=color:#f92672>*</span>event <span style=color:#f92672>=</span> (<span style=color:#66d9ef>ip_event_got_ip_t</span> <span style=color:#f92672>*</span>)event_data;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Got IP: &#34;</span> IPSTR, <span style=color:#a6e22e>IP2STR</span>(<span style=color:#f92672>&amp;</span>event<span style=color:#f92672>-&gt;</span>ip_info.ip));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ==================== Wi-Fi STA åˆå§‹åŒ– ====================
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>wifi_init_sta</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_netif_init</span>());
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_event_loop_create_default</span>());
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_netif_create_default_wifi_sta</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>wifi_init_config_t</span> cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>WIFI_INIT_CONFIG_DEFAULT</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_wifi_init</span>(<span style=color:#f92672>&amp;</span>cfg));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>esp_event_handler_instance_t</span> instance_any_id;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>esp_event_handler_instance_t</span> instance_got_ip;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_event_handler_instance_register</span>(WIFI_EVENT,
</span></span><span style=display:flex><span>                                                        ESP_EVENT_ANY_ID,
</span></span><span style=display:flex><span>                                                        <span style=color:#f92672>&amp;</span>wifi_event_handler,
</span></span><span style=display:flex><span>                                                        NULL,
</span></span><span style=display:flex><span>                                                        <span style=color:#f92672>&amp;</span>instance_any_id));
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_event_handler_instance_register</span>(IP_EVENT,
</span></span><span style=display:flex><span>                                                        IP_EVENT_STA_GOT_IP,
</span></span><span style=display:flex><span>                                                        <span style=color:#f92672>&amp;</span>wifi_event_handler,
</span></span><span style=display:flex><span>                                                        NULL,
</span></span><span style=display:flex><span>                                                        <span style=color:#f92672>&amp;</span>instance_got_ip));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>wifi_config_t</span> wifi_config <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        .sta <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            .ssid <span style=color:#f92672>=</span> WIFI_SSID,
</span></span><span style=display:flex><span>            .password <span style=color:#f92672>=</span> WIFI_PASS,
</span></span><span style=display:flex><span>            .threshold.authmode <span style=color:#f92672>=</span> WIFI_AUTH_WPA2_PSK,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_wifi_set_mode</span>(WIFI_MODE_STA));
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_wifi_set_config</span>(WIFI_IF_STA, <span style=color:#f92672>&amp;</span>wifi_config));
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_wifi_start</span>());
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ==================== éŸ³é¢‘æ¥æ”¶æ’­æ”¾ä»»åŠ¡ ====================
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>audio_receive_task</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>pvParameters)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> sockaddr_in server_addr, client_addr;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>socklen_t</span> client_len <span style=color:#f92672>=</span> <span style=color:#66d9ef>sizeof</span>(client_addr);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> listen_sock, client_sock;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> rx_buffer[BUF_SIZE];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>size_t</span> bytes_written;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> packet_count <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    listen_sock <span style=color:#f92672>=</span> <span style=color:#a6e22e>socket</span>(AF_INET, SOCK_STREAM, IPPROTO_IP);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (listen_sock <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;Unable to create socket&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>vTaskDelete</span>(NULL);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    server_addr.sin_addr.s_addr <span style=color:#f92672>=</span> <span style=color:#a6e22e>htonl</span>(INADDR_ANY);
</span></span><span style=display:flex><span>    server_addr.sin_family <span style=color:#f92672>=</span> AF_INET;
</span></span><span style=display:flex><span>    server_addr.sin_port <span style=color:#f92672>=</span> <span style=color:#a6e22e>htons</span>(TCP_PORT);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bind</span>(listen_sock, (<span style=color:#66d9ef>struct</span> sockaddr <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>server_addr, <span style=color:#66d9ef>sizeof</span>(server_addr));
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>listen</span>(listen_sock, <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Waiting for connection on port %d...&#34;</span>, TCP_PORT);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> (<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        client_sock <span style=color:#f92672>=</span> <span style=color:#a6e22e>accept</span>(listen_sock, (<span style=color:#66d9ef>struct</span> sockaddr <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>client_addr, <span style=color:#f92672>&amp;</span>client_len);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (client_sock <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;Unable to accept connection&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;ğŸ§ Client connected from %s&#34;</span>, <span style=color:#a6e22e>inet_ntoa</span>(client_addr.sin_addr));
</span></span><span style=display:flex><span>        packet_count <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> (<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int</span> len <span style=color:#f92672>=</span> <span style=color:#a6e22e>recv</span>(client_sock, rx_buffer, <span style=color:#66d9ef>sizeof</span>(rx_buffer), <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (len <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>ESP_LOGW</span>(TAG, <span style=color:#e6db74>&#34;Client disconnected&#34;</span>);
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>close</span>(client_sock);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// æ¯ 50 åŒ…æ‰“å°ä¸€æ¬¡æ—¥å¿—
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> (<span style=color:#f92672>++</span>packet_count <span style=color:#f92672>%</span> <span style=color:#ae81ff>50</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;ğŸµ Receiving audio... (%d packets)&#34;</span>, packet_count);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// âœ… ç›´æ¥æ’­æ”¾ï¼Œä¸è¿›è¡Œä½ç§»æˆ–è½¬æ¢
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#a6e22e>i2s_channel_write</span>(tx_handle, rx_buffer, len, <span style=color:#f92672>&amp;</span>bytes_written, portMAX_DELAY);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ==================== ä¸»å‡½æ•° ====================
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>app_main</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>nvs_flash_init</span>());
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>wifi_init_sta</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>i2s_tx_init</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>xTaskCreate</span>(audio_receive_task, <span style=color:#e6db74>&#34;audio_receive_task&#34;</span>, <span style=color:#ae81ff>8192</span>, NULL, <span style=color:#ae81ff>5</span>, NULL);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h1 id=esp32ä¸ä¸»æœºpythonç¨‹åº-tcpè¿æ¥ä¼ è¾“éŸ³é¢‘>ESP32ä¸ä¸»æœºpythonç¨‹åº TCPè¿æ¥ä¼ è¾“éŸ³é¢‘<a hidden class=anchor aria-hidden=true href=#esp32ä¸ä¸»æœºpythonç¨‹åº-tcpè¿æ¥ä¼ è¾“éŸ³é¢‘>#</a></h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// sender_main.c
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;string.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;math.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;freertos/FreeRTOS.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;freertos/task.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_wifi.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_event.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_log.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;nvs_flash.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_netif.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;lwip/sockets.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;driver/i2s_std.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ======== é…ç½®éƒ¨åˆ† ========
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define WIFI_SSID &#34;RTCT2300&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define WIFI_PASS &#34;123123*zxcvb&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define RECEIVER_IP &#34;192.168.80.77&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define RECEIVER_PORT 5005
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define INMP_SD GPIO_NUM_13
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define INMP_SCK GPIO_NUM_14
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define INMP_WS GPIO_NUM_27
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define SAMPLE_RATE 44100
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>// æ³¨æ„è¯»ç¼“å†²è‡³å°‘åº”æ˜¯4å­—èŠ‚çš„å€æ•°ï¼ˆ32-bit æ ·æœ¬å®¹å™¨ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define READ_BUF_SIZE 1024
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>TAG <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;audio_sender&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>i2s_chan_handle_t</span> rx_handle;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// åˆå§‹åŒ–éº¦å…‹é£è¾“å…¥ï¼ˆINMP441ï¼‰ï¼Œä½¿ç”¨ Philipsï¼ˆæ ‡å‡† I2Sï¼‰æ ¼å¼ï¼Œå®¹å™¨ä¿æŒ 32bit ä»¥ä¾¿è¯»åˆ°å®Œæ•´æ ·æœ¬
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>i2s_rx_init</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>i2s_chan_config_t</span> chan_cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>I2S_CHANNEL_DEFAULT_CONFIG</span>(I2S_NUM_0, I2S_ROLE_MASTER);
</span></span><span style=display:flex><span>    chan_cfg.dma_frame_num <span style=color:#f92672>=</span> <span style=color:#ae81ff>512</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>i2s_new_channel</span>(<span style=color:#f92672>&amp;</span>chan_cfg, NULL, <span style=color:#f92672>&amp;</span>rx_handle);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>i2s_std_config_t</span> std_cfg <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        .clk_cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>I2S_STD_CLK_DEFAULT_CONFIG</span>(SAMPLE_RATE),
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ä½¿ç”¨ 32bit å®¹å™¨è¯»å–ï¼ˆéº¦å…‹é£é€šå¸¸æŠŠ 24bit æ”¾åœ¨ 32bit å®¹å™¨ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        .slot_cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>I2S_STD_PHILIPS_SLOT_DEFAULT_CONFIG</span>(I2S_DATA_BIT_WIDTH_32BIT, I2S_SLOT_MODE_MONO),
</span></span><span style=display:flex><span>        .gpio_cfg <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            .mclk <span style=color:#f92672>=</span> I2S_GPIO_UNUSED,
</span></span><span style=display:flex><span>            .dout <span style=color:#f92672>=</span> I2S_GPIO_UNUSED,
</span></span><span style=display:flex><span>            .bclk <span style=color:#f92672>=</span> INMP_SCK,
</span></span><span style=display:flex><span>            .ws <span style=color:#f92672>=</span> INMP_WS,
</span></span><span style=display:flex><span>            .din <span style=color:#f92672>=</span> INMP_SD,
</span></span><span style=display:flex><span>            .invert_flags <span style=color:#f92672>=</span> {<span style=color:#ae81ff>0</span>},
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>i2s_channel_init_std_mode</span>(rx_handle, <span style=color:#f92672>&amp;</span>std_cfg);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>i2s_channel_enable</span>(rx_handle);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;I2S RX (Mic) initialized (Philips, 32-bit container)&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Wi-Fi äº‹ä»¶
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>wifi_event_handler</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>arg, <span style=color:#66d9ef>esp_event_base_t</span> event_base,
</span></span><span style=display:flex><span>                               <span style=color:#66d9ef>int32_t</span> event_id, <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>event_data)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (event_base <span style=color:#f92672>==</span> WIFI_EVENT <span style=color:#f92672>&amp;&amp;</span> event_id <span style=color:#f92672>==</span> WIFI_EVENT_STA_START)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>esp_wifi_connect</span>();
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Connecting to Wi-Fi...&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (event_base <span style=color:#f92672>==</span> WIFI_EVENT <span style=color:#f92672>&amp;&amp;</span> event_id <span style=color:#f92672>==</span> WIFI_EVENT_STA_DISCONNECTED)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGW</span>(TAG, <span style=color:#e6db74>&#34;Wi-Fi disconnected, retrying...&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>esp_wifi_connect</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (event_base <span style=color:#f92672>==</span> IP_EVENT <span style=color:#f92672>&amp;&amp;</span> event_id <span style=color:#f92672>==</span> IP_EVENT_STA_GOT_IP)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>ip_event_got_ip_t</span> <span style=color:#f92672>*</span>event <span style=color:#f92672>=</span> (<span style=color:#66d9ef>ip_event_got_ip_t</span> <span style=color:#f92672>*</span>)event_data;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Got IP: &#34;</span> IPSTR, <span style=color:#a6e22e>IP2STR</span>(<span style=color:#f92672>&amp;</span>event<span style=color:#f92672>-&gt;</span>ip_info.ip));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// åˆå§‹åŒ– Wi-Fi STA æ¨¡å¼
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>wifi_init_sta</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_netif_init</span>());
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_event_loop_create_default</span>());
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_netif_create_default_wifi_sta</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>wifi_init_config_t</span> cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>WIFI_INIT_CONFIG_DEFAULT</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_wifi_init</span>(<span style=color:#f92672>&amp;</span>cfg));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>esp_event_handler_instance_t</span> instance_any_id;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>esp_event_handler_instance_t</span> instance_got_ip;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_event_handler_instance_register</span>(WIFI_EVENT,
</span></span><span style=display:flex><span>                                                        ESP_EVENT_ANY_ID,
</span></span><span style=display:flex><span>                                                        <span style=color:#f92672>&amp;</span>wifi_event_handler,
</span></span><span style=display:flex><span>                                                        NULL,
</span></span><span style=display:flex><span>                                                        <span style=color:#f92672>&amp;</span>instance_any_id));
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_event_handler_instance_register</span>(IP_EVENT,
</span></span><span style=display:flex><span>                                                        IP_EVENT_STA_GOT_IP,
</span></span><span style=display:flex><span>                                                        <span style=color:#f92672>&amp;</span>wifi_event_handler,
</span></span><span style=display:flex><span>                                                        NULL,
</span></span><span style=display:flex><span>                                                        <span style=color:#f92672>&amp;</span>instance_got_ip));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>wifi_config_t</span> wifi_config <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        .sta <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            .ssid <span style=color:#f92672>=</span> WIFI_SSID,
</span></span><span style=display:flex><span>            .password <span style=color:#f92672>=</span> WIFI_PASS,
</span></span><span style=display:flex><span>            .threshold.authmode <span style=color:#f92672>=</span> WIFI_AUTH_WPA2_PSK,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_wifi_set_mode</span>(WIFI_MODE_STA));
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_wifi_set_config</span>(WIFI_IF_STA, <span style=color:#f92672>&amp;</span>wifi_config));
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_wifi_start</span>());
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// éŸ³é¢‘å‘é€ä»»åŠ¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>audio_send_task</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>pvParameters)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> sockaddr_in dest_addr;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> sock;
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è¯»å– 32-bit å®¹å™¨æ•°æ® buffer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>uint8_t</span> read_buf[READ_BUF_SIZE];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>size_t</span> bytes_read;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> log_counter <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ç”¨äºè½¬æ¢åˆ° 16-bit PCM çš„ç¼“å†²ï¼ˆæœ€å¤§æ ·æœ¬æ•° = READ_BUF_SIZE / 4ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// æ¯ä¸ªæ ·æœ¬ 2 å­—èŠ‚è¾“å‡º
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>uint8_t</span> out_buf[READ_BUF_SIZE <span style=color:#f92672>/</span> <span style=color:#ae81ff>2</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> (<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// è¿æ¥ TCP
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        dest_addr.sin_addr.s_addr <span style=color:#f92672>=</span> <span style=color:#a6e22e>inet_addr</span>(RECEIVER_IP);
</span></span><span style=display:flex><span>        dest_addr.sin_family <span style=color:#f92672>=</span> AF_INET;
</span></span><span style=display:flex><span>        dest_addr.sin_port <span style=color:#f92672>=</span> <span style=color:#a6e22e>htons</span>(RECEIVER_PORT);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        sock <span style=color:#f92672>=</span> <span style=color:#a6e22e>socket</span>(AF_INET, SOCK_STREAM, IPPROTO_IP);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (sock <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;Unable to create socket&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>vTaskDelay</span>(<span style=color:#a6e22e>pdMS_TO_TICKS</span>(<span style=color:#ae81ff>2000</span>));
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Connecting to receiver %s:%d ...&#34;</span>, RECEIVER_IP, RECEIVER_PORT);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>connect</span>(sock, (<span style=color:#66d9ef>struct</span> sockaddr <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>dest_addr, <span style=color:#66d9ef>sizeof</span>(dest_addr)) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;Connection failed&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>close</span>(sock);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>vTaskDelay</span>(<span style=color:#a6e22e>pdMS_TO_TICKS</span>(<span style=color:#ae81ff>2000</span>));
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Connected! Start sending audio...&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> (<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// ä»éº¦å…‹é£è¯»å– 32-bit å®¹å™¨æ ·æœ¬
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>esp_err_t</span> r <span style=color:#f92672>=</span> <span style=color:#a6e22e>i2s_channel_read</span>(rx_handle, read_buf, READ_BUF_SIZE, <span style=color:#f92672>&amp;</span>bytes_read, <span style=color:#ae81ff>1000</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (r <span style=color:#f92672>==</span> ESP_OK <span style=color:#f92672>&amp;&amp;</span> bytes_read <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// bytes_read æ˜¯å­—èŠ‚æ•°ï¼Œæ ·æœ¬æ•° = bytes_read / 4
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>int</span> sample_count <span style=color:#f92672>=</span> bytes_read <span style=color:#f92672>/</span> <span style=color:#ae81ff>4</span>;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>int64_t</span> energy <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>int32_t</span> <span style=color:#f92672>*</span>samples32 <span style=color:#f92672>=</span> (<span style=color:#66d9ef>int32_t</span> <span style=color:#f92672>*</span>)read_buf;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// è®¡ç®—èƒ½é‡ï¼ˆä½¿ç”¨ 32-bit åŸæ ·æœ¬ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> sample_count; i<span style=color:#f92672>++</span>)
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// INMP441 é€šå¸¸æ˜¯ 24-bit åœ¨é«˜ä½ï¼Œæ‰€ä»¥ llabs(samples32[i]) åˆç†
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    energy <span style=color:#f92672>+=</span> <span style=color:#a6e22e>llabs</span>((<span style=color:#66d9ef>int64_t</span>)samples32[i]);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (sample_count <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>                    energy <span style=color:#f92672>/=</span> sample_count;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (energy <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>5000</span> <span style=color:#f92672>&amp;&amp;</span> log_counter<span style=color:#f92672>++</span> <span style=color:#f92672>%</span> <span style=color:#ae81ff>10</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34; Detected voice (energy=%lld)&#34;</span>, energy);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// å°† 32-bit æ ·æœ¬é™åˆ° 16-bit PCMï¼ˆå–é«˜ 16 ä½ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>// è¾“å‡ºä¸º little-endian 16-bit
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> sample_count; i<span style=color:#f92672>++</span>)
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>int32_t</span> s32 <span style=color:#f92672>=</span> samples32[i];
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>int16_t</span> s16 <span style=color:#f92672>=</span> (<span style=color:#66d9ef>int16_t</span>)(s32 <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>16</span>); <span style=color:#75715e>// å–é«˜ 16 ä½
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#75715e>// little-endian å†™å…¥
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    out_buf[<span style=color:#ae81ff>2</span> <span style=color:#f92672>*</span> i] <span style=color:#f92672>=</span> (<span style=color:#66d9ef>uint8_t</span>)(s16 <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0xFF</span>);
</span></span><span style=display:flex><span>                    out_buf[<span style=color:#ae81ff>2</span> <span style=color:#f92672>*</span> i <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>] <span style=color:#f92672>=</span> (<span style=color:#66d9ef>uint8_t</span>)((s16 <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>8</span>) <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0xFF</span>);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>int</span> out_bytes <span style=color:#f92672>=</span> sample_count <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>int</span> err <span style=color:#f92672>=</span> <span style=color:#a6e22e>send</span>(sock, out_buf, out_bytes, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (err <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;Send failed (%d), reconnecting...&#34;</span>, err);
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>close</span>(sock);
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// è¶…æ—¶æˆ–è¯»å–å¤±è´¥ï¼ˆå¯èƒ½éº¦å…‹é£/é©±åŠ¨æš‚æ—¶æ²¡æ•°æ®ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>// ä¸è¦é¢‘ç¹æ‰“å°ä»¥å…åˆ·å±
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>app_main</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>nvs_flash_init</span>());
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>wifi_init_sta</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>i2s_rx_init</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>xTaskCreate</span>(audio_send_task, <span style=color:#e6db74>&#34;audio_send_task&#34;</span>, <span style=color:#ae81ff>8192</span>, NULL, <span style=color:#ae81ff>5</span>, NULL);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ä¸»æœºç«¯</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> socket
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> sounddevice <span style=color:#66d9ef>as</span> sd
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> numpy <span style=color:#66d9ef>as</span> np
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> wave
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> time
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ===== é…ç½®éƒ¨åˆ† =====</span>
</span></span><span style=display:flex><span>HOST <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;0.0.0.0&#34;</span>      <span style=color:#75715e># ç›‘å¬æ‰€æœ‰ IPï¼ˆè®© ESP32 å¯ä»¥è¿æ¥è¿›æ¥ï¼‰</span>
</span></span><span style=display:flex><span>PORT <span style=color:#f92672>=</span> <span style=color:#ae81ff>5005</span>           <span style=color:#75715e># å¿…é¡»å’Œ ESP32 å‘é€ç«¯ä¿æŒä¸€è‡´</span>
</span></span><span style=display:flex><span>SAMPLE_RATE <span style=color:#f92672>=</span> <span style=color:#ae81ff>44100</span>   <span style=color:#75715e># é‡‡æ ·ç‡</span>
</span></span><span style=display:flex><span>CHANNELS <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>          <span style=color:#75715e># å£°é“æ•°</span>
</span></span><span style=display:flex><span>CHUNK <span style=color:#f92672>=</span> <span style=color:#ae81ff>1024</span>          <span style=color:#75715e># æ¯æ¬¡æ¥æ”¶çš„å­—èŠ‚æ•°</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ===== åˆå§‹åŒ– =====</span>
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34; Listening on TCP </span><span style=color:#e6db74>{</span>HOST<span style=color:#e6db74>}</span><span style=color:#e6db74>:</span><span style=color:#e6db74>{</span>PORT<span style=color:#e6db74>}</span><span style=color:#e6db74> ...&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>server_socket <span style=color:#f92672>=</span> socket<span style=color:#f92672>.</span>socket(socket<span style=color:#f92672>.</span>AF_INET, socket<span style=color:#f92672>.</span>SOCK_STREAM)
</span></span><span style=display:flex><span>server_socket<span style=color:#f92672>.</span>bind((HOST, PORT))
</span></span><span style=display:flex><span>server_socket<span style=color:#f92672>.</span>listen(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>conn, addr <span style=color:#f92672>=</span> server_socket<span style=color:#f92672>.</span>accept()
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34; Connected from </span><span style=color:#e6db74>{</span>addr<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># æ‰“å¼€éŸ³é¢‘è¾“å‡ºæµ</span>
</span></span><span style=display:flex><span>stream <span style=color:#f92672>=</span> sd<span style=color:#f92672>.</span>OutputStream(
</span></span><span style=display:flex><span>    samplerate<span style=color:#f92672>=</span>SAMPLE_RATE,
</span></span><span style=display:flex><span>    channels<span style=color:#f92672>=</span>CHANNELS,
</span></span><span style=display:flex><span>    dtype<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;int16&#39;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>stream<span style=color:#f92672>.</span>start()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># æ‰“å¼€ WAV æ–‡ä»¶å†™å…¥ï¼ˆ16-bit PCMï¼‰</span>
</span></span><span style=display:flex><span>timestamp <span style=color:#f92672>=</span> time<span style=color:#f92672>.</span>strftime(<span style=color:#e6db74>&#34;%Y%m</span><span style=color:#e6db74>%d</span><span style=color:#e6db74>_%H%M%S&#34;</span>)
</span></span><span style=display:flex><span>wav_filename <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;test_</span><span style=color:#e6db74>{</span>timestamp<span style=color:#e6db74>}</span><span style=color:#e6db74>.wav&#34;</span>
</span></span><span style=display:flex><span>wav_file <span style=color:#f92672>=</span> wave<span style=color:#f92672>.</span>open(wav_filename, <span style=color:#e6db74>&#39;wb&#39;</span>)
</span></span><span style=display:flex><span>wav_file<span style=color:#f92672>.</span>setnchannels(CHANNELS)
</span></span><span style=display:flex><span>wav_file<span style=color:#f92672>.</span>setsampwidth(<span style=color:#ae81ff>2</span>)  <span style=color:#75715e># int16 = 2 å­—èŠ‚</span>
</span></span><span style=display:flex><span>wav_file<span style=color:#f92672>.</span>setframerate(SAMPLE_RATE)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Recording to </span><span style=color:#e6db74>{</span>wav_filename<span style=color:#e6db74>}</span><span style=color:#e6db74> ...&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>packet_count <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>total_bytes <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>        data <span style=color:#f92672>=</span> conn<span style=color:#f92672>.</span>recv(CHUNK)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> data:
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>&#34; Connection closed by sender.&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        packet_count <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        total_bytes <span style=color:#f92672>+=</span> len(data)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> packet_count <span style=color:#f92672>%</span> <span style=color:#ae81ff>50</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>            seconds <span style=color:#f92672>=</span> total_bytes <span style=color:#f92672>/</span> (SAMPLE_RATE <span style=color:#f92672>*</span> CHANNELS <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34; </span><span style=color:#e6db74>{</span>packet_count<span style=color:#e6db74>}</span><span style=color:#e6db74> packets received (</span><span style=color:#e6db74>{</span>total_bytes<span style=color:#e6db74>}</span><span style=color:#e6db74> bytes â‰ˆ </span><span style=color:#e6db74>{</span>seconds<span style=color:#e6db74>:</span><span style=color:#e6db74>.1f</span><span style=color:#e6db74>}</span><span style=color:#e6db74>s audio)&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># æ’­æ”¾éŸ³é¢‘</span>
</span></span><span style=display:flex><span>        samples <span style=color:#f92672>=</span> np<span style=color:#f92672>.</span>frombuffer(data, dtype<span style=color:#f92672>=</span>np<span style=color:#f92672>.</span>int16)
</span></span><span style=display:flex><span>        stream<span style=color:#f92672>.</span>write(samples)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># å†™å…¥ WAV æ–‡ä»¶</span>
</span></span><span style=display:flex><span>        wav_file<span style=color:#f92672>.</span>writeframes(data)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>except</span> <span style=color:#a6e22e>KeyboardInterrupt</span>:
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74> Stopped by user (Ctrl+C).&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>finally</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e># æ”¶å°¾</span>
</span></span><span style=display:flex><span>    conn<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>    server_socket<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>    stream<span style=color:#f92672>.</span>stop()
</span></span><span style=display:flex><span>    stream<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>    wav_file<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34; File saved: </span><span style=color:#e6db74>{</span>wav_filename<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span></code></pre></div><p>è¿è¡Œ</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>python testpy.py                                                                                                                                                                                                                                                                                  
</span></span><span style=display:flex><span> Listening on TCP 0.0.0.0:5005 ...
</span></span><span style=display:flex><span> Connected from <span style=color:#f92672>(</span><span style=color:#e6db74>&#39;192.168.80.41&#39;</span>, 55862<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span> Recording to test_20251031_144232.wav ...
</span></span><span style=display:flex><span> <span style=color:#ae81ff>50</span> packets received <span style=color:#f92672>(</span><span style=color:#ae81ff>36512</span> bytes â‰ˆ 0.4s audio<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span> <span style=color:#ae81ff>100</span> packets received <span style=color:#f92672>(</span><span style=color:#ae81ff>73536</span> bytes â‰ˆ 0.8s audio<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span> <span style=color:#ae81ff>150</span> packets received <span style=color:#f92672>(</span><span style=color:#ae81ff>109536</span> bytes â‰ˆ 1.2s audio<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span> <span style=color:#ae81ff>200</span> packets received <span style=color:#f92672>(</span><span style=color:#ae81ff>145952</span> bytes â‰ˆ 1.7s audio<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span> <span style=color:#ae81ff>250</span> packets received <span style=color:#f92672>(</span><span style=color:#ae81ff>182976</span> bytes â‰ˆ 2.1s audio<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span> <span style=color:#ae81ff>300</span> packets received <span style=color:#f92672>(</span><span style=color:#ae81ff>218976</span> bytes â‰ˆ 2.5s audio<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span> <span style=color:#ae81ff>350</span> packets received <span style=color:#f92672>(</span><span style=color:#ae81ff>255392</span> bytes â‰ˆ 2.9s audio<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span> <span style=color:#ae81ff>400</span> packets received <span style=color:#f92672>(</span><span style=color:#ae81ff>291392</span> bytes â‰ˆ 3.3s audio<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span> <span style=color:#ae81ff>450</span> packets received <span style=color:#f92672>(</span><span style=color:#ae81ff>327392</span> bytes â‰ˆ 3.7s audio<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span> <span style=color:#ae81ff>500</span> packets received <span style=color:#f92672>(</span><span style=color:#ae81ff>364832</span> bytes â‰ˆ 4.1s audio<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span> <span style=color:#ae81ff>550</span> packets received <span style=color:#f92672>(</span><span style=color:#ae81ff>400832</span> bytes â‰ˆ 4.5s audio<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span> <span style=color:#ae81ff>600</span> packets received <span style=color:#f92672>(</span><span style=color:#ae81ff>436832</span> bytes â‰ˆ 5.0s audio<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> Stopped by user <span style=color:#f92672>(</span>Ctrl+C<span style=color:#f92672>)</span>.
</span></span><span style=display:flex><span> File saved: test_20251031_144232.wav
</span></span></code></pre></div><h1 id=è¿wifiæ’­æ”¾å†…ç½‘éŸ³é¢‘>è¿wifiæ’­æ”¾å†…ç½‘éŸ³é¢‘<a hidden class=anchor aria-hidden=true href=#è¿wifiæ’­æ”¾å†…ç½‘éŸ³é¢‘>#</a></h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;string.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdlib.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;freertos/FreeRTOS.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;freertos/task.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;driver/i2s_std.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;driver/gpio.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_wifi.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_event.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_log.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_http_client.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;nvs_flash.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// å¼•è„šå®šä¹‰ï¼ˆä¿æŒä¸å˜ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define INMP_SD GPIO_NUM_13
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define INMP_SCK GPIO_NUM_14
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define INMP_WS GPIO_NUM_27
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define MAX_DIN GPIO_NUM_15
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define MAX_BCLK GPIO_NUM_16
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define MAX_LRC GPIO_NUM_17
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// WiFié…ç½®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define WIFI_SSID &#34;QQ1&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define WIFI_PASS &#34;123123*xx&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// WAVæ–‡ä»¶URL
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define WAV_URL &#34;http:</span><span style=color:#75715e>//192.168.80.77:8005/test_20251031_144232.wav&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// éŸ³é¢‘ç¼“å†²åŒºé…ç½®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define BUF_SIZE 4096
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>uint8_t</span> audio_buf[BUF_SIZE];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// I2Så¥æŸ„
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>i2s_chan_handle_t</span> tx_handle <span style=color:#f92672>=</span> NULL;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// WAVæ–‡ä»¶å¤´ç»“æ„
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> riff[<span style=color:#ae81ff>4</span>];           <span style=color:#75715e>// &#34;RIFF&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>uint32_t</span> file_size;     <span style=color:#75715e>// æ–‡ä»¶å¤§å° - 8
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>char</span> wave[<span style=color:#ae81ff>4</span>];           <span style=color:#75715e>// &#34;WAVE&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>char</span> fmt[<span style=color:#ae81ff>4</span>];            <span style=color:#75715e>// &#34;fmt &#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>uint32_t</span> fmt_size;      <span style=color:#75715e>// æ ¼å¼å—å¤§å°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>uint16_t</span> audio_fmt;     <span style=color:#75715e>// éŸ³é¢‘æ ¼å¼ (1 = PCM)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>uint16_t</span> num_chans;     <span style=color:#75715e>// å£°é“æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>uint32_t</span> sample_rate;   <span style=color:#75715e>// é‡‡æ ·ç‡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>uint32_t</span> byte_rate;     <span style=color:#75715e>// å­—èŠ‚ç‡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>uint16_t</span> block_align;   <span style=color:#75715e>// å—å¯¹é½
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>uint16_t</span> bits_per_samp; <span style=color:#75715e>// æ¯æ ·æœ¬ä½æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>} <span style=color:#66d9ef>wav_header_t</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>TAG <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;wav_player&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>bool</span> wifi_connected <span style=color:#f92672>=</span> false;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// WiFiäº‹ä»¶å¤„ç†
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>event_handler</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>arg, <span style=color:#66d9ef>esp_event_base_t</span> event_base,
</span></span><span style=display:flex><span>                          <span style=color:#66d9ef>int32_t</span> event_id, <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>event_data)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (event_base <span style=color:#f92672>==</span> WIFI_EVENT <span style=color:#f92672>&amp;&amp;</span> event_id <span style=color:#f92672>==</span> WIFI_EVENT_STA_START)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>esp_wifi_connect</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (event_base <span style=color:#f92672>==</span> WIFI_EVENT <span style=color:#f92672>&amp;&amp;</span> event_id <span style=color:#f92672>==</span> WIFI_EVENT_STA_DISCONNECTED)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>esp_wifi_connect</span>();
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;é‡æ–°è¿æ¥WiFi...&#34;</span>);
</span></span><span style=display:flex><span>        wifi_connected <span style=color:#f92672>=</span> false;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (event_base <span style=color:#f92672>==</span> IP_EVENT <span style=color:#f92672>&amp;&amp;</span> event_id <span style=color:#f92672>==</span> IP_EVENT_STA_GOT_IP)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>ip_event_got_ip_t</span> <span style=color:#f92672>*</span>event <span style=color:#f92672>=</span> (<span style=color:#66d9ef>ip_event_got_ip_t</span> <span style=color:#f92672>*</span>)event_data;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;è·å–IPåœ°å€:&#34;</span> IPSTR, <span style=color:#a6e22e>IP2STR</span>(<span style=color:#f92672>&amp;</span>event<span style=color:#f92672>-&gt;</span>ip_info.ip));
</span></span><span style=display:flex><span>        wifi_connected <span style=color:#f92672>=</span> true;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// åˆå§‹åŒ–WiFi
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>wifi_init_sta</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>nvs_flash_init</span>());
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_netif_init</span>());
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_event_loop_create_default</span>());
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_netif_create_default_wifi_sta</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>wifi_init_config_t</span> cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>WIFI_INIT_CONFIG_DEFAULT</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_wifi_init</span>(<span style=color:#f92672>&amp;</span>cfg));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>esp_event_handler_instance_t</span> instance_any_id;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>esp_event_handler_instance_t</span> instance_got_ip;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_event_handler_instance_register</span>(WIFI_EVENT,
</span></span><span style=display:flex><span>                                                        ESP_EVENT_ANY_ID,
</span></span><span style=display:flex><span>                                                        <span style=color:#f92672>&amp;</span>event_handler,
</span></span><span style=display:flex><span>                                                        NULL,
</span></span><span style=display:flex><span>                                                        <span style=color:#f92672>&amp;</span>instance_any_id));
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_event_handler_instance_register</span>(IP_EVENT,
</span></span><span style=display:flex><span>                                                        IP_EVENT_STA_GOT_IP,
</span></span><span style=display:flex><span>                                                        <span style=color:#f92672>&amp;</span>event_handler,
</span></span><span style=display:flex><span>                                                        NULL,
</span></span><span style=display:flex><span>                                                        <span style=color:#f92672>&amp;</span>instance_got_ip));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>wifi_config_t</span> wifi_config <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        .sta <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            .ssid <span style=color:#f92672>=</span> WIFI_SSID,
</span></span><span style=display:flex><span>            .password <span style=color:#f92672>=</span> WIFI_PASS,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_wifi_set_mode</span>(WIFI_MODE_STA));
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_wifi_set_config</span>(WIFI_IF_STA, <span style=color:#f92672>&amp;</span>wifi_config));
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_wifi_start</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;WiFiåˆå§‹åŒ–å®Œæˆ&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// åˆå§‹åŒ–I2Sè¾“å‡ºï¼ˆæ ¹æ®WAVå‚æ•°é…ç½®ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>i2s_init</span>(<span style=color:#66d9ef>uint32_t</span> sample_rate, <span style=color:#66d9ef>uint16_t</span> bits_per_sample, <span style=color:#66d9ef>uint16_t</span> num_channels)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (tx_handle)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>i2s_channel_disable</span>(tx_handle);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>i2s_del_channel</span>(tx_handle);
</span></span><span style=display:flex><span>        tx_handle <span style=color:#f92672>=</span> NULL;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>i2s_chan_config_t</span> chan_cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>I2S_CHANNEL_DEFAULT_CONFIG</span>(I2S_NUM_1, I2S_ROLE_MASTER);
</span></span><span style=display:flex><span>    chan_cfg.dma_frame_num <span style=color:#f92672>=</span> <span style=color:#ae81ff>1024</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>i2s_new_channel</span>(<span style=color:#f92672>&amp;</span>chan_cfg, <span style=color:#f92672>&amp;</span>tx_handle, NULL));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>i2s_data_bit_width_t</span> bit_width;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> (bits_per_sample)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>16</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        bit_width <span style=color:#f92672>=</span> I2S_DATA_BIT_WIDTH_16BIT;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>24</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        bit_width <span style=color:#f92672>=</span> I2S_DATA_BIT_WIDTH_24BIT;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>32</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        bit_width <span style=color:#f92672>=</span> I2S_DATA_BIT_WIDTH_32BIT;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;ä¸æ”¯æŒçš„ä½æ·±åº¦: %d&#34;</span>, bits_per_sample);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>i2s_slot_mode_t</span> slot_mode <span style=color:#f92672>=</span> (num_channels <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>?</span> I2S_SLOT_MODE_MONO : I2S_SLOT_MODE_STEREO;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>i2s_std_config_t</span> std_cfg <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        .clk_cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>I2S_STD_CLK_DEFAULT_CONFIG</span>(sample_rate),
</span></span><span style=display:flex><span>        .slot_cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>I2S_STD_MSB_SLOT_DEFAULT_CONFIG</span>(bit_width, slot_mode),
</span></span><span style=display:flex><span>        .gpio_cfg <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            .mclk <span style=color:#f92672>=</span> I2S_GPIO_UNUSED,
</span></span><span style=display:flex><span>            .din <span style=color:#f92672>=</span> I2S_GPIO_UNUSED,
</span></span><span style=display:flex><span>            .bclk <span style=color:#f92672>=</span> MAX_BCLK,
</span></span><span style=display:flex><span>            .ws <span style=color:#f92672>=</span> MAX_LRC,
</span></span><span style=display:flex><span>            .dout <span style=color:#f92672>=</span> MAX_DIN,
</span></span><span style=display:flex><span>            .invert_flags <span style=color:#f92672>=</span> {.mclk_inv <span style=color:#f92672>=</span> false, .bclk_inv <span style=color:#f92672>=</span> false, .ws_inv <span style=color:#f92672>=</span> false},
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>i2s_channel_init_std_mode</span>(tx_handle, <span style=color:#f92672>&amp;</span>std_cfg));
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>i2s_channel_enable</span>(tx_handle));
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;I2Såˆå§‹åŒ–å®Œæˆ - é‡‡æ ·ç‡: %d Hz, ä½æ·±åº¦: %d, å£°é“æ•°: %d&#34;</span>,
</span></span><span style=display:flex><span>             sample_rate, bits_per_sample, num_channels);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// HTTPè¯·æ±‚å›è°ƒå‡½æ•° - æ’­æ”¾éŸ³é¢‘æ•°æ®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>esp_err_t</span> <span style=color:#a6e22e>http_event_handler</span>(<span style=color:#66d9ef>esp_http_client_event_t</span> <span style=color:#f92672>*</span>evt)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>wav_header_t</span> wav_header;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>bool</span> header_parsed <span style=color:#f92672>=</span> false;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>uint32_t</span> data_read <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>uint32_t</span> data_size <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> (evt<span style=color:#f92672>-&gt;</span>event_id)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> HTTP_EVENT_ON_DATA:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>header_parsed)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// è§£æWAVæ–‡ä»¶å¤´
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>size_t</span> header_needed <span style=color:#f92672>=</span> <span style=color:#66d9ef>sizeof</span>(wav_header) <span style=color:#f92672>-</span> data_read;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>size_t</span> copy_len <span style=color:#f92672>=</span> (evt<span style=color:#f92672>-&gt;</span>data_len <span style=color:#f92672>&lt;</span> header_needed) <span style=color:#f92672>?</span> evt<span style=color:#f92672>-&gt;</span>data_len : header_needed;
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>memcpy</span>(((<span style=color:#66d9ef>uint8_t</span> <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>wav_header) <span style=color:#f92672>+</span> data_read, evt<span style=color:#f92672>-&gt;</span>data, copy_len);
</span></span><span style=display:flex><span>            data_read <span style=color:#f92672>+=</span> copy_len;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (data_read <span style=color:#f92672>&gt;=</span> <span style=color:#66d9ef>sizeof</span>(wav_header))
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// éªŒè¯WAVæ–‡ä»¶
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>memcmp</span>(wav_header.riff, <span style=color:#e6db74>&#34;RIFF&#34;</span>, <span style=color:#ae81ff>4</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>memcmp</span>(wav_header.wave, <span style=color:#e6db74>&#34;WAVE&#34;</span>, <span style=color:#ae81ff>4</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>memcmp</span>(wav_header.fmt, <span style=color:#e6db74>&#34;fmt &#34;</span>, <span style=color:#ae81ff>4</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>                    wav_header.audio_fmt <span style=color:#f92672>!=</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;ä¸æ˜¯æœ‰æ•ˆçš„PCM WAVæ–‡ä»¶&#34;</span>);
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>return</span> ESP_FAIL;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// è®¡ç®—å®é™…éŸ³é¢‘æ•°æ®å¤§å°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                data_size <span style=color:#f92672>=</span> wav_header.file_size <span style=color:#f92672>+</span> <span style=color:#ae81ff>8</span> <span style=color:#f92672>-</span> <span style=color:#66d9ef>sizeof</span>(wav_header);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// æ ¹æ®WAVå‚æ•°åˆå§‹åŒ–I2S
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#a6e22e>i2s_init</span>(wav_header.sample_rate, wav_header.bits_per_samp, wav_header.num_chans);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                header_parsed <span style=color:#f92672>=</span> true;
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;WAVæ–‡ä»¶è§£æå®Œæˆ - éŸ³é¢‘æ•°æ®å¤§å°: %d bytes&#34;</span>, data_size);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// å‘é€å¤´éƒ¨ä¸­åŒ…å«çš„éŸ³é¢‘æ•°æ®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>if</span> (copy_len <span style=color:#f92672>&lt;</span> evt<span style=color:#f92672>-&gt;</span>data_len)
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>size_t</span> audio_data_len <span style=color:#f92672>=</span> evt<span style=color:#f92672>-&gt;</span>data_len <span style=color:#f92672>-</span> copy_len;
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>size_t</span> bytes_written;
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>i2s_channel_write</span>(tx_handle, (<span style=color:#66d9ef>uint8_t</span> <span style=color:#f92672>*</span>)evt<span style=color:#f92672>-&gt;</span>data <span style=color:#f92672>+</span> copy_len,
</span></span><span style=display:flex><span>                                      audio_data_len, <span style=color:#f92672>&amp;</span>bytes_written, portMAX_DELAY);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// å‘é€éŸ³é¢‘æ•°æ®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>size_t</span> bytes_written;
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>i2s_channel_write</span>(tx_handle, evt<span style=color:#f92672>-&gt;</span>data, evt<span style=color:#f92672>-&gt;</span>data_len, <span style=color:#f92672>&amp;</span>bytes_written, portMAX_DELAY);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> HTTP_EVENT_ON_FINISH:
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;WAVæ–‡ä»¶æ’­æ”¾å®Œæˆ&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> HTTP_EVENT_ERROR:
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;HTTPè¯·æ±‚é”™è¯¯&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> ESP_OK;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// æ’­æ”¾WAVæ–‡ä»¶ä»»åŠ¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>wav_play_task</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>pvParameters)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ç­‰å¾…WiFiè¿æ¥
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>while</span> (<span style=color:#f92672>!</span>wifi_connected)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>vTaskDelay</span>(<span style=color:#a6e22e>pdMS_TO_TICKS</span>(<span style=color:#ae81ff>100</span>));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;å¼€å§‹æ’­æ”¾WAVæ–‡ä»¶: %s&#34;</span>, WAV_URL);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// é…ç½®HTTPå®¢æˆ·ç«¯
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>esp_http_client_config_t</span> config <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        .url <span style=color:#f92672>=</span> WAV_URL,
</span></span><span style=display:flex><span>        .event_handler <span style=color:#f92672>=</span> http_event_handler,
</span></span><span style=display:flex><span>        .timeout_ms <span style=color:#f92672>=</span> <span style=color:#ae81ff>10000</span>,
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>esp_http_client_handle_t</span> client <span style=color:#f92672>=</span> <span style=color:#a6e22e>esp_http_client_init</span>(<span style=color:#f92672>&amp;</span>config);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>esp_err_t</span> err <span style=color:#f92672>=</span> <span style=color:#a6e22e>esp_http_client_perform</span>(client);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (err <span style=color:#f92672>!=</span> ESP_OK)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;HTTPè¯·æ±‚å¤±è´¥: %s&#34;</span>, <span style=color:#a6e22e>esp_err_to_name</span>(err));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_http_client_cleanup</span>(client);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ’­æ”¾å®Œæˆåå…³é—­I2S
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (tx_handle)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>i2s_channel_disable</span>(tx_handle);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>i2s_del_channel</span>(tx_handle);
</span></span><span style=display:flex><span>        tx_handle <span style=color:#f92672>=</span> NULL;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;æ’­æ”¾ä»»åŠ¡ç»“æŸ&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>vTaskDelete</span>(NULL);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>app_main</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åˆå§‹åŒ–WiFi
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>wifi_init_sta</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åˆ›å»ºæ’­æ”¾ä»»åŠ¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>xTaskCreate</span>(wav_play_task, <span style=color:#e6db74>&#34;wav_play_task&#34;</span>, <span style=color:#ae81ff>1024</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>8</span>, NULL, <span style=color:#ae81ff>5</span>, NULL);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h1 id=é€šè¿‡udpå¹¿æ’­esp32é€šè®¯>é€šè¿‡UDPå¹¿æ’­ESP32é€šè®¯<a hidden class=anchor aria-hidden=true href=#é€šè¿‡udpå¹¿æ’­esp32é€šè®¯>#</a></h1><p>å‘é€ç«¯</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;string.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;freertos/FreeRTOS.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;freertos/task.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;freertos/event_groups.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_wifi.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_event.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_log.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;nvs_flash.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_netif.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;driver/i2s_std.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;lwip/sockets.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;lwip/netdb.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define WIFI_SSID &#34;RTCT2300&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define WIFI_PASS &#34;123123*zxcvb&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define UDP_PORT 12345
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define BROADCAST_IP &#34;255.255.255.255&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define TAG &#34;AUDIO_TX&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define INMP_SD GPIO_NUM_13
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define INMP_SCK GPIO_NUM_14
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define INMP_WS GPIO_NUM_27
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define SAMPLE_RATE 16000
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define I2S_NUM I2S_NUM_0
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define I2S_BUFFER_SAMPLES 256
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>i2s_chan_handle_t</span> rx_handle <span style=color:#f92672>=</span> NULL;
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> EventGroupHandle_t wifi_event_group;
</span></span><span style=display:flex><span><span style=color:#75715e>#define WIFI_CONNECTED_BIT BIT0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// --- WiFi äº‹ä»¶å›è°ƒ ---
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>wifi_event_handler</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>arg, <span style=color:#66d9ef>esp_event_base_t</span> event_base, <span style=color:#66d9ef>int32_t</span> event_id, <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>event_data)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (event_base <span style=color:#f92672>==</span> WIFI_EVENT <span style=color:#f92672>&amp;&amp;</span> event_id <span style=color:#f92672>==</span> WIFI_EVENT_STA_START)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>esp_wifi_connect</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (event_base <span style=color:#f92672>==</span> WIFI_EVENT <span style=color:#f92672>&amp;&amp;</span> event_id <span style=color:#f92672>==</span> WIFI_EVENT_STA_DISCONNECTED)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGW</span>(TAG, <span style=color:#e6db74>&#34;Wi-Fi disconnected, reconnecting...&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>esp_wifi_connect</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (event_base <span style=color:#f92672>==</span> IP_EVENT <span style=color:#f92672>&amp;&amp;</span> event_id <span style=color:#f92672>==</span> IP_EVENT_STA_GOT_IP)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>xEventGroupSetBits</span>(wifi_event_group, WIFI_CONNECTED_BIT);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>wifi_init_sta</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    wifi_event_group <span style=color:#f92672>=</span> <span style=color:#a6e22e>xEventGroupCreate</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_netif_init</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_event_loop_create_default</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_netif_create_default_wifi_sta</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>wifi_init_config_t</span> cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>WIFI_INIT_CONFIG_DEFAULT</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_wifi_init</span>(<span style=color:#f92672>&amp;</span>cfg);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_event_handler_register</span>(WIFI_EVENT, ESP_EVENT_ANY_ID, <span style=color:#f92672>&amp;</span>wifi_event_handler, NULL);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_event_handler_register</span>(IP_EVENT, IP_EVENT_STA_GOT_IP, <span style=color:#f92672>&amp;</span>wifi_event_handler, NULL);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>wifi_config_t</span> wifi_config <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        .sta <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            .ssid <span style=color:#f92672>=</span> WIFI_SSID,
</span></span><span style=display:flex><span>            .password <span style=color:#f92672>=</span> WIFI_PASS,
</span></span><span style=display:flex><span>            .threshold.authmode <span style=color:#f92672>=</span> WIFI_AUTH_WPA2_PSK,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_wifi_set_mode</span>(WIFI_MODE_STA);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_wifi_set_config</span>(WIFI_IF_STA, <span style=color:#f92672>&amp;</span>wifi_config);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_wifi_start</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Connecting to Wi-Fi...&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>xEventGroupWaitBits</span>(wifi_event_group, WIFI_CONNECTED_BIT, pdFALSE, pdTRUE, portMAX_DELAY);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Wi-Fi connected!&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>i2s_init</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>i2s_chan_config_t</span> chan_cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>I2S_CHANNEL_DEFAULT_CONFIG</span>(I2S_NUM, I2S_ROLE_MASTER);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>i2s_new_channel</span>(<span style=color:#f92672>&amp;</span>chan_cfg, NULL, <span style=color:#f92672>&amp;</span>rx_handle);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>i2s_std_config_t</span> std_cfg <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        .clk_cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>I2S_STD_CLK_DEFAULT_CONFIG</span>(SAMPLE_RATE),
</span></span><span style=display:flex><span>        .slot_cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>I2S_STD_PHILIPS_SLOT_DEFAULT_CONFIG</span>(I2S_DATA_BIT_WIDTH_32BIT, I2S_SLOT_MODE_MONO),
</span></span><span style=display:flex><span>        .gpio_cfg <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            .mclk <span style=color:#f92672>=</span> I2S_GPIO_UNUSED,
</span></span><span style=display:flex><span>            .bclk <span style=color:#f92672>=</span> INMP_SCK,
</span></span><span style=display:flex><span>            .ws <span style=color:#f92672>=</span> INMP_WS,
</span></span><span style=display:flex><span>            .dout <span style=color:#f92672>=</span> I2S_GPIO_UNUSED,
</span></span><span style=display:flex><span>            .din <span style=color:#f92672>=</span> INMP_SD,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>i2s_channel_init_std_mode</span>(rx_handle, <span style=color:#f92672>&amp;</span>std_cfg);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>i2s_channel_enable</span>(rx_handle);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>audio_sender_task</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>pvParameters)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> sockaddr_in dest_addr;
</span></span><span style=display:flex><span>    dest_addr.sin_addr.s_addr <span style=color:#f92672>=</span> <span style=color:#a6e22e>inet_addr</span>(BROADCAST_IP);
</span></span><span style=display:flex><span>    dest_addr.sin_family <span style=color:#f92672>=</span> AF_INET;
</span></span><span style=display:flex><span>    dest_addr.sin_port <span style=color:#f92672>=</span> <span style=color:#a6e22e>htons</span>(UDP_PORT);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> sock <span style=color:#f92672>=</span> <span style=color:#a6e22e>socket</span>(AF_INET, SOCK_DGRAM, IPPROTO_IP);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> broadcastEnable <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>setsockopt</span>(sock, SOL_SOCKET, SO_BROADCAST, <span style=color:#f92672>&amp;</span>broadcastEnable, <span style=color:#66d9ef>sizeof</span>(broadcastEnable));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;UDP socket ready, start sending audio...&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int32_t</span> i2s_raw[I2S_BUFFER_SAMPLES];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int16_t</span> pcm16[I2S_BUFFER_SAMPLES];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>size_t</span> bytes_read;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> (<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>esp_err_t</span> res <span style=color:#f92672>=</span> <span style=color:#a6e22e>i2s_channel_read</span>(rx_handle, i2s_raw, <span style=color:#66d9ef>sizeof</span>(i2s_raw), <span style=color:#f92672>&amp;</span>bytes_read, portMAX_DELAY);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (res <span style=color:#f92672>==</span> ESP_OK <span style=color:#f92672>&amp;&amp;</span> bytes_read <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int</span> samples <span style=color:#f92672>=</span> bytes_read <span style=color:#f92672>/</span> <span style=color:#ae81ff>4</span>; <span style=color:#75715e>// æ¯ä¸ªé‡‡æ ·32bit
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> samples; i<span style=color:#f92672>++</span>)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// INMP441 è¾“å‡ºå·¦å¯¹é½ 24bitï¼Œæœ‰æ•ˆä½åœ¨é«˜ 24 ä½
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>int32_t</span> sample <span style=color:#f92672>=</span> (i2s_raw[i] <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>8</span>);
</span></span><span style=display:flex><span>                pcm16[i] <span style=color:#f92672>=</span> (<span style=color:#66d9ef>int16_t</span>)(sample <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>8</span>); <span style=color:#75715e>// å‹ç¼©æˆ 16bit PCM
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>sendto</span>(sock, pcm16, samples <span style=color:#f92672>*</span> <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>int16_t</span>), <span style=color:#ae81ff>0</span>, (<span style=color:#66d9ef>struct</span> sockaddr <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>dest_addr, <span style=color:#66d9ef>sizeof</span>(dest_addr));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>close</span>(sock);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>vTaskDelete</span>(NULL);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>app_main</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nvs_flash_init</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>wifi_init_sta</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>i2s_init</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>xTaskCreate</span>(audio_sender_task, <span style=color:#e6db74>&#34;audio_sender_task&#34;</span>, <span style=color:#ae81ff>4096</span>, NULL, <span style=color:#ae81ff>5</span>, NULL);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æ¥æ”¶ç«¯</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;string.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;freertos/FreeRTOS.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;freertos/task.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;freertos/event_groups.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_wifi.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_event.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_log.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;nvs_flash.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_netif.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;driver/i2s_std.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;lwip/sockets.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;lwip/netdb.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define WIFI_SSID &#34;RTCT2300&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define WIFI_PASS &#34;123123*zxcvb&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define UDP_PORT 12345
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define TAG &#34;AUDIO_RX&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define MAX_DOUT GPIO_NUM_15
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define MAX_BCLK GPIO_NUM_16
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define MAX_LRC GPIO_NUM_17
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define SAMPLE_RATE 16000
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define I2S_NUM I2S_NUM_1
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define I2S_BUFFER_SAMPLES 256
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>i2s_chan_handle_t</span> tx_handle <span style=color:#f92672>=</span> NULL;
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> EventGroupHandle_t wifi_event_group;
</span></span><span style=display:flex><span><span style=color:#75715e>#define WIFI_CONNECTED_BIT BIT0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>wifi_event_handler</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>arg, <span style=color:#66d9ef>esp_event_base_t</span> event_base, <span style=color:#66d9ef>int32_t</span> event_id, <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>event_data)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (event_base <span style=color:#f92672>==</span> WIFI_EVENT <span style=color:#f92672>&amp;&amp;</span> event_id <span style=color:#f92672>==</span> WIFI_EVENT_STA_START)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>esp_wifi_connect</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (event_base <span style=color:#f92672>==</span> WIFI_EVENT <span style=color:#f92672>&amp;&amp;</span> event_id <span style=color:#f92672>==</span> WIFI_EVENT_STA_DISCONNECTED)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGW</span>(TAG, <span style=color:#e6db74>&#34;Wi-Fi disconnected, reconnecting...&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>esp_wifi_connect</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (event_base <span style=color:#f92672>==</span> IP_EVENT <span style=color:#f92672>&amp;&amp;</span> event_id <span style=color:#f92672>==</span> IP_EVENT_STA_GOT_IP)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>xEventGroupSetBits</span>(wifi_event_group, WIFI_CONNECTED_BIT);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>wifi_init_sta</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    wifi_event_group <span style=color:#f92672>=</span> <span style=color:#a6e22e>xEventGroupCreate</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_netif_init</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_event_loop_create_default</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_netif_create_default_wifi_sta</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>wifi_init_config_t</span> cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>WIFI_INIT_CONFIG_DEFAULT</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_wifi_init</span>(<span style=color:#f92672>&amp;</span>cfg);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_event_handler_register</span>(WIFI_EVENT, ESP_EVENT_ANY_ID, <span style=color:#f92672>&amp;</span>wifi_event_handler, NULL);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_event_handler_register</span>(IP_EVENT, IP_EVENT_STA_GOT_IP, <span style=color:#f92672>&amp;</span>wifi_event_handler, NULL);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>wifi_config_t</span> wifi_config <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        .sta <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            .ssid <span style=color:#f92672>=</span> WIFI_SSID,
</span></span><span style=display:flex><span>            .password <span style=color:#f92672>=</span> WIFI_PASS,
</span></span><span style=display:flex><span>            .threshold.authmode <span style=color:#f92672>=</span> WIFI_AUTH_WPA2_PSK,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_wifi_set_mode</span>(WIFI_MODE_STA);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_wifi_set_config</span>(WIFI_IF_STA, <span style=color:#f92672>&amp;</span>wifi_config);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_wifi_start</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Connecting to Wi-Fi...&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>xEventGroupWaitBits</span>(wifi_event_group, WIFI_CONNECTED_BIT, pdFALSE, pdTRUE, portMAX_DELAY);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Wi-Fi connected!&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>i2s_init</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>i2s_chan_config_t</span> chan_cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>I2S_CHANNEL_DEFAULT_CONFIG</span>(I2S_NUM, I2S_ROLE_MASTER);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>i2s_new_channel</span>(<span style=color:#f92672>&amp;</span>chan_cfg, <span style=color:#f92672>&amp;</span>tx_handle, NULL);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>i2s_std_config_t</span> std_cfg <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        .clk_cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>I2S_STD_CLK_DEFAULT_CONFIG</span>(SAMPLE_RATE),
</span></span><span style=display:flex><span>        .slot_cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>I2S_STD_PHILIPS_SLOT_DEFAULT_CONFIG</span>(I2S_DATA_BIT_WIDTH_16BIT, I2S_SLOT_MODE_MONO),
</span></span><span style=display:flex><span>        .gpio_cfg <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            .mclk <span style=color:#f92672>=</span> I2S_GPIO_UNUSED,
</span></span><span style=display:flex><span>            .bclk <span style=color:#f92672>=</span> MAX_BCLK,
</span></span><span style=display:flex><span>            .ws <span style=color:#f92672>=</span> MAX_LRC,
</span></span><span style=display:flex><span>            .dout <span style=color:#f92672>=</span> MAX_DOUT,
</span></span><span style=display:flex><span>            .din <span style=color:#f92672>=</span> I2S_GPIO_UNUSED,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>i2s_channel_init_std_mode</span>(tx_handle, <span style=color:#f92672>&amp;</span>std_cfg);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>i2s_channel_enable</span>(tx_handle);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>audio_receiver_task</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>pvParameters)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> sockaddr_in local_addr;
</span></span><span style=display:flex><span>    local_addr.sin_addr.s_addr <span style=color:#f92672>=</span> <span style=color:#a6e22e>htonl</span>(INADDR_ANY);
</span></span><span style=display:flex><span>    local_addr.sin_family <span style=color:#f92672>=</span> AF_INET;
</span></span><span style=display:flex><span>    local_addr.sin_port <span style=color:#f92672>=</span> <span style=color:#a6e22e>htons</span>(UDP_PORT);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> sock <span style=color:#f92672>=</span> <span style=color:#a6e22e>socket</span>(AF_INET, SOCK_DGRAM, IPPROTO_IP);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bind</span>(sock, (<span style=color:#66d9ef>struct</span> sockaddr <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>local_addr, <span style=color:#66d9ef>sizeof</span>(local_addr));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;UDP ready, waiting for audio...&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int16_t</span> pcm16[I2S_BUFFER_SAMPLES];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> (<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> len <span style=color:#f92672>=</span> <span style=color:#a6e22e>recvfrom</span>(sock, pcm16, <span style=color:#66d9ef>sizeof</span>(pcm16), <span style=color:#ae81ff>0</span>, NULL, NULL);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (len <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>size_t</span> bytes_written;
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>i2s_channel_write</span>(tx_handle, pcm16, len, <span style=color:#f92672>&amp;</span>bytes_written, portMAX_DELAY);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>close</span>(sock);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>vTaskDelete</span>(NULL);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>app_main</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nvs_flash_init</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>wifi_init_sta</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>i2s_init</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>xTaskCreate</span>(audio_receiver_task, <span style=color:#e6db74>&#34;audio_receiver_task&#34;</span>, <span style=color:#ae81ff>4096</span>, NULL, <span style=color:#ae81ff>5</span>, NULL);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è¾“å…¥ï¼š
16-bit PCM å•å£°é“è¾“å‡º
é‡‡æ ·ç‡ 16 kHz
è¾“å‡ºï¼š
æ•°æ®æ ¼å¼ä¸º 16-bit PCMã€å•å£°é“ã€é‡‡æ ·ç‡ 16kHzï¼›
æ¯æ¬¡åŒ…å¤§å° 512 å­—èŠ‚å·¦å³ï¼ˆ256 é‡‡æ ·ï¼‰</p><h1 id=python-server-esp32udp>python server esp32udp<a hidden class=anchor aria-hidden=true href=#python-server-esp32udp>#</a></h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># multiroom_server.py</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> threading
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> socket
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> time
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> json
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> flask <span style=color:#f92672>import</span> Flask, jsonify, request, render_template_string
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>AUDIO_PORT <span style=color:#f92672>=</span> <span style=color:#ae81ff>12345</span>
</span></span><span style=display:flex><span>CMD_PORT <span style=color:#f92672>=</span> <span style=color:#ae81ff>12346</span>
</span></span><span style=display:flex><span>HEARTBEAT_PORT <span style=color:#f92672>=</span> <span style=color:#ae81ff>12347</span>
</span></span><span style=display:flex><span>HEARTBEAT_TIMEOUT <span style=color:#f92672>=</span> <span style=color:#ae81ff>10.0</span>  <span style=color:#75715e># seconds to consider device offline</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app <span style=color:#f92672>=</span> Flask(__name__)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># device dict: ip -&gt; {id, ip, last_seen, audio_port}</span>
</span></span><span style=display:flex><span>devices <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>devices_lock <span style=color:#f92672>=</span> threading<span style=color:#f92672>.</span>Lock()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Simple HTML UI (very minimal)</span>
</span></span><span style=display:flex><span>INDEX_HTML <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;!doctype html&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;html&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;head&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &lt;meta charset=&#34;utf-8&#34;/&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &lt;title&gt;Multiroom Control&lt;/title&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;/head&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;body&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &lt;h2&gt;Multiroom æ§åˆ¶é¢æ¿&lt;/h2&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &lt;div&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;button onclick=&#34;refresh()&#34;&gt;åˆ·æ–°è®¾å¤‡&lt;/button&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;button onclick=&#34;startCall()&#34;&gt;å¼€å§‹äº’é€šï¼ˆé€‰ä¸­ä¸¤ä¸ªï¼‰&lt;/button&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;button onclick=&#34;stopCall()&#34;&gt;åœæ­¢æ‰€æœ‰é€šè¯&lt;/button&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &lt;/div&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &lt;h3&gt;è®¾å¤‡åˆ—è¡¨&lt;/h3&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &lt;table border=&#34;1&#34; id=&#34;devtable&#34;&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;thead&gt;&lt;tr&gt;&lt;th&gt;Select&lt;/th&gt;&lt;th&gt;IP&lt;/th&gt;&lt;th&gt;ID&lt;/th&gt;&lt;th&gt;Last seen&lt;/th&gt;&lt;th&gt;Audio port&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;tbody&gt;&lt;/tbody&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &lt;/table&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;script&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>async function refresh(){
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  const r = await fetch(&#39;/devices&#39;);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  const j = await r.json();
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  const tbody = document.querySelector(&#39;#devtable tbody&#39;);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  tbody.innerHTML = &#39;&#39;;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  j.forEach(d =&gt; {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    const tr = document.createElement(&#39;tr&#39;);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    tr.innerHTML = `&lt;td&gt;&lt;input type=&#34;checkbox&#34; data-ip=&#34;$</span><span style=color:#e6db74>{d.ip}</span><span style=color:#e6db74>&#34;&gt;&lt;/td&gt;&lt;td&gt;$</span><span style=color:#e6db74>{d.ip}</span><span style=color:#e6db74>&lt;/td&gt;&lt;td&gt;$</span><span style=color:#e6db74>{d.id}</span><span style=color:#e6db74>&lt;/td&gt;&lt;td&gt;$</span><span style=color:#e6db74>{d.last_seen}</span><span style=color:#e6db74>&lt;/td&gt;&lt;td&gt;$</span><span style=color:#e6db74>{d.audio_port}</span><span style=color:#e6db74>&lt;/td&gt;`;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    tbody.appendChild(tr);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  });
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>async function startCall(){
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  const checked = [...document.querySelectorAll(&#39;#devtable tbody input[type=checkbox]:checked&#39;)].map(i=&gt;i.dataset.ip);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  if(checked.length !== 2){ alert(&#39;è¯·é€‰æ‹©ä¸¤ä¸ªè®¾å¤‡ï¼ˆä¸¤ä¸ªæˆ¿é—´ï¼‰è¿›è¡Œäº’é€š&#39;); return; }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  const [a,b] = checked;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  const resp = await fetch(&#39;/start_call&#39;, {method:&#39;POST&#39;, headers:{&#39;Content-Type&#39;:&#39;application/json&#39;}, body: JSON.stringify({a_ip:a, b_ip:b})});
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  const j = await resp.json();
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  alert(JSON.stringify(j));
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  refresh();
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>async function stopCall(){
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  const resp = await fetch(&#39;/stop_all&#39;, {method:&#39;POST&#39;});
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  const j = await resp.json();
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  alert(JSON.stringify(j));
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  refresh();
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>refresh();
</span></span></span><span style=display:flex><span><span style=color:#e6db74>setInterval(refresh, 5000);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;/script&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;/body&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;/html&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@app.route</span>(<span style=color:#e6db74>&#39;/&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>index</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> render_template_string(INDEX_HTML)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@app.route</span>(<span style=color:#e6db74>&#39;/devices&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_devices</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> devices_lock:
</span></span><span style=display:flex><span>        now <span style=color:#f92672>=</span> time<span style=color:#f92672>.</span>time()
</span></span><span style=display:flex><span>        out <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> ip, info <span style=color:#f92672>in</span> list(devices<span style=color:#f92672>.</span>items()):
</span></span><span style=display:flex><span>            out<span style=color:#f92672>.</span>append({
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;ip&#39;</span>: ip,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;id&#39;</span>: info<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;id&#39;</span>),
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;audio_port&#39;</span>: info<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;audio_port&#39;</span>, AUDIO_PORT),
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;last_seen&#39;</span>: time<span style=color:#f92672>.</span>strftime(<span style=color:#e6db74>&#34;%Y-%m-</span><span style=color:#e6db74>%d</span><span style=color:#e6db74> %H:%M:%S&#34;</span>, time<span style=color:#f92672>.</span>localtime(info[<span style=color:#e6db74>&#39;last_seen&#39;</span>]))
</span></span><span style=display:flex><span>            })
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> jsonify(out)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>send_cmd</span>(ip, cmd_text):
</span></span><span style=display:flex><span>    sock <span style=color:#f92672>=</span> socket<span style=color:#f92672>.</span>socket(socket<span style=color:#f92672>.</span>AF_INET, socket<span style=color:#f92672>.</span>SOCK_DGRAM)
</span></span><span style=display:flex><span>    sock<span style=color:#f92672>.</span>settimeout(<span style=color:#ae81ff>1.0</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        sock<span style=color:#f92672>.</span>sendto(cmd_text<span style=color:#f92672>.</span>encode(<span style=color:#e6db74>&#39;utf-8&#39;</span>), (ip, CMD_PORT))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#34;send_cmd err:&#34;</span>, e)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>finally</span>:
</span></span><span style=display:flex><span>        sock<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@app.route</span>(<span style=color:#e6db74>&#39;/start_call&#39;</span>, methods<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#39;POST&#39;</span>])
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>start_call</span>():
</span></span><span style=display:flex><span>    data <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span>get_json()
</span></span><span style=display:flex><span>    a_ip <span style=color:#f92672>=</span> data[<span style=color:#e6db74>&#39;a_ip&#39;</span>]
</span></span><span style=display:flex><span>    b_ip <span style=color:#f92672>=</span> data[<span style=color:#e6db74>&#39;b_ip&#39;</span>]
</span></span><span style=display:flex><span>    <span style=color:#75715e># å°† A æŒ‡å‘ Bï¼ŒB æŒ‡å‘ A</span>
</span></span><span style=display:flex><span>    send_cmd(a_ip, <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;START_CALL:</span><span style=color:#e6db74>{</span>b_ip<span style=color:#e6db74>}</span><span style=color:#e6db74>:</span><span style=color:#e6db74>{</span>AUDIO_PORT<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>    send_cmd(b_ip, <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;START_CALL:</span><span style=color:#e6db74>{</span>a_ip<span style=color:#e6db74>}</span><span style=color:#e6db74>:</span><span style=color:#e6db74>{</span>AUDIO_PORT<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> jsonify({<span style=color:#e6db74>&#39;status&#39;</span>:<span style=color:#e6db74>&#39;ok&#39;</span>,<span style=color:#e6db74>&#39;msg&#39;</span>:<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{</span>a_ip<span style=color:#e6db74>}</span><span style=color:#e6db74> &lt;-&gt; </span><span style=color:#e6db74>{</span>b_ip<span style=color:#e6db74>}</span><span style=color:#e6db74> started&#39;</span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@app.route</span>(<span style=color:#e6db74>&#39;/stop_all&#39;</span>, methods<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#39;POST&#39;</span>])
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>stop_all</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> devices_lock:
</span></span><span style=display:flex><span>        ips <span style=color:#f92672>=</span> list(devices<span style=color:#f92672>.</span>keys())
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> ip <span style=color:#f92672>in</span> ips:
</span></span><span style=display:flex><span>        send_cmd(ip, <span style=color:#e6db74>&#34;STOP_CALL&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> jsonify({<span style=color:#e6db74>&#39;status&#39;</span>:<span style=color:#e6db74>&#39;ok&#39;</span>,<span style=color:#e6db74>&#39;stopped&#39;</span>:ips})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Heartbeat listener thread</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>heartbeat_listener</span>():
</span></span><span style=display:flex><span>    sock <span style=color:#f92672>=</span> socket<span style=color:#f92672>.</span>socket(socket<span style=color:#f92672>.</span>AF_INET, socket<span style=color:#f92672>.</span>SOCK_DGRAM)
</span></span><span style=display:flex><span>    sock<span style=color:#f92672>.</span>setsockopt(socket<span style=color:#f92672>.</span>SOL_SOCKET, socket<span style=color:#f92672>.</span>SO_REUSEADDR, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    sock<span style=color:#f92672>.</span>bind((<span style=color:#e6db74>&#39;&#39;</span>, HEARTBEAT_PORT))
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;Heartbeat listener running on port&#34;</span>, HEARTBEAT_PORT)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>            data, addr <span style=color:#f92672>=</span> sock<span style=color:#f92672>.</span>recvfrom(<span style=color:#ae81ff>1024</span>)
</span></span><span style=display:flex><span>            txt <span style=color:#f92672>=</span> data<span style=color:#f92672>.</span>decode(<span style=color:#e6db74>&#39;utf-8&#39;</span>, errors<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;ignore&#39;</span>)
</span></span><span style=display:flex><span>            ip <span style=color:#f92672>=</span> addr[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>            <span style=color:#75715e># æœŸæœ› heartbeat æ ¼å¼ JSON æˆ– &#34;heartbeat:&lt;id&gt;:&lt;audio_port&gt;&#34;</span>
</span></span><span style=display:flex><span>            parsed <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>                parsed <span style=color:#f92672>=</span> json<span style=color:#f92672>.</span>loads(txt)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>except</span>:
</span></span><span style=display:flex><span>                parts <span style=color:#f92672>=</span> txt<span style=color:#f92672>.</span>strip()<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#39;:&#39;</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> parts[<span style=color:#ae81ff>0</span>]<span style=color:#f92672>.</span>lower() <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;heartbeat&#39;</span>:
</span></span><span style=display:flex><span>                    parsed <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#39;type&#39;</span>:<span style=color:#e6db74>&#39;heartbeat&#39;</span>, <span style=color:#e6db74>&#39;id&#39;</span>: parts[<span style=color:#ae81ff>1</span>] <span style=color:#66d9ef>if</span> len(parts)<span style=color:#f92672>&gt;</span><span style=color:#ae81ff>1</span> <span style=color:#66d9ef>else</span> ip, <span style=color:#e6db74>&#39;audio_port&#39;</span>: int(parts[<span style=color:#ae81ff>2</span>]) <span style=color:#66d9ef>if</span> len(parts)<span style=color:#f92672>&gt;</span><span style=color:#ae81ff>2</span> <span style=color:#66d9ef>else</span> AUDIO_PORT}
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> parsed<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;type&#39;</span>)<span style=color:#f92672>==</span><span style=color:#e6db74>&#39;heartbeat&#39;</span> <span style=color:#f92672>or</span> <span style=color:#e6db74>&#39;id&#39;</span> <span style=color:#f92672>in</span> parsed:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>with</span> devices_lock:
</span></span><span style=display:flex><span>                    devices[ip] <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;id&#39;</span>: parsed<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;id&#39;</span>, ip),
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;audio_port&#39;</span>: parsed<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;audio_port&#39;</span>, AUDIO_PORT),
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;last_seen&#39;</span>: time<span style=color:#f92672>.</span>time()
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>&#34;heartbeat_listener error:&#34;</span>, e)
</span></span><span style=display:flex><span>        <span style=color:#75715e># cleanup old devices</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>with</span> devices_lock:
</span></span><span style=display:flex><span>            now <span style=color:#f92672>=</span> time<span style=color:#f92672>.</span>time()
</span></span><span style=display:flex><span>            todel <span style=color:#f92672>=</span> [k <span style=color:#66d9ef>for</span> k,v <span style=color:#f92672>in</span> devices<span style=color:#f92672>.</span>items() <span style=color:#66d9ef>if</span> now <span style=color:#f92672>-</span> v[<span style=color:#e6db74>&#39;last_seen&#39;</span>] <span style=color:#f92672>&gt;</span> HEARTBEAT_TIMEOUT]
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> k <span style=color:#f92672>in</span> todel:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>del</span> devices[k]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    t <span style=color:#f92672>=</span> threading<span style=color:#f92672>.</span>Thread(target<span style=color:#f92672>=</span>heartbeat_listener, daemon<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>    t<span style=color:#f92672>.</span>start()
</span></span><span style=display:flex><span>    app<span style=color:#f92672>.</span>run(host<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;0.0.0.0&#39;</span>, port<span style=color:#f92672>=</span><span style=color:#ae81ff>5000</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pip install flask 
</span></span><span style=display:flex><span>pip install flask_socketio
</span></span><span style=display:flex><span>é«˜æ€§èƒ½å¼‚æ­¥æœåŠ¡å™¨
</span></span><span style=display:flex><span>pip install eventlet   
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// main.c (ä¿®æ­£ç‰ˆ)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;string.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdbool.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;freertos/FreeRTOS.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;freertos/task.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;freertos/event_groups.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_wifi.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_event.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_log.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;nvs_flash.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_netif.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;driver/i2s_std.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;lwip/sockets.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;lwip/netdb.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_system.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_mac.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;esp_err.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define WIFI_SSID &#34;RTCT2300&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define WIFI_PASS &#34;123123*zx&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define TAG &#34;ESP32_ROOM&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define UDP_AUDIO_PORT 12345
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define UDP_CMD_PORT 12346
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define UDP_HEARTBEAT_PORT 12347
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define BROADCAST_IP &#34;255.255.255.255&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define SAMPLE_RATE 16000
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define I2S_BUFFER_SAMPLES 256
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// åˆ†åˆ«ä½¿ç”¨ä¸åŒçš„ I2S å¤–è®¾å·ï¼Œé¿å…å†²çª
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define I2S_RX_NUM I2S_NUM_0 </span><span style=color:#75715e>// microphone input
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define I2S_TX_NUM I2S_NUM_1 </span><span style=color:#75715e>// speaker output
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// I2S pins (æŒ‰ä½ åŸæ¥æ¥çº¿)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define INMP_SD GPIO_NUM_13
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define INMP_SCK GPIO_NUM_14
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define INMP_WS GPIO_NUM_27
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define MAX_DOUT GPIO_NUM_15
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define MAX_BCLK GPIO_NUM_16
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define MAX_LRC GPIO_NUM_17
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>i2s_chan_handle_t</span> rx_handle <span style=color:#f92672>=</span> NULL;
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>i2s_chan_handle_t</span> tx_handle <span style=color:#f92672>=</span> NULL;
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> EventGroupHandle_t wifi_event_group;
</span></span><span style=display:flex><span><span style=color:#75715e>#define WIFI_CONNECTED_BIT BIT0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>bool</span> in_call <span style=color:#f92672>=</span> false;
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>char</span> target_ip[<span style=color:#ae81ff>64</span>] <span style=color:#f92672>=</span> {<span style=color:#ae81ff>0</span>};
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> target_port <span style=color:#f92672>=</span> UDP_AUDIO_PORT;
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>char</span> device_id[<span style=color:#ae81ff>32</span>] <span style=color:#f92672>=</span> {<span style=color:#ae81ff>0</span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>wifi_event_handler</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>arg, <span style=color:#66d9ef>esp_event_base_t</span> event_base, <span style=color:#66d9ef>int32_t</span> event_id, <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>event_data)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (event_base <span style=color:#f92672>==</span> WIFI_EVENT <span style=color:#f92672>&amp;&amp;</span> event_id <span style=color:#f92672>==</span> WIFI_EVENT_STA_START)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>esp_wifi_connect</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (event_base <span style=color:#f92672>==</span> WIFI_EVENT <span style=color:#f92672>&amp;&amp;</span> event_id <span style=color:#f92672>==</span> WIFI_EVENT_STA_DISCONNECTED)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGW</span>(TAG, <span style=color:#e6db74>&#34;Wi-Fi disconnected, reconnecting...&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>esp_wifi_connect</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (event_base <span style=color:#f92672>==</span> IP_EVENT <span style=color:#f92672>&amp;&amp;</span> event_id <span style=color:#f92672>==</span> IP_EVENT_STA_GOT_IP)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>xEventGroupSetBits</span>(wifi_event_group, WIFI_CONNECTED_BIT);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>wifi_init_sta</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    wifi_event_group <span style=color:#f92672>=</span> <span style=color:#a6e22e>xEventGroupCreate</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_netif_init</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_event_loop_create_default</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_netif_create_default_wifi_sta</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>wifi_init_config_t</span> cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>WIFI_INIT_CONFIG_DEFAULT</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_wifi_init</span>(<span style=color:#f92672>&amp;</span>cfg));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_event_handler_register</span>(WIFI_EVENT, ESP_EVENT_ANY_ID, <span style=color:#f92672>&amp;</span>wifi_event_handler, NULL);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_event_handler_register</span>(IP_EVENT, IP_EVENT_STA_GOT_IP, <span style=color:#f92672>&amp;</span>wifi_event_handler, NULL);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>wifi_config_t</span> wifi_config <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        .sta <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            .ssid <span style=color:#f92672>=</span> WIFI_SSID,
</span></span><span style=display:flex><span>            .password <span style=color:#f92672>=</span> WIFI_PASS,
</span></span><span style=display:flex><span>            .threshold.authmode <span style=color:#f92672>=</span> WIFI_AUTH_WPA2_PSK,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_wifi_set_mode</span>(WIFI_MODE_STA));
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_wifi_set_config</span>(WIFI_IF_STA, <span style=color:#f92672>&amp;</span>wifi_config));
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>esp_wifi_start</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Connecting to Wi-Fi...&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>xEventGroupWaitBits</span>(wifi_event_group, WIFI_CONNECTED_BIT, pdFALSE, pdTRUE, portMAX_DELAY);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Wi-Fi connected!&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>i2s_init_master_rx</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>i2s_chan_config_t</span> chan_cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>I2S_CHANNEL_DEFAULT_CONFIG</span>(I2S_RX_NUM, I2S_ROLE_MASTER);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>esp_err_t</span> err <span style=color:#f92672>=</span> <span style=color:#a6e22e>i2s_new_channel</span>(<span style=color:#f92672>&amp;</span>chan_cfg, NULL, <span style=color:#f92672>&amp;</span>rx_handle);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (err <span style=color:#f92672>!=</span> ESP_OK)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;i2s_new_channel rx failed: %s&#34;</span>, <span style=color:#a6e22e>esp_err_to_name</span>(err));
</span></span><span style=display:flex><span>        rx_handle <span style=color:#f92672>=</span> NULL;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>i2s_std_config_t</span> std_cfg <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        .clk_cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>I2S_STD_CLK_DEFAULT_CONFIG</span>(SAMPLE_RATE),
</span></span><span style=display:flex><span>        .slot_cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>I2S_STD_PHILIPS_SLOT_DEFAULT_CONFIG</span>(I2S_DATA_BIT_WIDTH_32BIT, I2S_SLOT_MODE_MONO),
</span></span><span style=display:flex><span>        .gpio_cfg <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            .mclk <span style=color:#f92672>=</span> I2S_GPIO_UNUSED,
</span></span><span style=display:flex><span>            .bclk <span style=color:#f92672>=</span> INMP_SCK,
</span></span><span style=display:flex><span>            .ws <span style=color:#f92672>=</span> INMP_WS,
</span></span><span style=display:flex><span>            .dout <span style=color:#f92672>=</span> I2S_GPIO_UNUSED,
</span></span><span style=display:flex><span>            .din <span style=color:#f92672>=</span> INMP_SD,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    err <span style=color:#f92672>=</span> <span style=color:#a6e22e>i2s_channel_init_std_mode</span>(rx_handle, <span style=color:#f92672>&amp;</span>std_cfg);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (err <span style=color:#f92672>!=</span> ESP_OK)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;i2s_channel_init_std_mode rx failed: %s&#34;</span>, <span style=color:#a6e22e>esp_err_to_name</span>(err));
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>i2s_del_channel</span>(rx_handle);
</span></span><span style=display:flex><span>        rx_handle <span style=color:#f92672>=</span> NULL;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    err <span style=color:#f92672>=</span> <span style=color:#a6e22e>i2s_channel_enable</span>(rx_handle);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (err <span style=color:#f92672>!=</span> ESP_OK)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;i2s_channel_enable rx failed: %s&#34;</span>, <span style=color:#a6e22e>esp_err_to_name</span>(err));
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>i2s_del_channel</span>(rx_handle);
</span></span><span style=display:flex><span>        rx_handle <span style=color:#f92672>=</span> NULL;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;I2S RX initialized (handle=%p)&#34;</span>, rx_handle);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>i2s_init_master_tx</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>i2s_chan_config_t</span> chan_cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>I2S_CHANNEL_DEFAULT_CONFIG</span>(I2S_TX_NUM, I2S_ROLE_MASTER);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>esp_err_t</span> err <span style=color:#f92672>=</span> <span style=color:#a6e22e>i2s_new_channel</span>(<span style=color:#f92672>&amp;</span>chan_cfg, <span style=color:#f92672>&amp;</span>tx_handle, NULL);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (err <span style=color:#f92672>!=</span> ESP_OK)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;i2s_new_channel tx failed: %s&#34;</span>, <span style=color:#a6e22e>esp_err_to_name</span>(err));
</span></span><span style=display:flex><span>        tx_handle <span style=color:#f92672>=</span> NULL;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>i2s_std_config_t</span> std_cfg <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        .clk_cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>I2S_STD_CLK_DEFAULT_CONFIG</span>(SAMPLE_RATE),
</span></span><span style=display:flex><span>        .slot_cfg <span style=color:#f92672>=</span> <span style=color:#a6e22e>I2S_STD_PHILIPS_SLOT_DEFAULT_CONFIG</span>(I2S_DATA_BIT_WIDTH_16BIT, I2S_SLOT_MODE_MONO),
</span></span><span style=display:flex><span>        .gpio_cfg <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            .mclk <span style=color:#f92672>=</span> I2S_GPIO_UNUSED,
</span></span><span style=display:flex><span>            .bclk <span style=color:#f92672>=</span> MAX_BCLK,
</span></span><span style=display:flex><span>            .ws <span style=color:#f92672>=</span> MAX_LRC,
</span></span><span style=display:flex><span>            .dout <span style=color:#f92672>=</span> MAX_DOUT,
</span></span><span style=display:flex><span>            .din <span style=color:#f92672>=</span> I2S_GPIO_UNUSED,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    err <span style=color:#f92672>=</span> <span style=color:#a6e22e>i2s_channel_init_std_mode</span>(tx_handle, <span style=color:#f92672>&amp;</span>std_cfg);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (err <span style=color:#f92672>!=</span> ESP_OK)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;i2s_channel_init_std_mode tx failed: %s&#34;</span>, <span style=color:#a6e22e>esp_err_to_name</span>(err));
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>i2s_del_channel</span>(tx_handle);
</span></span><span style=display:flex><span>        tx_handle <span style=color:#f92672>=</span> NULL;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    err <span style=color:#f92672>=</span> <span style=color:#a6e22e>i2s_channel_enable</span>(tx_handle);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (err <span style=color:#f92672>!=</span> ESP_OK)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;i2s_channel_enable tx failed: %s&#34;</span>, <span style=color:#a6e22e>esp_err_to_name</span>(err));
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>i2s_del_channel</span>(tx_handle);
</span></span><span style=display:flex><span>        tx_handle <span style=color:#f92672>=</span> NULL;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;I2S TX initialized (handle=%p)&#34;</span>, tx_handle);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Heartbeat broadcaster
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>heartbeat_task</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>pvParameters)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> sock <span style=color:#f92672>=</span> <span style=color:#a6e22e>socket</span>(AF_INET, SOCK_DGRAM, IPPROTO_IP);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (sock <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;heartbeat socket create failed&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>vTaskDelete</span>(NULL);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> broadcastEnable <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>setsockopt</span>(sock, SOL_SOCKET, SO_BROADCAST, <span style=color:#f92672>&amp;</span>broadcastEnable, <span style=color:#66d9ef>sizeof</span>(broadcastEnable));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> sockaddr_in dest_addr;
</span></span><span style=display:flex><span>    dest_addr.sin_family <span style=color:#f92672>=</span> AF_INET;
</span></span><span style=display:flex><span>    dest_addr.sin_port <span style=color:#f92672>=</span> <span style=color:#a6e22e>htons</span>(UDP_HEARTBEAT_PORT);
</span></span><span style=display:flex><span>    dest_addr.sin_addr.s_addr <span style=color:#f92672>=</span> <span style=color:#a6e22e>inet_addr</span>(BROADCAST_IP);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> buf[<span style=color:#ae81ff>128</span>];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> (<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>snprintf</span>(buf, <span style=color:#66d9ef>sizeof</span>(buf), <span style=color:#e6db74>&#34;heartbeat:%s:%d&#34;</span>, device_id, UDP_AUDIO_PORT);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>sendto</span>(sock, buf, <span style=color:#a6e22e>strlen</span>(buf), <span style=color:#ae81ff>0</span>, (<span style=color:#66d9ef>struct</span> sockaddr <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>dest_addr, <span style=color:#66d9ef>sizeof</span>(dest_addr));
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>vTaskDelay</span>(<span style=color:#a6e22e>pdMS_TO_TICKS</span>(<span style=color:#ae81ff>3000</span>));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// never here
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>close</span>(sock);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>vTaskDelete</span>(NULL);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Command listener (CMD_PORT)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>cmd_listener_task</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>pvParameters)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> sock <span style=color:#f92672>=</span> <span style=color:#a6e22e>socket</span>(AF_INET, SOCK_DGRAM, IPPROTO_IP);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (sock <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;cmd socket create failed&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>vTaskDelete</span>(NULL);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> sockaddr_in local_addr;
</span></span><span style=display:flex><span>    local_addr.sin_family <span style=color:#f92672>=</span> AF_INET;
</span></span><span style=display:flex><span>    local_addr.sin_port <span style=color:#f92672>=</span> <span style=color:#a6e22e>htons</span>(UDP_CMD_PORT);
</span></span><span style=display:flex><span>    local_addr.sin_addr.s_addr <span style=color:#f92672>=</span> <span style=color:#a6e22e>htonl</span>(INADDR_ANY);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>bind</span>(sock, (<span style=color:#66d9ef>struct</span> sockaddr <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>local_addr, <span style=color:#66d9ef>sizeof</span>(local_addr)) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;cmd bind failed&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;CMD listener on %d&#34;</span>, UDP_CMD_PORT);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> buf[<span style=color:#ae81ff>256</span>];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> (<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> len <span style=color:#f92672>=</span> <span style=color:#a6e22e>recvfrom</span>(sock, buf, <span style=color:#66d9ef>sizeof</span>(buf) <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>0</span>, NULL, NULL);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (len <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            buf[len] <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;CMD recv: %s&#34;</span>, buf);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>strncmp</span>(buf, <span style=color:#e6db74>&#34;START_CALL:&#34;</span>, <span style=color:#ae81ff>11</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>char</span> ipbuf[<span style=color:#ae81ff>64</span>] <span style=color:#f92672>=</span> {<span style=color:#ae81ff>0</span>};
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>int</span> port <span style=color:#f92672>=</span> UDP_AUDIO_PORT;
</span></span><span style=display:flex><span>                <span style=color:#75715e>// parse ip:port ; allow case when port missing
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>sscanf</span>(buf <span style=color:#f92672>+</span> <span style=color:#ae81ff>11</span>, <span style=color:#e6db74>&#34;%63[^:]:%d&#34;</span>, ipbuf, <span style=color:#f92672>&amp;</span>port) <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>strncpy</span>(target_ip, ipbuf, <span style=color:#66d9ef>sizeof</span>(target_ip) <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>                    target_port <span style=color:#f92672>=</span> port;
</span></span><span style=display:flex><span>                    in_call <span style=color:#f92672>=</span> true;
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;start call to %s:%d&#34;</span>, target_ip, target_port);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>ESP_LOGW</span>(TAG, <span style=color:#e6db74>&#34;START_CALL parse failed&#34;</span>);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>strncmp</span>(buf, <span style=color:#e6db74>&#34;STOP_CALL&#34;</span>, <span style=color:#ae81ff>9</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                in_call <span style=color:#f92672>=</span> false;
</span></span><span style=display:flex><span>                target_ip[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;stop call&#34;</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;unknown cmd&#34;</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>close</span>(sock);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>vTaskDelete</span>(NULL);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Audio sender: when in_call true, read i2s mic and send PCM16 to target
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>audio_sender_task</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>pvParameters)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> sock <span style=color:#f92672>=</span> <span style=color:#a6e22e>socket</span>(AF_INET, SOCK_DGRAM, IPPROTO_IP);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (sock <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;audio sender socket create failed&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>vTaskDelete</span>(NULL);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;audio sender started (sock=%d)&#34;</span>, sock);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int32_t</span> i2s_raw[I2S_BUFFER_SAMPLES];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int16_t</span> pcm16[I2S_BUFFER_SAMPLES];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>size_t</span> bytes_read;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> (<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>in_call)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>vTaskDelay</span>(<span style=color:#a6e22e>pdMS_TO_TICKS</span>(<span style=color:#ae81ff>10</span>));
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (rx_handle <span style=color:#f92672>==</span> NULL)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ESP_LOGW</span>(TAG, <span style=color:#e6db74>&#34;rx_handle NULL, skipping send&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>vTaskDelay</span>(<span style=color:#a6e22e>pdMS_TO_TICKS</span>(<span style=color:#ae81ff>50</span>));
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>esp_err_t</span> res <span style=color:#f92672>=</span> <span style=color:#a6e22e>i2s_channel_read</span>(rx_handle, i2s_raw, <span style=color:#66d9ef>sizeof</span>(i2s_raw), <span style=color:#f92672>&amp;</span>bytes_read, portMAX_DELAY);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (res <span style=color:#f92672>==</span> ESP_OK <span style=color:#f92672>&amp;&amp;</span> bytes_read <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int</span> samples <span style=color:#f92672>=</span> bytes_read <span style=color:#f92672>/</span> <span style=color:#ae81ff>4</span>; <span style=color:#75715e>// 32-bit read -&gt; samples
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> (samples <span style=color:#f92672>&gt;</span> I2S_BUFFER_SAMPLES)
</span></span><span style=display:flex><span>                samples <span style=color:#f92672>=</span> I2S_BUFFER_SAMPLES;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> samples; i<span style=color:#f92672>++</span>)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>int32_t</span> sample <span style=color:#f92672>=</span> (i2s_raw[i] <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>8</span>); <span style=color:#75715e>// 24-bit -&gt; align
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                pcm16[i] <span style=color:#f92672>=</span> (<span style=color:#66d9ef>int16_t</span>)(sample <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>8</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (target_ip[<span style=color:#ae81ff>0</span>])
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>struct</span> sockaddr_in dest;
</span></span><span style=display:flex><span>                dest.sin_family <span style=color:#f92672>=</span> AF_INET;
</span></span><span style=display:flex><span>                dest.sin_port <span style=color:#f92672>=</span> <span style=color:#a6e22e>htons</span>(target_port);
</span></span><span style=display:flex><span>                dest.sin_addr.s_addr <span style=color:#f92672>=</span> <span style=color:#a6e22e>inet_addr</span>(target_ip);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>int</span> tosend <span style=color:#f92672>=</span> samples <span style=color:#f92672>*</span> <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>int16_t</span>);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>int</span> r <span style=color:#f92672>=</span> <span style=color:#a6e22e>sendto</span>(sock, pcm16, tosend, <span style=color:#ae81ff>0</span>, (<span style=color:#66d9ef>struct</span> sockaddr <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>dest, <span style=color:#66d9ef>sizeof</span>(dest));
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (r <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>ESP_LOGW</span>(TAG, <span style=color:#e6db74>&#34;sendto failed&#34;</span>);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ESP_LOGW</span>(TAG, <span style=color:#e6db74>&#34;i2s_channel_read failed: %s&#34;</span>, <span style=color:#a6e22e>esp_err_to_name</span>(res));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>close</span>(sock);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>vTaskDelete</span>(NULL);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Audio receiver: listen for UDP audio on AUDIO_PORT and write to I2S tx (speaker)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>audio_receiver_task</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>pvParameters)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> sockaddr_in local_addr;
</span></span><span style=display:flex><span>    local_addr.sin_family <span style=color:#f92672>=</span> AF_INET;
</span></span><span style=display:flex><span>    local_addr.sin_port <span style=color:#f92672>=</span> <span style=color:#a6e22e>htons</span>(UDP_AUDIO_PORT);
</span></span><span style=display:flex><span>    local_addr.sin_addr.s_addr <span style=color:#f92672>=</span> <span style=color:#a6e22e>htonl</span>(INADDR_ANY);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> sock <span style=color:#f92672>=</span> <span style=color:#a6e22e>socket</span>(AF_INET, SOCK_DGRAM, IPPROTO_IP);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (sock <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;audio recv socket create failed&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>vTaskDelete</span>(NULL);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>bind</span>(sock, (<span style=color:#66d9ef>struct</span> sockaddr <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>local_addr, <span style=color:#66d9ef>sizeof</span>(local_addr)) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGE</span>(TAG, <span style=color:#e6db74>&#34;audio recv bind failed&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Audio receiver listening on %d&#34;</span>, UDP_AUDIO_PORT);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int16_t</span> pcm16[I2S_BUFFER_SAMPLES];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> (<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> len <span style=color:#f92672>=</span> <span style=color:#a6e22e>recvfrom</span>(sock, pcm16, <span style=color:#66d9ef>sizeof</span>(pcm16), <span style=color:#ae81ff>0</span>, NULL, NULL);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (len <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (tx_handle <span style=color:#f92672>==</span> NULL)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>ESP_LOGW</span>(TAG, <span style=color:#e6db74>&#34;tx_handle NULL, received audio dropped&#34;</span>);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>size_t</span> bytes_written <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>esp_err_t</span> res <span style=color:#f92672>=</span> <span style=color:#a6e22e>i2s_channel_write</span>(tx_handle, pcm16, len, <span style=color:#f92672>&amp;</span>bytes_written, portMAX_DELAY);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (res <span style=color:#f92672>!=</span> ESP_OK)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>ESP_LOGW</span>(TAG, <span style=color:#e6db74>&#34;i2s_channel_write failed: %s&#34;</span>, <span style=color:#a6e22e>esp_err_to_name</span>(res));
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>close</span>(sock);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>vTaskDelete</span>(NULL);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>app_main</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#75715e>// generate device id from MAC
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>uint8_t</span> mac[<span style=color:#ae81ff>6</span>];
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>esp_read_mac</span>(mac, ESP_MAC_WIFI_STA);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>snprintf</span>(device_id, <span style=color:#66d9ef>sizeof</span>(device_id), <span style=color:#e6db74>&#34;room_%02X%02X%02X&#34;</span>, mac[<span style=color:#ae81ff>3</span>], mac[<span style=color:#ae81ff>4</span>], mac[<span style=color:#ae81ff>5</span>]);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;Device id: %s&#34;</span>, device_id);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ESP_ERROR_CHECK</span>(<span style=color:#a6e22e>nvs_flash_init</span>());
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>wifi_init_sta</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// init I2S rx/tx
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>i2s_init_master_rx</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>i2s_init_master_tx</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// log handles
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>ESP_LOGI</span>(TAG, <span style=color:#e6db74>&#34;rx_handle=%p tx_handle=%p&#34;</span>, rx_handle, tx_handle);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>xTaskCreate</span>(heartbeat_task, <span style=color:#e6db74>&#34;heartbeat_task&#34;</span>, <span style=color:#ae81ff>4096</span>, NULL, <span style=color:#ae81ff>5</span>, NULL);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>xTaskCreate</span>(cmd_listener_task, <span style=color:#e6db74>&#34;cmd_listener_task&#34;</span>, <span style=color:#ae81ff>4096</span>, NULL, <span style=color:#ae81ff>5</span>, NULL);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>xTaskCreate</span>(audio_sender_task, <span style=color:#e6db74>&#34;audio_sender_task&#34;</span>, <span style=color:#ae81ff>8192</span>, NULL, <span style=color:#ae81ff>5</span>, NULL);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>xTaskCreate</span>(audio_receiver_task, <span style=color:#e6db74>&#34;audio_receiver_task&#34;</span>, <span style=color:#ae81ff>8192</span>, NULL, <span style=color:#ae81ff>5</span>, NULL);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h1 id=nodejs-server>nodejs server<a hidden class=anchor aria-hidden=true href=#nodejs-server>#</a></h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>express</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;express&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>dgram</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;dgram&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>cors</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;cors&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>path</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;path&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>fileURLToPath</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;url&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>AUDIO_PORT</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>12345</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>CMD_PORT</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>12346</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>HEARTBEAT_PORT</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>12347</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>HEARTBEAT_TIMEOUT</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span>; <span style=color:#75715e>// 10ç§’
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>app</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>express</span>();
</span></span><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(<span style=color:#a6e22e>cors</span>());
</span></span><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(<span style=color:#a6e22e>express</span>.<span style=color:#a6e22e>json</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// è®¾å¤‡åˆ—è¡¨
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>devices</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Map</span>(); <span style=color:#75715e>// ip -&gt; { id, audio_port, last_seen }
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>cleanupDevices</span>() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>now</span> <span style=color:#f92672>=</span> Date.<span style=color:#a6e22e>now</span>();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> [<span style=color:#a6e22e>ip</span>, <span style=color:#a6e22e>info</span>] <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>devices</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>now</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>info</span>.<span style=color:#a6e22e>last_seen</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>HEARTBEAT_TIMEOUT</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>devices</span>.<span style=color:#66d9ef>delete</span>(<span style=color:#a6e22e>ip</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// UDP å‘é€å‘½ä»¤
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>sendCmd</span>(<span style=color:#a6e22e>ip</span>, <span style=color:#a6e22e>text</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>sock</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>dgram</span>.<span style=color:#a6e22e>createSocket</span>(<span style=color:#e6db74>&#34;udp4&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>buf</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Buffer</span>.<span style=color:#a6e22e>from</span>(<span style=color:#a6e22e>text</span>, <span style=color:#e6db74>&#34;utf-8&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>sock</span>.<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>buf</span>, <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>buf</span>.<span style=color:#a6e22e>length</span>, <span style=color:#a6e22e>CMD_PORT</span>, <span style=color:#a6e22e>ip</span>, (<span style=color:#a6e22e>err</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#34;sendCmd error:&#34;</span>, <span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sock</span>.<span style=color:#a6e22e>close</span>();
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// å¿ƒè·³ç›‘å¬çº¿ç¨‹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>startHeartbeatListener</span>() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>sock</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>dgram</span>.<span style=color:#a6e22e>createSocket</span>(<span style=color:#e6db74>&#34;udp4&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>sock</span>.<span style=color:#a6e22e>bind</span>(<span style=color:#a6e22e>HEARTBEAT_PORT</span>, () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`Heartbeat listener running on UDP port </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>HEARTBEAT_PORT</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>sock</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;message&#34;</span>, (<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>rinfo</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>ip</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>rinfo</span>.<span style=color:#a6e22e>address</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>parsed</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>txt</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>toString</span>(<span style=color:#e6db74>&#34;utf-8&#34;</span>).<span style=color:#a6e22e>trim</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>parsed</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>txt</span>);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>parts</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>txt</span>.<span style=color:#a6e22e>split</span>(<span style=color:#e6db74>&#34;:&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>parts</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>toLowerCase</span>() <span style=color:#f92672>===</span> <span style=color:#e6db74>&#34;heartbeat&#34;</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>parsed</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;heartbeat&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>parts</span>[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>||</span> <span style=color:#a6e22e>ip</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>audio_port</span><span style=color:#f92672>:</span> parseInt(<span style=color:#a6e22e>parts</span>[<span style=color:#ae81ff>2</span>]) <span style=color:#f92672>||</span> <span style=color:#a6e22e>AUDIO_PORT</span>,
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>parsed</span> <span style=color:#f92672>&amp;&amp;</span> (<span style=color:#a6e22e>parsed</span>.<span style=color:#a6e22e>type</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#34;heartbeat&#34;</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>parsed</span>.<span style=color:#a6e22e>id</span>)) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>devices</span>.<span style=color:#a6e22e>set</span>(<span style=color:#a6e22e>ip</span>, {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>parsed</span>.<span style=color:#a6e22e>id</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>ip</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>audio_port</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>parsed</span>.<span style=color:#a6e22e>audio_port</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>AUDIO_PORT</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>last_seen</span><span style=color:#f92672>:</span> Date.<span style=color:#a6e22e>now</span>(),
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cleanupDevices</span>();
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ç®€æ˜“å‰ç«¯ HTMLï¼ˆä¸ Python ç‰ˆç­‰ä»·ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>INDEX_HTML</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;!doctype html&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;html&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;head&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &lt;meta charset=&#34;utf-8&#34;/&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &lt;title&gt;Multiroom æ§åˆ¶é¢æ¿&lt;/title&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;/head&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;body&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &lt;h2&gt;Multiroom æ§åˆ¶é¢æ¿&lt;/h2&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &lt;div&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;button onclick=&#34;refresh()&#34;&gt;åˆ·æ–°è®¾å¤‡&lt;/button&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;button onclick=&#34;startCall()&#34;&gt;å¼€å§‹äº’é€šï¼ˆé€‰ä¸­ä¸¤ä¸ªï¼‰&lt;/button&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;button onclick=&#34;stopCall()&#34;&gt;åœæ­¢æ‰€æœ‰é€šè¯&lt;/button&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &lt;/div&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &lt;h3&gt;è®¾å¤‡åˆ—è¡¨&lt;/h3&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &lt;table border=&#34;1&#34; id=&#34;devtable&#34;&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;thead&gt;&lt;tr&gt;&lt;th&gt;Select&lt;/th&gt;&lt;th&gt;IP&lt;/th&gt;&lt;th&gt;ID&lt;/th&gt;&lt;th&gt;Last seen&lt;/th&gt;&lt;th&gt;Audio port&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;tbody&gt;&lt;/tbody&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &lt;/table&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;script&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>async function refresh(){
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  const r = await fetch(&#39;/devices&#39;);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  const j = await r.json();
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  const tbody = document.querySelector(&#39;#devtable tbody&#39;);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  tbody.innerHTML = &#39;&#39;;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  j.forEach(d =&gt; {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    const tr = document.createElement(&#39;tr&#39;);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    tr.innerHTML = \`&lt;td&gt;&lt;input type=&#34;checkbox&#34; data-ip=&#34;\${d.ip}&#34;&gt;&lt;/td&gt;&lt;td&gt;\${d.ip}&lt;/td&gt;&lt;td&gt;\${d.id}&lt;/td&gt;&lt;td&gt;\${d.last_seen}&lt;/td&gt;&lt;td&gt;\${d.audio_port}&lt;/td&gt;\`;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    tbody.appendChild(tr);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  });
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>async function startCall(){
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  const checked = [...document.querySelectorAll(&#39;#devtable tbody input[type=checkbox]:checked&#39;)].map(i=&gt;i.dataset.ip);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  if(checked.length !== 2){ alert(&#39;è¯·é€‰æ‹©ä¸¤ä¸ªè®¾å¤‡ï¼ˆä¸¤ä¸ªæˆ¿é—´ï¼‰è¿›è¡Œäº’é€š&#39;); return; }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  const [a,b] = checked;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  const resp = await fetch(&#39;/start_call&#39;, {method:&#39;POST&#39;, headers:{&#39;Content-Type&#39;:&#39;application/json&#39;}, body: JSON.stringify({a_ip:a, b_ip:b})});
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  const j = await resp.json();
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  alert(JSON.stringify(j));
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  refresh();
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>async function stopCall(){
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  const resp = await fetch(&#39;/stop_all&#39;, {method:&#39;POST&#39;});
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  const j = await resp.json();
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  alert(JSON.stringify(j));
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  refresh();
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>refresh();
</span></span></span><span style=display:flex><span><span style=color:#e6db74>setInterval(refresh, 5000);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;/script&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;/body&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;/html&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/&#34;</span>, (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>INDEX_HTML</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// è·å–è®¾å¤‡åˆ—è¡¨
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/devices&#34;</span>, (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>cleanupDevices</span>();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>list</span> <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> [<span style=color:#a6e22e>ip</span>, <span style=color:#a6e22e>info</span>] <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>devices</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>list</span>.<span style=color:#a6e22e>push</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>ip</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>info</span>.<span style=color:#a6e22e>id</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>audio_port</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>info</span>.<span style=color:#a6e22e>audio_port</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>last_seen</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>new</span> Date(<span style=color:#a6e22e>info</span>.<span style=color:#a6e22e>last_seen</span>).<span style=color:#a6e22e>toLocaleString</span>(),
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>json</span>(<span style=color:#a6e22e>list</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// å¼€å§‹äº’é€š
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>post</span>(<span style=color:#e6db74>&#34;/start_call&#34;</span>, (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>a_ip</span>, <span style=color:#a6e22e>b_ip</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>sendCmd</span>(<span style=color:#a6e22e>a_ip</span>, <span style=color:#e6db74>`START_CALL:</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>b_ip</span><span style=color:#e6db74>}</span><span style=color:#e6db74>:</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>AUDIO_PORT</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>sendCmd</span>(<span style=color:#a6e22e>b_ip</span>, <span style=color:#e6db74>`START_CALL:</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>a_ip</span><span style=color:#e6db74>}</span><span style=color:#e6db74>:</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>AUDIO_PORT</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;ok&#34;</span>, <span style=color:#a6e22e>msg</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>a_ip</span><span style=color:#e6db74>}</span><span style=color:#e6db74> &lt;-&gt; </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>b_ip</span><span style=color:#e6db74>}</span><span style=color:#e6db74> started`</span> });
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// åœæ­¢æ‰€æœ‰äº’é€š
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>post</span>(<span style=color:#e6db74>&#34;/stop_all&#34;</span>, (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>ips</span> <span style=color:#f92672>=</span> Array.<span style=color:#a6e22e>from</span>(<span style=color:#a6e22e>devices</span>.<span style=color:#a6e22e>keys</span>());
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>ip</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>ips</span>) <span style=color:#a6e22e>sendCmd</span>(<span style=color:#a6e22e>ip</span>, <span style=color:#e6db74>&#34;STOP_CALL&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;ok&#34;</span>, <span style=color:#a6e22e>stopped</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>ips</span> });
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// å¯åŠ¨
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>PORT</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>5000</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>listen</span>(<span style=color:#a6e22e>PORT</span>, <span style=color:#e6db74>&#34;0.0.0.0&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`Web server running at http://0.0.0.0:</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>PORT</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span><span style=color:#a6e22e>startHeartbeatListener</span>();
</span></span></code></pre></div><p>åœ¨é¡¹ç›®æ ¹ç›®å½•çš„ package.json ä¸­æ·»åŠ ï¼š</p><p>{
&ldquo;type&rdquo;: &ldquo;module&rdquo;
}</p><p>node server.js</p><h1 id=goserver-eps32>goserver eps32<a hidden class=anchor aria-hidden=true href=#goserver-eps32>#</a></h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;encoding/json&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;io&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;net&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;net/http&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;strconv&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;strings&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;sync&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>AUDIO_PORT</span>        = <span style=color:#ae81ff>12345</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>CMD_PORT</span>          = <span style=color:#ae81ff>12346</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>HEARTBEAT_PORT</span>    = <span style=color:#ae81ff>12347</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>HEARTBEAT_TIMEOUT</span> = <span style=color:#ae81ff>10</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>CLEANUP_INTERVAL</span>  = <span style=color:#ae81ff>3</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>HTTP_LISTEN_ADDR</span>  = <span style=color:#e6db74>&#34;:5000&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>DeviceInfo</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ID</span>        <span style=color:#66d9ef>string</span>    <span style=color:#e6db74>`json:&#34;id&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>AudioPort</span> <span style=color:#66d9ef>int</span>       <span style=color:#e6db74>`json:&#34;audio_port&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>LastSeen</span>  <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span> <span style=color:#e6db74>`json:&#34;last_seen&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>devices</span> = make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>DeviceInfo</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mu</span>      <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>RWMutex</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>heartbeatListener</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>cleanupLoop</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>HandleFunc</span>(<span style=color:#e6db74>&#34;/&#34;</span>, <span style=color:#a6e22e>indexHandler</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>HandleFunc</span>(<span style=color:#e6db74>&#34;/devices&#34;</span>, <span style=color:#a6e22e>devicesHandler</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>HandleFunc</span>(<span style=color:#e6db74>&#34;/start_call&#34;</span>, <span style=color:#a6e22e>startCallHandler</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>HandleFunc</span>(<span style=color:#e6db74>&#34;/stop_all&#34;</span>, <span style=color:#a6e22e>stopAllHandler</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;âœ… Web æ§åˆ¶ç«¯å·²å¯åŠ¨: http://0.0.0.0%s\n&#34;</span>, <span style=color:#a6e22e>HTTP_LISTEN_ADDR</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ListenAndServe</span>(<span style=color:#a6e22e>HTTP_LISTEN_ADDR</span>, <span style=color:#66d9ef>nil</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalf</span>(<span style=color:#e6db74>&#34;ListenAndServe: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>heartbeatListener</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>addr</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>UDPAddr</span>{<span style=color:#a6e22e>Port</span>: <span style=color:#a6e22e>HEARTBEAT_PORT</span>, <span style=color:#a6e22e>IP</span>: <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>IPv4zero</span>}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>ListenUDP</span>(<span style=color:#e6db74>&#34;udp4&#34;</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>addr</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalf</span>(<span style=color:#e6db74>&#34;æ— æ³•å¯åŠ¨å¿ƒè·³ç›‘å¬ç«¯å£ %d: %v&#34;</span>, <span style=color:#a6e22e>HEARTBEAT_PORT</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;ğŸ”„ å¿ƒè·³ç›‘å¬å·²å¯åŠ¨ (UDP %d)&#34;</span>, <span style=color:#a6e22e>HEARTBEAT_PORT</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>buf</span> <span style=color:#f92672>:=</span> make([]<span style=color:#66d9ef>byte</span>, <span style=color:#ae81ff>2048</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>n</span>, <span style=color:#a6e22e>raddr</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>ReadFromUDP</span>(<span style=color:#a6e22e>buf</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>txt</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>TrimSpace</span>(string(<span style=color:#a6e22e>buf</span>[:<span style=color:#a6e22e>n</span>]))
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ip</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>raddr</span>.<span style=color:#a6e22e>IP</span>.<span style=color:#a6e22e>String</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>parsed</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>interface</span>{}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>id</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>audioPort</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>AUDIO_PORT</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Unmarshal</span>([]byte(<span style=color:#a6e22e>txt</span>), <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>parsed</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>v</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>parsed</span>[<span style=color:#e6db74>&#34;id&#34;</span>]; <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>id</span> = <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%v&#34;</span>, <span style=color:#a6e22e>v</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>v</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>parsed</span>[<span style=color:#e6db74>&#34;audio_port&#34;</span>]; <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>vv</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>v</span>.(<span style=color:#66d9ef>type</span>) {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>case</span> <span style=color:#66d9ef>float64</span>:
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>audioPort</span> = int(<span style=color:#a6e22e>vv</span>)
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>case</span> <span style=color:#66d9ef>string</span>:
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>p</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>Atoi</span>(<span style=color:#a6e22e>vv</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>						<span style=color:#a6e22e>audioPort</span> = <span style=color:#a6e22e>p</span>
</span></span><span style=display:flex><span>					}
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>parts</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Split</span>(<span style=color:#a6e22e>txt</span>, <span style=color:#e6db74>&#34;:&#34;</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>parts</span>) <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>ToLower</span>(<span style=color:#a6e22e>parts</span>[<span style=color:#ae81ff>0</span>]) <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;heartbeat&#34;</span> {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>parts</span>) <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>2</span> {
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>id</span> = <span style=color:#a6e22e>parts</span>[<span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>parts</span>) <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>3</span> {
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>p</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>Atoi</span>(<span style=color:#a6e22e>parts</span>[<span style=color:#ae81ff>2</span>]); <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>						<span style=color:#a6e22e>audioPort</span> = <span style=color:#a6e22e>p</span>
</span></span><span style=display:flex><span>					}
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>id</span> = <span style=color:#a6e22e>ip</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>devices</span>[<span style=color:#a6e22e>ip</span>] = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>DeviceInfo</span>{<span style=color:#a6e22e>ID</span>: <span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>AudioPort</span>: <span style=color:#a6e22e>audioPort</span>, <span style=color:#a6e22e>LastSeen</span>: <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>cleanupLoop</span>() {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>CLEANUP_INTERVAL</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>now</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>ip</span>, <span style=color:#a6e22e>info</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>devices</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>now</span>.<span style=color:#a6e22e>Sub</span>(<span style=color:#a6e22e>info</span>.<span style=color:#a6e22e>LastSeen</span>) &gt; <span style=color:#a6e22e>HEARTBEAT_TIMEOUT</span> {
</span></span><span style=display:flex><span>				delete(<span style=color:#a6e22e>devices</span>, <span style=color:#a6e22e>ip</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>indexHandler</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Header</span>().<span style=color:#a6e22e>Set</span>(<span style=color:#e6db74>&#34;Content-Type&#34;</span>, <span style=color:#e6db74>&#34;text/html; charset=utf-8&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>indexHTML</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>devicesHandler</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RLock</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>out</span> <span style=color:#f92672>:=</span> make([]<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>interface</span>{}, <span style=color:#ae81ff>0</span>, len(<span style=color:#a6e22e>devices</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>ip</span>, <span style=color:#a6e22e>info</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>devices</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>out</span> = append(<span style=color:#a6e22e>out</span>, <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>interface</span>{}{
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;ip&#34;</span>:         <span style=color:#a6e22e>ip</span>,
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;id&#34;</span>:         <span style=color:#a6e22e>info</span>.<span style=color:#a6e22e>ID</span>,
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;audio_port&#34;</span>: <span style=color:#a6e22e>info</span>.<span style=color:#a6e22e>AudioPort</span>,
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;last_seen&#34;</span>:  <span style=color:#a6e22e>info</span>.<span style=color:#a6e22e>LastSeen</span>.<span style=color:#a6e22e>Format</span>(<span style=color:#e6db74>&#34;2006-01-02 15:04:05&#34;</span>),
</span></span><span style=display:flex><span>		})
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RUnlock</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Header</span>().<span style=color:#a6e22e>Set</span>(<span style=color:#e6db74>&#34;Content-Type&#34;</span>, <span style=color:#e6db74>&#34;application/json; charset=utf-8&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>NewEncoder</span>(<span style=color:#a6e22e>w</span>).<span style=color:#a6e22e>Encode</span>(<span style=color:#a6e22e>out</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>startCallHandler</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>payload</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>AIP</span> <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;a_ip&#34;`</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>BIP</span> <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;b_ip&#34;`</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>NewDecoder</span>(<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Body</span>).<span style=color:#a6e22e>Decode</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>payload</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>w</span>, <span style=color:#e6db74>&#34;bad request&#34;</span>, <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusBadRequest</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sendUDPCommand</span>(<span style=color:#a6e22e>payload</span>.<span style=color:#a6e22e>AIP</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;START_CALL:%s:%d&#34;</span>, <span style=color:#a6e22e>payload</span>.<span style=color:#a6e22e>BIP</span>, <span style=color:#a6e22e>AUDIO_PORT</span>))
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sendUDPCommand</span>(<span style=color:#a6e22e>payload</span>.<span style=color:#a6e22e>BIP</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;START_CALL:%s:%d&#34;</span>, <span style=color:#a6e22e>payload</span>.<span style=color:#a6e22e>AIP</span>, <span style=color:#a6e22e>AUDIO_PORT</span>))
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Header</span>().<span style=color:#a6e22e>Set</span>(<span style=color:#e6db74>&#34;Content-Type&#34;</span>, <span style=color:#e6db74>&#34;application/json; charset=utf-8&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>NewEncoder</span>(<span style=color:#a6e22e>w</span>).<span style=color:#a6e22e>Encode</span>(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>interface</span>{}{
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;status&#34;</span>: <span style=color:#e6db74>&#34;ok&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;msg&#34;</span>:    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%s &lt;-&gt; %s started&#34;</span>, <span style=color:#a6e22e>payload</span>.<span style=color:#a6e22e>AIP</span>, <span style=color:#a6e22e>payload</span>.<span style=color:#a6e22e>BIP</span>),
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>stopAllHandler</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RLock</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ips</span> <span style=color:#f92672>:=</span> make([]<span style=color:#66d9ef>string</span>, <span style=color:#ae81ff>0</span>, len(<span style=color:#a6e22e>devices</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>ip</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>devices</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ips</span> = append(<span style=color:#a6e22e>ips</span>, <span style=color:#a6e22e>ip</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RUnlock</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>ip</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>ips</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sendUDPCommand</span>(<span style=color:#a6e22e>ip</span>, <span style=color:#e6db74>&#34;STOP_CALL&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Header</span>().<span style=color:#a6e22e>Set</span>(<span style=color:#e6db74>&#34;Content-Type&#34;</span>, <span style=color:#e6db74>&#34;application/json; charset=utf-8&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>NewEncoder</span>(<span style=color:#a6e22e>w</span>).<span style=color:#a6e22e>Encode</span>(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>interface</span>{}{
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;status&#34;</span>: <span style=color:#e6db74>&#34;ok&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;stopped&#34;</span>: <span style=color:#a6e22e>ips</span>,
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>sendUDPCommand</span>(<span style=color:#a6e22e>ip</span>, <span style=color:#a6e22e>txt</span> <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>addr</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>JoinHostPort</span>(<span style=color:#a6e22e>ip</span>, <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>Itoa</span>(<span style=color:#a6e22e>CMD_PORT</span>))
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>Dial</span>(<span style=color:#e6db74>&#34;udp&#34;</span>, <span style=color:#a6e22e>addr</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;UDP è¿æ¥å¤±è´¥ %s: %v&#34;</span>, <span style=color:#a6e22e>ip</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Write</span>([]byte(<span style=color:#a6e22e>txt</span>))
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>indexHTML</span> = <span style=color:#e6db74>`
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;!doctype html&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;html&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;head&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &lt;meta charset=&#34;utf-8&#34;/&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &lt;title&gt;Multiroom æ§åˆ¶é¢æ¿&lt;/title&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;/head&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;body&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &lt;h2&gt;Multiroom æ§åˆ¶é¢æ¿&lt;/h2&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &lt;div&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;button onclick=&#34;refresh()&#34;&gt;åˆ·æ–°è®¾å¤‡&lt;/button&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;button onclick=&#34;startCall()&#34;&gt;å¼€å§‹äº’é€šï¼ˆé€‰ä¸­ä¸¤ä¸ªï¼‰&lt;/button&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;button onclick=&#34;stopCall()&#34;&gt;åœæ­¢æ‰€æœ‰é€šè¯&lt;/button&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &lt;/div&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &lt;h3&gt;è®¾å¤‡åˆ—è¡¨&lt;/h3&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &lt;table border=&#34;1&#34; id=&#34;devtable&#34;&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;thead&gt;&lt;tr&gt;&lt;th&gt;Select&lt;/th&gt;&lt;th&gt;IP&lt;/th&gt;&lt;th&gt;ID&lt;/th&gt;&lt;th&gt;Last seen&lt;/th&gt;&lt;th&gt;Audio port&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;tbody&gt;&lt;/tbody&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &lt;/table&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;script&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>async function refresh(){
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  const r = await fetch(&#39;/devices&#39;);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  const j = await r.json();
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  const tbody = document.querySelector(&#39;#devtable tbody&#39;);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  tbody.innerHTML = &#39;&#39;;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  j.forEach(d =&gt; {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    const tr = document.createElement(&#39;tr&#39;);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    tr.innerHTML = &#39;&lt;td&gt;&lt;input type=&#34;checkbox&#34; data-ip=&#34;&#39;+d.ip+&#39;&#34;&gt;&lt;/td&gt;&lt;td&gt;&#39;+d.ip+&#39;&lt;/td&gt;&lt;td&gt;&#39;+d.id+&#39;&lt;/td&gt;&lt;td&gt;&#39;+d.last_seen+&#39;&lt;/td&gt;&lt;td&gt;&#39;+d.audio_port+&#39;&lt;/td&gt;&#39;;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    tbody.appendChild(tr);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  });
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>async function startCall(){
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  const checked = [...document.querySelectorAll(&#39;#devtable tbody input[type=checkbox]:checked&#39;)].map(i=&gt;i.dataset.ip);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  if(checked.length !== 2){ alert(&#39;è¯·é€‰æ‹©ä¸¤ä¸ªè®¾å¤‡ï¼ˆä¸¤ä¸ªæˆ¿é—´ï¼‰è¿›è¡Œäº’é€š&#39;); return; }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  const [a,b] = checked;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  const resp = await fetch(&#39;/start_call&#39;, {method:&#39;POST&#39;, headers:{&#39;Content-Type&#39;:&#39;application/json&#39;}, body: JSON.stringify({a_ip:a, b_ip:b})});
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  const j = await resp.json();
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  alert(JSON.stringify(j));
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  refresh();
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>async function stopCall(){
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  const resp = await fetch(&#39;/stop_all&#39;, {method:&#39;POST&#39;});
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  const j = await resp.json();
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  alert(JSON.stringify(j));
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  refresh();
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>refresh();
</span></span></span><span style=display:flex><span><span style=color:#e6db74>setInterval(refresh, 5000);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;/script&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;/body&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;/html&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>`</span>
</span></span></code></pre></div><p>ç¼–è¯‘ & è¿è¡Œ</p><p>åˆå§‹åŒ– moduleï¼ˆå¯é€‰ï¼Œæ¨èï¼‰ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>go mod init multiroom
</span></span></code></pre></div><p>ç›´æ¥è¿è¡Œï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>go run multiroom_server.go
</span></span></code></pre></div><p>æˆ–æ„å»ºæˆå¯æ‰§è¡Œæ–‡ä»¶ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>go build -o multiroom_server multiroom_server.go
</span></span><span style=display:flex><span>./multiroom_server
</span></span></code></pre></div><p>æµè§ˆå™¨è®¿é—® http://<server-ip>:5000ã€‚</p><p>ESP32 å¿ƒè·³æ ¼å¼ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#a6e22e>heartbeat</span><span style=color:#f92672>:&lt;</span><span style=color:#a6e22e>id</span><span style=color:#f92672>&gt;:&lt;</span><span style=color:#a6e22e>audio_port</span><span style=color:#f92672>&gt;</span>
</span></span></code></pre></div><p>æˆ–</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span>{<span style=color:#e6db74>&#34;id&#34;</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#34;esp32-1&#34;</span>,<span style=color:#e6db74>&#34;audio_port&#34;</span><span style=color:#f92672>:</span><span style=color:#ae81ff>12345</span>}
</span></span></code></pre></div><h1 id=next>Next<a hidden class=anchor aria-hidden=true href=#next>#</a></h1><p>å¤šè®¾å¤‡é—´ç‚¹å¯¹ç‚¹é€šè¯ï¼ˆA å‘¼å« Bï¼‰éŸ³é¢‘ä¸­ç»§ï¼Ÿ</p><p>I2Cæ¸©åº¦ä¼ æ„Ÿå™¨
<a href=https://www.bilibili.com/video/BV1Tr42157oq>https://www.bilibili.com/video/BV1Tr42157oq</a></p><p>STM32
<a href=https://pan.quark.cn/s/799d9ec89b15>https://pan.quark.cn/s/799d9ec89b15</a></p><p>ESP-IDF<br>thonny micropython
arduino
platformIO</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://qfsyso.github.io/tags/esp32/>ESP32</a></li><li><a href=https://qfsyso.github.io/tags/c/>C</a></li></ul><nav class=paginav><a class=next href=https://qfsyso.github.io/posts/wled-dev/><span class=title>Next Â»</span><br><span>WLED Dev</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share ESP32 WIFI BLE on x" href="https://x.com/intent/tweet/?text=ESP32%20WIFI%20BLE&amp;url=https%3a%2f%2fqfsyso.github.io%2fposts%2fesp32-wifi-ble%2f&amp;hashtags=ESP32%2cC"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share ESP32 WIFI BLE on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fqfsyso.github.io%2fposts%2fesp32-wifi-ble%2f&amp;title=ESP32%20WIFI%20BLE&amp;summary=ESP32%20WIFI%20BLE&amp;source=https%3a%2f%2fqfsyso.github.io%2fposts%2fesp32-wifi-ble%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share ESP32 WIFI BLE on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fqfsyso.github.io%2fposts%2fesp32-wifi-ble%2f&title=ESP32%20WIFI%20BLE"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share ESP32 WIFI BLE on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fqfsyso.github.io%2fposts%2fesp32-wifi-ble%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share ESP32 WIFI BLE on whatsapp" href="https://api.whatsapp.com/send?text=ESP32%20WIFI%20BLE%20-%20https%3a%2f%2fqfsyso.github.io%2fposts%2fesp32-wifi-ble%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share ESP32 WIFI BLE on telegram" href="https://telegram.me/share/url?text=ESP32%20WIFI%20BLE&amp;url=https%3a%2f%2fqfsyso.github.io%2fposts%2fesp32-wifi-ble%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share ESP32 WIFI BLE on ycombinator" href="https://news.ycombinator.com/submitlink?t=ESP32%20WIFI%20BLE&u=https%3a%2f%2fqfsyso.github.io%2fposts%2fesp32-wifi-ble%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><div class=wtime><div class=wtime2>CST<span id=beijingTime></span> GMT <span id=londonTime></span> EST <span id=newYorkTime></span> PST<span id=losAngelesTime></span></div><div class=wtime2 style=display:none>ä¸œäº¬<span id=tokyoTime></span></div><div class=wtime2 style=display:none>æ¬§æ´²-å·´é»<span id=parisTime></span></div><div class=wtime2 style=display:none>UTC<span id=utcTime></span></div></div><span>&copy; 2025 <a href=https://qfsyso.github.io/>MLOG</a></span> Â·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a>
</span><script type=text/javascript>const timeZoneOffsets={beijing:8,tokyo:9,paris:[1,2],london:[0,1],newYork:[-5,-4],losAngeles:[-8,-7]};function padZero(e){return e<10?"0"+e:e}function formatTime(e){const t=e.getFullYear(),n=padZero(e.getMonth()+1),s=padZero(e.getDate()),o=padZero(e.getHours()),i=padZero(e.getMinutes()),a=padZero(e.getSeconds());return`${t}-${n}-${s} ${o}:${i}:${a}`}function isDaylightSavingTime(e,t){const o=e.getMonth(),n=new Date(e.getFullYear(),3,8,2,0,0),s=new Date(e.getFullYear(),10,1,2,0,0);return(t==="paris"||t==="london"||t==="newYork"||t==="losAngeles")&&e>=n&&e<s}function updateTime(){const e=new Date,t=new Date(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds()),n=formatTime(t);document.getElementById("utcTime").innerHTML=n;for(const n in timeZoneOffsets){const e=timeZoneOffsets[n];let s;Array.isArray(e)?s=isDaylightSavingTime(t,n)?e[1]:e[0]:s=e;const o=new Date(t.getTime()+s*60*60*1e3);document.getElementById(n+"Time").innerHTML=formatTime(o)}setTimeout(updateTime,1e3)}window.onload=function(){updateTime()};function notfound(e){var n=e.src,t=n.split("/"),s=t[t.length-1];e.src="https://47.115.223.75:8080/group1/v2/"+s+"?timestamp="+Date.now(),e.onerror=null}</script></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>